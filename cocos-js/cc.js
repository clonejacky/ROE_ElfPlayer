System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:Xe,CCClass:kt,DebugMode:void 0,Enum:Ye,Eventify:an,ExtrapolationMode:void 0,KeyCode:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,WorldNode3DToLocalNodeUI:Ib,WorldNode3DToWorldNodeUI:wb,absMax:ui,absMaxComponent:li,approx:Xn,assert:m,assertID:I,bezier:Of,bezierByTime:Qf,ccenum:Ze,clamp:Yn,clamp01:Kn,color:pi,computeRatioByType:lU,createDefaultPipeline:bM,debug:v,deserialize:Bh,enumerableProps:hi,equals:qn,error:d,errorID:b,find:TD,getError:w,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[sl]},getWorldTransformUntilRoot:function(e,t,n){for(wi.identity(n);e!==t;)wi.fromRTS(Lk,e.rotation,e.position,e.scale),wi.multiply(n,Lk,n),e=e.parent;return n},instantiate:Jh,inverseLerp:ci,isCustomTargetModifier:jk,isDisplayStats:D,isElementModifier:Vk,isPropertyModifier:Hk,isValid:Qt,lerp:Qn,log:f,logID:T,markAsWarning:void 0,mat4:Mi,murmurhash2_32_gc:Ro,nextPow2:ai,pingPong:si,pseudoRandom:ni,pseudoRandomRange:ii,pseudoRandomRangeInt:ri,quat:Ri,randomRange:ei,randomRangeInt:ti,rect:ji,removeProperty:void 0,repeat:oi,replaceProperty:void 0,sampleAnimationCurve:cU,setDefaultLogTimes:function(e){e>0&&(Gn=e)},setDisplayStats:O,size:Hi,toDegree:Jn,toRadian:Zn,v2:Li,v3:gi,v4:Ui,warn:p,warnID:A});var n="undefined"==typeof window?global:window,i=e("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!1,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0;var r=e("VERSION","3.4.2");n.CocosEngine=i.ENGINE_VERSION=r,n.cc=i;var a="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",o=null,s=console.log.bind(console),c=s,l=s,u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+_.apply(void 0,[t].concat(i)))}},h=s;function _(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return i.js.formatStr.apply(null,[e].concat(n))}function f(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return s.apply(void 0,[e].concat(n))}function p(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return c.apply(void 0,[e].concat(n))}function d(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.apply(void 0,[e].concat(n))}function m(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return u.apply(void 0,[e,t].concat(i))}function v(){return h.apply(void 0,arguments)}function g(e){if(s=c=l=u=h=function(){},e!==P.NONE){if(e>P.ERROR){var t=function(e){if(i.game.canvas){if(!o){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",i.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(o=document.createElement("textarea")).setAttribute("rows","20"),o.setAttribute("cols","30"),o.setAttribute("disabled","true");var r=o.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",t.appendChild(o),i.game.canvas.parentNode.appendChild(t)}o.value=o.value+e+"\r\n",o.scrollTop=o.scrollHeight}};l=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+_.apply(void 0,[e].concat(i)))},u=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),a=2;a<i;a++)r[a-2]=arguments[a];t("ASSERT: "+_.apply(void 0,[n].concat(r)))}},e!==P.ERROR_FOR_WEB_PAGE&&(c=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+_.apply(void 0,[e].concat(i)))}),e===P.INFO_FOR_WEB_PAGE&&(s=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(_.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var a=_.apply(void 0,[t].concat(i));throw new Error(a)}});if(e!==P.ERROR&&(c=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=P.INFO&&(s=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=P.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);h=function(){return n.apply(void 0,arguments)}}}}function y(e){d(e.stack||e)}function x(e){return function(t){for(var n=e+" "+t+", please go to "+a+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var S=x("Log");function T(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];f(S.apply(void 0,[e].concat(n)))}var E=x("Warning");function A(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];p(E.apply(void 0,[e].concat(n)))}var C=x("Error");function b(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];d(C.apply(void 0,[e].concat(n)))}var P,R=x("Assert");function I(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];m(!1,R.apply(void 0,[t].concat(i)))}}function w(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return C.apply(void 0,[e].concat(n))}function D(){return!!i.profiler&&i.profiler.isShowingStats()}function O(e){i.profiler&&(e?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(P||(P=e("DebugMode",{})));var M=Object.freeze({__proto__:null,log:f,warn:p,error:d,assert:m,debug:v,_resetDebugSetting:g,_throw:y,logID:T,warnID:A,errorID:b,assertID:I,get DebugMode(){return P},getError:w,isDisplayStats:D,setDisplayStats:O});function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function B(e,t,n){return t&&N(e.prototype,t),n&&N(e,n),e}function F(){return(F=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function L(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,U(e,t)}function z(e){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function U(e,t){return(U=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function G(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function k(e,t,n){return(k=G()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&U(r,n.prototype),r}).apply(null,arguments)}function H(e){var t="function"==typeof Map?new Map:void 0;return(H=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return k(e,arguments,z(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),U(i,e)})(e)}function V(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function W(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return j(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?j(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function q(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function X(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var Y=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},B(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function K(e,t){e.splice(t,1)}function Q(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function Z(e,t){var n=e.indexOf(t);return n>=0&&(K(e,n),!0)}function J(e,t){return e.indexOf(t)>=0}var $=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:Q,remove:Z,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return K(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=W(e);!(n=i()).done;)if(!(n.value instanceof t))return T(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)Z(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:J,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:Y}),ee=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();ee.global=new ee("global");var te=new ee("TmpCId."),ne="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),ie="__cid__";function re(e){return"number"==typeof e||e instanceof Number}function ae(e){return"string"==typeof e||e instanceof String}function oe(e){for(var t in e)return!1;return!0}var se,ce=(se={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){se.value=n,se.writable=i,se.enumerable=r,Object.defineProperty(e,t,se),se.value=void 0}),le=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,a,o){void 0===a&&(a=!1),void 0===o&&(o=!1),"boolean"==typeof r&&(a=r,r=void 0),e.get=i,e.set=r,e.enumerable=a,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),ue=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.get=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0}}(),he=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.set=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.set=void 0}}();function _e(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function fe(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?fe(e.constructor):""}function pe(e,t,n,i){var r=/([^.]+)$/,a=r.exec(t)[0],o=r.exec(n)[0];function s(){return this[o]}i?le(e,a,s,(function(e){this[o]=e})):ue(e,a,s)}function de(e,t,n,i){for(var r in n)pe(e,t+"."+r,n[r],i)}var me=/(%d)|(%s)/,ve=/%s/;function ge(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&me.test(e);if(r)for(var a,o=W(n);!(a=o()).done;){var s=a.value,c="number"==typeof s?me:ve;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=W(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function ye(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function xe(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Se(e,t,n){var i=xe(t,e);i&&Object.defineProperty(n,e,i)}function Te(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!=typeof o){b(5402,o);continue}for(var s in o)s in e||Se(s,o,e)}}return e}function Ee(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!=typeof o){b(5403,o);continue}for(var s in o)Se(s,o,e)}}return e}function Ae(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ce(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function be(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ce(e)))return!1;if(e===t)return!0}}return!1}function Pe(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Re=_e(!0),Ie=_e(!0);function we(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],ce(i.prototype,e,n),n){var r=t[n];r&&r!==i?d("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var De=we("__cid__",Re),Oe=we("__classname__",Ie);function Me(e,t){if(Oe(e,t),!t.prototype.hasOwnProperty(ie)){var n=e||te.getNewId();n&&De(n,t)}}function Ne(e,t){var n=Ie[t],i=Re[t],r=!0;if(n&&n!==e&&(d('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(d('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var a=e[ne];a||(a=[],e[ne]=a),a.push(t),Ie[t]=e,Re[t]=e}}function Be(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=a.prototype,s=o.__cid__;s&&delete Re[s];var c=o.__classname__;c&&delete Ie[c];var l=o[ne];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Ie[h],delete Re[h]}}}function Fe(e){return Re[e]}function Le(e){return Ie[e]}function ze(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(ie))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(ie))return e.__cid__}return""}var Ue=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),Ge=$,ke={IDGenerator:ee,Pool:Ue,array:$,isNumber:re,isString:ae,isEmptyObject:oe,getPropertyDescriptor:xe,addon:Te,mixin:Ee,extend:Ae,getSuper:Ce,isChildClassOf:be,clear:Pe,value:ce,getset:le,get:ue,set:he,unregisterClass:Be,getClassName:fe,setClassName:Me,setClassAlias:Ne,getClassByName:Le,get _registeredClassNames(){return F({},Ie)},set _registeredClassNames(e){Pe(Ie),Object.assign(Ie,e)},get _registeredClassIds(){return F({},Re)},set _registeredClassIds(e){Pe(Re),Object.assign(Re,e)},_getClassId:ze,_setClassId:De,_getClassById:Fe,obsolete:pe,obsoletes:de,formatStr:ge,shiftArguments:ye,createMap:_e};i.js=ke,e("js",Object.freeze({__proto__:null,array:Ge,js:ke,IDGenerator:ee,Pool:Ue,isNumber:re,isString:ae,isEmptyObject:oe,value:ce,getset:le,get:ue,set:he,createMap:_e,getClassName:fe,obsolete:pe,obsoletes:de,formatStr:ge,shiftArguments:ye,getPropertyDescriptor:xe,addon:Te,mixin:Ee,extend:Ae,getSuper:Ce,isChildClassOf:be,clear:Pe,_idToClass:Re,_nameToClass:Ie,_setClassId:De,setClassName:Me,setClassAlias:Ne,unregisterClass:Be,_getClassById:Fe,getClassByName:Le,_getClassId:ze}));var He=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,ke.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),Ve=function(){function e(){this._poolHandle=-1,He.addContainer(this)}return e.prototype.destroy=function(){He.removeContainer(this)},e}(),je=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var a=0;a<r._elementsPerBatch;++a)r._freepool.push(t());return r}L(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&A(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(Ve)),We=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var a=0;a<n;++a)r._data[a]=t();return r}L(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},B(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(Ve)),qe=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=void 0!==n?n:function(e,t){return e-t},i}L(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(Ve));function Xe(e){if("__bitmask__"in e)return e;ce(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&ce(e,o,r)}return e}function Ye(e){return"__enums__"in e?e:(ce(e,"__enums__",null,!0),Ye.update(e))}function Ke(e){e.hasOwnProperty("__enums__")}function Qe(e){Ke(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function Ze(e){"__enums__"in e||ce(e,"__enums__",null,!0)}e("memop",Object.freeze({__proto__:null,Pool:je,RecyclePool:We,CachedArray:qe})),Xe.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Xe.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},i.BitMask=Xe,Ye.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&ce(e,o,r)}return Array.isArray(e.__enums__)&&Qe(e),e},Ye||(Ye=e("Enum",{})),Ye.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Ye.getList=function(e){return Ke(e),e.__enums__?e.__enums__:Qe(e)},i.Enum=Ye;var Je=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return b(100,fe(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){b(100,fe(this)+".set")},t.toString=function(){return""+{}},e}());Me("cc.ValueType",Je),i.ValueType=Je;var $e=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});i.macro=$e;for(var et=/^(?:cc|dragonBones|sp|ccsg)\..+/,tt=new Array(123),nt=0;nt<123;++nt)tt[nt]=64;for(var it=0;it<64;++it)tt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(it)]=it;var rt=tt;function at(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var a=e[n];le(e,t,a,e[i])}}for(var r,a=e.prototype,o=0;o<t.length;o++){var s=(r=t[o])[0].toUpperCase()+r.slice(1);i(a,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(a,r,c[0],c[1])}}function ot(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function st(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function ct(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function lt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ut(e){return!(!e||e.constructor!==Object)&&oe(e)}function ht(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function _t(e){return e*$e.RAD}function ft(e){return e*$e.DEG}i.misc={BUILTIN_CLASSID_RE:et,BASE64_VALUES:rt,propertyDefine:at,pushToMap:ot,contains:st,isDomNode:ct,callInNextTick:lt,isPlainEmptyObj_DEV:ut,clampf:ht,degreesToRadians:_t,radiansToDegrees:ft},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:et,BASE64_VALUES:rt,propertyDefine:at,pushToMap:ot,contains:st,isDomNode:ct,callInNextTick:lt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ut,clampf:ht,degreesToRadians:_t,radiansToDegrees:ft}));var pt="$_$";function dt(e,t){var n=t?Object.create(t):{};return ce(e,"__attrs__",n),n}function mt(e){if("function"!=typeof e)return dt(e,gt(e.constructor));for(var t,n=i.Class.getInheritanceChain(e),r=n.length-1;r>=0;r--){var a=n[r];a.hasOwnProperty("__attrs__")&&a.__attrs__||dt(a,(t=n[r+1])&&t.__attrs__)}return dt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function vt(e,t){var n=gt(e),i=t+pt,r={};for(var a in n)a.startsWith(i)&&(r[a.slice(i.length)]=n[a]);return r}function gt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||mt(e)}function yt(e,t,n,i){gt(e)[t+pt+n]=i}var xt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),St=e("CCInteger",new xt("Integer",0));i.Integer=St,i.CCInteger=St;var Tt=e("CCFloat",new xt("Float",0));i.Float=Tt,i.CCFloat=Tt;var Et=e("CCBoolean",new xt("Boolean",!1));i.Boolean=Et,i.CCBoolean=Et;var At=e("CCString",new xt("String",""));function Ct(e,t){return function(n,i){var r='"'+fe(n)+"."+i+'"',a=vt(n,i),o=a.type;if(o===St||o===Tt?o="Number":o!==At&&o!==Et||(o=""+o),o===e){if(a.hasOwnProperty("default")){var s=a.default;if(void 0!==s&&!Array.isArray(s)&&!ut(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof a.ctor)return;A(3605,r,fe(a.ctor))}else"Number"!==e&&A(3606,t,r,e);else{if("function"===c)return;e===At.default&&null==s?A(3607,r):A(3611,t,r,c)}delete a.type}}}else A(3604,r)}}i.String=At,i.CCString=At;var bt=Object.freeze({__proto__:null,DELIMETER:pt,createAttrsSingle:dt,createAttrs:mt,attr:vt,getClassAttrs:gt,setClassAttr:yt,PrimitiveType:xt,CCInteger:St,CCFloat:Tt,CCBoolean:Et,CCString:At,getTypeChecker_ET:Ct,getObjTypeChecker_ET:function(e){return function(t,n){Ct("Object","type")(t,n);var r=gt(t)[n+pt+"default"],a=i.Class.getDefault(r);if(!Array.isArray(a)&&be(e,i.ValueType)){var o=fe(e),s=ge('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',fe(t),n,o);r?f(s):A(3612,s,o,fe(t),n,o)}}}}),Pt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Rt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var a={};for(var o in i[r]=a,Pt){var s=Pt[o];e.hasOwnProperty(o)&&(a[o]=e[o],s.canUsedInGet||delete e[o])}}}function It(e,t,n,r){if(Array.isArray(t)){if(!(t.length>0))return b(5508,n,r);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=i.String:t===Boolean?e.type=i.Boolean:t===Number&&(e.type=i.Float))}function wt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Dt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return wt(t,[],e);if("function"==typeof e){var n=e;return wt(t,be(n,i.ValueType)?new n:null,n)}return wt(t,e instanceof xt?e.default:e)}return null}var Ot=[];function Mt(){return Ot[Ot.length-1]}i._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Ot.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Ot.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Mt};var Nt=pt,Bt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var a=fe(i);r?Gt(i,a,r,i.$super,n.mixins):b(3633,a)}this.datas=null}}};function Ft(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Vt(e,i,t,n)}function Lt(e,t,n,i){var r=i.get;i.set,r&&(Vt(e,i,t,n),yt(e,n,"serializable",!1))}function zt(e){return"function"==typeof e?e():e}function Ut(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,xe(t,i))}function Gt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var a=0;a<r.length;++a){var o=r[a];o.__props__&&(e.__props__=e.__props__.concat(o.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Dt(i,!1);if(r&&(i=e[n]=r),i){var a=i.notify;a&&Rt(i,n,a,e),"type"in i&&It(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Lt(e,t,s,c):Ft(e,t,s,c)}var l=gt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Nt+"serializable"]}))}function kt(e){var t=e.name,n=e.extends,r=e.mixins,a=function(e,t,n,r){var a=i.Component,o=Mt();if(o&&be(t,a)){if(be(o.cls,a))return b(3615),null;e=e||o.script}var s=function(e,t,n,i){var r=i.ctor,a=[r],o=r;ce(o,"__ctors__",a.length>0?a:null,!0);var s=o.prototype;if(t&&(o.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ut(s,l.prototype),kt._isCCClass(l)&&Ut(gt(o),gt(l))}s.constructor=o}return Me(e,o),o}(e,t,n,r);if(o)if(be(t,a)){var c=o.uuid;c&&De(c,s),o.cls=s}else be(o.cls,a)||(o.cls=s);return s}(t,n,r,e);t||(t=i.js.getClassName(a)),a._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||r&&r.some((function(e){return null===e.__props__}))?(Bt.push({cls:a,props:o,mixins:r}),a.__props__=a.__values__=null):Gt(a,t,o,n,e.mixins);var s=e.editor;return s&&be(n,i.Component)&&i.Component._registerEditorProps(a,s),a}kt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},kt.fastDefine=function(e,t,n){Me(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=gt(t),a=0;a<i.length;a++){var o=i[a];r[o+Nt+"visible"]=!1,r[o+Nt+"default"]=n[o]}},kt.Attr=bt,kt.attr=vt,kt.getInheritanceChain=function(e){for(var t=[];e=Ce(e);)e!==Object&&t.push(e);return t};var Ht={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Vt(e,t,n,i){var r=null,a="";function o(){return a=i+Nt,r=gt(e)}"type"in t&&void 0===t.type&&A(3660,i,n);var s=t.type;s&&(Ht[s]?(r||o())[a+"type"]=s:"Object"===s||("object"==typeof s?Ye.isEnum(s)?((r||o())[a+"type"]="Enum",r[a+"enumList"]=Ye.getList(s)):Xe.isBitMask(s)&&((r||o())[a+"type"]="BitMask",r[a+"bitmaskList"]=Xe.getList(s)):"function"==typeof s&&((r||o())[a+"type"]="Object",r[a+"ctor"]=s))),"default"in t&&((r||o())[a+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||o())[a+e]=i)}};t.editorOnly&&((r||o())[a+"editorOnly"]=!0),t.__noImplicit?(r||o())[a+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||o())[a+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||o())[a+"min"]=u[0],r[a+"max"]=u[1],u.length>2&&(r[a+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}kt.isArray=function(e){return e=zt(e),Array.isArray(e)},kt.getDefault=zt,kt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},kt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,kt.getNewValueTypeCode=function(e){for(var t=fe(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},i.Class=kt;var jt,Wt=e("editorExtrasTag","__editorExtras__"),qt=1<<22,Xt=[],Yt=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=Xt.length,t=0;t<e;++t){var n=Xt[t];1&n._objFlags||n._destroyImmediate()}e===Xt.length?Xt.length=0:Xt.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(A(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Xt.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,r=e instanceof i._BaseNode||e instanceof i.Component,a=r?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===a)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(kt._isCCClass(t))for(var s=i.Class.Attr.getClassAttrs(t),c=t.__props__,l=0;l<c.length;l++){var u=(n=c[l])+i.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(typeof s[u]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var _;_=kt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+kt.escapeForJS(n)+"]=";var f=o[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,e),ce(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?b(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},B(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&qt)},set:function(e){e?this._objFlags|=qt:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Kt=Yt.prototype;function Qt(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Kt._deserialize=null,Kt._onPreDestroy=null,kt.fastDefine("cc.Object",Yt,((jt={_name:"",_objFlags:0})[Wt]={},jt)),kt.Attr.setClassAttr(Yt,Wt,"editorOnly",!0),kt.Attr.setClassAttr(Yt,"replicated","visible",!1),ce(Yt,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Qt,i.Object=Yt;var Zt=Ge.fastRemoveAt;function Jt(){}var $t=function(){function e(){this.callback=Jt,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||Jt,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=Jt,this.once=!1},t.check=function(){return!(this.target instanceof Yt&&!Qt(this.target,!0))},e}(),en=new je((function(){return new $t}),32),tn=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),en.free(n),Zt(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),en.free(n),Zt(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Zt(this.callbackInfos,e),en.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),en.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Zt(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),nn=new je((function(){return new tn}),16),rn=function(){function e(){this._callbackTable=_e(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=nn.alloc());var a=en.alloc();a.set(t,n,i),r.callbackInfos.push(a)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var a=0;a<r.length;++a)if(r[a])return!0;return!1}return r.length>0}for(var o=0;o<r.length;++o){var s=r[o];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),nn.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var a=r.callbackInfos,o=0;o<a.length;++o){var s=a[o];s&&s.target===e&&r.cancel(o)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var a=r.callbackInfos;if(t)for(var o=0;o<a.length;++o){var s=a[o];if(s&&s.callback===t&&s.target===n){r.cancel(o);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,a){var o=this._callbackTable&&this._callbackTable[e];if(o){var s=!o.isInvoking;o.isInvoking=!0;for(var c=o.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,a):_(t,n,i,r,a):this.off(e,_,f)}}s&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),nn.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function an(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=_e(!0),t}L(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=rn.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var a=i[r];if(!(a in t.prototype)){var o=Object.getOwnPropertyDescriptor(n,a);o&&Object.defineProperty(t.prototype,a,o)}}return t}var on,sn,cn,ln,un,hn,_n=e("EventTarget",an((function(){})));i.EventTarget=_n,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(on||(on={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(sn||(sn={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(cn||(cn={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(ln||(ln={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(un||(un={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(hn||(hn={}));var fn=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,a=window.navigator,o=a.userAgent.toLowerCase();null===(t=a.getBattery)||void 0===t||t.call(a).then((function(e){i._battery=e})),i.networkType=cn.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(o),i.platform=i.isMobile?un.MOBILE_BROWSER:un.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=a.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||a.browserLanguage)?s.split("-")[0]:sn.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(o)||/android\s*(\d+(?:\.\d+)*)/i.exec(a.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(o))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(a.platform)||"MacIntel"===a.platform&&a.maxTouchPoints&&a.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=ln.UNKNOWN;-1!==a.appVersion.indexOf("Win")?f=ln.WINDOWS:l?f=ln.IOS:-1!==a.appVersion.indexOf("Mac")?f=ln.OSX:-1!==a.appVersion.indexOf("X11")&&-1===a.appVersion.indexOf("Linux")?f=ln.LINUX:c?f=ln.ANDROID:-1===a.appVersion.indexOf("Linux")&&-1===o.indexOf("ubuntu")||(f=ln.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=on.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(o)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(o)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(o)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(o),d=p?p[0].toLowerCase():ln.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(o))&&(d=on.ANDROID);var m={micromessenger:on.WECHAT,wechat:on.WECHAT,weixin:on.WECHAT,trident:on.IE,edge:on.EDGE,"360 aphone":on.BROWSER_360,mxbrowser:on.MAXTHON,"opr/":on.OPERA,ubrowser:on.UC,huaweibrowser:on.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(o);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(o)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[hn.WEBP]=g,n[hn.IMAGE_BITMAP]=x,n[hn.WEB_VIEW]=!0,n[hn.VIDEO_PLAYER]=!0,n[hn.SAFE_AREA]=!1,n[hn.INPUT_TOUCH]=S,n[hn.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[hn.EVENT_MOUSE]=T,n[hn.EVENT_TOUCH]=S||T,n[hn.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}L(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,a,o){n&&(n=!1,t.emit("show",e,i,r,a,o))};if(e)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],o=0;o<a.length;o++)document.addEventListener(a[o],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(_n)),pn=/(\.[^\.\/\?\\]*)(\?.*)?$/,dn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,mn=/[^\.\/]+\/\.\.\//;function vn(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];e=(e+(""===e?"":"/")+o).replace(/(\/|\\\\)$/,"")}return e}function gn(e){var t=pn.exec(e);return t?t[1]:""}function yn(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function xn(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Sn(e){var t=dn.exec(e);return t?t[2]:""}function Tn(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function En(e,t,n){if(0===t.indexOf("."))return Tn(e,t);var i=e.indexOf("?"),r="",a=n?gn(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+a+r}function An(e){var t=e=String(e);do{t=e,e=e.replace(mn,"")}while(t.length!==e.length);return e}function Cn(e){return e.replace(/[\/\\]$/,"")}function bn(){return fn.os===ln.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:vn,extname:gn,mainFileName:yn,basename:xn,dirname:Sn,changeExtname:Tn,changeBasename:En,_normalize:An,stripSep:Cn,getSeperator:bn})),i.log=f,i.warn=p,i.error=d,i.assert=m,i._throw=y,i.logID=T,i.warnID=A,i.errorID=b,i.assertID=I,i.debug=M,i.path={join:vn,extname:gn,mainFileName:yn,basename:xn,dirname:Sn,changeExtname:Tn,changeBasename:En,_normalize:An,stripSep:Cn,get sep(){return bn()}};var Pn=0,Rn={};function In(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function wn(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function Dn(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var On=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(On);var Mn=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:In,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:wn,nextPow2:Dn,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return On[255&e]<<24|On[e>>>8&255]<<16|On[e>>>16&255]<<8|On[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>wn(e)+1}});e("bits",Mn);var Nn,Bn,Fn,Ln,zn,Un,Gn=10,kn=0,Hn=new Map;Ln=function(e,t,n,i,r,a,o){var s=Hn.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+o,e+"."+t,n+"."+i),s.count++)},Nn=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=kn++;Hn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Gn});var r=null!=n.target?n.target:e,a=null!=n.newName?n.newName:n.name,o=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return Ln(t,n.name,o,a,p,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return Ln(t,n.name,o,a,p,i,c),n.customGetter.call(this)},set:function(e){Ln(t,n.name,o,a,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){Ln(t,n.name,o,a,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return Ln(t,n.name,o,a,p,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return Ln(t,n.name,o,a,p,i,c),s?this[a]:r[a]},set:function(e){Ln(t,n.name,o,a,p,i,c),s?this[a]=e:r[a]=e},enumerable:!1})}))})),Un=function(e,t,n,i,r){var a=Hn.get(i);a&&a.logTimes>a.count&&(n("'%s' has been removed. "+r,e+"."+t),a.count++)},Bn=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=kn++;Hn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Gn});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return Un(t,n.name,d,i,r)},set:function(){Un(t,n.name,d,i,r)},enumerable:!1})}))})),zn=function(e,t,n,i,r){var a=Hn.get(i);a&&a.logTimes>a.count&&(n("'%s' is deprecated. "+r,e+"."+t),a.count++)},Fn=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var a=kn++;Hn.set(a,{id:a,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Gn});var o=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return zn(t,i,p,a,o),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return zn(t,i,p,a,o),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){zn(t,i,p,a,o),c=e}})}else!function(t,n,i,r,a,o){if(t.get){var s=t.get;t.get=function(){return zn(n,i,r,a,o),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){zn(n,i,r,a,o),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,p,a,o);Object.defineProperty(e,i,{enumerable:!1})}}))}));var Vn=Math.PI/180,jn=180/Math.PI,Wn=e("EPSILON",1e-6);function qn(e,t){return Math.abs(e-t)<=Wn*Math.max(1,Math.abs(e),Math.abs(t))}function Xn(e,t,n){return n=n||Wn,Math.abs(e-t)<=n}function Yn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function Kn(e){return e<0?0:e>1?1:e}function Qn(e,t,n){return e+(t-e)*n}function Zn(e){return e*Vn}function Jn(e){return e*jn}var $n=e("random",Math.random);function ei(e,t){return Math.random()*(t-e)+e}function ti(e,t){return Math.floor(ei(e,t))}function ni(e){return(e=(9301*e+49297)%233280)/233280}function ii(e,t,n){return ni(e)*(n-t)+t}function ri(e,t,n){return Math.floor(ii(e,t,n))}function ai(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function oi(e,t){return e-Math.floor(e/t)*t}function si(e,t){return e=oi(e,2*t),t-Math.abs(e-t)}function ci(e,t,n){return(n-e)/(t-e)}function li(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function ui(e,t){return Math.abs(e)>Math.abs(t)?e:t}function hi(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var _i=1/255,fi=e("Color",function(e){function t(t,n,i,r){var a;return(a=e.call(this)||this)._val=0,"string"==typeof t?a.fromHEX(t):void 0!==n?a.set(t,n,i,r):a.set(t),a}L(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,a=t.g,o=t.b,s=t.a;return r+=(n.r-r)*i,a+=(n.g-a)*i,o+=(n.b-o)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(o<<16)+(a<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,a=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,a+=(e.a-a)*t,this._val=Math.floor((a<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*_i).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,a=0;if(0===t)i=r=a=n;else if(0===n)i=r=a=0;else{1===e&&(e=0),e*=6;var o=Math.floor(e),s=e-o,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(o){case 0:i=n,r=u,a=c;break;case 1:i=l,r=n,a=c;break;case 2:i=c,r=n,a=u;break;case 3:i=c,r=l,a=n;break;case 4:i=u,r=c,a=n;break;case 5:i=n,r=c,a=l}}return i*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*_i,t=this.g*_i,n=this.b*_i,i={h:0,s:0,v:0},r=Math.max(e,t,n),a=Math.min(e,t,n),o=0;return i.v=r,i.s=r?(r-a)/r:0,i.s?(o=r-a,i.h=e===r?(t-n)/o:t===r?2+(n-e)/o:4+(e-t)/o,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},B(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Yn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Yn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Yn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Yn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*_i},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*_i},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*_i},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*_i},set:function(e){this.a=255*e}}]),t}(Je));function pi(e,t,n,i){return new fi(e,t,n,i)}fi.WHITE=Object.freeze(new fi(255,255,255,255)),fi.GRAY=Object.freeze(new fi(127,127,127,255)),fi.BLACK=Object.freeze(new fi(0,0,0,255)),fi.TRANSPARENT=Object.freeze(new fi(0,0,0,0)),fi.RED=Object.freeze(new fi(255,0,0,255)),fi.GREEN=Object.freeze(new fi(0,255,0,255)),fi.BLUE=Object.freeze(new fi(0,0,255,255)),fi.CYAN=Object.freeze(new fi(0,255,255,255)),fi.MAGENTA=Object.freeze(new fi(255,0,255,255)),fi.YELLOW=Object.freeze(new fi(255,255,0,255)),kt.fastDefine("cc.Color",fi,{r:0,g:0,b:0,a:255}),i.Color=fi,i.color=pi;var di=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}L(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<Wn?e.x=0:e.x=1/n,Math.abs(i)<Wn?e.y=0:e.y=1/i,Math.abs(r)<Wn?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,a=n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z;return e.x=r*c-a*s,e.y=a*o-i*c,e.z=i*s-r*o,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*$n()*Math.PI,i=2*$n()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a+n.m15;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a+n.m12)*o,e.y=(n.m01*i+n.m05*r+n.m09*a+n.m13)*o,e.z=(n.m02*i+n.m06*r+n.m10*a+n.m14)*o,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a)*o,e.y=(n.m01*i+n.m05*r+n.m09*a)*o,e.z=(n.m02*i+n.m06*r+n.m10*a)*o,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=i*n.m00+r*n.m03+a*n.m06,e.y=i*n.m01+r*n.m04+a*n.m07,e.z=i*n.m02+r*n.m05+a*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13,e.x=n.m02*i+n.m06*r+n.m10*a+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,a=n.w*t.z+n.x*t.y-n.y*t.x,o=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+o*-n.x+r*-n.z-a*-n.y,e.y=r*n.w+o*-n.y+a*-n.x-i*-n.z,e.z=a*n.w+o*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var a=t.x*r.x,o=t.y*r.y,s=t.z*r.z,c=n.w*a+n.y*s-n.z*o,l=n.w*o+n.z*a-n.x*s,u=n.w*s+n.x*o-n.y*a,h=-n.x*a-n.y*o-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var a=t.x-i.x,o=t.y-i.y,s=t.z-i.z,c=n.w*a-n.y*s+n.z*o,l=n.w*o-n.z*a+n.x*s,u=n.w*s-n.x*o+n.y*a,h=n.x*a+n.y*o+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=a*s-o*c,h=a*c+o*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=o*c+r*s,u=a,h=o*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-a*c,u=r*c+a*s,h=o;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=Wn);var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,c=t.z;return Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-c)<=n*Math.max(1,Math.abs(a),Math.abs(c))},t.angle=function(e,n){t.normalize(mi,e),t.normalize(vi,n);var i=t.dot(mi,vi);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=Wn),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=Yn(this.x,e.x,t.x),this.y=Yn(this.y,e.y,t.y),this.z=Yn(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(Je));di.UNIT_X=Object.freeze(new di(1,0,0)),di.UNIT_Y=Object.freeze(new di(0,1,0)),di.UNIT_Z=Object.freeze(new di(0,0,1)),di.RIGHT=Object.freeze(new di(1,0,0)),di.UP=Object.freeze(new di(0,1,0)),di.FORWARD=Object.freeze(new di(0,0,-1)),di.ZERO=Object.freeze(new di(0,0,0)),di.ONE=Object.freeze(new di(1,1,1)),di.NEG_ONE=Object.freeze(new di(-1,-1,-1));var mi=new di,vi=new di;function gi(e,t,n){return new di(e,t,n)}kt.fastDefine("cc.Vec3",di,{x:0,y:0,z:0}),i.Vec3=di,i.v3=gi;var yi=e("Mat3",function(e){function t(t,n,i,r,a,o,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=a,u.m05=o,u.m06=s,u.m07=c,u.m08=l),u}L(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,a,o,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*o-s*l,_=-u*a+s*c,f=l*a-o*c,p=n*h+i*_+r*f;return 0===p?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(p=1/p,e.m00=h*p,e.m01=(-u*i+r*l)*p,e.m02=(s*i-r*o)*p,e.m03=_*p,e.m04=(u*n-r*c)*p,e.m05=(-s*n+r*a)*p,e.m06=f*p,e.m07=(-l*n+i*c)*p,e.m08=(o*n-i*a)*p,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*a-o*c)+n*(-l*r+o*s)+i*(c*r-a*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*o+p*l,e.m01=_*r+f*s+p*u,e.m02=_*a+f*c+p*h,e.m03=d*i+m*o+v*l,e.m04=d*r+m*s+v*u,e.m05=d*a+m*c+v*h,e.m06=g*i+y*o+x*l,e.m07=g*r+y*s+x*u,e.m08=g*a+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*o+p*l,e.m01=_*r+f*s+p*u,e.m02=_*a+f*c+p*h,e.m03=d*i+m*o+v*l,e.m04=d*r+m*s+v*u,e.m05=d*a+m*c+v*h,e.m06=g*i+y*o+x*l,e.m07=g*r+y*s+x*u,e.m08=g*a+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=c,e.m06=_*i+f*o+l,e.m07=_*r+f*s+u,e.m08=_*a+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*o,e.m01=f*r+_*s,e.m02=f*a+_*c,e.m03=f*o-_*i,e.m04=f*s-_*r,e.m05=f*c-_*a,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return di.lengthSqr(n)<Wn*Wn?(t.identity(e),e):(i=i||di.UNIT_Y,di.normalize(xi,di.cross(xi,i,n)),di.lengthSqr(xi)<Wn*Wn?(t.identity(e),e):(di.cross(Si,n,xi),t.set(e,xi.x,xi.y,xi.z,Si.x,Si.y,Si.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,_=r*o,f=r*s,p=r*c,d=a*o,m=a*s,v=a*c;return e.m00=1-h-p,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-p,e.m07=f-d,e.m02=_-m,e.m05=f+d,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,A=u*d-h*p,C=u*m-_*p,b=u*v-f*p,P=h*m-_*d,R=h*v-f*d,I=_*v-f*m,w=g*I-y*R+x*P+S*b-T*C+E*A;return w?(w=1/w,e.m00=(s*I-c*R+l*P)*w,e.m01=(c*b-o*I-l*C)*w,e.m02=(o*R-s*b+l*A)*w,e.m03=(r*R-i*I-a*P)*w,e.m04=(n*I-r*b+a*C)*w,e.m05=(i*b-n*R-a*A)*w,e.m06=(d*E-m*T+v*S)*w,e.m07=(m*x-p*E-v*y)*w,e.m08=(p*T-d*x+v*g)*w,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,a,o,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=c*r-a*s,u=-c*i+a*o,h=s*i-r*o,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(a*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*o)*_,this.m05=(-a*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*o)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08;return e*(c*r-a*s)+t*(-c*i+a*o)+n*(s*i-r*o)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,p=e.m04,d=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*a+_*c,this.m02=u*i+h*o+_*l,this.m03=f*t+p*r+d*s,this.m04=f*n+p*a+d*c,this.m05=f*i+p*o+d*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*a+g*c,this.m08=m*i+v*o+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*a,this.m02=h*i+u*o,this.m03=h*r-u*t,this.m04=h*a-u*n,this.m05=h*o-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,_=i*o,f=i*s,p=r*a,d=r*o,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},t}(Je));yi.IDENTITY=Object.freeze(new yi);var xi=new di,Si=new di;kt.fastDefine("cc.Mat3",yi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=yi;var Ti=e("Quat",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.x=t.x,a.y=t.y,a.z=t.z,a.w=t.w):(a.x=t||0,a.y=n||0,a.z=i||0,a.w=null!=r?r:1),a}L(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=di.dot(n,i);return r<-.999999?(di.cross(Ci,di.UNIT_X,n),Ci.length()<1e-6&&di.cross(Ci,di.UNIT_Y,n),di.normalize(Ci,Ci),t.fromAxisAngle(e,Ci,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(di.cross(Ci,n,i),e.x=Ci.x,e.y=Ci.y,e.z=Ci.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,a=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,o=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=a,e.w=o,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+c*i,e.y=o*r+s*i,e.z=s*r-o*i,e.w=c*r-a*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r-s*i,e.y=o*r+c*i,e.z=s*r+a*i,e.w=c*r-o*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+o*i,e.y=o*r-a*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Ei,n),di.transformQuat(Ci,i,Ei),t.fromAxisAngle(Ei,Ci,r),t.multiply(e,n,Ei),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Ei,i,r),t.multiply(e,n,Ei),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,a=0,o=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,o=-o,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,a=Math.sin(i*h)/_}else r=1-i,a=i;return e.x=r*t.x+a*o,e.y=r*t.y+a*s,e.z=r*t.z+a*c,e.w=r*t.w+a*l,e},t.sqlerp=function(e,n,i,r,a,o){return t.slerp(Ei,n,a,o),t.slerp(Ai,i,r,o),t.slerp(e,Ei,Ai,2*o*(1-o)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return yi.set(bi,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,bi))},t.fromViewUp=function(e,n,i){return yi.fromViewUp(bi,n,i),t.normalize(e,t.fromMat3(e,bi))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,a=t.m01,o=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+o+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(a-i)*_}else if(n>o&&n>u){var f=2*Math.sqrt(1+n-o-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+a)/f,e.z=(r+c)/f}else if(o>u){var p=2*Math.sqrt(1+o-n-u);e.w=(r-c)/p,e.x=(i+a)/p,e.y=.25*p,e.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-o);e.w=(a-i)/d,e.x=(r+c)/d,e.y=(s+l)/d,e.z=.25*d}return e},t.fromEuler=function(e,t,n,i){t*=Pi,n*=Pi,i*=Pi;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+a*o*c,e.y=a*o*l+r*s*c,e.z=a*s*c-r*o*l,e.w=a*s*l-r*o*c,e},t.fromAngleZ=function(e,t){return t*=Pi,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=0,c=0,l=0,u=i*r+a*o;if(u>.499999)s=0,c=Jn(2*Math.atan2(i,o)),l=90;else if(u<-.499999)s=0,c=-Jn(2*Math.atan2(i,o)),l=-90;else{var h=i*i,_=r*r,f=a*a;s=Jn(Math.atan2(2*i*o-2*r*a,1-2*h-2*f)),c=Jn(Math.atan2(2*r*o-2*i*a,1-2*_-2*f)),l=Jn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(Je));Ti.IDENTITY=Object.freeze(new Ti);var Ei=new Ti,Ai=new Ti,Ci=new di,bi=new yi,Pi=.5*Math.PI/180;function Ri(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Ti(e,t,n,i)}kt.fastDefine("cc.Quat",Ti,{x:0,y:0,z:0,w:1}),i.Quat=Ti,i.quat=Ri;var Ii=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),wi=e("Mat4",function(e){function t(t,n,i,r,a,o,s,c,l,u,h,_,f,p,d,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=a,v.m05=o,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}L(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=p,e.m14=d,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,a=t.m06,o=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=o,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,A=u*d-h*p,C=u*m-_*p,b=u*v-f*p,P=h*m-_*d,R=h*v-f*d,I=_*v-f*m,w=g*I-y*R+x*P+S*b-T*C+E*A;return 0===w?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(w=1/w,e.m00=(s*I-c*R+l*P)*w,e.m01=(r*R-i*I-a*P)*w,e.m02=(d*E-m*T+v*S)*w,e.m03=(_*T-h*E-f*S)*w,e.m04=(c*b-o*I-l*C)*w,e.m05=(n*I-r*b+a*C)*w,e.m06=(m*x-p*E-v*y)*w,e.m07=(u*E-_*x+f*y)*w,e.m08=(o*R-s*b+l*A)*w,e.m09=(i*b-n*R-a*A)*w,e.m10=(p*T-d*x+v*g)*w,e.m11=(h*x-u*T-f*g)*w,e.m12=(s*C-o*P-c*A)*w,e.m13=(n*P-i*C+r*A)*w,e.m14=(d*y-p*S-m*g)*w,e.m15=(u*S-h*y+_*g)*w,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,p=e.m13,d=e.m14,m=e.m15;return(t*o-n*a)*(h*m-_*d)-(t*s-i*a)*(u*m-_*p)+(t*c-r*a)*(u*d-h*p)+(n*s-i*o)*(l*m-_*f)-(n*c-r*o)*(l*d-h*f)+(i*c-r*s)*(l*p-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,p=t.m11,d=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,T=n.m03;return e.m00=y*i+x*s+S*h+T*d,e.m01=y*r+x*c+S*_+T*m,e.m02=y*a+x*l+S*f+T*v,e.m03=y*o+x*u+S*p+T*g,y=n.m04,x=n.m05,S=n.m06,T=n.m07,e.m04=y*i+x*s+S*h+T*d,e.m05=y*r+x*c+S*_+T*m,e.m06=y*a+x*l+S*f+T*v,e.m07=y*o+x*u+S*p+T*g,y=n.m08,x=n.m09,S=n.m10,T=n.m11,e.m08=y*i+x*s+S*h+T*d,e.m09=y*r+x*c+S*_+T*m,e.m10=y*a+x*l+S*f+T*v,e.m11=y*o+x*u+S*p+T*g,y=n.m12,x=n.m13,S=n.m14,T=n.m15,e.m12=y*i+x*s+S*h+T*d,e.m13=y*r+x*c+S*_+T*m,e.m14=y*a+x*l+S*f+T*v,e.m15=y*o+x*u+S*p+T*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,a=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*a+t.m15;else{var o=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,p=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=o,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=p,e.m09=d,e.m10=m,e.m11=v,e.m12=o*i+u*r+p*a+t.m12,e.m13=s*i+h*r+d*a+t.m13,e.m14=c*i+_*r+m*a+t.m14,e.m15=l*i+f*r+v*a+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,a=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,a=i.y,o=i.z,s=Math.sqrt(r*r+a*a+o*o);if(Math.abs(s)<Wn)return null;r*=s=1/s,a*=s,o*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,p=t.m03,d=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,E=r*r*u+l,A=a*r*u+o*c,C=o*r*u-a*c,b=r*a*u-o*c,P=a*a*u+l,R=o*a*u+r*c,I=r*o*u+a*c,w=a*o*u-r*c,D=o*o*u+l;return e.m00=h*E+d*A+y*C,e.m01=_*E+m*A+x*C,e.m02=f*E+v*A+S*C,e.m03=p*E+g*A+T*C,e.m04=h*b+d*P+y*R,e.m05=_*b+m*P+x*R,e.m06=f*b+v*P+S*R,e.m07=p*b+g*P+T*R,e.m08=h*I+d*w+y*D,e.m09=_*I+m*w+x*D,e.m10=f*I+v*w+S*D,e.m11=p*I+g*w+T*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m04,o=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+l*i,e.m05=o*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-a*i,e.m09=u*r-o*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-l*i,e.m01=o*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=a*i+l*r,e.m09=o*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+l*i,e.m01=o*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-a*i,e.m05=u*r-o*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,a=n.z,o=Math.sqrt(i*i+r*r+a*a);if(Math.abs(o)<Wn)return null;i*=o=1/o,r*=o,a*=o;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+a*s,e.m02=a*i*l-r*s,e.m03=0,e.m04=i*r*l-a*s,e.m05=r*r*l+c,e.m06=a*r*l+i*s,e.m07=0,e.m08=i*a*l+r*s,e.m09=r*a*l-i*s,e.m10=a*a*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=a*l,m=o*s,v=o*c,g=o*l;return e.m00=1-(f+d),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+d),e.m06=p+m,e.m07=0,e.m08=_+v,e.m09=p-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Oi.m00=t.m00,i=Oi.m01=t.m01,r=Oi.m02=t.m02,a=Oi.m03=t.m04,o=Oi.m04=t.m05,s=Oi.m05=t.m06,c=Oi.m06=t.m08,l=Oi.m07=t.m09,u=Oi.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(c*c+l*l+u*u),yi.determinant(Oi)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=di.set(Di,e.m00,e.m01,e.m02).length(),Oi.m00=e.m00/i.x,Oi.m01=e.m01/i.x,Oi.m02=e.m02/i.x,i.y=di.set(Di,e.m04,e.m05,e.m06).length(),Oi.m03=e.m04/i.y,Oi.m04=e.m05/i.y,Oi.m05=e.m06/i.y,i.z=di.set(Di,e.m08,e.m09,e.m10).length(),Oi.m06=e.m08/i.z,Oi.m07=e.m09/i.z,Oi.m08=e.m10/i.z,yi.determinant(Oi)<0&&(i.x*=-1,Oi.m00*=-1,Oi.m01*=-1,Oi.m02*=-1),Ti.fromMat3(t,Oi),di.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=t.w,c=r+r,l=a+a,u=o+o,h=r*c,_=r*l,f=r*u,p=a*l,d=a*u,m=o*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,T=i.z;return e.m00=(1-(p+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(d+v)*S,e.m07=0,e.m08=(f+g)*T,e.m09=(d-v)*T,e.m10=(1-(h+p))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var a=t.x,o=t.y,s=t.z,c=t.w,l=a+a,u=o+o,h=s+s,_=a*l,f=a*u,p=a*h,d=o*u,m=o*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,T=i.y,E=i.z,A=r.x,C=r.y,b=r.z;return e.m00=(1-(d+v))*S,e.m01=(f+x)*S,e.m02=(p-y)*S,e.m03=0,e.m04=(f-x)*T,e.m05=(1-(_+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(p+y)*E,e.m09=(m-g)*E,e.m10=(1-(_+d))*E,e.m11=0,e.m12=n.x+A-(e.m00*A+e.m04*C+e.m08*b),e.m13=n.y+C-(e.m01*A+e.m05*C+e.m09*b),e.m14=n.z+b-(e.m02*A+e.m06*C+e.m10*b),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,_=r*o,f=r*s,p=r*c,d=a*o,m=a*s,v=a*c;return e.m00=1-h-p,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-p,e.m06=f+d,e.m07=0,e.m08=_+m,e.m09=f-d,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,a,o){var s=1/(n-t),c=1/(r-i),l=1/(a-o);return e.m00=2*a*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(o+a)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*a*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,a,o,s,c){void 0===a&&(a=!0),void 0===o&&(o=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=a?l/n:l,_=(a?l:l*n)*s,f=Ii[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-o*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-o),e.m15=0,e},t.ortho=function(e,t,n,i,r,a,o,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(a-o),f=-2*u,p=-2*h,d=(t+n)*u,m=(r+i)*h,v=Ii[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=p*v[2],e.m05=p*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=d*v[0]+m*v[2],e.m13=d*v[1]+m*v[3],e.m14=(a-s*o)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=a-n.y,_=o-n.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return e.m00=p,e.m01=v,e.m02=u,e.m03=0,e.m04=d,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(p*r+d*a+m*o),e.m13=-(v*r+g*a+y*o),e.m14=-(u*r+h*a+_*o),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,A=u*d-h*p,C=u*m-_*p,b=u*v-f*p,P=h*m-_*d,R=h*v-f*d,I=_*v-f*m,w=g*I-y*R+x*P+S*b-T*C+E*A;return w?(w=1/w,e.m00=(s*I-c*R+l*P)*w,e.m01=(c*b-o*I-l*C)*w,e.m02=(o*R-s*b+l*A)*w,e.m03=0,e.m04=(r*R-i*I-a*P)*w,e.m05=(n*I-r*b+a*C)*w,e.m06=(i*b-n*R-a*A)*w,e.m07=0,e.m08=(d*E-m*T+v*S)*w,e.m09=(m*x-p*E-v*y)*w,e.m10=(p*T-d*x+v*g)*w,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=a,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=e*a-t*r,v=e*o-n*r,g=e*s-i*r,y=t*o-n*a,x=t*s-i*a,S=n*s-i*o,T=c*f-l*_,E=c*p-u*_,A=c*d-h*_,C=l*p-u*f,b=l*d-h*f,P=u*d-h*p,R=m*P-v*b+g*C+y*A-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(a*P-o*b+s*C)*R,this.m01=(n*b-t*P-i*C)*R,this.m02=(f*S-p*x+d*y)*R,this.m03=(u*x-l*S-h*y)*R,this.m04=(o*A-r*P-s*E)*R,this.m05=(e*P-n*A+i*E)*R,this.m06=(p*g-_*S-d*v)*R,this.m07=(c*S-u*g+h*v)*R,this.m08=(r*b-a*A+s*T)*R,this.m09=(t*A-e*b-i*T)*R,this.m10=(_*x-f*g+d*m)*R,this.m11=(l*g-c*x-h*m)*R,this.m12=(a*E-r*C-o*T)*R,this.m13=(e*C-t*E+n*T)*R,this.m14=(f*v-_*y-p*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(e*a-t*r)*(u*d-h*p)-(e*o-n*r)*(l*d-h*f)+(e*s-i*r)*(l*p-u*f)+(t*o-n*a)*(c*d-h*_)-(t*s-i*a)*(c*p-u*_)+(n*s-i*o)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*a+y*l+x*f,this.m01=v*n+g*o+y*u+x*p,this.m02=v*i+g*s+y*h+x*d,this.m03=v*r+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*a+y*l+x*f,this.m05=v*n+g*o+y*u+x*p,this.m06=v*i+g*s+y*h+x*d,this.m07=v*r+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*a+y*l+x*f,this.m09=v*n+g*o+y*u+x*p,this.m10=v*i+g*s+y*h+x*d,this.m11=v*r+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*a+y*l+x*f,this.m13=v*n+g*o+y*u+x*p,this.m14=v*i+g*s+y*h+x*d,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,a=Math.sqrt(n*n+i*i+r*r);if(Math.abs(a)<Wn)return null;n*=a=1/a,i*=a,r*=a;var o=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,T=i*n*c+r*o,E=r*n*c-i*o,A=n*i*c-r*o,C=i*i*c+s,b=r*i*c+n*o,P=n*r*c+i*o,R=i*r*c-n*o,I=r*r*c+s;return this.m00=l*S+f*T+v*E,this.m01=u*S+p*T+g*E,this.m02=h*S+d*T+y*E,this.m03=_*S+m*T+x*E,this.m04=l*A+f*C+v*b,this.m05=u*A+p*C+g*b,this.m06=h*A+d*C+y*b,this.m07=_*A+m*C+x*b,this.m08=l*P+f*R+v*I,this.m09=u*P+p*R+g*I,this.m10=h*P+d*R+y*I,this.m11=_*P+m*R+x*I,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Oi.m00=this.m00,n=Oi.m01=this.m01,i=Oi.m02=this.m02,r=Oi.m03=this.m04,a=Oi.m04=this.m05,o=Oi.m05=this.m06,s=Oi.m06=this.m08,c=Oi.m07=this.m09,l=Oi.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+a*a+o*o),e.z=Math.sqrt(s*s+c*c+l*l),yi.determinant(Oi)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=a*l,m=o*s,v=o*c,g=o*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(p-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,_=i*o,f=i*s,p=r*a,d=r*o,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(Je));wi.IDENTITY=Object.freeze(new wi);var Di=new di,Oi=new yi;function Mi(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d){return new wi(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d)}kt.fastDefine("cc.Mat4",wi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=wi,i.mat4=Mi;var Ni=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}L(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<Wn?e.x=0:e.x=1/n,Math.abs(i)<Wn?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof di?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,a=t.y;return e.x=r+i*(n.x-r),e.y=a+i*(n.y-a),e},t.random=function(e,t){t=t||1;var n=2*$n()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Bi,e),t.normalize(Fi,n);var i=t.dot(Bi,Fi);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=Yn(this.x,e.x,t.x),this.y=Yn(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=Yn(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(Je));Ni.ZERO=Object.freeze(new Ni(0,0)),Ni.ONE=Object.freeze(new Ni(1,1)),Ni.NEG_ONE=Object.freeze(new Ni(-1,-1)),Ni.UNIT_X=Object.freeze(new Ni(1,0)),Ni.UNIT_Y=Object.freeze(new Ni(0,1));var Bi=new Ni,Fi=new Ni;function Li(e,t){return new Ni(e,t)}kt.fastDefine("cc.Vec2",Ni,{x:0,y:0}),i.Vec2=Ni,i.v2=Li;var zi=e("Vec4",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.x=t.x,a.y=t.y,a.z=t.z,a.w=t.w):(a.x=t||0,a.y=n||0,a.z=i||0,a.w=r||0),a}L(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w;return Math.abs(n)<Wn?e.x=0:e.x=1/n,Math.abs(i)<Wn?e.y=0:e.y=1/i,Math.abs(r)<Wn?e.z=0:e.z=1/r,Math.abs(a)<Wn?e.w=0:e.w=1/a,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n*n+i*i+r*r+a*a;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o,e.w=a*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*$n()*Math.PI,i=2*$n()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12*o,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13*o,e.z=n.m02*i+n.m06*r+n.m10*a+n.m14*o,e.w=n.m03*i+n.m07*r+n.m11*a+n.m15*o,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m01*r+n.m02*a+n.m03*o,e.y=n.m04*i+n.m05*r+n.m06*a+n.m07*o,e.x=n.m08*i+n.m09*r+n.m10*a+n.m11*o,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*a-c*r,h=l*r+c*i-o*a,_=l*a+o*r-s*i,f=-o*i-s*r-c*a;return e.x=u*l+f*-o+h*-c-_*-s,e.y=h*l+f*-s+_*-o-u*-c,e.z=_*l+f*-c+u*-s-h*-o,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=Wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=Wn),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,a=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=a+t*(e.w-a),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=Yn(this.x,e.x,t.x),this.y=Yn(this.y,e.y,t.y),this.z=Yn(this.z,e.z,t.z),this.w=Yn(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(Je));function Ui(e,t,n,i){return new zi(e,t,n,i)}zi.ZERO=Object.freeze(new zi(0,0,0,0)),zi.ONE=Object.freeze(new zi(1,1,1,1)),zi.NEG_ONE=Object.freeze(new zi(-1,-1,-1,-1)),kt.fastDefine("cc.Vec4",zi,{x:0,y:0,z:0,w:0}),i.Vec4=zi,i.v4=Ui,Nn(Ni,"Vec2",[{name:"sub",newName:"subtract",target:Ni,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Ni,targetName:"Vec2"},{name:"div",newName:"divide",target:Ni,targetName:"Vec2"},{name:"dist",newName:"distance",target:Ni,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Ni,targetName:"Vec2"},{name:"mag",newName:"len",target:Ni,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Ni,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ni,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ni,targetName:"Vec2"}]),Nn(Ni.prototype,"Vec2",[{name:"mag",newName:"length",target:Ni.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Ni.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ni.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ni.prototype,targetName:"Vec2"}]),Nn(di,"Vec3",[{name:"sub",newName:"subtract",target:di,targetName:"Vec3"},{name:"mul",newName:"multiply",target:di,targetName:"Vec3"},{name:"div",newName:"divide",target:di,targetName:"Vec3"},{name:"dist",newName:"distance",target:di,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:di,targetName:"Vec3"},{name:"mag",newName:"len",target:di,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:di,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:di,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:di,targetName:"Vec3"}]),Nn(di.prototype,"Vec3",[{name:"mag",newName:"length",target:di.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:di.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:di.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:di.prototype,targetName:"Vec3"}]),Nn(zi,"Vec4",[{name:"sub",newName:"subtract",target:zi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:zi,targetName:"Vec4"},{name:"div",newName:"divide",target:zi,targetName:"Vec4"},{name:"dist",newName:"distance",target:zi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:zi,targetName:"Vec4"},{name:"mag",newName:"len",target:zi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:zi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:zi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:zi,targetName:"Vec4"}]),Nn(zi.prototype,"Vec4",[{name:"mag",newName:"length",target:zi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:zi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:zi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:zi.prototype,targetName:"Vec4"}]),Nn(Ti,"Quat",[{name:"mag",newName:"len",target:Ti,targetName:"Quat"},{name:"mul",newName:"multiply",target:Ti,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Ti,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Ti,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ti,targetName:"Quat"}]),Nn(Ti.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Ti.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ti.prototype,targetName:"Quat"}]),Nn(fi,"Color",[{name:"sub",newName:"subtract",target:fi,targetName:"Color"},{name:"mul",newName:"multiply",target:fi,targetName:"Color"},{name:"div",newName:"divide",target:fi,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:fi,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[1].toString(16);return i.Color.fromHEX(t[0],r)}}]),Nn(yi,"Mat3",[{name:"sub",newName:"subtract",target:yi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:yi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:yi,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:yi,targetName:"Mat3"}]),Nn(yi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:yi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:yi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:yi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:yi.prototype,targetName:"Mat3"}]),Nn(wi,"Mat4",[{name:"sub",newName:"subtract",target:wi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:wi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:wi,targetName:"Mat4"}]),Nn(wi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:wi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:wi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:wi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:wi.prototype,targetName:"Mat4"}]);var Gi=e("AffineTransform",function(){function e(e,t,n,i,r,a){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=a}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,a=t.c,o=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=a*n.a+o*n.c,e.d=a*n.b+o*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,a;void 0===i?(i=n,r=t.x,a=t.y):(r=t,a=n),e.x=i.a*r+i.c*a+i.tx,e.y=i.b*r+i.d*a+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,a=n.a*t.x+n.c*t.y+n.tx,o=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(a,s,l,h),p=Math.max(a,s,l,h),d=Math.min(o,c,u,_),m=Math.max(o,c,u,_);e.x=f,e.y=d,e.width=p-f,e.height=m-d},e.transformObb=function(e,t,n,i,r,a){var o=a.a*r.x+a.c*r.y+a.tx,s=a.b*r.x+a.d*r.y+a.ty,c=a.a*r.width,l=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=o,t.y=s,n.x=c+o,n.y=l+s,e.x=u+o,e.y=h+s,i.x=c+u+o,i.y=l+h+s},e}());i.AffineTransform=Gi;var ki=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}L(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},B(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(Je));function Hi(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new ki(e,t)}ki.ZERO=Object.freeze(new ki(0,0)),ki.ONE=Object.freeze(new ki(1,1)),kt.fastDefine("cc.Size",ki,{width:0,height:0}),i.size=Hi,i.Size=ki;var Vi=e("Rect",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.y=t.y,a.width=t.width,a.height=t.height,a.x=t.x):(a.x=t||0,a.y=n||0,a.width=i||0,a.height=r||0),a}L(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),a=Math.max(t.x,n.x),o=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=a-i,e.height=o-r,e},t.lerp=function(e,t,n,i){var r=t.x,a=t.y,o=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=a+(n.y-a)*i,e.width=o+(n.width-o)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,a=t.x+t.width,o=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(a,l)-e.x,e.height=Math.min(o,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,a=t.width,o=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+a,s+l)-e.x,e.height=Math.max(r+o,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,a=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=a+(e.height-a)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,a=e.m00*t+e.m04*n+e.m12,o=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(a,s,l,h),p=Math.max(a,s,l,h),d=Math.min(o,c,u,_),m=Math.max(o,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},n.transformMat4ToPoints=function(e,t,n,i,r){var a=this.x,o=this.y,s=a+this.width,c=o+this.height;t.x=e.m00*a+e.m04*o+e.m12,t.y=e.m01*a+e.m05*o+e.m13,r.x=e.m00*s+e.m04*o+e.m12,r.y=e.m01*s+e.m05*o+e.m13,n.x=e.m00*a+e.m04*c+e.m12,n.y=e.m01*a+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},B(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Ni(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Ni(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new ki(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(Je));function ji(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new Vi(e,t,n,i)}kt.fastDefine("cc.Rect",Vi,{x:0,y:0,width:0,height:0}),i.Rect=Vi,i.rect=ji;var Wi=e("MATH_FLOAT_ARRAY",Float64Array),qi=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t.createFloatArray=function(e){return new Wi(e)},B(t,[{key:"array",get:function(){return this._array}}]),t}(Je)),Xi=Object.freeze({__proto__:null,bits:Mn,Vec2:Ni,v2:Li,Vec3:di,v3:gi,Vec4:zi,v4:Ui,Quat:Ti,quat:Ri,Mat3:yi,Mat4:wi,mat4:Mi,AffineTransform:Gi,Size:ki,size:Hi,Rect:Vi,rect:ji,Color:fi,color:pi,EPSILON:Wn,equals:qn,approx:Xn,clamp:Yn,clamp01:Kn,lerp:Qn,toRadian:Zn,toDegree:Jn,random:$n,randomRange:ei,randomRangeInt:ti,pseudoRandom:ni,pseudoRandomRange:ii,pseudoRandomRangeInt:ri,nextPow2:ai,repeat:oi,pingPong:si,inverseLerp:ci,absMaxComponent:li,absMax:ui,enumerableProps:hi,MATH_FLOAT_ARRAY:Wi,MathBase:qi});e("math",Xi);var Yi=function(){function e(){this._groundAlbedoHDR=new zi(.2,.2,.2,1),this._skyColorHDR=new zi(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new zi(.2,.2,.2,1),this._skyColorLDR=new zi(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(e){this._mipmapCount=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();Yi.SUN_ILLUM=65e3,Yi.SKY_ILLUM=2e4,i.Ambient=Yi;var Ki=function(){function e(){this._enabled=!1,this._minPos=new di(0,0,0),this._maxPos=new di(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Qi=new di,Zi=new di,Ji=new di,$i=new di,er=new di,tr=new di,nr=new Array(3),ir=new Array(3);function rr(e,t){return di.dot(t.n,e)-t.d}function ar(e,t,n){return di.copy(e,t),di.subtract(er,n.center,n.halfExtents),di.add(tr,n.center,n.halfExtents),e.x=e.x<er.x?er.x:e.x,e.y=e.y<er.y?er.y:e.y,e.z=e.z<er.z?er.z:e.z,e.x=e.x>tr.x?tr.x:e.x,e.y=e.y>tr.y?tr.y:e.y,e.z=e.z>tr.z?tr.z:e.z,e}function or(e,t,n){di.set(Qi,n.orientation.m00,n.orientation.m01,n.orientation.m02),di.set(Zi,n.orientation.m03,n.orientation.m04,n.orientation.m05),di.set(Ji,n.orientation.m06,n.orientation.m07,n.orientation.m08),nr[0]=Qi,nr[1]=Zi,nr[2]=Ji,ir[0]=n.halfExtents.x,ir[1]=n.halfExtents.y,ir[2]=n.halfExtents.z,di.subtract($i,t,n.center),di.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=di.dot($i,nr[i]);r>ir[i]&&(r=ir[i]),r<-ir[i]&&(r=-ir[i]),e.x+=r*nr[i].x,e.y+=r*nr[i].y,e.z+=r*nr[i].z}return e}var sr=Object.freeze({__proto__:null,point_plane:rr,pt_point_plane:function(e,t,n){var i=rr(t,n);return di.subtract(e,t,di.multiplyScalar(e,n.n,i))},pt_point_aabb:ar,pt_point_obb:or,pt_point_line:function(e,t,n,i){di.subtract(Qi,n,i);var r=Qi,a=di.lengthSqr(r);if(0==a)di.copy(e,n);else{di.subtract(Qi,t,n);var o=di.dot(Qi,r)/a;o<0?di.copy(e,n):o>1?di.copy(e,i):di.scaleAndAdd(e,n,r,o)}}}),cr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},lr=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=cr.SHAPE_LINE,this.s=new di(e,t,n),this.e=new di(i,r,a)}return e.create=function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return di.copy(e.s,t.s),di.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return di.copy(e.s,t),di.copy(e.e,n),e},e.set=function(e,t,n,i,r,a,o){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=a,e.e.z=o,e},e.len=function(e){return di.distance(e.s,e.e)},e.prototype.length=function(){return di.distance(this.s,this.e)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),ur=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=cr.SHAPE_RAY,this.o=new di(e,t,n),this.d=new di(i,r,a)}return e.create=function(t,n,i,r,a,o){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return di.copy(e.o,t.o),di.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return di.copy(e.o,t),di.normalize(e.d,di.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,a,o){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=a,e.d.z=o,e},e.prototype.computeHit=function(e,t){di.normalize(e,this.d),di.scaleAndAdd(e,this.o,e,t)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),hr=new di,_r=new di,fr=new di,pr=new di;function dr(e){return Math.max(Math.max(e.x,e.y),e.z)}var mr,vr,gr,yr,xr,Sr,Tr,Er,Ar,Cr,br,Pr,Rr,Ir,wr,Dr,Or,Mr,Nr,Br,Fr,Lr,zr,Ur,Gr,kr,Hr,Vr,jr,Wr,qr,Xr,Yr,Kr,Qr,Zr,Jr,$r,ea,ta,na,ia=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new di(0,0,0),this._radius=0,this._type=void 0,this._type=cr.SHAPE_SPHERE,this._center=new di(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return di.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return di.multiplyScalar(e.center,di.add(hr,t,n),.5),e.radius=.5*di.subtract(hr,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){di.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),di.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){di.transformMat4(r.center,this.center,e),r.radius=this.radius*dr(i)},t.translateAndRotate=function(e,t,n){di.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*dr(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),di.subtract(_r,e,this.center);var t=_r.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,di.multiplyScalar(_r,_r,n/t),di.add(this.center,this.center,_r)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(fr,pr),this.mergePoint(fr),this.mergePoint(pr)},B(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),ra=function(){function e(e,t,n,i,r,a,o,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=cr.SHAPE_TRIANGLE,this.a=new di(e,t,n),this.b=new di(i,r,a),this.c=new di(o,s,c)}return e.create=function(t,n,i,r,a,o,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,a,o,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return di.copy(e.a,t.a),di.copy(e.b,t.b),di.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return di.copy(e.a,t),di.copy(e.b,n),di.copy(e.c,i),e},e.set=function(e,t,n,i,r,a,o,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=a,e.b.z=o,e.c.x=s,e.c.y=c,e.c.z=l,e},B(e,[{key:"type",get:function(){return this._type}}]),e}(),aa=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(mr||(mr={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(vr||(vr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(gr||(gr={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(yr||(yr={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(xr||(xr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(Sr||(Sr={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Tr||(Tr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(Er||(Er={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Ar||(Ar={})),function(e){e[e.NONE=0]="NONE"}(Cr||(Cr={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(br||(br={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Pr||(Pr={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Rr||(Rr={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Ir||(Ir={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(wr||(wr={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Dr||(Dr={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Or||(Or={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Mr||(Mr={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Nr||(Nr={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Br||(Br={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Fr||(Fr={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Lr||(Lr={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(zr||(zr={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Ur||(Ur={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Gr||(Gr={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(kr||(kr={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Hr||(Hr={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Vr||(Vr={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(jr||(jr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Wr||(Wr={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(qr||(qr={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Xr||(Xr={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Yr||(Yr={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Kr||(Kr={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Qr||(Qr={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Zr||(Zr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Jr||(Jr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}($r||($r={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(ea||(ea={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(ta||(ta={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(na||(na={}));var oa,sa=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ca=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new sa),void 0===v&&(v=new sa),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=a,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),la=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ua=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),ha=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),_a=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),fa=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),pa=function(){function e(e,t,n,i,r){void 0===e&&(e=new _a),void 0===t&&(t=new la),void 0===n&&(n=new _a),void 0===i&&(i=new la),void 0===r&&(r=new ha),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),da=function(){function e(e,t,n,i,r,a){void 0===e&&(e=new _a),void 0===t&&(t=new la),void 0===n&&(n=new ha),void 0===i&&(i=new _a),void 0===r&&(r=new la),void 0===a&&(a=new ha),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=a}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),ma=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new la),void 0===i&&(i=new ha),void 0===r&&(r=new _a),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),va=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=a}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),ga=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),ya=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),xa=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Or.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),Sa=function(){function e(e){void 0===e&&(e=new ya),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),Ta=function(){function e(e,t,n,i,r){void 0===e&&(e=Ar.NONE),void 0===t&&(t=Pr.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=Cr.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),Ea=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),Aa=function(){function e(e,t,n,i,r,a,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=a,this.firstInstance=o}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),Ca=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),ba=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return aa(this.drawInfos,e.drawInfos,Aa),this},e}(),Pa=function(){function e(e,t,n,i,r,a,o,s,c,l,u){void 0===e&&(e=Rr.TEX2D),void 0===t&&(t=Ir.NONE),void 0===n&&(n=Sr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=wr.NONE),void 0===o&&(o=1),void 0===s&&(s=1),void 0===c&&(c=Dr.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=a,this.layerCount=o,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),Ra=function(){function e(e,t,n,i,r,a,o){void 0===e&&(e=null),void 0===t&&(t=Rr.TEX2D),void 0===n&&(n=Sr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=a,this.layerCount=o}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),Ia=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=Mr.LINEAR),void 0===t&&(t=Mr.LINEAR),void 0===n&&(n=Mr.NONE),void 0===i&&(i=Nr.WRAP),void 0===r&&(r=Nr.WRAP),void 0===a&&(a=Nr.WRAP),void 0===o&&(o=0),void 0===s&&(s=Br.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=a,this.maxAnisotropy=o,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),wa=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=Er.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Da=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,aa(this.members,e.members,wa),this.count=e.count,this},e}(),Oa=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Er.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ma=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Na=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Er.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ba=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Er.UNKNOWN),void 0===r&&(r=0),void 0===a&&(a=br.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=a}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Fa=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=br.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),La=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),za=function(){function e(e,t){void 0===e&&(e=Gr.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Ua=function(){function e(e,t,n,i,r,a){void 0===e&&(e=""),void 0===t&&(t=Sr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===a&&(a=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=a}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Ga=function(){function e(e,t,n,i,r,a,o,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===a&&(a=[]),void 0===o&&(o=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=a,this.samplers=o,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,aa(this.stages,e.stages,za),aa(this.attributes,e.attributes,Ua),aa(this.blocks,e.blocks,Da),aa(this.buffers,e.buffers,Fa),aa(this.samplerTextures,e.samplerTextures,Oa),aa(this.samplers,e.samplers,Ma),aa(this.textures,e.textures,Na),aa(this.images,e.images,Ba),aa(this.subpassInputs,e.subpassInputs,La),this},e}(),ka=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return aa(this.attributes,e.attributes,Ua),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Ha=function(){function e(e,t,n,i,r,a,o){void 0===e&&(e=Sr.UNKNOWN),void 0===t&&(t=Dr.ONE),void 0===n&&(n=kr.CLEAR),void 0===i&&(i=Hr.STORE),void 0===r&&(r=[]),void 0===a&&(a=[Vr.COLOR_ATTACHMENT_WRITE]),void 0===o&&(o=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=a,this.isGeneralLayout=o}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Va=function(){function e(e,t,n,i,r,a,o,s,c){void 0===e&&(e=Sr.UNKNOWN),void 0===t&&(t=Dr.ONE),void 0===n&&(n=kr.CLEAR),void 0===i&&(i=Hr.STORE),void 0===r&&(r=kr.CLEAR),void 0===a&&(a=Hr.STORE),void 0===o&&(o=[]),void 0===s&&(s=[Vr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=a,this.beginAccesses=o,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),ja=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===a&&(a=-1),void 0===o&&(o=jr.NONE),void 0===s&&(s=jr.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=a,this.depthResolveMode=o,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Wa=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),qa=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Va),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return aa(this.colorAttachments,e.colorAttachments,Ha),this.depthStencilAttachment.copy(e.depthStencilAttachment),aa(this.subpasses,e.subpasses,ja),aa(this.dependencies,e.dependencies,Wa),this},e}(),Xa=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),Ya=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Ka=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Qa=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=Jr.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Gr.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Za=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return aa(this.bindings,e.bindings,Qa),this},e}(),Ja=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),$a=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),eo=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return aa(this.attributes,e.attributes,Ua),this},e}(),to=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=ta.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),no=function(){function e(e){void 0===e&&(e=$r.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),io=function(){function e(e,t,n){void 0===e&&(e=ea.OCCLUSION),void 0===t&&(t=65536),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),ro=function(e,t,n,i,r,a,o,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=Tr.NONE),void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=a,this.hasStencil=o,this.isCompressed=s},ao=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),oo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),so=function(){function e(e,t,n,i,r,a,o,s,c,l,u){void 0===e&&(e=new va),void 0===t&&(t=new ua),void 0===n&&(n=new ga),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new oo),void 0===u&&(u=new oo),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=a,this.depthBiasSlope=o,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),co=function(){function e(t){this._objectType=mr.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[mr.UNKNOWN]++,this._typedID=e._idTable[t]++}return B(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();co._idTable=Array(mr.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(oa||(oa={}));var lo=Object.freeze([new ro("UNKNOWN",0,0,Tr.NONE,!1,!1,!1,!1),new ro("A8",1,1,Tr.UNORM,!0,!1,!1,!1),new ro("L8",1,1,Tr.UNORM,!1,!1,!1,!1),new ro("LA8",1,2,Tr.UNORM,!0,!1,!1,!1),new ro("R8",1,1,Tr.UNORM,!1,!1,!1,!1),new ro("R8SN",1,1,Tr.SNORM,!1,!1,!1,!1),new ro("R8UI",1,1,Tr.UINT,!1,!1,!1,!1),new ro("R8I",1,1,Tr.INT,!1,!1,!1,!1),new ro("R16F",2,1,Tr.FLOAT,!1,!1,!1,!1),new ro("R16UI",2,1,Tr.UINT,!1,!1,!1,!1),new ro("R16I",2,1,Tr.INT,!1,!1,!1,!1),new ro("R32F",4,1,Tr.FLOAT,!1,!1,!1,!1),new ro("R32UI",4,1,Tr.UINT,!1,!1,!1,!1),new ro("R32I",4,1,Tr.INT,!1,!1,!1,!1),new ro("RG8",2,2,Tr.UNORM,!1,!1,!1,!1),new ro("RG8SN",2,2,Tr.SNORM,!1,!1,!1,!1),new ro("RG8UI",2,2,Tr.UINT,!1,!1,!1,!1),new ro("RG8I",2,2,Tr.INT,!1,!1,!1,!1),new ro("RG16F",4,2,Tr.FLOAT,!1,!1,!1,!1),new ro("RG16UI",4,2,Tr.UINT,!1,!1,!1,!1),new ro("RG16I",4,2,Tr.INT,!1,!1,!1,!1),new ro("RG32F",8,2,Tr.FLOAT,!1,!1,!1,!1),new ro("RG32UI",8,2,Tr.UINT,!1,!1,!1,!1),new ro("RG32I",8,2,Tr.INT,!1,!1,!1,!1),new ro("RGB8",3,3,Tr.UNORM,!1,!1,!1,!1),new ro("SRGB8",3,3,Tr.UNORM,!1,!1,!1,!1),new ro("RGB8SN",3,3,Tr.SNORM,!1,!1,!1,!1),new ro("RGB8UI",3,3,Tr.UINT,!1,!1,!1,!1),new ro("RGB8I",3,3,Tr.INT,!1,!1,!1,!1),new ro("RGB16F",6,3,Tr.FLOAT,!1,!1,!1,!1),new ro("RGB16UI",6,3,Tr.UINT,!1,!1,!1,!1),new ro("RGB16I",6,3,Tr.INT,!1,!1,!1,!1),new ro("RGB32F",12,3,Tr.FLOAT,!1,!1,!1,!1),new ro("RGB32UI",12,3,Tr.UINT,!1,!1,!1,!1),new ro("RGB32I",12,3,Tr.INT,!1,!1,!1,!1),new ro("RGBA8",4,4,Tr.UNORM,!0,!1,!1,!1),new ro("BGRA8",4,4,Tr.UNORM,!0,!1,!1,!1),new ro("SRGB8_A8",4,4,Tr.UNORM,!0,!1,!1,!1),new ro("RGBA8SN",4,4,Tr.SNORM,!0,!1,!1,!1),new ro("RGBA8UI",4,4,Tr.UINT,!0,!1,!1,!1),new ro("RGBA8I",4,4,Tr.INT,!0,!1,!1,!1),new ro("RGBA16F",8,4,Tr.FLOAT,!0,!1,!1,!1),new ro("RGBA16UI",8,4,Tr.UINT,!0,!1,!1,!1),new ro("RGBA16I",8,4,Tr.INT,!0,!1,!1,!1),new ro("RGBA32F",16,4,Tr.FLOAT,!0,!1,!1,!1),new ro("RGBA32UI",16,4,Tr.UINT,!0,!1,!1,!1),new ro("RGBA32I",16,4,Tr.INT,!0,!1,!1,!1),new ro("R5G6B5",2,3,Tr.UNORM,!1,!1,!1,!1),new ro("R11G11B10F",4,3,Tr.FLOAT,!1,!1,!1,!1),new ro("RGB5A1",2,4,Tr.UNORM,!0,!1,!1,!1),new ro("RGBA4",2,4,Tr.UNORM,!0,!1,!1,!1),new ro("RGB10A2",2,4,Tr.UNORM,!0,!1,!1,!1),new ro("RGB10A2UI",2,4,Tr.UINT,!0,!1,!1,!1),new ro("RGB9E5",2,4,Tr.FLOAT,!0,!1,!1,!1),new ro("DEPTH",4,1,Tr.FLOAT,!1,!0,!1,!1),new ro("DEPTH_STENCIL",5,2,Tr.FLOAT,!1,!0,!0,!1),new ro("BC1",1,3,Tr.UNORM,!1,!1,!1,!0),new ro("BC1_ALPHA",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC1_SRGB",1,3,Tr.UNORM,!1,!1,!1,!0),new ro("BC1_SRGB_ALPHA",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC2",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC2_SRGB",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC3",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC3_SRGB",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC4",1,1,Tr.UNORM,!1,!1,!1,!0),new ro("BC4_SNORM",1,1,Tr.SNORM,!1,!1,!1,!0),new ro("BC5",1,2,Tr.UNORM,!1,!1,!1,!0),new ro("BC5_SNORM",1,2,Tr.SNORM,!1,!1,!1,!0),new ro("BC6H_UF16",1,3,Tr.UFLOAT,!1,!1,!1,!0),new ro("BC6H_SF16",1,3,Tr.FLOAT,!1,!1,!1,!0),new ro("BC7",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("BC7_SRGB",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ETC_RGB8",1,3,Tr.UNORM,!1,!1,!1,!0),new ro("ETC2_RGB8",1,3,Tr.UNORM,!1,!1,!1,!0),new ro("ETC2_SRGB8",1,3,Tr.UNORM,!1,!1,!1,!0),new ro("ETC2_RGB8_A1",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ETC2_SRGB8_A1",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ETC2_RGBA8",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("ETC2_SRGB8_A8",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("EAC_R11",1,1,Tr.UNORM,!1,!1,!1,!0),new ro("EAC_R11SN",1,1,Tr.SNORM,!1,!1,!1,!0),new ro("EAC_RG11",2,2,Tr.UNORM,!1,!1,!1,!0),new ro("EAC_RG11SN",2,2,Tr.SNORM,!1,!1,!1,!0),new ro("PVRTC_RGB2",2,3,Tr.UNORM,!1,!1,!1,!0),new ro("PVRTC_RGBA2",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("PVRTC_RGB4",2,3,Tr.UNORM,!1,!1,!1,!0),new ro("PVRTC_RGBA4",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("PVRTC2_2BPP",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("PVRTC2_4BPP",2,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_4x4",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_5x4",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_5x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_6x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_6x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_8x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_8x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_8x8",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_10x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_10x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_10x8",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_10x10",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_12x10",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_RGBA_12x12",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_4x4",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_5x4",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_5x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_6x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_6x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_8x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_8x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_8x8",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_10x5",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_10x6",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_10x8",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_10x10",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_12x10",1,4,Tr.UNORM,!0,!1,!1,!0),new ro("ASTC_SRGBA_12x12",1,4,Tr.UNORM,!0,!1,!1,!0)]),uo=Jr.UNIFORM_BUFFER|Jr.DYNAMIC_UNIFORM_BUFFER|Jr.STORAGE_BUFFER|Jr.DYNAMIC_STORAGE_BUFFER,ho=Jr.SAMPLER_TEXTURE|Jr.SAMPLER|Jr.TEXTURE|Jr.STORAGE_IMAGE|Jr.INPUT_ATTACHMENT,_o=Jr.DYNAMIC_STORAGE_BUFFER|Jr.DYNAMIC_UNIFORM_BUFFER;function fo(e){return e>0&&0==(e&e-1)}function po(e,t,n,i){if(!lo[e].isCompressed)return t*n*i*lo[e].size;switch(e){case Sr.BC1:case Sr.BC1_ALPHA:case Sr.BC1_SRGB:case Sr.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Sr.BC2:case Sr.BC2_SRGB:case Sr.BC3:case Sr.BC3_SRGB:case Sr.BC4:case Sr.BC4_SNORM:case Sr.BC6H_SF16:case Sr.BC6H_UF16:case Sr.BC7:case Sr.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Sr.BC5:case Sr.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Sr.ETC_RGB8:case Sr.ETC2_RGB8:case Sr.ETC2_SRGB8:case Sr.ETC2_RGB8_A1:case Sr.EAC_R11:case Sr.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Sr.ETC2_RGBA8:case Sr.ETC2_SRGB8_A1:case Sr.EAC_RG11:case Sr.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Sr.PVRTC_RGB2:case Sr.PVRTC_RGBA2:case Sr.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Sr.PVRTC_RGB4:case Sr.PVRTC_RGBA4:case Sr.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Sr.ASTC_RGBA_4X4:case Sr.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Sr.ASTC_RGBA_5X4:case Sr.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Sr.ASTC_RGBA_5X5:case Sr.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Sr.ASTC_RGBA_6X5:case Sr.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Sr.ASTC_RGBA_6X6:case Sr.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Sr.ASTC_RGBA_8X5:case Sr.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Sr.ASTC_RGBA_8X6:case Sr.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Sr.ASTC_RGBA_8X8:case Sr.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Sr.ASTC_RGBA_10X5:case Sr.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Sr.ASTC_RGBA_10X6:case Sr.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Sr.ASTC_RGBA_10X8:case Sr.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Sr.ASTC_RGBA_10X10:case Sr.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Sr.ASTC_RGBA_12X10:case Sr.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Sr.ASTC_RGBA_12X12:case Sr.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function mo(e,t,n,i,r){for(var a=0,o=0;o<r;++o)a+=po(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return a}var vo=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function go(e){return vo[e]||0}function yo(e){var t=e.size/e.count;switch(e.type){case Tr.UNORM:case Tr.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Tr.SNORM:case Tr.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Tr.FLOAT:return Float32Array}return Float32Array}var xo=Object.freeze({__proto__:null,get ObjectType(){return mr},get Status(){return vr},get API(){return gr},get SurfaceTransform(){return yr},get Feature(){return xr},get Format(){return Sr},get FormatType(){return Tr},get Type(){return Er},get BufferUsageBit(){return Ar},get BufferFlagBit(){return Cr},get MemoryAccessBit(){return br},get MemoryUsageBit(){return Pr},get TextureType(){return Rr},get TextureUsageBit(){return Ir},get TextureFlagBit(){return wr},get SampleCount(){return Dr},get VsyncMode(){return Or},get Filter(){return Mr},get Address(){return Nr},get ComparisonFunc(){return Br},get StencilOp(){return Fr},get BlendFactor(){return Lr},get BlendOp(){return zr},get ColorMask(){return Ur},get ShaderStageFlagBit(){return Gr},get LoadOp(){return kr},get StoreOp(){return Hr},get AccessType(){return Vr},get ResolveMode(){return jr},get PipelineBindPoint(){return Wr},get PrimitiveMode(){return qr},get PolygonMode(){return Xr},get ShadeModel(){return Yr},get CullMode(){return Kr},get DynamicStateFlagBit(){return Qr},get StencilFace(){return Zr},get DescriptorType(){return Jr},get QueueType(){return $r},get QueryType(){return ea},get CommandBufferType(){return ta},get ClearFlagBit(){return na},Size:sa,DeviceCaps:ca,Offset:la,Rect:ua,Extent:ha,TextureSubresLayers:_a,TextureSubresRange:fa,TextureCopy:pa,TextureBlit:da,BufferTextureCopy:ma,Viewport:va,Color:ga,BindingMappingInfo:ya,SwapchainInfo:xa,DeviceInfo:Sa,BufferInfo:Ta,BufferViewInfo:Ea,DrawInfo:Aa,DispatchInfo:Ca,IndirectBuffer:ba,TextureInfo:Pa,TextureViewInfo:Ra,SamplerInfo:Ia,Uniform:wa,UniformBlock:Da,UniformSamplerTexture:Oa,UniformSampler:Ma,UniformTexture:Na,UniformStorageImage:Ba,UniformStorageBuffer:Fa,UniformInputAttachment:La,ShaderStage:za,Attribute:Ua,ShaderInfo:Ga,InputAssemblerInfo:ka,ColorAttachment:Ha,DepthStencilAttachment:Va,SubpassInfo:ja,SubpassDependency:Wa,RenderPassInfo:qa,GlobalBarrierInfo:Xa,TextureBarrierInfo:Ya,FramebufferInfo:Ka,DescriptorSetLayoutBinding:Qa,DescriptorSetLayoutInfo:Za,DescriptorSetInfo:Ja,PipelineLayoutInfo:$a,InputState:eo,CommandBufferInfo:to,QueueInfo:no,QueryPoolInfo:io,FormatInfo:ro,MemoryStatus:ao,DynamicStencilStates:oo,DynamicStates:so,GFXObject:co,get AttributeName(){return oa},FormatInfos:lo,DESCRIPTOR_BUFFER_TYPE:uo,DESCRIPTOR_SAMPLER_TYPE:ho,DESCRIPTOR_DYNAMIC_TYPE:_o,DRAW_INFO_SIZE:28,IsPowerOf2:fo,FormatSize:po,FormatSurfaceSize:mo,GetTypeSize:go,getTypedArrayConstructor:yo}),So=function(e){function t(){var t;return(t=e.call(this,mr.BUFFER)||this)._usage=Ar.NONE,t._memUsage=Pr.NONE,t._size=0,t._stride=1,t._count=0,t._flags=Cr.NONE,t._isBufferView=!1,t}return L(t,e),B(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(co),To=function(e){function t(){var t;return(t=e.call(this,mr.COMMAND_BUFFER)||this)._queue=null,t._type=ta.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return L(t,e),B(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(co),Eo=function(){function e(){this._gfxAPI=gr.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(xr.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ao,this._caps=new ca,this._bindingMappingInfo=new ya,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return e.prototype.hasFeature=function(e){return this._features[e]},B(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();Eo.canvas=void 0;var Ao=function(e){function t(){var t;return(t=e.call(this,mr.SWAPCHAIN)||this)._transform=yr.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return L(t,e),B(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(co),Co=function(e){function t(){var t;return(t=e.call(this,mr.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return L(t,e),B(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(co),bo=String.prototype.charCodeAt;function Po(e){return this[e]}function Ro(e,t){for(var n=e.length,i=t^n,r=0,a="string"==typeof e?bo:Po;n>=4;){var o=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(o=1540483477*(65535&(o^=o>>>24))+((1540483477*(o>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&a.call(e,r+2))<<16;case 2:i^=(255&a.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&a.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Io=function(e){function t(){var t;return(t=e.call(this,mr.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new Aa,t}L(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Ro(e,666)},B(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(co),wo=function(e){function t(){var t;return(t=e.call(this,mr.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}L(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&uo){var a=this._layout.descriptorIndices[e];this._buffers[a+n]!==t&&(this._buffers[a+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ho){var a=this._layout.descriptorIndices[e];this._samplers[a+n]!==t&&(this._samplers[a+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ho){var a=this._layout.descriptorIndices[e];this._textures[a+n]!==t&&(this._textures[a+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},B(t,[{key:"layout",get:function(){return this._layout}}]),t}(co),Do=function(e){function t(){var t;return(t=e.call(this,mr.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return L(t,e),B(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(co),Oo=function(e){function t(){var t;return(t=e.call(this,mr.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return L(t,e),B(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(co),Mo=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Xr.FILL),void 0===n&&(n=Yr.GOURAND),void 0===i&&(i=Kr.BACK),void 0===r&&(r=!0),void 0===a&&(a=!1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=a,this.depthBias=o,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Xr.FILL,this.shadeModel=Yr.GOURAND,this.cullMode=Kr.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),No=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Br.LESS),void 0===i&&(i=!1),void 0===r&&(r=Br.ALWAYS),void 0===a&&(a=65535),void 0===o&&(o=65535),void 0===s&&(s=Fr.KEEP),void 0===c&&(c=Fr.KEEP),void 0===l&&(l=Fr.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Br.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=Fr.KEEP),void 0===m&&(m=Fr.KEEP),void 0===v&&(v=Fr.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=a,this.stencilWriteMaskFront=o,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Br.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Br.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Fr.KEEP,this.stencilZFailOpFront=Fr.KEEP,this.stencilPassOpFront=Fr.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Br.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Fr.KEEP,this.stencilZFailOpBack=Fr.KEEP,this.stencilPassOpBack=Fr.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),Bo=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=!1),void 0===t&&(t=Lr.ONE),void 0===n&&(n=Lr.ZERO),void 0===i&&(i=zr.ADD),void 0===r&&(r=Lr.ONE),void 0===a&&(a=Lr.ZERO),void 0===o&&(o=zr.ADD),void 0===s&&(s=Ur.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=a,this.blendAlphaEq=o,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Lr.ONE,this.blendDst=Lr.ZERO,this.blendEq=zr.ADD,this.blendSrcAlpha=Lr.ONE,this.blendDstAlpha=Lr.ZERO,this.blendAlphaEq=zr.ADD,this.blendColorMask=Ur.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Fo=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new ga),void 0===i&&(i=[new Bo]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Bo),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),Lo=function(e,t,n,i,r,a,o,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new eo),void 0===r&&(r=new Mo),void 0===a&&(a=new No),void 0===o&&(o=new Fo),void 0===s&&(s=qr.TRIANGLE_LIST),void 0===c&&(c=Qr.NONE),void 0===l&&(l=Wr.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=a,this.blendState=o,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},zo=function(e){function t(){var t;return(t=e.call(this,mr.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=qr.TRIANGLE_LIST,t._is=null,t._rs=new Mo,t._dss=new No,t._bs=new Fo,t._dynamicStates=Qr.NONE,t._renderPass=null,t}return L(t,e),B(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(co),Uo=function(e){function t(){var t;return(t=e.call(this,mr.QUEUE)||this)._type=$r.GRAPHICS,t}return L(t,e),B(t,[{key:"type",get:function(){return this._type}}]),t}(co),Go=function(e){function t(){var t;return(t=e.call(this,mr.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return L(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var a=0;a<n.inputs.length;++a){var o=this._colorInfos[n.inputs[a]];e+=","+o.format+","+o.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Ro(e,666)},B(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(co),ko=function(e){function t(t,n){var i;return(i=e.call(this,mr.SAMPLER)||this)._info=new Ia,i._hash=0,i._info.copy(t),i._hash=n,i}return L(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new Ia;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(co),Ho=function(e){function t(){var t;return(t=e.call(this,mr.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return L(t,e),B(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(co),Vo=function(e){function t(){var t;return(t=e.call(this,mr.TEXTURE)||this)._type=Rr.TEX2D,t._usage=Ir.NONE,t._format=Sr.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._layerCount=1,t._levelCount=1,t._samples=Dr.ONE,t._flags=wr.NONE,t._isPowerOf2=!1,t._size=0,t}return L(t,e),B(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(co),jo=function(e){function t(t,n){var i;return(i=e.call(this,mr.GLOBAL_BARRIER)||this)._info=new Xa,i._hash=0,i._info.copy(t),i._hash=n,i}return L(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return Ro(t,666)},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(co),Wo=function(e){function t(t,n){var i;return(i=e.call(this,mr.TEXTURE_BARRIER)||this)._info=new Ya,i._hash=0,i._info.copy(t),i._hash=n,i}return L(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,Ro(t+=e.dstQueue?e.dstQueue.type:0,666)},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(co),qo={Device:Eo,Swapchain:Ao,Buffer:So,Texture:Vo,Sampler:ko,Shader:Ho,InputAssembler:Io,RenderPass:Go,Framebuffer:Co,DescriptorSet:wo,DescriptorSetLayout:Do,PipelineLayout:Oo,PipelineState:zo,CommandBuffer:To,Queue:Uo,GlobalBarrier:jo,TextureBarrier:Wo,RasterizerState:Mo,BlendState:Fo,BlendTarget:Bo,DepthStencilState:No,PipelineStateInfo:Lo};Object.assign(qo,xo),i.gfx=qo;var Xo,Yo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var Ko in i.gfx)if("__esModule"!==Ko){var Qo=Yo[Ko];""===Qo?Qo=Ko:void 0===Qo&&(Qo="GFX"+Ko),Nn(i,"cc",[{name:Qo,newName:Ko,target:i.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:wo,Buffer:So,CommandBuffer:To,get ObjectType(){return mr},get Status(){return vr},get API(){return gr},get SurfaceTransform(){return yr},get Feature(){return xr},get Format(){return Sr},get FormatType(){return Tr},get Type(){return Er},get BufferUsageBit(){return Ar},get BufferFlagBit(){return Cr},get MemoryAccessBit(){return br},get MemoryUsageBit(){return Pr},get TextureType(){return Rr},get TextureUsageBit(){return Ir},get TextureFlagBit(){return wr},get SampleCount(){return Dr},get VsyncMode(){return Or},get Filter(){return Mr},get Address(){return Nr},get ComparisonFunc(){return Br},get StencilOp(){return Fr},get BlendFactor(){return Lr},get BlendOp(){return zr},get ColorMask(){return Ur},get ShaderStageFlagBit(){return Gr},get LoadOp(){return kr},get StoreOp(){return Hr},get AccessType(){return Vr},get ResolveMode(){return jr},get PipelineBindPoint(){return Wr},get PrimitiveMode(){return qr},get PolygonMode(){return Xr},get ShadeModel(){return Yr},get CullMode(){return Kr},get DynamicStateFlagBit(){return Qr},get StencilFace(){return Zr},get DescriptorType(){return Jr},get QueueType(){return $r},get QueryType(){return ea},get CommandBufferType(){return ta},get ClearFlagBit(){return na},Size:sa,DeviceCaps:ca,Offset:la,Rect:ua,Extent:ha,TextureSubresLayers:_a,TextureSubresRange:fa,TextureCopy:pa,TextureBlit:da,BufferTextureCopy:ma,Viewport:va,Color:ga,BindingMappingInfo:ya,SwapchainInfo:xa,DeviceInfo:Sa,BufferInfo:Ta,BufferViewInfo:Ea,DrawInfo:Aa,DispatchInfo:Ca,IndirectBuffer:ba,TextureInfo:Pa,TextureViewInfo:Ra,SamplerInfo:Ia,Uniform:wa,UniformBlock:Da,UniformSamplerTexture:Oa,UniformSampler:Ma,UniformTexture:Na,UniformStorageImage:Ba,UniformStorageBuffer:Fa,UniformInputAttachment:La,ShaderStage:za,Attribute:Ua,ShaderInfo:Ga,InputAssemblerInfo:ka,ColorAttachment:Ha,DepthStencilAttachment:Va,SubpassInfo:ja,SubpassDependency:Wa,RenderPassInfo:qa,GlobalBarrierInfo:Xa,TextureBarrierInfo:Ya,FramebufferInfo:Ka,DescriptorSetLayoutBinding:Qa,DescriptorSetLayoutInfo:Za,DescriptorSetInfo:Ja,PipelineLayoutInfo:$a,InputState:eo,CommandBufferInfo:to,QueueInfo:no,QueryPoolInfo:io,FormatInfo:ro,MemoryStatus:ao,DynamicStencilStates:oo,DynamicStates:so,GFXObject:co,get AttributeName(){return oa},FormatInfos:lo,DESCRIPTOR_BUFFER_TYPE:uo,DESCRIPTOR_SAMPLER_TYPE:ho,DESCRIPTOR_DYNAMIC_TYPE:_o,DRAW_INFO_SIZE:28,IsPowerOf2:fo,FormatSize:po,FormatSurfaceSize:mo,GetTypeSize:go,getTypedArrayConstructor:yo,Device:Eo,Swapchain:Ao,Framebuffer:Co,InputAssembler:Io,DescriptorSetLayout:Do,PipelineLayout:Oo,RasterizerState:Mo,DepthStencilState:No,BlendTarget:Bo,BlendState:Fo,PipelineStateInfo:Lo,PipelineState:zo,Queue:Uo,RenderPass:Go,Sampler:ko,Shader:Ho,Texture:Vo,GlobalBarrier:jo,TextureBarrier:Wo})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Xo||(Xo={}));var Zo,Jo,$o,es,ts,ns,is,rs,as=(Zo=new di(0,0,0),function(e,t){var n=di.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;di.multiplyScalar(Zo,t.n,t.d);var i=di.dot(di.subtract(Zo,Zo,e.o),t.n)/n;return i<0?0:i}),os=(Jo=new di(0,0,0),$o=new di(0,0,0),es=new di(0,0,0),ts=new di(0,0,0),ns=new di(0,0,0),function(e,t,n){di.subtract(Jo,t.b,t.a),di.subtract($o,t.c,t.a),di.cross(es,e.d,$o);var i=di.dot(Jo,es);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;di.subtract(ts,e.o,t.a);var a=di.dot(ts,es)*r;if(a<0||a>1)return 0;di.cross(ns,ts,Jo);var o=di.dot(e.d,ns)*r;if(o<0||a+o>1)return 0;var s=di.dot($o,ns)*r;return s<0?0:s}),ss=function(){var e=new di(0,0,0);return function(t,n){var i=n.radius,r=n.center,a=t.o,o=t.d,s=i*i;di.subtract(e,r,a);var c=e.lengthSqr(),l=di.dot(e,o),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),cs=(is=new di,rs=new di,function(e,t){return di.subtract(is,t.center,t.halfExtents),di.add(rs,t.center,t.halfExtents),ls(e,is,rs)});function ls(e,t,n){var i=e.o,r=e.d,a=1/r.x,o=1/r.y,s=1/r.z,c=(t.x-i.x)*a,l=(n.x-i.x)*a,u=(t.y-i.y)*o,h=(n.y-i.y)*o,_=(t.z-i.z)*s,f=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var us,hs,_s,fs,ps=function(){var e=new di,t=new di,n=new di,i=new di,r=new di,a=new di,o=new di,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,di.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),di.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),di.set(a,_.orientation.m06,_.orientation.m07,_.orientation.m08),di.subtract(o,e,t),c[0]=di.dot(i,n),c[1]=di.dot(r,n),c[2]=di.dot(a,n),l[0]=di.dot(i,o),l[1]=di.dot(r,o),l[2]=di.dot(a,o);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),ds=function(){var e=new di,t=new di,n=new di,i=new di,r=new di,a=new di,o=new di,s=new ia;return function(c,l){var u=l.radius*l.radius,h=di.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=di.subtract(t,f,_);if(p.equals(di.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),$s.raySphere(c,s);var d=c.o,m=di.subtract(n,d,_),v=di.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=di.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),$s.raySphere(c,s)}var x=di.cross(r,m,p),S=p.lengthSqr(),T=2*di.dot(v,x),E=T*T-4*g*(x.lengthSqr()-u*S);if(E<0)return 0;var A=(-T-Math.sqrt(E))/(2*g);if(A<0){s.radius=l.radius;var C=di.subtract(a,f,d);return m.lengthSqr()<C.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),$s.raySphere(c,s)}var b=di.scaleAndAdd(a,c.o,h,A),P=di.subtract(o,b,_),R=di.dot(P,p)/S;return R>=0&&R<=1?A:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),$s.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),$s.raySphere(c,s)):0}}(),ms=(us=ra.create(),hs={distance:1/0,doubleSided:!1,mode:Xo.ANY},_s=0,fs=function(e,t,n,i,r,a){e===Xo.CLOSEST?(_s>t||0===_s)&&(_s=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(a[0].distance=t,a[0].vertexIndex0=n/3,a[0].vertexIndex1=i/3,a[0].vertexIndex2=r/3))):(_s=t,a&&a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(_s=0,0===t.geometricInfo.positions.length)return _s;var i=void 0===n?hs:n;if(ls(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,a=t.geometricInfo;!function(e,t,n,i,r){if(n===qr.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var s=3*t[o],c=3*t[o+1],l=3*t[o+2];di.set(us.a,e[s],e[s+1],e[s+2]),di.set(us.b,e[c],e[c+1],e[c+2]),di.set(us.c,e[l],e[l+1],e[l+2]);var u=$s.rayTriangle(i,us,r.doubleSided);if(!(0===u||u>r.distance)&&(fs(r.mode,u,s,c,l,r.result),r.mode===Xo.ANY))return u}else if(n===qr.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var p=3*t[f-_],d=3*t[f+_+1],m=3*t[f+2];di.set(us.a,e[p],e[p+1],e[p+2]),di.set(us.b,e[d],e[d+1],e[d+2]),di.set(us.c,e[m],e[m+1],e[m+2]),_=~_;var v=$s.rayTriangle(i,us,r.doubleSided);if(!(0===v||v>r.distance)&&(fs(r.mode,v,p,d,m,r.result),r.mode===Xo.ANY))return v}else if(n===qr.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];di.set(us.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],T=3*t[x+1];di.set(us.b,e[S],e[S+1],e[S+2]),di.set(us.c,e[T],e[T+1],e[T+2]);var E=$s.rayTriangle(i,us,r.doubleSided);if(!(0===E||E>r.distance)&&(fs(r.mode,E,y,S,T,r.result),r.mode===Xo.ANY))return E}}}(a.positions,a.indices,r,e,i)}return _s}),vs=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Xo.ANY};return function(n,i,r){e=0;var a=void 0===r?t:r,o=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!ls(n,s,c))return e;for(var l=0;l<o;l++){var u=i.renderingSubMeshes[l],h=ms(n,u,a);if(h)if(a.mode===Xo.CLOSEST)(0===e||e>h)&&(e=h,a.subIndices&&(a.subIndices[0]=l));else if(e=h,a.subIndices&&a.subIndices.push(l),a.mode===Xo.ANY)return h}return e&&a.mode===Xo.CLOSEST&&(a.result&&(a.result[0].distance=e,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),e}}(),gs=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Xo.ANY},n=new ur,i=new wi;return function(r,a,o){e=0;var s=void 0===o?t:o,c=a.worldBounds;if(c&&!cs(r,c))return e;ur.copy(n,r),a.node&&(wi.invert(i,a.node.getWorldMatrix(i)),di.transformMat4(n.o,r.o,i),di.transformMat4Normal(n.d,r.d,i));for(var l=a.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=ms(n,h,s);if(_)if(s.mode===Xo.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===Xo.ANY)return _}return e&&s.mode===Xo.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),ys=function(){var e=new di(0,0,0);return function(t,n){di.subtract(e,t.e,t.s);var i=(n.d-di.dot(t.s,n.n))/di.dot(e,n.n);return i<0||i>1?0:i}}(),xs=function(){var e=new di(0,0,0),t=new di(0,0,0),n=new di(0,0,0),i=new di(0,0,0),r=new di(0,0,0),a=new di(0,0,0);return function(o,s,c){di.subtract(e,s.b,s.a),di.subtract(t,s.c,s.a),di.subtract(n,o.s,o.e),di.cross(r,e,t);var l=di.dot(n,r);if(l<=0)return 0;di.subtract(i,o.s,s.a);var u=di.dot(i,r);if(u<0||u>l)return 0;di.cross(a,n,i);var h=di.dot(t,a);if(h<0||h>l)return 0;var _=-di.dot(e,a);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);di.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),Ss=new ur;function Ts(e,t){Ss.o.set(e.s),di.subtract(Ss.d,e.e,e.s),Ss.d.normalize();var n=cs(Ss,t);return n<=e.length()?n:0}function Es(e,t){Ss.o.set(e.s),di.subtract(Ss.d,e.e,e.s),Ss.d.normalize();var n=ps(Ss,t);return n<=e.length()?n:0}function As(e,t){Ss.o.set(e.s),di.subtract(Ss.d,e.e,e.s),Ss.d.normalize();var n=ss(Ss,t);return n<=e.length()?n:0}var Cs,bs,Ps,Rs,Is=(Cs=new di,bs=new di,Ps=new di,Rs=new di,function(e,t){return di.subtract(Cs,e.center,e.halfExtents),di.add(bs,e.center,e.halfExtents),di.subtract(Ps,t.center,t.halfExtents),di.add(Rs,t.center,t.halfExtents),Cs.x<=Rs.x&&bs.x>=Ps.x&&Cs.y<=Rs.y&&bs.y>=Ps.y&&Cs.z<=Rs.z&&bs.z>=Ps.z});function ws(e,t,n,i,r,a){di.set(a[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),di.set(a[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),di.set(a[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),di.set(a[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),di.set(a[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),di.set(a[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),di.set(a[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),di.set(a[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Ds(e,t){for(var n=di.dot(t,e[0]),i=n,r=1;r<8;++r){var a=di.dot(t,e[r]);n=a<n?a:n,i=a>i?a:i}return[n,i]}var Os,Ms,Ns,Bs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new di(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new di(0,0,0),i[r]=new di(0,0,0);var a=new di,o=new di;return function(t,r){di.set(e[0],1,0,0),di.set(e[1],0,1,0),di.set(e[2],0,0,1),di.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),di.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),di.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)di.cross(e[6+3*s],e[s],e[3]),di.cross(e[7+3*s],e[s],e[4]),di.cross(e[7+3*s],e[s],e[5]);di.subtract(a,t.center,t.halfExtents),di.add(o,t.center,t.halfExtents),function(e,t,n){di.set(n[0],e.x,t.y,t.z),di.set(n[1],e.x,t.y,e.z),di.set(n[2],e.x,e.y,t.z),di.set(n[3],e.x,e.y,e.z),di.set(n[4],t.x,t.y,t.z),di.set(n[5],t.x,t.y,e.z),di.set(n[6],t.x,e.y,t.z),di.set(n[7],t.x,e.y,e.z)}(a,o,n),ws(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Ds(n,e[c]),u=Ds(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Fs=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=di.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Ls=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Fs(e,t.planes[n]))return 0;return 1},zs=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new di(0,0,0);return function(i,r){for(var a=0,o=!1,s=0;s<r.planes.length;s++){if(-1===(a=Fs(i,r.planes[s])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var c=0;c<r.vertices.length;c++)di.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),Us=(Os=new di(0,0,0),Ms=new yi,function(e,t){return di.subtract(Os,t,e.center),di.transformMat3(Os,Os,yi.transpose(Ms,e.orientation)),n=Os,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Gs=(Ns=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ns(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ns(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ns(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=di.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ks=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Gs(e,t.planes[n]))return 0;return 1},Hs=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new di(0,0,0);var a=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,o){for(var s=0,c=!1,l=0;l<o.planes.length;l++){if(-1===(s=Gs(r,o.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<o.vertices.length;u++)di.subtract(e[u],o.vertices[u],r.center);n=0,i=0;for(var h=0;h<o.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var _=0;_<o.vertices.length;_++)(t=a(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var f=0;f<o.vertices.length;f++)(t=a(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===o.vertices.length||i===o.vertices.length?0:1}}(),Vs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new di(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new di(0,0,0),i[r]=new di(0,0,0);return function(t,r){di.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),di.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),di.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),di.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),di.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),di.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)di.cross(e[6+3*a],e[a],e[3]),di.cross(e[7+3*a],e[a],e[4]),di.cross(e[8+3*a],e[a],e[5]);ws(t.center,t.halfExtents,e[0],e[1],e[2],n),ws(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var o=0;o<15;++o){var s=Ds(n,e[o]),c=Ds(i,e[o]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),js=function(){for(var e=new ia,t=new di,n=new di,i=new di,r=new Array(8),a=0;a<8;a++)r[a]=new di;for(var o=new Array(8),s=0;s<8;s++)o[s]=new di;return function(a,s){if(0===di.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),$s.sphereOBB(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,n.x=a.orientation.m03,n.y=a.orientation.m04,n.z=a.orientation.m05,i.x=a.orientation.m06,i.y=a.orientation.m07,i.z=a.orientation.m08,ws(a.center,a.halfExtents,t,n,i,r);var c=o,l=di.copy(c[0],t),u=di.copy(c[1],n),h=di.copy(c[2],i);di.subtract(c[3],s.center,a.center).normalize();var _=di.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),di.cross(c[5],l,_),di.cross(c[6],u,_),di.cross(c[7],h,_);for(var f=0;f<8;++f){var p=Ds(r,c[f]),d=di.dot(c[f],s.ellipseCenter0),m=di.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),Ws=function(e,t){var n=di.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},qs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ws(e,t.planes[n]))return 0;return 1},Xs=function(){var e=new di(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var a=i.planes[r],o=n.radius,s=n.center,c=a.n,l=a.d,u=di.dot(c,s);if(u+o<l)return 0;if(!(u-o>l)){di.add(e,s,di.multiplyScalar(e,c,o));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(di.dot(_.n,e)<_.d)return 0}}}return 1}}(),Ys=function(e,t){var n=e.radius+t.radius;return di.squaredDistance(e.center,t.center)<n*n},Ks=function(){var e=new di;return function(t,n){return ar(e,t.center,n),di.squaredDistance(t.center,e)<t.radius*t.radius}}(),Qs=function(){var e=new di;return function(t,n){return or(e,t.center,n),di.squaredDistance(t.center,e)<t.radius*t.radius}}(),Zs=function(){var e=new di,t=new di;return function(n,i){var r=n.radius+i.radius,a=r*r,o=di.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===o)return di.squaredDistance(n.center,i.center)<a;di.subtract(e,n.center,i.ellipseCenter0),di.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=di.dot(e,t)/o;return s<0?di.squaredDistance(n.center,i.ellipseCenter0)<a:s>1?di.squaredDistance(n.center,i.ellipseCenter1)<a:(di.scaleAndAdd(e,i.ellipseCenter0,t,s),di.squaredDistance(n.center,e)<a)}}(),Js=function(){var e=new di,t=new di,n=new di,i=new di,r=new di,a=new di;return function(o,s){var c,l,u=di.subtract(e,o.ellipseCenter1,o.ellipseCenter0),h=di.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=di.subtract(n,o.ellipseCenter0,s.ellipseCenter0),f=di.dot(u,u),p=di.dot(u,h),d=di.dot(h,h),m=di.dot(u,_),v=di.dot(h,_),g=f*d-p*p,y=g,x=g;g<Wn?(c=0,y=1,l=v,x=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+p,x=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var S=Math.abs(c)<Wn?0:c/y,T=Math.abs(l)<Wn?0:l/x,E=i;E.set(_),E.add(di.multiplyScalar(r,u,S)),E.subtract(di.multiplyScalar(a,h,T));var A=o.radius+s.radius;return E.lengthSqr()<A*A}}(),$s={raySphere:ss,rayAABB:cs,rayOBB:ps,rayPlane:as,rayTriangle:os,rayCapsule:ds,raySubMesh:ms,rayMesh:vs,rayModel:gs,lineSphere:As,lineAABB:Ts,lineOBB:Es,linePlane:ys,lineTriangle:xs,sphereWithSphere:Ys,sphereAABB:Ks,sphereOBB:Qs,spherePlane:Ws,sphereFrustum:qs,sphereFrustumAccurate:Xs,sphereCapsule:Zs,aabbWithAABB:Is,aabbWithOBB:Bs,aabbPlane:Fs,aabbFrustum:Ls,aabbFrustumAccurate:zs,obbWithOBB:Vs,obbPlane:Gs,obbFrustum:ks,obbFrustumAccurate:Hs,obbPoint:Us,obbCapsule:js,capsuleWithCapsule:Js,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,a=this[i|r];return i<r?a(e,t,n):a(t,e,n)}};$s[cr.SHAPE_RAY|cr.SHAPE_SPHERE]=ss,$s[cr.SHAPE_RAY|cr.SHAPE_AABB]=cs,$s[cr.SHAPE_RAY|cr.SHAPE_OBB]=ps,$s[cr.SHAPE_RAY|cr.SHAPE_PLANE]=as,$s[cr.SHAPE_RAY|cr.SHAPE_TRIANGLE]=os,$s[cr.SHAPE_RAY|cr.SHAPE_CAPSULE]=ds,$s[cr.SHAPE_LINE|cr.SHAPE_SPHERE]=As,$s[cr.SHAPE_LINE|cr.SHAPE_AABB]=Ts,$s[cr.SHAPE_LINE|cr.SHAPE_OBB]=Es,$s[cr.SHAPE_LINE|cr.SHAPE_PLANE]=ys,$s[cr.SHAPE_LINE|cr.SHAPE_TRIANGLE]=xs,$s[cr.SHAPE_SPHERE]=Ys,$s[cr.SHAPE_SPHERE|cr.SHAPE_AABB]=Ks,$s[cr.SHAPE_SPHERE|cr.SHAPE_OBB]=Qs,$s[cr.SHAPE_SPHERE|cr.SHAPE_PLANE]=Ws,$s[cr.SHAPE_SPHERE|cr.SHAPE_FRUSTUM]=qs,$s[cr.SHAPE_SPHERE|cr.SHAPE_FRUSTUM_ACCURATE]=Xs,$s[cr.SHAPE_SPHERE|cr.SHAPE_CAPSULE]=Zs,$s[cr.SHAPE_AABB]=Is,$s[cr.SHAPE_AABB|cr.SHAPE_OBB]=Bs,$s[cr.SHAPE_AABB|cr.SHAPE_PLANE]=Fs,$s[cr.SHAPE_AABB|cr.SHAPE_FRUSTUM]=Ls,$s[cr.SHAPE_AABB|cr.SHAPE_FRUSTUM_ACCURATE]=zs,$s[cr.SHAPE_OBB]=Vs,$s[cr.SHAPE_OBB|cr.SHAPE_PLANE]=Gs,$s[cr.SHAPE_OBB|cr.SHAPE_FRUSTUM]=ks,$s[cr.SHAPE_OBB|cr.SHAPE_FRUSTUM_ACCURATE]=Hs,$s[cr.SHAPE_OBB|cr.SHAPE_CAPSULE]=js,$s[cr.SHAPE_CAPSULE]=Js,Nn(lr.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Bn($s,"intersect",[{name:"line_quad"}]);var ec,tc,nc,ic,rc,ac,oc,sc=new di(0,0,0),cc=new di(0,0,0),lc=i.mat4(),uc=i.v4(),hc=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=cr.SHAPE_PLANE,this.n=new di(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return di.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return di.subtract(sc,n,t),di.subtract(cc,i,t),di.normalize(e.n,di.cross(e.n,sc,cc)),e.d=di.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return di.copy(e.n,t),e.d=di.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return di.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){wi.invert(lc,e),wi.transpose(lc,lc),zi.set(uc,this.n.x,this.n.y,this.n.z,this.d),zi.transformMat4(uc,uc,lc),di.set(this.n,uc.x,uc.y,uc.z),this.d=uc.w},B(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),_c=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(oc||(oc={}));var fc,pc,dc=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new _c(e,r,this._stride);var a=oc.NEVER,o=!1,s=!1;for(var c in t){if(o=this._hasFloat32,(s=this._hasUint32)&&o)break;a=t[c],o||a!==oc.FLOAT32?s||a!==oc.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],a=[],o=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&a.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&o.push(l);return c&&this._uint32BufferViews.push(a),s&&this._float32BufferViews.push(r),this._freeLists.push(o),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,a=(this._dataType[t]===oc.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],o=this._dataMembers[t];return a.subarray(r,r+o)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(fc||(fc={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(pc||(pc={}));var mc,vc=((ec={})[pc.DIRTY_FLAG]=oc.UINT32,ec[pc.LAYER]=oc.UINT32,ec[pc.WORLD_SCALE]=oc.FLOAT32,ec[pc.WORLD_POSITION]=oc.FLOAT32,ec[pc.WORLD_ROTATION]=oc.FLOAT32,ec[pc.WORLD_MATRIX]=oc.FLOAT32,ec[pc.LOCAL_SCALE]=oc.FLOAT32,ec[pc.LOCAL_POSITION]=oc.FLOAT32,ec[pc.LOCAL_ROTATION]=oc.FLOAT32,ec[pc.COUNT]=oc.NEVER,ec),gc=((tc={})[pc.DIRTY_FLAG]=pc.LAYER-pc.DIRTY_FLAG,tc[pc.LAYER]=pc.WORLD_SCALE-pc.LAYER,tc[pc.WORLD_SCALE]=pc.WORLD_POSITION-pc.WORLD_SCALE,tc[pc.WORLD_POSITION]=pc.WORLD_ROTATION-pc.WORLD_POSITION,tc[pc.WORLD_ROTATION]=pc.WORLD_MATRIX-pc.WORLD_ROTATION,tc[pc.WORLD_MATRIX]=pc.LOCAL_SCALE-pc.WORLD_MATRIX,tc[pc.LOCAL_SCALE]=pc.LOCAL_POSITION-pc.LOCAL_SCALE,tc[pc.LOCAL_POSITION]=pc.LOCAL_ROTATION-pc.LOCAL_POSITION,tc[pc.LOCAL_ROTATION]=pc.COUNT-pc.LOCAL_ROTATION,tc[pc.COUNT]=1,tc),yc=new dc(fc.NODE,vc,gc,pc);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(mc||(mc={}));var xc,Sc=((nc={})[mc.PRIORITY]=oc.UINT32,nc[mc.STAGE]=oc.UINT32,nc[mc.PHASE]=oc.UINT32,nc[mc.PRIMITIVE]=oc.UINT32,nc[mc.BATCHING_SCHEME]=oc.UINT32,nc[mc.DYNAMIC_STATE]=oc.UINT32,nc[mc.HASH]=oc.UINT32,nc[mc.COUNT]=oc.NEVER,nc),Tc=((ic={})[mc.PRIORITY]=mc.STAGE-mc.PRIORITY,ic[mc.STAGE]=mc.PHASE-mc.STAGE,ic[mc.PHASE]=mc.PRIMITIVE-mc.PHASE,ic[mc.PRIMITIVE]=mc.BATCHING_SCHEME-mc.PRIMITIVE,ic[mc.BATCHING_SCHEME]=mc.DYNAMIC_STATE-mc.BATCHING_SCHEME,ic[mc.DYNAMIC_STATE]=mc.HASH-mc.DYNAMIC_STATE,ic[mc.HASH]=mc.COUNT-mc.HASH,ic[mc.COUNT]=1,ic),Ec=new dc(fc.PASS,Sc,Tc,mc);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(xc||(xc={}));var Ac=((rc={})[xc.CENTER]=oc.FLOAT32,rc[xc.HALFEXTENTS]=oc.FLOAT32,rc[xc.COUNT]=oc.NEVER,rc),Cc=((ac={})[xc.CENTER]=xc.HALFEXTENTS-xc.CENTER,ac[xc.HALFEXTENTS]=xc.COUNT-xc.HALFEXTENTS,ac[xc.COUNT]=1,ac),bc=new dc(fc.AABB,Ac,Cc,xc),Pc=new di,Rc=new di,Ic=new di,wc=new di,Dc=new yi,Oc=function(e,t,n){Dc.m00=Math.abs(n.m00),Dc.m01=Math.abs(n.m01),Dc.m02=Math.abs(n.m02),Dc.m03=Math.abs(n.m04),Dc.m04=Math.abs(n.m05),Dc.m05=Math.abs(n.m06),Dc.m06=Math.abs(n.m08),Dc.m07=Math.abs(n.m09),Dc.m08=Math.abs(n.m10),di.transformMat3(e,t,Dc)},Mc=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=cr.SHAPE_AABB,this.center=new di(e,t,n),this.halfExtents=new di(i,r,a)}e.create=function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return di.copy(e.center,t.center),di.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return di.add(Pc,n,t),di.subtract(Rc,n,t),di.multiplyScalar(e.center,Pc,.5),di.multiplyScalar(e.halfExtents,Rc,.5),e},e.set=function(e,t,n,i,r,a,o){return e.center.set(t,n,i),e.halfExtents.set(r,a,o),e},e.merge=function(t,n,i){return di.subtract(Pc,n.center,n.halfExtents),di.subtract(Rc,i.center,i.halfExtents),di.add(Ic,n.center,n.halfExtents),di.add(wc,i.center,i.halfExtents),di.max(wc,Ic,wc),di.min(Ic,Pc,Rc),e.fromPoints(t,Ic,wc)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return di.transformMat4(e.center,t.center,n),Oc(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){di.subtract(e,this.center,this.halfExtents),di.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){di.transformMat4(r.center,this.center,e),Oc(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Pc,Rc),e.x<Pc.x&&(Pc.x=e.x),e.y<Pc.y&&(Pc.y=e.y),e.z<Pc.z&&(Pc.z=e.z),e.x>Rc.x&&(Rc.x=e.x),e.y>Rc.y&&(Rc.y=e.y),e.z>Rc.z&&(Rc.z=e.z),di.add(Ic,Pc,Rc),this.center.set(di.multiplyScalar(Ic,Ic,.5)),this.halfExtents.set(Rc.x-Ic.x,Rc.y-Ic.y,Rc.z-Ic.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},B(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Nc=new di,Bc=new di,Fc=new yi,Lc=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===o&&(o=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=cr.SHAPE_OBB,this.center=new di(e,t,n),this.halfExtents=new di(i,r,a),this.orientation=new yi(o,s,c,l,u,h,_,f,p)}e.create=function(t,n,i,r,a,o,s,c,l,u,h,_,f,p,d){return new e(t,n,i,r,a,o,s,c,l,u,h,_,f,p,d)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return di.copy(e.center,t.center),di.copy(e.halfExtents,t.halfExtents),yi.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return di.multiplyScalar(e.center,di.add(Nc,t,n),.5),di.multiplyScalar(e.halfExtents,di.subtract(Bc,n,t),.5),yi.identity(e.orientation),e},e.set=function(e,t,n,i,r,a,o,s,c,l,u,h,_,f,p,d){return di.set(e.center,t,n,i),di.set(e.halfExtents,r,a,o),yi.set(e.orientation,s,c,l,u,h,_,f,p,d),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Fc.m00=Math.abs(n.m00),Fc.m01=Math.abs(n.m01),Fc.m02=Math.abs(n.m02),Fc.m03=Math.abs(n.m03),Fc.m04=Math.abs(n.m04),Fc.m05=Math.abs(n.m05),Fc.m06=Math.abs(n.m06),Fc.m07=Math.abs(n.m07),Fc.m08=Math.abs(n.m08),di.transformMat3(e,t,Fc)}(Nc,this.halfExtents,this.orientation),di.subtract(e,this.center,Nc),di.add(t,this.center,Nc)},t.transform=function(e,t,n,i,r){di.transformMat4(r.center,this.center,e),yi.fromQuat(r.orientation,n),di.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){di.transformMat4(n.center,this.center,e),yi.fromQuat(n.orientation,t)},t.setScale=function(e,t){di.multiply(t.halfExtents,this.halfExtents,e)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),zc=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=cr.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new di,this.rotation=new Ti,this.ellipseCenter0=new di(0,t,0),this.ellipseCenter1=new di(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var a=i,o=li(a);r.radius=this.radius*Math.abs(o);var s=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;s<0&&(s=0),r.halfHeight=s,di.transformMat4(r.center,this.center,e),Ti.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),di.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),di.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},B(e,[{key:"type",get:function(){return this._type}}]),e}(),Uc=new Array(8);Uc[0]=new di(1,1,1),Uc[1]=new di(-1,1,1),Uc[2]=new di(-1,-1,1),Uc[3]=new di(1,-1,1),Uc[4]=new di(1,1,-1),Uc[5]=new di(-1,1,-1),Uc[6]=new di(-1,-1,-1),Uc[7]=new di(1,-1,-1);var Gc,kc,Hc=new di,Vc=new di,jc=new di,Wc=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=cr.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=hc.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new di}e.createFromAABB=function(e,t){var n=new di,i=new di;return di.subtract(n,t.center,t.halfExtents),di.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==cr.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var a=Math.tan(.5*t.fov),o=a*t.aspect;Hc.set(i*o,i*a,i),Vc.set(r*o,r*a,r);var s=e.vertices;return jc.set(Hc.x,Hc.y,Hc.z),di.transformMat4(s[0],jc,n),jc.set(-Hc.x,Hc.y,Hc.z),di.transformMat4(s[1],jc,n),jc.set(-Hc.x,-Hc.y,Hc.z),di.transformMat4(s[2],jc,n),jc.set(Hc.x,-Hc.y,Hc.z),di.transformMat4(s[3],jc,n),jc.set(Vc.x,Vc.y,Vc.z),di.transformMat4(s[4],jc,n),jc.set(-Vc.x,Vc.y,Vc.z),di.transformMat4(s[5],jc,n),jc.set(-Vc.x,-Vc.y,Vc.z),di.transformMat4(s[6],jc,n),jc.set(Vc.x,-Vc.y,Vc.z),di.transformMat4(s[7],jc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)hc.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)di.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(di.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),di.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),di.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),di.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),di.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),di.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===cr.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();di.multiplyScalar(i.n,i.n,r),i.d*=r}for(var a=0;a<8;a++)di.transformMat4(this.vertices[a],Uc[a],t)}},t.transform=function(e){if(this._type===cr.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)di.transformMat4(this.vertices[t],this.vertices[t],e);hc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),hc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),hc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),hc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),hc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),hc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},t.updatePlanes=function(){hc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),hc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),hc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),hc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),hc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),hc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},B(e,[{key:"accurate",set:function(e){this._type=e?cr.SHAPE_FRUSTUM_ACCURATE:cr.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();Wc.createOrtho=function(e,t,n,i,r,a){var o=t/2,s=n/2;di.set(jc,o,s,-i),di.transformMat4(e.vertices[0],jc,a),di.set(jc,-o,s,-i),di.transformMat4(e.vertices[1],jc,a),di.set(jc,-o,-s,-i),di.transformMat4(e.vertices[2],jc,a),di.set(jc,o,-s,-i),di.transformMat4(e.vertices[3],jc,a),di.set(jc,o,s,-r),di.transformMat4(e.vertices[4],jc,a),di.set(jc,-o,s,-r),di.transformMat4(e.vertices[5],jc,a),di.set(jc,-o,-s,-r),di.transformMat4(e.vertices[6],jc,a),di.set(jc,o,-s,-r),di.transformMat4(e.vertices[7],jc,a),hc.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),hc.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),hc.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),hc.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),hc.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),hc.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Gc||(Gc={})),function(e){e[e.Default=Gc.Default]="Default",e[e.Normal=Gc.Normal]="Normal",e[e.Reverse=Gc.Reverse]="Reverse",e[e.Loop=Gc.Loop]="Loop",e[e.LoopReverse=Gc.Loop|Gc.Reverse]="LoopReverse",e[e.PingPong=Gc.PingPong]="PingPong",e[e.PingPongReverse=Gc.PingPong|Gc.Reverse]="PingPongReverse"}(kc||(kc={})),Ze(kc);var qc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function Xc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,a=r>>>1;i<=r;a=i+r>>>1){var o=e[a];if(o>t+n)r=a-1;else{if(!(o<t-n))return a;i=a+1}}return~i}var Yc=function(){},Kc=function(){return Yc},Qc=Zc((function(){}));function Zc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function Jc(e){return function(t){return function(n){!function(e,t,n){var i=el(e);if(i){var r=tl(i,"proto");tl(r,"editor")[t]=n}}(n,e,t)}}}var $c="__ccclassCache__";function el(e){return tl(e,$c)}function tl(e,t){return e[t]||(e[t]={})}var nl=Zc((function(e,t){var n=ke.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[$c];if(r){var a=r.proto;a&&ke.mixin(i,a),e[$c]=void 0}return kt(i)})),il=Jc("requireComponent"),rl=Jc("executionOrder"),al=Qc;function ol(e,t,n){var i=null;function r(e,t,n){var r=el(e.constructor);if(r){var a=tl(r,"proto"),o=tl(a,"properties");!function(e,t,n,i,r,a){var o,s=r&&(r.get||r.set);i&&(o=Dt(i,s));var c=t[n],l=ke.mixin(c||{},o||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,o,t,i,n,r)}}return void 0===e?ol({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var sl=Symbol("cc:SerializationMetadata"),cl=function(e,t,n){return ol(hl({}))(e,t,n)};function ll(e){return ol(hl({formerlySerializedAs:e}))}var ul=function(e,t,n){return ol({editorOnly:!0})(e,t,n)};function hl(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var _l=Yc,fl=Qc,pl=Kc,dl=Qc,ml=Kc,vl=Kc,gl=Kc,yl=Yc,xl=Kc,Sl=Yc,Tl=Kc,El=Kc,Al=Kc,Cl=Kc,bl=Kc,Pl=Yc,Rl=Kc,Il=Yc,wl=Yc,Dl=Bl(St),Ol=Bl(Tt),Ml=Bl(Et),Nl=Bl(At);function Bl(e){return ol({type:e})}var Fl,Ll,zl,Ul,Gl,kl,Hl,Vl,jl,Wl=function(e,t,n){return ol({__noImplicit:!0,override:!0})(e,t,n)},ql=nl("cc.KeyframeCurve")((Fl=Symbol.iterator,kl=function(){function e(){q(this,"_times",Ul,this),q(this,"_values",Gl,this)}var t=e.prototype;return t[Fl]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return Xc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return Xc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||Xn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,a=Xc(n,e);if(a>=0)return a;var o=~a;return 0===o?(n.unshift(e),i.unshift(t)):o===r?(n.push(e),i.push(t)):(n.splice(o-1,0,e),i.splice(o-1,0,t)),o},B(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),Ul=X((zl=kl).prototype,"_times",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gl=X(zl.prototype,"_values",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ll=zl))||Ll;function Xl(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(Hl||(Hl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Vl||(Vl=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(jl||(jl=e("TangentWeightMode",{})));var Yl=function(){},Kl=Object.freeze({__proto__:null,uniquelyReferenced:_l,ccclass:nl,property:ol,requireComponent:il,executionOrder:rl,disallowMultiple:al,allowReplicated:function(e){kt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:fl,menu:pl,playOnFocus:dl,inspector:ml,icon:vl,help:gl,type:Bl,integer:Dl,float:Ol,boolean:Ml,string:Nl});e("_decorator",Kl);var Ql=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=ke.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=ke.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},B(e,[{key:"count",get:function(){return this._count}}]),e}(),Zl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(A(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();Zl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=ke.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},B(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var Jl,$l=new Ql,eu=new Ql,tu=new Ql,nu=new Ql,iu=new Zl("normal load",[]),ru=new Zl("fetch",[]),au=new Zl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(Jl||(Jl={}));var ou,su={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(ou||(ou={}));var cu=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var a="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[a]&&this[a](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();cu.MAX_DEAD_NUM=500,cu._taskId=0,cu._deadPool=[];var lu="0123456789abcdef".split(""),uu=["","","",""],hu=uu.concat(uu,"-",uu,"-",uu,"-",uu,"-",uu,uu,uu),_u=hu.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function fu(e){var t=e.split("@")[0];if(22!==t.length)return e;hu[0]=e[0],hu[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=rt[e.charCodeAt(n)],a=rt[e.charCodeAt(n+1)];hu[_u[i++]]=lu[r>>2],hu[_u[i++]]=lu[(3&r)<<2|a>>4],hu[_u[i++]]=lu[15&a]}return e.replace(t,hu.join(""))}var pu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function du(e){var t=pu.exec(e);return t?t[1]:""}function mu(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=nu.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),yu(e,t)}function vu(e){return!!e&&(e instanceof i.SceneAsset||e instanceof i.Scene)}function gu(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function yu(e,t){var n=cu.create({input:e,options:t}),i=[];try{for(var r,a=W(au.sync(n));!(r=a()).done;){var o=r.value,s=o.url;o.recycle(),i.push(s)}}catch(e){for(var c,l=W(n.output);!(c=l()).done;)c.value.recycle();d(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var xu,Su,Tu,Eu,Au,Cu,bu,Pu,Ru=Object.freeze({__proto__:null,getUuidFromURL:du,getUrlWithUuid:mu,isScene:vu,normalize:gu,transform:yu,decodeUuid:fu}),Iu=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),wu=nl("cc.GCObject")(xu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,Iu.registerGCObject(V(t))||V(t)}L(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return Iu.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(Yt))||xu,Du=e("Asset",nl("cc.Asset")((Au=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,q(t,"_native",Eu,V(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(V(t),"_uuid",{value:"",writable:!0}),t}L(t,e),t.deserialize=function(e){return i.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&i.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return v(w(12101,this._uuid)),e.prototype.destroy.call(this)},B(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=mu(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=mu(this._uuid,{__nativeName__:e,nativeExt:gn(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(an(wu)),Eu=X((Tu=Au).prototype,"_native",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),X(Tu.prototype,"_nativeAsset",[ol],Object.getOwnPropertyDescriptor(Tu.prototype,"_nativeAsset"),Tu.prototype),Su=Tu))||Su);Du.prototype.createNode=null,i.Asset=Du;var Ou=e("Script",nl("cc.Script")(Cu=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(Du))||Cu);i._Script=Ou;var Mu=e("JavaScript",nl("cc.JavaScript")(bu=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(Ou))||bu);i._JavaScript=Mu;var Nu,Bu,Fu,Lu,zu,Uu,Gu,ku,Hu,Vu,ju,Wu=e("TypeScript",nl("cc.TypeScript")(Pu=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(Ou))||Pu);i._TypeScript=Wu;var qu,Xu,Yu,Ku,Qu=new ee("Comp"),Zu=Yt.Flags.IsOnLoadCalled,Ju=e("Component",(Nu=nl("cc.Component"),Bu=Tl(),Fu=Bl(Ou),Lu=El(),Nu((ju=Vu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"node",Gu,V(t)),q(t,"_enabled",ku,V(t)),q(t,"__prefab",Hu,V(t)),t._sceneGetter=null,t._id=Qu.getNewId(),t}L(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=i.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,r){void 0===t&&(t=0),void 0===n&&(n=i.macro.REPEAT_FOREVER),void 0===r&&(r=0),I(e,1619),I((t=t||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,r=r||0;var a=i.director.getScheduler(),o=a.isTargetPaused(this);a.schedule(e,this,t,n,r,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&i.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){i.director.getScheduler().unscheduleAllForTarget(this)},B(t,[{key:"name",get:function(){if(this._name)return this._name;var e=fe(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=i.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Zu}}]),t}(Yt),Vu.system=null,X((Uu=ju).prototype,"__scriptAsset",[Bu,Fu,Lu,wl],Object.getOwnPropertyDescriptor(Uu.prototype,"__scriptAsset"),Uu.prototype),Gu=X(Uu.prototype,"node",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ku=X(Uu.prototype,"_enabled",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hu=X(Uu.prototype,"__prefab",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=Uu))||zu)),$u=Ju.prototype;$u.update=null,$u.lateUpdate=null,$u.__preload=null,$u.onLoad=null,$u.start=null,$u.onEnable=null,$u.onDisable=null,$u.onDestroy=null,$u.onFocusInEditor=null,$u.onLostFocusInEditor=null,$u.resetInEditor=null,$u._getLocalBounds=null,$u.onRestore=null,Ju._requireComponent=null,Ju._executionOrder=0,ce(Ju,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),i.Component=Ju;var eh,th=e("MissingScript",nl("cc.MissingScript")(qu=ml()((Ku=function(e){function t(){var t;return q(t=e.call(this)||this,"_$erialized",Yu,V(t)),t}return L(t,e),t.safeFindClass=function(e){var t=Fe(e);if(t)return t;i.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){A(4600,this.node.name)},t}(Ju),Yu=X((Xu=Ku).prototype,"_$erialized",[cl,ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qu=Xu))||qu)||qu);i._MissingScript=th;try{var nh=th.__values__;0!==nh.length&&"_$erialized"===nh[nh.length-1]||(d("The '_$erialized' prop in MissingScript is missing. Please contact jare."),d("    Error props: ['"+nh+"']"))}catch(ir){d("Error when checking MissingScript 5, "+ir)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(eh||(eh={}));var ih,rh={auto:eh.AUTO,landscape:eh.LANDSCAPE,portrait:eh.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(ih||(ih={}));var ah=new(function(e){function t(){var t,n,i,r,a,o;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new ki(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=eh.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(a=r.parentNode)||void 0===a||a.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(o=s[c],void 0!==document[o[1]]){for(var l=0;l<o.length;l++)t._fn[s[0][l]]=o[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}L(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=rh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ih.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===ih.Fullscreen?document[this._fn.fullscreenElement]:e===ih.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=fn.isMobile&&(t&&e===eh.PORTRAIT||!t&&e===eh.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void A(9201);var e,t,n=i.view.getDesignResolutionSize(),r=this._gameFrame,a=r.clientWidth,o=r.clientHeight,s=n.width,c=n.height,l=a/s,u=o/c,h=this._gameContainer.style;l<u?(e=a,t=c*l):(e=s*u,t=o),h.width=e+"px",h.height=t+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else A(9201)},B(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===ih.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):A(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new ki(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ki(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(A(9201),new ki(0,0));var e,t,n;switch(this._windowType){case ih.SubFrame:return this._gameFrame?new ki(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(A(9201),new ki(0,0));case ih.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new ki(t,n);case ih.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ki(t,n);case ih.Unknown:default:return new ki(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?ih.Fullscreen:this._gameFrame?this._exactFitScreen?ih.BrowserWindow:ih.SubFrame:(A(9201),ih.Unknown)}}]),t}(_n)),oh=function(){function e(){}var t=e.prototype;return t._init=function(e){ah.init(e,(function(){var e,t=i.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=ah.resolutionScale:A(1220)}))},t.fullScreen=function(){return ah.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&A(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ah.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return ah.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},B(e,[{key:"devicePixelRatio",get:function(){return ah.devicePixelRatio}},{key:"windowSize",get:function(){return ah.windowSize},set:function(e){ah.windowSize=e}},{key:"resolution",get:function(){return ah.resolution}},{key:"supportsFullScreen",get:function(){return ah.supportFullScreen}}]),e}(),sh=e("screen",new oh);i.screen=sh;var ch=e("sys",{Feature:hn,hasFeature:function(e){return fn.hasFeature(e)},NetworkType:cn,Language:sn,OS:ln,Platform:un,BrowserType:on,isNative:fn.isNative,isBrowser:fn.isBrowser,isMobile:fn.isMobile,isLittleEndian:fn.isLittleEndian,platform:fn.platform,language:fn.language,languageCode:fn.nativeLanguage,os:fn.os,osVersion:fn.osVersion,osMainVersion:fn.osMainVersion,browserType:fn.browserType,browserVersion:fn.browserVersion,windowPixelResolution:sh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:fn.hasFeature(hn.WEBP),imageBitmap:fn.hasFeature(hn.IMAGE_BITMAP),touches:fn.hasFeature(hn.INPUT_TOUCH),mouse:fn.hasFeature(hn.EVENT_MOUSE),keyboard:fn.hasFeature(hn.EVENT_KEYBOARD),accelerometer:fn.hasFeature(hn.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return fn.networkType},getBatteryLevel:function(){return fn.getBatteryLevel()},garbageCollect:function(){fn.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",f(e+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){fn.openURL(e)},now:function(){return fn.now()},restartVM:function(){fn.restartJSVM()},getSafeAreaRect:function(){var e=i.view,t=ah.safeAreaEdge,n=ah.windowSize,r=new Ni(t.left,t.bottom),a=new Ni(n.width-t.right,n.height-t.top);e._convertToUISpace(r),e._convertToUISpace(a);var o=r.x,s=r.y,c=a.x-r.x,l=a.y-r.y;return new Vi(o,s,c,l)}});!function(){try{var e=ch.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){A(5200)};ch.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}ch.__isWebIOS14OrIPadOS14Env=(ch.os===ln.IOS||ch.os===ln.OSX)&&fn.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),i.sys=ch;var lh=e("serializeTag",Symbol("[[Serialize]]")),uh=e("deserializeTag",Symbol("[[Deserialize]]")),hh=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return B(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function _h(e){var t=e;return{chunks:t.chunks,document:t.document}}function fh(e){if(e.length<16)throw new ph(w(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new ph(w(13100));var n=t.getUint32(4,!0);if(1!==n)throw new ph(w(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new ph(w(13102));var i=12,r=t.getUint32(i,!0);i+=4;var a=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var o,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(w(13104))}(a);try{o=JSON.parse(s)}catch(e){throw new ph(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new ph(w(13102));return new hh(o,c)}var ph=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(H(Error));function dh(e,t,n,r,a){if(t instanceof i.ValueType){a||e.push("if(prop){");var o=fe(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),a||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+r+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},B(e,[{key:"byteLength",get:function(){return this._length}}])}(),i.internal.parseCCONJson=_h,i.internal.decodeCCONBinary=fh,i.internal.CCON=hh;var mh="$_$default",vh="$_$formerlySerializedAs",gh=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return L(t,e),t.prototype.get=function(e,t,n,i,r){var a=this._get();return a?(a.reset(e,t,n,i,r),a):new yh(e,t,n,i,r)},t}(Ue),yh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof hh?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,a=e.__type__,o=this._classFinder(a,e,n,i);if(!o)return this._classFinder===Fe&&this._reportMissingClass(a),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(o);return this._deserializeInto(e,s,o),s},t._deserializeInto=function(e,t,n,r){void 0===r&&(r=!1),r||!t[uh]?t._deserialize?t._deserialize(e.content,this):i.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ce(n);r&&i._deserializeInto(e,t,r)}};t[uh](r,this._context)},t._deserializeFireClass=function(e,t,n){var r;if(n.hasOwnProperty("__deserialize__"))r=n.__deserialize__;else{r=function(e,t){for(var n=gt(t),r=t.__values__,a=["var prop;"],o=et.test(ze(t)),s=0;s<r.length;s++){var c=r[s],l=void 0,u=void 0;kt.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=kt.escapeForJS(c))+"]";var h=l;if(n[c+vh]){var _=n[c+vh];h=kt.IDENTIFIER_RE.test(_)?"."+_:"["+kt.escapeForJS(_)+"]"}a.push("prop=d"+h+";"),a.push('if(typeof prop!=="undefined"){');var f=kt.getDefault(n[c+mh]);if(o){var p=void 0,d=n[c+"$_$type"];if(void 0===f&&d)p=d instanceof xt;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?a.push("o"+l+"=prop;"):dh(a,f,l,u,!0)}else a.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),dh(a,f,l,u,!1),a.push("}");a.push("}")}return(i.js.isChildClassOf(t,i._BaseNode)||i.js.isChildClassOf(t,i.Component))&&a.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(a.push("o._$erialized=JSON.parse(JSON.stringify(d));"),a.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",a.join(""))}(0,n);try{if(n===th){var a=n.__values__;0!==a.length&&"_$erialized"===a[a.length-1]||(d("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),d("    Error props: ['"+a+"']. Please contact jare."));var o=r;r=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||d("Unable to load previously serialized data. "+JSON.stringify(n))}catch(e){d("Error when checking MissingScript 7, "+e)}o(e,t,n,i)}}}catch(e){d("Error when checking MissingScript 6, "+e)}ce(n,"__deserialize__",r,!0)}r(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var a,o=this._serializedData[i];e[n]=this._deserializeObject(o,i,void 0,n),null===(a=this._onDereferenced)||void 0===a||a.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===i.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===i.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==i.Color){if(n===i.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=gt(n),a=n.__values__,o=0;o<a.length;o++){var s=a[o],c=t[s];void 0!==c||t.hasOwnProperty(s)||(c=kt.getDefault(r[s+mh])),"object"!=typeof c?e[s]=c:c?this._deserializeAndAssignField(e,c,s):e[s]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}},e}();yh.pool=new gh;var xh=[Ni,di,zi,Ti,fi,ki,Vi,wi];function Sh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Th=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Sh,Sh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){wi.fromArray(e,t,1)}],Eh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function Ah(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),a=i[1],o=i[2],s=n[n.length-1],c=1;c<s;++c)r[a[n[c]]]=t[c];for(;c<t.length;++c){var l=a[n[c]],u=i[n[c]+o];(0,wh[u])(e,r,l,t[c])}return r}function Ch(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):b(5303,fe(t)),i}function bh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Ph(e){return function(t,n,i,r){n[i]=r;for(var a=0;a<r.length;++a)e(t,r,a,r[a])}}function Rh(e,t,n,i){t[n]=null,e[8][i]=t}function Ih(e,t,n,i){t[n]=Ah(e,i)}Eh.pool=new Ue((function(e){e.reset()}),5),Eh.pool.get=function(){return this._get()||new Eh};var wh=new Array(13);function Dh(e,t,n){return e||n(t),Object}function Oh(e,t,n,i,r,a,o){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Dh(a,i,o);return t[n]=r,new r}}(n,i,t));s=Dh(a,t,o)}n[i]=s}function Mh(e,t,n,i){for(var r=n||Fe,a=e[3],o=0;o<a.length;++o){var s=a[o];"string"!=typeof s?Oh(r,s[0],s,0,t,n,i):Oh(r,s,a,o,t,n,i)}}function Nh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Bh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var r,a=!t;if(t=t||Eh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Fh}return!1}(e)){t.init(e),n=n||{};var o,s=e[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(w(5304,s));n._version=s,n.result=t,e[0]=n,c||(Mh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Bh.reportMissingClass),Nh(e)),i.game._isCloning=!0;var l=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],a=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--a);for(var o=0;o<a;++o)t[o]=Ah(e,t[o]);for(var s=e[3],c=0;c<i;++c,++o){var l=n[c],u=t[o];if(l>=0){var h=s[l];t[o]=Ch(e,h,u)}else(0,wh[l=~l])(e,t,o,u)}return r}(e);i.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,a=3*e[i];r<a;r+=3){var o=e[r],s=t[e[r+2]],c=e[r+1];c>=0?o[n[c]]=s:o[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],l,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],a=e[9],o=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=a[s];"number"==typeof l&&(l=l>=0?n[l]:~l,a[s]=l);var u=o[s];"number"==typeof u&&(o[s]=i[u])}}(e),r=l[u]}else r=function(e,t,n){var r,a=(n=n||{}).classFinder||Fe,o=n.createAssetRefs||ch.platform===un.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(r=n.reportMissingClass)&&void 0!==r?r:i.deserialize.reportMissingClass;t.init();var u=yh.pool.get(t,a,l,s,c);i.game._isCloning=!0;var h=u.deserialize(e);return i.game._isCloning=!1,yh.pool.put(u),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return a&&Eh.pool.put(t),r}wh[0]=function(e,t,n,i){t[n]=i},wh[1]=bh,wh[2]=Ph(bh),wh[3]=Ph(Rh),wh[4]=Ih,wh[5]=function(e,t,n,i){Th[i[0]](t[n],i)},wh[6]=Rh,wh[7]=function(e,t,n,i){t[n].set(i)},wh[8]=function(e,t,n,i){var r=new xh[i[0]];Th[i[0]](r,i),t[n]=r},wh[9]=Ph(Ih),wh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Ch(e,r,i[1])},wh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=1;a<i.length;a+=3){var o=i[a],s=i[a+1],c=i[a+2];(0,wh[s])(e,r,o,c)}},wh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=0;a<r.length;++a){var o=r[a],s=i[a+1];0!==s&&(0,wh[s])(e,r,a,o)}},Bh.Details=Eh,Bh.reportMissingClass=function(e){b(5302,e)};var Fh=function(e){this.preprocessed=!0,this.version=e};function Lh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}i.deserialize=Bh;var zh,Uh,Gh,kh,Hh,Vh,jh,Wh,qh,Xh,Yh,Kh=Yt.Flags.Destroyed,Qh=Yt.Flags.PersistentMask,Zh=[];function Jh(e){var t;if(e instanceof Yt){if(e._instantiate)return i.game._isCloning=!0,t=e._instantiate(null,!0),i.game._isCloning=!1,t;if(e instanceof i.Asset)throw new TypeError(w(6903))}return i.game._isCloning=!0,t=$h(e),i.game._isCloning=!1,t}function $h(e,t){var n;e_(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=Zh.length;i<r;++i)Zh[i]._iN$t=null;return Zh.length=0,n}function e_(e,t,n){ke.value(e,"_iN$t",t,!0),Zh.push(e);var r=e.constructor;if(i.Class._isCCClass(r))!function(e,t,n,i){for(var r=e.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];if("object"==typeof s&&s){var c=n[o];c instanceof Je&&c.constructor===s.constructor?c.set(s):n[o]=s._iN$t||t_(s,i)}else n[o]=s}}(r,e,t,n);else for(var a in e)if(e.hasOwnProperty(a)&&(95!==a.charCodeAt(0)||95!==a.charCodeAt(1)||"__type__"===a||"__prefab"===a)){var o=e[a];if("object"==typeof o&&o){if(o===t)continue;t[a]=o._iN$t||t_(o,n)}else t[a]=o}e instanceof Yt&&(t._objFlags&=Qh)}function t_(e,t){if(e instanceof Je)return e.clone();if(e instanceof i.Asset)return e;var n;if(ArrayBuffer.isView(e)){var r=e.length;n=new e.constructor(r),e._iN$t=n,Zh.push(e);for(var a=0;a<r;++a)n[a]=e[a];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,Zh.push(e);for(var s=0;s<o;++s){var c=e[s];n[s]="object"==typeof c&&c?c._iN$t||t_(c,t):c}return n}if(e._objFlags&Kh)return null;var l=e.constructor;if(i.Class._isCCClass(l)){if(t)if(t instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return e}else if(t instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof i.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return e_(e,n,t),n}function n_(e,t){return(t<<3)+e}function i_(e){return a_[e]}function r_(e){switch(e){case Xh.Uint8:return Uint8Array;case Xh.Uint16:return Uint16Array;case Xh.Uint32:return Uint32Array;case Xh.Int8:return Int8Array;case Xh.Int16:return Int16Array;case Xh.Int32:return Int32Array;case Xh.Float32:return Float32Array;case Xh.Float64:return Float64Array}}Jh._clone=$h,i.instantiate=Jh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Xh||(Xh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Yh||(Yh={})),e("CompactValueTypeArray",nl("cc.CompactValueTypeArray")((Wh=jh=function(){function e(){q(this,"_byteOffset",Gh,this),q(this,"_unitCount",kh,this),q(this,"_unitElement",Hh,this),q(this,"_length",Vh,this)}return e.lengthFor=function(e,t,n){return i_(t).requiredUnits*e.length*r_(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,a,o){for(var s=i_(n),c=r_(i),l=s.requiredUnits*t.length,u=new c(r,a,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=n_(i,n),_._byteOffset=o,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=i_(n.elementType),a=new(r_(i))(e,this._byteOffset,this._unitCount),o=new Array(this._length),s=0;s<this._length;++s)o[s]=r.decompress(a,s);return o},e}(),jh.StorageUnit=Xh,jh.ElementType=Yh,Gh=X((Uh=Wh).prototype,"_byteOffset",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kh=X(Uh.prototype,"_unitCount",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hh=X(Uh.prototype,"_unitElement",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n_(Xh.Uint8,Yh.Scalar)}}),Vh=X(Uh.prototype,"_length",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zh=Uh))||zh);var a_=((qh={})[Yh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},qh[Yh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new di(e[2*t],e[2*t+1])}},qh[Yh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new di(e[3*t],e[3*t+1],e[3*t+2])}},qh[Yh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new zi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},qh[Yh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Ti(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},qh[Yh.Mat4]={requiredUnits:16,compress:function(e,t,n){wi.toArray(e,n,16*t)},decompress:function(e,t){return wi.fromArray(new wi,e,16*t)}},qh);function o_(){return 0}function s_(e){return e}function c_(e){return e*e}function l_(e){return e*(2-e)}function u_(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function h_(e){return e*e*e}function __(e){return--e*e*e+1}function f_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function p_(e){return e*e*e*e}function d_(e){return 1- --e*e*e*e}function m_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function v_(e){return e*e*e*e*e}function g_(e){return--e*e*e*e*e+1}function y_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function x_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function S_(e){return Math.sin(e*Math.PI/2)}function T_(e){return.5*(1-Math.cos(Math.PI*e))}function E_(e){return 0===e?0:Math.pow(1024,e-1)}function A_(e){return 1===e?1:1-Math.pow(2,-10*e)}function C_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function b_(e){return 1-Math.sqrt(1-e*e)}function P_(e){return Math.sqrt(1- --e*e)}function R_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function I_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function w_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function D_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function O_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function M_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function N_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function B_(e){return 1-F_(1-e)}function F_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function L_(e){return e<.5?.5*B_(2*e):.5*F_(2*e-1)+.5}function z_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function U_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}i._decorator=Kl;var G_=Q_(c_,l_),k_=Q_(h_,__),H_=Q_(p_,d_),V_=Q_(v_,g_),j_=Q_(x_,S_),W_=Q_(E_,A_),q_=Q_(b_,P_),X_=Q_(I_,w_),Y_=Q_(O_,M_),K_=Q_(B_,F_);function Q_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var Z_,J_,$_=Object.freeze({__proto__:null,constant:o_,linear:s_,quadIn:c_,quadOut:l_,quadInOut:u_,cubicIn:h_,cubicOut:__,cubicInOut:f_,quartIn:p_,quartOut:d_,quartInOut:m_,quintIn:v_,quintOut:g_,quintInOut:y_,sineIn:x_,sineOut:S_,sineInOut:T_,expoIn:E_,expoOut:A_,expoInOut:C_,circIn:b_,circOut:P_,circInOut:R_,elasticIn:I_,elasticOut:w_,elasticInOut:D_,backIn:O_,backOut:M_,backInOut:N_,bounceIn:B_,bounceOut:F_,bounceInOut:L_,smooth:z_,fade:U_,quadOutIn:G_,cubicOutIn:k_,quartOutIn:H_,quintOutIn:V_,sineOutIn:j_,expoOutIn:W_,circOutIn:q_,elasticOutIn:X_,backOutIn:Y_,bounceOutIn:K_});e("easing",$_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(J_||(J_={}));var ef,tf,nf,rf,af,of=((Z_={})[J_.CONSTANT]=o_,Z_[J_.LINEAR]=s_,Z_[J_.QUAD_IN]=c_,Z_[J_.QUAD_OUT]=l_,Z_[J_.QUAD_IN_OUT]=u_,Z_[J_.QUAD_OUT_IN]=G_,Z_[J_.CUBIC_IN]=h_,Z_[J_.CUBIC_OUT]=__,Z_[J_.CUBIC_IN_OUT]=f_,Z_[J_.CUBIC_OUT_IN]=k_,Z_[J_.QUART_IN]=p_,Z_[J_.QUART_OUT]=d_,Z_[J_.QUART_IN_OUT]=m_,Z_[J_.QUART_OUT_IN]=H_,Z_[J_.QUINT_IN]=v_,Z_[J_.QUINT_OUT]=g_,Z_[J_.QUINT_IN_OUT]=y_,Z_[J_.QUINT_OUT_IN]=V_,Z_[J_.SINE_IN]=x_,Z_[J_.SINE_OUT]=S_,Z_[J_.SINE_IN_OUT]=T_,Z_[J_.SINE_OUT_IN]=j_,Z_[J_.EXPO_IN]=E_,Z_[J_.EXPO_OUT]=A_,Z_[J_.EXPO_IN_OUT]=C_,Z_[J_.EXPO_OUT_IN]=W_,Z_[J_.CIRC_IN]=b_,Z_[J_.CIRC_OUT]=P_,Z_[J_.CIRC_IN_OUT]=R_,Z_[J_.CIRC_OUT_IN]=q_,Z_[J_.ELASTIC_IN]=I_,Z_[J_.ELASTIC_OUT]=w_,Z_[J_.ELASTIC_IN_OUT]=D_,Z_[J_.ELASTIC_OUT_IN]=X_,Z_[J_.BACK_IN]=O_,Z_[J_.BACK_OUT]=M_,Z_[J_.BACK_IN_OUT]=N_,Z_[J_.BACK_OUT_IN]=Y_,Z_[J_.BOUNCE_IN]=B_,Z_[J_.BOUNCE_OUT]=F_,Z_[J_.BOUNCE_IN_OUT]=L_,Z_[J_.BOUNCE_OUT_IN]=K_,Z_[J_.SMOOTH]=z_,Z_[J_.FADE]=U_,Z_);function sf(e){return of[e]}var cf,lf,uf,hf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=Hl.LINEAR,t.tangentWeightMode=jl.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=J_.LINEAR,t}return L(t,e),t}(Yl);function _f(e){var t=new hf;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,a=e.rightTangent,o=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[Wt];t.value=null!=r?r:t.value,t.rightTangent=null!=a?a:t.rightTangent,t.rightTangentWeight=null!=o?o:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[Wt]=u)}return t}kt.fastDefine("cc.RealKeyframeValue",hf,{interpolationMode:Hl.LINEAR,tangentWeightMode:jl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:J_.LINEAR}),kt.Attr.setClassAttr(hf,Wt,"editorOnly",!0),(cf=hf,null!==(uf=(lf=cf)[sl])&&void 0!==uf?uf:lf[sl]={}).uniquelyReferenced=!0;var ff,pf=e("RealCurve",nl("cc.RealCurve")((af=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",nf,V(t)),q(t,"postExtrapolation",rf,V(t)),t}L(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],a=t[i-1];if(e<r){var o=this.preExtrapolation,s=n[0];if(o===Vl.CLAMP||i<2)return s.value;switch(o){case Vl.LINEAR:return wf(r,n[0].value,t[1],n[1].value,e);case Vl.LOOP:e=Rf(e,r,a);break;case Vl.PING_PONG:e=If(e,r,a);break;default:return s.value}}else if(e>a){var c=this.postExtrapolation,l=n[i-1];if(c===Vl.CLAMP||i<2)return l.value;switch(c){case Vl.LINEAR:return wf(a,l.value,t[i-2],n[i-2].value,e);case Vl.LOOP:e=Rf(e,r,a);break;case Vl.PING_PONG:e=If(e,r,a);break;default:return l.value}}var u=Xc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],p=n[_],d=t[h];return function(e,t,n,i,r){var a=n-e;switch(t.interpolationMode){default:case Hl.CONSTANT:return t.value;case Hl.LINEAR:var o=t.easingMethod===J_.LINEAR?r:sf(t.easingMethod)(r);return Qn(t.value,i.value,o);case Hl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&jl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&jl.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=a,m=a*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+e,y=Math.sin(v)*p+t.value,x=0;if(f)x=_;else{var S=a,T=a*h;x=Math.sqrt(S*S+T*T)*s}var E=Math.atan(h),A=(g-e)/a,C=(-Math.cos(E)*x+n-e)/a,b=y,P=-Math.sin(E)*x+i.value,R=[0,0,0],I=function(e,t,n,i,r){var a=n/i,o=t/i,s=a*a,c=1/3*(-1/3*s+o),l=.5*(2/27*a*s-1/3*a*o+e/i),u=c*c*c,h=l*l+u,_=0;if(Xl(h)){if(Xl(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*a,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*A,3*C-6*A,3*(A-C)+1,R),w=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var a=e[r];a>=0&&a<=1&&a>i&&(i=a)}i===-1/0&&(i=0)}return i}(R,I,r);return Df(t.value,b,P,i.value,w)}var D=t.value+s*c*a,O=i.value-s*h*a;return Df(t.value,D,O,i.value,r)}}(f,p,d,n[h],(e-f)/(d-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,_f(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return _f(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return _f(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return Xn(n.value,t,e)}))},n[lh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,a=new DataView(new ArrayBuffer(0+df+df+mf+vf*r+Cf*r)),o=0;a.setUint8(o,this.preExtrapolation),o+=df,a.setUint8(o,this.postExtrapolation),o+=df,a.setUint32(o,r,!0),o+=mf,n.forEach((function(e,t){return a.setFloat32(o+vf*t,e,!0)})),o+=vf*r;for(var s,c=W(i);!(s=c()).done;){var l=s.value;o=bf(a,l,o)}var u=new Uint8Array(a.buffer,0,o);e.writeProperty("bytes",u);var h=i.map((function(e){return e[Wt]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[uh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=df,this.postExtrapolation=i.getUint8(r),r+=df;var a=i.getUint32(r,!0);r+=mf;var o=Array.from({length:a},(function(e,t){return i.getFloat32(r+vf*t,!0)}));r+=vf*a;for(var s=new Array(a),c=0;c<a;++c){var l=_f({});r=Pf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][Wt]=e}))),this._times=o,this._values=s}else e.readThis()},t}(ql),nf=X((tf=af).prototype,"preExtrapolation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vl.CLAMP}}),rf=X(tf.prototype,"postExtrapolation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vl.CLAMP}}),ef=tf))||ef);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(ff||(ff={}));var df=1,mf=4,vf=4,gf=_f({}),yf=gf.interpolationMode,xf=gf.tangentWeightMode,Sf=gf.leftTangent,Tf=gf.leftTangentWeight,Ef=gf.rightTangent,Af=gf.rightTangentWeight,Cf=26;function bf(e,t,n){var i=0,r=n,a=r;r+=4;var o=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,o,!0),r+=4,s!==yf&&(i|=ff.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==xf&&(i|=ff.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==Sf&&(i|=ff.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==Tf&&(i|=ff.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==Ef&&(i|=ff.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==Af&&(i|=ff.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(a,i,!0),r}function Pf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&ff.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&ff.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&ff.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&ff.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&ff.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&ff.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var a=(65280&r)>>8;return t.easingMethod=a,i}function Rf(e,t,n){return t+oi(e-t,n-t)}function If(e,t,n){return t+si(e-t,n-t)}function wf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function Df(e,t,n,i,r){var a=1-r;return a*a*a*e+3*a*a*r*t+3*a*r*r*n+r*r*r*i}function Of(e,t,n,i,r){var a=1-r;return a*(a*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}i.bezier=Of;var Mf,Nf,Bf,Ff,Lf,zf,Uf,Gf,kf,Hf,Vf,jf=Math.cos,Wf=Math.acos,qf=Math.max,Xf=2*Math.PI,Yf=Math.sqrt;function Kf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Qf(e,t){var n=function(e,t){var n,i,r,a,o=t-0,s=t-e[0],c=3*o,l=3*s,u=3*(t-e[2]),h=1/(-o+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+o*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,T=Yf(S*S*S),E=-g/(2*T),A=Wf(E<-1?-1:E>1?1:E),C=2*Kf(T);return i=C*jf(A*_)-p,r=C*jf((A+Xf)*_)-p,a=C*jf((A+2*Xf)*_)-p,i>=0&&i<=1?r>=0&&r<=1?a>=0&&a<=1?qf(i,r,a):qf(i,r):a>=0&&a<=1?qf(i,a):i:r>=0&&r<=1?a>=0&&a<=1?qf(r,a):r:a}if(0===x)return r=-(n=y<0?Kf(-y):-Kf(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?qf(i,r):i:r;var b=Yf(x);return(n=Kf(-y+b))-Kf(y+b)-p}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}i.bezierByTime=Qf,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Vf||(Vf=e("QuatInterpolationMode",{})));var Zf=nl("cc.QuatKeyframeValue")(Mf=_l((Bf=X((Nf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;q(this,"interpolationMode",Bf,this),q(this,"value",Ff,this),q(this,"easingMethod",Lf,this),this.value=n?Ti.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vf.SLERP}}),Ff=X(Nf.prototype,"value",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.clone(Ti.IDENTITY)}}),Lf=X(Nf.prototype,"easingMethod",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J_.LINEAR}}),Mf=Nf))||Mf)||Mf;function Jf(e){return new Zf(e)}var $f,ep=e("QuatCurve",nl("cc.QuatCurve")((Hf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",Gf,V(t)),q(t,"postExtrapolation",kf,V(t)),t}L(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Ti);var i=this._times,r=this._values,a=this.postExtrapolation,o=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(o){case Vl.LOOP:e=c+oi(e-c,l-c);break;case Vl.PING_PONG:e=c+si(e-c,l-c);break;case Vl.CLAMP:default:return Ti.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(a){case Vl.LOOP:e=c+oi(e-c,l-c);break;case Vl.PING_PONG:e=c+si(e-c,l-c);break;case Vl.CLAMP:default:return Ti.copy(t,h.value)}}var _=Xc(i,e);if(_>=0)return Ti.copy(t,r[_].value);var f=~_,p=f-1,d=i[p],m=r[p],v=i[f],g=r[f],y=(e-d)/(v-d);switch(m.interpolationMode){default:case Vf.CONSTANT:return Ti.copy(t,m.value);case Vf.SLERP:var x=m.easingMethod,S=x===J_.LINEAR?y:Array.isArray(x)?Qf(x,y):sf(x)(y);return Ti.slerp(t,m.value,g.value,S)}},n.addKeyFrame=function(t,n){var i=new Zf(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Jf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Jf(e[1])})))}},n[lh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var a=n.length,o=hp*(r?1:a),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?_p+4*pp:_p)}),0),c=0,l=new DataView(new ArrayBuffer(c+=sp+cp+lp*a+4*up*a+s+o+0)),u=0,h=0;r&&(h|=$f.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=sp,l.setUint32(u,a,!0),u+=cp,n.forEach((function(e,t){return l.setFloat32(u+lp*t,e,!0)})),u+=lp*a,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,a=n.z,o=n.w,s=u+4*up*t;l.setFloat32(s+0*up,i,!0),l.setFloat32(s+1*up,r,!0),l.setFloat32(s+2*up,a,!0),l.setFloat32(s+3*up,o,!0)})),u+=4*up*a,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,fp),++u,l.setFloat32(u+0*pp,t[0],!0),l.setFloat32(u+1*pp,t[1],!0),l.setFloat32(u+2*pp,t[2],!0),l.setFloat32(u+3*pp,t[3],!0),u+=4*pp):(l.setUint8(u,t),++u)}));var _=u;u+=o;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=hp)}));var p=new Uint8Array(l.buffer);e.writeProperty("bytes",p)}else e.writeThis()},n[uh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,a=i.getUint32(r,!0);r+=sp;var o=a&$f.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=cp;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+lp*t,!0)})),l=r+=lp*s;r+=4*up*s;var u=Array.from({length:s},(function(e,t){var n=l+4*up*t,a=i.getFloat32(n+0*up,!0),o=i.getFloat32(n+1*up,!0),s=i.getFloat32(n+2*up,!0),c=i.getFloat32(n+3*up,!0),u=i.getUint8(r);++r;var h=Jf({value:{x:a,y:o,z:s,w:c}});return u!==fp?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*pp,!0),i.getFloat32(r+1*pp,!0),i.getFloat32(r+2*pp,!0),i.getFloat32(r+3*pp,!0)],r+=4*pp),h}));if(o){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=i.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else e.readThis()},t}(ql),Gf=X((Uf=Hf).prototype,"preExtrapolation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vl.CLAMP}}),kf=X(Uf.prototype,"postExtrapolation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vl.CLAMP}}),zf=Uf))||zf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}($f||($f={}));var tp,np,ip,rp,ap,op,sp=1,cp=4,lp=4,up=4,hp=1,_p=1,fp=255,pp=4,dp=e("ObjectCurve",nl("cc.ObjectCurve")(tp=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=Yn(~t-1,0,this._values.length-1);return this._values[n]},t}(ql))||tp),mp=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};kt.fastDefine("cc.Keyframe",mp,{time:0,value:0,inTangent:0,outTangent:0});var vp=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),gp=nl("cc.AnimationCurve")((op=ap=function(){function e(e){if(void 0===e&&(e=null),q(this,"_curve",rp,this),this.cachedKey=void 0,e instanceof pf)this._curve=e;else{var t=new pf;this._curve=t,t.preExtrapolation=Vl.LOOP,t.postExtrapolation=Vl.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:Hl.CUBIC,value:1}],[1,{interpolationMode:Hl.CUBIC,value:1}]])}this.cachedKey=new vp}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:Hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,a=e<0?n.preExtrapolation:n.postExtrapolation,o=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(a){case Vl.LOOP:r=oi(e-o,s-o)+o;break;case Vl.PING_PONG:r=si(e-o,s-o)+o;break;case Vl.CLAMP:default:r=Yn(e,o,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),a=this._curve.getKeyframeValue(t),o=a.value,s=a.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-o,f=1/(h*h),p=s*h,d=u*h;e.coefficient[0]=(p+d-_-_)*f/h,e.coefficient[1]=(_+_+_-p-p-d)*f,e.coefficient[2]=s,e.coefficient[3]=o},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var a=0;a<3;a++){var o=r+a;if(o+1<i&&n.getKeyframeTime(o+1)>t)return o}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},B(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new mp;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return xp(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=yp(e)}},{key:"postWrapMode",get:function(){return xp(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=yp(e)}}]),e}(),ap.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],rp=X((ip=op).prototype,"_curve",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),np=ip))||np;function yp(e){switch(e){default:case Gc.Default:case Gc.Normal:case Gc.Clamp:return Vl.CLAMP;case Gc.PingPong:return Vl.PING_PONG;case Gc.Loop:return Vl.LOOP}}function xp(e){switch(e){default:case Vl.LINEAR:case Vl.CLAMP:return Gc.Clamp;case Vl.PING_PONG:return Gc.PingPong;case Vl.LOOP:return Gc.Loop}}function Sp(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}Nn($s,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Tp=function(e){function t(){var t;return t=e.call(this)||this,Sp("line","Line"),t}return L(t,e),t}(lr),Ep=function(e){function t(){var t;return t=e.call(this)||this,Sp("plane","Plane"),t}return L(t,e),t}(hc),Ap=function(e){function t(){var t;return t=e.call(this)||this,Sp("ray","Ray"),t}return L(t,e),t}(ur),Cp=function(e){function t(){var t;return t=e.call(this)||this,Sp("triangle","Triangle"),t}return L(t,e),t}(ra),bp=function(e){function t(){var t;return t=e.call(this)||this,Sp("sphere","Sphere"),t}return L(t,e),t}(ia),Pp=function(e){function t(){var t;return t=e.call(this)||this,Sp("aabb","AABB"),t}return L(t,e),t}(Mc),Rp=function(e){function t(){var t;return t=e.call(this)||this,Sp("obb","OBB"),t}return L(t,e),t}(Lc),Ip=function(e){function t(){var t;return t=e.call(this)||this,Sp("capsule","Capsule"),t}return L(t,e),t}(zc),wp=function(e){function t(){var t;return t=e.call(this)||this,Sp("frustum","Frustum"),t}return L(t,e),t}(Wc),Dp=Object.freeze({__proto__:null,distance:sr,enums:cr,intersect:$s,Line:lr,Plane:hc,Ray:ur,Triangle:ra,Sphere:ia,AABB:Mc,OBB:Lc,Capsule:zc,Frustum:Wc,Keyframe:mp,AnimationCurve:gp,get ERaycastMode(){return Xo},line:Tp,plane:Ep,ray:Ap,triangle:Cp,sphere:bp,aabb:Pp,obb:Rp,capsule:Ip,frustum:wp});e("geometry",Dp);var Op={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Mp=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=W(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],w(2104,t),e.Enum[t]=i,ke.value(e.Enum,String(i),t),e.BitMask[t]=i,ke.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):In(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Mp.Enum=Ye(Op),Mp.BitMask=Xe(F({},Op)),i.Layers=Mp;var Np,Bp,Fp="MainFlow",Lp="ForwardFlow",zp="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Np||(Np={})),i.RenderPassStage=Np,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Bp||(Bp={}));var Up,Gp={bindings:[],layouts:{}},kp={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Up||(Up={}));var Hp,Vp=Up.SAMPLER_SHADOWMAP,jp=Up.COUNT-Vp;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(Hp||(Hp={}));var Wp,qp=Hp.SAMPLER_JOINTS,Xp=Hp.COUNT-qp;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Wp||(Wp={}));var Yp=new ya;Yp.bufferOffsets=[0,Vp+qp,Vp],Yp.samplerOffsets=[-Vp,jp+Xp,jp-qp],Yp.flexibleSet=1;var Kp=function(){};Kp.SIZE=4*(Kp.COUNT=4+(Kp.SCREEN_SIZE_OFFSET=4+(Kp.NATIVE_SIZE_OFFSET=4+(Kp.TIME_OFFSET=0)))),Kp.NAME="CCGlobal",Kp.BINDING=Up.UBO_GLOBAL,Kp.DESCRIPTOR=new Qa(Kp.BINDING,Jr.UNIFORM_BUFFER,1,Gr.ALL),Kp.LAYOUT=new Da(Wp.GLOBAL,Kp.BINDING,Kp.NAME,[new wa("cc_time",Er.FLOAT4,1),new wa("cc_screenSize",Er.FLOAT4,1),new wa("cc_nativeSize",Er.FLOAT4,1)],1),Gp.layouts[Kp.NAME]=Kp.LAYOUT,Gp.bindings[Kp.BINDING]=Kp.DESCRIPTOR;var Qp=function(){};Qp.SIZE=4*(Qp.COUNT=4+(Qp.VIEW_PORT_OFFSET=4+(Qp.NEAR_FAR_OFFSET=4+(Qp.GLOBAL_FOG_ADD_OFFSET=4+(Qp.GLOBAL_FOG_BASE_OFFSET=4+(Qp.GLOBAL_FOG_COLOR_OFFSET=4+(Qp.AMBIENT_GROUND_OFFSET=4+(Qp.AMBIENT_SKY_OFFSET=4+(Qp.MAIN_LIT_COLOR_OFFSET=4+(Qp.MAIN_LIT_DIR_OFFSET=4+(Qp.EXPOSURE_OFFSET=4+(Qp.SCREEN_SCALE_OFFSET=4+(Qp.CAMERA_POS_OFFSET=16+(Qp.MAT_VIEW_PROJ_INV_OFFSET=16+(Qp.MAT_VIEW_PROJ_OFFSET=16+(Qp.MAT_PROJ_INV_OFFSET=16+(Qp.MAT_PROJ_OFFSET=16+(Qp.MAT_VIEW_INV_OFFSET=16+(Qp.MAT_VIEW_OFFSET=0))))))))))))))))))),Qp.NAME="CCCamera",Qp.BINDING=Up.UBO_CAMERA,Qp.DESCRIPTOR=new Qa(Qp.BINDING,Jr.UNIFORM_BUFFER,1,Gr.ALL),Qp.LAYOUT=new Da(Wp.GLOBAL,Qp.BINDING,Qp.NAME,[new wa("cc_matView",Er.MAT4,1),new wa("cc_matViewInv",Er.MAT4,1),new wa("cc_matProj",Er.MAT4,1),new wa("cc_matProjInv",Er.MAT4,1),new wa("cc_matViewProj",Er.MAT4,1),new wa("cc_matViewProjInv",Er.MAT4,1),new wa("cc_cameraPos",Er.FLOAT4,1),new wa("cc_screenScale",Er.FLOAT4,1),new wa("cc_exposure",Er.FLOAT4,1),new wa("cc_mainLitDir",Er.FLOAT4,1),new wa("cc_mainLitColor",Er.FLOAT4,1),new wa("cc_ambientSky",Er.FLOAT4,1),new wa("cc_ambientGround",Er.FLOAT4,1),new wa("cc_fogColor",Er.FLOAT4,1),new wa("cc_fogBase",Er.FLOAT4,1),new wa("cc_fogAdd",Er.FLOAT4,1),new wa("cc_nearFar",Er.FLOAT4,1),new wa("cc_viewPort",Er.FLOAT4,1)],1),Gp.layouts[Qp.NAME]=Qp.LAYOUT,Gp.bindings[Qp.BINDING]=Qp.DESCRIPTOR;var Zp=function(){};Zp.SIZE=4*(Zp.COUNT=4+(Zp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Zp.SHADOW_COLOR_OFFSET=4+(Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Zp.SHADOW_PROJ_INFO_OFFSET=4+(Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Zp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Zp.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Zp.MAT_LIGHT_VIEW_OFFSET=16+(Zp.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Zp.NAME="CCShadow",Zp.BINDING=Up.UBO_SHADOW,Zp.DESCRIPTOR=new Qa(Zp.BINDING,Jr.UNIFORM_BUFFER,1,Gr.ALL),Zp.LAYOUT=new Da(Wp.GLOBAL,Zp.BINDING,Zp.NAME,[new wa("cc_matLightPlaneProj",Er.MAT4,1),new wa("cc_matLightView",Er.MAT4,1),new wa("cc_matLightViewProj",Er.MAT4,1),new wa("cc_shadowInvProjDepthInfo",Er.FLOAT4,1),new wa("cc_shadowProjDepthInfo",Er.FLOAT4,1),new wa("cc_shadowProjInfo",Er.FLOAT4,1),new wa("cc_shadowNFLSInfo",Er.FLOAT4,1),new wa("cc_shadowWHPBInfo",Er.FLOAT4,1),new wa("cc_shadowLPNNInfo",Er.FLOAT4,1),new wa("cc_shadowColor",Er.FLOAT4,1),new wa("cc_planarNDInfo",Er.FLOAT4,1)],1),Gp.layouts[Zp.NAME]=Zp.LAYOUT,Gp.bindings[Zp.BINDING]=Zp.DESCRIPTOR;var Jp=Up.SAMPLER_SHADOWMAP,$p=new Qa(Jp,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),ed=new Oa(Wp.GLOBAL,Jp,"cc_shadowMap",Er.SAMPLER2D,1);Gp.layouts.cc_shadowMap=ed,Gp.bindings[Jp]=$p;var td=Up.SAMPLER_ENVIRONMENT,nd=new Qa(td,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),id=new Oa(Wp.GLOBAL,td,"cc_environment",Er.SAMPLER_CUBE,1);Gp.layouts.cc_environment=id,Gp.bindings[td]=nd;var rd=Up.SAMPLER_DIFFUSEMAP,ad=new Qa(rd,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),od=new Oa(Wp.GLOBAL,rd,"cc_diffuseMap",Er.SAMPLER_CUBE,1);Gp.layouts.cc_diffuseMap=od,Gp.bindings[rd]=ad;var sd=Up.SAMPLER_SPOT_LIGHTING_MAP,cd=new Qa(sd,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),ld=new Oa(Wp.GLOBAL,sd,"cc_spotLightingMap",Er.SAMPLER2D,1);Gp.layouts.cc_spotLightingMap=ld,Gp.bindings[sd]=cd;var ud=function(){};ud.SIZE=4*(ud.COUNT=4+(ud.LIGHTINGMAP_UVPARAM=16+(ud.MAT_WORLD_IT_OFFSET=16+(ud.MAT_WORLD_OFFSET=0)))),ud.NAME="CCLocal",ud.BINDING=Hp.UBO_LOCAL,ud.DESCRIPTOR=new Qa(ud.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX|Gr.COMPUTE),ud.LAYOUT=new Da(Wp.LOCAL,ud.BINDING,ud.NAME,[new wa("cc_matWorld",Er.MAT4,1),new wa("cc_matWorldIT",Er.MAT4,1),new wa("cc_lightingMapUVParam",Er.FLOAT4,1)],1),kp.layouts[ud.NAME]=ud.LAYOUT,kp.bindings[ud.BINDING]=ud.DESCRIPTOR;var hd=function(){};hd.SIZE=4*(hd.COUNT=4+(hd.WORLD_BOUND_HALF_EXTENTS=4+(hd.WORLD_BOUND_CENTER=0))),hd.NAME="CCWorldBound",hd.BINDING=Hp.UBO_LOCAL,hd.DESCRIPTOR=new Qa(hd.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX|Gr.COMPUTE),hd.LAYOUT=new Da(Wp.LOCAL,hd.BINDING,hd.NAME,[new wa("cc_worldBoundCenter",Er.FLOAT4,1),new wa("cc_worldBoundHalfExtents",Er.FLOAT4,1)],1),kp.layouts[hd.NAME]=hd.LAYOUT,kp.bindings[hd.BINDING]=hd.DESCRIPTOR;var _d="a_matWorld0",fd=function(){};fd.BATCHING_COUNT=10,fd.MAT_WORLDS_OFFSET=0,fd.SIZE=4*(fd.COUNT=16*fd.BATCHING_COUNT),fd.NAME="CCLocalBatched",fd.BINDING=Hp.UBO_LOCAL,fd.DESCRIPTOR=new Qa(fd.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX|Gr.COMPUTE),fd.LAYOUT=new Da(Wp.LOCAL,fd.BINDING,fd.NAME,[new wa("cc_matWorlds",Er.MAT4,fd.BATCHING_COUNT)],1),kp.layouts[fd.NAME]=fd.LAYOUT,kp.bindings[fd.BINDING]=fd.DESCRIPTOR;var pd=function(){};pd.LIGHTS_PER_PASS=1,pd.SIZE=4*(pd.COUNT=(pd.LIGHT_DIR_OFFSET=(pd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(pd.LIGHT_COLOR_OFFSET=(pd.LIGHT_POS_OFFSET=0)+4*pd.LIGHTS_PER_PASS)+4*pd.LIGHTS_PER_PASS)+4*pd.LIGHTS_PER_PASS)+4*pd.LIGHTS_PER_PASS),pd.NAME="CCForwardLight",pd.BINDING=Hp.UBO_FORWARD_LIGHTS,pd.DESCRIPTOR=new Qa(pd.BINDING,Jr.DYNAMIC_UNIFORM_BUFFER,1,Gr.FRAGMENT),pd.LAYOUT=new Da(Wp.LOCAL,pd.BINDING,pd.NAME,[new wa("cc_lightPos",Er.FLOAT4,pd.LIGHTS_PER_PASS),new wa("cc_lightColor",Er.FLOAT4,pd.LIGHTS_PER_PASS),new wa("cc_lightSizeRangeAngle",Er.FLOAT4,pd.LIGHTS_PER_PASS),new wa("cc_lightDir",Er.FLOAT4,pd.LIGHTS_PER_PASS)],1),kp.layouts[pd.NAME]=pd.LAYOUT,kp.bindings[pd.BINDING]=pd.DESCRIPTOR;var dd=function(){};dd.LIGHTS_PER_PASS=10;var md=function(){};md.SIZE=4*(md.COUNT=4+(md.JOINTS_TEXTURE_INFO_OFFSET=0)),md.NAME="CCSkinningTexture",md.BINDING=Hp.UBO_SKINNING_TEXTURE,md.DESCRIPTOR=new Qa(md.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX),md.LAYOUT=new Da(Wp.LOCAL,md.BINDING,md.NAME,[new wa("cc_jointTextureInfo",Er.FLOAT4,1)],1),kp.layouts[md.NAME]=md.LAYOUT,kp.bindings[md.BINDING]=md.DESCRIPTOR;var vd=function(){};vd.SIZE=4*(vd.COUNT=4+(vd.JOINTS_ANIM_INFO_OFFSET=0)),vd.NAME="CCSkinningAnimation",vd.BINDING=Hp.UBO_SKINNING_ANIMATION,vd.DESCRIPTOR=new Qa(vd.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX),vd.LAYOUT=new Da(Wp.LOCAL,vd.BINDING,vd.NAME,[new wa("cc_jointAnimInfo",Er.FLOAT4,1)],1),kp.layouts[vd.NAME]=vd.LAYOUT,kp.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd=function(){};gd.SIZE=4*(gd.COUNT=360+(gd.JOINTS_OFFSET=0)),gd.NAME="CCSkinning",gd.BINDING=Hp.UBO_SKINNING_TEXTURE,gd.DESCRIPTOR=new Qa(gd.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX),gd.LAYOUT=new Da(Wp.LOCAL,gd.BINDING,gd.NAME,[new wa("cc_joints",Er.FLOAT4,90)],1),kp.layouts[gd.NAME]=gd.LAYOUT,kp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=function(){};yd.MAX_MORPH_TARGET_COUNT=60,yd.OFFSET_OF_WEIGHTS=0,yd.OFFSET_OF_VERTICES_COUNT=4+(yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*yd.MAX_MORPH_TARGET_COUNT)),yd.COUNT_BASE_4_BYTES=4*Math.ceil(yd.MAX_MORPH_TARGET_COUNT/4)+4,yd.SIZE=4*yd.COUNT_BASE_4_BYTES,yd.NAME="CCMorph",yd.BINDING=Hp.UBO_MORPH,yd.DESCRIPTOR=new Qa(yd.BINDING,Jr.UNIFORM_BUFFER,1,Gr.VERTEX),yd.LAYOUT=new Da(Wp.LOCAL,yd.BINDING,yd.NAME,[new wa("cc_displacementWeights",Er.FLOAT4,yd.MAX_MORPH_TARGET_COUNT/4),new wa("cc_displacementTextureInfo",Er.FLOAT4,1)],1),kp.layouts[yd.NAME]=yd.LAYOUT,kp.bindings[yd.BINDING]=yd.DESCRIPTOR;var xd=function(){};xd.NAME="CCUILocal",xd.BINDING=Hp.UBO_UI_LOCAL,xd.DESCRIPTOR=new Qa(xd.BINDING,Jr.DYNAMIC_UNIFORM_BUFFER,1,Gr.VERTEX),xd.LAYOUT=new Da(Wp.LOCAL,xd.BINDING,xd.NAME,[new wa("cc_local_data",Er.FLOAT4,1)],1),kp.layouts[xd.NAME]=xd.LAYOUT,kp.bindings[xd.BINDING]=xd.DESCRIPTOR;var Sd=Hp.SAMPLER_JOINTS,Td=new Qa(Sd,Jr.SAMPLER_TEXTURE,1,Gr.VERTEX),Ed=new Oa(Wp.LOCAL,Sd,"cc_jointTexture",Er.SAMPLER2D,1);kp.layouts.cc_jointTexture=Ed,kp.bindings[Sd]=Td;var Ad=Hp.SAMPLER_MORPH_POSITION,Cd=new Qa(Ad,Jr.SAMPLER_TEXTURE,1,Gr.VERTEX),bd=new Oa(Wp.LOCAL,Ad,"cc_PositionDisplacements",Er.SAMPLER2D,1);kp.layouts.cc_PositionDisplacements=bd,kp.bindings[Ad]=Cd;var Pd=Hp.SAMPLER_MORPH_NORMAL,Rd=new Qa(Pd,Jr.SAMPLER_TEXTURE,1,Gr.VERTEX),Id=new Oa(Wp.LOCAL,Pd,"cc_NormalDisplacements",Er.SAMPLER2D,1);kp.layouts.cc_NormalDisplacements=Id,kp.bindings[Pd]=Rd;var wd=Hp.SAMPLER_MORPH_TANGENT,Dd=new Qa(wd,Jr.SAMPLER_TEXTURE,1,Gr.VERTEX),Od=new Oa(Wp.LOCAL,wd,"cc_TangentDisplacements",Er.SAMPLER2D,1);kp.layouts.cc_TangentDisplacements=Od,kp.bindings[wd]=Dd;var Md=Hp.SAMPLER_LIGHTMAP,Nd=new Qa(Md,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),Bd=new Oa(Wp.LOCAL,Md,"cc_lightingMap",Er.SAMPLER2D,1);kp.layouts.cc_lightingMap=Bd,kp.bindings[Md]=Nd;var Fd=Hp.SAMPLER_SPRITE,Ld=new Qa(Fd,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),zd=new Oa(Wp.LOCAL,Fd,"cc_spriteTexture",Er.SAMPLER2D,1);kp.layouts.cc_spriteTexture=zd,kp.bindings[Fd]=Ld;var Ud=Hp.SAMPLER_REFLECTION,Gd=new Qa(Ud,Jr.SAMPLER_TEXTURE,1,Gr.FRAGMENT),kd=new Oa(Wp.LOCAL,Ud,"cc_reflectionTexture",Er.SAMPLER2D,1);kp.layouts.cc_reflectionTexture=kd,kp.bindings[Ud]=Gd;var Hd=Hp.STORAGE_REFLECTION,Vd=new Qa(Hd,Jr.STORAGE_IMAGE,1,Gr.COMPUTE),jd=new Ba(Wp.LOCAL,Hd,"cc_reflectionStorage",Er.IMAGE2D,1);kp.layouts.cc_reflectionStorage=jd,kp.bindings[Hd]=Vd;var Wd,qd,Xd,Yd,Kd,Qd=Mp.makeMaskExclude([Mp.BitMask.UI_2D,Mp.BitMask.GIZMOS,Mp.BitMask.EDITOR,Mp.BitMask.SCENE_GIZMO,Mp.BitMask.PROFILER]),Zd=Mp.makeMaskExclude([Mp.BitMask.UI_2D,Mp.BitMask.PROFILER]),Jd=Mp.Enum.ALL;function $d(e){return e.hasFeature(xr.COLOR_FLOAT)&&e.hasFeature(xr.TEXTURE_FLOAT)&&!(e.gfxAPI===gr.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Fp,PIPELINE_FLOW_FORWARD:Lp,PIPELINE_FLOW_SHADOW:zp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Np},get RenderPriority(){return Bp},globalDescriptorSetLayout:Gp,localDescriptorSetLayout:kp,get PipelineGlobalBindings(){return Up},get ModelLocalBindings(){return Hp},get SetIndex(){return Wp},bindingMappingInfo:Yp,UBOGlobal:Kp,UBOCamera:Qp,UBOShadow:Zp,UNIFORM_SHADOWMAP_BINDING:Jp,UNIFORM_ENVIRONMENT_BINDING:td,UNIFORM_DIFFUSEMAP_BINDING:rd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:sd,UBOLocal:ud,UBOWorldBound:hd,INST_MAT_WORLD:_d,UBOLocalBatched:fd,UBOForwardLight:pd,UBODeferredLight:dd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:md,UBOSkinningAnimation:vd,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:gd,UBOMorph:yd,UBOUILocal:xd,UNIFORM_JOINT_TEXTURE_BINDING:Sd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Ad,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Pd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:wd,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Md,UNIFORM_SPRITE_TEXTURE_BINDING:Fd,UNIFORM_REFLECTION_TEXTURE_BINDING:Ud,UNIFORM_REFLECTION_STORAGE_BINDING:Hd,CAMERA_DEFAULT_MASK:Qd,CAMERA_EDITOR_MASK:Zd,MODEL_ALWAYS_MASK:Jd,supportsHalfFloatTexture:function(e){return e.hasFeature(xr.COLOR_HALF_FLOAT)&&e.hasFeature(xr.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===gr.WEBGL)},supportsFloatTexture:$d})),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Wd||(Wd={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(qd||(qd={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Xd||(Xd={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Yd||(Yd={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Kd||(Kd={}));var em,tm,nm,im,rm,am,om,sm=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],cm=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],lm=[100,200,400,800],um=new di,hm=new di,_m=new wi,fm=na.STENCIL<<1,pm=[],dm=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Wd.VERTICAL,this._fov=Zn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new ga(.2,.2,.2,1),this._viewport=new Vi(0,0,1,1),this._orientedViewport=new Vi(0,0,1,1),this._curTransform=yr.IDENTITY,this._isProjDirty=!0,this._matView=new wi,this._matProj=new wi,this._matProjInv=new wi,this._matViewProj=new wi,this._matViewProjInv=new wi,this._frustum=new Wc,this._forward=new di,this._position=new di,this._priority=0,this._aperture=Xd.F16_0,this._apertureValue=void 0,this._shutter=Kd.D125,this._shutterValue=0,this._iso=Yd.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=na.NONE,this._clearDepth=1,this._visibility=Qd,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=sm[this._aperture],this._shutterValue=cm[this._shutter],this._isoValue=lm[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!pm.length){var t=e.capabilities.clipSpaceSignY;pm[yr.IDENTITY]=new wi(1,0,0,0,0,t),pm[yr.ROTATE_90]=new wi(0,1,0,0,-t,0),pm[yr.ROTATE_180]=new wi(-1,0,0,0,0,-t),pm[yr.ROTATE_270]=new wi(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||yr.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=na.NONE,this.clearDepth=1,this.visibility=Qd,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(wi.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||yr.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var a=this._device.capabilities.clipSpaceSignY;if(this._proj===qd.PERSPECTIVE)wi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Wd.VERTICAL,this._device.capabilities.clipSpaceMinZ,a,r);else{var o=this._orthoHeight*this._aspect,s=this._orthoHeight;wi.ortho(this._matProj,-o,o,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,a,r)}wi.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(wi.multiply(this._matViewProj,this._matProj,this._matView),wi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,a=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,o=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(o&&o.surfaceTransform||yr.IDENTITY){case yr.ROTATE_90:this._viewport.x=1-a-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case yr.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-a-r,this._viewport.width=i,this._viewport.height=r;break;case yr.ROTATE_270:this._viewport.x=a,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case yr.IDENTITY:this._viewport.x=n,this._viewport.y=a,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=a,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||i.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||yr.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,a=this._orientedViewport.x*i,o=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===qd.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Ii[this._curTransform];di.set(um,(t-a)/s*2-1,(n-o)/c*2-1,l?1:-1);var _=um.x,f=um.y;return um.x=_*h[0]+f*h[2]*u,um.y=_*h[1]+f*h[3]*u,di.transformMat4(l?um:e.o,um,this._matViewProjInv),l?(this._node.getWorldPosition(hm),ur.fromPoints(e,hm,um)):di.transformQuat(e.d,di.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,a=this._orientedViewport.y*i,o=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Ii[this._curTransform];if(this._proj===qd.PERSPECTIVE){di.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,di.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(um),di.lerp(e,um,e,Qn(this._nearClip/this._farClip,1,t.z))}else{di.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,di.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Ii[this._curTransform];di.transformMat4(e,t,this._matViewProj);var r=e.x,a=e.y;e.x=r*i[0]+a*i[2]*n,e.y=r*i[1]+a*i[3]*n;var o=this.width,s=this.height,c=this._orientedViewport.x*o,l=this._orientedViewport.y*s,u=this._orientedViewport.width*o,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){wi.multiply(e,this._matViewProj,t),wi.multiply(e,pm[this._curTransform],e);var r=n/2,a=i/2;return wi.identity(_m),wi.transform(_m,_m,di.set(um,r,a,0)),wi.scale(_m,_m,di.set(um,r,a,1)),wi.multiply(e,_m,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},B(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){A(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=sm[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=cm[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=lm[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),mm=1024;function vm(e){return!!(i.sys.hasFeature(i.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}!function(e){e[e.RGB565=Sr.R5G6B5]="RGB565",e[e.RGB5A1=Sr.RGB5A1]="RGB5A1",e[e.RGBA4444=Sr.RGBA4]="RGBA4444",e[e.RGB888=Sr.RGB8]="RGB888",e[e.RGB32F=Sr.RGB32F]="RGB32F",e[e.RGBA8888=Sr.RGBA8]="RGBA8888",e[e.RGBA32F=Sr.RGBA32F]="RGBA32F",e[e.A8=Sr.A8]="A8",e[e.I8=Sr.L8]="I8",e[e.AI8=Sr.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Sr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Sr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=mm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Sr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Sr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=mm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Sr.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=mm++]="RGBA_ETC1",e[e.RGB_ETC2=Sr.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Sr.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Sr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Sr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Sr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Sr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Sr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Sr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Sr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Sr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Sr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Sr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Sr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Sr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Sr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Sr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(em||(em={})),function(e){e[e.REPEAT=Nr.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Nr.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Nr.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Nr.BORDER]="CLAMP_TO_BORDER"}(tm||(tm={})),function(e){e[e.NONE=Mr.NONE]="NONE",e[e.LINEAR=Mr.LINEAR]="LINEAR",e[e.NEAREST=Mr.POINT]="NEAREST"}(nm||(nm={}));var gm,ym,xm,Sm,Tm,Em,Am,Cm,bm,Pm,Rm,Im,wm=e("ImageAsset",nl("cc.ImageAsset")((om=am=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=em.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}L(t,e);var n=t.prototype;return n.reset=function(e){vm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):vm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var r,a=i.director.root?i.director.root.device:null,o=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=i.macro.SUPPORT_TEXTURE_FORMATS,h=W(o);!(r=h()).done;){var _=r.value.split("@"),f=parseInt(_[0],void 0),p=t.extnames[f]||_[0],d=u.indexOf(p);if(-1!==d&&d<s){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||a&&a.hasFeature(xr.FORMAT_ASTC)))continue;if(!(".pvr"!==p||a&&a.hasFeature(xr.FORMAT_PVRTC)))continue;if(!(m!==em.RGB_ETC1&&m!==em.RGBA_ETC1||a&&a.hasFeature(xr.FORMAT_ETC1)))continue;if(!(m!==em.RGB_ETC2&&m!==em.RGBA_ETC2||a&&a.hasFeature(xr.FORMAT_ETC2)))continue;if(".webp"===p&&!i.sys.hasFeature(i.sys.Feature.WEBP))continue;s=d,l=p,c=m}}l?(this._setRawAsset(l),this._format=c):A(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),a=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,a,a),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},B(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||vm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||vm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=em.RGB_ETC1&&this._format<=em.RGBA_ASTC_12x12||this._format>=em.RGB_A_PVRTC_2BPPV1&&this._format<=em.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Du),am.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],am._sharedPlaceHolderCanvas=null,X((rm=om).prototype,"_nativeAsset",[Wl],Object.getOwnPropertyDescriptor(rm.prototype,"_nativeAsset"),rm.prototype),im=rm))||im);i.ImageAsset=wm,Ze(Sr);var Dm=new ee("Tex"),Om=nl("cc.TextureBase")((Im=Rm=function(e){function t(){var t;return q(t=e.call(this)||this,"_format",xm,V(t)),q(t,"_minFilter",Sm,V(t)),q(t,"_magFilter",Tm,V(t)),q(t,"_mipFilter",Em,V(t)),q(t,"_wrapS",Am,V(t)),q(t,"_wrapT",Cm,V(t)),q(t,"_wrapR",bm,V(t)),q(t,"_anisotropy",Pm,V(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new Ia,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Dm.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=Ro(t._id,666),t}L(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=i.director.root)||void 0===t?void 0:t.batcher2D)&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):b(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return i.director.root?i.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?em.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===em.RGBA_ETC1?e=em.RGB_ETC1:e===em.RGB_A_PVRTC_4BPPV1?e=em.RGB_PVRTC_4BPPV1:e===em.RGB_A_PVRTC_2BPPV1&&(e=em.RGB_PVRTC_2BPPV1),e},B(t,[{key:"isCompressed",get:function(){return this._format>=em.RGB_ETC1&&this._format<=em.RGBA_ASTC_12x12||this._format>=em.RGB_A_PVRTC_2BPPV1&&this._format<=em.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Du),Rm.PixelFormat=em,Rm.WrapMode=tm,Rm.Filter=nm,xm=X((ym=Im).prototype,"_format",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return em.RGBA8888}}),Sm=X(ym.prototype,"_minFilter",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.LINEAR}}),Tm=X(ym.prototype,"_magFilter",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.LINEAR}}),Em=X(ym.prototype,"_mipFilter",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.NONE}}),Am=X(ym.prototype,"_wrapS",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tm.REPEAT}}),Cm=X(ym.prototype,"_wrapT",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tm.REPEAT}}),bm=X(ym.prototype,"_wrapR",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tm.REPEAT}}),Pm=X(ym.prototype,"_anisotropy",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gm=ym))||gm;i.TextureBase=Om;var Mm=new WeakMap,Nm=new WeakSet,Bm=new WeakSet;function Fm(e,t){var n;n=th.safeFindClass;var i,r=Eh.pool.get();try{i=Bh(e,r,{classFinder:n,customEnv:t})}catch(e){throw d(e),Eh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var a=r.uuidList,o=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<a.length;u++){var h=a[u];l[u]={uuid:fu(h),owner:o[u],prop:s[u],type:ke._getClassById(c[u])}}return Mm.set(i,l),i._native&&Nm.add(i),Eh.pool.put(r),i}var Lm,zm=new(function(){function e(){this._depends=new Ql}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?F({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof hh){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var a=Fm(t,{__uuid__:e});(r=this._parseDepsFromAsset(a)).nativeDep&&(r.nativeDep.uuid=e),tu.add(e+"@import",a)}catch(t){eu.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Mm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Nm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=fu(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var a=i[r];t[a]||(t[a]=!0,n.push(a),this._descend(a,t,n))}},e}()),Um=[new ma];function Gm(e){return e&&0==(e&e-1)}var km,Hm,Vm,jm,Wm,qm,Xm=nl("cc.SimpleTexture")(Lm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}L(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Um[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Um):i.copyTexImagesToTexture([e],this._gfxTexture,Um)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),$e.CLEANUP_IMAGE_CACHE)){var r=zm.getDeps(this._uuid),a=r.indexOf(e._uuid);-1!==a&&(Q(r,a),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=wr.NONE;this._mipFilter!==nm.NONE&&function(e,t,n){return!(e.gfxAPI===gr.WEBGL)||Gm(t)&&Gm(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=wr.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Ir.SAMPLED|Ir.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},B(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Om))||Lm;i.SimpleTexture=Xm;var Ym,Km,Qm,Zm,Jm,$m,ev,tv=e("Texture2D",(km=nl("cc.Texture2D"),Hm=Bl([wm]),km((qm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",Wm,V(t)),t}L(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=em.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new wm,i.mipmaps[r]){var a=i.mipmaps[r];n.result.push(this._mipmaps,""+r,a,ke._getClassId(wm))}},n._getGfxTextureCreateInfo=function(e){var t=new Pa(Rr.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new wm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},B(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Xm),Wm=X((jm=qm).prototype,"_mipmaps",[Hm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vm=jm))||Vm));i.Texture2D=tv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(ev||(ev={}));var nv=e("TextureCube",nl("cc.TextureCube")(($m=Jm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",Qm,V(t)),q(t,"_mipmaps",Zm,V(t)),t}L(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,a=0;a<r;a++){var o=6*a;i.push({front:e[o+ev.front].image,back:e[o+ev.back].image,left:e[o+ev.left].image,right:e[o+ev.right].image,top:e[o+ev.top].image,bottom:e[o+ev.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;iv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},a=0;a<i;++a)r(a)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new wm,back:new wm,left:new wm,right:new wm,top:new wm,bottom:new wm};var a=i.mipmaps[r],o=ke._getClassId(wm);n.result.push(this._mipmaps[r],"front",a.front,o),n.result.push(this._mipmaps[r],"back",a.back,o),n.result.push(this._mipmaps[r],"left",a.left,o),n.result.push(this._mipmaps[r],"right",a.right,o),n.result.push(this._mipmaps[r],"top",a.top,o),n.result.push(this._mipmaps[r],"bottom",a.bottom,o)}},n._getGfxTextureCreateInfo=function(e){var t=new Pa(Rr.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new wm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},B(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){iv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Xm),Jm.FaceIndex=ev,Qm=X((Km=$m).prototype,"isRGBE",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zm=X(Km.prototype,"_mipmaps",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ym=Km))||Ym);function iv(e,t){t(e.front,ev.front),t(e.back,ev.back),t(e.left,ev.left),t(e.right,ev.right),t(e.top,ev.top),t(e.bottom,ev.bottom)}i.TextureCube=nv;var rv,av,ov=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),sv=4227858432,cv=66060288,lv=1044480,uv=function(e,t,n,i){return void 0===i&&(i=0),t<<26&sv|e<<20&cv|n<<12&lv|4095&i},hv=function(e){return(e&sv)>>>26},_v=function(e){return(e&cv)>>>20},fv=function(e){return(e&lv)>>>12},pv=function(e){return 4095&e},dv=function(e,t){return 67108863&e|t<<26&sv},mv=((rv={})[Er.UNKNOWN]=function(){return console.warn("illegal uniform handle")},rv[Er.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},rv[Er.INT2]=function(e,t,n){return void 0===n&&(n=0),Ni.fromArray(t,e,n)},rv[Er.INT3]=function(e,t,n){return void 0===n&&(n=0),di.fromArray(t,e,n)},rv[Er.INT4]=function(e,t,n){return void 0===n&&(n=0),zi.fromArray(t,e,n)},rv[Er.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},rv[Er.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Ni.fromArray(t,e,n)},rv[Er.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),di.fromArray(t,e,n)},rv[Er.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),zi.fromArray(t,e,n)},rv[Er.MAT3]=function(e,t,n){return void 0===n&&(n=0),yi.fromArray(t,e,n)},rv[Er.MAT4]=function(e,t,n){return void 0===n&&(n=0),wi.fromArray(t,e,n)},rv),vv=((av={})[Er.UNKNOWN]=function(){return console.warn("illegal uniform handle")},av[Er.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},av[Er.INT2]=function(e,t,n){return void 0===n&&(n=0),Ni.toArray(e,t,n)},av[Er.INT3]=function(e,t,n){return void 0===n&&(n=0),di.toArray(e,t,n)},av[Er.INT4]=function(e,t,n){return void 0===n&&(n=0),zi.toArray(e,t,n)},av[Er.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},av[Er.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Ni.toArray(e,t,n)},av[Er.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),di.toArray(e,t,n)},av[Er.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),zi.toArray(e,t,n)},av[Er.MAT3]=function(e,t,n){return void 0===n&&(n=0),yi.toArray(e,t,n)},av[Er.MAT4]=function(e,t,n){return void 0===n&&(n=0),wi.toArray(e,t,n)},av),gv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function yv(e){switch(e){case Er.BOOL:case Er.INT:case Er.UINT:case Er.FLOAT:return gv[0];case Er.BOOL2:case Er.INT2:case Er.UINT2:case Er.FLOAT2:return gv[1];case Er.BOOL4:case Er.INT4:case Er.UINT4:case Er.FLOAT4:return gv[2];case Er.MAT4:return gv[3];case Er.SAMPLER2D:return"default-texture";case Er.SAMPLER_CUBE:return"default-cube-texture"}return gv[0]}function xv(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Sv=new Za;function Tv(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Ev(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Av(e,t,n,i,r){for(var a=e.builtins[i],o=[],s=function(e){var t=a.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&uo))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";o.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<a.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,o);for(var l=[],u=function(e){var t=a.samplerTextures[e],i=n.layouts[t.name],o=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&o&&o.descriptorType&ho))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(o)&&r.push(o)},h=0;h<a.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function Cv(e){return e.members.reduce((function(e,t){return e+go(t.type)*t.count}),0)}function bv(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Pv(e){switch(e.gfxAPI){case gr.GLES2:case gr.WEBGL:return"glsl1";case gr.GLES3:case gr.WEBGL2:return"glsl3";default:return"glsl4"}}var Rv=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var a=i.passes[r];void 0!==a.propertyIndex&&void 0===a.properties&&(a.properties=i.passes[a.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=F({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var a=t.range;r=Tv(a[1]-a[0]+1),t._map=function(e){return e-a[0]}}else"string"===t.type?(r=Tv(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},a=0;a<n.defines.length;a++)r(a);for(var o in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+o+" "+n.builtins.statistics[o]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Ga,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Cv(l)),s.bindings.push(new Qa(l.binding,Jr.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Da(Wp.MATERIAL,l.binding,l.name,l.members.map((function(e){return new wa(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Qa(h.binding,Jr.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Oa(Wp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Qa(f.binding,Jr.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Ma(Wp.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new Qa(d.binding,Jr.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Na(Wp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Qa(v.binding,Jr.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Fa(Wp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Qa(y.binding,Jr.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Ba(Wp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Qa(S.binding,Jr.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new La(Wp.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var E=n.attributes[T];s.gfxAttributes.push(new Ua(E.name,E.format,E.isNormalized,0,E.isInstanced,E.location))}Av(n,s,kp,"locals"),s.shaderInfo.stages.push(new za(Gr.VERTEX,"")),s.shaderInfo.stages.push(new za(Gr.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,a=0,o=0;o<r.length;o++){var s=r[o];t[s.name]=uv(i.binding,s.type,s.count,a),a+=(go(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=uv(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(Sv.bindings=r.bindings,r.setLayouts[Wp.MATERIAL]=e.createDescriptorSetLayout(Sv),Sv.bindings=kp.bindings,r.setLayouts[Wp.LOCAL]=e.createDescriptorSetLayout(Sv)),r.setLayouts[n?Wp.LOCAL:Wp.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",a=0;a<i.length;a++){var o=i[a],s=t[o.name];if(s&&o._map){var c=o._map(s);r+=""+o._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),a=0;a<r.length;a++){var o=r[a],s=this._cache[o];v("destroyed shader "+s.name),s.destroy(),delete this._cache[o]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var a=this._cache[r];if(a)return a;var o=this._templates[t],s=this._templateInfos[o.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Av(o,s,Gp,"globals"),s.setLayouts[Wp.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new $a(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],a=r.name,o=e[a],s=Ev(r,o),c=!o||"0"===o;n.push({name:a,value:s,isDefault:c})}return n}(n,o.defines),l=i.constantMacros+o.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=o.glsl3,h=Pv(e);return h?u=o[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,a=t.gfxAttributes,o=0;o<r.length;o++)bv(r[o].defines,n)&&i.push(a[o]);return i}(o,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());i.programLib=Rv;var Iv,wv,Dv,Ov={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Mv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,r=new Uint8Array(16),a=new Uint8Array(16),o=new Uint8Array(16),s=new Uint8Array(16),c=new Uint8Array(16),l=0,u=0;u<4;u++)r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=255,a[l]=0,a[l+1]=0,a[l+2]=0,a[l+3]=0,o[l]=119,o[l+1]=119,o[l+2]=119,o[l+3]=255,s[l]=255,s[l+1]=255,s[l+2]=255,s[l+3]=255,c[l]=127,c[l+1]=127,c[l+2]=255,c[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var _=0;_<256;_++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var f=0;f<8;f++){for(var p=0;p<8;p++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:r,_compressed:!1,format:tv.PixelFormat.RGBA8888},g={width:2,height:2,_data:a,_compressed:!1,format:tv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:tv.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:tv.PixelFormat.RGBA8888},S={width:2,height:2,_data:c,_compressed:!1,format:tv.PixelFormat.RGBA8888},T={width:16,height:16,_data:h,_compressed:!1,format:tv.PixelFormat.RGBA8888},E=new wm(v),A=new tv;A._uuid="black-texture",A.image=E,n[A._uuid]=A;var C=new wm(g),b=new tv;b._uuid="empty-texture",b.image=C,n[b._uuid]=b;var P=new nv;P._uuid="black-cube-texture",P.setMipFilter(nv.Filter.NEAREST),P.image={front:new wm(v),back:new wm(v),left:new wm(v),right:new wm(v),top:new wm(v),bottom:new wm(v)},n[P._uuid]=P;var R=new wm(y),I=new tv;I._uuid="grey-texture",I.image=R,n[I._uuid]=I;var w=new wm(x),D=new tv;D._uuid="white-texture",D.image=w,n[D._uuid]=D;var O=new nv;O._uuid="white-cube-texture",O.setMipFilter(nv.Filter.NEAREST),O.image={front:new wm(x),back:new wm(x),left:new wm(x),right:new wm(x),top:new wm(x),bottom:new wm(x)},n[O._uuid]=O;var M=new wm(S),N=new tv;N._uuid="normal-texture",N.image=M,n[N._uuid]=N;var B=new wm(T),F=new tv;F._uuid="default-texture",F.image=B,n[F._uuid]=F;var L=new nv;if(L.setMipFilter(nv.Filter.NEAREST),L._uuid="default-cube-texture",L.image={front:new wm(T),back:new wm(T),left:new wm(T),right:new wm(T),top:new wm(T),bottom:new wm(T)},n[L._uuid]=L,i.SpriteFrame){var z=new i.SpriteFrame,U=E,G=new tv;G.image=U,z.texture=G,z._uuid="default-spriteframe",n[z._uuid]=z}var k=Pv(e);if(!k)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=Ov[k];return H?Promise.resolve().then((function(){ov.forEach((function(e,t){var n=Object.assign(new i.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[k]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+k+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var r=new i.Material;r._uuid="missing-effect-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ffff00")),e[r._uuid]=r,t.push(r);var a=new i.Material;a._uuid="missing-material",a.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),a.setProperty("mainColor",i.color("#ff00ff")),e[a._uuid]=a,t.push(a);var o=new i.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var s=new i.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new i.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new i.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new i.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new i.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),e[p._uuid]=p,t.push(p);var d=new i.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new i.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new i.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),i.game.on(i.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Nv=e("builtinResMgr",i.builtinResMgr=new Mv),Bv=e("getPhaseID",(Iv=new Map,wv=0,function(e){return"number"==typeof e?e:(Iv.has(e)||(Iv.set(e,1<<wv),wv++),Iv.get(e))})),Fv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var a=e.inputAssembler,o=e.descriptorSet.getTexture(Md),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==a.indexBuffer||u.count>=1024)&&u.lightingMap===o&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=a.vertexBuffers.slice(),m=a.attributes.slice(),v=a.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new Ua(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}p.set(t.buffer),d.push(f);var S=new ka(m,d,v),T=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Lv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,a=0,o=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<fd.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=i[p],m=_.vbs[p],v=_.vbDatas[p];(r=(o+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(a=4*(o+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(a),_.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+o,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return wi.toArray(_.uboData,n.transform.worldMatrix,fd.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(fd.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=o,void(_.ia.vertexCount+=o)}}}for(var E=[],A=[],C=[],b=0;b<i.length;++b){var P=i[b],R=this._device.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,P.count*P.stride,P.stride));R.update(P.buffer.buffer),E.push(R),A.push(new Uint8Array(R.size)),C.push(R)}var I=this._device.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,4*o,4)),w=new Float32Array(o);w.fill(0),I.update(w),C.push(I);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),M=0;M<D.length;++M)O[M]=D[M];O[D.length]=new Ua("a_dyn_batch_id",Sr.R32F,!1,i.length);var N=new ka(O,C),B=this._device.createInputAssembler(N),F=this._device.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,fd.SIZE,fd.SIZE));l.bindBuffer(fd.BINDING,F),l.update();var L=new Float32Array(fd.COUNT);wi.toArray(L,n.transform.worldMatrix,fd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:A,vbIdx:I,vbIdxData:w,vbCount:o,ia:B,ubo:F,uboData:L,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),zv=new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.DEVICE),Uv=new Ea(null),Gv=new Ja(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Dv||(Dv={}));var kv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Fo,this._dss=new No,this._rs=new Mo,this._priority=Bp.DEFAULT,this._stage=Np.DEFAULT,this._phase=Bv("default"),this._primitive=qr.TRIANGLE_LIST,this._batchingScheme=Dv.NONE,this._dynamicStates=Qr.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Bv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Rv.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=W(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),Ro(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=Er.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=dv(i,n):t&&(i=dv(i,hv(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);vv[r](o,n,a),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);return mv[r](o,n,a)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=go(r)>>2,o=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=a)null!==n[c]&&vv[r](o,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):b(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Fv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Lv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),a=e.getOffsetFromHandle(n),o=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||yv(i),u=(go(i)>>2)*o,h=0;h+l.length<=u;h+=l.length)s.set(l,a+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),a=e.getBindingFromHandle(i),o=this._properties[t],s=o&&o.value,c=s?s+"-texture":yv(r),l=Nv.get(c),u=l&&l.getGFXTexture(),h=o&&void 0!==o.samplerHash?ko.unpackFromHash(o.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(a,_,n),this._descriptorSet.bindTexture(a,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],a=this._getBlockView(r.type,t.binding),o=this._properties[r.name],s=o&&o.value||yv(r.type),c=(go(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)a.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Rv.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Rv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Rv.getGFXShader(this._device,this._programName,this._defines,t),a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Bp.DEFAULT),this._setStage(Np.DEFAULT),this._setPhase(Bv("default")),this._setPrimitive(qr.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?F({},t.defines):t.defines,this._shaderInfo=Rv.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Gv.layout=Rv.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Gv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,a=Rv.getTemplateInfo(t.program),o=a.blockSizes,s=a.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=o[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(zv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(zv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=o[d];Uv.buffer=this._rootBuffer,Uv.offset=l[m++],Uv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Uv);this._blocks[v]=new Float32Array(this._rootBlock,Uv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var T in this._properties){var E=this._properties[T];E.handleInfo&&(S[T]=this.getHandle.apply(this,E.handleInfo))}Object.assign(x,S)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(xr.INSTANCED_ARRAYS)?this._setBatchingScheme(Dv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Dv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Dv.VB_MERGING):this._setBatchingScheme(Dv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<Er.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Rv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},B(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Rv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();kv.getTypeFromHandle=hv,kv.getBindingFromHandle=_v,kv.getCountFromHandle=fv,kv.getOffsetFromHandle=pv;var Hv,Vv=new Ja(null),jv=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Bp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var r=i.director.root;this._device=r.device,Vv.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Vv);var a=i.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Ja(null);if(o.layout=a.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Dv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Bp.DEFAULT,t[0].phase===Bv("reflection")){var s=r.mainWindow.width,c=r.mainWindow.height,l=512;c<s?(s=l*s/c,c=l):c=l*c/(s=l),this._reflectionTex=this._device.createTexture(new Pa(Rr.TEX2D,Ir.STORAGE|Ir.TRANSFER_SRC|Ir.SAMPLED,Sr.RGBA8,s,c)),this.descriptorSet.bindTexture(Ud,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Ia(Mr.LINEAR,Mr.LINEAR,Mr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP)),this.descriptorSet.bindSampler(Ud,this._reflectionSampler),this.descriptorSet.bindTexture(Hd,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Bp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},B(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?b(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Dv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Vv.layout=e[0].localSetLayout,this._createDescriptorSet(Vv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Dv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Wv=new wi,qv=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Hv||(Hv={}));var Xv,Yv,Kv=new Ia(Mr.LINEAR,Mr.LINEAR,Mr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP),Qv=new Ia(Mr.LINEAR,Mr.LINEAR,Mr.LINEAR,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP),Zv=function(){function e(){this.type=Hv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(ud.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new zi,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Mp.Enum.NONE,this._device=i.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Mp.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var a=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,a[r],a[r+1],a[r+2])}else if(this._localBuffer){wi.toArray(this._localData,i,ud.MAT_WORLD_OFFSET),wi.inverseTranspose(Wv,i);var o=Math.abs(wi.determinant(Wv)),s=1/Math.sqrt(o);wi.multiplyScalar(Wv,Wv,s),wi.toArray(this._localData,Wv,ud.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Mc.fromPoints(Mc.create(),e,t),this._worldBounds=Mc.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new jv},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){zi.toArray(this._localData,t,ud.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Nv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?Qv:Kv),r=this._subModels,a=0;a<r.length;a++){var o=r[a].descriptorSet;o.bindTexture(Md,n),o.bindSampler(Md,i),o.update()}},t.getMacroPatches=function(){return this.receiveShadow?qv:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(xr.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=lo[r.format].size)}var a=this.instancedAttributes;a.buffer=new Uint8Array(n),a.views.length=a.attributes.length=0;for(var o=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Ua;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,a.attributes.push(l);var u=lo[c.format],h=new(yo(u))(a.buffer.buffer,o,u.count);a.views.push(h),o+=u.size}}t.batchingScheme===Dv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(_d)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.DEVICE,ud.SIZE,ud.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.DEVICE,hd.SIZE,hd.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(ud.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(hd.BINDING,this._worldBoundBuffer)},B(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Xv||(Xv={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Yv||(Yv={})),i.internal.TransformBit=Yv;var Jv,$v,eg,tg,ng,ig,rg,ag,og=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,a=0;a<r.length;a++)r[a].update();for(var o=this._models,s=0;s<o.length;s++){var c=o[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=W(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Yv.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=W(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=W(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},B(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}(),sg=e("EffectAsset",nl("cc.EffectAsset")((ag=rg=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"techniques",eg,V(t)),q(t,"shaders",tg,V(t)),q(t,"combinations",ng,V(t)),q(t,"hideInEditor",ig,V(t)),t}L(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Rv.register(this),t.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=i.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],a=0;a<i.length;++a){var o=F({},n);o[t]=i[a],e.push(o)}return e}),[])}),[{}]).forEach((function(e){return Rv.getGFXShader(t.device,i.name,e,t.pipeline)}))},r=0;r<this.shaders.length;r++)n(r)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Du),rg._effects={},eg=X(($v=ag).prototype,"techniques",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tg=X($v.prototype,"shaders",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ng=X($v.prototype,"combinations",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ig=X($v.prototype,"hideInEditor",[cl,ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jv=$v))||Jv);i.EffectAsset=sg;var cg=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var a=t.hash^i.hash^r.attributesHash^n.typedID,o=this._PSOHashMap.get(a);if(!o){var s=t.pipelineLayout,c=new eo(r.attributes),l=new Lo(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);o=e.createPipelineState(l),this._PSOHashMap.set(a,o)}return o},e}());cg._PSOHashMap=new Map;var lg=new va,ug=new ua;function hg(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var _g,fg,pg,dg,mg,vg,gg,yg,xg,Sg,Tg=null;function Eg(e,t,n,i,r){if(i&&i.enabled&&r===Tg){var a=i.subModels[0],o=a.inputAssembler,s=a.passes,c=a.shaders,l=a.descriptorSet;lg.width=ug.width=r.window.width,lg.height=ug.height=r.window.height;var u=cg.getOrCreatePipelineState(e,s[0],c[0],t,o);n.setViewport(lg),n.setScissor(ug),n.bindPipelineState(u),n.bindDescriptorSet(Wp.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Wp.LOCAL,l),n.bindInputAssembler(o),n.draw(o)}}var Ag=new zi,Cg=e("Material",(_g=nl("cc.Material"),fg=Bl(sg),_g((Sg=function(e){function t(){var t;return q(t=e.call(this)||this,"_effectAsset",mg,V(t)),q(t,"_techIdx",vg,V(t)),q(t,"_defines",gg,V(t)),q(t,"_states",yg,V(t)),q(t,"_props",xg,V(t)),t._passes=[],t._hash=0,t}L(t,e),t.getHash=function(e){for(var t,n=0,i=W(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?A(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=W(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,a=r.length,o=0;o<a;o++){var s=r[o];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var a=n[r];if(e in a)return a[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var o=this._props[this._passes[t].propertyIndex];if(e in o)return o[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=F({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=F({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=F({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=sg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],r=0;r<t;++r){var a=e.passes[r],o=a.passIndex=r,s=a.defines=this._defines[o]||(this._defines[o]={});if(a.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==a.propertyIndex&&Object.assign(s,this._defines[a.propertyIndex]),void 0!==a.embeddedMacros&&Object.assign(s,a.embeddedMacros),!a.switch||s[a.switch]){var c=new kv(i.director.root);c.initialize(a),n.push(c)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(kv.getTypeFromHandle(i)<Er.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var a=n;hg(Ag,a),Ag.w=a.w,n=Ag}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=kv.getBindingFromHandle(t);if(n instanceof Vo)e.bindTexture(r,n,i);else if(n instanceof Om){var a=n.getGFXTexture();if(!a||!a.width||!a.height)return;e.bindTexture(r,a,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=W(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new fi("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},B(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Du),mg=X((dg=Sg).prototype,"_effectAsset",[fg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vg=X(dg.prototype,"_techIdx",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gg=X(dg.prototype,"_defines",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yg=X(dg.prototype,"_states",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xg=X(dg.prototype,"_props",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pg=dg))||pg));i.Material=Cg;var bg=Ye({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Pg=Ye({Planar:0,ShadowMap:1}),Rg=Ye({HARD:0,SOFT:1,SOFT_2X:2}),Ig=Pg.ShadowMap+1,wg=function(){function e(){this.fixedSphere=new ia(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new wi,this.matShadowProj=new wi,this.matShadowViewProj=new wi,this._normal=new di(0,1,0),this._shadowColor=new fi(0,0,0,76),this._matLight=new wi,this._material=null,this._instancingMaterial=null,this._size=new Ni(512,512),this._enabled=!1,this._distance=0,this._type=Ig,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Cg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:Ig},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){this.enabled&&this.type===Pg.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new Cg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){di.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();wg.MAX_FAR=2e3,wg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=wg,Bn(og.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Bn(og.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Dg={};Bn(Dg,"CameraVisFlags",[{name:"GENERAL"}]),Nn(Dg,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Mp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Mp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Mp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Mp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Mp.BitMask,targetName:"UI_2D"}]),i.CameraVisFlags=Dg;var Og,Mg={};function Ng(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),a=2*i-8*r+4,o=3*i/a,s=2*r/a,c=1/s*o,l=1/s*(1-o-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}Bn(Mg,"VisibilityFlags",[{name:"GENERAL"}]),Nn(Mg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Mp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Mp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Mp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Mp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Mp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Mp.Enum,targetName:"UI_2D"}]),i.VisibilityFlags=Mg,Nn(kv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Bn(dm.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),Bn(wg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Og||(Og={}));var Bg=function(e){return 4*Math.PI*Math.PI*e*e},Fg=function(){function e(){this._baked=!1,this._color=new di(1,1,1),this._colorTemp=6550,this._colorTempRGB=new di(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Og.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new di(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},B(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Ng(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Yv.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Lg=new di(0,0,-1),zg=new di,Ug=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new di(1,-1,-1),t._illuminanceHDR=Yi.SUN_ILLUM,t._illuminanceLDR=1,t._type=Og.DIRECTIONAL,t}L(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Yi.SUN_ILLUM,this.direction=new di(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=di.transformQuat(zg,Lg,this._node.worldRotation))},B(t,[{key:"direction",get:function(){return this._dir},set:function(e){di.normalize(this._dir,e)}},{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(Fg),Gg=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var a=i._shaderInfo.blocks[r],o=i._blocks[a.binding],s=i._parent.blocks[a.binding];o.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(V(i)),i}L(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),kv.fillPipelineInfo(this,e),kv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!xv(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Dv.NONE)},n._onStateChange=function(){this._setHash(kv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},B(t,[{key:"parent",get:function(){return this._parent}}]),t}(kv),kg=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}L(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=W(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],a=this._states[i]||(this._states[i]={});for(var o in e)a[o]=e[o];r.overridePipelineStates(n[r.passIndex],a)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Cg.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new Gg(t[n],this));return e},B(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Cg),Hg=null,Vg=null,jg=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=i.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=i.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Nv.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!Vg){var n=new Cg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),Vg=new kg({parent:n})}this.enabled&&(Hg||(Hg=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Hg.renderingSubMeshes[0],Vg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=i.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,r=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,a=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===r&&t.macros.CC_USE_HDR===a||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=r,t.macros.CC_USE_HDR=a,e.onGlobalPipelineStateChanged()),this.enabled&&Vg&&Vg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Vg)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=i.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),r=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(td,r),this._globalDSManager.bindTexture(td,n)}var a=this.diffuseMap?this.diffuseMap:this._default;if(a){var o=a.getGFXTexture(),s=e.getSampler(a.getSamplerInfo());this._globalDSManager.bindSampler(rd,s),this._globalDSManager.bindTexture(rd,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();i.Skybox=jg;var Wg,qg,Xg=function(e){L(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Mc.create(),t._pos=new di,t._type=Og.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Bg(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Mc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},B(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Fg),Yg=new di(0,0,-1),Kg=new Ti,Qg=new wi,Zg=new wi,Jg=new wi,$g=new wi,ey=function(e){L(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new di(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._aspect=0,t._aabb=Mc.create(),t._frustum=Wc.create(),t._pos=new di,t._type=Og.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Bg(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new di(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),di.transformQuat(this._dir,Yg,this._node.getWorldRotation(Kg)),di.normalize(this._dir,this._dir),Mc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Qg),wi.invert(Qg,Qg),wi.perspective(Zg,this._angle,1,.001,this._range),wi.multiply(Jg,Zg,Qg),this._frustum.update(Jg,$g),this._needUpdate=!1)},B(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(Fg),ty=Object.freeze({__proto__:null,Ambient:Yi,Octree:Ki,get CameraFOVAxis(){return Wd},get CameraProjection(){return qd},get CameraAperture(){return Xd},get CameraISO(){return Yd},get CameraShutter(){return Kd},SKYBOX_FLAG:fm,Camera:dm,CameraVisFlags:Dg,VisibilityFlags:Mg,DirectionalLight:Ug,ColorTemperatureToRGB:Ng,get LightType(){return Og},nt2lm:Bg,Light:Fg,get ModelType(){return Hv},Model:Zv,ShadowSize:bg,ShadowType:Pg,PCFType:Rg,Shadows:wg,RenderScene:og,Skybox:jg,SphereLight:Xg,SpotLight:ey,SubModel:jv,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function ny(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function iy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Wg||(Wg={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(qg||(qg={}));var ry=function(){function e(e){this._device=void 0,this._format=Sr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new ma,this._region1=new ma,this._region2=new ma,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=lo[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=yo(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=iy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var a=this._chunks[n];a.start+=e;var o={chunkIdx:n,start:i,end:i+e,texture:a.texture};return this._handles.push(o),o}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,ny(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;v("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Pa(Rr.TEX2D,Ir.SAMPLED|Ir.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,o=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-o,a),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),o=0,s+=1,a-=c,l+=c),a>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=s,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=a,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),o=0,s+=this._region1.texExtent.height,a-=c,l+=c),a>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=s,this._region2.texExtent.width=a,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,a*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var a=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<a.length;o++){var s=a[o];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=iy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var a={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(a),a}}var o=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,ny(o)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),ay=function(e){if(void 0===Rn[e]){var t=1<<Pn;Rn[e]=t,Pn+=1}},oy=Object.freeze({__proto__:null,addStage:ay,scene:ty,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var a=[];a.push(new Ua(oa.ATTR_POSITION,Sr.RGB32F)),t.normals&&a.push(new Ua(oa.ATTR_NORMAL,Sr.RGB32F)),t.uvs&&a.push(new Ua(oa.ATTR_TEX_COORD,Sr.RG32F)),t.colors&&a.push(new Ua(oa.ATTR_COLOR,Sr.RGB32F));var o=e.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,4*n.length,4*n.length/i));o.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new ka(a,[o],s))},get RenderQueue(){return Wg},get PassStage(){return qg},genHandle:uv,getTypeFromHandle:hv,getBindingFromHandle:_v,getCountFromHandle:fv,getOffsetFromHandle:pv,customizeType:dv,type2reader:mv,type2writer:vv,getDefaultFromType:yv,overrideMacros:xv,get BatchingSchemes(){return Dv},Pass:kv,getDeviceShaderVersion:Pv,programLib:Rv,nearestPOT:ny,TextureBufferPool:ry,MaterialInstance:kg,PassInstance:Gg,get PoolType(){return fc},NULL_HANDLE:0,get NodeView(){return pc},NodePool:yc,get PassView(){return mc},PassPool:Ec,get AABBView(){return xc},AABBPool:bc});e("renderer",oy);var sy=new di,cy=(new di,new di,new di),ly=new wi,uy=new Mc,hy=new Mc,_y=!1,fy=ia.create(0,0,0,1),py=new ia,dy=new Wc;dy.accurate=!0;var my=new Wc;my.accurate=!0;var vy=new Wc,gy=new wi,yy=new wi,xy=new wi,Sy=new wi,Ty=new wi,Ey=new wi,Ay=new wi,Cy=new di,by=new Ni,Py=new di,Ry=new di,Iy=new di(0,0,0),wy=(new Mc,new je((function(){return{model:null,depth:0}}),128)),Dy=new je((function(){return{model:null,depth:0}}),128),Oy=new je((function(){return{model:null,depth:0}}),128);function My(e,t){var n=0;e.node&&(di.subtract(sy,e.node.worldPosition,t.position),n=di.dot(sy,t.forward));var i=wy.alloc();return i.model=e,i.depth=n,i}function Ny(e,t){var n=0;e.node&&(di.subtract(sy,e.node.worldPosition,t.position),n=di.dot(sy,t.forward));var i=Dy.alloc();return i.model=e,i.depth=n,i}function By(e,t){var n=0;e.node&&(di.subtract(sy,e.node.worldPosition,t.position),n=di.dot(sy,t.forward));var i=Oy.alloc();return i.model=e,i.depth=n,i}function Fy(e,t,n){var i=t.direction,r=e.normal,a=e.distance+.001,o=1/di.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*a,f.m13=c*a,f.m14=l*a,f.m15=1,wi.toArray(n,f,Zp.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Ly(e,t){di.normalize(sy,e.normal),t[Zp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=sy.x,t[Zp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=sy.y,t[Zp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=sy.z,t[Zp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function zy(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var a=i[r];a.baked||(ia.set(fy,a.position.x,a.position.y,a.position.z,a.range),$s.sphereFrustum(fy,t.frustum)&&n.push(a))}for(var o=t.scene.sphereLights,s=0;s<o.length;s++){var c=o[s];c.baked||(ia.set(fy,c.position.x,c.position.y,c.position.z,c.range),$s.sphereFrustum(fy,t.frustum)&&n.push(c))}}function Uy(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,a=r.shadows,o=r.skybox,s=r.renderObjects;wy.freeArray(s),s.length=0;var c=r.castShadowObjects;Oy.freeArray(c),c.length=0,_y=!1;var l=null;if(a.enabled&&(e.pipelineUBO.updateShadowUBORange(Zp.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===Pg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Dy.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var a=t.device;if(r.fixedArea){var o=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;wi.fromRT(gy,n.node.getWorldRotation(),n.node.getWorldPosition()),wi.invert(yy,gy),wi.ortho(Sy,-o,o,-s,s,c,l,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),wi.multiply(Ty,Sy,yy),wi.invert(xy,yy),r.matShadowView=yy,r.matShadowProj=Sy,r.matShadowViewProj=Ty,Wc.createOrtho(e,2*o,2*s,c,l,xy)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();wi.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(ly,i),Wc.split(dy,i,ly,.1,r.shadowDistance),my=Wc.clone(dy),wi.fromRT(gy,n.node.rotation,Iy),wi.invert(yy,gy),wi.invert(xy,yy);var _=yy.clone();my.transform(yy),Mc.fromPoints(uy,new di(1e7,1e7,1e7),new di(-1e7,-1e7,-1e7)),uy.mergeFrustum(my);var f=2*uy.halfExtents.z;cy.set(uy.center.x,uy.center.y,uy.center.z+uy.halfExtents.z+u),di.transformMat4(cy,cy,xy),wi.fromRT(gy,n.node.rotation,cy),wi.invert(yy,gy),wi.invert(xy,yy);var p=di.distance(dy.vertices[0],dy.vertices[6]);py.center.set(0,0,0),py.radius=-1,py.mergePoints(dy.vertices);var d=.8*p+.4*py.radius;r.shadowCameraFar=f+u;var m=.5*d;if(wi.ortho(Sy,-m,m,-m,m,.1,r.shadowCameraFar,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),h>0){wi.multiply(Ey,Sy,_),di.transformMat4(Cy,cy,Ey);var v=2/h;by.set(v,v);var g=Cy.x%by.x,y=Cy.y%by.y;Py.set(Cy.x-g,Cy.y-y,Cy.z),wi.invert(Ay,Ey),di.transformMat4(Ry,Py,Ay),wi.fromRT(gy,n.node.rotation,Ry),wi.invert(yy,gy),wi.invert(xy,yy),Wc.createOrtho(e,d,d,.1,r.shadowCameraFar,xy)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}wi.multiply(Ty,Sy,yy),r.matShadowView=yy,r.matShadowProj=Sy,r.matShadowViewProj=Ty}}(vy,e,i,t,a);else{for(var u=0;u<8;u++)vy.vertices[u].set(0,0,0);vy.updatePlanes()}i&&a.type===Pg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,a=n.distance+.001,o=1/di.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*a,f.m13=c*a,f.m14=l*a,f.m15=1,e.pipelineUBO.updateShadowUBORange(Zp.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),o.enabled&&o.model&&t.clearFlag&fm&&s.push(My(o.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var p=h[f];if(p.enabled&&(p.castShadow&&c.push(By(p,t)),a.firstSetCSM&&p.worldBounds&&(_y||(hy.copy(p.worldBounds),_y=!0),Mc.merge(hy,hy,p.worldBounds)),p.node&&(_&p.node.layer)===p.node.layer||_&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&$s.aabbFrustum(p.worldBounds,vy)&&l.push(Ny(p,t)),p.worldBounds&&!$s.aabbFrustum(p.worldBounds,t.frustum))continue;s.push(My(p,t))}}a.firstSetCSM&&(a.shadowDistance=2*hy.halfExtents.length(),a.firstSetCSM=!1)}var Gy,ky,Hy,Vy,jy,Wy,qy,Xy,Yy,Ky,Qy=new Ia(Mr.LINEAR,Mr.LINEAR,Mr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP),Zy=new Ia(Mr.POINT,Mr.POINT,Mr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP),Jy=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(Qy),this._pointSampler=this._device.getSampler(Zy);var t=new Za(Gp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Ja(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Ja(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Up.UBO_GLOBAL;r<Up.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var a=t.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Zp.SIZE,Zp.SIZE));i.bindBuffer(Zp.BINDING,a),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},B(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),$y=new wi,ex=new wi,tx=new wi,nx=new zi,ix=new zi(0,0,1,0),rx=function(){function e(){this._globalUBO=new Float32Array(Kp.COUNT),this._cameraUBO=new Float32Array(Qp.COUNT),this._shadowUBO=new Float32Array(Zp.COUNT)}e.updateGlobalUBOView=function(e,t){var n=i.director.root,r=t,a=Math.floor(e.width),o=Math.floor(e.height);r[Kp.TIME_OFFSET]=n.cumulativeTime,r[Kp.TIME_OFFSET+1]=n.frameTime,r[Kp.TIME_OFFSET+2]=i.director.getTotalFrames(),r[Kp.SCREEN_SIZE_OFFSET]=a,r[Kp.SCREEN_SIZE_OFFSET+1]=o,r[Kp.SCREEN_SIZE_OFFSET+2]=1/a,r[Kp.SCREEN_SIZE_OFFSET+3]=1/o,r[Kp.NATIVE_SIZE_OFFSET]=a,r[Kp.NATIVE_SIZE_OFFSET+1]=o,r[Kp.NATIVE_SIZE_OFFSET+2]=1/r[Kp.NATIVE_SIZE_OFFSET],r[Kp.NATIVE_SIZE_OFFSET+3]=1/r[Kp.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var r=(n.scene?n.scene:i.director.getScene().renderScene).mainLight,a=e.pipelineSceneData,o=a.ambient,s=a.fog,c=a.shadows,l=t,u=n.exposure,h=a.isHDR;if(l[Qp.SCREEN_SCALE_OFFSET]=a.shadingScale,l[Qp.SCREEN_SCALE_OFFSET+1]=a.shadingScale,l[Qp.SCREEN_SCALE_OFFSET+2]=1/l[Qp.SCREEN_SCALE_OFFSET],l[Qp.SCREEN_SCALE_OFFSET+3]=1/l[Qp.SCREEN_SCALE_OFFSET+1],l[Qp.EXPOSURE_OFFSET]=u,l[Qp.EXPOSURE_OFFSET+1]=1/u,l[Qp.EXPOSURE_OFFSET+2]=h?1:0,l[Qp.EXPOSURE_OFFSET+3]=0,r){var _=c.enabled&&c.type===Pg.ShadowMap?1:0,f=r.direction;if(ix.set(f.x,f.y,f.z,_),zi.toArray(l,ix,Qp.MAIN_LIT_DIR_OFFSET),di.toArray(l,r.color,Qp.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var p=r.colorTemperatureRGB;l[Qp.MAIN_LIT_COLOR_OFFSET]*=p.x,l[Qp.MAIN_LIT_COLOR_OFFSET+1]*=p.y,l[Qp.MAIN_LIT_COLOR_OFFSET+2]*=p.z}l[Qp.MAIN_LIT_COLOR_OFFSET+3]=h?r.illuminance*u:r.illuminance}else ix.set(0,0,1,0),zi.toArray(l,ix,Qp.MAIN_LIT_DIR_OFFSET),zi.toArray(l,zi.ZERO,Qp.MAIN_LIT_COLOR_OFFSET);var d=o.skyColor;d.w=h?o.skyIllum*u:o.skyIllum,l[Qp.AMBIENT_SKY_OFFSET+0]=d.x,l[Qp.AMBIENT_SKY_OFFSET+1]=d.y,l[Qp.AMBIENT_SKY_OFFSET+2]=d.z,l[Qp.AMBIENT_SKY_OFFSET+3]=d.w,l[Qp.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,l[Qp.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,l[Qp.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,l[Qp.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,wi.toArray(l,n.matView,Qp.MAT_VIEW_OFFSET),wi.toArray(l,n.node.worldMatrix,Qp.MAT_VIEW_INV_OFFSET),di.toArray(l,n.position,Qp.CAMERA_POS_OFFSET),wi.toArray(l,n.matProj,Qp.MAT_PROJ_OFFSET),wi.toArray(l,n.matProjInv,Qp.MAT_PROJ_INV_OFFSET),wi.toArray(l,n.matViewProj,Qp.MAT_VIEW_PROJ_OFFSET),wi.toArray(l,n.matViewProjInv,Qp.MAT_VIEW_PROJ_INV_OFFSET),l[Qp.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=s.colorArray;l[Qp.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[Qp.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[Qp.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[Qp.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[Qp.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,l[Qp.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,l[Qp.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,l[Qp.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,l[Qp.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,l[Qp.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten,l[Qp.NEAR_FAR_OFFSET]=n.nearClip,l[Qp.NEAR_FAR_OFFSET+1]=n.farClip,l[Qp.VIEW_PORT_OFFSET]=a.shadingScale*n.window.width*n.viewport.x,l[Qp.VIEW_PORT_OFFSET+1]=a.shadingScale*n.window.height*n.viewport.y,l[Qp.VIEW_PORT_OFFSET+2]=a.shadingScale*n.window.width*n.viewport.z,l[Qp.VIEW_PORT_OFFSET+3]=a.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,a=e.pipelineSceneData.shadows,o=t;if(a.enabled){if(r&&a.type===Pg.ShadowMap){var s=.1,c=0,l=a.matShadowView,u=a.matShadowProj,h=a.matShadowViewProj;a.fixedArea?(s=a.near,c=a.far):(s=.1,c=a.shadowCameraFar),wi.toArray(t,l,Zp.MAT_LIGHT_VIEW_OFFSET),o[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Zp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Zp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Zp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Zp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,wi.toArray(t,h,Zp.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=$d(i)?0:1;o[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,o[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,o[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,o[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-a.saturation,o[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,o[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,o[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=a.pcf,o[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=a.bias,o[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,o[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=a.normalBias,o[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&a.type===Pg.Planar&&(Fy(a,r,o),Ly(a,o));fi.toArray(o,a.shadowColor,Zp.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,a=t,o=$d(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case Og.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),wi.toArray(t,l,Zp.MAT_LIGHT_VIEW_OFFSET),a[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Zp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Zp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Zp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Zp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,wi.toArray(t,h,Zp.MAT_LIGHT_VIEW_PROJ_OFFSET),nx.set(s,c,0,1-r.saturation),zi.toArray(a,nx,Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),nx.set(0,o,r.normalBias,0),zi.toArray(a,nx,Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Og.SPOT:wi.invert($y,n.node.getWorldMatrix()),wi.toArray(a,$y,Zp.MAT_LIGHT_VIEW_OFFSET),wi.perspective(ex,n.angle,n.aspect,.001,n.range),wi.multiply(tx,ex,$y),wi.toArray(a,tx,Zp.MAT_LIGHT_VIEW_PROJ_OFFSET),nx.set(.01,n.range,0,1-r.saturation),zi.toArray(a,nx,Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),nx.set(1,o,r.normalBias,0),zi.toArray(a,nx,Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}nx.set(r.size.x,r.size.y,r.pcf,r.bias),zi.toArray(a,nx,Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),fi.toArray(a,r.shadowColor,Zp.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Kp.SIZE,Kp.SIZE));n.bindBuffer(Kp.BINDING,i);var r=e.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Qp.SIZE,Qp.SIZE));n.bindBuffer(Qp.BINDING,r);var a=e.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Zp.SIZE,Zp.SIZE));n.bindBuffer(Zp.BINDING,a)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Kp.BINDING),this._globalUBO),n.bindBuffer(Kp.BINDING,i.getBuffer(Kp.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(Qp.BINDING),this._cameraUBO),n.bindBuffer(Qp.BINDING,i.getBuffer(Qp.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,a=n.shadowFrameBufferMap,o=t.scene.mainLight;o&&a.has(o)&&i.bindTexture(Jp,a.get(o).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Zp.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(Jp,Nv.get("default-texture").getGFXTexture()),t.bindTexture(sd,Nv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Zp.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof wi?wi.toArray(this._shadowUBO,t,e):t instanceof fi&&fi.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();rx._combineSignY=0;var ax,ox,sx,cx,lx,ux,hx,_x,fx,px,dx,mx,vx,gx=e("RenderStage",(Gy=nl("RenderStage"),ky=Rl(),Hy=Rl(),Vy=Rl(),Gy((Ky=function(){function e(){q(this,"_name",qy,this),q(this,"_priority",Xy,this),this._enabled=!0,q(this,"_tag",Yy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},B(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),qy=X((Wy=Ky).prototype,"_name",[ky,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xy=X(Wy.prototype,"_priority",[Hy,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yy=X(Wy.prototype,"_tag",[Vy,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jy=Wy))||jy));i.RenderStage=gx;var yx,xx=e("RenderFlow",(ax=nl("RenderFlow"),ox=Rl(),sx=Rl(),cx=Rl(),lx=Rl(),ux=Bl([gx]),ax((vx=function(){function e(){q(this,"_name",fx,this),q(this,"_priority",px,this),q(this,"_tag",dx,this),q(this,"_stages",mx,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},B(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),fx=X((_x=vx).prototype,"_name",[ox,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),px=X(_x.prototype,"_priority",[sx,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dx=X(_x.prototype,"_tag",[cx,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mx=X(_x.prototype,"_stages",[lx,ux,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hx=_x))||hx));i.RenderFlow=xx,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(yx||(yx=e("PipelineEventType",{})));var Sx,Tx,Ex,Ax,Cx,bx,Px,Rx,Ix,wx,Dx,Ox,Mx,Nx,Bx,Fx=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}L(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(_n)),Lx=new ua,zx=new va,Ux=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Gx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},kx=e("RenderPipeline",(Sx=nl("cc.RenderPipeline"),Tx=Rl(),Ex=Rl(),Ax=Bl([xx]),Sx((Ix=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_tag",Px,V(t)),q(t,"_flows",Rx,V(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new Fx,t._commandBuffers=[],t._pipelineUBO=new rx,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new ua,t._clusterEnabled=!1,t._bloomEnabled=!1,t}L(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Ha,a=new Va;r.format=t,a.format=n,a.stencilStoreOp=Hr.DISCARD,a.depthStoreOp=Hr.DISCARD,e&na.COLOR||(e&fm?r.loadOp=kr.DISCARD:(r.loadOp=kr.LOAD,r.beginAccesses=[Vr.COLOR_ATTACHMENT_WRITE])),(e&na.DEPTH_STENCIL)!==na.DEPTH_STENCIL&&(e&na.DEPTH||(a.depthLoadOp=kr.LOAD),e&na.STENCIL||(a.stencilLoadOp=kr.LOAD)),a.beginAccesses=[Vr.DEPTH_STENCIL_ATTACHMENT_WRITE];var o=new qa([r],a);return i.createRenderPass(o)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,a=0;a<r.length;a++)r[a].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Ka(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,Lx),t||(t=zx);var n=this.pipelineSceneData.shadingScale;return t.left=Lx.x*n,t.top=Lx.y*n,t.width=Lx.width*n,t.height=Lx.height*n,t},n.generateScissor=function(e,t){t||(t=Lx),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=i.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new Jy(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(yx.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Tg=n)}Tg=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(yx.RENDER_CAMERA_BEGIN,n),zy(this,n),Uy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(yx.RENDER_CAMERA_END,n)}}this.emit(yx.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,a=t.y/this._height,o=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=o;o=a,a=s}var c=0;switch(e){case yr.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case yr.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=a;break;case yr.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case yr.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o}return n},n._createQuadInputAssembler=function(){var e=new Gx,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE|Pr.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r,o=this._device.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,a,r));if(!o)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,o.update(s);var c=new Array(2);c[0]=new Ua("a_position",Sr.RG32F),c[1]=new Ua("a_texCoord",Sr.RG32F);var l=this._device.createInputAssembler(new ka(c,[i],o));return e.quadIB=o,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(yr.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||yr.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(xr.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(xr.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(fn.os===ln.ANDROID&&fn.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+($e.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Ux,t=this.device,n=new Ha;n.format=Sr.RGBA8,n.loadOp=kr.CLEAR,n.storeOp=Hr.STORE,n.endAccesses=[Vr.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new qa([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Ka(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var a=0;a<6;++a)e.downsampleTexs.push(t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[a]=t.createFramebuffer(new Ka(e.renderPass,[e.downsampleTexs[a]])),e.upsampleTexs.push(t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA8,i,r))),e.upsampleFramebuffers[a]=t.createFramebuffer(new Ka(e.renderPass,[e.upsampleTexs[a]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Ka(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},B(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(Du),Px=X((bx=Ix).prototype,"_tag",[Tx,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rx=X(bx.prototype,"_flows",[Ex,Ax,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cx=bx))||Cx));i.RenderPipeline=kx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(wx||(wx={})),function(e){e[e.FORWARD=10]="FORWARD"}(Dx||(Dx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(Ox||(Ox={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(Mx||(Mx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Nx||(Nx={}));var Hx=new Ha;Hx.format=Sr.RGBA8,Hx.beginAccesses=[Vr.FRAGMENT_SHADER_READ_TEXTURE],Hx.endAccesses=[Vr.FRAGMENT_SHADER_READ_TEXTURE];var Vx=new Va;Vx.format=Sr.DEPTH_STENCIL;var jx,Wx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eS,tS,nS,iS,rS,aS,oS,sS,cS,lS,uS,hS,_S,fS,pS,dS,mS,vS,gS,yS,xS,SS,TS,ES,AS,CS,bS,PS,RS,IS,wS,DS,OS,MS,NS,BS,FS,LS,zS,US,GS,kS,HS,VS,jS,WS,qS,XS,YS,KS,QS,ZS,JS,$S,eT,tT,nT,iT,rT,aT,oT,sT,cT,lT,uT,hT,_T,fT,pT,dT=new qa([Hx],Vx),mT={width:1,height:1,renderPassInfo:dT},vT=e("RenderTexture",nl("cc.RenderTexture")(Bx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=i.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(Yn(e,1,2048)),this._height=Math.floor(Yn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=i.director.root;mT.title=this._name,mT.width=this._width,mT.height=this._height,mT.renderPassInfo=e&&e.passInfo?e.passInfo:dT,this._window?(this._window.destroy(),this._window.initialize(t.device,mT)):this._window=t.createWindow(mT)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var a=this.getGFXTexture();if(!a)return b(7606),null;var o=4*n*i;if(void 0===r)r=new Uint8Array(o);else if(r.length<o)return b(7607,o),null;var s=this._getGFXDevice(),c=[],l=[],u=new ma;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(a,c,l),r},B(t,[{key:"window",get:function(){return this._window}}]),t}(Om))||Bx);i.RenderTexture=vT,Ze(Rr),Ze(Ir),Ze(Hr),Ze(kr),Ze(Vr),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(pT||(pT={})),Ze(pT),jx=nl("RenderTextureDesc"),Wx=Bl(Rr),qx=Bl(Ir),Xx=Bl(Sr),jx((Kx=X((Yx=function(){q(this,"name",Kx,this),q(this,"type",Qx,this),q(this,"usage",Zx,this),q(this,"format",Jx,this),q(this,"width",$x,this),q(this,"height",eS,this)}).prototype,"name",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Qx=X(Yx.prototype,"type",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rr.TEX2D}}),Zx=X(Yx.prototype,"usage",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ir.COLOR_ATTACHMENT}}),Jx=X(Yx.prototype,"format",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sr.UNKNOWN}}),$x=X(Yx.prototype,"width",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),eS=X(Yx.prototype,"height",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Yx));var gT,yT=(tS=nl("RenderTextureConfig"),nS=Bl(vT),tS((aS=X((rS=function(){q(this,"name",aS,this),q(this,"texture",oS,this)}).prototype,"name",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oS=X(rS.prototype,"texture",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iS=rS))||iS),xT=(sS=nl("MaterialConfig"),cS=Bl(Cg),sS((uS=X((lS=function(){q(this,"name",uS,this),q(this,"material",hS,this)}).prototype,"name",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hS=X(lS.prototype,"material",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lS)),_S=nl("FrameBufferDesc"),fS=Bl([At]),pS=Bl(vT),_S((mS=X((dS=function(){q(this,"name",mS,this),q(this,"renderPass",vS,this),q(this,"colorTextures",gS,this),q(this,"depthStencilTexture",yS,this),q(this,"texture",xS,this)}).prototype,"name",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vS=X(dS.prototype,"renderPass",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gS=X(dS.prototype,"colorTextures",[fS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yS=X(dS.prototype,"depthStencilTexture",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xS=X(dS.prototype,"texture",[pS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dS)),SS=nl("ColorDesc"),TS=Bl(Sr),ES=Bl(kr),AS=Bl(Hr),CS=Bl([Vr]),bS=Bl([Vr]),SS((IS=X((RS=function(){q(this,"format",IS,this),q(this,"loadOp",wS,this),q(this,"storeOp",DS,this),q(this,"sampleCount",OS,this),q(this,"beginAccesses",MS,this),q(this,"endAccesses",NS,this)}).prototype,"format",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sr.UNKNOWN}}),wS=X(RS.prototype,"loadOp",[ES],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),DS=X(RS.prototype,"storeOp",[AS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.STORE}}),OS=X(RS.prototype,"sampleCount",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),MS=X(RS.prototype,"beginAccesses",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NS=X(RS.prototype,"endAccesses",[bS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Vr.COLOR_ATTACHMENT_WRITE]}}),PS=RS))||PS),ST=(BS=nl("DepthStencilDesc"),FS=Bl(Sr),LS=Bl(kr),zS=Bl(Hr),US=Bl(kr),GS=Bl(Hr),kS=Bl([Vr]),HS=Bl([Vr]),BS((WS=X((jS=function(){q(this,"format",WS,this),q(this,"depthLoadOp",qS,this),q(this,"depthStoreOp",XS,this),q(this,"stencilLoadOp",YS,this),q(this,"stencilStoreOp",KS,this),q(this,"sampleCount",QS,this),q(this,"beginAccesses",ZS,this),q(this,"endAccesses",JS,this)}).prototype,"format",[FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sr.UNKNOWN}}),qS=X(jS.prototype,"depthLoadOp",[LS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),XS=X(jS.prototype,"depthStoreOp",[zS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.STORE}}),YS=X(jS.prototype,"stencilLoadOp",[US],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),KS=X(jS.prototype,"stencilStoreOp",[GS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.STORE}}),QS=X(jS.prototype,"sampleCount",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZS=X(jS.prototype,"beginAccesses",[kS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JS=X(jS.prototype,"endAccesses",[HS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Vr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),VS=jS))||VS);$S=nl("RenderPassDesc"),eT=Bl([xT]),tT=Bl(ST),$S((iT=X((nT=function(){q(this,"index",iT,this),q(this,"colorAttachments",rT,this),q(this,"depthStencilAttachment",aT,this)}).prototype,"index",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),rT=X(nT.prototype,"colorAttachments",[eT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aT=X(nT.prototype,"depthStencilAttachment",[tT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ST}}),nT)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(gT||(gT={})),Ze(gT);var TT=(oT=nl("RenderQueueDesc"),sT=Bl(gT),cT=Bl([At]),oT((hT=X((uT=function(){q(this,"isTransparent",hT,this),q(this,"sortMode",_T,this),q(this,"stages",fT,this)}).prototype,"isTransparent",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_T=X(uT.prototype,"sortMode",[sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gT.FRONT_TO_BACK}}),fT=X(uT.prototype,"stages",[cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lT=uT))||lT);function ET(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function AT(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var CT=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new We((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new qe(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],a=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var o=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=o,s.depth=e.depth||0,s.shaderId=a.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],a=r.subModel,o=r.passIdx,s=a.inputAssembler,c=a.passes[o],l=a.shaders[o],u=cg.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Wp.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Wp.LOCAL,a.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function bT(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Bv(e.stages[n]);var i=ET;switch(e.sortMode){case gT.BACK_TO_FRONT:i=AT;break;case gT.FRONT_TO_BACK:i=ET}return new CT({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function PT(e){e.clear()}function RT(e){e.sort()}var IT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var a=0;a<r.vbs.length;++a)r.vbs[a].update(r.vbDatas[a]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var a=!1,o=0;o<r.value.batches.length;++o){var s=r.value.batches[o];if(s.mergeCount){if(!a){var c=s.shader,l=cg.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Wp.MATERIAL,s.pass.descriptorSet),a=!0}n.bindDescriptorSet(Wp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),wT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var a=r.value,o=a.instances,s=a.pass;if(a.hasPendingModels){n.bindDescriptorSet(Wp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<o.length;++l){var u=o[l];if(u.count){var h=u.shader,_=cg.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(Wp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),DT=new je((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),OT=new Float32Array(4),MT=[],NT=[],BT=new wi,FT=new wi;function LT(e,t){return!(!t.worldBounds||$s.aabbWithAABB(t.worldBounds,e.aabb))}function zT(e,t){return!(!t.worldBounds||$s.aabbWithAABB(t.worldBounds,e.aabb)&&$s.aabbFrustum(t.worldBounds,e.frustum))}var UT=Bv("forward-add"),GT=[];function kT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===UT){a=o,n=!0;break}t.push(a)}return n}var HT,VT,jT,WT,qT,XT,YT,KT,QT,ZT,JT,$T=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Zp.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new wT,this._batchedQueue=new IT;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(pd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Ea(this._lightBuffer,0,pd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}DT.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Zp.BINDING).destroy(),r.getTexture(Jp).destroy(),r.getTexture(sd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var a=i[r].model,o=a.subModels;if(kT(o,GT)&&(NT.length=0,this._lightCulling(a,n),NT.length))for(var s=0;s<o.length;s++){var c=GT[s];if(!(c<0)){var l=o[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(pd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,a,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var a=this._lightPasses[r],o=a.subModel,s=a.passIdx,c=a.dynamicOffsets,l=a.lights,u=o.passes[s],h=o.shaders[s],_=o.inputAssembler,f=cg.getOrCreatePipelineState(e,u,h,t,_),p=u.descriptorSet,d=o.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(Wp.MATERIAL,p),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);MT[0]=c[m],n.bindDescriptorSet(Wp.GLOBAL,g),n.bindDescriptorSet(Wp.LOCAL,d,MT),n.draw(_)}}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case Og.SPHERE:r=LT(i,e);break;case Og.SPOT:r=zT(i,e)}r||NT.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===Dv.INSTANCING)for(var a=0;a<NT.length;a++){var o=NT[a],s=e.getInstancedBuffer(o);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*o,this._instancedQueue.queue.add(s)}else if(r===Dv.VB_MERGING)for(var c=0;c<NT.length;c++){var l=NT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=DT.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<NT.length;_++){var f=NT[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,a=i.shadowFrameBufferMap,o=e.scene.mainLight,s=$d(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,p=void 0;switch(h.type){case Og.SPHERE:o&&(Fy(r,o,this._shadowUBO),Ly(r,this._shadowUBO)),this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,fi.toArray(this._shadowUBO,r.shadowColor,Zp.SHADOW_COLOR_OFFSET);break;case Og.SPOT:if(o&&(Fy(r,o,this._shadowUBO),Ly(r,this._shadowUBO)),wi.invert(BT,h.node.getWorldMatrix()),wi.perspective(FT,h.angle,h.aspect,.001,h.range),f=FT.clone(),p=FT.clone().invert(),wi.multiply(FT,FT,BT),wi.toArray(this._shadowUBO,BT,Zp.MAT_LIGHT_VIEW_OFFSET),wi.toArray(this._shadowUBO,FT,Zp.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Zp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Zp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Zp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Zp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Zp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[Zp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[Zp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[Zp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[Zp.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Zp.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Zp.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Zp.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,fi.toArray(this._shadowUBO,r.shadowColor,Zp.SHADOW_COLOR_OFFSET),a.has(h)){var d,m=null===(d=a.get(h))||void 0===d?void 0:d.colorTextures[0];m&&_.bindTexture(sd,m)}}_.update(),t.updateBuffer(_.getBuffer(Zp.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,a=i.shadows,o=i.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=ai(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Ea(this._lightBuffer,0,pd.SIZE)));for(var s=0,c=0;s<o.length;s++,c+=this._lightBufferElementCount){var l=o[s];switch(l.type){case Og.SPHERE:if(di.toArray(OT,l.position),OT[3]=0,this._lightBufferData.set(OT,c+pd.LIGHT_POS_OFFSET),OT[0]=l.size,OT[1]=l.range,OT[2]=0,OT[3]=a.enabled&&a.type===Pg.ShadowMap?1:0,this._lightBufferData.set(OT,c+pd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),di.toArray(OT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;OT[0]*=u.x,OT[1]*=u.y,OT[2]*=u.z}OT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(OT,c+pd.LIGHT_COLOR_OFFSET);break;case Og.SPOT:if(di.toArray(OT,l.position),OT[3]=1,this._lightBufferData.set(OT,c+pd.LIGHT_POS_OFFSET),OT[0]=l.size,OT[1]=l.range,OT[2]=l.spotAngle,OT[3]=a.enabled&&a.type===Pg.ShadowMap?1:0,this._lightBufferData.set(OT,c+pd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),di.toArray(OT,l.direction),this._lightBufferData.set(OT,c+pd.LIGHT_DIR_OFFSET),di.toArray(OT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;OT[0]*=h.x,OT[1]*=h.y,OT[2]*=h.z}OT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(OT,c+pd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),eE=new Mc,tE=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new wT,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Pg.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,a=e.frustum,o=0!=(e.visibility&Mp.BitMask.DEFAULT);if(r.mainLight&&o){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Mc.transform(eE,_.worldBounds,i.matLight),$s.aabbFrustum(eE,a)))if(_.isInstancingEnabled)for(var f=_.subModels,p=0;p<f.length;p++){var d=f[p];u.merge(d,_.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Pg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],a=r.descriptorSet;n.bindDescriptorSet(Wp.MATERIAL,a);for(var o=this._pendingModels.length,s=0;s<o;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=cg.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(Wp.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),nE=function(){function e(){this._phaseID=Bv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],a=e.scene.batches,o=0;o<a.length;o++){var s=a[o],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=cg.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(p),r.bindDescriptorSet(Wp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Wp.LOCAL,d),r.bindInputAssembler(f),r.draw(f)}}}},e}(),iE=[new ga(0,0,0,1)],rE=e("ForwardStage",(HT=nl("ForwardStage"),VT=Bl([TT]),jT=Rl(),HT((KT=YT=function(e){function t(){var t;return q(t=e.call(this)||this,"renderQueues",XT,V(t)),t._renderQueues=[],t._renderArea=new ua,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Bv("default"),t._clearFlag=4294967295,t._batchedQueue=new IT,t._instancedQueue=new wT,t._uiPhase=new nE,t}L(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=bT(this.renderQueues[i]);this._additiveLightQueue=new $T(this._pipeline),this._planarQueue=new tE(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(PT);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Dv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(f===Dv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,a,c.model),this._batchedQueue.queue.add(d)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(RT);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&na.COLOR&&(iE[0].x=e.clearColor.x,iE[0].y=e.clearColor.y,iE[0].z=e.clearColor.z,iE[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,iE,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(e,g),Eg(n,g,m,t.profiler,e),m.endRenderPass()},t}(gx),YT.initInfo={name:"ForwardStage",priority:Dx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:gT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gT.BACK_TO_FRONT,stages:["default","planarShadow"]}]},XT=X((qT=KT).prototype,"renderQueues",[VT,cl,jT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WT=qT))||WT)),aE=e("ForwardFlow",nl("ForwardFlow")((JT=ZT=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new rE;n.initialize(rE.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(xx),ZT.initInfo={name:Lp,priority:Ox.FORWARD,stages:[]},QT=JT))||QT),oE=new wi,sE=new wi,cE=new wi,lE=new Mc,uE=Bv("shadow-caster"),hE=[];function _E(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===uE){a=o,n=!0;break}t.push(a)}return n}var fE,pE,dE,mE,vE,gE,yE=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new wT,this._batchedQueue=new IT}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,a=r.shadows;if(n&&a.enabled&&a.type===Pg.ShadowMap){var o=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case Og.DIRECTIONAL:for(var c=0;c<o.length;c++){var l=o[c].model;_E(l.subModels,hE)&&this.add(l,hE)}break;case Og.SPOT:wi.invert(oE,n.node.getWorldMatrix()),wi.perspective(sE,n.angle,n.aspect,.001,n.range),wi.multiply(cE,sE,oE);for(var u=0;u<s.length;u++){var h=s[u].model;_E(h.subModels,hE)&&(h.worldBounds&&(Mc.transform(lE,h.worldBounds,cE),!$s.aabbFrustum(lE,t.frustum))||this.add(h,hE))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],a=t[i],o=r.passes[a];if(o.batchingScheme===Dv.INSTANCING){var s=o.getInstancedBuffer();s.merge(r,e.instancedAttributes,a),this._instancedQueue.queue.add(s)}else if(o.batchingScheme===Dv.VB_MERGING){var c=o.getBatchedBuffer();c.merge(r,a,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[a];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(o)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],a=this._shaderArray[i],o=this._passArray[i],s=r.inputAssembler,c=cg.getOrCreatePipelineState(e,o,a,t,s),l=o.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Wp.MATERIAL,l),n.bindDescriptorSet(Wp.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),xE=[new ga(1,1,1,1)],SE=e("ShadowStage",nl("ShadowStage")((dE=pE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new ua,t._light=null,t._globalDS=null,t}L(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){xE[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,xE,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,a=this._globalDS,o=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light),this._additiveShadowQueue.gatherLightPasses(a,e,this._light,o);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,xE,e.clearDepth,e.clearStencil),o.bindDescriptorSet(Wp.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(l,u,o),o.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new yE(t)},t}(gx),pE.initInfo={name:"ShadowStage",priority:Dx.FORWARD,tag:0},fE=dE))||fE),TE=[],EE=e("ShadowFlow",nl("ShadowFlow")((gE=vE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}L(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new SE;n.initialize(SE.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Pg.ShadowMap){for(var o=0,s=0;o<n.maxReceived&&s<a.length;){var c=a[s];c.type===Og.SPOT&&(TE.push(c),o++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var p=0;p<TE.length;p++){var d=TE[p],m=t.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(t,d,e.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(e)}}TE.length=0}else this.clearShadowMap(TE,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var a=r.colorTextures,o=0;o<a.length;o++){var s=a[i];s&&s.destroy()}a.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,a=$d(n)?Sr.R32F:Sr.RGBA8;if(!this._shadowRenderPass){var o=new Ha;o.format=a,o.loadOp=kr.CLEAR,o.storeOp=Hr.STORE,o.sampleCount=1;var s=new Va;s.format=Sr.DEPTH_STENCIL,s.depthLoadOp=kr.CLEAR,s.depthStoreOp=Hr.DISCARD,s.stencilLoadOp=kr.CLEAR,s.stencilStoreOp=Hr.DISCARD,s.sampleCount=1;var c=new qa([o],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,a,i.x,i.y)));var u=n.createTexture(new Pa(Rr.TEX2D,Ir.DEPTH_STENCIL_ATTACHMENT,Sr.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Ka(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var a=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var o=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(a,r,o),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(_,u,h),p.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,a=$d(i)?Sr.R32F:Sr.RGBA8,o=r.values(),s=o.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,a,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Ka(h,l,u)),s=o.next()}else s=o.next()}e.shadowMapDirty=!1},t}(xx),vE.initInfo={name:zp,priority:Ox.SHADOW,tag:pT.SCENE,stages:[]},mE=gE))||mE),AE=new zi,CE=Ye({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),bE=CE.LAYERED+1,PE=function(){function e(){this._fogColor=new fi("#C8C8C8"),this._colorArray=new zi(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:bE},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=i.director.root,t=this.enabled?this.type:bE,n=this.accurate?1:0,r=e.pipeline;r.macros.CC_USE_FOG===t&&r.macros.CC_USE_ACCURATE_FOG===n||(r.macros.CC_USE_FOG=t,r.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=bE,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),AE.set(e.x,e.y,e.z,e.w),hg(this._colorArray,AE)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();function RE(e,t){for(var n,i=W(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?RE(e,r):e.push(r)}}function IE(e){var t=[];return RE(t,e),t.join("")}i.Fog=PE;var wE=Yt.Flags.Destroyed,DE=Yt.Flags.PersistentMask,OE=kt.IDENTIFIER_RE,ME="var ",NE="o",BE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},FE=kt.escapeForJS,LE=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return ME+this.varName+"="+this.expression+";"},e}();function zE(e,t){return t instanceof LE?new LE(t.varName,e+t.expression):e+t}function UE(e,t,n){Array.isArray(n)?(n[0]=zE(t,n[0]),e.push(n)):e.push(zE(t,n)+";")}var GE=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];UE(e,t+kE(i[0])+"=",i[1])}},e}();function kE(e){return OE.test(e)?"."+e:"["+FE(e)+"]"}GE.pool=void 0,GE.pool=new Ue((function(e){e._exps.length=0,e._targetExp=null}),1),GE.pool.get=function(e){var t=this._get()||new GE;return t._targetExp=e,t};var HE=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=_e(),Ee(this.funcModuleCache,BE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=ME+this.globalVariables.join(",")+";");var i=IE(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=fe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var o="F["+a+"]";return t&&(o="("+o+")"),this.funcModuleCache[n]=o,o},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=GE.pool.get(i),a=t.constructor.__props__;a||(a=Object.keys(t));for(var o=0;o<a.length;o++){var s=a[o],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),GE.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var r=n.__values__,a=gt(n),o=0;o<r.length;o++){var s=r[o],c=t[s],l=a[s+"$_$default"];if(!VE(l,c))if("object"==typeof c&&c instanceof i.ValueType&&(l=kt.getDefault(l))&&l.constructor===c.constructor){var u=NE+kE(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new LE(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)UE(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new LE(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&UE(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=i.source[0];i.source[0]=zE(r+"=",a)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?FE(n):("_objFlags"===t&&e instanceof Yt&&(n&=DE),n)},t.setObjProp=function(e,t,n,i){UE(e,NE+kE(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=t[r];"object"==typeof a&&a&&a===t._iN$t||this.setObjProp(e,t,r,a)}},t.instantiateObj=function(e){if(e instanceof i.ValueType)return kt.getNewValueTypeCode(e);if(e instanceof i.Asset)return this.getObjRef(e);if(e._objFlags&wE)return null;var t,n=e.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return this.getObjRef(e)}else if(this.parent instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof i.Component){var r;if(!(null===(r=e.node)||void 0===r?void 0:r.isChildOf(this.parent)))return this.getObjRef(e)}t=new LE(NE,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new LE(NE,"{}");else{if(n)return this.getObjRef(e);t=new LE(NE,"Object.create(null)")}var a=[t];return e._iN$t={globalVar:"",source:a},this.objsToClear_iN$t.push(e),this.enumerateObject(a,e),["(function(){",a,"return o;})();"]},e}();function VE(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof i.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return oe(e)&&oe(t)}return!1}var jE,WE,qE,XE,YE,KE,QE,ZE,JE,$E,eA=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},B(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?A(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();Yt.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(jE||(jE={}));var tA=Yt.Flags.Destroying,nA=Yt.Flags.DontDestroy,iA=Yt.Flags.Deactivating,rA=new ee("Node");function aA(e){return e?"string"==typeof e?Le(e):e:(b(3804),null)}var oA,sA,cA,lA,uA,hA,_A,fA,pA,dA,mA,vA=e("BaseNode",nl("cc.BaseNode")(($E=JE=function(e){L(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var a=i[r];if(a.constructor===t)return a}else for(var o=0;o<i.length;++o){var s=i[o];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var a=0;a<r.length;++a){var o=r[a];o.constructor===t&&n.push(o)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],a=n._findComponent(r,t);if(a)return a;if(r._children.length>0&&(a=n._findChildComponent(r._children,t)))return a}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var a=e[r];n._findComponents(a,t,i),a._children.length>0&&n._findChildComponents(a._children,t,i)}};var t=n.prototype;function n(t){var n;return q(n=e.call(this,t)||this,"_parent",XE,V(n)),q(n,"_children",YE,V(n)),q(n,"_active",KE,V(n)),q(n,"_components",QE,V(n)),q(n,"_prefab",ZE,V(n)),n._scene=null,n._activeInHierarchy=!1,n._id=rA.getNewId(),n._name=void 0,n._eventProcessor=new i.NodeEventProcessor(V(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Ee(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(jE.PARENT_CHANGED,n),n&&!(n._objFlags&tA)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(jE.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(jE.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return f("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return f("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var a=i(r);if("continue"!==a&&"object"==typeof a)return a.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&iA)b(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,a=null,o=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(a=s[--i])if(!l&&e?e(a):l&&t&&t(a),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++o])s[i]=r[o],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(o=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),o<0))break}else a._children.length>0?(c=a,r=a._children,o=0,s[i]=r[o],i++):(s[i]=a,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=aA(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=aA(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=aA(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=aA(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=Le(e)))throw i._RF.peek()&&b(3808,e),TypeError(w(3807,e))}else{if(!e)throw TypeError(w(3804));t=e}if("function"!=typeof t)throw TypeError(w(3809));if(!be(t,i.Component))throw TypeError(w(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var r=0;r<n.length;r++){var a=n[r];this.getComponent(a)||this.addComponent(a)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var s=new t;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof Ju?e:this.getComponent(e))&&t.destroy()}else b(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case jE.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case jE.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(jE.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&tA)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&b(3815)}}else b(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(jE.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=i.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof i.Scene||i.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&i.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=tA;var e=this._parent,t=!!e&&0!=(e._objFlags&tA);if(this._persistNode&&i.game.removePersistRootNode(this),!t&&e){this.emit(jE.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(jE.CHILD_REMOVED,this)}this.emit(jE.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var o=this._components,s=0;s<o.length;++s)o[s]._destroyImmediate();return t},B(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&nA)>0},set:function(e){e?this._objFlags|=nA:this._objFlags&=~nA}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&i.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Yt),JE.idGenerator=rA,JE._stacks=[[]],JE._stackId=0,X((qE=$E).prototype,"_persistNode",[ol],Object.getOwnPropertyDescriptor(qE.prototype,"_persistNode"),qE.prototype),X(qE.prototype,"name",[yl],Object.getOwnPropertyDescriptor(qE.prototype,"name"),qE.prototype),X(qE.prototype,"children",[yl],Object.getOwnPropertyDescriptor(qE.prototype,"children"),qE.prototype),X(qE.prototype,"active",[yl],Object.getOwnPropertyDescriptor(qE.prototype,"active"),qE.prototype),X(qE.prototype,"activeInHierarchy",[yl],Object.getOwnPropertyDescriptor(qE.prototype,"activeInHierarchy"),qE.prototype),X(qE.prototype,"parent",[yl],Object.getOwnPropertyDescriptor(qE.prototype,"parent"),qE.prototype),XE=X(qE.prototype,"_parent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YE=X(qE.prototype,"_children",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KE=X(qE.prototype,"_active",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QE=X(qE.prototype,"_components",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZE=X(qE.prototype,"_prefab",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WE=qE))||WE);i._BaseNode=vA;var gA=new di,yA=new Ti,xA=new Ti,SA=new Ti,TA=new yi,EA=new yi,AA=new wi,CA=[],bA=[],PA=[],RA=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return PA[0]=this._chunks[e],PA[1]=this._freelists[e].pop(),PA},e}();RA.CAPACITY_PER_CHUNK=256;var IA,wA,DA,OA,MA,NA,BA,FA,LA,zA,UA,GA,kA,HA,VA,jA,WA,qA,XA,YA,KA,QA,ZA,JA,$A,eC,tC,nC,iC,rC,aC,oC,sC,cC,lC,uC,hC,_C,fC,pC,dC,mC,vC,gC,yC,xC,SC,TC,EC,AC,CC,bC,PC,RC,IC,wC,DC,OC,MC,NC,BC,FC,LC,zC,UC,GC,kC,HC,VC,jC=new RA,WC=Symbol("ReserveContentsForAllSyncablePrefab"),qC=e("Node",(oA=nl("cc.Node"),sA=Bl(di),oA((mA=dA=function(e){L(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new eA(V(n)),n._static=!1,q(n,"_lpos",uA,V(n)),q(n,"_lrot",hA,V(n)),q(n,"_lscale",_A,V(n)),q(n,"_layer",fA,V(n)),q(n,"_euler",pA,V(n)),n._dirtyFlagsPri=Yv.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=jC.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new di,this._rot=new Ti,this._scale=new di(1,1,1),this._mat=new wi},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof i.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return jC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[lh]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),wi.multiply(AA,wi.invert(AA,i._mat),this._mat),wi.toRTS(AA,this._lrot,this._lpos,this._lscale)):(di.copy(this._lpos,this._pos),Ti.copy(this._lrot,this._rot),di.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Yv.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=Yv.TRS,this._dirtyFlags|=Yv.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Yv.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||Xv.LOCAL;if(n===Xv.LOCAL)di.transformQuat(gA,e,this._lrot),this._lpos.x+=gA.x,this._lpos.y+=gA.y,this._lpos.z+=gA.z;else if(n===Xv.WORLD)if(this._parent){Ti.invert(yA,this._parent.worldRotation),di.transformQuat(gA,e,yA);var i=this.worldScale;this._lpos.x+=gA.x/i.x,this._lpos.y+=gA.y/i.y,this._lpos.z+=gA.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Yv.POSITION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.POSITION)},t.rotate=function(e,t){var n=t||Xv.LOCAL;if(Ti.normalize(yA,e),n===Xv.LOCAL)Ti.multiply(this._lrot,this._lrot,yA);else if(n===Xv.WORLD){var i=this.worldRotation;Ti.multiply(xA,yA,i),Ti.invert(yA,i),Ti.multiply(xA,yA,xA),Ti.multiply(this._lrot,this._lrot,xA)}this._eulerDirty=!0,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(gA),di.subtract(gA,gA,e),di.normalize(gA,gA),Ti.fromViewUp(yA,gA,t),this.setWorldRotation(yA)},t._setDirtyNode=function(e,t){CA[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,a=0,o=0,s=0,c=0,l=e|Yv.POSITION;for(CA[0]=this;r>=0;){if(c=(t=CA[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,o=(i=t._children).length,a=0;a<o;a++)n=i[a],CA[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=CA[--n])._dirtyFlags,t?(i&Yv.POSITION&&(di.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Yv.RS&&(wi.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),wi.multiply(e._mat,t._mat,e._mat),i&Yv.ROTATION&&Ti.multiply(e._rot,t._rot,e._lrot),yi.fromQuat(TA,Ti.conjugate(SA,e._rot)),yi.multiplyMat4(TA,TA,e._mat),e._scale.x=TA.m00,e._scale.y=TA.m04,e._scale.z=TA.m08)):(i&Yv.POSITION&&(di.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Yv.RS&&(i&Yv.ROTATION&&Ti.copy(e._rot,e._lrot),i&Yv.SCALE&&(di.copy(e._scale,e._lscale),wi.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=Yv.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?di.copy(this._lpos,e):void 0===n?di.set(this._lpos,e,t,this._lpos.z):di.set(this._lpos,e,t,n),this.invalidateChildren(Yv.POSITION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.POSITION)},t.getPosition=function(e){return e?di.set(e,this._lpos.x,this._lpos.y,this._lpos.z):di.copy(new di,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ti.copy(this._lrot,e):Ti.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(di.copy(this._euler,e),Ti.fromEuler(this._lrot,e.x,e.y,e.z)):(di.set(this._euler,e,t,i),Ti.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)},t.getRotation=function(e){return e?Ti.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Ti.copy(new Ti,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?di.copy(this._lscale,e):void 0===n?di.set(this._lscale,e,t,this._lscale.z):di.set(this._lscale,e,t,n),this.invalidateChildren(Yv.SCALE),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.SCALE)},t.getScale=function(e){return e?di.set(e,this._lscale.x,this._lscale.y,this._lscale.z):di.copy(new di,this._lscale)},t.inverseTransformPoint=function(e,t){di.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)di.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=CA[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?di.copy(this._pos,e):di.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),di.transformMat4(r,this._pos,wi.invert(AA,i._mat))):di.copy(r,this._pos),this.invalidateChildren(Yv.POSITION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?di.copy(e,this._pos):di.copy(new di,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ti.copy(this._rot,e):Ti.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Ti.multiply(this._lrot,Ti.conjugate(this._lrot,this._parent._rot),this._rot)):Ti.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Ti.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Ti.multiply(this._lrot,Ti.conjugate(this._lrot,this._parent._rot),this._rot)):Ti.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Ti.copy(e,this._rot):Ti.copy(new Ti,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?di.copy(this._scale,e):di.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),yi.fromQuat(TA,Ti.conjugate(SA,i._rot)),yi.multiplyMat4(TA,TA,i._mat),EA.m00=this._scale.x,EA.m04=this._scale.y,EA.m08=this._scale.z,yi.multiply(TA,EA,yi.invert(TA,TA)),this._lscale.x=di.set(gA,TA.m00,TA.m01,TA.m02).length(),this._lscale.y=di.set(gA,TA.m03,TA.m04,TA.m05).length(),this._lscale.z=di.set(gA,TA.m06,TA.m07,TA.m08).length()):di.copy(this._lscale,this._scale),this.invalidateChildren(Yv.SCALE),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?di.copy(e,this._scale):di.copy(new di,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new wi;return wi.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new wi;return wi.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new wi;return wi.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=Yv.ROTATION,void 0!==e.w?(Ti.copy(this._lrot,e),this._eulerDirty=!0):(di.copy(this._euler,e),Ti.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(di.copy(this._lpos,t),i|=Yv.POSITION),n&&(di.copy(this._lscale,n),i|=Yv.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){jC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,CA.length=0,bA.length=0)},B(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Ti.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){di.set(this._euler,0,0,e),Ti.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Yv.ROTATION),1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){wi.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Yv.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(jE.TRANSFORM_CHANGED,Yv.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return di.transformQuat(new di,di.FORWARD,this.worldRotation)},set:function(e){var t=e.length();di.multiplyScalar(gA,e,-1/t),Ti.fromViewUp(yA,gA),this.setWorldRotation(yA)}},{key:"up",get:function(){return di.transformQuat(new di,di.UP,this.worldRotation)}},{key:"right",get:function(){return di.transformQuat(new di,di.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(jE.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(vA),dA.EventType=jE,dA.NodeSpace=Xv,dA.TransformDirtyBit=Yv,dA.TransformBit=Yv,dA.reserveContentsForAllSyncablePrefabTag=WC,dA.ClearFrame=0,dA.ClearRound=1e3,uA=X((lA=mA).prototype,"_lpos",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di}}),hA=X(lA.prototype,"_lrot",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),_A=X(lA.prototype,"_lscale",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(1,1,1)}}),fA=X(lA.prototype,"_layer",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mp.Enum.DEFAULT}}),pA=X(lA.prototype,"_euler",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di}}),X(lA.prototype,"eulerAngles",[sA],Object.getOwnPropertyDescriptor(lA.prototype,"eulerAngles"),lA.prototype),X(lA.prototype,"angle",[yl],Object.getOwnPropertyDescriptor(lA.prototype,"angle"),lA.prototype),X(lA.prototype,"layer",[yl],Object.getOwnPropertyDescriptor(lA.prototype,"layer"),lA.prototype),cA=lA))||cA));i.Node=qC;var XC=nl("cc.TargetInfo")((DA=X((wA=function(){q(this,"localID",DA,this)}).prototype,"localID",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IA=wA))||IA,YC=(OA=nl("cc.TargetOverrideInfo"),MA=Bl(Yt),NA=Bl(XC),BA=Bl(qC),FA=Bl(XC),OA((UA=X((zA=function(){q(this,"source",UA,this),q(this,"sourceInfo",GA,this),q(this,"propertyPath",kA,this),q(this,"target",HA,this),q(this,"targetInfo",VA,this)}).prototype,"source",[cl,MA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GA=X(zA.prototype,"sourceInfo",[cl,NA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kA=X(zA.prototype,"propertyPath",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HA=X(zA.prototype,"target",[cl,BA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VA=X(zA.prototype,"targetInfo",[cl,FA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LA=zA))||LA),KC=nl("cc.CompPrefabInfo")((qA=X((WA=function(){q(this,"fileId",qA,this)}).prototype,"fileId",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jA=WA))||jA,QC=(XA=nl("CCPropertyOverrideInfo"),YA=Bl(XC),XA((eC=function(){function e(){q(this,"targetInfo",ZA,this),q(this,"propertyPath",JA,this),q(this,"value",$A,this)}return e.prototype.isTarget=function(){},e}(),ZA=X((QA=eC).prototype,"targetInfo",[cl,YA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JA=X(QA.prototype,"propertyPath",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$A=X(QA.prototype,"value",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KA=QA))||KA),ZC=(tC=nl("cc.MountedChildrenInfo"),nC=Bl(XC),iC=Bl([qC]),tC((cC=function(){function e(){q(this,"targetInfo",oC,this),q(this,"nodes",sC,this)}return e.prototype.isTarget=function(){},e}(),oC=X((aC=cC).prototype,"targetInfo",[cl,nC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sC=X(aC.prototype,"nodes",[cl,iC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rC=aC))||rC),JC=(lC=nl("cc.MountedComponentsInfo"),uC=Bl(XC),hC=Bl([Ju]),lC((mC=function(){function e(){q(this,"targetInfo",pC,this),q(this,"components",dC,this)}return e.prototype.isTarget=function(){},e}(),pC=X((fC=mC).prototype,"targetInfo",[cl,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dC=X(fC.prototype,"components",[cl,hC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_C=fC))||_C),$C=(vC=nl("cc.PrefabInstance"),gC=Bl(qC),yC=Bl([ZC]),xC=Bl([JC]),SC=Bl([QC]),TC=Bl([XC]),vC((DC=function(){function e(){q(this,"fileId",CC,this),q(this,"prefabRootNode",bC,this),q(this,"mountedChildren",PC,this),q(this,"mountedComponents",RC,this),q(this,"propertyOverrides",IC,this),q(this,"removedComponents",wC,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),CC=X((AC=DC).prototype,"fileId",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bC=X(AC.prototype,"prefabRootNode",[cl,gC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PC=X(AC.prototype,"mountedChildren",[cl,yC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RC=X(AC.prototype,"mountedComponents",[cl,xC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IC=X(AC.prototype,"propertyOverrides",[cl,SC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wC=X(AC.prototype,"removedComponents",[cl,TC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EC=AC))||EC),eb=(OC=nl("cc.PrefabInfo"),MC=Bl(qC),NC=Bl($C),BC=Bl([YC]),OC((zC=X((LC=function(){q(this,"root",zC,this),q(this,"asset",UC,this),q(this,"fileId",GC,this),q(this,"instance",kC,this),q(this,"targetOverrides",HC,this),q(this,"nestedPrefabInstanceRoots",VC,this)}).prototype,"root",[cl,MC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UC=X(LC.prototype,"asset",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GC=X(LC.prototype,"fileId",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kC=X(LC.prototype,"instance",[cl,NC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),HC=X(LC.prototype,"targetOverrides",[cl,BC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),VC=X(LC.prototype,"nestedPrefabInstanceRoots",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FC=LC))||FC);function tb(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return b(3701,e.name),void(t.instance=void 0);var n=e._objFlags,r=e._parent,a=e._id,o=e._prefab;e[Wt],i.game._isCloning=!0,t.asset._doInstantiate(e),i.game._isCloning=!1,e._objFlags=n,e._parent=r,e._id=a,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function nb(e,t,n){var i;if(t&&e){var r=t,a=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&a&&(t[a.fileId]={},r=t[a.fileId]);var o=e._prefab;o&&(r[o.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)nb(e.children[u],r,!1)}}function ib(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function rb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=ib(r.targetInfo.localID,n);if(!a)continue;var o=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)o=o[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(a._children.push(u),u._parent=a,nb(u,o,!1),u._siblingIndex=a._children.length-1,lb(u,!0))}}}}function ab(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=ib(r.targetInfo.localID,n);if(!a)continue;if(r.components)for(var o=0;o<r.components.length;o++){var s=r.components[o];s&&(s.node=a,a._components.push(s))}}}}function ob(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var a=ib(r.localID,n);if(!a||!a.node)continue;var o=a.node.components.indexOf(a);o>=0&&a.node._components.splice(o,1)}}}function sb(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var a=t[r];if(a&&a.targetInfo){if(!(i=ib(a.targetInfo.localID,n)))continue;var o=i,s=a.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(o=o[s[l]]);l++);if(!o)continue;if(Array.isArray(o))if("length"===c)o[c]=a.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<o.length&&(o[c]=a.value)}else o[c]instanceof Je?o[c].set(a.value):o[c]=a.value}}}}function cb(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,a,o=n[i],s=o.source,c=o.sourceInfo;if(c){var l,u,h=null===(l=o.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=ib(c.localID,h.targetMap))}if(s){var _,f=o.targetInfo;if(f){var p=null===(r=o.target)||void 0===r||null===(a=r._prefab)||void 0===a?void 0:a.instance;if(p&&p.targetMap&&(_=ib(f.localID,p.targetMap))){var d=o.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}function lb(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){tb(e);var r={};i.targetMap=r,nb(e,r,!0),rb(0,i.mountedChildren,r),ob(0,i.removedComponents,r),ab(0,i.mountedComponents,r),sb(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){lb(e,!0)}))}function ub(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){lb(e)}))}i._PrefabInfo=eb;var hb,_b,fb,pb,db,mb,vb,gb,yb,xb,Sb,Tb,Eb,Ab,Cb=Object.freeze({__proto__:null,TargetInfo:XC,TargetOverrideInfo:YC,CompPrefabInfo:KC,PropertyOverrideInfo:QC,MountedChildrenInfo:ZC,MountedComponentsInfo:JC,PrefabInstance:$C,PrefabInfo:eb,createNodeWithPrefab:tb,generateTargetMap:nb,getTarget:ib,applyMountedChildren:rb,applyMountedComponents:ab,applyRemovedComponents:ob,applyPropertyOverrides:sb,applyTargetOverrides:cb,expandPrefabInstanceNode:lb,expandNestedPrefabInstanceNode:ub}),bb=Ye({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Pb=e("Prefab",nl("cc.Prefab")((vb=mb=function(e){function t(){var t;return q(t=e.call(this)||this,"data",fb,V(t)),q(t,"optimizationPolicy",pb,V(t)),q(t,"persistent",db,V(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}L(t,e);var n=t.prototype;return n.createNode=function(e){var t=i.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof i._BaseNode&&e,new HE(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||A(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==bb.SINGLE_INSTANCE&&(this.optimizationPolicy===bb.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new qC,this.data.name="(Missing Node)";var n=new i._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;ub(e),cb(e)},t}(Du),mb.OptimizationPolicy=bb,mb.OptimizationPolicyThreshold=3,fb=X((_b=vb).prototype,"data",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pb=X(_b.prototype,"optimizationPolicy",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bb.AUTO}}),db=X(_b.prototype,"persistent",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hb=_b))||hb);ke.value(Pb,"_utils",Cb),i.Prefab=Pb,pe(i,"cc._Prefab","Prefab"),e("PrefabLink",(gb=nl("cc.PrefabLink"),yb=Bl(Pb),xb=xl(),gb((Ab=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"prefab",Eb,V(t)),t}return L(t,e),t}(Ju),Eb=X((Tb=Ab).prototype,"prefab",[yb,cl,xb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sb=Tb))||Sb));var Rb=new di;function Ib(e,t,n,i){i||(i=new di),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function wb(e,t,n){return n||(n=new di),e.worldToScreen(t,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}var Db,Ob,Mb=e("convertUtils",{WorldNode3DToLocalNodeUI:Ib,WorldNode3DToWorldNodeUI:wb});i.pipelineUtils=Mb,Nn(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||Rb;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),Bn(Om.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Nn(vT.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Nb,Bb=e("BufferAsset",nl("cc.BufferAsset")((X((Ob=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}L(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},B(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Du)).prototype,"_nativeAsset",[Wl],Object.getOwnPropertyDescriptor(Ob.prototype,"_nativeAsset"),Ob.prototype),Db=Ob))||Db);i.BufferAsset=Bb;var Fb=((Nb={})[Tr.UNORM]="Uint",Nb[Tr.SNORM]="Int",Nb[Tr.UINT]="Uint",Nb[Tr.INT]="Int",Nb[Tr.UFLOAT]="Float",Nb[Tr.FLOAT]="Float",Nb.default="Uint",Nb);function Lb(e){return""+(Fb[e.type]||Fb.default)+e.size/e.count*8}function zb(e,t,n,i,r,a,o){void 0===n&&(n=Sr.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===a&&(a=0),o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=lo[n];a||(a=s.size);for(var c="set"+Lb(s),l="get"+Lb(s),u=s.size/s.count,h=Math.floor(r/a),_=ch.isLittleEndian,f=0;f<h;++f)for(var p=i+a*f,d=0;d<s.count;++d){var m=p+u*d,v=e[l](m,_);o[c](m,t(v,d,e),_)}return o}var Ub,Gb,kb=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new ka(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],a=e.struct.vertexBundles[r],o=n.indexView?n.indexView.count:a.view.count,s=a.view.stride,c=s*o,l=new Uint8Array(e.data.buffer,a.view.offset,a.view.length),u=new Uint8Array(n.indexView?c:a.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:o,buffer:u})}else u.set(e.data.subarray(a.view.offset,a.view.offset+a.view.length)),this._flatBuffers.push({stride:s,count:o,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Ua("a_vertexId",Sr.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},B(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:di.ZERO,max:di.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:di.ZERO,max:di.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,oa.ATTR_POSITION),i=e.readIndices(t),r=new di,a=new di,o=this.attributes.find((function(e){return e.name===oa.ATTR_POSITION}));if(o){var s=lo[o.format].count;2===s?(r.set(n[0],n[1],0),a.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),a.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y,a.z=n[c+2]<a.z?n[c+2]:a.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,a,o=this.mesh.struct,s=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===s.jointMapIndex||!o.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=i.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=o.vertexBundles[s.vertexBundelIndices[l]];a=0,r=Sr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===oa.ATTR_JOINTS){r=_.format;break}a+=lo[_.format].size}r?function(){var i=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(i.slice().buffer),_=o.jointMaps[s.jointMapIndex];zb(h,(function(e){return _.indexOf(e)}),r,a,u.view.length,u.view.stride,h);var f=c.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Ub||(Ub=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(Gb||(Gb={})),i.SystemEventType=Ub;var Hb,Vb=new Array(16),jb=null,Wb=new Ni,qb=[jE.TOUCH_START,jE.TOUCH_MOVE,jE.TOUCH_END,jE.TOUCH_CANCEL],Xb=[jE.MOUSE_DOWN,jE.MOUSE_ENTER,jE.MOUSE_MOVE,jE.MOUSE_LEAVE,jE.MOUSE_UP,jE.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(Hb||(Hb={}));var Yb,Kb,Qb,Zb,Jb,$b,eP,tP,nP,iP,rP,aP,oP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,xP,SP,TP,EP,AP,CP,bP,PP,RP,IP,wP,DP,OP,MP,NP,BP,FP,LP,zP,UP,GP,kP,HP,VP,jP,WP,qP,XP,YP,KP,QP,ZP,JP,$P,eR,tR,nR,iR,rR,aR,oR,sR,cR,lR,uR,hR,_R,fR,pR,dR,mR,vR,gR,yR,xR,SR,TR,ER,AR,CR,bR,PR,RR,IR,wR,DR,OR,MR,NR,BR,FR,LR,zR,UR,GR,kR,HR,VR,jR,WR,qR,XR,YR,KR,QR,ZR,JR,$R,eI,tI,nI,iI,rI,aI,oI,sI,cI,lI,uI,hI,_I,fI,pI,dI,mI,vI,gI,yI,xI,SI,TI,EI,AI,CI,bI,PI,RI,II,wI,DI,OI,MI,NI,BI,FI,LI,zI,UI,GI,kI,HI,VI,jI,WI,qI,XI,YI,KI,QI,ZI,JI,$I,ew,tw,nw,iw,rw,aw,ow,sw,cw,lw,uw,hw,_w,fw,pw,dw,mw,vw,gw,yw,xw,Sw,Tw,Ew,Aw,Cw,bw,Pw=function(){var e=t.prototype;function t(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}return e.setEnabled=function(e,n){if(void 0===n&&(n=!1),this._isEnabled!==e){this._isEnabled=e;var i=this.node.children;if(e&&this._attachMask(),t.callbacksInvoker.emit(Hb.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(e,!0)}},e._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&qC.isNode(r);r=r.parent,++n){var a=r.getComponent(e);if(a){var o={index:n,comp:a};i?i.push(o):i=[o]}}return i.length>0?i:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e.reattach=function(){var e,n=this;this.node.walk((function(i){e||(e=n._searchComponentsInParent(t._maskComp)),i.eventProcessor.maskList=e}))},e.destroy=function(){jb===this._node&&(jb=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(Hb.REMOVE_POINTER_EVENT_PROCESSOR,this)},e._isTouchEvent=function(e){return-1!==qb.indexOf(e)},e._isMouseEvent=function(e){return-1!==Xb.indexOf(e)},e._hasTouchListeners=function(){for(var e=0;e<qb.length;++e){var t=qb[e];if(this.hasEventListener(t))return!0}return!1},e._hasMouseListeners=function(){for(var e=0;e<Xb.length;++e){var t=Xb[e];if(this.hasEventListener(t))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var n=this._isTouchEvent(e),i=this._isMouseEvent(e);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||t.callbacksInvoker.emit(Hb.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,n=new rn;return n._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(Hb.REMOVE_POINTER_EVENT_PROCESSOR,e)})),n},e.on=function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},e.once=function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},e.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},e.targetOff=function(e){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(e),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(Hb.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(e,t,n,i,r,a){var o;null===(o=this.bubblingTarget)||void 0===o||o.emit(e,t,n,i,r,a)},e.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,Vb.length=0,this.getCapturingTargets(e.type,Vb),e.eventPhase=1,i=Vb.length-1;i>=0;--i)if((t=Vb[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,Vb),e.propagationStopped))return void(Vb.length=0);if(Vb.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,Vb),e.eventPhase=3,i=0;i<Vb.length;++i)if((t=Vb[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(Vb.length=0);Vb.length=0},e.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},e.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e._handleEventMouse=function(e){switch(e.type){case Gb.MOUSE_DOWN:return this._handleMouseDown(e);case Gb.MOUSE_MOVE:return this._handleMouseMove(e);case Gb.MOUSE_UP:return this._handleMouseUp(e);case Gb.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},e._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Wb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Wb)||(e.type=jE.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Wb=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Wb)?(this.previousMouseIn||(jb&&jb!==t&&(e.type=jE.MOUSE_LEAVE,jb.dispatchEvent(e),jb.eventProcessor.previousMouseIn=!1),jb=t,e.type=jE.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=jE.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=jE.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,jb=null),1)))},e._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Wb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Wb)||(e.type=jE.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Wb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Wb)||(e.type=jE.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleEventTouch=function(e){switch(e.type){case Gb.TOUCH_START:return this._handleTouchStart(e);case Gb.TOUCH_MOVE:return this._handleTouchMove(e);case Gb.TOUCH_END:return this._handleTouchEnd(e);case Gb.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},e._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(Wb),!t._uiProps.uiTransformComp.isHit(Wb)||(e.type=jE.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},e._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=jE.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},e._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(Wb),t._uiProps.uiTransformComp.isHit(Wb)?e.type=jE.TOUCH_END:e.type=jE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=jE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},B(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();Pw._maskComp=null,Pw.callbacksInvoker=new rn,i.NodeEventProcessor=Pw;var Rw=new di(0,1,0),Iw=new di,ww=new zi,Dw=new fi,Ow=new Ti,Mw=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},Nw=(Yb=nl("cc.AmbientInfo"),Kb=gl(),Qb=ll("_skyColor"),Zb=ll("_skyIllum"),Jb=ll("_groundAlbedo"),$b=xl(),eP=El(),tP=Bl(Tt),nP=El(),iP=xl(),rP=El(),Yb(aP=Kb((fP=function(){function e(){q(this,"_skyColorHDR",sP,this),q(this,"_skyIllumHDR",cP,this),q(this,"_groundAlbedoHDR",lP,this),q(this,"_skyColorLDR",uP,this),q(this,"_skyIllumLDR",hP,this),q(this,"_groundAlbedoLDR",_P,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},B(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=i.director.root.pipeline.pipelineSceneData.isHDR;return ww.set(e?this._skyColorHDR:this._skyColorLDR),Mw(ww),Dw.set(255*ww.x,255*ww.y,255*ww.z,255)},set:function(e){ww.set(e.x,e.y,e.z,e.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(ww):this._skyColorLDR.set(ww),this._resource&&this._resource.skyColor.set(ww)}},{key:"skyColor",set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=i.director.root.pipeline.pipelineSceneData.isHDR;return ww.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),Mw(ww),Dw.set(255*ww.x,255*ww.y,255*ww.z,255)},set:function(e){ww.set(e.x,e.y,e.z,e.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(ww):this._groundAlbedoLDR.set(ww),this._resource&&this._resource.groundAlbedo.set(ww)}},{key:"groundAlbedo",set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),sP=X((oP=fP).prototype,"_skyColorHDR",[cl,Qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(.2,.5,.8,1)}}),cP=X(oP.prototype,"_skyIllumHDR",[cl,Zb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yi.SKY_ILLUM}}),lP=X(oP.prototype,"_groundAlbedoHDR",[cl,Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(.2,.2,.2,1)}}),uP=X(oP.prototype,"_skyColorLDR",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(.2,.5,.8,1)}}),hP=X(oP.prototype,"_skyIllumLDR",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yi.SKY_ILLUM}}),_P=X(oP.prototype,"_groundAlbedoLDR",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(.2,.2,.2,1)}}),X(oP.prototype,"skyLightingColor",[$b,yl,eP],Object.getOwnPropertyDescriptor(oP.prototype,"skyLightingColor"),oP.prototype),X(oP.prototype,"skyIllum",[yl,tP,nP],Object.getOwnPropertyDescriptor(oP.prototype,"skyIllum"),oP.prototype),X(oP.prototype,"groundLightingColor",[iP,yl,rP],Object.getOwnPropertyDescriptor(oP.prototype,"groundLightingColor"),oP.prototype),aP=oP))||aP)||aP);i.AmbientInfo=Nw;var Bw=(pP=nl("cc.SkyboxInfo"),dP=gl(),mP=Bl(nv),vP=ll("_envmap"),gP=Bl(nv),yP=Bl(nv),xP=Bl(nv),SP=xl(),TP=El(),EP=Rl(),AP=El(),CP=El(),bP=El(),PP=Bl(nv),RP=El(),IP=xl(),wP=Bl(nv),DP=Rl(),pP(OP=dP((HP=function(){function e(){q(this,"_applyDiffuseMap",NP,this),q(this,"_envmapHDR",BP,this),q(this,"_envmapLDR",FP,this),q(this,"_diffuseMapHDR",LP,this),q(this,"_diffuseMapLDR",zP,this),q(this,"_enabled",UP,this),q(this,"_useIBL",GP,this),q(this,"_useHDR",kP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},B(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}(),NP=X((MP=HP).prototype,"_applyDiffuseMap",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BP=X(MP.prototype,"_envmapHDR",[cl,mP,vP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FP=X(MP.prototype,"_envmapLDR",[cl,gP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LP=X(MP.prototype,"_diffuseMapHDR",[cl,yP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zP=X(MP.prototype,"_diffuseMapLDR",[cl,xP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UP=X(MP.prototype,"_enabled",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GP=X(MP.prototype,"_useIBL",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kP=X(MP.prototype,"_useHDR",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(MP.prototype,"applyDiffuseMap",[SP,yl,TP,EP],Object.getOwnPropertyDescriptor(MP.prototype,"applyDiffuseMap"),MP.prototype),X(MP.prototype,"enabled",[yl,AP],Object.getOwnPropertyDescriptor(MP.prototype,"enabled"),MP.prototype),X(MP.prototype,"useIBL",[yl,CP],Object.getOwnPropertyDescriptor(MP.prototype,"useIBL"),MP.prototype),X(MP.prototype,"useHDR",[yl,bP],Object.getOwnPropertyDescriptor(MP.prototype,"useHDR"),MP.prototype),X(MP.prototype,"envmap",[yl,PP,RP],Object.getOwnPropertyDescriptor(MP.prototype,"envmap"),MP.prototype),X(MP.prototype,"diffuseMap",[IP,yl,Sl,wP,DP],Object.getOwnPropertyDescriptor(MP.prototype,"diffuseMap"),MP.prototype),OP=MP))||OP)||OP);i.SkyboxInfo=Bw;var Fw=(VP=nl("cc.FogInfo"),jP=gl(),WP=El(),qP=Rl(),XP=El(),YP=Rl(),KP=El(),QP=Bl(CE),ZP=Rl(),JP=El(),$P=xl(),eR=Bl(Tt),tR=Al(),nR=bl(),iR=El(),rR=xl(),aR=Bl(Tt),oR=bl(),sR=El(),cR=xl(),lR=Bl(Tt),uR=bl(),hR=El(),_R=xl(),fR=Bl(Tt),pR=Cl(),dR=bl(),mR=El(),vR=xl(),gR=Bl(Tt),yR=bl(),xR=El(),SR=xl(),TR=Bl(Tt),ER=bl(),AR=El(),VP(CR=jP((zR=LR=function(){function e(){q(this,"_type",PR,this),q(this,"_fogColor",RR,this),q(this,"_enabled",IR,this),q(this,"_fogDensity",wR,this),q(this,"_fogStart",DR,this),q(this,"_fogEnd",OR,this),q(this,"_fogAtten",MR,this),q(this,"_fogTop",NR,this),q(this,"_fogRange",BR,this),q(this,"_accurate",FR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),LR.FogType=CE,PR=X((bR=zR).prototype,"_type",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CE.LINEAR}}),RR=X(bR.prototype,"_fogColor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi("#C8C8C8")}}),IR=X(bR.prototype,"_enabled",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wR=X(bR.prototype,"_fogDensity",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),DR=X(bR.prototype,"_fogStart",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),OR=X(bR.prototype,"_fogEnd",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),MR=X(bR.prototype,"_fogAtten",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),NR=X(bR.prototype,"_fogTop",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),BR=X(bR.prototype,"_fogRange",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),FR=X(bR.prototype,"_accurate",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(bR.prototype,"enabled",[yl,WP,qP],Object.getOwnPropertyDescriptor(bR.prototype,"enabled"),bR.prototype),X(bR.prototype,"accurate",[yl,XP,YP],Object.getOwnPropertyDescriptor(bR.prototype,"accurate"),bR.prototype),X(bR.prototype,"fogColor",[yl,KP],Object.getOwnPropertyDescriptor(bR.prototype,"fogColor"),bR.prototype),X(bR.prototype,"type",[yl,QP,ZP,JP],Object.getOwnPropertyDescriptor(bR.prototype,"type"),bR.prototype),X(bR.prototype,"fogDensity",[$P,eR,tR,nR,Pl,iR],Object.getOwnPropertyDescriptor(bR.prototype,"fogDensity"),bR.prototype),X(bR.prototype,"fogStart",[rR,aR,oR,sR],Object.getOwnPropertyDescriptor(bR.prototype,"fogStart"),bR.prototype),X(bR.prototype,"fogEnd",[cR,lR,uR,hR],Object.getOwnPropertyDescriptor(bR.prototype,"fogEnd"),bR.prototype),X(bR.prototype,"fogAtten",[_R,fR,pR,dR,mR],Object.getOwnPropertyDescriptor(bR.prototype,"fogAtten"),bR.prototype),X(bR.prototype,"fogTop",[vR,gR,yR,xR],Object.getOwnPropertyDescriptor(bR.prototype,"fogTop"),bR.prototype),X(bR.prototype,"fogRange",[SR,TR,ER,AR],Object.getOwnPropertyDescriptor(bR.prototype,"fogRange"),bR.prototype),CR=bR))||CR)||CR),Lw=(UR=nl("cc.ShadowsInfo"),GR=gl(),kR=El(),HR=Bl(Pg),VR=xl(),jR=xl(),WR=El(),qR=Bl(Tt),XR=El(),YR=xl(),KR=Al(),QR=Bl(Tt),ZR=El(),JR=xl(),$R=Bl(Rg),eI=El(),tI=xl(),nI=Bl(St),iI=xl(),rI=Bl(Tt),aI=El(),oI=xl(),sI=Bl(Tt),cI=El(),lI=xl(),uI=Bl(bg),hI=El(),_I=xl(),fI=Bl(Et),pI=El(),dI=xl(),mI=Bl(Tt),vI=El(),gI=xl(),yI=Bl(Tt),xI=El(),SI=xl(),TI=Al(),EI=Bl(Tt),AI=El(),CI=xl(),bI=Al(),PI=Bl(Tt),RI=El(),II=xl(),wI=Bl(Tt),DI=El(),OI=xl(),UR(MI=GR(($I=function(){function e(){q(this,"_type",BI,this),q(this,"_enabled",FI,this),q(this,"_normal",LI,this),q(this,"_distance",zI,this),q(this,"_shadowColor",UI,this),q(this,"_firstSetCSM",GI,this),q(this,"_fixedArea",kI,this),q(this,"_pcf",HI,this),q(this,"_bias",VI,this),q(this,"_normalBias",jI,this),q(this,"_near",WI,this),q(this,"_far",qI,this),q(this,"_shadowDistance",XI,this),q(this,"_invisibleOcclusionRange",YI,this),q(this,"_orthoSize",KI,this),q(this,"_maxReceived",QI,this),q(this,"_size",ZI,this),q(this,"_saturation",JI,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(Ow),this.normal=di.transformQuat(Iw,Rw,Ow),e.getWorldPosition(Iw),this.distance=di.dot(this._normal,Iw)},t.activate=function(e){this.pcf=Math.min(this._pcf,Rg.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){di.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,wg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,wg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,wg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),BI=X((NI=$I).prototype,"_type",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pg.Planar}}),FI=X(NI.prototype,"_enabled",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LI=X(NI.prototype,"_normal",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,1,0)}}),zI=X(NI.prototype,"_distance",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UI=X(NI.prototype,"_shadowColor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(0,0,0,76)}}),GI=X(NI.prototype,"_firstSetCSM",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kI=X(NI.prototype,"_fixedArea",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HI=X(NI.prototype,"_pcf",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rg.HARD}}),VI=X(NI.prototype,"_bias",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),jI=X(NI.prototype,"_normalBias",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WI=X(NI.prototype,"_near",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),qI=X(NI.prototype,"_far",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),XI=X(NI.prototype,"_shadowDistance",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),YI=X(NI.prototype,"_invisibleOcclusionRange",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),KI=X(NI.prototype,"_orthoSize",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),QI=X(NI.prototype,"_maxReceived",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),ZI=X(NI.prototype,"_size",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(512,512)}}),JI=X(NI.prototype,"_saturation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),X(NI.prototype,"enabled",[yl,kR],Object.getOwnPropertyDescriptor(NI.prototype,"enabled"),NI.prototype),X(NI.prototype,"type",[yl,HR],Object.getOwnPropertyDescriptor(NI.prototype,"type"),NI.prototype),X(NI.prototype,"shadowColor",[VR],Object.getOwnPropertyDescriptor(NI.prototype,"shadowColor"),NI.prototype),X(NI.prototype,"normal",[jR,WR],Object.getOwnPropertyDescriptor(NI.prototype,"normal"),NI.prototype),X(NI.prototype,"distance",[qR,XR,YR],Object.getOwnPropertyDescriptor(NI.prototype,"distance"),NI.prototype),X(NI.prototype,"saturation",[yl,KR,Pl,QR,ZR,JR],Object.getOwnPropertyDescriptor(NI.prototype,"saturation"),NI.prototype),X(NI.prototype,"pcf",[$R,eI,tI],Object.getOwnPropertyDescriptor(NI.prototype,"pcf"),NI.prototype),X(NI.prototype,"maxReceived",[nI,iI],Object.getOwnPropertyDescriptor(NI.prototype,"maxReceived"),NI.prototype),X(NI.prototype,"bias",[rI,aI,oI],Object.getOwnPropertyDescriptor(NI.prototype,"bias"),NI.prototype),X(NI.prototype,"normalBias",[sI,cI,lI],Object.getOwnPropertyDescriptor(NI.prototype,"normalBias"),NI.prototype),X(NI.prototype,"shadowMapSize",[uI,hI,_I],Object.getOwnPropertyDescriptor(NI.prototype,"shadowMapSize"),NI.prototype),X(NI.prototype,"fixedArea",[fI,pI,dI],Object.getOwnPropertyDescriptor(NI.prototype,"fixedArea"),NI.prototype),X(NI.prototype,"near",[mI,vI,gI],Object.getOwnPropertyDescriptor(NI.prototype,"near"),NI.prototype),X(NI.prototype,"far",[yI,xI,SI],Object.getOwnPropertyDescriptor(NI.prototype,"far"),NI.prototype),X(NI.prototype,"invisibleOcclusionRange",[yl,TI,Pl,EI,AI,CI],Object.getOwnPropertyDescriptor(NI.prototype,"invisibleOcclusionRange"),NI.prototype),X(NI.prototype,"shadowDistance",[yl,bI,Pl,PI,RI,II],Object.getOwnPropertyDescriptor(NI.prototype,"shadowDistance"),NI.prototype),X(NI.prototype,"orthoSize",[wI,DI,OI],Object.getOwnPropertyDescriptor(NI.prototype,"orthoSize"),NI.prototype),MI=NI))||MI)||MI);i.ShadowsInfo=Lw;var zw=new di(-1024,-1024,-1024),Uw=new di(1024,1024,1024),Gw=(ew=nl("cc.OctreeInfo"),tw=gl(),nw=El(),iw=El(),rw=Tl(),aw=El(),ow=Tl(),sw=Al(),cw=Bl(St),lw=El(),ew(uw=tw((mw=function(){function e(){q(this,"_enabled",_w,this),q(this,"_minPos",fw,this),q(this,"_maxPos",pw,this),q(this,"_depth",dw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),_w=X((hw=mw).prototype,"_enabled",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fw=X(hw.prototype,"_minPos",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(zw)}}),pw=X(hw.prototype,"_maxPos",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(Uw)}}),dw=X(hw.prototype,"_depth",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),X(hw.prototype,"enabled",[yl,nw],Object.getOwnPropertyDescriptor(hw.prototype,"enabled"),hw.prototype),X(hw.prototype,"minPos",[yl,iw,rw],Object.getOwnPropertyDescriptor(hw.prototype,"minPos"),hw.prototype),X(hw.prototype,"maxPos",[yl,aw,ow],Object.getOwnPropertyDescriptor(hw.prototype,"maxPos"),hw.prototype),X(hw.prototype,"depth",[yl,sw,cw,lw],Object.getOwnPropertyDescriptor(hw.prototype,"depth"),hw.prototype),uw=hw))||uw)||uw),kw=(vw=nl("cc.SceneGlobals"),gw=Bl(Bw),vw((bw=function(){function e(){q(this,"ambient",Sw,this),q(this,"shadows",Tw,this),q(this,"_skybox",Ew,this),q(this,"fog",Aw,this),q(this,"octree",Cw,this)}return e.prototype.activate=function(){var e=i.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},B(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),Sw=X((xw=bw).prototype,"ambient",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nw}}),Tw=X(xw.prototype,"shadows",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lw}}),Ew=X(xw.prototype,"_skybox",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bw}}),Aw=X(xw.prototype,"fog",[yl,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fw}}),X(xw.prototype,"skybox",[yl,gw],Object.getOwnPropertyDescriptor(xw.prototype,"skybox"),xw.prototype),Cw=X(xw.prototype,"octree",[yl,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gw}}),yw=xw))||yw);i.SceneGlobals=kw;var Hw=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());Hw.NO_TYPE="no_type",Hw.TOUCH="touch",Hw.MOUSE="mouse",Hw.KEYBOARD="keyboard",Hw.ACCELERATION="acceleration",Hw.NONE=0,Hw.CAPTURING_PHASE=1,Hw.AT_TARGET=2,Hw.BUBBLING_PHASE=3,i.Event=Hw;var Vw=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,Ub.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return L(t,e),t}(Hw));Hw.EventAcceleration=Vw;var jw=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?Ub.KEY_DOWN:Ub.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==Ub.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return L(t,e),B(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(Hw));Hw.EventKeyboard=jw;var Ww=e("EventMouse",function(e){function t(n,i,r){var a;return(a=e.call(this,n,i)||this).movementX=0,a.movementY=0,a.preventSwallow=!1,a._eventType=void 0,a._button=t.BUTTON_MISSING,a._x=0,a._y=0,a._prevX=0,a._prevY=0,a._scrollX=0,a._scrollY=0,a._eventType=n,r&&(a._prevX=r.x,a._prevY=r.y),a}L(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Ni),Ni.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Ni),Ni.set(e,this._x,i.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Ni),Ni.set(e,this._x,this._y),i.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Ni),Ni.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Ni),Ni.set(e,this._prevX,this._prevY),i.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Ni),Ni.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Ni),Ni.set(e,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/i.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/i.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=i.view.getViewportRect();return(this._x-e.x)/i.view.getScaleX()},n.getUILocationY=function(){var e=i.view.getViewportRect();return(this._y-e.y)/i.view.getScaleY()},B(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(Hw));Ww.BUTTON_MISSING=-1,Ww.BUTTON_LEFT=0,Ww.BUTTON_RIGHT=2,Ww.BUTTON_MIDDLE=1,Ww.BUTTON_4=3,Ww.BUTTON_5=4,Ww.BUTTON_6=5,Ww.BUTTON_7=6,Ww.BUTTON_8=7,Hw.EventMouse=Ww;var qw=new Ni,Xw=e("EventTouch",function(e){function t(t,n,i,r){var a;return void 0===r&&(r=[]),(a=e.call(this,i,n)||this).touch=null,a.simulate=!1,a.preventSwallow=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=i,a._touches=t||[],a._allTouches=r,a}L(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Ni},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Ni},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Ni},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Ni},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Ni},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Ni},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Ni},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Ni},n.getDeltaX=function(){return this.touch?this.touch.getDelta(qw).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(qw).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(Hw));Xw.MAX_TOUCHES=5,Hw.EventTouch=Xw;var Yw,Kw=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(Yw||(Yw=e("KeyCode",{})));var Qw=new Ni,Zw=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Ni,this._prevPoint=new Ni,this._lastModified=0,this._id=0,this._startPoint=new Ni,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Ni),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Ni),e.set(this._point.x,this._point.y),i.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=i.view.getViewportRect();return(this._point.x-e.x)/i.view.getScaleX()},t.getUILocationY=function(){var e=i.view.getViewportRect();return(this._point.y-e.y)/i.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Ni),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Ni),e.set(this._prevPoint.x,this._prevPoint.y),i.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Ni),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Ni),e.set(this._startPoint.x,this._startPoint.y),i.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Ni),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Ni),Qw.set(this._point),Qw.subtract(this._prevPoint),e.set(i.view.getScaleX(),i.view.getScaleY()),Ni.divide(e,Qw,e),e},t.getLocationInView=function(e){return e||(e=new Ni),e.set(this._point.x,i.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Ni),e.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Ni),e.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Ni(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Ni(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=i.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Ni(e.x,e.y):new Ni(e||0,t||0),this._lastModified=i.game.frameStartTime},B(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());i.Touch=Zw;var Jw,$w,eD=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new _n,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,fn.browserType===on.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;n=.1*((null==a?void 0:a.x)||0),i=.1*((null==a?void 0:a.y)||0),r=.1*((null==a?void 0:a.z)||0)}else{var o=e;n=(o.gamma||0)/90*.981,i=-(o.beta||0)/90*.981,r=(o.alpha||0)/90*.981}if(ah.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),fn.os===ln.ANDROID&&fn.browserType!==on.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new Kw(n,i,r,l),h=new Vw(u);this._eventTarget.emit(Gb.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),tD={Backspace:Yw.BACKSPACE,Tab:Yw.TAB,Enter:Yw.ENTER,ShiftLeft:Yw.SHIFT_LEFT,ControlLeft:Yw.CTRL_LEFT,AltLeft:Yw.ALT_LEFT,ShiftRight:Yw.SHIFT_RIGHT,ControlRight:Yw.CTRL_RIGHT,AltRight:Yw.ALT_RIGHT,Pause:Yw.PAUSE,CapsLock:Yw.CAPS_LOCK,Escape:Yw.ESCAPE,Space:Yw.SPACE,PageUp:Yw.PAGE_UP,PageDown:Yw.PAGE_DOWN,End:Yw.END,Home:Yw.HOME,ArrowLeft:Yw.ARROW_LEFT,ArrowUp:Yw.ARROW_UP,ArrowRight:Yw.ARROW_RIGHT,ArrowDown:Yw.ARROW_DOWN,Insert:Yw.INSERT,Delete:Yw.DELETE,Digit0:Yw.DIGIT_0,Digit1:Yw.DIGIT_1,Digit2:Yw.DIGIT_2,Digit3:Yw.DIGIT_3,Digit4:Yw.DIGIT_4,Digit5:Yw.DIGIT_5,Digit6:Yw.DIGIT_6,Digit7:Yw.DIGIT_7,Digit8:Yw.DIGIT_8,Digit9:Yw.DIGIT_9,KeyA:Yw.KEY_A,KeyB:Yw.KEY_B,KeyC:Yw.KEY_C,KeyD:Yw.KEY_D,KeyE:Yw.KEY_E,KeyF:Yw.KEY_F,KeyG:Yw.KEY_G,KeyH:Yw.KEY_H,KeyI:Yw.KEY_I,KeyJ:Yw.KEY_J,KeyK:Yw.KEY_K,KeyL:Yw.KEY_L,KeyM:Yw.KEY_M,KeyN:Yw.KEY_N,KeyO:Yw.KEY_O,KeyP:Yw.KEY_P,KeyQ:Yw.KEY_Q,KeyR:Yw.KEY_R,KeyS:Yw.KEY_S,KeyT:Yw.KEY_T,KeyU:Yw.KEY_U,KeyV:Yw.KEY_V,KeyW:Yw.KEY_W,KeyX:Yw.KEY_X,KeyY:Yw.KEY_Y,KeyZ:Yw.KEY_Z,Numpad0:Yw.NUM_0,Numpad1:Yw.NUM_1,Numpad2:Yw.NUM_2,Numpad3:Yw.NUM_3,Numpad4:Yw.NUM_4,Numpad5:Yw.NUM_5,Numpad6:Yw.NUM_6,Numpad7:Yw.NUM_7,Numpad8:Yw.NUM_8,Numpad9:Yw.NUM_9,NumpadMultiply:Yw.NUM_MULTIPLY,NumpadAdd:Yw.NUM_PLUS,NumpadSubtract:Yw.NUM_SUBTRACT,NumpadDecimal:Yw.NUM_DECIMAL,NumpadDivide:Yw.NUM_DIVIDE,NumpadEnter:Yw.NUM_ENTER,F1:Yw.F1,F2:Yw.F2,F3:Yw.F3,F4:Yw.F4,F5:Yw.F5,F6:Yw.F6,F7:Yw.F7,F8:Yw.F8,F9:Yw.F9,F10:Yw.F10,F11:Yw.F11,F12:Yw.F12,NumLock:Yw.NUM_LOCK,ScrollLock:Yw.SCROLL_LOCK,Semicolon:Yw.SEMICOLON,Equal:Yw.EQUAL,Comma:Yw.COMMA,Minus:Yw.DASH,Period:Yw.PERIOD,Slash:Yw.SLASH,Backquote:Yw.BACK_QUOTE,BracketLeft:Yw.BRACKET_LEFT,Backslash:Yw.BACKSLASH,BracketRight:Yw.BRACKET_RIGHT,Quote:Yw.QUOTE},nD=function(){function e(){this._eventTarget=new _n,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,Gb.KEY_PRESSING);e._eventTarget.emit(Gb.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,Gb.KEY_DOWN);e._eventTarget.emit(Gb.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,Gb.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(Gb.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,tD[n]||Yw.NONE);return new jw(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),iD=function(){function e(){this._canvas=void 0,this._eventTarget=new _n,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Ni,fn.hasFeature(hn.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Vi(t.x,t.y,t.width,t.height):new Vi(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=ah.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Ni(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(Gb.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(Gb.MOUSE_MOVE));var a=this._createCallback(Gb.MOUSE_UP);window.addEventListener("mouseup",a),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",a),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),a=n.button;switch(e){case Gb.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case Gb.MOUSE_UP:t._isPressed=!1;break;case Gb.MOUSE_MOVE:t._isPressed||(a=Ww.BUTTON_MISSING)}var o=new Ww(e,!1,t._preMousePos);o.setLocation(r.x,r.y),o.setButton(a),o.movementX=n.movementX,o.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,o)}},t._handleMouseWheel=function(e){var t=Gb.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new Ww(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),rD=new Ni,aD=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(rD);var n=new Zw(rD.x,rD.y,t);return e.getLocation(rD),n.setPoint(rD.x,rD.y),e.getPreviousLocation(rD),n.setPrevPoint(rD),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new Zw(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(rD),e.setPrevPoint(rD),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=$e.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>$e.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),oD=function(){function e(){this._canvas=void 0,this._eventTarget=new _n,fn.hasFeature(hn.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(Gb.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(Gb.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(Gb.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(Gb.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),a=[],o=n.changedTouches.length,s=0;s<o;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=aD.getTouch(l,u.x,u.y);h&&(e!==Gb.TOUCH_END&&e!==Gb.TOUCH_CANCEL||aD.releaseTouch(l),a.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===Gb.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),a.length>0){var _=new Xw(a,!1,e,$e.ENABLE_MULTI_TOUCH?aD.getAllTouches():a);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Vi(t.x,t.y,t.width,t.height):new Vi(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(ah.isFrameRotated){var r=n;n=t.height-i,i=r}var a=ah.devicePixelRatio;return new Ni(n*=a,i*=a)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}($w||($w={}));var sD=function(){function e(e){this.priority=$w.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),cD=((Jw={})[Gb.MOUSE_DOWN]=Gb.TOUCH_START,Jw[Gb.MOUSE_MOVE]=Gb.TOUCH_MOVE,Jw[Gb.MOUSE_UP]=Gb.TOUCH_END,Jw),lD=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new _n,this._touchInput=new oD,this._mouseInput=new iD,this._keyboardInput=new nD,this._accelerometerInput=new eD,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new sD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=cD[e.type],n=aD.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new Xw(i,!1,t,i);t===Gb.TOUCH_END&&aD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(ch.hasFeature(ch.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(Gb.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Gb.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Gb.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Gb.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(ch.hasFeature(ch.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(Gb.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Gb.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Gb.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Gb.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(ch.hasFeature(ch.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(Gb.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(Gb.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(Gb.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(ch.hasFeature(ch.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(Gb.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,a=0,o=r.length;a<o;++a)for(var s=r[a],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var p=h[_];this._emitEvent(p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},e}());lD.EventType=Gb;var uD=e("input",new lD),hD=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,uD.on(Gb.MOUSE_DOWN,(function(e){t.emit(Ub.MOUSE_DOWN,e)})),uD.on(Gb.MOUSE_MOVE,(function(e){t.emit(Ub.MOUSE_MOVE,e)})),uD.on(Gb.MOUSE_UP,(function(e){t.emit(Ub.MOUSE_UP,e)})),uD.on(Gb.MOUSE_WHEEL,(function(e){t.emit(Ub.MOUSE_WHEEL,e)})),uD.on(Gb.TOUCH_START,(function(e){t.emit(Ub.TOUCH_START,e.touch,e)})),uD.on(Gb.TOUCH_MOVE,(function(e){t.emit(Ub.TOUCH_MOVE,e.touch,e)})),uD.on(Gb.TOUCH_END,(function(e){t.emit(Ub.TOUCH_END,e.touch,e)})),uD.on(Gb.TOUCH_CANCEL,(function(e){t.emit(Ub.TOUCH_CANCEL,e.touch,e)})),uD.on(Gb.KEY_DOWN,(function(e){t.emit(Ub.KEY_DOWN,e)})),uD.on(Gb.KEY_PRESSING,(function(e){t.emit(Ub.KEY_DOWN,e)})),uD.on(Gb.KEY_UP,(function(e){t.emit(Ub.KEY_UP,e)})),uD.on(Gb.DEVICEMOTION,(function(e){t.emit(Ub.DEVICEMOTION,e)})),t}L(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){uD.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){uD.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(_n));hD.EventType=Ub,i.SystemEvent=hD;var _D,fD=e("systemEvent",new hD);i.systemEvent=fD,Nn(Ub,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),Nn(Hw,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Fn(Hw,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),Nn(Ww,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:hD.EventType,targetName:"SystemEvent.EventType"}}))),Nn(Ww,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Fn(Ww.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),Nn(Xw,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Nn(Xw,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Nn(Xw,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Nn(Xw,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:hD.EventType,targetName:"SystemEvent.EventType"}]),Fn(Xw.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),Nn(Xw.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:Xw,targetName:"EventTouch"}]),Fn($e.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),Fn($e.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),Fn($e.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),Fn($e.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),Fn($e,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),Nn(vA.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),Nn(qC.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Ni),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ki),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),Bn(kw.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),Bn(qC.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Nn(eA.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),Bn(Mp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Nn(Mp,"Layers",[{name:"Default",newName:"DEFAULT",target:Mp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Mp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Mp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Mp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Mp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Mp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Mp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Mp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Mp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Mp,targetName:"Layers"}]),Bn(Mp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Bn(Mp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var pD,dD,mD,vD,gD=Yt.Flags.HideInHierarchy,yD=Yt.Flags.DontSave,xD=e("PrivateNode",nl("cc.PrivateNode")(_D=function(e){function t(t){var n;return A(12003,(n=e.call(this,t)||this).name),n.hideFlags|=yD|gD,n}return L(t,e),t}(qC))||_D);Nn(Ub,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:qC.EventType,targetName:"Node.EventType"}}))),Nn(qC.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:hD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:hD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:hD.EventType,targetName:"SystemEvent.EventType"}]),i.PrivateNode=xD;var SD=e("Scene",nl("cc.Scene")((X((dD=function(e){L(n,e);var t=n.prototype;function n(t){var n;return q(n=e.call(this,t)||this,"autoReleaseAssets",mD,V(n)),q(n,"_globals",vD,V(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=di.ZERO,n._rot=Ti.IDENTITY,n._scale=di.ONE,n._mat=wi.IDENTITY,n._dirtyFlags=0,n._lpos=di.ZERO,n._lrot=Ti.IDENTITY,n._lscale=di.ONE,n._activeInHierarchy=!1,i.director&&i.director.root&&(n._renderScene=i.director.root.createScene({})),n._inited=!i.game||!i.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=Yt.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(w(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return di.copy(e||new di,di.ZERO)},t.getRotation=function(e){return Ti.copy(e||new Ti,Ti.IDENTITY)},t.getScale=function(e){return di.copy(e||new di,di.ONE)},t.getWorldPosition=function(e){return di.copy(e||new di,di.ZERO)},t.getWorldRotation=function(e){return Ti.copy(e||new Ti,Ti.IDENTITY)},t.getWorldScale=function(e){return di.copy(e||new di,di.ONE)},t.getWorldMatrix=function(e){return wi.copy(e||new wi,wi.IDENTITY)},t.getWorldRS=function(e){return wi.copy(e||new wi,wi.IDENTITY)},t.getWorldRT=function(e){return wi.copy(e||new wi,wi.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(ub(this),cb(this),this._onBatchCreated(false),this._inited=!0),this.walk(vA._setScene)},t._activate=function(e){e=!1!==e,i.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},B(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return di.ZERO}},{key:"worldPosition",get:function(){return di.ZERO}},{key:"rotation",get:function(){return Ti.IDENTITY}},{key:"worldRotation",get:function(){return Ti.IDENTITY}},{key:"scale",get:function(){return di.ONE}},{key:"worldScale",get:function(){return di.ONE}},{key:"eulerAngles",get:function(){return di.ZERO}},{key:"worldMatrix",get:function(){return wi.IDENTITY}}]),n}(vA)).prototype,"globals",[yl],Object.getOwnPropertyDescriptor(dD.prototype,"globals"),dD.prototype),mD=X(dD.prototype,"autoReleaseAssets",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vD=X(dD.prototype,"_globals",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kw}}),pD=dD))||pD);function TD(e,t){if(!t){var n=i.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}i.Scene=SD,i.find=TD;var ED=Ge.fastRemoveAt,AD=Yt.Flags.IsStartCalled,CD=Yt.Flags.IsOnEnableCalled;function bD(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,a=e.length-1,o=a>>>1;r<=a;o=r+a>>>1){var s=e[o],c=s.constructor._executionOrder;if(c>n)a=o-1;else if(c<n)r=o+1;else{var l=s._id;if(l>i)a=o-1;else{if(!(l<i))return o;r=o+1}}}return~r}function PD(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Yt.Flags.IsEditorOnEnableCalled;var RD=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=Y;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function ID(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}RD.stableRemoveInactive=PD;var wD=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){PD(this._zero,e),PD(this._neg,e),PD(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(ID),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(ID),this._invoke(t),t.array.length=0)},t}(RD),DD=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=bD(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=bD(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(RD);function OD(e,t,n){var r="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",a=t?Function("it","dt",r):Function("it",r);return function(e,t,n){return function(r,a){try{t(r,a)}catch(t){i._throw(t);var o=r.array;for(n&&(o[r.i]._objFlags|=n),++r.i;r.i<o.length;++r.i)try{e(o[r.i],a)}catch(e){i._throw(e),n&&(o[r.i]._objFlags|=n)}}}}(Function("c","dt",e),a,n)}var MD=OD("c.start();c._objFlags|="+AD,!1,AD),ND=OD("c.update(dt)",!0),BD=OD("c.lateUpdate(dt)",!0),FD=function(e){var t=i.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var r=n[e.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||t._onEnabled(r))}},LD=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new wD(MD),this.updateInvoker=new DD(ND),this.lateUpdateInvoker=new DD(BD),this._updating=!1},t._onEnabled=function(e){i.director.getScheduler().resumeTarget(e),e._objFlags|=CD,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){i.director.getScheduler().pauseTarget(e),e._objFlags&=~CD;var t=this._deferredComps.indexOf(e);t>=0?ED(this._deferredComps,t):(!e.start||e._objFlags&AD||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&CD)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&CD&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&AD||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),zD=Yt.Flags.IsPreloadStarted,UD=Yt.Flags.IsOnLoadStarted,GD=Yt.Flags.IsOnLoadCalled,kD=Yt.Flags.Deactivating,HD=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){RD.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(RD),VD=OD("c.__preload();"),jD=OD("c.onLoad();c._objFlags|="+GD,!1,GD),WD=new Ue(4);function qD(e,t,n){b(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):Ge.removeAt(e._components,n)}WD.get=function(){var e=this._get()||{preload:new HD(VD),onLoad:new wD(jD),onEnable:new wD(FD)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var XD,YD,KD,QD,ZD,JD,$D,eO,tO=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=WD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),WD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=W(this._activatingStack);!(i=r()).done;){var a=i.value;a.preload.cancelInactive(zD),a.onLoad.cancelInactive(UD),a.onEnable.cancelInactive()}}e.emit(jE.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,r){if(Qt(e,!0)&&(e._objFlags&zD||(e._objFlags|=zD,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&UD||(e._objFlags|=UD,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=GD):e._objFlags|=GD),e._enabled)){if(!e.node._activeInHierarchy)return;i.director._compScheduler.enableComp(e,r)}},t.destroyComp=function(e){i.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&GD&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,r){if(e._objFlags&kD)b(3816,e.name);else{e._activeInHierarchy=!0;for(var a=e._components.length,o=0;o<a;++o){var s=e._components[o];s instanceof i.Component?this.activateComp(s,t,n,r):(qD(e,s,o),--o,--a)}for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,r)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=kD,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var r=e._components[n];if(r._enabled&&(i.director._compScheduler.disableComp(r),e._activeInHierarchy))return void(e._objFlags&=~kD)}for(var a=0,o=e._children.length;a<o;++a){var s=e._children[a];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~kD)}e._onPostActivated(!1),e._objFlags&=~kD},e}()),nO=e("SceneAsset",nl("cc.SceneAsset")((QD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"scene",KD,V(t)),t}L(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new SD("New Scene")},n.validate=function(){return!!this.scene},t}(Du),KD=X((YD=QD).prototype,"scene",[yl,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XD=YD))||XD);i.SceneAsset=nO;var iO,rO,aO,oO,sO=e("TextAsset",nl("cc.TextAsset")((eO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"text",$D,V(t)),t}return L(t,e),t.prototype.toString=function(){return this.text},t}(Du),$D=X((JD=eO).prototype,"text",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZD=JD))||ZD);i.TextAsset=sO;var cO=e("JsonAsset",nl("cc.JsonAsset")((oO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"json",aO,V(t)),t}return L(t,e),t}(Du),aO=X((rO=oO).prototype,"json",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iO=rO))||iO);i.JsonAsset=cO;var lO,uO,hO,_O,fO,pO,dO,mO,vO,gO,yO,xO,SO,TO,EO,AO,CO,bO,PO,RO,IO,wO,DO,OO,MO,NO,BO,FO,LO,zO,UO,GO,kO,HO,VO,jO,WO,qO,XO=function(){var e=t.prototype;function t(){this.fog=new PE,this.ambient=new Yi,this.skybox=new jg,this.shadows=new wg,this.octree=new Ki,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Cg;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),a=Uint16Array.BYTES_PER_ELEMENT,o=36*a;this._occlusionQueryIndicesBuffer=e.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,o,a)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Ua("a_position",Sr.RGB32F)],c=new ka(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},B(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(yx.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),YO=e("ForwardPipeline",(lO=nl("ForwardPipeline"),uO=Bl([yT]),hO=Rl(),lO((dO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",pO,V(t)),t._postRenderPass=null,t}L(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new EE;n.initialize(EE.initInfo),this._flows.push(n);var i=new aE;i.initialize(aE.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new XO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(b(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Jp,t),this._descriptorSet.bindTexture(Jp,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(sd,t),this._descriptorSet.bindTexture(sd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Kp.BINDING).destroy(),this._descriptorSet.getBuffer(Zp.BINDING).destroy(),this._descriptorSet.getBuffer(Qp.BINDING).destroy(),this._descriptorSet.getTexture(Jp).destroy(),this._descriptorSet.getTexture(sd).destroy())},B(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(kx),pO=X((fO=dO).prototype,"renderTextures",[uO,cl,hO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_O=fO))||_O)),KO=[new ga(0,0,0,0),new ga(0,0,0,0),new ga(0,0,0,0)],QO=e("GbufferStage",(mO=nl("GbufferStage"),vO=Bl([TT]),gO=Rl(),mO((EO=TO=function(e){function t(){var t;return q(t=e.call(this)||this,"renderQueues",SO,V(t)),t._renderQueues=[],t._renderArea=new ua,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Bv("default"),t._batchedQueue=new IT,t._instancedQueue=new wT,t}L(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=bT(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(PT),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Dv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(f===Dv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,a,c.model),this._batchedQueue.queue.add(d)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(RT);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&na.COLOR&&(t.pipelineSceneData.isHDR?hg(KO[0],e.clearColor):(KO[0].x=e.clearColor.x,KO[0].y=e.clearColor.y,KO[0].z=e.clearColor.z)),KO[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,KO,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(gx),TO.initInfo={name:"GbufferStage",priority:Mx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:gT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gT.BACK_TO_FRONT,stages:["default"]}]},SO=X((xO=EO).prototype,"renderQueues",[vO,cl,gO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yO=xO))||yO)),ZO=[new ga(0,0,0,1)],JO=e("LightingStage",(AO=nl("LightingStage"),CO=Bl(Cg),bO=Rl(),PO=Bl([TT]),RO=Rl(),AO((NO=MO=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=dd.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new ua,t._uiPhase=void 0,q(t,"_deferredMaterial",DO,V(t)),q(t,"renderQueues",OO,V(t)),t._phaseID=Bv("default"),t._renderQueues=[],t._uiPhase=new nE,t}L(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,a=ia.create(0,0,0,1),o=new Float32Array(4),s=e.exposure,c=0,l=zi.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(ia.set(a,_.position.x,_.position.y,_.position.z,_.range),$s.sphereFrustum(a,e.frustum)){if(di.toArray(o,_.position),o[3]=0,this._lightBufferData.set(o,c*l),di.toArray(o,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;o[0]*=f.x,o[1]*=f.y,o[2]*=f.z}t.pipelineSceneData.isHDR?o[3]=_.luminance*s*this._lightMeterScale:o[3]=_.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=_.size,o[1]=_.range,o[2]=0,this._lightBufferData.set(o,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(ia.set(a,d.position.x,d.position.y,d.position.z,d.range),$s.sphereFrustum(a,e.frustum)){if(di.toArray(o,d.position),o[3]=1,this._lightBufferData.set(o,c*l+0*u),di.toArray(o,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;o[0]*=m.x,o[1]*=m.y,o[2]*=m.z}t.pipelineSceneData.isHDR?o[3]=d.luminance*s*this._lightMeterScale:o[3]=d.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=d.size,o[1]=d.range,o[2]=d.spotAngle,this._lightBufferData.set(o,c*l+2*u),di.toArray(o,d.direction),this._lightBufferData.set(o,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=bT(this.renderQueues[r]);var a=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;a=Math.ceil(a/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,a,i.capabilities.uboOffsetAlignment));var o=i.createBuffer(new Ea(this._deferredLitsBufs,0,a));this._lightBufferData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT);var s=new Za(kp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Ja(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(pd.BINDING,o),this._planarQueue=new tE(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,a=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(Wp.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&na.COLOR&&(ZO[0].x=e.clearColor.x,ZO[0].y=e.clearColor.y,ZO[0].z=e.clearColor.z),ZO[0].w=0;var o=t.getPipelineRenderData(),s=o.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,ZO,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,o.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,o.sampler);l.descriptorSet.bindTexture(3,o.outputDepth),l.descriptorSet.bindSampler(3,o.sampler),l.descriptorSet.update(),i.bindDescriptorSet(Wp.MATERIAL,l.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=cg.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(PT);for(var p=0,d=0,m=0,v=0;v<a.length;++v){var g=a[v],y=g.model.subModels;for(p=0;p<y.length;++p){var x=y[p].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(a.length>0){this._renderQueues.forEach(RT);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()},t}(gx),MO.initInfo={name:"LightingStage",priority:Mx.LIGHTING,tag:0},DO=X((wO=NO).prototype,"_deferredMaterial",[CO,cl,bO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OO=X(wO.prototype,"renderQueues",[PO,cl,RO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IO=wO))||IO)),$O=[new ga(0,0,0,1)],eM=e("PostProcessStage",(BO=nl("PostProcessStage"),FO=Bl(Cg),LO=Rl(),zO=Bl([TT]),UO=Rl(),BO((WO=jO=function(e){function t(){var t;return q(t=e.call(this)||this,"_postProcessMaterial",HO,V(t)),q(t,"renderQueues",VO,V(t)),t._renderArea=new ua,t._uiPhase=new nE,t}L(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.window.width,this._renderArea.y=a.y*e.window.height,this._renderArea.width=a.width*e.window.width,this._renderArea.height=a.height*e.window.height;var o=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&na.COLOR&&($O[0].x=e.clearColor.x,$O[0].y=e.clearColor.y,$O[0].z=e.clearColor.z),$O[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,$O,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,o.bloom.combineTex):l.descriptorSet.bindTexture(0,o.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,o.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Wp.MATERIAL,l.descriptorSet);var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=cg.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),Eg(n,c,r,t.profiler,e),r.endRenderPass()},t}(gx),jO.initInfo={name:"PostProcessStage",priority:wx.POST_PROCESS,tag:0},HO=X((kO=WO).prototype,"_postProcessMaterial",[FO,cl,LO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VO=X(kO.prototype,"renderQueues",[zO,cl,UO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GO=kO))||GO));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(qO||(qO={}));var tM,nM,iM,rM,aM,oM,sM,cM,lM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=qO.NONE,t}L(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var a=this._bloomMaterial.passes[7+i];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently(),t.push(r.native),n.push(a.native)}var o=this._bloomMaterial.passes[13];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Cg;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Cg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Cg;r._uuid="builtin-post-process-material",$e.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=qO.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<r.passes.length;++a)r.passes[a].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},B(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Cg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(XO),uM=[new ga(0,0,0,1)],hM=function(){};hM.SIZE=4*(hM.COUNT=4+(hM.TEXTURE_SIZE_OFFSET=0));var _M,fM,pM,dM,mM,vM,gM,yM,xM,SM,TM=e("BloomStage",(tM=nl("BloomStage"),nM=Bl(Cg),iM=Rl(),tM((cM=sM=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,q(t,"_bloomMaterial",oM,V(t)),t._renderArea=new ua,t._bloomUBO=[],t}L(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,hM.SIZE,hM.SIZE));e.clearFlag&na.COLOR&&(uM[0].x=e.clearColor.x,uM[0].y=e.clearColor.y,uM[0].z=e.clearColor.z),uM[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(hM.COUNT);o[hM.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],o),n.beginRenderPass(a.renderPass,a.prefilterFramebuffer,this._renderArea,uM,0,0),n.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,a.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Wp.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=cg.getOrCreatePipelineState(t.device,i,l,a.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,a=new Float32Array(hM.COUNT),o=0;o<this.iterations;++o){a[hM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[hM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[o+1],a),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[o],this._renderArea,uM,0,0);var s=i.passes[1+o],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[o+1]),0===o?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[o-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Wp.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=cg.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,a=new Float32Array(hM.COUNT),o=0;o<this.iterations;++o){var s=o+6+1;a[hM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[hM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],a),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-o],this._renderArea,uM,0,0);var c=r.passes[7+o],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===o?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-o]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Wp.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=cg.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(hM.COUNT);o[hM.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],o),n.beginRenderPass(a.renderPass,a.combineFramebuffer,this._renderArea,uM,0,0),n.bindDescriptorSet(Wp.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,a.upsampleTexs[0]),s.descriptorSet.bindSampler(1,a.sampler),s.descriptorSet.bindSampler(2,a.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Wp.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=cg.getOrCreatePipelineState(t.device,s,u,a.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(gx),sM.initInfo={name:"BloomStage",priority:wx.BLOOM,tag:0},oM=X((aM=cM).prototype,"_bloomMaterial",[nM,cl,iM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rM=aM))||rM)),EM=e("MainFlow",nl("MainFlow")((pM=fM=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new QO;n.initialize(QO.initInfo),this._stages.push(n);var i=new JO;i.initialize(JO.initInfo),this._stages.push(i);var r=new TM;r.initialize(TM.initInfo),this._stages.push(r);var a=new eM;a.initialize(eM.initInfo),this._stages.push(a)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(xx),fM.initInfo={name:Fp,priority:Nx.MAIN,stages:[]},_M=pM))||_M),AM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return L(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),CM=e("DeferredPipeline",(dM=nl("DeferredPipeline"),mM=Bl([yT]),vM=Rl(),dM((SM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,q(t,"renderTextures",xM,V(t)),t}L(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new EE;n.initialize(EE.initInfo),this._flows.push(n);var i=new EM;i.initialize(EM.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new lM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(b(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Jp,n),this._descriptorSet.bindTexture(Jp,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(sd,n),this._descriptorSet.bindTexture(sd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Gx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var a=new Ha;a.format=Sr.RGBA16F,a.loadOp=kr.CLEAR,a.storeOp=Hr.STORE;var o=new Ha;o.format=Sr.RGBA16F,o.loadOp=kr.CLEAR,o.storeOp=Hr.STORE;var s=new Ha;s.format=Sr.RGBA16F,s.loadOp=kr.CLEAR,s.storeOp=Hr.STORE;var c=new Va;c.format=Sr.DEPTH_STENCIL,c.depthLoadOp=kr.CLEAR,c.depthStoreOp=Hr.STORE,c.stencilLoadOp=kr.CLEAR,c.stencilStoreOp=Hr.STORE;var l=new qa([a,o,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Ha;u.format=Sr.RGBA8,u.loadOp=kr.CLEAR,u.storeOp=Hr.STORE,u.endAccesses=[Vr.COLOR_ATTACHMENT_WRITE];var h=new Va;h.format=Sr.DEPTH_STENCIL,h.depthLoadOp=kr.LOAD,h.depthStoreOp=Hr.DISCARD,h.stencilLoadOp=kr.LOAD,h.stencilStoreOp=Hr.DISCARD,h.beginAccesses=[Vr.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Vr.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new qa([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Kp.BINDING).destroy(),this._descriptorSet.getBuffer(Zp.BINDING).destroy(),this._descriptorSet.getBuffer(Qp.BINDING).destroy(),this._descriptorSet.getTexture(Jp).destroy(),this._descriptorSet.getTexture(sd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new AM,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new Pa(Rr.TEX2D,Ir.DEPTH_STENCIL_ATTACHMENT|Ir.SAMPLED,Sr.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Ka(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED,Sr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Ka(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(yx.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},t}(kx),xM=X((yM=SM).prototype,"renderTextures",[mM,cl,vM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gM=yM))||gM));function bM(){var e=new YO;return e.initialize({flows:[]}),e}var PM=new Ni,RM=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new ga(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new ga(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?i.view.setDesignResolutionSize(n.width,n.height,n.policy):i.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,i.game.once(i.Game.EVENT_GAME_INITED,(function(){i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new ga(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new ua(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,a=4*r;this.vertexBuffers=t.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,a,r)),this.vertexBuffers.update(i);var o=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,c,s)),this.indicesBuffers.update(o);var l=[new Ua("a_position",Sr.RG32F),new Ua("a_texCoord",Sr.RG32F)],u=new ka(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new wi,wi.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),i.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,a=e.swapchain;wi.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,a.surfaceTransform);var o=a.width,s=a.height,c=o<s?o:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=__(Kn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,p=f*h/_,d=f;if(a.surfaceTransform!==yr.ROTATE_90&&a.surfaceTransform!==yr.ROTATE_270||(p=f*o/s,d=f*_/h*s/o),e.logoMat.setProperty("resolution",PM.set(o,s),0),e.logoMat.setProperty("scale",PM.set(p,d),0),e.logoMat.setProperty("translate",PM.set(.5*o,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;a.surfaceTransform!==yr.ROTATE_90&&a.surfaceTransform!==yr.ROTATE_270||(g=.5*m,y=m*o/s*.5),e.watermarkMat.setProperty("resolution",PM.set(o,s),0),e.watermarkMat.setProperty("scale",PM.set(g,y),0),e.watermarkMat.setProperty("translate",PM.set(.5*o,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Cg,this.logoMat.initialize({effectName:"splash-screen"});var t=new Ia;t.addressU=Nr.CLAMP,t.addressV=Nr.CLAMP,t.addressW=Nr.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Pa(Rr.TEX2D,Ir.SAMPLED|Ir.TRANSFER_DST,Sr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var a=new ma;a.texExtent.width=this.logoImage.width,a.texExtent.height=this.logoImage.height,a.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[a])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new ma;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Pa(Rr.TEX2D,Ir.SAMPLED|Ir.TRANSFER_DST,Sr.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Cg,this.watermarkMat.initialize({effectName:"splash-screen"});var a=this.watermarkMat.passes[0],o=a.getBinding("mainTexture");a.bindTexture(o,this.watermarkTexture),a.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var a=this.logoMat.passes[0],o=cg.getOrCreatePipelineState(e,a,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(o),n.bindDescriptorSet(Wp.MATERIAL,a.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=cg.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Wp.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},B(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();RM._ins=void 0,i.internal.SplashScreen=RM;var IM=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},B(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());IM.Priority=Ye({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var wM=new ee("Scheduler"),DM=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};DM.get=function(e,t,n,i){var r=DM._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new DM(e,t,n,i),r},DM.put=function(e){DM._listEntries.length<20&&(e.target=null,DM._listEntries.push(e))},DM._listEntries=[];var OM=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};OM.get=function(e,t,n,i){var r=OM._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new OM(e,t,n,i),r},OM.put=function(e){OM._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,OM._hashUpdateEntries.push(e))},OM._hashUpdateEntries=[];var MM=function(e,t,n,i,r,a){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=a};MM.get=function(e,t,n,i,r,a){var o=MM._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=n,o.currentTimer=i,o.currentTimerSalvaged=r,o.paused=a):o=new MM(e,t,n,i,r,a),o},MM.put=function(e){MM._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,MM._hashTimerEntries.push(e))},MM._hashTimerEntries=[];var NM=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,r,a,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=r,this._delay=o,this._useDelay=this._delay>0,this._repeat=a,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();NM._timers=[],NM.get=function(){return NM._timers.pop()||new NM},NM.put=function(e){NM._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,NM._timers.push(e))};var BM,FM=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=_e(!0),t._hashForTimers=_e(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}L(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?A(1513):e.id=wM.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var o=this._arrayForTimers;for(t=0;t<o.length;t++){if(a=o[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,r,a,o){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!r,r=i.macro.REPEAT_FOREVER,a=0),I(t,1502);var c=t.uuid||t.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==o&&A(1511):(h=MM.get(null,t,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return T(1507,l.getInterval(),n),void(l._interval=n);(l=NM.get()).initWithCallback(this,e,t,n,r,a),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else b(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return T(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var a,o=DM.get(e,t,n,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[i]=OM.get(a,o,e,null)}else b(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,a=0,o=r.length;a<o;a++){var s=r[a];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(a,1),NM.put(s),i.timerIndex>=a&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else b(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else b(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,a=i.length;r<a;r++)NM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else b(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(IM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){I(e,1508),I(t,1509);var n=t.uuid||t.id;if(!n)return b(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,a=0;a<r.length;++a)if(e===r[a]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(IM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,a=[],o=this._arrayForTimers;for(n=0,i=o.length;n<i;n++)(t=o[n])&&(t.paused=!0,a.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,a.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){I(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else b(1510)},n.resumeTarget=function(e){I(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else b(1510)},n.isTargetPaused=function(e){I(e,1505);var t=e.uuid||e.id;if(!t)return b(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}MM.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,a=0,o=i.length;a<o;a++)if(i[a]===r){i.splice(a,1);break}delete this._hashForUpdates[t],DM.put(r),OM.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(IM));FM.ID="scheduler",i.Scheduler=FM;var LM=((BM={})[eh.PORTRAIT]=yr.IDENTITY,BM[eh.LANDSCAPE_RIGHT]=yr.ROTATE_90,BM[eh.PORTRAIT_UPSIDE_DOWN]=yr.ROTATE_180,BM[eh.LANDSCAPE_LEFT]=yr.ROTATE_270,BM),zM=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new Pa(Rr.TEX2D,Ir.COLOR_ATTACHMENT|Ir.SAMPLED|Ir.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==Sr.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Pa(Rr.TEX2D,Ir.DEPTH_STENCIL_ATTACHMENT|Ir.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Ka(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,LM[ah.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Ka(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=W(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},B(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),UM=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(e),og.registerCreateFunc(this),zM.registerCreateFunc(this),this._cameraPool=new je((function(){return new dm(t._device)}),4,(function(e){return e.destroy()}))}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){this._init();var e=i.game._swapchain,t=new Ha;t.format=e.colorTexture.format;var n=new Va;n.format=e.depthStencilTexture.format,n.depthStoreOp=Hr.DISCARD,n.stencilStoreOp=Hr.DISCARD;var r=new qa([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:r,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Nv.initBuiltinRes(this._device))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){for(var n,i=W(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},e.setRenderPipeline=function(e){e instanceof CM&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=bM(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(xr.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=i.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,r=[],a=0;a<n.length;a++)n[a].extractRenderCameras(r);if(this._pipeline&&r.length>0){this._device.acquire([i.game._swapchain]);var o=this._scenes,s=i.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var c=0;c<o.length;c++)o[c].update(s);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),r.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(r),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=W(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=W(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new je((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):A(1300,e.constructor.name),e.destroy()},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new je((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Og.SPHERE:e.scene.removeSphereLight(e);break;case Og.SPOT:e.scene.removeSpotLight(e)}e.destroy()},B(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();i.Root=UM;var GM=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}L(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){i.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(uD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return i.director.once(i.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),i.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){fn.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),sh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,r=0;r<n.length;r++){var a=n[r],o=In(a.value);Mp.addLayer(a.name,o)}return this._initEngine().then((function(){return t._initEvents(),i.director.root&&i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Iu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(i.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=i.director._scene;if(i.isValid(n))if(e.parent){if(!(e.parent instanceof i.Scene))return void A(3801);if(e.parent!==n)return void A(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(e)}}else A(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},n._initEngine=function(){var e=this;this._initDevice();var n=i.director;return Promise.resolve(n._init()).then((function(){i.view.init(),f("Cocos Creator v"+r),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,i.internal.dynamicAtlasManager&&(i.internal.dynamicAtlasManager.enabled=!$e.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=i.director;if(30===this._frameRate){var r=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(r=!r)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=i.director;O(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=P.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,g(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(w(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new Sa(Yp),r=!!window.WebGL2RenderingContext,a=window.navigator.userAgent.toLowerCase();(-1!==a.indexOf("safari")&&-1===a.indexOf("chrome")||ch.browserType===on.UC)&&(r=!1);var o=[];r&&i.WebGL2Device&&o.push(i.WebGL2Device),i.WebGLDevice&&o.push(i.WebGLDevice),i.EmptyDevice&&o.push(i.EmptyDevice),Eo.canvas=this.canvas;for(var s=0;s<o.length&&(this._gfxDevice=new o[s],!this._gfxDevice.initialize(n));s++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&i.EmptyDevice&&(this._gfxDevice=new i.EmptyDevice,this._gfxDevice.initialize(new Sa(Yp)));if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var c=new xa(this.canvas),l=sh.windowSize;c.width=l.width,c.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(c),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){fn.on("show",this._onShow,this),fn.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){i.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof kx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){p(n),p("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(i.internal.SplashScreen){var e=i.internal.SplashScreen.instance;return e.main(i.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){i.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},B(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(_n));GM.EVENT_HIDE="game_on_hide",GM.EVENT_SHOW="game_on_show",GM.EVENT_LOW_MEMORY="game_on_low_memory",GM.EVENT_GAME_INITED="game_inited",GM.EVENT_ENGINE_INITED="engine_inited",GM.EVENT_RENDERER_INITED="renderer_inited",GM.EVENT_RESTART="game_on_restart",GM.RENDER_TYPE_CANVAS=0,GM.RENDER_TYPE_WEBGL=1,GM.RENDER_TYPE_OPENGL=2,GM.RENDER_TYPE_HEADLESS=3,GM.DEBUG_DT_THRESHOLD=1,i.Game=GM;var kM=e("game",i.game=new GM),HM=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new FM,t._compScheduler=new LD,t._nodeActivator=new tO,t._systems=[],kM.once(GM.EVENT_RENDERER_INITED,t._initOnRendererInitialized,V(t)),t}L(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof nO&&(e=e.scene),I(e instanceof SD,1216),e._load();for(var r=Object.keys(kM._persistRootNodes).map((function(e){return kM._persistRootNodes[e]})),a=0;a<r.length;a++){var o=r[a];o.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(o,c)}else o.parent=e}var l=this._scene;i.isValid(l)&&l.destroy(),i.assetManager._releaseManager._autoRelease(l,e,kM._persistRootNodes),this._scene=null,Yt._deferredDestroy(),t&&t(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var r=this;e instanceof nO&&(e=e.scene),I(e,1205),I(e instanceof SD,1216),e._load(),this.once(i.Director.EVENT_END_FRAME,(function(){r.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var r=this;if(this._loadingScene)return A(1208,e,this._loadingScene),!1;var a=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return a?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),a.loadScene(e,(function(i,a){console.timeEnd("LoadScene "+e),r._loadingScene="",i?(d(i),t&&t(i)):r.runSceneImmediate(a,n,t)})),!0):(b(1209,e),!1)},n.preloadScene=function(e,t,n){var r=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(r)r.preloadScene(e,null,t,n);else{var a='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(a)),d("preloadScene: "+a)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return kM.deltaTime},n.getTotalTime=function(){return kM.totalTime},n.getCurrentTime=function(){return kM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(FM.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(IM.sortByPriority)},n.unregisterSystem=function(e){Ge.fastRemove(this._systems,e),this._systems.sort(IM.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(i.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=kM._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),uD._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Yt._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),qC.resetHasChangedFlags(),qC.clearNodeArray(),He.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(FM.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new UM(kM._gfxDevice),this._root.initialize({}).catch((function(e){return b(1217),Promise.reject(e)}))},B(t,[{key:"root",get:function(){return this._root}}]),t}(_n));HM.EVENT_INIT="director_init",HM.EVENT_RESET="director_reset",HM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",HM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",HM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",HM.EVENT_BEFORE_UPDATE="director_before_update",HM.EVENT_AFTER_UPDATE="director_after_update",HM.EVENT_BEFORE_DRAW="director_before_draw",HM.EVENT_AFTER_DRAW="director_after_draw",HM.EVENT_BEFORE_COMMIT="director_before_commit",HM.EVENT_BEFORE_PHYSICS="director_before_physics",HM.EVENT_AFTER_PHYSICS="director_after_physics",HM.EVENT_BEGIN_FRAME="director_begin_frame",HM.EVENT_END_FRAME="director_end_frame",HM.instance=void 0,i.Director=HM;var VM=e("director",HM.instance=i.director=new HM),jM={};Nn(jM,"vmath",[{name:"vec2",newName:"Vec2",target:Xi,targetName:"math"},{name:"vec3",newName:"Vec3",target:Xi,targetName:"math"},{name:"vec4",newName:"Vec4",target:Xi,targetName:"math"},{name:"quat",newName:"Quat",target:Xi,targetName:"math"},{name:"mat3",newName:"Mat3",target:Xi,targetName:"math"},{name:"mat4",newName:"Mat4",target:Xi,targetName:"math"},{name:"color4",newName:"Color",target:Xi,targetName:"math"},{name:"rect",newName:"Rect",target:Xi,targetName:"math"},{name:"approx",newName:"approx",target:Xi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Xi,targetName:"math"},{name:"equals",newName:"equals",target:Xi,targetName:"math"},{name:"clamp",newName:"clamp",target:Xi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Xi,targetName:"math"},{name:"lerp",newName:"lerp",target:Xi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Xi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Xi,targetName:"math"},{name:"random",newName:"random",target:Xi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Xi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Xi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Xi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Xi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Xi,targetName:"math"},{name:"repeat",newName:"repeat",target:Xi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Xi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Xi,targetName:"math"}]),i.vmath=jM,Nn(FM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:FM,targetName:"Scheduler"}]),Nn(FM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return IM.Priority.SCHEDULER}}]),Bn(FM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),Nn(jv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Bn(jv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),Nn(UM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),Fn(kM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),Fn(HM.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),Bn(HM.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var WM,qM={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,a=r+n,o=i+t;this.topLeft.x=i,this.topLeft.y=a,this.topRight.x=o,this.topRight.y=a,this.top.x=i+t/2,this.top.y=a,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=o,this.right.y=r+n/2}};i.visibleRect=qM;var XM=new ki,YM=((WM={})[$e.ORIENTATION_AUTO]=eh.AUTO,WM[$e.ORIENTATION_LANDSCAPE]=eh.LANDSCAPE,WM[$e.ORIENTATION_PORTRAIT]=eh.PORTRAIT,WM),KM=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=QM,i=ZM;return t._designResolutionSize=new ki(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Vi(0,0,0,0),t._visibleRect=new Vi(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new JM(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new JM(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new JM(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new JM(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new JM(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}L(t,e);var n=t.prototype;return n.init=function(){var e=sh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,XM.width=this._visibleRect.width,XM.height=this._visibleRect.height,qM&&qM.init(this._visibleRect),ah.on("window-resize",this._updateAdaptResult,this),ah.on("orientation-change",this._updateAdaptResult,this),ah.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){ah.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){ah.orientation=YM[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&sh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){ah.resolutionScale=1;var n=ah.devicePixelRatio,i=new ki(e*n,t*n);sh.windowSize=i},n.getCanvasSize=function(){return sh.windowSize},n.getFrameSize=function(){var e=ah.devicePixelRatio,t=sh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=ah.devicePixelRatio;sh.windowSize=new ki(e*n,t*n)},n.getVisibleSize=function(){return new ki(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ki(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Ni(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Ni(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof JM)this._resolutionPolicy=e;else{var t=JM;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=$M.getDesignResolutionSize();$M.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,o=this._visibleRect,s=r.viewport;a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height,o.x=0,o.y=0,o.width=s.width/this._scaleX,o.height=s.height/this._scaleY}i.postApply(this),XM.width=this._visibleRect.width,XM.height=this._visibleRect.height,qM&&qM.init(this._visibleRect),this.emit("design-resolution-changed")}else b(2200)},n.getDesignResolutionSize=function(){return new ki(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return ah.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Ni);var r=ah.devicePixelRatio*(e-n.left),a=ah.devicePixelRatio*(n.top+n.height-t);return ah.isFrameRotated?(i.x=sh.windowSize.width-a,i.y=r):(i.x=r,i.y=a),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;i.director.root.resize(sh.windowSize.width,sh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(_n));KM.instance=void 0;var QM=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=kM.canvas;if(e){var t=sh.windowSize;e.width=t.width,e.height=t.height}},e}();QM.EQUAL_TO_FRAME=void 0,QM.PROPORTION_TO_FRAME=void 0;var ZM=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,a){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var o=new Vi(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,a],this._result.viewport=o,this._result},e}();ZM.EXACT_FIT=void 0,ZM.SHOW_ALL=void 0,ZM.NO_BORDER=void 0,ZM.FIXED_HEIGHT=void 0,ZM.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return L(t,e),t.prototype.apply=function(){ah.isProportionalToFrame=!1,this._setupCanvas()},t}(QM),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return L(t,e),t.prototype.apply=function(){ah.isProportionalToFrame=!0,this._setupCanvas()},t}(QM);QM.EQUAL_TO_FRAME=new e,QM.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return L(t,e),t.prototype.apply=function(e,t){var n=sh.windowSize,i=n.width,r=n.height,a=i/t.width,o=r/t.height;return this._buildResult(i,r,i,r,a,o)},t}(ZM),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return L(t,e),t.prototype.apply=function(e,t){var n,i,r=sh.windowSize,a=r.width,o=r.height,s=t.width,c=t.height,l=a/s,u=o/c,h=0;return l<u?(n=a,i=c*(h=l)):(n=s*(h=u),i=o),this._buildResult(a,o,n,i,h,h)},t}(ZM),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return L(t,e),t.prototype.apply=function(e,t){var n,i,r,a=sh.windowSize,o=a.width,s=a.height,c=t.width,l=t.height,u=o/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=o,r=l*(n=u)),this._buildResult(o,s,i,r,n,n)},t}(ZM),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return L(t,e),t.prototype.apply=function(e,t){var n=sh.windowSize,i=n.width,r=n.height,a=r/t.height,o=i,s=r;return this._buildResult(i,r,o,s,a,a)},t}(ZM),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return L(t,e),t.prototype.apply=function(e,t){var n=sh.windowSize,i=n.width,r=n.height,a=i/t.width,o=i,s=r;return this._buildResult(i,r,o,s,a,a)},t}(ZM);ZM.EXACT_FIT=new n,ZM.SHOW_ALL=new i,ZM.NO_BORDER=new r,ZM.FIXED_HEIGHT=new a,ZM.FIXED_WIDTH=new o}();var JM=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof QM&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof ZM&&(this._contentStrategy=e)},B(e,[{key:"canvasSize",get:function(){return sh.windowSize}}]),e}());JM.EXACT_FIT=0,JM.NO_BORDER=1,JM.SHOW_ALL=2,JM.FIXED_HEIGHT=3,JM.FIXED_WIDTH=4,JM.UNKNOWN=5,JM.ContainerStrategy=QM,JM.ContentStrategy=ZM,i.ResolutionPolicy=JM;var $M=e("view",KM.instance=i.view=new KM);i.winSize=XM,Bn(KM.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),Fn(KM.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),Fn(i,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),Fn(ch,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),Nn(ch,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:ch.Language,targetName:"sys.Language"}}))),Nn(ch,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:ch.OS,targetName:"sys.OS"}}))),Nn(ch,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:ch.BrowserType,targetName:"sys.BrowserType"}}))),Nn(ch,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:ch.BrowserType,targetName:"sys.BrowserType"}]),Nn(ch,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:ch.Platform,targetName:"sys.Platform"}}))),Nn(ch,"sys",[{name:"IPHONE",newName:"IOS",target:ch.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:ch.Platform,targetName:"sys.Platform"}]),Bn(ch,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),Nn(ch,"sys",[{name:"windowPixelResolution",target:sh,targetName:"screen",newName:"windowSize"}]),Fn(sh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var eN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Ql,this.scenes=new Ql,this.paths=new Ql}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,a=e.paths=Object.create(null);if(!1===e.debug){for(var o=0,s=t.length;o<s;o++)t[o]=fu(t[o]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var p=t[_];t[_]=h[p]=fu(p)}t=h}for(var d in n){var m=n[d];a[t[d]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var T=x[S],E=0;E<T.length;++E)T[E]=t[T[E]];var A=e.versions;if(A)for(var C in A)for(var b=A[C],P=0;P<b.length;P+=2){var R=b[P];b[P]=t[R]||R}var I=e.redirect;if(I)for(var w=0;w<I.length;w+=2)I[w]=t[I[w]],I[w+1]=r[I[w+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=gu(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var a=n[i];if(ke.isChildClassOf(a.ctor,t))return a}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=gu(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var a=0,o=n.length;a<o;a++){var s=n[a];t&&!ke.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],a=i[1],o=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=ke._getClassById(a),t.has(r)?o?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],a=n.get(r);a.url=i,t.add(i,a)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var a=0,o=i.length;a<o;a++){var s=i[a],c=t.get(s),l=c.packs;l?1===o?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var a=n[i];t.get(a).ver=n[i+1]}if(n=e.native)for(var o=0,s=n.length;o<s;o+=2){var c=n[o];t.get(c).nativeVer=n[o+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function tN(e,t){e._uuid&&t.push(e._uuid)}function nN(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var a=e[r];if("object"==typeof a&&a)if(Array.isArray(a))for(var o=0;o<a.length;o++){var s=a[o];s instanceof Du&&tN(s,t)}else if(a.constructor&&a.constructor!==Object)a instanceof Du&&tN(a,t);else for(var c=Object.getOwnPropertyNames(a),l=0;l<c.length;l++){var u=a[c[l]];u instanceof Du&&tN(u,t)}}}}function iN(e,t){for(var n=0;n<e._components.length;n++)nN(e._components[n],t);for(var i=0;i<e._children.length;i++)iN(e._children[i],t)}function rN(e,t,n,i){n.push(e._uuid);for(var r=zm.getDeps(e._uuid),a=0,o=r.length;a<o;a++){var s=$l.get(r[a]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||rN(s,t,n,i)}}}var aN=[],oN=new(function(){function e(){this._persistNodeDeps=new Ql,this._toDelete=new Ql,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];iN(e,t);for(var n=0,i=t.length;n<i;n++){var r=$l.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=$l.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=zm.getDeps(e.uuid),r=0,a=i.length;r<a;r++){var o=$l.get(i[r]);o&&o.decRef(e.autoReleaseAssets)}var s=zm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=$l.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&zm.remove(e.uuid)}var _=zm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var p,d,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=W(v);!(d=g()).done;){var y=d.value,x=$l.get(y);x&&x.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Du&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,lt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),Qt(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,rN(e,t,aN,-1),aN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&rN($l.get(n),t,aN,1);return aN.length=0,t[e._uuid]}(e)>0)){$l.remove(n);for(var i=zm.getDeps(n),r=0,a=i.length;r<a;r++){var o=$l.get(i[r]);o&&(o.decRef(!1),this._free(o,!1))}e.destroy(),zm.remove(n)}},e}()),sN=null;function cN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Du&&r.content.decRef(!1),r.recycle()}e.input=null}function lN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function uN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(a,o){r++,!a||r>t?i&&i(a,o):setTimeout((function(){uN(e,t,n,i,r)}),n)}))}function hN(e,t,n,i,r){try{for(var a=zm.parse(e,t),o=0,s=a.deps.length;o<s;o++){var c=a.deps[o];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}a.nativeDep&&(r&&(a.nativeDep.bundle=r.name),i.push(F({},a.nativeDep)))}catch(e){d(e.message,e.stack)}}function _N(e,t,n){t&&(n=void 0!==n?n:i.assetManager.cacheAsset,vu(t)||!n||t.isDefault||$l.add(e,t))}function fN(e,t,n){var i=0,r=[],a=e.length;0===a&&n&&n(r);for(var o=function(e){e&&r.push(e),++i===a&&n&&n(r)},s=0;s<a;s++)t(e[s],o)}function pN(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o="function"==typeof e;t?(a=t,o||(r=null)):void 0===t&&o&&(a=e,i=null,r=null),void 0!==t&&o&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:a}}function dN(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o=ke.isChildClassOf(e,Du);t?(a=t,o&&(r=null)):void 0!==t||o||(a=e,r=null,i=null),void 0===t||o||(r=e,i=null)}return{type:i,onProgress:r||sN,onComplete:a}}function mN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,a=zm.getDeps(t);if(a)for(var o=0,s=a.length;o<s;o++){var c=a[o];if(c===e||mN(e,c,n,i)){r=!0;break}}return r}function vN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Du&&i.push(e.addRef())})):n instanceof Du&&i.push(n.addRef()),lt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var gN=function(){function e(){this._config=new eN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),nu.add(e.name,this)},t.load=function(e,t,n,r){var a=dN(t,n,r),o=a.type,s=a.onProgress,c=a.onComplete,l={__requestType__:Jl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};i.assetManager.loadAny(e,l,s,c)},t.preload=function(e,t,n,r){var a=dN(t,n,r),o=a.type,s=a.onProgress,c=a.onComplete;i.assetManager.preloadAny(e,{__requestType__:Jl.PATH,type:o,bundle:this.name},s,c)},t.loadDir=function(e,t,n,r){var a=dN(t,n,r),o=a.type,s=a.onProgress,c=a.onComplete;i.assetManager.loadAny(e,{__requestType__:Jl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},s,c)},t.preloadDir=function(e,t,n,r){var a=dN(t,n,r),o=a.type,s=a.onProgress,c=a.onComplete;i.assetManager.preloadAny(e,{__requestType__:Jl.DIR,type:o,bundle:this.name},s,c)},t.loadScene=function(e,t,n,r){var a=pN(t,n,r),o=a.options,s=a.onProgress,c=a.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,i.assetManager.loadAny({scene:e},o,s,(function(e,t){if(e)d(e.message,e.stack);else if(t instanceof nO&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");c&&c(e,t)}))},t.preloadScene=function(e,t,n,r){var a=pN(t,n,r),o=a.options,s=a.onProgress,c=a.onComplete;o.bundle=this.name,i.assetManager.preloadAny({scene:e},o,s,(function(t){t&&b(1210,e,t.message),c&&c(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&$l.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&oN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;$l.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&oN.tryRelease(t)}))},t.releaseAll=function(){var e=this;$l.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&oN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},B(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),yN=e("resources",new gN);function xN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(null,i)}function a(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(new Error(w(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",a),i.src=e,i}function SN(e,t,n,i){var r=new XMLHttpRequest,a="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var o in t.xhrHeader)r.setRequestHeader(o,t.xhrHeader[o]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+a+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+a+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+a+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+a+r.status+"(abort)"))},r.send(null),r}i.resources=yN;var TN={};function EN(e,t,n){if(TN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),TN[e]=!0,n&&n(null)}function a(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),n&&n(new Error(w(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",a,!1),document.body.appendChild(i),i}var AN=/^(?:\w+:\/\/|\.+\/).+/,CN=function(e,t,n){(ch.hasFeature(ch.Feature.IMAGE_BITMAP)&&i.assetManager.allowImageBitmap?bN:xN)(e,t,n)},bN=function(e,t,n){t.xhrResponseType="blob",SN(e,t,t.onFileProgress,n)},PN=function(e,t,n){t.xhrResponseType="json",SN(e,t,t.onFileProgress,n)},RN=function(e,t,n){t.xhrResponseType="arraybuffer",SN(e,t,t.onFileProgress,n)},IN=function(e,t,n){PN(e,t,(function(t,i){if(t)n(t);else{var r=_h(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){RN(""+yn(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new hh(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},wN=function(e,t,n){RN(e,t,(function(e,t){if(e)n(e);else try{var i=fh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},DN=function(e,t,n){t.xhrResponseType="text",SN(e,t,t.onFileProgress,n)},ON=function(e,t,n){var i=xn(e),r=e;AN.test(r)||(r=-1!==MN.remoteBundles.indexOf(i)?MN.remoteServerAddress+"remote/"+i:"assets/"+i);var a=t.version||MN.bundleVers[i],o=0,s=null,c=null;PN(r+"/config."+(a?a+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++o&&n(c,s)})),EN(r+"/index."+(a?a+".":"")+"js",t,(function(e){c=e,2==++o&&n(e,s)}))},MN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=xN,this.downloadDomAudio=null,this.downloadFile=SN,this.downloadScript=EN,this._downloaders={".png":CN,".jpg":CN,".bmp":CN,".jpeg":CN,".gif":CN,".ico":CN,".tiff":CN,".webp":CN,".image":CN,".pvr":RN,".pkm":RN,".astc":RN,".txt":DN,".xml":DN,".vsh":DN,".fsh":DN,".atlas":DN,".tmx":DN,".tsx":DN,".json":PN,".ExportJson":PN,".plist":DN,".ccon":IN,".cconb":wN,".fnt":DN,".binary":RN,".bin":RN,".dbbin":RN,".skel":RN,".js":EN,bundle:ON,default:DN},this._downloading=new Ql,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?Ee(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var a=this,o=eu.get(e);if(o)r(null,o);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;uN((function(n,o){if(0===n&&a._downloading.add(e,[r]),a.limited){a._updateTime();var s=function(e,t){a._totalNum--,a._handleQueueInNextFrame(h,_),o(e,t)};a._totalNum<h&&a._totalNumThisPeriod<_?(f(lN(t,a.appendTimeStamp),i,s),a._totalNum++,a._totalNumThisPeriod++):(a._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),a._queueDirty=!0,a._totalNum<h&&a._handleQueueInNextFrame(h,_))}else f(lN(t,a.appendTimeStamp),i,o)}),u,this.retryInterval,(function(t,n){t||eu.add(e,n);for(var i=a._downloading.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){i.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=i.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(lN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(lt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},B(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function NN(e,t,n,i){var r=null,a=null;try{(r=new wm)._nativeUrl=e,r._nativeAsset=t}catch(e){a=e}i(a,r)}function BN(e,t,n,i){var r=new cO;r.json=t,i(null,r)}function FN(e,t,n,i){var r=new sO;r.text=t,i(null,r)}function LN(e,t,n,i){var r=new Bb;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function zN(e,t,n,i){var r=new Du;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function UN(e,n,i,r){var a=nu.get(n.name);a||(a=n.name===ou.RESOURCES?yN:new gN,n.base=n.base||e+"/",a.init(n)),t.import("virtual:///prerequisite-imports/"+a.name).then((function(){r(null,a)})).catch(r)}var GN=new(function(){function e(){this._creating=new Ql,this._producers={".png":NN,".jpg":NN,".bmp":NN,".jpeg":NN,".gif":NN,".ico":NN,".tiff":NN,".webp":NN,".image":NN,".pvr":NN,".pkm":NN,".txt":FN,".xml":FN,".vsh":FN,".fsh":FN,".atlas":FN,".tmx":FN,".tsx":FN,".fnt":FN,".json":BN,".ExportJson":BN,".binary":LN,".bin":LN,".dbbin":LN,".skel":LN,bundle:UN,default:zN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?ke.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var a=this,o=this._producers[n]||this._producers.default,s=$l.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),o(e,t,i,(function(t,n){!t&&n instanceof Du&&(n._uuid=e,_N(e,n,i.cacheAsset));for(var r=a._creating.remove(e),o=0,s=r.length;o<s;o++)r[o](t,n)})))}else r(null,s)},e}()),kN=new(function(){function e(){this._loading=new Ql,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=ke.createMap(!0),a=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(w(5304,e[0]));Mh(e,!0,void 0,Bh.reportMissingClass),Nh(e);for(var t=new Fh(e[0]),n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=0;s<o.length;++s)o[s].unshift(t,n,i,r,a);return o}(t)).length!==e.length&&b(4915);for(var o=0;o<e.length;o++)r[e[o]+"@import"]=t[o]}else{var s=ke._getClassId(tv),c=ke._getClassId(wm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&b(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Lh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&b(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else a=new Error("unmatched type pack!"),r=null}i(a,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?ke.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(eu.has(e.id))n(null,eu.get(e.id));else{var r=e.info.packs,a=r.find((function(e){return i._loading.has(e.uuid)}));if(a)this._loading.get(a.uuid).push({onComplete:n,id:e.id});else{a=r[0],this._loading.add(a.uuid,[{onComplete:n,id:e.id}]);var o=yu(a.uuid,{ext:a.ext,bundle:e.config.name});MN.download(a.uuid,o,a.ext,e.options,(function(t,n){eu.remove(a.uuid),t&&d(t.message,t.stack),i.unpack(a.packedUuids,n,a.ext,e.options,(function(e,n){if(!e)for(var r in n)eu.add(r,n[r]);for(var o=i._loading.remove(a.uuid),s=0,c=o.length;s<c;s++){var l=o[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else MN.download(e.id,e.url,e.ext,e.options,n)},e}());function HN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,a=e.progress,o=[],s=a.total,c=r.__exclude__=r.__exclude__||Object.create(null);e.output=[],fN(e.input,(function(r,l){if(!r.isNative&&$l.has(r.uuid)){var u=$l.get(r.uuid);return r.content=u.addRef(),e.output.push(r),a.canInvoke&&e.dispatch("progress",++a.finish,a.total,r),void l()}kN.load(r,e.options,(function(u,h){u?e.isFinish||(!i.assetManager.force||n?(d(u.message,u.stack),a.canInvoke=!1,t(u)):(e.output.push(r),a.canInvoke&&e.dispatch("progress",++a.finish,a.total,r))):e.isFinish||(r.file=h,e.output.push(r),r.isNative||(c[r.uuid]=!0,hN(r.uuid,h,c,o,r.config),a.total=s+o.length),a.canInvoke&&e.dispatch("progress",++a.finish,a.total,r)),l()}))}),(function(){if(e.isFinish)return cN(e,!0),void e.dispatch("error");if(o.length>0){var i=cu.create({input:o,progress:a,options:r,onProgress:e.onProgress,onError:cu.prototype.recycle,onComplete:function(r){var a;r||((a=e.output).push.apply(a,i.output),i.recycle()),n&&VN(e),t(r)}});ru.async(i)}else n&&VN(e),t()}))}function VN(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var jN=new(function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return A(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var a=e.childNodes[i];1===a.nodeType&&("key"===a.tagName?n=a.firstChild.nodeValue:t[n]=this._parseNode(a))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function WN(e,t){return e[t]<<8|e[t+1]}var qN=new(function(){function e(){this._parsing=new Ql,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Int32Array(a,0,13);if(55727696===o[0]){var s=o[7],c=o[6],l=o[12]+52;r={_data:new Uint8Array(a,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==o[11])throw new Error("Invalid magic number in PVR header");var u=o[0],h=o[1],_=o[2];r={_data:new Uint8Array(a,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a),s=WN(o,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=WN(o,12),l=WN(o,14);WN(o,8),WN(o,10),r={_data:new Uint8Array(a,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a);if(1554098963!==o[0]+(o[1]<<8)+(o[2]<<16)+(o[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=o[4],c=o[5],l=o[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?em.RGBA_ASTC_4x4:5===e?4===t?em.RGBA_ASTC_5x4:em.RGBA_ASTC_5x5:6===e?5===t?em.RGBA_ASTC_6x5:em.RGBA_ASTC_6x6:8===e?5===t?em.RGBA_ASTC_8x5:6===t?em.RGBA_ASTC_8x6:em.RGBA_ASTC_8x8:10===e?5===t?em.RGBA_ASTC_10x5:6===t?em.RGBA_ASTC_10x6:8===t?em.RGBA_ASTC_10x8:em.RGBA_ASTC_10x10:10===t?em.RGBA_ASTC_12x10:em.RGBA_ASTC_12x12}(s,c),h=o[7]+(o[8]<<8)+(o[9]<<16),_=o[10]+(o[11]<<8)+(o[12]<<16);o[13],o[14],o[15],r={_data:new Uint8Array(a,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=jN.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Fm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?Ee(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var a=this,o=tu.get(e);if(o)r(null,o);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?eu.remove(e):vu(n)||tu.add(e,n);for(var i=a._parsing.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))):r(null,t)}}},e}());function XN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,a=e.progress;r.__exclude__=r.__exclude__||Object.create(null),e.output=[],fN(e.input,(function(o,s){var c=cu.create({input:o,onProgress:e.onProgress,options:r,progress:a,onComplete:function(r,l){r&&!e.isFinish&&(!i.assetManager.force||n?(d(r.message,r.stack),a.canInvoke=!1,t(r)):a.canInvoke&&e.dispatch("progress",++a.finish,a.total,o)),e.output.push(l),c.recycle(),s(null)}});YN.async(c)}),(function(){if(r.__exclude__=null,e.isFinish)return cN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),cN(e,!0),t()}))}var YN=new Zl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,a=n.uuid,o=n.file,s=i.reloadAsset;o||!s&&!r&&$l.has(a)?t():kN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,a=n.id,o=n.file,s=n.options;if(n.isNative)qN.parse(a,o,n.ext,s,(function(r,o){r?t(r):(n.content=o,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),eu.remove(a),tu.remove(a),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||mN(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&$l.has(c)){var p=$l.get(c);n.content=p.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,qN.parse(a,o,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,a=i,o=a.uuid,s=a.id,c=a.options,l=a.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),hN(o,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[o]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=cu.create({input:h,options:e.options,onProgress:e.onProgress,onError:cu.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),a=W(i);!(n=a()).done;){var c=n.value;c&&(r[c instanceof Du?c._uuid+"@import":o+"@native"]=c)}!function(e,t,n){var i=Mm.get(t);if(i){for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.uuid+"@import"];if(s)o.owner[o.prop]=s.addRef();else{if(d("The asset "+o.uuid+" is missing!"),o.type&&o.type!==Du){var c=new o.type;c.initDefault(o.uuid),o.owner[o.prop]=c}!0}}Mm.delete(t)}Nm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Nm.delete(t))}(o,t,r);try{"function"!=typeof t.onLoaded||Bm.has(t)||Nm.has(t)||(t.onLoaded(),Bm.add(t))}catch(e){d("The asset "+o+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}eu.remove(s),tu.remove(s),_N(o,t,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var m=l[h];t.addRef&&t.addRef(),m.item.content=t,m.done(e)}l.length=0}});iu.async(f)}(e,i,t)}))}}]);function KN(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var a in n)switch(a){case Jl.PATH:case Jl.UUID:case Jl.DIR:case Jl.SCENE:case Jl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[a]=n[a];break;case"__exclude__":case"__outputAsArray__":r[a]=n[a];break;default:i[a]=n[a],r[a]=n[a]}e.options=r;var o=cu.create({input:e.input,options:i}),s=null;try{e.output=e.source=au.sync(o)}catch(e){s=e;for(var c=0,l=o.output.length;c<l;c++)o.output[c].recycle()}o.recycle(),t(s)}var QN=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},B(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();QN.MAX_DEAD_NUM=500,QN._deadPool=[];var ZN=[];function JN(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,a=n[i],o=QN.create(),s=null,c=null;if("string"==typeof a&&((a=Object.create(null))[t.__requestType__||Jl.UUID]=n[i]),"object"==typeof a)for(var l in Te(a,t),a.preset&&Te(a,su[a.preset]),a){switch(l){case Jl.UUID:if("break"===function(){var e,t=o.uuid=fu(a.uuid);if(!a.bundle){var n=nu.find((function(e){return!!e.getAssetInfo(t)}));a.bundle=n&&n.name}if(nu.has(a.bundle)){if(s=nu.get(a.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!nu.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=nu.get(c.redirect).config,c=s.getAssetInfo(t)}o.config=s,o.info=c}return o.ext=a.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Jl.DIR:if(nu.has(a.bundle)){nu.get(a.bundle).config.getDirWithPath(a.dir,a.type,ZN);for(var u,h=W(ZN);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:a.bundle})}ZN.length=0}o.recycle(),o=null;break;case Jl.PATH:if(nu.has(a.bundle)){if(s=nu.get(a.bundle).config,(c=s.getInfoWithPath(a.path,a.type))&&c.redirect){if(!nu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=nu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle "+a.bundle+" doesn't contain "+a.path);o.config=s,o.uuid=c.uuid,o.info=c}o.ext=a.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case Jl.SCENE:if(!a.bundle){var f=nu.find((function(e){return!!e.getSceneInfo(a.scene)}));a.bundle=f&&f.name}if(nu.has(a.bundle)){if(s=nu.get(a.bundle).config,(c=s.getSceneInfo(a.scene))&&c.redirect){if(!nu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=nu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+a.scene);o.config=s,o.uuid=c.uuid,o.info=c}break;case"__isNative__":o.isNative=a.__isNative__;break;case Jl.URL:o.url=a.url,o.uuid=a.uuid||a.url,o.ext=a.ext||gn(a.url),o.isNative=void 0===a.__isNative__||a.__isNative__;break;default:o.options[l]=a[l]}if(!o)break}if(!o)return"continue";if(e.output.push(o),!o.uuid&&!o.url)throw new Error("Can not parse this input:"+JSON.stringify(a))},r=0;r<n.length;r++)i(r);return null}function $N(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var r=t[n];if(!r.url){var a,o,s=r.config;o=r.isNative?s&&s.nativeBase?s.base+s.nativeBase:i.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:i.assetManager.generalImportBase;var c=r.uuid,l="";r.info&&(l=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),a=".ttf"===r.ext?o+"/"+c.slice(0,2)+"/"+c+l+"/"+r.options.__nativeName__:o+"/"+c.slice(0,2)+"/"+c+l+r.ext,r.url=a}}return null}var eB=e("AssetManager",function(){function e(){this.pipeline=iu.append(KN).append(XN),this.fetchPipeline=ru.append(KN).append(HN),this.transformPipeline=au.append(JN).append($N),this.bundles=nu,this.assets=$l,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=zm,this.force=!1,this.allowImageBitmap=!ch.isMobile,this.utils=Ru,this.downloader=MN,this.parser=qN,this.packManager=kN,this.cacheAsset=!0,this.cacheManager=null,this.presets=su,this.factory=GN,this.preprocessPipe=KN,this.fetchPipe=HN,this.loadPipe=XN,this.references=null,this._releaseManager=oN,this._files=eu,this._parsed=tu,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return nu.get(e)||null},t.removeBundle=function(e){e._destroy(),nu.remove(e.name)},t.loadAny=function(e,t,n,i){var r=pN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"default",e=Array.isArray(e)?e.slice():e;var c=cu.create({input:e,onProgress:o,onComplete:vN(s),options:a});iu.async(c)},t.preloadAny=function(e,t,n,i){var r=pN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=cu.create({input:e,onProgress:o,onComplete:vN(s),options:a});ru.async(c)},t.loadRemote=function(e,t,n){var i=pN(t,void 0,n),r=i.options,a=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),a&&a(t,n)):GN.create(e,n,r.ext||gn(e),r,(function(e,t){a&&a(e,t)}))}))):vN(a)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=pN(t,void 0,n),r=i.options,a=i.onComplete,o=xn(e);this.bundles.has(o)?vN(a)(null,this.getBundle(o)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),a&&a(t,n)):GN.create(e,n,"bundle",r,(function(e,t){a&&a(e,t)}))})))},t.releaseAsset=function(e){oN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){$l.forEach((function(e){oN.tryRelease(e)}))},t.releaseAll=function(){$l.forEach((function(e){oN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},B(e,[{key:"main",get:function(){return nu.get(ou.MAIN)||null}},{key:"resources",get:function(){return nu.get(ou.RESOURCES)||null}}]),e}());eB.Pipeline=Zl,eB.Task=cu,eB.Cache=Ql,eB.RequestItem=QN,eB.Bundle=gN,eB.BuiltinBundleName=ou;var tB=e("assetManager",i.assetManager=new eB);i.AssetManager=eB;var nB=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],iB=[".mp3",".ogg",".wav",".m4a"];function rB(){return!0}var aB={transformURL:function(e){var t=du(e);if(!t)return e;var n=nu.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var a=!1;if(".ttf"===gn(e)&&(a=!0),a){var o=Sn(e),s=xn(e);e=o+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},oB=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=dN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var a=i[r];"string"==typeof a?i[r]={url:a,__isNative__:!0}:(a.type&&(a.ext="."+a.type,a.type=void 0),a.url&&(a.__isNative__=!0))}var o=[],s=[];tB.loadAny(i,null,(function(e,n,i){i.content&&(nB.includes(i.ext)?o.push(i.content):iB.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var a=function(e){var n=t[e];if(!(n instanceof Du)){var r=n,a=i[e].url;o.includes(r)?GN.create(a,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&GN.create(a,n,".mp3",{},(function(n,i){r=t[e]=i})),$l.add(a,r)}},c=0;c<t.length;c++)a(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:rB,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return tB.assets.has(e)?{content:tB.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete,c=gn(e);c&&!yN.getInfoWithPath(e,a)&&(e=e.slice(0,-c.length)),yN.load(e,a,o,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=gn(t);i&&!yN.getInfoWithPath(t,a)&&(e[n]=t.slice(0,-i.length))})),yN.load(e,a,o,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;yN.loadDir(e,a,o,(function(t,n){var i=[];t||(i=yN.getDirWithPath(e,a).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return $l.has(e)?$l.get(e):yN.get(e,t)},t.getResCount=function(){return $l.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return zm.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);MN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);qN.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=$l.get(n)),tB.releaseAsset(n)}else e&&("string"==typeof e&&(e=$l.get(e)),tB.releaseAsset(e))},t.releaseAsset=function(e){tB.releaseAsset(e)},t.releaseRes=function(e,t){yN.release(e,t)},t.releaseAll=function(){tB.releaseAll(),$l.clear()},t.removeItem=function(e){return!!$l.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=zm.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},B(e,[{key:"onProgress",set:function(e){sN=e}},{key:"_cache",get:function(){if($l instanceof Ql)return $l._map;var e={};return $l.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return aB}},{key:"downloader",get:function(){return MN}},{key:"loader",get:function(){return tB.parser}}]),e}()),sB=e("loader",new oB),cB=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,tB.init(e),e.rawAssets&&yN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:ou.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){tB.loadAny(e,t)}}),lB=e("url",{});Nn(lB,"url",[{name:"normalize",target:tB.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?yu({path:Tn(e.substr(10)),bundle:ou.RESOURCES,__isNative__:!0,ext:gn(e)}):""}}]),Bn(cB,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),Bn(sB,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),Nn(i,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return sB}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return cB}},{name:"Pipeline",target:eB,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return lB}}]),Bn(i,"cc",[{name:"LoadingItems",suggest:w(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),Nn($e,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:MN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),Nn(VM,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return tB.main?null===(t=tB.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),Nn(kM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return tB.main&&tB.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var uB,hB,_B,fB,pB,dB,mB,vB,gB,yB,xB,SB,TB,EB,AB=oN._autoRelease;oN._autoRelease=function(e,t,n){AB.call(oN,e,t,n);for(var i=sB._autoReleaseSetting,r=Object.keys(i),a=0;a<r.length;a++){var o=r[a];if(!0===i[o]){var s=$l.get(o);s&&oN.tryRelease(s)}}};var CB,bB,PB,RB,IB,wB,DB,OB,MB,NB,BB,FB,LB,zB,UB,GB,kB,HB,VB,jB,WB,qB,XB,YB,KB,QB,ZB,JB,$B,eF,tF,nF,iF,rF,aF,oF,sF,cF,lF,uF,hF,_F,fF,pF,dF,mF,vF,gF,yF,xF,SF,TF,EF,AF,CF,bF,PF,RF,IF,wF,DF,OF,MF,NF,BF,FF,LF,zF=e("EventHandler",(uB=nl("cc.ClickEvent"),hB=Bl(i.Node),_B=El(),fB=El(),pB=El(),dB=El(),uB((EB=function(){function e(){q(this,"target",gB,this),q(this,"component",yB,this),q(this,"_componentId",xB,this),q(this,"handler",SB,this),q(this,"customEventData",TB,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var a=0,o=t.length;a<o;a++){var s=t[a];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(i.isValid(t)){this._genCompIdIfNeeded();var n=i.js._getClassById(this._componentId),r=t.getComponent(n);if(i.isValid(r)){var a=r[this.handler];"function"==typeof a&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),a.apply(r,e))}}},t._compName2Id=function(e){var t=i.js.getClassByName(e);return i.js._getClassId(t)},t._compId2Name=function(e){var t=i.js._getClassById(e);return i.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},B(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),gB=X((vB=EB).prototype,"target",[cl,hB,cl,_B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yB=X(vB.prototype,"component",[cl,yl,fB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xB=X(vB.prototype,"_componentId",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SB=X(vB.prototype,"handler",[cl,yl,pB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TB=X(vB.prototype,"customEventData",[cl,yl,dB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mB=vB))||mB));i.Component.EventHandler=zF;var UF,GF,kF,HF,VF,jF,WF,qF,XF,YF,KF,QF=new di,ZF=Ye(qd),JF=Ye(Wd),$F=Ye(Xd),eL=Ye(Kd),tL=Ye(Yd),nL=Ye({SKYBOX:fm|na.DEPTH_STENCIL,SOLID_COLOR:na.ALL,DEPTH_ONLY:na.DEPTH_STENCIL,DONT_CLEAR:na.NONE}),iL=(CB=nl("cc.Camera"),bB=gl(),PB=pl(),RB=Rl(),IB=El(),wB=Bl(Mp.BitMask),DB=Rl(),OB=El(),MB=Bl(nL),NB=Rl(),BB=El(),FB=Rl(),LB=El(),zB=Rl(),UB=El(),GB=Rl(),kB=El(),HB=Bl(ZF),VB=Rl(),jB=El(),WB=Bl(JF),qB=Rl(),XB=El(),YB=Rl(),KB=El(),QB=Rl(),ZB=El(),JB=Rl(),$B=El(),eF=Rl(),tF=El(),nF=Bl($F),iF=Rl(),rF=El(),aF=Bl(eL),oF=Rl(),sF=El(),cF=Bl(tL),lF=Rl(),uF=El(),hF=Rl(),_F=El(),fF=Bl(vT),pF=Rl(),dF=El(),UF=CB(mF=bB(mF=PB(mF=fl((LF=FF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_projection",gF,V(t)),q(t,"_priority",yF,V(t)),q(t,"_fov",xF,V(t)),q(t,"_fovAxis",SF,V(t)),q(t,"_orthoHeight",TF,V(t)),q(t,"_near",EF,V(t)),q(t,"_far",AF,V(t)),q(t,"_color",CF,V(t)),q(t,"_depth",bF,V(t)),q(t,"_stencil",PF,V(t)),q(t,"_clearFlags",RF,V(t)),q(t,"_rect",IF,V(t)),q(t,"_aperture",wF,V(t)),q(t,"_shutter",DF,V(t)),q(t,"_iso",OF,V(t)),q(t,"_screenScale",MF,V(t)),q(t,"_visibility",NF,V(t)),q(t,"_targetTexture",BF,V(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}L(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=Yv.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=ur.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new di),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new di),!this._camera)return n;this.worldToScreen(e,QF);var r=t.getComponent("cc.UITransform"),a=$M.getVisibleSize(),o=QF.x-.5*this._camera.width,s=QF.y-.5*this._camera.height;return QF.x=o/i.view.getScaleX()+.5*a.width,QF.y=s/i.view.getScaleY()+.5*a.height,r&&r.convertToNodeSpaceAR(QF,n),n},n._createCamera=function(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=Zn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},B(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Wd.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=Zn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}}]),t}(Ju),FF.ProjectionType=ZF,FF.FOVAxis=JF,FF.ClearFlag=nL,FF.Aperture=$F,FF.Shutter=eL,FF.ISO=tL,FF.TARGET_TEXTURE_CHANGE="tex-change",gF=X((vF=LF).prototype,"_projection",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZF.PERSPECTIVE}}),yF=X(vF.prototype,"_priority",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xF=X(vF.prototype,"_fov",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),SF=X(vF.prototype,"_fovAxis",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JF.VERTICAL}}),TF=X(vF.prototype,"_orthoHeight",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),EF=X(vF.prototype,"_near",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AF=X(vF.prototype,"_far",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),CF=X(vF.prototype,"_color",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi("#333333")}}),bF=X(vF.prototype,"_depth",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),PF=X(vF.prototype,"_stencil",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RF=X(vF.prototype,"_clearFlags",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nL.SOLID_COLOR}}),IF=X(vF.prototype,"_rect",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi(0,0,1,1)}}),wF=X(vF.prototype,"_aperture",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $F.F16_0}}),DF=X(vF.prototype,"_shutter",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eL.D125}}),OF=X(vF.prototype,"_iso",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tL.ISO100}}),MF=X(vF.prototype,"_screenScale",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NF=X(vF.prototype,"_visibility",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qd}}),BF=X(vF.prototype,"_targetTexture",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(vF.prototype,"priority",[RB,IB],Object.getOwnPropertyDescriptor(vF.prototype,"priority"),vF.prototype),X(vF.prototype,"visibility",[wB,DB,OB],Object.getOwnPropertyDescriptor(vF.prototype,"visibility"),vF.prototype),X(vF.prototype,"clearFlags",[MB,NB,BB],Object.getOwnPropertyDescriptor(vF.prototype,"clearFlags"),vF.prototype),X(vF.prototype,"clearColor",[FB,LB],Object.getOwnPropertyDescriptor(vF.prototype,"clearColor"),vF.prototype),X(vF.prototype,"clearDepth",[zB,UB],Object.getOwnPropertyDescriptor(vF.prototype,"clearDepth"),vF.prototype),X(vF.prototype,"clearStencil",[GB,kB],Object.getOwnPropertyDescriptor(vF.prototype,"clearStencil"),vF.prototype),X(vF.prototype,"projection",[HB,VB,jB],Object.getOwnPropertyDescriptor(vF.prototype,"projection"),vF.prototype),X(vF.prototype,"fovAxis",[WB,qB,XB],Object.getOwnPropertyDescriptor(vF.prototype,"fovAxis"),vF.prototype),X(vF.prototype,"fov",[YB,KB],Object.getOwnPropertyDescriptor(vF.prototype,"fov"),vF.prototype),X(vF.prototype,"orthoHeight",[QB,ZB],Object.getOwnPropertyDescriptor(vF.prototype,"orthoHeight"),vF.prototype),X(vF.prototype,"near",[JB,$B],Object.getOwnPropertyDescriptor(vF.prototype,"near"),vF.prototype),X(vF.prototype,"far",[eF,tF],Object.getOwnPropertyDescriptor(vF.prototype,"far"),vF.prototype),X(vF.prototype,"aperture",[nF,iF,rF],Object.getOwnPropertyDescriptor(vF.prototype,"aperture"),vF.prototype),X(vF.prototype,"shutter",[aF,oF,sF],Object.getOwnPropertyDescriptor(vF.prototype,"shutter"),vF.prototype),X(vF.prototype,"iso",[cF,lF,uF],Object.getOwnPropertyDescriptor(vF.prototype,"iso"),vF.prototype),X(vF.prototype,"rect",[hF,_F],Object.getOwnPropertyDescriptor(vF.prototype,"rect"),vF.prototype),X(vF.prototype,"targetTexture",[fF,pF,dF],Object.getOwnPropertyDescriptor(vF.prototype,"targetTexture"),vF.prototype),mF=vF))||mF)||mF)||mF)||mF,e({Camera:UF,CameraComponent:UF}),UF);i.Camera=iL;var rL,aL,oL,sL,cL,lL,uL,hL,_L={parent:null,owner:null,subModelIdx:0},fL=e("RenderableComponent",(GF=nl("cc.RenderableComponent"),kF=Bl([Cg]),HF=Bl(Cg),VF=Rl(),jF=Tl(),GF((KF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_materials",XF,V(t)),q(t,"_visFlags",YF,V(t)),t._materialInstances=[],t._models=[],t}L(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof kg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){_L.parent=this._materials[e],_L.owner=this,_L.subModelIdx=e;var t=new kg(_L);_L.parent=null,_L.owner=null,_L.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){A(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},B(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(Ju),XF=X((qF=KF).prototype,"_materials",[kF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YF=X(qF.prototype,"_visFlags",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mp.Enum.NONE}}),X(qF.prototype,"sharedMaterials",[HF,VF,jF],Object.getOwnPropertyDescriptor(qF.prototype,"sharedMaterials"),qF.prototype),WF=qF))||WF));function pL(e){return"string"==typeof e||"number"==typeof e}i.RenderableComponent=fL,Nn(iL,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),Nn(iL.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),i.CameraComponent=iL,ke.setClassAlias(iL,"cc.CameraComponent");var dL,mL,vL,gL,yL,xL,SL,TL,EL,AL,CL,bL,PL,RL,IL,wL,DL,OL,ML,NL,BL,FL,LL=nl("cc.animation.HierarchyPath")((sL=function(){function e(e){q(this,"path",oL,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getChildByPath(this.path)||(A(3926,e.name,this.path),null):(A(3925),null)},e}(),oL=X((aL=sL).prototype,"path",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rL=aL))||rL,zL=nl("cc.animation.ComponentPath")((hL=function(){function e(e){q(this,"component",uL,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getComponent(this.component)||(A(3928,e.name,this.component),null):(A(3927),null)},e}(),uL=X((lL=hL).prototype,"component",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cL=lL))||cL,UL=nl("cc.animation.UniformProxyFactory")((xL=function(){function e(e,t){q(this,"passIndex",vL,this),q(this,"uniformName",gL,this),q(this,"channelIndex",yL,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(kv.getTypeFromHandle(n)<Er.SAMPLER1D){var r=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,Er.FLOAT);if(!r)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=W(e.shaderInfo.blocks);!(n=i()).done;)for(var r,a=W(n.value.members);!(r=a()).done;){var o=r.value;if(o.name===t)return o.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(r,e)}}:{set:function(e){t.setUniform(r,e)}}}var a=kv.getBindingFromHandle(n),o=t.properties[this.uniformName],s=o&&o.value?o.value+"-texture":yv(o.type),c=Nv.get(s);return c||(p("Illegal texture default value: "+s+"."),c=Nv.get("default-texture")),{set:function(e){e||(e=c);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(a,n),e instanceof Om&&t.bindSampler(a,i.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),vL=X((mL=xL).prototype,"passIndex",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gL=X(mL.prototype,"uniformName",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yL=X(mL.prototype,"channelIndex",[Ol],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),dL=mL))||dL,GL=nl("cc.animation.MorphWeightValueProxy")((CL=function(){function e(){q(this,"subMeshIndex",EL,this),q(this,"shapeIndex",AL,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),EL=X((TL=CL).prototype,"subMeshIndex",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AL=X(TL.prototype,"shapeIndex",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SL=TL))||SL,kL=nl("cc.animation.MorphWeightsValueProxy")((IL=function(){function e(){q(this,"subMeshIndex",RL,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),RL=X((PL=IL).prototype,"subMeshIndex",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bL=PL))||bL,HL=nl("cc.animation.MorphWeightsAllValueProxy")(wL=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,a=0;a<r;++a)e.setWeights(t,a)}}},e}())||wL;function VL(e,t,n,i){var r,a,o,s,c,l,u=new t,h=new t,_=new t,f=nl(e)((l=function(){function e(e,n,i){q(this,"dataPoint",o,this),q(this,"inTangent",s,this),q(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var a=this.dataPoint,o=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,p=s-c;return u=n(u,a,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,o,f),u=i(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},e}(),o=X((a=l).prototype,"dataPoint",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=X(a.prototype,"inTangent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=X(a.prototype,"outTangent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=a))||r;if(t===Ti){var p=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=p.call(this,e,t,n);return Ti.normalize(i,i),i}}return f}var jL=e("CubicSplineVec2Value",VL("cc.CubicSplineVec2Value",Ni,Ni.multiplyScalar,Ni.scaleAndAdd));i.CubicSplineVec2Value=jL;var WL=e("CubicSplineVec3Value",VL("cc.CubicSplineVec3Value",di,di.multiplyScalar,di.scaleAndAdd));i.CubicSplineVec3Value=WL;var qL=e("CubicSplineVec4Value",VL("cc.CubicSplineVec4Value",zi,zi.multiplyScalar,zi.scaleAndAdd));i.CubicSplineVec4Value=qL;var XL=e("CubicSplineQuatValue",VL("cc.CubicSplineQuatValue",Ti,Ti.multiplyScalar,Ti.scaleAndAdd));i.CubicSplineQuatValue=XL;var YL=e("CubicSplineNumberValue",nl("cc.CubicSplineNumberValue")((FL=function(){function e(e,t,n){q(this,"dataPoint",ML,this),q(this,"inTangent",NL,this),q(this,"outTangent",BL,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,a=t*t*t,o=t*t;return i*(2*a-3*o+1)+this.outTangent*n*(a-2*o+t)+r*(-2*a+3*o)+e.inTangent*n*(a-o)},t.getNoLerp=function(){return this.dataPoint},e}(),ML=X((OL=FL).prototype,"dataPoint",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NL=X(OL.prototype,"inTangent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BL=X(OL.prototype,"outTangent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DL=OL))||DL);i.CubicSplineNumberValue=YL;var KL,QL,ZL,JL,$L,ez,tz,nz,iz,rz,az,oz,sz,cz,lz,uz,hz,_z,fz,pz,dz,mz,vz,gz,yz,xz,Sz,Tz=Symbol("CreateEval"),Ez=Symbol("NormalizedFollow"),Az=Symbol("ConvertAsTrsPath"),Cz=Symbol("TrackBinding"),bz=nl("cc.animation.TrackPath")((JL=function(){function e(){q(this,"_paths",ZL,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new LL(e)),this},t.toComponent=function(e){var t=new zL("string"==typeof e?e:ke.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof LL},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof zL},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Ez](e,t,n)},t[Az]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var a=t[i];if(!(a instanceof LL))break;a.path&&(r?r+="/"+a.path:r=a.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[Ez]=function(e,t,n){for(var i=this._paths,r=e,a=t;a<n;++a){var o=i[a];if(pL(o)){if(!(o in r))return A(3929,o),null;r=r[o]}else r=o.get(r);if(null===r)break}return r},B(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),ZL=X((QL=JL).prototype,"_paths",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KL=QL))||KL,Pz=nl("cc.animation.TrackBinding")($L=_l((iz=function(){function e(){q(this,"path",tz,this),q(this,"proxy",nz,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[Az]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,a=i.length,o=a-1;if(0===a||!i.isPropertyAt(o)&&!i.isElementAt(o)||r){if(r){var s=i[Ez](e,0,a);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return b(3921),null}var h,_=i.isPropertyAt(o)?i.parsePropertyAt(o):i.parseElementAt(o),f=i[Ez](e,0,a-1);return null===f?null:t&&f instanceof qC&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}},e}(),tz=X((ez=iz).prototype,"path",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bz}}),nz=X(ez.prototype,"proxy",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$L=ez))||$L)||$L,Rz=nl("cc.animation.Track")((sz=function(){function e(){q(this,"_binding",oz,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=W(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},B(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:Cz,get:function(){return this._binding}}]),e}(),oz=X((az=sz).prototype,"_binding",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pz}}),rz=az))||rz,Iz=nl("cc.animation.Channel")((hz=function(){function e(e){this.name="",q(this,"_curve",uz,this),this._curve=e}return B(e,[{key:"curve",get:function(){return this._curve}}]),e}(),uz=X((lz=hz).prototype,"_curve",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cz=lz))||cz,wz=nl("cc.animation.SingleChannelTrack")((dz=function(e){function t(){var t;return q(t=e.call(this)||this,"_channel",pz,V(t)),t._channel=new Iz(t.createCurve()),t}L(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Tz]=function(){var e=this._channel.curve;return new Dz(e)},B(t,[{key:"channel",get:function(){return this._channel}}]),t}(Rz),pz=X((fz=dz).prototype,"_channel",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_z=fz))||_z,Dz=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),Oz=nl("cc.animation.RealTrack")(mz=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t.prototype.createCurve=function(){return new pf},t}(wz))||mz;function Mz(e){return 0===e.keyFramesCount?void 0:e}var Nz,Bz,Fz,Lz,zz,Uz,Gz,kz,Hz,Vz,jz=["X","Y","Z","W"],Wz=nl("cc.animation.VectorTrack")((Sz=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",yz,V(t)),q(t,"_nComponents",xz,V(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Iz(new pf);i.name=jz[n],t._channels[n]=i}return t}L(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){switch(this._nComponents){default:case 2:return new qz(Mz(this._channels[0].curve),Mz(this._channels[1].curve));case 3:return new Xz(Mz(this._channels[0].curve),Mz(this._channels[1].curve),Mz(this._channels[2].curve));case 4:return new Yz(Mz(this._channels[0].curve),Mz(this._channels[1].curve),Mz(this._channels[2].curve),Mz(this._channels[3].curve))}},B(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(Rz),yz=X((gz=Sz).prototype,"_channels",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xz=X(gz.prototype,"_nComponents",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),vz=gz))||vz,qz=function(){function e(e,t){this._result=new Ni,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Ni.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),Xz=function(){function e(e,t,n){this._result=new di,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||di.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),Yz=function(){function e(e,t,n,i){this._result=new zi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||zi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),Kz=nl("cc.animation.QuatTrack")(Nz=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.createCurve=function(){return new ep},n[Tz]=function(){return new Qz(this.channels()[0].curve)},t}(wz))||Nz,Qz=function(){function e(e){this._result=new Ti,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),Zz=["Red","Green","Blue","Alpha"],Jz=nl("cc.animation.ColorTrack")((zz=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",Lz,V(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Iz(new pf);i.name=Zz[n],t._channels[n]=i}return t}L(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){return new $z(Mz(this._channels[0].curve),Mz(this._channels[1].curve),Mz(this._channels[2].curve),Mz(this._channels[3].curve))},t}(Rz),Lz=X((Fz=zz).prototype,"_channels",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Bz=Fz))||Bz,$z=function(){function e(e,t,n,i){this._result=new fi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||fi.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),eU=["Width","Height"],tU=nl("cc.animation.SizeTrack")((Hz=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",kz,V(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new Iz(new pf);i.name=eU[n],t._channels[n]=i}return t}L(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){return new nU(Mz(this._channels[0].curve),Mz(this._channels[1].curve))},t}(Rz),kz=X((Gz=Hz).prototype,"_channels",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Uz=Gz))||Uz,nU=function(){function e(e,t){this._result=new ki,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),iU=nl("cc.animation.ObjectTrack")(Vz=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t.prototype.createCurve=function(){return new dp},t}(wz))||Vz;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:UL,MorphWeightValueProxy:GL,MorphWeightsValueProxy:kL,MorphWeightsAllValueProxy:HL,Track:Rz,TrackPath:bz,RealTrack:Oz,VectorTrack:Wz,QuatTrack:Kz,ColorTrack:Jz,SizeTrack:tU,ObjectTrack:iU,isPropertyPath:pL,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:LL,ComponentPath:zL,CubicSplineVec2Value:jL,CubicSplineVec3Value:WL,CubicSplineVec4Value:qL,CubicSplineQuatValue:XL,CubicSplineNumberValue:YL}));var rU=Symbol("BakeNodeCurves"),aU=function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&i.director.root.dataPoolManager.releaseAnimationClip(t);var r=Math.ceil(t.sample*t.duration)+1,a=t.sample;n=t[rU](0,a,r),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}();aU.pool=new Map;var oU=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,a=e.length;r<a;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?uU:Xc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());i.RatioSampler=oU;var sU=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,a=Object.keys(t.easingMethods);r<a.length;r++){var o=a[r];this.types[o]=i(t.easingMethods[o])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=yU(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var a=this.types?this.types[t]:this.type,o=r-n,s=(e-n)/o;if(a&&(s=lU(s,a)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,o*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function cU(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function lU(e,t){if("string"==typeof t){var n=$_[t];n?e=n(e):b(3906,t)}else Array.isArray(t)&&(e=Qf(t,e));return e}function uU(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var a=(t=(t-i)/(r-i))/(1/n),o=0|a,s=1e-6;return a-o<s?o:o+1-a<s?o+1:~(o+1)}sU.Linear=null,i.AnimCurve=sU,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),i.sampleAnimationCurve=cU;var hU,_U,fU,pU,dU,mU,vU,gU,yU=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return Qn;if("object"==typeof t&&t.constructor){if(t instanceof Ti)return n=new Ti,function(e,t,i){return Ti.slerp(n,e,t,i)};if(t instanceof Je)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return Qn;if("function"==typeof t.lerp)return e}var n}}}(),xU=nl("cc.animation.UntypedTrackChannel")((pU=function(e){function t(){var t;return q(t=e.call(this,new pf)||this,"property",fU,V(t)),t}return L(t,e),t}(Iz),fU=X((_U=pU).prototype,"property",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hU=_U))||hU,SU=nl("cc.animation.UntypedTrack")((gU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_channels",vU,V(t)),t}L(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Tz]=function(e){var t=this;if(!e.getValue)throw new Error(w(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(w(3931));case i instanceof Ni:return new qz(n("x"),n("y"));case i instanceof di:return new Xz(n("x"),n("y"),n("z"));case i instanceof zi:return new Yz(n("x"),n("y"),n("z"),n("w"));case i instanceof fi:return new $z(n("r"),n("g"),n("b"),n("a"));case i instanceof ki:return new nU(n("width"),n("height"))}},n.addChannel=function(e){var t=new xU;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new Wz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var a=r.channels(),o=a[0],s=a[1],c=a[2],l=a[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",o),n("y",s)}return r;case"color":var u=new Jz,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return n("r",_),n("g",f),n("b",p),n("a",d),n("x",_),n("y",f),n("z",p),n("w",d),u;case"size":}return null},t}(Rz),vU=X((mU=gU).prototype,"_channels",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dU=mU))||dU,TU=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,a=function(e,t,n){for(var i,r=new bz,a=W(t);!(i=a()).done;){var o=i.value;"string"==typeof o?r.toProperty(o):"number"==typeof o?r.toElement(o):o instanceof LL?r.toHierarchy(o.path):o instanceof zL?r.toComponent(o.component):r.toCustomized(o)}e.path=r,e.proxy=n},o=r.map((function(e){var n=new SU;return a(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new AU(s,l.length),f=function(e){a(e,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return A(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return A(3933),"continue";var d=r.modifiers[0],m=o[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void A(3934);var e;if(p)e=p;else{var n=new Oz;f(n),t.push(n),e=n.channel.curve}var i=h?Hl.LINEAR:Hl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case EU(c,Ni):case EU(c,di):case EU(c,zi):var r=u instanceof Ni?2:u instanceof di?3:4,a=new Wz;f(a),a.componentsCount=r;var o=a.channels(),s=o[0].curve,d=o[1].curve,m=o[2].curve,v=o[3].curve,g=h?Hl.LINEAR:Hl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),d.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(d)}return void t.push(a);case EU(c,Ti):var x=new Kz;f(x);var S=h?Vf.SLERP:Vf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:Ti.clone(e),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void t.push(x);case EU(c,fi):var T=new Jz;f(T);var E=T.channels(),C=E[0].curve,b=E[1].curve,P=E[2].curve,R=E[3].curve,I=h?Hl.LINEAR:Hl.CONSTANT,w=function(e){return{value:e,interpolationMode:I}};return C.assignSorted(l,c.map((function(e){return w(e.r)}))),_.convert(C),b.assignSorted(l,c.map((function(e){return w(e.g)}))),_.convert(b),P.assignSorted(l,c.map((function(e){return w(e.b)}))),_.convert(P),R.assignSorted(l,c.map((function(e){return w(e.a)}))),_.convert(R),void t.push(T);case EU(c,ki):var D=new tU;f(D);var O=D.channels(),M=O[0].curve,N=O[1].curve,B=h?Hl.LINEAR:Hl.CONSTANT,F=function(e){return{value:e,interpolationMode:B}};return M.assignSorted(l,c.map((function(e){return F(e.width)}))),_.convert(M),N.assignSorted(l,c.map((function(e){return F(e.height)}))),_.convert(N),void t.push(D);case EU(c,YL):var L=new Oz;f(L);var z=h?Hl.CUBIC:Hl.CONSTANT;return L.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(L);case EU(c,jL):case EU(c,WL):case EU(c,qL):var U=u instanceof jL?2:u instanceof WL?3:4,G=new Wz;f(G),G.componentsCount=U;var k=G.channels(),H=k[0],V=k[1],j=k[2],W=k[3],q=h?Hl.LINEAR:Hl.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(U){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(G);case c.every((function(e){return e instanceof XL})):A(3935)}var Y=new iU;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=W(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new oU(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new sU(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},B(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function EU(e,t){return e.every((function(e){return e instanceof t}))}var AU=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,a,o,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S,T,E=this._easingMethods;if(E){var A=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(E)&&E.length;for(var C=A-1,b=0;b<C;++b){var P=E[b];P&&(Array.isArray(P)?(t=P,n=e.getKeyframeTime(b),i=e.getKeyframeValue(b),r=e.getKeyframeTime(b+1),a=e.getKeyframeValue(b+1),o=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,T=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(a.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),x=Math.sqrt(p*p+d*d)*g,S=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Hl.CUBIC,i.tangentWeightMode=(o=i.tangentWeightMode)===jl.NONE?jl.RIGHT:o===jl.LEFT?jl.BOTH:o,i.rightTangent=y,i.rightTangentWeight=x,a.tangentWeightMode=function(e){return e===jl.NONE?jl.LEFT:e===jl.RIGHT?jl.BOTH:e}(a.tangentWeightMode),a.leftTangent=S,a.leftTangentWeight=T):CU(P,e,b))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var a=t[r];a&&(Array.isArray(a)?e.getKeyframeValue(r).easingMethod=a.slice():bU(a,e,r))}}}},B(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function CU(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=nG[e];r===J_.CONSTANT?i.interpolationMode=Hl.CONSTANT:(i.interpolationMode=Hl.LINEAR,i.easingMethod=r)}function bU(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=nG[e];i.easingMethod=r}var PU,RU,IU,wU,DU,OU,MU,NU,BU,FU,LU,zU,UU,GU,kU,HU,VU,jU,WU,qU,XU,YU,KU,QU,ZU,JU,$U,eG,tG,nG={constant:J_.CONSTANT,linear:J_.LINEAR,quadIn:J_.QUAD_IN,quadOut:J_.QUAD_OUT,quadInOut:J_.QUAD_IN_OUT,quadOutIn:J_.QUAD_OUT_IN,cubicIn:J_.CUBIC_IN,cubicOut:J_.CUBIC_OUT,cubicInOut:J_.CUBIC_IN_OUT,cubicOutIn:J_.CUBIC_OUT_IN,quartIn:J_.QUART_IN,quartOut:J_.QUART_OUT,quartInOut:J_.QUART_IN_OUT,quartOutIn:J_.QUART_OUT_IN,quintIn:J_.QUINT_IN,quintOut:J_.QUINT_OUT,quintInOut:J_.QUINT_IN_OUT,quintOutIn:J_.QUINT_OUT_IN,sineIn:J_.SINE_IN,sineOut:J_.SINE_OUT,sineInOut:J_.SINE_IN_OUT,sineOutIn:J_.SINE_OUT_IN,expoIn:J_.EXPO_IN,expoOut:J_.EXPO_OUT,expoInOut:J_.EXPO_IN_OUT,expoOutIn:J_.EXPO_OUT_IN,circIn:J_.CIRC_IN,circOut:J_.CIRC_OUT,circInOut:J_.CIRC_IN_OUT,circOutIn:J_.CIRC_OUT_IN,elasticIn:J_.ELASTIC_IN,elasticOut:J_.ELASTIC_OUT,elasticInOut:J_.ELASTIC_IN_OUT,elasticOutIn:J_.ELASTIC_OUT_IN,backIn:J_.BACK_IN,backOut:J_.BACK_OUT,backInOut:J_.BACK_IN_OUT,backOutIn:J_.BACK_OUT_IN,bounceIn:J_.BOUNCE_IN,bounceOut:J_.BOUNCE_OUT,bounceInOut:J_.BOUNCE_IN_OUT,bounceOutIn:J_.BOUNCE_OUT_IN,smooth:J_.SMOOTH,fade:J_.FADE};function iG(){throw new Error("split() only valid in Editor.")}nl("cc.animation.ExoticAnimation")((IU=function(){function e(){q(this,"_nodeAnimations",RU,this)}var t=e.prototype;return t.createEvaluator=function(e){return new fG(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new rG(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return iG()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),RU=X((PU=IU).prototype,"_nodeAnimations",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PU));var rG=nl("cc.animation.ExoticNodeAnimation")((FU=function(){function e(e){q(this,"_path",OU,this),q(this,"_position",MU,this),q(this,"_rotation",NU,this),q(this,"_scale",BU,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new uG(e,new cG(t))},t.createRotation=function(e,t){this._rotation=new uG(e,new lG(t))},t.createScale=function(e,t){this._scale=new uG(e,new cG(t))},t.createEvaluator=function(e){return new pG(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return iG()},t.toHashString=function(){var e,t,n,i,r,a;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(a=this._rotation)||void 0===a?void 0:a.toHashString())&&void 0!==r?r:"")},B(e,[{key:"path",get:function(){return this._path}}]),e}(),OU=X((DU=FU).prototype,"_path",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MU=X(DU.prototype,"_position",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NU=X(DU.prototype,"_rotation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BU=X(DU.prototype,"_scale",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wU=DU))||wU;function aG(e){return e.toPrecision(2)}function oG(e){return e.map(aG).join(" ")}var sG=nl("cc.animation.ExoticVectorLikeTrackValues")((kU=function(){function e(e){q(this,"_values",UU,this),q(this,"_isQuantized",GU,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=mG[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),a=Math.max(e,a)}));var o=a-r,s=n.from(e,(function(e){return(e-r)/o*i}));return new DG(vG(e),s,o,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():oG(t))},B(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:vG(this._values)}}]),e}(),UU=X((zU=kU).prototype,"_values",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GU=X(zU.prototype,"_isQuantized",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LU=zU))||LU,cG=nl("cc.animation.ExoticVec3TrackValues")(HU=function(e){function t(){return e.apply(this,arguments)||this}L(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?NG(n,e,t):di.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(NG(o,e,i),NG(o,t,r)):(di.fromArray(i,o,3*e),di.fromArray(r,o,3*t)),di.lerp(a,i,r,n)},t}(sG))||HU,lG=nl("cc.animation.ExoticQuatTrackValues")(VU=function(e){function t(){return e.apply(this,arguments)||this}L(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?BG(n,e,t):Ti.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(BG(o,e,i),BG(o,t,r)):(Ti.fromArray(i,o,4*e),Ti.fromArray(r,o,4*t)),Ti.slerp(a,i,r,n)},t}(sG))||VU,uG=nl("cc.animation.ExoticTrack")((YU=function(){function e(e,t){q(this,"times",qU,this),q(this,"values",XU,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+oG(e)+"; values: "+t.toHashString()},e}(),qU=X((WU=YU).prototype,"times",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XU=X(WU.prototype,"values",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jU=WU))||jU;function hG(e,t){e.length,e.length;var n=0,i=0,r=Xc(e,t);if(r>=0)n=r;else{var a=~r,o=a-1;n=o;var s=e[a],c=e[o];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],a=e[i-1],o=Yn(t,r,a),s=Yn(n,r,a);this._timeOffset=o;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=hG(e,t),a=r.index,o=r.ratio,s=hG(e,n);return{fromIndex:a,fromRatio:o,toIndex:s.index,toRatio:s.ratio}}(e,o,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},B(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var _G,fG=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),pG=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=MG(t.times,t.values,di,e,"position",r)),n&&(this._rotation=MG(n.times,n.values,Ti,e,"rotation",r)),i&&(this._scale=MG(i.times,i.values,di,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),dG=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],a=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>a)n.just=!0,n.index=i-1;else{var o=Xc(e,t);if(o>=0)n.just=!0,n.index=o;else{var s=~o,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),mG={uint8:Uint8Array,uint16:Uint16Array};function vG(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return _G.FLOAT_32;case 8:return _G.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(_G||(_G={}));var gG,yG,xG,SG,TG,EG,AG,CG,bG,PG,RG,IG,wG,DG=nl("cc.animation.QuantizedFloatArray")((tG=function(){function e(e,t,n,i){void 0===i&&(i=0),q(this,"originalPrecision",ZU,this),q(this,"min",JU,this),q(this,"extent",$U,this),q(this,"values",eG,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+aG(t)+" "+aG(n)+" "+i.join(" ")},B(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),ZU=X((QU=tG).prototype,"originalPrecision",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),JU=X(QU.prototype,"min",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$U=X(QU.prototype,"extent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eG=X(QU.prototype,"values",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KU=QU))||KU;function OG(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function MG(e,t,n,i,r,a){var o=new Pz;o.path=(new bz).toHierarchy(i).toProperty(r);var s=a(o);return s?{runtimeBinding:s,evaluator:new dG(e,t,n)}:null}function NG(e,t,n){di.set(n,OG(e,3*t+0),OG(e,3*t+1),OG(e,3*t+2))}function BG(e,t,n){Ti.set(n,OG(e,4*t+0),OG(e,4*t+1),OG(e,4*t+2),OG(e,4*t+3))}var FG=Symbol("SearchForRootBonePath"),LG=Symbol("ExoticAnimation"),zG=e("AnimationClip",nl("cc.AnimationClip")((wG=IG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"sample",xG,V(t)),q(t,"speed",SG,V(t)),q(t,"wrapMode",TG,V(t)),q(t,"enableTrsBlending",EG,V(t)),q(t,"_duration",AG,V(t)),q(t,"_hash",CG,V(t)),t.frameRate=0,q(t,"_tracks",bG,V(t)),q(t,"_exoticAnimation",PG,V(t)),t._legacyData=void 0,t._legacyDataDirty=!1,q(t,"_events",RG,V(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}L(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,a=new iU;return a.path=(new bz).toComponent("cc.Sprite").toProperty("spriteFrame"),a.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(a),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new qG(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=i.director.root)||void 0===t?void 0:t.dataPoolManager)&&i.director.root.dataPoolManager.releaseAnimationClip(this),aU.destroy(this),e.prototype.destroy.call(this)},n[rU]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),a=r.length,o={},s=0;s<a;++s)o[r[s]]={transforms:Array.from({length:n},(function(){return new wi}))};var c=r.reduce((function(e,t){return e[t]=new kG,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return WG(n,t.property)}}),void 0),d=0;d<n;++d){var m=e+i*d;p.evaluate(m);for(var v=0;v<a;++v){var g=r[v];wi.copy(o[g].transforms[d],c[g].globalTransform)}for(var y=0;y<a;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:o}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,a=0;a<r;++a){var o=i[a];if(o instanceof SU){var s=o.upgrade(e);s&&(t.push(s),n.push(o))}}for(var c=n.length,l=0;l<c;++l)Ge.remove(i,n[l]);i.push.apply(i,t)},n[FG]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var a,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[Cz]);if(h){var _=u[Tz](h);o.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(a=this._exoticAnimation.createEvaluator(t)),new UG(o,a,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof qC){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var a=new GG,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Cz].parseTrsPath();if(h&&h.node===i){n.push(u);var _=WG(a,h.property);if(_){var f=u[Tz](_);o.push({binding:_,trackEval:f})}}}return new VG(r,this._duration,a,o)}A(3924)}else A(3923)}else b(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[Cz].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,a=t+1;a<n;++a){var o=e[a];if(o.rank!==i.rank)break;if(o.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new TU(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][Cz].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var a=this._exoticAnimation.collectAnimatedJoints(),o=a.length,s=0;s<o;++s)e.add(a[s]);return Array.from(e)},B(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=Ro(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),a=r.length,o=function(e){var a=r[e],o=a.frame/t._duration,s=n.findIndex((function(e){return e===o}));s<0&&(s=n.length,n.push(o),i.push({events:[]})),i[s].events.push({functionName:a.func,parameters:a.params})},s=0;s<a;++s)o(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:LG,get:function(){return this._exoticAnimation}},{key:LG,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Du),IG.WrapMode=kc,xG=X((yG=wG).prototype,"sample",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),SG=X(yG.prototype,"speed",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TG=X(yG.prototype,"wrapMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kc.Normal}}),EG=X(yG.prototype,"enableTrsBlending",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AG=X(yG.prototype,"_duration",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CG=X(yG.prototype,"_hash",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bG=X(yG.prototype,"_tracks",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PG=X(yG.prototype,"_exoticAnimation",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RG=X(yG.prototype,"_events",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gG=yG))||gG);i.AnimationClip=zG;var UG=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var a=t[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),GG=function(){function e(){this.position=new di,this.scale=new di(1,1,1),this.rotation=new Ti,this.eulerAngles=new di}return e.prototype.getTransform=function(e){wi.fromRTS(e,this.rotation,this.position,this.scale)},e}(),kG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new wi,t}return L(t,e),t.prototype.invalidate=function(){this._dirty=!0},B(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,wi.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&wi.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(GG),HG=new wi,VG=function(){function e(e,t,n,i){this._initialTransformCache=new wi,this._clipEndTransformCache=new wi,this._startTransformCache=new wi,this._endTransformCache=new wi,this._motionTransformCache=new wi,this._translationMotionCache=new di,this._rotationMotionCache=new Ti,this._scaleMotionCache=new di,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,a=this._scaleMotionCache,o=this._rootBone;wi.toRTS(n,r,i,a),di.add(i,i,o.position),o.setPosition(i),Ti.multiply(r,r,o.rotation),o.setRotation(r),di.multiply(a,a,o.scale),o.setScale(a)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,a=this._evaluateAt(e,this._startTransformCache);if(t<r){var o=this._evaluateAt(e+t,this._endTransformCache);jG(n,a,o)}else{wi.identity(n);var s=function(e,t){jG(HG,e,t),wi.multiply(n,n,HG)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(a,_),jG(HG,h,_);for(var p=0;p<l;++p)wi.multiply(n,n,HG);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var a=n[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function jG(e,t,n){wi.invert(e,t),wi.multiply(e,n,e)}function WG(e,t){switch(t){default:return;case"position":return{setValue:function(t){di.copy(e.position,t)}};case"rotation":return{setValue:function(t){Ti.copy(e.rotation,t)}};case"scale":return{setValue:function(t){di.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){di.copy(e.eulerAngles,t)}}}}var qG=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=YG(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=YG(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var a=this._wrapMode,o=XG(n),s=XG(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&o!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((a&Gc.PingPong)===Gc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((a&Gc.PingPong)===Gc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>o)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?i.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,a=0;a<r;++a)for(var o=n.events[a],s=o.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,o.parameters)}}},e}();function XG(e){return e-(0|e)==0&&(e-=1),0|e}function YG(e,t){return Xc(t,e)}var KG,QG=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(w(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},B(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),ZG=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(KG||(KG={})),Ze(KG);var JG=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=kc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new qc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||v("Clip "+t.name+" has zero duration."),i}L(t,e);var n=t.prototype;return n.initialize=function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Gc.Loop)===Gc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,a,o,s=null!==(r=null!=t?t:null===(a=i.director.getAnimationManager())||void 0===a?void 0:a.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new ZG(s)),this._clipEval=n.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(KG.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(KG.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(KG.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(KG.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new qc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(KG.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(KG.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(KG.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&Gc.PingPong)===Gc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&Gc.Reverse)===Gc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new qc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,a=this.repeatCount,o=(e-=n)>0?e/i:-e/i;if(o>=a){o=a,r=!0;var s=a-(0|a);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&Gc.ShouldWrap;u&&(l=this._needReverse(o));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=o,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){i.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){i.director.getAnimationManager().removeAnimation(this)},B(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&Gc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Gc.ShouldWrap,n=(this.wrapMode&Gc.Reverse)===Gc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(QG));i.AnimationState=JG;var $G,ek,tk,nk,ik,rk,ak,ok,sk,ck,lk,uk,hk,_k,fk,pk,dk,mk=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:i.director.getAnimationManager(),n}L(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var a=1,o=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:Kn(c.easeTime/c.easeDuration),u=l*a;if(a*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){o=s+1,c.easeTime=c.easeDuration;break}}if(o!==n.length){for(var h=o;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),Z(this._managedStates,_.target))}n.splice(o)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(QG),vk=function(t){return e({AnimationComponent:t,Animation:t}),t}(($G=nl("cc.Animation"),ek=gl(),tk=rl(99),nk=pl(),ik=Bl([zG]),rk=El(),ak=Bl(zG),ok=El(),sk=El(),ck=Bl([zG]),$G(lk=ek(lk=tk(lk=fl(lk=nk((dk=pk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",hk,V(t)),t._crossFade=new mk,t._nameToState=_e(!0),q(t,"_clips",_k,V(t)),q(t,"_defaultClip",fk,V(t)),t._hasBeenPlayed=!1,t}L(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=_e(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return J(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void A(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void A(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var a=e.prototype.on.call(this,t,n,i,r);return t===KG.LASTFRAME&&this._syncAllowLastFrameEvent(),a},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===KG.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===KG.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new JG(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(KG.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];gk(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(KG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(KG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},B(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=W(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var a,o=W(e);!(a=o()).done;){var s=a.value;s&&this.createState(s)}var c=e.find((function(e){return gk(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return gk(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(an(Ju)),pk.EventType=KG,X((uk=dk).prototype,"clips",[ik,rk],Object.getOwnPropertyDescriptor(uk.prototype,"clips"),uk.prototype),X(uk.prototype,"defaultClip",[ak,ok],Object.getOwnPropertyDescriptor(uk.prototype,"defaultClip"),uk.prototype),hk=X(uk.prototype,"playOnLoad",[cl,sk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_k=X(uk.prototype,"_clips",[ck],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fk=X(uk.prototype,"_defaultClip",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lk=uk))||lk)||lk)||lk)||lk)||lk));function gk(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}i.Animation=vk,Nn(vk.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return vk.prototype.removeState.call(this,e.name)}}]),i.AnimationComponent=vk,ke.setClassAlias(vk,"cc.AnimationComponent");var yk,xk,Sk,Tk=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new Ek(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new Pk,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),Ek=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},B(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),Ak=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},Ck=function(e){function t(){return e.call(this,new di)||this}L(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?di.copy(n,e):di.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,di.zero(this.blendedValue)},t}(Ak),bk=function(e){function t(){return e.call(this,new Ti)||this}L(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)Ti.copy(n,e);else{var r=t/(i+t);Ti.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,Ti.identity(this.blendedValue)},t}(Ak),Pk=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new Ck;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new bk}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,a=r.position,o=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;a&&a.blendedWeight&&(l=!0,a.blendedWeight<1&&a.blend(e.position,1-a.blendedWeight),t=a.blendedValue),o&&o.blendedWeight&&(u=!0,o.blendedWeight<1&&o.blend(e.scale,1-o.blendedWeight),n=o.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&a.reset(),u&&o.reset(),h&&s.reset(),_&&c.reset()},B(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),Rk=[],Ik=new Map;function wk(e,t){for(var n=0,i=wi.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,Rk[n++]=e,e=e.parent}for(;n>0;){e=Rk[--n],Rk[n]=null;var r=e.node;wi.fromRTS(e.local,r.rotation,r.position,r.scale),i=wi.multiply(e.world,i,e.local)}return i}function Dk(e){for(var t=Ik.get(e.uuid)||null;t;)Ik.delete(t.node.uuid),t=t.parent}var Ok=e("AnimationManager",nl((Sk=xk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new Y([]),t._crossFades=new Y([]),t._delayEvents=[],t._blendStateBuffer=new Tk,t._sockets=[],t}L(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):b(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,r=this._sockets,a=n.array;for(n.i=0;n.i<a.length;++n.i)a[n.i].update(e);var o=this._anims,s=o.array;for(o.i=0;o.i<s.length;++o.i){var c=s[o.i];c.isMotionless||c.update(e)}this._blendStateBuffer.apply();for(var l=i.director.getTotalFrames(),u=0,h=r.length;u<h;u++){var _=r[u],f=_.target,p=_.transform;f.matrix=wk(p,l)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):b(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var a=e.getChildByPath(r.path),o=r.target&&a&&function(e,t){for(var n,i=null,r=0;e!==t;){var a=e.uuid;if(Ik.has(a)){i=Ik.get(a);break}i={node:e,local:new wi,world:new wi,stamp:-1,parent:null},Ik.set(a,i),Rk[r++]=i,e=e.parent,i=null}for(;r>0;)n=Rk[--r],Rk[r]=null,n.parent=i,i=n;return i}(a,e);o&&n._sockets.push({target:r.target,transform:o})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var a=this._sockets[r];if(a.target===i.target){Dk(a.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},B(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(IM),xk.ID="animation",yk=Sk))||yk);VM.on(HM.EVENT_INIT,(function(){var e=new Ok;VM.registerSystem(Ok.ID,e,IM.Priority.HIGH)})),i.AnimationManager=Ok;var Mk,Nk,Bk,Fk,Lk=new wi;i.easing=$_;var zk=e("HierachyModifier",nl("cc.HierachyModifier")(Mk=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(LL))||Mk);i.HierachyModifier=zk;var Uk=e("ComponentModifier",nl("cc.ComponentModifier")(Nk=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(zL))||Nk);i.ComponentModifier=Uk;var Gk=e("CurveValueAdapter",nl("cc.CurveValueAdapter")(Bk=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||Bk);i.CurveValueAdapter=Gk;var kk=e("UniformCurveValueAdapter",nl("cc.UniformCurveValueAdapter")(Fk=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(UL))||Fk);function Hk(e){return"string"==typeof e}function Vk(e){return"number"==typeof e}function jk(e,t){return e instanceof t}i.UniformCurveValueAdapter=kk,i.isPropertyModifier=Hk,i.isElementModifier=Vk,i.isCustomTargetModifier=jk,i.math=Xi,i.geometry=Dp;var Wk=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var a=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return a&&a.reuse&&a.reuse(arguments),r},e}());i.NodePool=Wk,i.renderer=oy;var qk=Object.setPrototypeOf,Xk={};Xk||(Xk={}),function(e){var t=function(){function t(n){this._clock=new e.WorldClock,this._events=[],this._objects=[],this._eventManager=null,this._eventManager=n,console.info("DragonBones: "+t.VERSION+"\nWebsite: http://dragonbones.com/\nSource and Demo: https://github.com/DragonBones/")}return t.prototype.advanceTime=function(t){if(this._objects.length>0){for(var n=0,i=this._objects;n<i.length;n++)i[n].returnToPool();this._objects.length=0}if(this._clock.advanceTime(t),this._events.length>0){for(var r=0;r<this._events.length;++r){var a=this._events[r],o=a.armature;null!==o._armatureData&&(o.eventDispatcher.dispatchDBEvent(a.type,a),a.type===e.EventObject.SOUND_EVENT&&this._eventManager.dispatchDBEvent(a.type,a)),this.bufferObject(a)}this._events.length=0}},t.prototype.bufferEvent=function(e){this._events.indexOf(e)<0&&this._events.push(e)},t.prototype.bufferObject=function(e){this._objects.indexOf(e)<0&&this._objects.push(e)},Object.defineProperty(t.prototype,"clock",{get:function(){return this._clock},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"eventManager",{get:function(){return this._eventManager},enumerable:!0,configurable:!0}),t.VERSION="5.6.300",t.yDown=!1,t.debug=!1,t.debugDraw=!1,t.webAssembly=!1,t}();e.DragonBones=t}(Xk||(Xk={})),console.warn||(console.warn=function(){}),console.assert||(console.assert=function(){}),Date.now||(Date.now=function(){return(new Date).getTime()}),qk=function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);n.prototype=t.prototype,e.prototype=new n},function(e){var t=function(){function e(){this.hashCode=e._hashCode++,this._isInPool=!1}return e._returnObject=function(t){var n=String(t.constructor),i=n in e._maxCountMap?e._maxCountMap[n]:e._defaultMaxCount,r=e._poolsMap[n]=e._poolsMap[n]||[];r.length<i&&(t._isInPool?console.warn("The object is already in the pool."):(t._isInPool=!0,r.push(t)))},e.toString=function(){throw new Error},e.setMaxCount=function(t,n){if((n<0||n!=n)&&(n=0),null!==t)null!==(r=(i=String(t))in e._poolsMap?e._poolsMap[i]:null)&&r.length>n&&(r.length=n),e._maxCountMap[i]=n;else for(var i in e._defaultMaxCount=n,e._poolsMap){var r;(r=e._poolsMap[i]).length>n&&(r.length=n),i in e._maxCountMap&&(e._maxCountMap[i]=n)}},e.clearPool=function(t){if(void 0===t&&(t=null),null!==t){var n=String(t);null!==(r=n in e._poolsMap?e._poolsMap[n]:null)&&r.length>0&&(r.length=0)}else for(var i in e._poolsMap){var r;(r=e._poolsMap[i]).length=0}},e.borrowObject=function(t){var n=String(t),i=n in e._poolsMap?e._poolsMap[n]:null;if(null!==i&&i.length>0){var r=i.pop();return r._isInPool=!1,r}var a=new t;return a._onClear(),a},e.prototype.returnToPool=function(){this._onClear(),e._returnObject(this)},e._hashCode=0,e._defaultMaxCount=3e3,e._maxCountMap={},e._poolsMap={},e}();e.BaseObject=t}(Xk||(Xk={})),function(e){var t=function(){function e(e,t,n,i,r,a){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=a}return e.prototype.toString=function(){return"[object dragonBones.Matrix] a:"+this.a+" b:"+this.b+" c:"+this.c+" d:"+this.d+" tx:"+this.tx+" ty:"+this.ty},e.prototype.copyFrom=function(e){return this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.tx=e.tx,this.ty=e.ty,this},e.prototype.copyFromArray=function(e,t){return void 0===t&&(t=0),this.a=e[t],this.b=e[t+1],this.c=e[t+2],this.d=e[t+3],this.tx=e[t+4],this.ty=e[t+5],this},e.prototype.identity=function(){return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this},e.prototype.concat=function(e){var t=this.a*e.a,n=0,i=0,r=this.d*e.d,a=this.tx*e.a+e.tx,o=this.ty*e.d+e.ty;return 0===this.b&&0===this.c||(t+=this.b*e.c,n+=this.b*e.d,i+=this.c*e.a,r+=this.c*e.b),0===e.b&&0===e.c||(n+=this.a*e.b,i+=this.d*e.c,a+=this.ty*e.c,o+=this.tx*e.b),this.a=t,this.b=n,this.c=i,this.d=r,this.tx=a,this.ty=o,this},e.prototype.invert=function(){var e=this.a,t=this.b,n=this.c,i=this.d,r=this.tx,a=this.ty;if(0===t&&0===n)return this.b=this.c=0,0===e||0===i?this.a=this.b=this.tx=this.ty=0:(e=this.a=1/e,i=this.d=1/i,this.tx=-e*r,this.ty=-i*a),this;var o=e*i-t*n;if(0===o)return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this;o=1/o;var s=this.a=i*o;return t=this.b=-t*o,n=this.c=-n*o,i=this.d=e*o,this.tx=-(s*r+n*a),this.ty=-(t*r+i*a),this},e.prototype.transformPoint=function(e,t,n,i){void 0===i&&(i=!1),n.x=this.a*e+this.c*t,n.y=this.b*e+this.d*t,i||(n.x+=this.tx,n.y+=this.ty)},e.prototype.transformRectangle=function(e,t){void 0===t&&(t=!1);var n=this.a,i=this.b,r=this.c,a=this.d,o=t?0:this.tx,s=t?0:this.ty,c=e.x,l=e.y,u=c+e.width,h=l+e.height,_=n*c+r*l+o,f=i*c+a*l+s,p=n*u+r*l+o,d=i*u+a*l+s,m=n*u+r*h+o,v=i*u+a*h+s,g=n*c+r*h+o,y=i*c+a*h+s,x=0;_>p&&(x=_,_=p,p=x),m>g&&(x=m,m=g,g=x),e.x=Math.floor(_<m?_:m),e.width=Math.ceil((p>g?p:g)-e.x),f>d&&(x=f,f=d,d=x),v>y&&(x=v,v=y,y=x),e.y=Math.floor(f<v?f:v),e.height=Math.ceil((d>y?d:y)-e.y)},e}();e.Matrix=t}(Xk||(Xk={})),function(e){var t=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=1),this.x=e,this.y=t,this.skew=n,this.rotation=i,this.scaleX=r,this.scaleY=a}return e.normalizeRadian=function(e){return(e=(e+Math.PI)%(2*Math.PI))+(e>0?-Math.PI:Math.PI)},e.prototype.toString=function(){return"[object dragonBones.Transform] x:"+this.x+" y:"+this.y+" skewX:"+180*this.skew/Math.PI+" skewY:"+180*this.rotation/Math.PI+" scaleX:"+this.scaleX+" scaleY:"+this.scaleY},e.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.skew=e.skew,this.rotation=e.rotation,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this},e.prototype.identity=function(){return this.x=this.y=0,this.skew=this.rotation=0,this.scaleX=this.scaleY=1,this},e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.skew+=e.skew,this.rotation+=e.rotation,this.scaleX*=e.scaleX,this.scaleY*=e.scaleY,this},e.prototype.minus=function(e){return this.x-=e.x,this.y-=e.y,this.skew-=e.skew,this.rotation-=e.rotation,this.scaleX/=e.scaleX,this.scaleY/=e.scaleY,this},e.prototype.fromMatrix=function(t){var n=this.scaleX,i=this.scaleY,r=e.PI_Q;this.x=t.tx,this.y=t.ty,this.rotation=Math.atan(t.b/t.a);var a=Math.atan(-t.c/t.d);return this.scaleX=this.rotation>-r&&this.rotation<r?t.a/Math.cos(this.rotation):t.b/Math.sin(this.rotation),this.scaleY=a>-r&&a<r?t.d/Math.cos(a):-t.c/Math.sin(a),n>=0&&this.scaleX<0&&(this.scaleX=-this.scaleX,this.rotation=this.rotation-Math.PI),i>=0&&this.scaleY<0&&(this.scaleY=-this.scaleY,a-=Math.PI),this.skew=a-this.rotation,this},e.prototype.toMatrix=function(e){return 0===this.rotation?(e.a=1,e.b=0):(e.a=Math.cos(this.rotation),e.b=Math.sin(this.rotation)),0===this.skew?(e.c=-e.b,e.d=e.a):(e.c=-Math.sin(this.skew+this.rotation),e.d=Math.cos(this.skew+this.rotation)),1!==this.scaleX&&(e.a*=this.scaleX,e.b*=this.scaleX),1!==this.scaleY&&(e.c*=this.scaleY,e.d*=this.scaleY),e.tx=this.x,e.ty=this.y,this},e.PI=Math.PI,e.PI_D=2*Math.PI,e.PI_H=Math.PI/2,e.PI_Q=Math.PI/4,e.RAD_DEG=180/Math.PI,e.DEG_RAD=Math.PI/180,e}();e.Transform=t}(Xk||(Xk={})),function(e){var t=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),this.alphaMultiplier=e,this.redMultiplier=t,this.greenMultiplier=n,this.blueMultiplier=i,this.alphaOffset=r,this.redOffset=a,this.greenOffset=o,this.blueOffset=s}return e.prototype.copyFrom=function(e){this.alphaMultiplier=e.alphaMultiplier,this.redMultiplier=e.redMultiplier,this.greenMultiplier=e.greenMultiplier,this.blueMultiplier=e.blueMultiplier,this.alphaOffset=e.alphaOffset,this.redOffset=e.redOffset,this.greenOffset=e.greenOffset,this.blueOffset=e.blueOffset},e.prototype.identity=function(){this.alphaMultiplier=this.redMultiplier=this.greenMultiplier=this.blueMultiplier=1,this.alphaOffset=this.redOffset=this.greenOffset=this.blueOffset=0},e}();e.ColorTransform=t}(Xk||(Xk={})),function(e){var t=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t}return e.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},e.prototype.clear=function(){this.x=this.y=0},e}();e.Point=t}(Xk||(Xk={})),function(e){var t=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height},e.prototype.clear=function(){this.x=this.y=0,this.width=this.height=0},e}();e.Rectangle=t}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.ints=[],t.floats=[],t.strings=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.UserData]"},t.prototype._onClear=function(){this.ints.length=0,this.floats.length=0,this.strings.length=0},t.prototype.addInt=function(e){this.ints.push(e)},t.prototype.addFloat=function(e){this.floats.push(e)},t.prototype.addString=function(e){this.strings.push(e)},t.prototype.getInt=function(e){return void 0===e&&(e=0),e>=0&&e<this.ints.length?this.ints[e]:0},t.prototype.getFloat=function(e){return void 0===e&&(e=0),e>=0&&e<this.floats.length?this.floats[e]:0},t.prototype.getString=function(e){return void 0===e&&(e=0),e>=0&&e<this.strings.length?this.strings[e]:""},t}(e.BaseObject);e.UserData=t;var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.data=null,t}return qk(t,e),t.toString=function(){return"[class dragonBones.ActionData]"},t.prototype._onClear=function(){null!==this.data&&this.data.returnToPool(),this.type=0,this.name="",this.bone=null,this.slot=null,this.data=null},t}(e.BaseObject);e.ActionData=n}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.frameIndices=[],t.cachedFrames=[],t.armatureNames=[],t.armatures={},t.userData=null,t}return qk(t,e),t.toString=function(){return"[class dragonBones.DragonBonesData]"},t.prototype._onClear=function(){for(var e in this.armatures)this.armatures[e].returnToPool(),delete this.armatures[e];null!==this.userData&&this.userData.returnToPool(),this.autoSearch=!1,this.frameRate=0,this.version="",this.name="",this.stage=null,this.frameIndices.length=0,this.cachedFrames.length=0,this.armatureNames.length=0,this.binary=null,this.intArray=null,this.floatArray=null,this.frameIntArray=null,this.frameFloatArray=null,this.frameArray=null,this.timelineArray=null,this.userData=null},t.prototype.addArmature=function(e){e.name in this.armatures?console.warn("Same armature: "+e.name):(e.parent=this,this.armatures[e.name]=e,this.armatureNames.push(e.name))},t.prototype.getArmature=function(e){return e in this.armatures?this.armatures[e]:null},t.prototype.dispose=function(){console.warn("已废弃"),this.returnToPool()},t}(e.BaseObject);e.DragonBonesData=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.aabb=new e.Rectangle,n.animationNames=[],n.sortedBones=[],n.sortedSlots=[],n.defaultActions=[],n.actions=[],n.bones={},n.slots={},n.constraints={},n.skins={},n.animations={},n.canvas=null,n.userData=null,n}return qk(n,t),n.toString=function(){return"[class dragonBones.ArmatureData]"},n.prototype._onClear=function(){for(var e=0,t=this.defaultActions;e<t.length;e++)t[e].returnToPool();for(var n=0,i=this.actions;n<i.length;n++)i[n].returnToPool();for(var r in this.bones)this.bones[r].returnToPool(),delete this.bones[r];for(var r in this.slots)this.slots[r].returnToPool(),delete this.slots[r];for(var r in this.constraints)this.constraints[r].returnToPool(),delete this.constraints[r];for(var r in this.skins)this.skins[r].returnToPool(),delete this.skins[r];for(var r in this.animations)this.animations[r].returnToPool(),delete this.animations[r];null!==this.canvas&&this.canvas.returnToPool(),null!==this.userData&&this.userData.returnToPool(),this.type=0,this.frameRate=0,this.cacheFrameRate=0,this.scale=1,this.name="",this.aabb.clear(),this.animationNames.length=0,this.sortedBones.length=0,this.sortedSlots.length=0,this.defaultActions.length=0,this.actions.length=0,this.defaultSkin=null,this.defaultAnimation=null,this.canvas=null,this.userData=null,this.parent=null},n.prototype.sortBones=function(){var e=this.sortedBones.length;if(!(e<=0)){var t=this.sortedBones.concat(),n=0,i=0;for(this.sortedBones.length=0;i<e;){var r=t[n++];if(n>=e&&(n=0),!(this.sortedBones.indexOf(r)>=0)){var a=!1;for(var o in this.constraints){var s=this.constraints[o];if(s.root===r&&this.sortedBones.indexOf(s.target)<0){a=!0;break}}a||null!==r.parent&&this.sortedBones.indexOf(r.parent)<0||(this.sortedBones.push(r),i++)}}}},n.prototype.cacheFrames=function(e){if(!(this.cacheFrameRate>0))for(var t in this.cacheFrameRate=e,this.animations)this.animations[t].cacheFrames(this.cacheFrameRate)},n.prototype.setCacheFrame=function(e,t){var n=this.parent.cachedFrames,i=n.length;return n.length+=10,n[i]=e.a,n[i+1]=e.b,n[i+2]=e.c,n[i+3]=e.d,n[i+4]=e.tx,n[i+5]=e.ty,n[i+6]=t.rotation,n[i+7]=t.skew,n[i+8]=t.scaleX,n[i+9]=t.scaleY,i},n.prototype.getCacheFrame=function(e,t,n){var i=this.parent.cachedFrames;e.a=i[n],e.b=i[n+1],e.c=i[n+2],e.d=i[n+3],e.tx=i[n+4],e.ty=i[n+5],t.rotation=i[n+6],t.skew=i[n+7],t.scaleX=i[n+8],t.scaleY=i[n+9],t.x=e.tx,t.y=e.ty},n.prototype.addBone=function(e){e.name in this.bones?console.warn("Same bone: "+e.name):(this.bones[e.name]=e,this.sortedBones.push(e))},n.prototype.addSlot=function(e){e.name in this.slots?console.warn("Same slot: "+e.name):(this.slots[e.name]=e,this.sortedSlots.push(e))},n.prototype.addConstraint=function(e){e.name in this.constraints?console.warn("Same constraint: "+e.name):this.constraints[e.name]=e},n.prototype.addSkin=function(e){e.name in this.skins?console.warn("Same skin: "+e.name):(e.parent=this,this.skins[e.name]=e,null===this.defaultSkin&&(this.defaultSkin=e),"default"===e.name&&(this.defaultSkin=e))},n.prototype.addAnimation=function(e){e.name in this.animations?console.warn("Same animation: "+e.name):(e.parent=this,this.animations[e.name]=e,this.animationNames.push(e.name),null===this.defaultAnimation&&(this.defaultAnimation=e))},n.prototype.addAction=function(e,t){t?this.defaultActions.push(e):this.actions.push(e)},n.prototype.getBone=function(e){return e in this.bones?this.bones[e]:null},n.prototype.getSlot=function(e){return e in this.slots?this.slots[e]:null},n.prototype.getConstraint=function(e){return e in this.constraints?this.constraints[e]:null},n.prototype.getSkin=function(e){return e in this.skins?this.skins[e]:null},n.prototype.getMesh=function(e,t,n){var i=this.getSkin(e);return null===i?null:i.getDisplay(t,n)},n.prototype.getAnimation=function(e){return e in this.animations?this.animations[e]:null},n}(e.BaseObject);e.ArmatureData=t;var n=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.transform=new e.Transform,n.userData=null,n}return qk(n,t),n.toString=function(){return"[class dragonBones.BoneData]"},n.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.inheritTranslation=!1,this.inheritRotation=!1,this.inheritScale=!1,this.inheritReflection=!1,this.type=0,this.length=0,this.name="",this.transform.identity(),this.userData=null,this.parent=null},n}(e.BaseObject);e.BoneData=n;var i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.vertices=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.SurfaceData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=1,this.segmentX=0,this.segmentY=0,this.vertices.length=0},t}(n);e.SurfaceData=i;var r=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.color=null,e.userData=null,e}return qk(n,t),n.createColor=function(){return new e.ColorTransform},n.toString=function(){return"[class dragonBones.SlotData]"},n.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.blendMode=0,this.displayIndex=0,this.zOrder=0,this.name="",this.color=null,this.userData=null,this.parent=null},n.DEFAULT_COLOR=new e.ColorTransform,n}(e.BaseObject);e.SlotData=r}(Xk||(Xk={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){this.order=0,this.name="",this.type=0,this.target=null,this.root=null,this.bone=null},t}(e.BaseObject);e.ConstraintData=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.IKConstraintData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.scaleEnabled=!1,this.bendPositive=!1,this.weight=1},t}(t);e.IKConstraintData=n;var i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.bones=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.PathConstraintData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.pathSlot=null,this.pathDisplayData=null,this.bones.length=0,this.positionMode=0,this.spacingMode=1,this.rotateMode=1,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=0,this.translateMix=0},t.prototype.AddBone=function(e){this.bones.push(e)},t}(t);e.PathConstraintData=i}(Xk||(Xk={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.CanvasData]"},t.prototype._onClear=function(){this.hasBackground=!1,this.color=0,this.x=0,this.y=0,this.width=0,this.height=0},t}(e.BaseObject);e.CanvasData=t}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.displays={},t}return qk(t,e),t.toString=function(){return"[class dragonBones.SkinData]"},t.prototype._onClear=function(){for(var e in this.displays){for(var t=0,n=this.displays[e];t<n.length;t++){var i=n[t];null!==i&&i.returnToPool()}delete this.displays[e]}this.name="",this.parent=null},t.prototype.addDisplay=function(e,t){e in this.displays||(this.displays[e]=[]),null!==t&&(t.parent=this),this.displays[e].push(t)},t.prototype.getDisplay=function(e,t){var n=this.getDisplays(e);if(null!==n)for(var i=0,r=n;i<r.length;i++){var a=r[i];if(null!==a&&a.name===t)return a}return null},t.prototype.getDisplays=function(e){return e in this.displays?this.displays[e]:null},t}(e.BaseObject);e.SkinData=t}(Xk||(Xk={})),function(e){var t=function(){function e(){this.weight=null}return e.prototype.clear=function(){this.isShared||null===this.weight||this.weight.returnToPool(),this.isShared=!1,this.inheritDeform=!1,this.offset=0,this.data=null,this.weight=null},e.prototype.shareFrom=function(e){this.isShared=!0,this.offset=e.offset,this.weight=e.weight},e}();e.VerticesData=t;var n=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.transform=new e.Transform,n}return qk(n,t),n.prototype._onClear=function(){this.name="",this.path="",this.transform.identity(),this.parent=null},n}(e.BaseObject);e.DisplayData=n;var i=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.pivot=new e.Point,n}return qk(n,t),n.toString=function(){return"[class dragonBones.ImageDisplayData]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=0,this.pivot.clear(),this.texture=null},n}(n);e.ImageDisplayData=i;var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.actions=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.ArmatureDisplayData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this);for(var t=0,n=this.actions;t<n.length;t++)n[t].returnToPool();this.type=1,this.inheritAnimation=!1,this.actions.length=0,this.armature=null},t.prototype.addAction=function(e){this.actions.push(e)},t}(n);e.ArmatureDisplayData=r;var a=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.vertices=new t,n}return qk(n,e),n.toString=function(){return"[class dragonBones.MeshDisplayData]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=2,this.vertices.clear(),this.texture=null},n}(n);e.MeshDisplayData=a;var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.boundingBox=null,t}return qk(t,e),t.toString=function(){return"[class dragonBones.BoundingBoxDisplayData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),null!==this.boundingBox&&this.boundingBox.returnToPool(),this.type=3,this.boundingBox=null},t}(n);e.BoundingBoxDisplayData=o;var s=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.vertices=new t,n.curveLengths=[],n}return qk(n,e),n.toString=function(){return"[class dragonBones.PathDisplayData]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=4,this.closed=!1,this.constantSpeed=!1,this.vertices.clear(),this.curveLengths.length=0},n}(n);e.PathDisplayData=s;var c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.bones=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.WeightData]"},t.prototype._onClear=function(){this.count=0,this.offset=0,this.bones.length=0},t.prototype.addBone=function(e){this.bones.push(e)},t}(e.BaseObject);e.WeightData=c}(Xk||(Xk={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){this.color=0,this.width=0,this.height=0},t}(e.BaseObject);e.BoundingBoxData=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.RectangleBoundingBoxData]"},t._computeOutCode=function(e,t,n,i,r,a){var o=0;return e<n?o|=1:e>r&&(o|=2),t<i?o|=4:t>a&&(o|=8),o},t.rectangleIntersectsSegment=function(e,n,i,r,a,o,s,c,l,u,h){void 0===l&&(l=null),void 0===u&&(u=null),void 0===h&&(h=null);var _=e>a&&e<s&&n>o&&n<c,f=i>a&&i<s&&r>o&&r<c;if(_&&f)return-1;for(var p=0,d=t._computeOutCode(e,n,a,o,s,c),m=t._computeOutCode(i,r,a,o,s,c);;){if(0==(d|m)){p=2;break}if(0!=(d&m))break;var v=0,g=0,y=0,x=0!==d?d:m;0!=(4&x)?(v=e+(i-e)*(o-n)/(r-n),g=o,null!==h&&(y=.5*-Math.PI)):0!=(8&x)?(v=e+(i-e)*(c-n)/(r-n),g=c,null!==h&&(y=.5*Math.PI)):0!=(2&x)?(g=n+(r-n)*(s-e)/(i-e),v=s,null!==h&&(y=0)):0!=(1&x)&&(g=n+(r-n)*(a-e)/(i-e),v=a,null!==h&&(y=Math.PI)),x===d?(e=v,n=g,d=t._computeOutCode(e,n,a,o,s,c),null!==h&&(h.x=y)):(i=v,r=g,m=t._computeOutCode(i,r,a,o,s,c),null!==h&&(h.y=y))}return p&&(_?(p=2,null!==l&&(l.x=i,l.y=r),null!==u&&(u.x=i,u.y=i),null!==h&&(h.x=h.y+Math.PI)):f?(p=1,null!==l&&(l.x=e,l.y=n),null!==u&&(u.x=e,u.y=n),null!==h&&(h.y=h.x+Math.PI)):(p=3,null!==l&&(l.x=e,l.y=n),null!==u&&(u.x=i,u.y=r))),p},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=0},t.prototype.containsPoint=function(e,t){var n=.5*this.width;if(e>=-n&&e<=n){var i=.5*this.height;if(t>=-i&&t<=i)return!0}return!1},t.prototype.intersectsSegment=function(e,n,i,r,a,o,s){void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null);var c=.5*this.width,l=.5*this.height;return t.rectangleIntersectsSegment(e,n,i,r,-c,-l,c,l,a,o,s)},t}(t);e.RectangleBoundingBoxData=n;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.EllipseData]"},t.ellipseIntersectsSegment=function(e,t,n,i,r,a,o,s,c,l,u){void 0===c&&(c=null),void 0===l&&(l=null),void 0===u&&(u=null);var h=o/s,_=h*h,f=n-e,p=(i*=h)-(t*=h),d=Math.sqrt(f*f+p*p),m=f/d,v=p/d,g=(r-e)*m+(a-t)*v,y=o*o,x=y-(e*e+t*t)+g*g,S=0;if(x>=0){var T=Math.sqrt(x),E=g-T,A=g+T,C=E<0?-1:E<=d?0:1,b=A<0?-1:A<=d?0:1,P=C*b;if(P<0)return-1;0===P&&(-1===C?(S=2,n=e+A*m,i=(t+A*v)/h,null!==c&&(c.x=n,c.y=i),null!==l&&(l.x=n,l.y=i),null!==u&&(u.x=Math.atan2(i/y*_,n/y),u.y=u.x+Math.PI)):1===b?(S=1,e+=E*m,t=(t+E*v)/h,null!==c&&(c.x=e,c.y=t),null!==l&&(l.x=e,l.y=t),null!==u&&(u.x=Math.atan2(t/y*_,e/y),u.y=u.x+Math.PI)):(S=3,null!==c&&(c.x=e+E*m,c.y=(t+E*v)/h,null!==u&&(u.x=Math.atan2(c.y/y*_,c.x/y))),null!==l&&(l.x=e+A*m,l.y=(t+A*v)/h,null!==u&&(u.y=Math.atan2(l.y/y*_,l.x/y)))))}return S},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=1},t.prototype.containsPoint=function(e,t){var n=.5*this.width;if(e>=-n&&e<=n){var i=.5*this.height;if(t>=-i&&t<=i)return t*=n/i,Math.sqrt(e*e+t*t)<=n}return!1},t.prototype.intersectsSegment=function(e,n,i,r,a,o,s){return void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null),t.ellipseIntersectsSegment(e,n,i,r,0,0,.5*this.width,.5*this.height,a,o,s)},t}(t);e.EllipseBoundingBoxData=i;var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.vertices=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.PolygonBoundingBoxData]"},t.polygonIntersectsSegment=function(e,t,n,i,r,a,o,s){void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null),e===n&&(e=n+1e-6),t===i&&(t=i+1e-6);for(var c=r.length,l=e-n,u=t-i,h=e*i-t*n,_=0,f=r[c-2],p=r[c-1],d=0,m=0,v=0,g=0,y=0,x=0,S=0;S<c;S+=2){var T=r[S],E=r[S+1];f===T&&(f=T+1e-4),p===E&&(p=E+1e-4);var A=f-T,C=p-E,b=f*E-p*T,P=l*C-u*A,R=(h*A-l*b)/P;if((R>=f&&R<=T||R>=T&&R<=f)&&(0===l||R>=e&&R<=n||R>=n&&R<=e)){var I=(h*C-u*b)/P;if((I>=p&&I<=E||I>=E&&I<=p)&&(0===u||I>=t&&I<=i||I>=i&&I<=t)){if(null===o){v=R,g=I,y=R,x=I,_++,null!==s&&(s.x=Math.atan2(E-p,T-f)-.5*Math.PI,s.y=s.x);break}var w=R-e;w<0&&(w=-w),0===_?(d=w,m=w,v=R,g=I,y=R,x=I,null!==s&&(s.x=Math.atan2(E-p,T-f)-.5*Math.PI,s.y=s.x)):(w<d&&(d=w,v=R,g=I,null!==s&&(s.x=Math.atan2(E-p,T-f)-.5*Math.PI)),w>m&&(m=w,y=R,x=I,null!==s&&(s.y=Math.atan2(E-p,T-f)-.5*Math.PI))),_++}}f=T,p=E}return 1===_?(null!==a&&(a.x=v,a.y=g),null!==o&&(o.x=v,o.y=g),null!==s&&(s.y=s.x+Math.PI)):_>1&&(_++,null!==a&&(a.x=v,a.y=g),null!==o&&(o.x=y,o.y=x)),_},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=2,this.x=0,this.y=0,this.vertices.length=0},t.prototype.containsPoint=function(e,t){var n=!1;if(e>=this.x&&e<=this.width&&t>=this.y&&t<=this.height)for(var i=0,r=this.vertices.length,a=r-2;i<r;i+=2){var o=this.vertices[a+1],s=this.vertices[i+1];if(s<t&&o>=t||o<t&&s>=t){var c=this.vertices[a],l=this.vertices[i];(t-s)*(c-l)/(o-s)+l<e&&(n=!n)}a=i}return n},t.prototype.intersectsSegment=function(e,i,r,a,o,s,c){void 0===o&&(o=null),void 0===s&&(s=null),void 0===c&&(c=null);var l=0;return 0!==n.rectangleIntersectsSegment(e,i,r,a,this.x,this.y,this.x+this.width,this.y+this.height,null,null,null)&&(l=t.polygonIntersectsSegment(e,i,r,a,this.vertices,o,s,c)),l},t}(t);e.PolygonBoundingBoxData=r}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.cachedFrames=[],t.boneTimelines={},t.surfaceTimelines={},t.slotTimelines={},t.constraintTimelines={},t.animationTimelines={},t.boneCachedFrameIndices={},t.slotCachedFrameIndices={},t.actionTimeline=null,t.zOrderTimeline=null,t}return qk(t,e),t.toString=function(){return"[class dragonBones.AnimationData]"},t.prototype._onClear=function(){for(var e in this.boneTimelines){for(var t=0,n=this.boneTimelines[e];t<n.length;t++)n[t].returnToPool();delete this.boneTimelines[e]}for(var e in this.surfaceTimelines){for(var i=0,r=this.surfaceTimelines[e];i<r.length;i++)r[i].returnToPool();delete this.surfaceTimelines[e]}for(var e in this.slotTimelines){for(var a=0,o=this.slotTimelines[e];a<o.length;a++)o[a].returnToPool();delete this.slotTimelines[e]}for(var e in this.constraintTimelines){for(var s=0,c=this.constraintTimelines[e];s<c.length;s++)c[s].returnToPool();delete this.constraintTimelines[e]}for(var e in this.animationTimelines){for(var l=0,u=this.animationTimelines[e];l<u.length;l++)u[l].returnToPool();delete this.animationTimelines[e]}for(var e in this.boneCachedFrameIndices)delete this.boneCachedFrameIndices[e];for(var e in this.slotCachedFrameIndices)delete this.slotCachedFrameIndices[e];null!==this.actionTimeline&&this.actionTimeline.returnToPool(),null!==this.zOrderTimeline&&this.zOrderTimeline.returnToPool(),this.frameIntOffset=0,this.frameFloatOffset=0,this.frameOffset=0,this.frameCount=0,this.playTimes=0,this.duration=0,this.scale=1,this.fadeInTime=0,this.cacheFrameRate=0,this.name="",this.cachedFrames.length=0,this.actionTimeline=null,this.zOrderTimeline=null,this.parent=null},t.prototype.cacheFrames=function(e){if(!(this.cacheFrameRate>0)){this.cacheFrameRate=Math.max(Math.ceil(e*this.scale),1);var t=Math.ceil(this.cacheFrameRate*this.duration)+1;this.cachedFrames.length=t;for(var n=0,i=this.cacheFrames.length;n<i;++n)this.cachedFrames[n]=!1;for(var r=0,a=this.parent.sortedBones;r<a.length;r++){var o=a[r];for(n=0,i=(l=new Array(t)).length;n<i;++n)l[n]=-1;this.boneCachedFrameIndices[o.name]=l}for(var s=0,c=this.parent.sortedSlots;s<c.length;s++){var l,u=c[s];for(n=0,i=(l=new Array(t)).length;n<i;++n)l[n]=-1;this.slotCachedFrameIndices[u.name]=l}}},t.prototype.addBoneTimeline=function(e,t){var n=e.name in this.boneTimelines?this.boneTimelines[e.name]:this.boneTimelines[e.name]=[];n.indexOf(t)<0&&n.push(t)},t.prototype.addSurfaceTimeline=function(e,t){var n=e.name in this.surfaceTimelines?this.surfaceTimelines[e.name]:this.surfaceTimelines[e.name]=[];n.indexOf(t)<0&&n.push(t)},t.prototype.addSlotTimeline=function(e,t){var n=e.name in this.slotTimelines?this.slotTimelines[e.name]:this.slotTimelines[e.name]=[];n.indexOf(t)<0&&n.push(t)},t.prototype.addConstraintTimeline=function(e,t){var n=e.name in this.constraintTimelines?this.constraintTimelines[e.name]:this.constraintTimelines[e.name]=[];n.indexOf(t)<0&&n.push(t)},t.prototype.addAnimationTimeline=function(e,t){var n=e in this.animationTimelines?this.animationTimelines[e]:this.animationTimelines[e]=[];n.indexOf(t)<0&&n.push(t)},t.prototype.getBoneTimelines=function(e){return e in this.boneTimelines?this.boneTimelines[e]:null},t.prototype.getSurfaceTimelines=function(e){return e in this.surfaceTimelines?this.surfaceTimelines[e]:null},t.prototype.getSlotTimelines=function(e){return e in this.slotTimelines?this.slotTimelines[e]:null},t.prototype.getConstraintTimelines=function(e){return e in this.constraintTimelines?this.constraintTimelines[e]:null},t.prototype.getAnimationTimelines=function(e){return e in this.animationTimelines?this.animationTimelines[e]:null},t.prototype.getBoneCachedFrameIndices=function(e){return e in this.boneCachedFrameIndices?this.boneCachedFrameIndices[e]:null},t.prototype.getSlotCachedFrameIndices=function(e){return e in this.slotCachedFrameIndices?this.slotCachedFrameIndices[e]:null},t}(e.BaseObject);e.AnimationData=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.TimelineData]"},t.prototype._onClear=function(){this.type=10,this.offset=0,this.frameIndicesOffset=-1},t}(e.BaseObject);e.TimelineData=n}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.boneMask=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.AnimationConfig]"},t.prototype._onClear=function(){this.pauseFadeOut=!0,this.fadeOutMode=4,this.fadeOutTweenType=1,this.fadeOutTime=-1,this.actionEnabled=!0,this.additiveBlending=!1,this.displayControl=!0,this.pauseFadeIn=!0,this.resetToPose=!0,this.fadeInTweenType=1,this.playTimes=-1,this.layer=0,this.position=0,this.duration=-1,this.timeScale=-100,this.weight=1,this.fadeInTime=-1,this.autoFadeOutTime=-1,this.name="",this.animation="",this.group="",this.boneMask.length=0},t.prototype.clear=function(){this._onClear()},t.prototype.copyFrom=function(e){this.pauseFadeOut=e.pauseFadeOut,this.fadeOutMode=e.fadeOutMode,this.autoFadeOutTime=e.autoFadeOutTime,this.fadeOutTweenType=e.fadeOutTweenType,this.actionEnabled=e.actionEnabled,this.additiveBlending=e.additiveBlending,this.displayControl=e.displayControl,this.pauseFadeIn=e.pauseFadeIn,this.resetToPose=e.resetToPose,this.playTimes=e.playTimes,this.layer=e.layer,this.position=e.position,this.duration=e.duration,this.timeScale=e.timeScale,this.fadeInTime=e.fadeInTime,this.fadeOutTime=e.fadeOutTime,this.fadeInTweenType=e.fadeInTweenType,this.weight=e.weight,this.name=e.name,this.animation=e.animation,this.group=e.group,this.boneMask.length=e.boneMask.length;for(var t=0,n=this.boneMask.length;t<n;++t)this.boneMask[t]=e.boneMask[t]},t.prototype.containsBoneMask=function(e){return 0===this.boneMask.length||this.boneMask.indexOf(e)>=0},t.prototype.addBoneMask=function(e,t,n){void 0===n&&(n=!0);var i=e.getBone(t);if(null!==i&&(this.boneMask.indexOf(t)<0&&this.boneMask.push(t),n))for(var r=0,a=e.getBones();r<a.length;r++){var o=a[r];this.boneMask.indexOf(o.name)<0&&i.contains(o)&&this.boneMask.push(o.name)}},t.prototype.removeBoneMask=function(e,t,n){void 0===n&&(n=!0);var i=this.boneMask.indexOf(t);if(i>=0&&this.boneMask.splice(i,1),n){var r=e.getBone(t);if(null!==r)if(this.boneMask.length>0)for(var a=0,o=e.getBones();a<o.length;a++){var s=o[a],c=this.boneMask.indexOf(s.name);c>=0&&r.contains(s)&&this.boneMask.splice(c,1)}else for(var l=0,u=e.getBones();l<u.length;l++)(s=u[l])!==r&&(r.contains(s)||this.boneMask.push(s.name))}},t}(e.BaseObject);e.AnimationConfig=t}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.textures={},t}return qk(t,e),t.prototype._onClear=function(){for(var e in this.textures)this.textures[e].returnToPool(),delete this.textures[e];this.autoSearch=!1,this.width=0,this.height=0,this.scale=1,this.name="",this.imagePath=""},t.prototype.copyFrom=function(e){for(var t in this.autoSearch=e.autoSearch,this.scale=e.scale,this.width=e.width,this.height=e.height,this.name=e.name,this.imagePath=e.imagePath,this.textures)this.textures[t].returnToPool(),delete this.textures[t];for(var t in e.textures){var n=this.createTexture();n.copyFrom(e.textures[t]),this.textures[t]=n}},t.prototype.addTexture=function(e){e.name in this.textures?console.warn("Same texture: "+e.name):(e.parent=this,this.textures[e.name]=e)},t.prototype.getTexture=function(e){return e in this.textures?this.textures[e]:null},t}(e.BaseObject);e.TextureAtlasData=t;var n=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.region=new e.Rectangle,n.frame=null,n}return qk(n,t),n.createRectangle=function(){return new e.Rectangle},n.prototype._onClear=function(){this.rotated=!1,this.name="",this.region.clear(),this.parent=null,this.frame=null},n.prototype.copyFrom=function(e){this.rotated=e.rotated,this.name=e.name,this.region.copyFrom(e.region),this.parent=e.parent,null===this.frame&&null!==e.frame?this.frame=n.createRectangle():null!==this.frame&&null===e.frame&&(this.frame=null),null!==this.frame&&null!==e.frame&&this.frame.copyFrom(e.frame)},n}(e.BaseObject);e.TextureData=n}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.vertices=[],t.bones=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.DeformVertices]"},t.prototype._onClear=function(){this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},t.prototype.init=function(e,t){if(this.verticesData=e,null!==this.verticesData){var n;n=null!==this.verticesData.weight?2*this.verticesData.weight.count:2*this.verticesData.data.intArray[this.verticesData.offset+0],this.verticesDirty=!0,this.vertices.length=n,this.bones.length=0;for(var i=0,r=this.vertices.length;i<r;++i)this.vertices[i]=0;if(null!==this.verticesData.weight)for(i=0,r=this.verticesData.weight.bones.length;i<r;++i){var a=t.getBone(this.verticesData.weight.bones[i].name);this.bones.push(a)}}else this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},t.prototype.isBonesUpdate=function(){for(var e=0,t=this.bones;e<t.length;e++){var n=t[e];if(null!==n&&n._childrenTransformDirty)return!0}return!1},t}(e.BaseObject);e.DeformVertices=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._bones=[],e._slots=[],e._constraints=[],e._actions=[],e._animation=null,e._proxy=null,e._replaceTextureAtlasData=null,e._clock=null,e}return qk(n,t),n.toString=function(){return"[class dragonBones.Armature]"},n._onSortSlots=function(e,t){return e._zOrder>t._zOrder?1:-1},n.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var e=0,t=this._bones;e<t.length;e++)t[e].returnToPool();for(var n=0,i=this._slots;n<i.length;n++)i[n].returnToPool();for(var r=0,a=this._constraints;r<a.length;r++)a[r].returnToPool();for(var o=0,s=this._actions;o<s.length;o++)s[o].returnToPool();null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},n.prototype._sortZOrder=function(e,t){var n=this._armatureData.sortedSlots,i=null===e;if(this._zOrderDirty||!i){for(var r=0,a=n.length;r<a;++r){var o=i?r:e[t+r];if(!(o<0||o>=a)){var s=n[o],c=this.getSlot(s.name);null!==c&&c._setZorder(r)}}this._slotsDirty=!0,this._zOrderDirty=!i}},n.prototype._addBone=function(e){this._bones.indexOf(e)<0&&this._bones.push(e)},n.prototype._addSlot=function(e){this._slots.indexOf(e)<0&&this._slots.push(e)},n.prototype._addConstraint=function(e){this._constraints.indexOf(e)<0&&this._constraints.push(e)},n.prototype._bufferAction=function(e,t){this._actions.indexOf(e)<0&&(t?this._actions.push(e):this._actions.unshift(e))},n.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},n.prototype.init=function(t,n,i,r){null===this._armatureData&&(this._armatureData=t,this._animation=e.BaseObject.borrowObject(e.Animation),this._proxy=n,this._display=i,this._dragonBones=r,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},n.prototype.advanceTime=function(e){if(!this._lockUpdate)if(null!==this._armatureData)if(null!==this._armatureData.parent){var t=this._cacheFrameIndex;if(this._animation.advanceTime(e),this._slotsDirty&&(this._slotsDirty=!1,this._slots.sort(n._onSortSlots)),this._cacheFrameIndex<0||this._cacheFrameIndex!==t){var i=0,r=0;for(i=0,r=this._bones.length;i<r;++i)this._bones[i].update(this._cacheFrameIndex);for(i=0,r=this._slots.length;i<r;++i)this._slots[i].update(this._cacheFrameIndex)}if(this._actions.length>0){this._lockUpdate=!0;for(var a=0,o=this._actions;a<o.length;a++){var s=o[a],c=s.actionData;if(null!==c&&0===c.type)if(null!==s.slot)null!==(h=s.slot.childArmature)&&h.animation.fadeIn(c.name);else if(null!==s.bone)for(var l=0,u=this.getSlots();l<u.length;l++){var h,_=u[l];_.parent===s.bone&&null!==(h=_.childArmature)&&h.animation.fadeIn(c.name)}else this._animation.fadeIn(c.name);s.returnToPool()}this._actions.length=0,this._lockUpdate=!1}this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},n.prototype.invalidUpdate=function(e,t){if(void 0===e&&(e=null),void 0===t&&(t=!1),null!==e&&e.length>0){if(null!==(o=this.getBone(e))&&(o.invalidUpdate(),t))for(var n=0,i=this._slots;n<i.length;n++)(l=i[n]).parent===o&&l.invalidUpdate()}else{for(var r=0,a=this._bones;r<a.length;r++){var o;(o=a[r]).invalidUpdate()}if(t)for(var s=0,c=this._slots;s<c.length;s++){var l;(l=c[s]).invalidUpdate()}}},n.prototype.containsPoint=function(e,t){for(var n=0,i=this._slots;n<i.length;n++){var r=i[n];if(r.containsPoint(e,t))return r}return null},n.prototype.intersectsSegment=function(e,t,n,i,r,a,o){void 0===r&&(r=null),void 0===a&&(a=null),void 0===o&&(o=null);for(var s=e===n,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=null,v=null,g=0,y=this._slots;g<y.length;g++){var x=y[g];if(x.intersectsSegment(e,t,n,i,r,a,o)>0){if(null===r&&null===a){m=x;break}var S;null!==r&&((S=s?r.y-t:r.x-e)<0&&(S=-S),(null===m||S<c)&&(c=S,u=r.x,h=r.y,m=x,o&&(p=o.x))),null!==a&&((S=a.x-e)<0&&(S=-S),(null===v||S>l)&&(l=S,_=a.x,f=a.y,v=x,null!==o&&(d=o.y)))}}return null!==m&&null!==r&&(r.x=u,r.y=h,null!==o&&(o.x=p)),null!==v&&null!==a&&(a.x=_,a.y=f,null!==o&&(o.y=d)),m},n.prototype.getBone=function(e){for(var t=0,n=this._bones;t<n.length;t++){var i=n[t];if(i.name===e)return i}return null},n.prototype.getBoneByDisplay=function(e){var t=this.getSlotByDisplay(e);return null!==t?t.parent:null},n.prototype.getSlot=function(e){for(var t=0,n=this._slots;t<n.length;t++){var i=n[t];if(i.name===e)return i}return null},n.prototype.getSlotByDisplay=function(e){if(null!==e)for(var t=0,n=this._slots;t<n.length;t++){var i=n[t];if(i.display===e)return i}return null},n.prototype.getBones=function(){return this._bones},n.prototype.getSlots=function(){return this._slots},Object.defineProperty(n.prototype,"flipX",{get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"flipY",{get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(e){if(this._armatureData.cacheFrameRate!==e){this._armatureData.cacheFrames(e);for(var t=0,n=this._slots;t<n.length;t++){var i=n[t].childArmature;null!==i&&(i.cacheFrameRate=e)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(e){if(this._replacedTexture!==e){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=e;for(var t=0,n=this._slots;t<n.length;t++){var i=n[t];i.invalidUpdate(),i.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"clock",{get:function(){return this._clock},set:function(e){if(this._clock!==e){null!==this._clock&&this._clock.remove(this),this._clock=e,this._clock&&this._clock.add(this);for(var t=0,n=this._slots;t<n.length;t++){var i=n[t].childArmature;null!==i&&(i.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.replaceTexture=function(e){this.replacedTexture=e},n.prototype.hasEventListener=function(e){return this._proxy.hasDBEventListener(e)},n.prototype.addEventListener=function(e,t,n){this._proxy.addDBEventListener(e,t,n)},n.prototype.removeEventListener=function(e,t,n){this._proxy.removeDBEventListener(e,t,n)},n.prototype.enableAnimationCache=function(e){console.warn("Deprecated."),this.cacheFrameRate=e},n.prototype.getDisplay=function(){return this._display},n}(e.BaseObject);e.Armature=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.globalTransformMatrix=new e.Matrix,n.global=new e.Transform,n.offset=new e.Transform,n}return qk(n,t),n.prototype._onClear=function(){this.globalTransformMatrix.identity(),this.global.identity(),this.offset.identity(),this.origin=null,this.userData=null,this._globalDirty=!1,this._armature=null},n.prototype.updateGlobalTransform=function(){this._globalDirty&&(this._globalDirty=!1,this.global.fromMatrix(this.globalTransformMatrix))},Object.defineProperty(n.prototype,"armature",{get:function(){return this._armature},enumerable:!0,configurable:!0}),n._helpMatrix=new e.Matrix,n._helpTransform=new e.Transform,n._helpPoint=new e.Point,n}(e.BaseObject);e.TransformObject=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.animationPose=new e.Transform,n._blendState=new e.BlendState,n}return qk(n,t),n.toString=function(){return"[class dragonBones.Bone]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._blendState.clear(),this._boneData=null,this._parent=null,this._cachedFrameIndices=null},n.prototype._updateGlobalTransformMatrix=function(t){var n=this._boneData,i=this.global,r=this.globalTransformMatrix,a=this.origin,o=this.offset,s=this.animationPose,c=this._parent,l=this._armature.flipX,u=this._armature.flipY===e.DragonBones.yDown,h=null!==c,_=0;if(1===this.offsetMode?null!==a?(i.x=a.x+o.x+s.x,i.scaleX=a.scaleX*o.scaleX*s.scaleX,i.scaleY=a.scaleY*o.scaleY*s.scaleY,e.DragonBones.yDown?(i.y=a.y+o.y+s.y,i.skew=a.skew+o.skew+s.skew,i.rotation=a.rotation+o.rotation+s.rotation):(i.y=a.y-o.y+s.y,i.skew=a.skew-o.skew+s.skew,i.rotation=a.rotation-o.rotation+s.rotation)):(i.copyFrom(o),e.DragonBones.yDown||(i.y=-i.y,i.skew=-i.skew,i.rotation=-i.rotation),i.add(s)):0===this.offsetMode?null!==a?i.copyFrom(a).add(s):i.copyFrom(s):(h=!1,i.copyFrom(o),e.DragonBones.yDown||(i.y=-i.y,i.skew=-i.skew,i.rotation=-i.rotation)),h){var f=0===c._boneData.type?c.globalTransformMatrix:c._getGlobalTransformMatrix(i.x,i.y);if(n.inheritScale)n.inheritRotation||(c.updateGlobalTransform(),_=l&&u?i.rotation-(c.global.rotation+Math.PI):l?i.rotation+c.global.rotation+Math.PI:u?i.rotation+c.global.rotation:i.rotation-c.global.rotation,i.rotation=_),i.toMatrix(r),r.concat(f),n.inheritTranslation?(i.x=r.tx,i.y=r.ty):(r.tx=i.x,r.ty=i.y),t?i.fromMatrix(r):this._globalDirty=!0;else{if(n.inheritTranslation){var p=i.x,d=i.y;i.x=f.a*p+f.c*d+f.tx,i.y=f.b*p+f.d*d+f.ty}else l&&(i.x=-i.x),u&&(i.y=-i.y);n.inheritRotation?(c.updateGlobalTransform(),_=c.global.scaleX<0?i.rotation+c.global.rotation+Math.PI:i.rotation+c.global.rotation,f.a*f.d-f.b*f.c<0&&(_-=2*i.rotation,(l!==u||n.inheritReflection)&&(i.skew+=Math.PI),e.DragonBones.yDown||(i.skew=-i.skew)),i.rotation=_):(l||u)&&(l&&u?_=i.rotation+Math.PI:(_=l?Math.PI-i.rotation:-i.rotation,i.skew+=Math.PI),i.rotation=_),i.toMatrix(r)}}else(l||u)&&(l&&(i.x=-i.x),u&&(i.y=-i.y),l&&u?_=i.rotation+Math.PI:(_=l?Math.PI-i.rotation:-i.rotation,i.skew+=Math.PI),i.rotation=_),i.toMatrix(r)},n.prototype.init=function(e,t){null===this._boneData&&(this._boneData=e,this._armature=t,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},n.prototype.update=function(e){if(this._blendState.dirty=!1,e>=0&&null!==this._cachedFrameIndices){var t=this._cachedFrameIndices[e];if(t>=0&&this._cachedFrameIndex===t)this._transformDirty=!1;else if(t>=0)this._transformDirty=!0,this._cachedFrameIndex=t;else{if(this._hasConstraint)for(var n=0,i=this._armature._constraints;n<i.length;n++)(o=i[n])._root===this&&o.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[e]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var r=0,a=this._armature._constraints;r<a.length;r++){var o;(o=a[r])._root===this&&o.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(e=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var s=e>=0;this._localDirty&&this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[e]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},n.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},n.prototype.invalidUpdate=function(){this._transformDirty=!0},n.prototype.contains=function(e){if(e===this)return!1;for(var t=e;t!==this&&null!==t;)t=t.parent;return t===this},Object.defineProperty(n.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(e){if(this._visible!==e){this._visible=e;for(var t=0,n=this._armature.getSlots();t<n.length;t++){var i=n[t];i.parent===this&&i._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.getBones=function(){console.warn("Deprecated.");for(var e=new Array,t=0,n=this._armature.getBones();t<n.length;t++){var i=n[t];i.parent===this&&e.push(i)}return e},n.prototype.getSlots=function(){console.warn("Deprecated.");for(var e=new Array,t=0,n=this._armature.getSlots();t<n.length;t++){var i=n[t];i.parent===this&&e.push(i)}return e},Object.defineProperty(n.prototype,"slot",{get:function(){console.warn("Deprecated.");for(var e=0,t=this._armature.getSlots();e<t.length;e++){var n=t[e];if(n.parent===this)return n}return null},enumerable:!0,configurable:!0}),n}(e.TransformObject);e.Bone=t}(Xk||(Xk={})),function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._vertices=[],t._deformVertices=[],t._hullCache=[],t._matrixCahce=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.Surface]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this._dX=0,this._dY=0,this._k=0,this._kX=0,this._kY=0,this._vertices.length=0,this._deformVertices.length=0,this._matrixCahce.length=0,this._hullCache.length=0},t.prototype._getAffineTransform=function(e,t,n,i,r,a,o,s,c,l,u,h,_){var f=o-r,p=s-a,d=c-r,m=l-a;u.rotation=Math.atan2(p,f),u.skew=Math.atan2(m,d)-.5*Math.PI-u.rotation,_&&(u.rotation+=Math.PI),u.scaleX=Math.sqrt(f*f+p*p)/n,u.scaleY=Math.sqrt(d*d+m*m)/i,u.toMatrix(h),u.x=h.tx=r-(h.a*e+h.c*t),u.y=h.ty=a-(h.b*e+h.d*t)},t.prototype._updateVertices=function(){var e=this._boneData.vertices,t=this._vertices,n=this._deformVertices;if(null!==this._parent)if(1===this._parent._boneData.type)for(var i=0,r=e.length;i<r;i+=2){var a=e[i]+n[i],o=e[i+1]+n[i],s=this._parent._getGlobalTransformMatrix(a,o);t[i]=s.a*a+s.c*o+s.tx,t[i+1]=s.b*a+s.d*o+s.ty}else{var c=this._parent.globalTransformMatrix;for(i=0,r=e.length;i<r;i+=2)a=e[i]+n[i],o=e[i+1]+n[i+1],t[i]=c.a*a+c.c*o+c.tx,t[i+1]=c.b*a+c.d*o+c.ty}else for(i=0,r=e.length;i<r;i+=2)t[i]=e[i]+n[i],t[i+1]=e[i+1]+n[i+1]},t.prototype._updateGlobalTransformMatrix=function(){var e=2*this._boneData.segmentX,t=this._vertices.length-2,n=this._vertices[0],i=this._vertices[1],r=this._vertices[e],a=this._vertices[e+1],o=this._vertices[t],s=this._vertices[t+1],c=this._vertices[t-e],l=this._vertices[t-e+1],u=n+.5*(o-n),h=i+.5*(s-i),_=u+.5*(r+.5*(c-r)-u),f=h+.5*(a+.5*(l-a)-h),p=r+.5*(o-r),d=a+.5*(s-a),m=c+.5*(o-c),v=l+.5*(s-l);this._globalDirty=!1,this._getAffineTransform(0,0,200,200,_,f,p,d,m,v,this.global,this.globalTransformMatrix,!1)},t.prototype._getGlobalTransformMatrix=function(e,n){var i=1e3;if(e<-i||i<e||n<-i||i<n)return this.globalTransformMatrix;var r=!1,a=200,o=this._boneData,s=o.segmentX,c=o.segmentY,l=2*o.segmentX,u=this._dX,h=this._dY,_=Math.floor((e+a)/u),f=Math.floor((n+a)/h),p=0,d=_*u-a,m=f*h-a,v=this._matrixCahce,g=t._helpMatrix;if(e<-a){if(n<-a||n>=a)return this.globalTransformMatrix;if(p=7*(2*(s*(c+1)+2*s+c+f)+((r=n>this._kX*(e+a)+m)?1:0)),this._matrixCahce[p]>0)g.copyFromArray(v,p+1);else{var y=f*(l+2),x=this._hullCache[4],S=this._hullCache[5],T=this._hullCache[2]-(c-f)*x,E=this._hullCache[3]-(c-f)*S,A=this._vertices;r?this._getAffineTransform(-a,m+h,800,h,A[y+l+2],A[y+l+3],T+x,E+S,A[y],A[y+1],t._helpTransform,g,!0):this._getAffineTransform(-i,m,800,h,T,E,A[y],A[y+1],T+x,E+S,t._helpTransform,g,!1),v[p]=1,v[p+1]=g.a,v[p+2]=g.b,v[p+3]=g.c,v[p+4]=g.d,v[p+5]=g.tx,v[p+6]=g.ty}}else if(e>=a){if(n<-a||n>=a)return this.globalTransformMatrix;p=7*(2*(s*(c+1)+s+f)+((r=n>this._kX*(e-i)+m)?1:0)),this._matrixCahce[p]>0?g.copyFromArray(v,p+1):(y=(f+1)*(l+2)-2,x=this._hullCache[4],S=this._hullCache[5],T=this._hullCache[0]+f*x,E=this._hullCache[1]+f*S,A=this._vertices,r?this._getAffineTransform(i,m+h,800,h,T+x,E+S,A[y+l+2],A[y+l+3],T,E,t._helpTransform,g,!0):this._getAffineTransform(a,m,800,h,A[y],A[y+1],T,E,A[y+l+2],A[y+l+3],t._helpTransform,g,!1),v[p]=1,v[p+1]=g.a,v[p+2]=g.b,v[p+3]=g.c,v[p+4]=g.d,v[p+5]=g.tx,v[p+6]=g.ty)}else if(n<-a){if(e<-a||e>=a)return this.globalTransformMatrix;p=7*(s*(c+1)+2*_+((r=n>this._kY*(e-d-u)-i)?1:0)),this._matrixCahce[p]>0?g.copyFromArray(v,p+1):(y=2*_,x=this._hullCache[10],S=this._hullCache[11],T=this._hullCache[8]+_*x,E=this._hullCache[9]+_*S,A=this._vertices,r?this._getAffineTransform(d+u,-a,u,800,A[y+2],A[y+3],A[y],A[y+1],T+x,E+S,t._helpTransform,g,!0):this._getAffineTransform(d,-i,u,800,T,E,T+x,E+S,A[y],A[y+1],t._helpTransform,g,!1),v[p]=1,v[p+1]=g.a,v[p+2]=g.b,v[p+3]=g.c,v[p+4]=g.d,v[p+5]=g.tx,v[p+6]=g.ty)}else if(n>=a){if(e<-a||e>=a)return this.globalTransformMatrix;p=7*(2*(s*(c+1)+s+c+f)+((r=n>this._kY*(e-d-u)+a)?1:0)),this._matrixCahce[p]>0?g.copyFromArray(v,p+1):(y=c*(l+2)+2*_,x=this._hullCache[10],S=this._hullCache[11],T=this._hullCache[6]-(s-_)*x,E=this._hullCache[7]-(s-_)*S,A=this._vertices,r?this._getAffineTransform(d+u,i,u,800,T+x,E+S,T,E,A[y+2],A[y+3],t._helpTransform,g,!0):this._getAffineTransform(d,a,u,800,A[y],A[y+1],A[y+2],A[y+3],T,E,t._helpTransform,g,!1),v[p]=1,v[p+1]=g.a,v[p+2]=g.b,v[p+3]=g.c,v[p+4]=g.d,v[p+5]=g.tx,v[p+6]=g.ty)}else p=7*(2*(s*f+_)+((r=n>this._k*(e-d-u)+m)?1:0)),this._matrixCahce[p]>0?g.copyFromArray(v,p+1):(y=2*_+f*(l+2),A=this._vertices,r?this._getAffineTransform(d+u,m+h,u,h,A[y+l+4],A[y+l+5],A[y+l+2],A[y+l+3],A[y+2],A[y+3],t._helpTransform,g,!0):this._getAffineTransform(d,m,u,h,A[y],A[y+1],A[y+2],A[y+3],A[y+l+2],A[y+l+3],t._helpTransform,g,!1),v[p]=1,v[p+1]=g.a,v[p+2]=g.b,v[p+3]=g.c,v[p+4]=g.d,v[p+5]=g.tx,v[p+6]=g.ty);return g},t.prototype.init=function(t,n){if(null===this._boneData){e.prototype.init.call(this,t,n);var i=t.segmentX,r=t.segmentY,a=t.vertices.length;this._dX=400/i,this._dY=400/r,this._k=-this._dY/this._dX,this._kX=-this._dY/800,this._kY=-800/this._dX,this._vertices.length=a,this._deformVertices.length=a,this._matrixCahce.length=14*(i*r+2*i+2*r),this._hullCache.length=10;for(var o=0;o<a;++o)this._deformVertices[o]=0}},t.prototype.update=function(e){if(this._blendState.dirty=!1,e>=0&&null!==this._cachedFrameIndices){var n=this._cachedFrameIndices[e];if(n>=0&&this._cachedFrameIndex===n)this._transformDirty=!1;else if(n>=0)this._transformDirty=!0,this._cachedFrameIndex=n;else{if(this._hasConstraint)for(var i=0,r=this._armature._constraints;i<r.length;i++)(s=r[i])._root===this&&s.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[e]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var a=0,o=this._armature._constraints;a<o.length;a++){var s;(s=o[a])._root===this&&s.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(e=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty){this._transformDirty=!1,this._childrenTransformDirty=!0;for(var c=0,l=this._matrixCahce.length;c<l;c+=7)this._matrixCahce[c]=-1;if(this._updateVertices(),this._cachedFrameIndex<0){var u=e>=0;this._localDirty&&this._updateGlobalTransformMatrix(u),u&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[e]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);var h=2*this.global.x,_=2*this.global.y,f=t._helpPoint;this.globalTransformMatrix.transformPoint(1e3,-200,f),this._hullCache[0]=f.x,this._hullCache[1]=f.y,this._hullCache[2]=h-f.x,this._hullCache[3]=_-f.y,this.globalTransformMatrix.transformPoint(0,this._dY,f,!0),this._hullCache[4]=f.x,this._hullCache[5]=f.y,this.globalTransformMatrix.transformPoint(200,1e3,f),this._hullCache[6]=f.x,this._hullCache[7]=f.y,this._hullCache[8]=h-f.x,this._hullCache[9]=_-f.y,this.globalTransformMatrix.transformPoint(this._dX,0,f,!0),this._hullCache[10]=f.x,this._hullCache[11]=f.y}else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},t}(e.Bone);e.Surface=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n._localMatrix=new e.Matrix,n._colorTransform=new e.ColorTransform,n._displayDatas=[],n._displayList=[],n._deformVertices=null,n._rawDisplay=null,n._meshDisplay=null,n}return qk(n,t),n.prototype._onClear=function(){t.prototype._onClear.call(this);for(var n=[],i=0,r=this._displayList;i<r.length;i++)null!==(s=r[i])&&s!==this._rawDisplay&&s!==this._meshDisplay&&n.indexOf(s)<0&&n.push(s);for(var a=0,o=n;a<o.length;a++){var s;(s=o[a])instanceof e.Armature?s.dispose():this._disposeDisplay(s,!0)}null!==this._deformVertices&&this._deformVertices.returnToPool(),null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDirty=!1,this._zOrderDirty=!1,this._blendModeDirty=!1,this._colorDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayList.length=0,this._displayDatas.length=0,this._slotData=null,this._rawDisplayDatas=null,this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._deformVertices=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},n.prototype._getDefaultRawDisplayData=function(e){var t=this._armature._armatureData.defaultSkin;if(null!==t){var n=t.getDisplays(this._slotData.name);if(null!==n)return e<n.length?n[e]:null}return null},n.prototype._updateDisplayData=function(){var t=this._displayData,i=null!==this._deformVertices?this._deformVertices.verticesData:null,r=this._textureData,a=null,o=null;if(this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._displayIndex>=0&&(null!==this._rawDisplayDatas&&(a=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null),null===a&&(a=this._getDefaultRawDisplayData(this._displayIndex)),this._displayIndex<this._displayDatas.length&&(this._displayData=this._displayDatas[this._displayIndex])),null!==this._displayData&&(2===this._displayData.type||4===this._displayData.type?o=this._displayData.vertices:null!==a&&(2===a.type||4===a.type)&&(o=a.vertices),3===this._displayData.type?this._boundingBoxData=this._displayData.boundingBox:null!==a&&3===a.type&&(this._boundingBoxData=a.boundingBox),(0===this._displayData.type||2===this._displayData.type)&&(this._textureData=this._displayData.texture)),this._displayData!==t||o!==i||this._textureData!==r){if(null===o&&null!==this._textureData){var s=this._displayData,c=this._textureData.parent.scale*this._armature._armatureData.scale,l=this._textureData.frame;this._pivotX=s.pivot.x,this._pivotY=s.pivot.y;var u=null!==l?l:this._textureData.region,h=u.width,_=u.height;this._textureData.rotated&&null===l&&(h=u.height,_=u.width),this._pivotX*=h*c,this._pivotY*=_*c,null!==l&&(this._pivotX+=l.x*c,this._pivotY+=l.y*c),null!==this._displayData&&null!==a&&this._displayData!==a&&(a.transform.toMatrix(n._helpMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(0,0,n._helpPoint),this._pivotX-=n._helpPoint.x,this._pivotY-=n._helpPoint.y,this._displayData.transform.toMatrix(n._helpMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(0,0,n._helpPoint),this._pivotX+=n._helpPoint.x,this._pivotY+=n._helpPoint.y),e.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*c-this._pivotY)}else this._pivotX=0,this._pivotY=0;null!==a?this.origin=a.transform:null!==this._displayData?this.origin=this._displayData.transform:this.origin=null,o!==i?(null===this._deformVertices&&(this._deformVertices=e.BaseObject.borrowObject(e.DeformVertices)),this._deformVertices.init(o,this._armature)):null!==this._deformVertices&&this._textureData!==r&&(this._deformVertices.verticesDirty=!0),this._displayDirty=!0,this._transformDirty=!0}},n.prototype._updateDisplay=function(){var t=null!==this._display?this._display:this._rawDisplay,n=this._childArmature;this._displayIndex>=0&&this._displayIndex<this._displayList.length?(this._display=this._displayList[this._displayIndex],null!==this._display&&this._display instanceof e.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null);var i=null!==this._display?this._display:this._rawDisplay;if(i!==t&&(this._onUpdateDisplay(),this._replaceDisplay(t),this._transformDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0),i!==this._rawDisplay&&i!==this._meshDisplay||this._updateFrame(),this._childArmature!==n&&(null!==n&&(n._parent=null,n.clock=null,n.inheritAnimation&&n.animation.reset()),null!==this._childArmature&&(this._childArmature._parent=this,this._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var r=this._armature.cacheFrameRate;0!==r&&(this._childArmature.cacheFrameRate=r)}var a=null;if(null!==this._displayData&&1===this._displayData.type)a=this._displayData.actions;else if(this._displayIndex>=0&&null!==this._rawDisplayDatas){var o=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null;null===o&&(o=this._getDefaultRawDisplayData(this._displayIndex)),null!==o&&1===o.type&&(a=o.actions)}if(null!==a&&a.length>0)for(var s=0,c=a;s<c.length;s++){var l=c[s],u=e.BaseObject.borrowObject(e.EventObject);e.EventObject.actionDataToInstance(l,u,this._armature),u.slot=this,this._armature._bufferAction(u,!1)}else this._childArmature.animation.play()}},n.prototype._updateGlobalTransformMatrix=function(e){var t=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(t),e?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},n.prototype._setDisplayIndex=function(e,t){if(void 0===t&&(t=!1),t){if(this._animationDisplayIndex===e)return!1;this._animationDisplayIndex=e}return this._displayIndex!==e&&(this._displayIndex=e,this._displayDirty=!0,this._updateDisplayData(),this._displayDirty)},n.prototype._setZorder=function(e){return this._zOrder,this._zOrder=e,this._zOrderDirty=!0,this._zOrderDirty},n.prototype._setColor=function(e){return this._colorTransform.copyFrom(e),this._colorDirty=!0,this._colorDirty},n.prototype._setDisplayList=function(t){if(null!==t&&t.length>0){this._displayList.length!==t.length&&(this._displayList.length=t.length);for(var n=0,i=t.length;n<i;++n){var r=t[n];null!==r&&r!==this._rawDisplay&&r!==this._meshDisplay&&!(r instanceof e.Armature)&&this._displayList.indexOf(r)<0&&this._initDisplay(r,!0),this._displayList[n]=r}}else this._displayList.length>0&&(this._displayList.length=0);return this._displayIndex>=0&&this._displayIndex<this._displayList.length?this._displayDirty=this._display!==this._displayList[this._displayIndex]:this._displayDirty=null!==this._display,this._updateDisplayData(),this._displayDirty},n.prototype.init=function(e,t,n,i){if(null===this._slotData){this._slotData=e,this._isFromCache=!1,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=n,this._meshDisplay=i,this._armature=t;var r=this._armature.getBone(this._slotData.parent.name);null!==r&&(this._parent=r),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},n.prototype.update=function(e){if(this._isFromCache=!1,this._displayDirty&&(this._displayDirty=!1,this._updateDisplay(),this._transformDirty&&(null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix))),this._zOrderDirty&&(this._zOrderDirty=!1,this._updateZOrder()),e>=0&&null!==this._cachedFrameIndices){var t=this._cachedFrameIndices[e];t>=0&&this._cachedFrameIndex===t?this._transformDirty=!1:t>=0?(this._transformDirty=!0,this._cachedFrameIndex=t):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[e]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(e=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(null!==this._display){if(this._visibleDirty&&(this._visibleDirty=!1,this._updateVisible()),this._blendModeDirty&&(this._blendModeDirty=!1,this._updateBlendMode()),this._colorDirty&&(this._colorDirty=!1,this._updateColor()),null!==this._deformVertices&&null!==this._deformVertices.verticesData&&this._display===this._meshDisplay){var n=null!==this._deformVertices.verticesData.weight,i=0!==this._parent._boneData.type;if((this._deformVertices.verticesDirty||n&&this._deformVertices.isBonesUpdate()||i&&this._parent._childrenTransformDirty)&&(this._deformVertices.verticesDirty=!1,this._updateMesh()),n||i)return}if(this._transformDirty){if(this._transformDirty=!1,this._cachedFrameIndex<0){var r=e>=0;this._updateGlobalTransformMatrix(r),r&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[e]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._isFromCache=!0,this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform()}}},n.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._transformDirty=!1,this._updateGlobalTransformMatrix(!1))},n.prototype.replaceDisplayData=function(e,t){if(void 0===t&&(t=-1),t<0&&(t=this._displayIndex<0?0:this._displayIndex),this._displayDatas.length<=t){this._displayDatas.length=t+1;for(var n=0,i=this._displayDatas.length;n<i;++n)this._displayDatas[n]||(this._displayDatas[n]=null)}this._displayDatas[t]=e},n.prototype.containsPoint=function(e,t){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),n._helpMatrix.copyFrom(this.globalTransformMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(e,t,n._helpPoint),this._boundingBoxData.containsPoint(n._helpPoint.x,n._helpPoint.y))},n.prototype.intersectsSegment=function(e,t,i,r,a,o,s){if(void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),n._helpMatrix.copyFrom(this.globalTransformMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(e,t,n._helpPoint),e=n._helpPoint.x,t=n._helpPoint.y,n._helpMatrix.transformPoint(i,r,n._helpPoint),i=n._helpPoint.x,r=n._helpPoint.y;var c=this._boundingBoxData.intersectsSegment(e,t,i,r,a,o,s);return c>0&&(1===c||2===c?null!==a?(this.globalTransformMatrix.transformPoint(a.x,a.y,a),null!==o&&(o.x=a.x,o.y=a.y)):null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o):(null!==a&&this.globalTransformMatrix.transformPoint(a.x,a.y,a),null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o)),null!==s&&(this.globalTransformMatrix.transformPoint(Math.cos(s.x),Math.sin(s.x),n._helpPoint,!0),s.x=Math.atan2(n._helpPoint.y,n._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(s.y),Math.sin(s.y),n._helpPoint,!0),s.y=Math.atan2(n._helpPoint.y,n._helpPoint.x))),c},n.prototype.invalidUpdate=function(){this._displayDirty=!0,this._transformDirty=!0},Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(e){this._setDisplayIndex(e)&&this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayList",{get:function(){return this._displayList.concat()},set:function(t){var n=this._displayList.concat(),i=new Array;this._setDisplayList(t)&&this.update(-1);for(var r=0,a=n;r<a.length;r++)null!==(c=a[r])&&c!==this._rawDisplay&&c!==this._meshDisplay&&this._displayList.indexOf(c)<0&&i.indexOf(c)<0&&i.push(c);for(var o=0,s=i;o<s.length;o++){var c;(c=s[o])instanceof e.Armature||this._disposeDisplay(c,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rawDisplayDatas",{get:function(){return this._rawDisplayDatas},set:function(e){if(this._rawDisplayDatas!==e)if(this._displayDirty=!0,this._rawDisplayDatas=e,null!==this._rawDisplayDatas){this._displayDatas.length=this._rawDisplayDatas.length;for(var t=0,n=this._displayDatas.length;t<n;++t){var i=this._rawDisplayDatas[t];null===i&&(i=this._getDefaultRawDisplayData(t)),this._displayDatas[t]=i}}else this._displayDatas.length=0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayData",{get:function(){return this._displayData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"display",{get:function(){return this._display},set:function(e){if(this._display!==e){var t=this._displayList.length;if(this._displayIndex<0&&0===t&&(this._displayIndex=0),!(this._displayIndex<0)){var n=this.displayList;t<=this._displayIndex&&(n.length=this._displayIndex+1),n[this._displayIndex]=e,this.displayList=n}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"childArmature",{get:function(){return this._childArmature},set:function(e){this._childArmature!==e&&(this.display=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.getDisplay=function(){return this._display},n.prototype.setDisplay=function(e){this.display=e},n}(e.TransformObject);e.Slot=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(n.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),n._helpMatrix=new e.Matrix,n._helpTransform=new e.Transform,n._helpPoint=new e.Point,n}(e.BaseObject);e.Constraint=t;var n=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.toString=function(){return"[class dragonBones.IKConstraint]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},n.prototype._computeA=function(){var t=this._target.global,n=this._root.global,i=this._root.globalTransformMatrix,r=Math.atan2(t.y-n.y,t.x-n.x);n.scaleX<0&&(r+=Math.PI),n.rotation+=e.Transform.normalizeRadian(r-n.rotation)*this._weight,n.toMatrix(i)},n.prototype._computeB=function(){var t=this._bone._boneData.length,n=this._root,i=this._target.global,r=n.global,a=this._bone.global,o=this._bone.globalTransformMatrix,s=o.a*t,c=o.b*t,l=s*s+c*c,u=Math.sqrt(l),h=a.x-r.x,_=a.y-r.y,f=h*h+_*_,p=Math.sqrt(f),d=a.rotation,m=r.rotation,v=Math.atan2(_,h),g=(h=i.x-r.x)*h+(_=i.y-r.y)*_,y=Math.sqrt(g),x=0;if(u+p<=y||y+u<=p||y+p<=u)x=Math.atan2(i.y-r.y,i.x-r.x),u+p<=y||p<u&&(x+=Math.PI);else{var S=(f-l+g)/(2*g),T=Math.sqrt(f-S*S*g)/y,E=r.x+h*S,A=r.y+_*S,C=-_*T,b=h*T,P=!1,R=n.parent;if(null!==R){var I=R.globalTransformMatrix;P=I.a*I.d-I.b*I.c<0}P!==this._bendPositive?(a.x=E-C,a.y=A-b):(a.x=E+C,a.y=A+b),x=Math.atan2(a.y-r.y,a.x-r.x)}var w=e.Transform.normalizeRadian(x-v);r.rotation=m+w*this._weight,r.toMatrix(n.globalTransformMatrix);var D=v+w*this._weight;a.x=r.x+Math.cos(D)*p,a.y=r.y+Math.sin(D)*p;var O=Math.atan2(i.y-a.y,i.x-a.x);a.scaleX<0&&(O+=Math.PI),a.rotation=r.rotation+d-m+e.Transform.normalizeRadian(O-w-d)*this._weight,a.toMatrix(o)},n.prototype.init=function(e,t){if(null===this._constraintData){this._constraintData=e,this._armature=t,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var n=this._constraintData;this._scaleEnabled=n.scaleEnabled,this._bendPositive=n.bendPositive,this._weight=n.weight,this._root._hasConstraint=!0}},n.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},n.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},n}(t);e.IKConstraint=n;var i=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._bones=[],e._spaces=[],e._positions=[],e._curves=[],e._boneLengths=[],e._pathGlobalVertices=[],e._segments=[10],e}return qk(n,t),n.toString=function(){return"[class dragonBones.PathConstraint]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},n.prototype._updatePathVertices=function(e){var t=this._armature,n=t.armatureData.parent,i=t.armatureData.scale,r=n.intArray,a=n.floatArray,o=e.offset,s=r[o+0],c=r[o+2];this._pathGlobalVertices.length=2*s;var l=e.weight;if(null!==l)for(var u=this._pathSlot._deformVertices.bones,h=l.bones.length,_=l.offset,f=r[_+1],p=_+2+h,d=(A=0,0);A<s;A++){for(var m=0,v=0,g=0,y=r[p++];g<y;g++){var x=u[r[p++]];if(null!==x){x.updateByConstraint(),E=x.globalTransformMatrix;var S=a[f++];b=a[f++]*i,P=a[f++]*i,m+=(E.a*b+E.c*P+E.tx)*S,v+=(E.b*b+E.d*P+E.ty)*S}}this._pathGlobalVertices[d++]=m,this._pathGlobalVertices[d++]=v}else{var T=this._pathSlot.parent;T.updateByConstraint();for(var E=T.globalTransformMatrix,A=0,C=c;A<s;A+=2){var b=a[C++]*i,P=a[C++]*i,R=E.a*b+E.c*P+E.tx,I=E.b*b+E.d*P+E.ty;this._pathGlobalVertices[A]=R,this._pathGlobalVertices[A+1]=I}}},n.prototype._computeVertices=function(e,t,n,i){for(var r=n,a=e;r<t;r+=2)i[r]=this._pathGlobalVertices[a++],i[r+1]=this._pathGlobalVertices[a++]},n.prototype._computeBezierCurve=function(e,t,n,i,r){var a=this._armature.armatureData.parent.intArray[e.vertices.offset+0],o=this._positions,s=this._spaces,c=e.closed,l=Array(),u=2*a,h=u/6,_=-1,f=this.position;o.length=3*t+2;var p=0;if(e.constantSpeed){c?(u+=2,l.length=a,this._computeVertices(2,u-4,0,l),this._computeVertices(0,2,u-4,l),l[u-2]=l[0],l[u-1]=l[1]):(h--,u-=4,l.length=u,this._computeVertices(2,u,0,l));var d=new Array(h);p=0;for(var m,v,g,y,x,S,T,E,A=l[0],C=l[1],b=0,P=0,R=0,I=0,w=0,D=0,O=(H=0,2);H<h;H++,O+=6)b=l[O],P=l[O+1],R=l[O+2],I=l[O+3],x=2*(m=.1875*(A-2*b+R))+(g=.09375*(3*(b-R)-A+(w=l[O+4]))),S=2*(v=.1875*(C-2*P+I))+(y=.09375*(3*(P-I)-C+(D=l[O+5]))),T=.75*(b-A)+m+.16666667*g,E=.75*(P-C)+v+.16666667*y,p+=Math.sqrt(T*T+E*E),T+=x,E+=S,x+=g,S+=y,p+=Math.sqrt(T*T+E*E),T+=x,E+=S,p+=Math.sqrt(T*T+E*E),T+=x+g,E+=S+y,p+=Math.sqrt(T*T+E*E),d[H]=p,A=w,C=D;if(i&&(f*=p),r)for(H=0;H<t;H++)s[H]*=p;for(var M=this._segments,N=0,B=(H=0,V=0,j=0,0);H<t;H++,V+=3){var F=f+=s[H];if(c)(F%=p)<0&&(F+=p),j=0;else{if(F<0)continue;if(F>p)continue}for(;;j++){var L=d[j];if(!(F>L)){0===j?F/=L:F=(F-(G=d[j-1]))/(L-G);break}}if(j!==_){_=j;var z=6*j;for(A=l[z],C=l[z+1],b=l[z+2],P=l[z+3],R=l[z+4],I=l[z+5],x=2*(m=.03*(A-2*b+R))+(g=.006*(3*(b-R)-A+(w=l[z+6]))),S=2*(v=.03*(C-2*P+I))+(y=.006*(3*(P-I)-C+(D=l[z+7]))),T=.3*(b-A)+m+.16666667*g,E=.3*(P-C)+v+.16666667*y,N=Math.sqrt(T*T+E*E),M[0]=N,z=1;z<8;z++)T+=x,E+=S,x+=g,S+=y,N+=Math.sqrt(T*T+E*E),M[z]=N;T+=x,E+=S,N+=Math.sqrt(T*T+E*E),M[8]=N,T+=x+g,E+=S+y,N+=Math.sqrt(T*T+E*E),M[9]=N,B=0}for(F*=N;;B++){var U=M[B];if(!(F>U)){var G;0===B?F/=U:F=B+(F-(G=M[B-1]))/(U-G);break}}this.addCurvePosition(.1*F,A,C,b,P,R,I,w,D,o,V,n)}}else{var k=e.curveLengths;if(p=k[h-=c?1:2],i&&(f*=p),r)for(var H=0;H<t;H++)s[H]*=p;l.length=8;H=0;for(var V=0,j=0;H<t;H++,V+=3){if(f+=s[H],c)(f%=p)<0&&(f+=p),j=0;else{if(f<0)continue;if(f>p)continue}for(var W=0;;j++){var q=k[j];if(!(f>q)){if(0===j)W=f/q;else{var X=k[j-1];W=(f-X)/(q-X)}break}}j!==_&&(_=j,c&&j===h?(this._computeVertices(u-4,4,0,l),this._computeVertices(0,4,4,l)):this._computeVertices(6*j+2,8,0,l)),this.addCurvePosition(W,l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7],o,V,n)}}},n.prototype.addCurvePosition=function(e,t,n,i,r,a,o,s,c,l,u,h){if(0===e)return l[u]=t,l[u+1]=n,void(l[u+2]=0);if(1===e)return l[u]=s,l[u+1]=c,void(l[u+2]=0);var _=1-e,f=_*_,p=e*e,d=f*_,m=f*e*3,v=_*p*3,g=e*p,y=d*t+m*i+v*a+g*s,x=d*n+m*r+v*o+g*c;l[u]=y,l[u+1]=x,l[u+2]=h?Math.atan2(x-(d*n+m*r+v*o),y-(d*t+m*i+v*a)):0},n.prototype.init=function(e,t){this._constraintData=e,this._armature=t;var n=e;this.pathOffset=n.pathDisplayData.vertices.offset,this.position=n.position,this.spacing=n.spacing,this.rotateOffset=n.rotateOffset,this.rotateMix=n.rotateMix,this.translateMix=n.translateMix,this._root=this._armature.getBone(n.root.name),this._target=this._armature.getBone(n.target.name),this._pathSlot=this._armature.getSlot(n.pathSlot.name);for(var i=0,r=n.bones.length;i<r;i++){var a=this._armature.getBone(n.bones[i].name);null!==a&&this._bones.push(a)}2===n.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},n.prototype.update=function(){var t=this._pathSlot;if(null!==t._deformVertices&&null!==t._deformVertices.verticesData&&t._deformVertices.verticesData.offset===this.pathOffset){var n=this._constraintData,i=t._displayData,r=!1,a=t._deformVertices;if(this._root._childrenTransformDirty?(this._updatePathVertices(i.vertices),r=!0):null!==a&&(a.verticesDirty||a.isBonesUpdate())&&(this._updatePathVertices(i.vertices),a.verticesDirty=!1,r=!0),r||this.dirty){var o=n.positionMode,s=n.spacingMode,c=n.rotateMode,l=this._bones,u=0===s,h=2===c,_=0===c,f=l.length,p=_?f:f+1,d=this.spacing,m=this._spaces;if(m.length=p,h||u){m[0]=0;for(var v=0,g=p-1;v<g;v++){(D=l[v]).updateByConstraint();var y=D._boneData.length,x=y*(O=D.globalTransformMatrix).a,S=y*O.b,T=Math.sqrt(x*x+S*S);h&&(this._boneLengths[v]=T),m[v+1]=(y+d)*T/y}}else for(v=0;v<p;v++)m[v]=d;this._computeBezierCurve(i,p,_,1===o,2===s);var E,A=this._positions,C=this.rotateOffset,b=A[0],P=A[1];0===C?E=1===c:(E=!1,null!==(D=t.parent)&&(C*=(O=D.globalTransformMatrix).a*O.d-O.b*O.c>0?e.Transform.DEG_RAD:-e.Transform.DEG_RAD));for(var R=this.rotateMix,I=this.translateMix,w=(v=0,3);v<f;v++,w+=3){var D,O;(D=l[v]).updateByConstraint(),(O=D.globalTransformMatrix).tx+=(b-O.tx)*I,O.ty+=(P-O.ty)*I;var M=(x=A[w])-b,N=(S=A[w+1])-P;if(h){var B=this._boneLengths[v],F=(Math.sqrt(M*M+N*N)/B-1)*R+1;O.a*=F,O.b*=F}if(b=x,P=S,R>0){var L=O.a,z=O.b,U=O.c,G=O.d,k=void 0,H=void 0,V=void 0;if(k=_?A[w-1]:Math.atan2(N,M),k-=Math.atan2(z,L),E){H=Math.cos(k),V=Math.sin(k);var j=D._boneData.length;b+=(j*(H*L-V*z)-M)*R,P+=(j*(V*L+H*z)-N)*R}else k+=C;k>e.Transform.PI?k-=e.Transform.PI_D:k<-e.Transform.PI&&(k+=e.Transform.PI_D),k*=R,H=Math.cos(k),V=Math.sin(k),O.a=H*L-V*z,O.b=V*L+H*z,O.c=H*U-V*G,O.d=V*U+H*G}D.global.fromMatrix(O)}this.dirty=!1}}},n.prototype.invalidUpdate=function(){},n}(t);e.PathConstraint=i}(Xk||(Xk={})),function(e){var t=function(){function e(e){void 0===e&&(e=0),this.time=0,this.timeScale=1,this._systemTime=0,this._animatebles=[],this._clock=null,this.time=e,this._systemTime=.001*(new Date).getTime()}return e.prototype.advanceTime=function(e){e!=e&&(e=0);var t=.001*Date.now();if(e<0&&(e=t-this._systemTime),this._systemTime=t,1!==this.timeScale&&(e*=this.timeScale),0!==e){e<0?this.time-=e:this.time+=e;for(var n=0,i=0,r=this._animatebles.length;n<r;++n){var a=this._animatebles[n];null!==a?(i>0&&(this._animatebles[n-i]=a,this._animatebles[n]=null),a.advanceTime(e)):i++}if(i>0){for(r=this._animatebles.length;n<r;++n){var o=this._animatebles[n];null!==o?this._animatebles[n-i]=o:i++}this._animatebles.length-=i}}},e.prototype.contains=function(e){if(e===this)return!1;for(var t=e;t!==this&&null!==t;)t=t.clock;return t===this},e.prototype.add=function(e){this._animatebles.indexOf(e)<0&&(this._animatebles.push(e),e.clock=this)},e.prototype.remove=function(e){var t=this._animatebles.indexOf(e);t>=0&&(this._animatebles[t]=null,e.clock=null)},e.prototype.clear=function(){for(var e=0,t=this._animatebles;e<t.length;e++){var n=t[e];null!==n&&(n.clock=null)}},Object.defineProperty(e.prototype,"clock",{get:function(){return this._clock},set:function(e){this._clock!==e&&(null!==this._clock&&this._clock.remove(this),this._clock=e,null!==this._clock&&this._clock.add(this))},enumerable:!0,configurable:!0}),e.clock=new e,e}();e.WorldClock=t}(Xk||(Xk={})),function(e){var t=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._animationNames=[],e._animationStates=[],e._animations={},e._animationConfig=null,e}return qk(n,t),n.toString=function(){return"[class dragonBones.Animation]"},n.prototype._onClear=function(){for(var e=0,t=this._animationStates;e<t.length;e++)t[e].returnToPool();for(var n in this._animations)delete this._animations[n];null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._lockUpdate=!1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},n.prototype._fadeOut=function(e){switch(e.fadeOutMode){case 1:for(var t=0,n=this._animationStates;t<n.length;t++)null===(l=n[t])._parent&&l.layer===e.layer&&l.fadeOut(e.fadeOutTime,e.pauseFadeOut);break;case 2:for(var i=0,r=this._animationStates;i<r.length;i++)null===(l=r[i])._parent&&l.group===e.group&&l.fadeOut(e.fadeOutTime,e.pauseFadeOut);break;case 3:for(var a=0,o=this._animationStates;a<o.length;a++)null===(l=o[a])._parent&&l.layer===e.layer&&l.group===e.group&&l.fadeOut(e.fadeOutTime,e.pauseFadeOut);break;case 4:for(var s=0,c=this._animationStates;s<c.length;s++){var l;null===(l=c[s])._parent&&l.fadeOut(e.fadeOutTime,e.pauseFadeOut)}}},n.prototype.init=function(t){null===this._armature&&(this._armature=t,this._animationConfig=e.BaseObject.borrowObject(e.AnimationConfig))},n.prototype.advanceTime=function(e){e<0&&(e=-e),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(e*=this._inheritTimeScale);var t=this._animationStates.length;if(1===t)if((p=this._animationStates[0])._fadeState>0&&p._subFadeState>0)this._armature._dragonBones.bufferObject(p),this._animationStates.length=0,this._lastAnimationState=null;else{var n=p._animationData,i=n.cacheFrameRate;if(this._animationDirty&&i>0){this._animationDirty=!1;for(var r=0,a=this._armature.getBones();r<a.length;r++){var o=a[r];o._cachedFrameIndices=n.getBoneCachedFrameIndices(o.name)}for(var s=0,c=this._armature.getSlots();s<c.length;s++){var l=c[s],u=l.rawDisplayDatas;if(null!==u&&u.length>0){var h=u[0];if(null!==h&&h.parent===this._armature.armatureData.defaultSkin){l._cachedFrameIndices=n.getSlotCachedFrameIndices(l.name);continue}}l._cachedFrameIndices=null}}p.advanceTime(e,i)}else if(t>1){for(var _=0,f=0;_<t;++_){var p;(p=this._animationStates[_])._fadeState>0&&p._subFadeState>0?(f++,this._armature._dragonBones.bufferObject(p),this._animationDirty=!0,this._lastAnimationState===p&&(this._lastAnimationState=null)):(f>0&&(this._animationStates[_-f]=p),p.advanceTime(e,0)),_===t-1&&f>0&&(this._animationStates.length-=f,null===this._lastAnimationState&&this._animationStates.length>0&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},n.prototype.reset=function(){for(var e=0,t=this._animationStates;e<t.length;e++)t[e].returnToPool();this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},n.prototype.stop=function(e){if(void 0===e&&(e=null),null!==e)null!==(i=this.getState(e))&&i.stop();else for(var t=0,n=this._animationStates;t<n.length;t++){var i;(i=n[t]).stop()}},n.prototype.playConfig=function(t){var n=t.animation;if(!(n in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+n),null;var i=this._animations[n];if(5===t.fadeOutMode)for(var r=0,a=this._animationStates;r<a.length;r++){var o=a[r];if(o._animationData===i)return o}0===this._animationStates.length?t.fadeInTime=0:t.fadeInTime<0&&(t.fadeInTime=i.fadeInTime),t.fadeOutTime<0&&(t.fadeOutTime=t.fadeInTime),t.timeScale<=-100&&(t.timeScale=1/i.scale),i.frameCount>1?(t.position<0?(t.position%=i.duration,t.position=i.duration-t.position):t.position===i.duration?t.position-=1e-6:t.position>i.duration&&(t.position%=i.duration),t.duration>0&&t.position+t.duration>i.duration&&(t.duration=i.duration-t.position),t.playTimes<0&&(t.playTimes=i.playTimes)):(t.playTimes=1,t.position=0,t.duration>0&&(t.duration=0)),0===t.duration&&(t.duration=-1),this._fadeOut(t);var s=e.BaseObject.borrowObject(e.AnimationState);if(s.init(this._armature,i,t),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,this._animationStates.length>0){for(var c=!1,l=0,u=this._animationStates.length;l<u;++l){if(s.layer>this._animationStates[l].layer){c=!0,this._animationStates.splice(l,0,s);break}if(l!==u-1&&s.layer>this._animationStates[l+1].layer){c=!0,this._animationStates.splice(l+1,0,s);break}}c||this._animationStates.push(s)}else this._animationStates.push(s);for(var h=0,_=this._armature.getSlots();h<_.length;h++){var f=_[h].childArmature;null!==f&&f.inheritAnimation&&f.animation.hasAnimation(n)&&null===f.animation.getState(n)&&f.animation.fadeIn(n)}var p=!1;for(var d in i.animationTimelines){this._lockUpdate||(p=!0,this._lockUpdate=!0);var m=this.fadeIn(d,t.fadeInTime,1,s.layer,null,0);null!==m&&(m.resetToPose=!1,m._parent=s,m.stop())}return p&&(this._lockUpdate=!1),this._lockUpdate||(t.fadeInTime<=0&&this._armature.advanceTime(0),this._lastAnimationState=s),s},n.prototype.play=function(e,t){if(void 0===e&&(e=null),void 0===t&&(t=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=t,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==e?e:"",null!==e&&e.length>0)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var n=this._armature.armatureData.defaultAnimation;null!==n&&(this._animationConfig.animation=n.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},n.prototype.fadeIn=function(e,t,n,i,r,a){return void 0===t&&(t=-1),void 0===n&&(n=-1),void 0===i&&(i=0),void 0===r&&(r=null),void 0===a&&(a=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=a,this._animationConfig.playTimes=n,this._animationConfig.layer=i,this._animationConfig.fadeInTime=t,this._animationConfig.animation=e,this._animationConfig.group=null!==r?r:"",this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByTime=function(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.position=t,this._animationConfig.fadeInTime=0,this._animationConfig.animation=e,this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByFrame=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0,this._animationConfig.animation=e;var i=e in this._animations?this._animations[e]:null;return null!==i&&(this._animationConfig.position=i.duration*t/i.frameCount),this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByProgress=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0,this._animationConfig.animation=e;var i=e in this._animations?this._animations[e]:null;return null!==i&&(this._animationConfig.position=i.duration*(t>0?t:0)),this.playConfig(this._animationConfig)},n.prototype.gotoAndStopByTime=function(e,t){void 0===t&&(t=0);var n=this.gotoAndPlayByTime(e,t,1);return null!==n&&n.stop(),n},n.prototype.gotoAndStopByFrame=function(e,t){void 0===t&&(t=0);var n=this.gotoAndPlayByFrame(e,t,1);return null!==n&&n.stop(),n},n.prototype.gotoAndStopByProgress=function(e,t){void 0===t&&(t=0);var n=this.gotoAndPlayByProgress(e,t,1);return null!==n&&n.stop(),n},n.prototype.getState=function(e){for(var t=this._animationStates.length;t--;){var n=this._animationStates[t];if(n.name===e)return n}return null},n.prototype.hasAnimation=function(e){return e in this._animations},n.prototype.getStates=function(){return this._animationStates},Object.defineProperty(n.prototype,"isPlaying",{get:function(){for(var e=0,t=this._animationStates;e<t.length;e++)if(t[e].isPlaying)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isCompleted",{get:function(){for(var e=0,t=this._animationStates;e<t.length;e++)if(!t[e].isCompleted)return!1;return this._animationStates.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animations",{get:function(){return this._animations},set:function(e){if(this._animations!==e){for(var t in this._animationNames.length=0,this._animations)delete this._animations[t];for(var t in e)this._animationNames.push(t),this._animations[t]=e[t]}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),n.prototype.gotoAndPlay=function(e,t,n,i,r,a,o){void 0===t&&(t=-1),void 0===n&&(n=-1),void 0===i&&(i=-1),void 0===r&&(r=0),void 0===a&&(a=null),void 0===o&&(o=3),console.warn("Deprecated."),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=i,this._animationConfig.layer=r,this._animationConfig.fadeInTime=t,this._animationConfig.animation=e,this._animationConfig.group=null!==a?a:"";var s=this._animations[e];return s&&n>0&&(this._animationConfig.timeScale=s.duration/n),this.playConfig(this._animationConfig)},n.prototype.gotoAndStop=function(e,t){return void 0===t&&(t=0),console.warn("Deprecated."),this.gotoAndStopByTime(e,t)},Object.defineProperty(n.prototype,"animationList",{get:function(){return console.warn("Deprecated."),this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationDataList",{get:function(){console.warn("Deprecated.");for(var e=[],t=0,n=this._animationNames.length;t<n;++t)e.push(this._animations[this._animationNames[t]]);return e},enumerable:!0,configurable:!0}),n}(e.BaseObject);e.Animation=t}(Xk||(Xk={})),function(e){var t=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._blendState=new i,e._boneMask=[],e._boneTimelines=[],e._surfaceTimelines=[],e._slotTimelines=[],e._constraintTimelines=[],e._animationTimelines=[],e._poseTimelines=[],e._bonePoses={},e._actionTimeline=null,e._zOrderTimeline=null,e._parent=null,e}return qk(r,t),r.toString=function(){return"[class dragonBones.AnimationState]"},r.prototype._onClear=function(){for(var e=0,t=this._boneTimelines;e<t.length;e++)t[e].returnToPool();for(var n=0,i=this._surfaceTimelines;n<i.length;n++)i[n].returnToPool();for(var r=0,a=this._slotTimelines;r<a.length;r++)a[r].returnToPool();for(var o=0,s=this._constraintTimelines;o<s.length;o++)s[o].returnToPool();for(var c=0,l=this._animationTimelines;c<l.length;c++)l[c].returnToPool();for(var u in this._bonePoses)this._bonePoses[u].returnToPool(),delete this._bonePoses[u];null!==this._actionTimeline&&this._actionTimeline.returnToPool(),null!==this._zOrderTimeline&&this._zOrderTimeline.returnToPool(),this.actionEnabled=!1,this.additiveBlending=!1,this.displayControl=!1,this.resetToPose=!1,this.playTimes=1,this.layer=0,this.timeScale=1,this.weight=1,this.autoFadeOutTime=0,this.fadeTotalTime=0,this.name="",this.group="",this._timelineDirty=2,this._playheadState=0,this._fadeState=-1,this._subFadeState=-1,this._position=0,this._duration=0,this._fadeTime=0,this._time=0,this._fadeProgress=0,this._weightResult=0,this._blendState.clear(),this._boneMask.length=0,this._boneTimelines.length=0,this._surfaceTimelines.length=0,this._slotTimelines.length=0,this._constraintTimelines.length=0,this._animationTimelines.length=0,this._poseTimelines.length=0,this._animationData=null,this._armature=null,this._actionTimeline=null,this._zOrderTimeline=null,this._parent=null},r.prototype._updateTimelines=function(){for(var t=0,n=this._armature._constraints;t<n.length;t++){var i=n[t];if(null!==(c=this._animationData.getConstraintTimelines(i.name)))for(var r=0,a=c;r<a.length;r++)switch((_=a[r]).type){case 30:(f=e.BaseObject.borrowObject(e.IKConstraintTimelineState)).constraint=i,f.init(this._armature,this,_),this._constraintTimelines.push(f)}else this.resetToPose&&((f=e.BaseObject.borrowObject(e.IKConstraintTimelineState)).constraint=i,f.init(this._armature,this,null),this._constraintTimelines.push(f),this._poseTimelines.push(f))}for(var o=0,s=this._armature.animation.getStates();o<s.length;o++){var c,l=s[o];if(l._parent===this&&null!==(c=this._animationData.getAnimationTimelines(l.name)))for(var u=0,h=c;u<h.length;u++){var _;switch((_=h[u]).type){case 40:var f;(f=e.BaseObject.borrowObject(e.AnimationTimelineState)).animationState=l,f.init(this._armature,this,_),this._animationTimelines.push(f)}}}},r.prototype._updateBoneAndSlotTimelines=function(){for(var t={},i=0,r=this._boneTimelines;i<r.length;i++)(c=(g=r[i]).bone.name)in t||(t[c]=[]),t[c].push(g);for(var a=0,o=this._armature.getBones();a<o.length;a++){var s=o[a],c=s.name;if(this.containsBoneMask(c))if(c in t)delete t[c];else if(0===s._boneData.type){var l=this._animationData.getBoneTimelines(c),u=c in this._bonePoses?this._bonePoses[c]:this._bonePoses[c]=e.BaseObject.borrowObject(n);if(null!==l)for(var h=0,_=l;h<_.length;h++)switch((D=_[h]).type){case 10:(g=e.BaseObject.borrowObject(e.BoneAllTimelineState)).bone=s,g.bonePose=u,g.init(this._armature,this,D),this._boneTimelines.push(g);break;case 11:(g=e.BaseObject.borrowObject(e.BoneTranslateTimelineState)).bone=s,g.bonePose=u,g.init(this._armature,this,D),this._boneTimelines.push(g);break;case 12:(g=e.BaseObject.borrowObject(e.BoneRotateTimelineState)).bone=s,g.bonePose=u,g.init(this._armature,this,D),this._boneTimelines.push(g);break;case 13:(g=e.BaseObject.borrowObject(e.BoneScaleTimelineState)).bone=s,g.bonePose=u,g.init(this._armature,this,D),this._boneTimelines.push(g)}else this.resetToPose&&((g=e.BaseObject.borrowObject(e.BoneAllTimelineState)).bone=s,g.bonePose=u,g.init(this._armature,this,null),this._boneTimelines.push(g),this._poseTimelines.push(g))}else if(1===s._boneData.type)if(null!==(l=this._animationData.getSurfaceTimelines(c)))for(var f=0,p=l;f<p.length;f++)switch((D=p[f]).type){case 50:(g=e.BaseObject.borrowObject(e.SurfaceTimelineState)).surface=s,g.init(this._armature,this,D),this._surfaceTimelines.push(g)}else this.resetToPose&&((g=e.BaseObject.borrowObject(e.SurfaceTimelineState)).surface=s,g.init(this._armature,this,null),this._surfaceTimelines.push(g),this._poseTimelines.push(g))}for(var d in t)for(var m=0,v=t[d];m<v.length;m++){var g=v[m];this._boneTimelines.splice(this._boneTimelines.indexOf(g),1),g.returnToPool()}for(var y={},x=[],S=0,T=this._slotTimelines;S<T.length;S++)(c=(g=T[S]).slot.name)in y||(y[c]=[]),y[c].push(g);for(var E=0,A=this._armature.getSlots();E<A.length;E++){var C=A[E],b=C.parent.name;if(this.containsBoneMask(b))if(c=C.name,l=this._animationData.getSlotTimelines(c),c in y)delete y[c];else{var P=!1,R=!1;if(x.length=0,null!==l)for(var I=0,w=l;I<w.length;I++){var D;switch((D=w[I]).type){case 20:(g=e.BaseObject.borrowObject(e.SlotDislayTimelineState)).slot=C,g.init(this._armature,this,D),this._slotTimelines.push(g),P=!0;break;case 21:(g=e.BaseObject.borrowObject(e.SlotColorTimelineState)).slot=C,g.init(this._armature,this,D),this._slotTimelines.push(g),R=!0;break;case 22:(g=e.BaseObject.borrowObject(e.DeformTimelineState)).slot=C,g.init(this._armature,this,D),this._slotTimelines.push(g),x.push(g.vertexOffset)}}if(this.resetToPose&&(P||((g=e.BaseObject.borrowObject(e.SlotDislayTimelineState)).slot=C,g.init(this._armature,this,null),this._slotTimelines.push(g),this._poseTimelines.push(g)),R||((g=e.BaseObject.borrowObject(e.SlotColorTimelineState)).slot=C,g.init(this._armature,this,null),this._slotTimelines.push(g),this._poseTimelines.push(g)),null!==C.rawDisplayDatas))for(var O=0,M=C.rawDisplayDatas;O<M.length;O++){var N=M[O];if(null!==N&&2===N.type){var B=N.vertices.offset;x.indexOf(B)<0&&((g=e.BaseObject.borrowObject(e.DeformTimelineState)).vertexOffset=B,g.slot=C,g.init(this._armature,this,null),this._slotTimelines.push(g),this._poseTimelines.push(g))}}}}for(var d in y)for(var F=0,L=y[d];F<L.length;F++)g=L[F],this._slotTimelines.splice(this._slotTimelines.indexOf(g),1),g.returnToPool()},r.prototype._advanceFadeTime=function(t){var n,i=this._fadeState>0;if(this._subFadeState<0){this._subFadeState=0;var r=i?e.EventObject.FADE_OUT:e.EventObject.FADE_IN;this._armature.eventDispatcher.hasDBEventListener(r)&&((n=e.BaseObject.borrowObject(e.EventObject)).type=r,n.armature=this._armature,n.animationState=this,this._armature._dragonBones.bufferEvent(n))}(t<0&&(t=-t),this._fadeTime+=t,this._fadeTime>=this.fadeTotalTime?(this._subFadeState=1,this._fadeProgress=i?0:1):this._fadeTime>0?this._fadeProgress=i?1-this._fadeTime/this.fadeTotalTime:this._fadeTime/this.fadeTotalTime:this._fadeProgress=i?1:0,this._subFadeState>0)&&(i||(this._playheadState|=1,this._fadeState=0),r=i?e.EventObject.FADE_OUT_COMPLETE:e.EventObject.FADE_IN_COMPLETE,this._armature.eventDispatcher.hasDBEventListener(r)&&((n=e.BaseObject.borrowObject(e.EventObject)).type=r,n.armature=this._armature,n.animationState=this,this._armature._dragonBones.bufferEvent(n)))},r.prototype.init=function(t,n,i){if(null===this._armature){if(this._armature=t,this._animationData=n,this.resetToPose=i.resetToPose,this.additiveBlending=i.additiveBlending,this.displayControl=i.displayControl,this.actionEnabled=i.actionEnabled,this.layer=i.layer,this.playTimes=i.playTimes,this.timeScale=i.timeScale,this.fadeTotalTime=i.fadeInTime,this.autoFadeOutTime=i.autoFadeOutTime,this.weight=i.weight,this.name=i.name.length>0?i.name:i.animation,this.group=i.group,i.pauseFadeIn?this._playheadState=2:this._playheadState=3,i.duration<0?(this._position=0,this._duration=this._animationData.duration,0!==i.position?this.timeScale>=0?this._time=i.position:this._time=i.position-this._duration:this._time=0):(this._position=i.position,this._duration=i.duration,this._time=0),this.timeScale<0&&0===this._time&&(this._time=-1e-6),this.fadeTotalTime<=0&&(this._fadeProgress=.999999),i.boneMask.length>0){this._boneMask.length=i.boneMask.length;for(var r=0,a=this._boneMask.length;r<a;++r)this._boneMask[r]=i.boneMask[r]}this._actionTimeline=e.BaseObject.borrowObject(e.ActionTimelineState),this._actionTimeline.init(this._armature,this,this._animationData.actionTimeline),this._actionTimeline.currentTime=this._time,this._actionTimeline.currentTime<0&&(this._actionTimeline.currentTime=this._duration-this._actionTimeline.currentTime),null!==this._animationData.zOrderTimeline&&(this._zOrderTimeline=e.BaseObject.borrowObject(e.ZOrderTimelineState),this._zOrderTimeline.init(this._armature,this,this._animationData.zOrderTimeline))}},r.prototype.advanceTime=function(t,n){if(this._blendState.dirty=!1,0===this._fadeState&&0===this._subFadeState||this._advanceFadeTime(t),3===this._playheadState&&(1!==this.timeScale&&(t*=this.timeScale),this._time+=t),0!==this._timelineDirty&&(2===this._timelineDirty&&this._updateTimelines(),this._timelineDirty=0,this._updateBoneAndSlotTimelines()),0!==this.weight){var i=0===this._fadeState&&n>0,r=!0,a=!0,o=this._time;if(this._weightResult=this.weight*this._fadeProgress,null!==this._parent&&(this._weightResult*=this._parent._weightResult/this._parent._fadeProgress),this._actionTimeline.playState<=0&&this._actionTimeline.update(o),i){var s=2*n;this._actionTimeline.currentTime=Math.floor(this._actionTimeline.currentTime*s)/s}if(null!==this._zOrderTimeline&&this._zOrderTimeline.playState<=0&&this._zOrderTimeline.update(o),i){var c=Math.floor(this._actionTimeline.currentTime*n);this._armature._cacheFrameIndex===c?(r=!1,a=!1):(this._armature._cacheFrameIndex=c,this._animationData.cachedFrames[c]?a=!1:this._animationData.cachedFrames[c]=!0)}if(r){if(a)for(var l=0,u=this._boneTimelines.length;l<u;++l)(d=this._boneTimelines[l]).playState<=0&&d.update(o),(l===u-1||d.bone!==this._boneTimelines[l+1].bone)&&0!==(h=d.bone._blendState.update(this._weightResult,this.layer))&&d.blend(h);for(l=0,u=this._surfaceTimelines.length;l<u;++l){var h=(d=this._surfaceTimelines[l]).surface._blendState.update(this._weightResult,this.layer);d.playState<=0&&d.update(o),0!==h&&d.blend(h)}if(this.displayControl)for(l=0,u=this._slotTimelines.length;l<u;++l){var _=(d=this._slotTimelines[l]).slot.displayController;null!==_&&_!==this.name&&_!==this.group||d.playState<=0&&d.update(o)}for(l=0,u=this._constraintTimelines.length;l<u;++l)(d=this._constraintTimelines[l]).playState<=0&&d.update(o);for(l=0,u=this._animationTimelines.length;l<u;++l)h=(d=this._animationTimelines[l]).animationState._blendState.update(this._weightResult,this.layer),d.playState<=0&&d.update(o),0!==h&&d.blend(h)}if(0===this._fadeState){if(this._subFadeState>0&&(this._subFadeState=0,this._poseTimelines.length>0)){for(var f=0,p=this._poseTimelines;f<p.length;f++){var d;(d=p[f])instanceof e.BoneTimelineState?this._boneTimelines.splice(this._boneTimelines.indexOf(d),1):d instanceof e.SurfaceTimelineState?this._surfaceTimelines.splice(this._surfaceTimelines.indexOf(d),1):d instanceof e.SlotTimelineState?this._slotTimelines.splice(this._slotTimelines.indexOf(d),1):d instanceof e.ConstraintTimelineState&&this._constraintTimelines.splice(this._constraintTimelines.indexOf(d),1),d.returnToPool()}this._poseTimelines.length=0}this._actionTimeline.playState>0&&this.autoFadeOutTime>=0&&this.fadeOut(this.autoFadeOutTime)}}},r.prototype.play=function(){this._playheadState=3},r.prototype.stop=function(){this._playheadState&=1},r.prototype.fadeOut=function(e,t){if(void 0===t&&(t=!0),e<0&&(e=0),t&&(this._playheadState&=2),this._fadeState>0){if(e>this.fadeTotalTime-this._fadeTime)return}else{this._fadeState=1,this._subFadeState=-1,(e<=0||this._fadeProgress<=0)&&(this._fadeProgress=1e-6);for(var n=0,i=this._boneTimelines;n<i.length;n++)(_=i[n]).fadeOut();for(var r=0,a=this._surfaceTimelines;r<a.length;r++)(_=a[r]).fadeOut();for(var o=0,s=this._slotTimelines;o<s.length;o++)(_=s[o]).fadeOut();for(var c=0,l=this._constraintTimelines;c<l.length;c++)(_=l[c]).fadeOut();for(var u=0,h=this._animationTimelines;u<h.length;u++){var _;(_=h[u]).animationState.fadeOut(e,t),_.fadeOut()}}this.displayControl=!1,this.fadeTotalTime=this._fadeProgress>1e-6?e/this._fadeProgress:0,this._fadeTime=this.fadeTotalTime*(1-this._fadeProgress)},r.prototype.containsBoneMask=function(e){return 0===this._boneMask.length||this._boneMask.indexOf(e)>=0},r.prototype.addBoneMask=function(e,t){void 0===t&&(t=!0);var n=this._armature.getBone(e);if(null!==n){if(this._boneMask.indexOf(e)<0&&this._boneMask.push(e),t)for(var i=0,r=this._armature.getBones();i<r.length;i++){var a=r[i];this._boneMask.indexOf(a.name)<0&&n.contains(a)&&this._boneMask.push(a.name)}this._timelineDirty=1}},r.prototype.removeBoneMask=function(e,t){void 0===t&&(t=!0);var n=this._boneMask.indexOf(e);if(n>=0&&this._boneMask.splice(n,1),t){var i=this._armature.getBone(e);if(null!==i){var r=this._armature.getBones();if(this._boneMask.length>0)for(var a=0,o=r;a<o.length;a++){var s=o[a],c=this._boneMask.indexOf(s.name);c>=0&&i.contains(s)&&this._boneMask.splice(c,1)}else for(var l=0,u=r;l<u.length;l++)(s=u[l])!==i&&(i.contains(s)||this._boneMask.push(s.name))}}this._timelineDirty=1},r.prototype.removeAllBoneMask=function(){this._boneMask.length=0,this._timelineDirty=1},Object.defineProperty(r.prototype,"isFadeIn",{get:function(){return this._fadeState<0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isFadeOut",{get:function(){return this._fadeState>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isFadeComplete",{get:function(){return 0===this._fadeState},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPlaying",{get:function(){return 0!=(2&this._playheadState)&&this._actionTimeline.playState<=0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isCompleted",{get:function(){return this._actionTimeline.playState>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentPlayTimes",{get:function(){return this._actionTimeline.currentPlayTimes},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"totalTime",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentTime",{get:function(){return this._actionTimeline.currentTime},set:function(e){var t=this._actionTimeline.currentPlayTimes-(this._actionTimeline.playState>0?1:0);if((e<0||this._duration<e)&&(e=e%this._duration+t*this._duration)<0&&(e+=this._duration),this.playTimes>0&&t===this.playTimes-1&&e===this._duration&&(e=this._duration-1e-6),this._time!==e){this._time=e,this._actionTimeline.setCurrentTime(this._time),null!==this._zOrderTimeline&&(this._zOrderTimeline.playState=-1);for(var n=0,i=this._boneTimelines;n<i.length;n++)i[n].playState=-1;for(var r=0,a=this._slotTimelines;r<a.length;r++)a[r].playState=-1}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"animationData",{get:function(){return this._animationData},enumerable:!0,configurable:!0}),r}(e.BaseObject);e.AnimationState=t;var n=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.current=new e.Transform,n.delta=new e.Transform,n.result=new e.Transform,n}return qk(n,t),n.toString=function(){return"[class dragonBones.BonePose]"},n.prototype._onClear=function(){this.current.identity(),this.delta.identity(),this.result.identity()},n}(e.BaseObject);e.BonePose=n;var i=function(){function e(){}return e.prototype.update=function(e,t){if(this.dirty){if(!(this.leftWeight>0))return 0;if(this.layer!==t){if(this.layerWeight>=this.leftWeight)return this.leftWeight=0,0;this.layer=t,this.leftWeight-=this.layerWeight,this.layerWeight=0}return e*=this.leftWeight,this.layerWeight+=e,this.blendWeight=e,2}return this.dirty=!0,this.layer=t,this.layerWeight=e,this.leftWeight=1,this.blendWeight=e,1},e.prototype.clear=function(){this.dirty=!1,this.layer=0,this.leftWeight=0,this.layerWeight=0,this.blendWeight=0},e}();e.BlendState=i}(Xk||(Xk={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){this.playState=-1,this.currentPlayTimes=-1,this.currentTime=-1,this._tweenState=0,this._frameRate=0,this._frameValueOffset=0,this._frameCount=0,this._frameOffset=0,this._frameIndex=-1,this._frameRateR=0,this._position=0,this._duration=0,this._timeScale=1,this._timeOffset=0,this._dragonBonesData=null,this._animationData=null,this._timelineData=null,this._armature=null,this._animationState=null,this._actionTimeline=null,this._frameArray=null,this._frameIntArray=null,this._frameFloatArray=null,this._timelineArray=null,this._frameIndices=null},t.prototype._setCurrentTime=function(e){var t=this.playState,n=this.currentPlayTimes,i=this.currentTime;if(null!==this._actionTimeline&&this._frameCount<=1)this.playState=this._actionTimeline.playState>=0?1:-1,this.currentPlayTimes=1,this.currentTime=this._actionTimeline.currentTime;else if(null===this._actionTimeline||1!==this._timeScale||0!==this._timeOffset){var r=this._animationState.playTimes,a=r*this._duration;e*=this._timeScale,0!==this._timeOffset&&(e+=this._timeOffset*this._animationData.duration),r>0&&(e>=a||e<=-a)?(this.playState<=0&&3===this._animationState._playheadState&&(this.playState=1),this.currentPlayTimes=r,this.currentTime=e<0?0:this._duration+1e-6):(0!==this.playState&&3===this._animationState._playheadState&&(this.playState=0),e<0?(e=-e,this.currentPlayTimes=Math.floor(e/this._duration),this.currentTime=this._duration-e%this._duration):(this.currentPlayTimes=Math.floor(e/this._duration),this.currentTime=e%this._duration)),this.currentTime+=this._position}else this.playState=this._actionTimeline.playState,this.currentPlayTimes=this._actionTimeline.currentPlayTimes,this.currentTime=this._actionTimeline.currentTime;return(this.currentPlayTimes!==n||this.currentTime!==i)&&((t<0&&this.playState!==t||this.playState<=0&&this.currentPlayTimes!==n)&&(this._frameIndex=-1),!0)},t.prototype.init=function(e,t,n){this._armature=e,this._animationState=t,this._timelineData=n,this._actionTimeline=this._animationState._actionTimeline,this===this._actionTimeline&&(this._actionTimeline=null),this._animationData=this._animationState._animationData,this._frameRate=this._animationData.parent.frameRate,this._frameRateR=1/this._frameRate,this._position=this._animationState._position,this._duration=this._animationState._duration,this._dragonBonesData=this._animationData.parent.parent,null!==this._timelineData&&(this._frameIntArray=this._dragonBonesData.frameIntArray,this._frameFloatArray=this._dragonBonesData.frameFloatArray,this._frameArray=this._dragonBonesData.frameArray,this._timelineArray=this._dragonBonesData.timelineArray,this._frameIndices=this._dragonBonesData.frameIndices,this._frameCount=this._timelineArray[this._timelineData.offset+2],this._frameValueOffset=this._timelineArray[this._timelineData.offset+4],this._timeScale=100/this._timelineArray[this._timelineData.offset+0],this._timeOffset=.01*this._timelineArray[this._timelineData.offset+1])},t.prototype.fadeOut=function(){},t.prototype.update=function(e){if(this._setCurrentTime(e)){if(this._frameCount>1){var t=Math.floor(this.currentTime*this._frameRate),n=this._frameIndices[this._timelineData.frameIndicesOffset+t];this._frameIndex!==n&&(this._frameIndex=n,this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex],this._onArriveAtFrame())}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5]),this._onArriveAtFrame());0!==this._tweenState&&this._onUpdateFrame()}},t}(e.BaseObject);e.TimelineState=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t._getEasingValue=function(e,t,n){var i=t;switch(e){case 3:i=Math.pow(t,2);break;case 4:i=1-Math.pow(1-t,2);break;case 5:i=.5*(1-Math.cos(t*Math.PI))}return(i-t)*n+t},t._getEasingCurveValue=function(e,t,n,i){if(e<=0)return 0;if(e>=1)return 1;var r=n+1,a=Math.floor(e*r),o=0===a?0:t[i+a-1];return 1e-4*(o+((a===r-1?1e4:t[i+a])-o)*(e*r-a))},t.prototype._onClear=function(){e.prototype._onClear.call(this),this._tweenType=0,this._curveCount=0,this._framePosition=0,this._frameDurationR=0,this._tweenProgress=0,this._tweenEasing=0},t.prototype._onArriveAtFrame=function(){if(this._frameCount>1&&(this._frameIndex!==this._frameCount-1||0===this._animationState.playTimes||this._animationState.currentPlayTimes<this._animationState.playTimes-1))if(this._tweenType=this._frameArray[this._frameOffset+1],this._tweenState=0===this._tweenType?1:2,2===this._tweenType?this._curveCount=this._frameArray[this._frameOffset+2]:0!==this._tweenType&&1!==this._tweenType&&(this._tweenEasing=.01*this._frameArray[this._frameOffset+2]),this._framePosition=this._frameArray[this._frameOffset]*this._frameRateR,this._frameIndex===this._frameCount-1)this._frameDurationR=1/(this._animationData.duration-this._framePosition);else{var e=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex+1],t=this._frameArray[e]*this._frameRateR-this._framePosition;this._frameDurationR=t>0?1/t:0}else this._tweenState=1},t.prototype._onUpdateFrame=function(){2===this._tweenState?(this._tweenProgress=(this.currentTime-this._framePosition)*this._frameDurationR,2===this._tweenType?this._tweenProgress=t._getEasingCurveValue(this._tweenProgress,this._frameArray,this._curveCount,this._frameOffset+3):1!==this._tweenType&&(this._tweenProgress=t._getEasingValue(this._tweenType,this._tweenProgress,this._tweenEasing))):this._tweenProgress=0},t}(t);e.TweenTimelineState=n;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){e.prototype._onClear.call(this),this.bone=null,this.bonePose=null},t.prototype.blend=function(e){var t=this.bone._blendState.blendWeight,n=this.bone.animationPose,i=this.bonePose.result;2===e?(n.x+=i.x*t,n.y+=i.y*t,n.rotation+=i.rotation*t,n.skew+=i.skew*t,n.scaleX+=(i.scaleX-1)*t,n.scaleY+=(i.scaleY-1)*t):1!==t?(n.x=i.x*t,n.y=i.y*t,n.rotation=i.rotation*t,n.skew=i.skew*t,n.scaleX=(i.scaleX-1)*t+1,n.scaleY=(i.scaleY-1)*t+1):(n.x=i.x,n.y=i.y,n.rotation=i.rotation,n.skew=i.skew,n.scaleX=i.scaleX,n.scaleY=i.scaleY),0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.bone._transformDirty=!0)},t}(n);e.BoneTimelineState=i;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){e.prototype._onClear.call(this),this.slot=null},t}(n);e.SlotTimelineState=r;var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.prototype._onClear=function(){e.prototype._onClear.call(this),this.constraint=null},t}(n);e.ConstraintTimelineState=a}(Xk||(Xk={})),function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.toString=function(){return"[class dragonBones.ActionTimelineState]"},n.prototype._onCrossFrame=function(t){var n=this._armature.eventDispatcher;if(this._animationState.actionEnabled)for(var i=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+t],r=this._frameArray[i+1],a=this._animationData.parent.actions,o=0;o<r;++o){var s=a[this._frameArray[i+2+o]];if(0===s.type)(c=e.BaseObject.borrowObject(e.EventObject)).time=this._frameArray[i]/this._frameRate,c.animationState=this._animationState,e.EventObject.actionDataToInstance(s,c,this._armature),this._armature._bufferAction(c,!0);else{var c,l=10===s.type?e.EventObject.FRAME_EVENT:e.EventObject.SOUND_EVENT;(11===s.type||n.hasDBEventListener(l))&&((c=e.BaseObject.borrowObject(e.EventObject)).time=this._frameArray[i]/this._frameRate,c.animationState=this._animationState,e.EventObject.actionDataToInstance(s,c,this._armature),this._armature._dragonBones.bufferEvent(c))}}},n.prototype._onArriveAtFrame=function(){},n.prototype._onUpdateFrame=function(){},n.prototype.update=function(t){var n=this.playState,i=this.currentPlayTimes,r=this.currentTime;if(this._setCurrentTime(t)){var a=this._armature.eventDispatcher;if(n<0){if(this.playState===n)return;if(this._animationState.displayControl&&this._animationState.resetToPose&&this._armature._sortZOrder(null,0),i=this.currentPlayTimes,a.hasDBEventListener(e.EventObject.START)){var o=e.BaseObject.borrowObject(e.EventObject);o.type=e.EventObject.START,o.armature=this._armature,o.animationState=this._animationState,this._armature._dragonBones.bufferEvent(o)}}var s=this._animationState.timeScale<0,c=null,l=null;if(this.currentPlayTimes!==i&&(a.hasDBEventListener(e.EventObject.LOOP_COMPLETE)&&((c=e.BaseObject.borrowObject(e.EventObject)).type=e.EventObject.LOOP_COMPLETE,c.armature=this._armature,c.animationState=this._animationState),this.playState>0&&a.hasDBEventListener(e.EventObject.COMPLETE)&&((l=e.BaseObject.borrowObject(e.EventObject)).type=e.EventObject.COMPLETE,l.armature=this._armature,l.animationState=this._animationState)),this._frameCount>1){var u=this._timelineData,h=Math.floor(this.currentTime*this._frameRate),_=this._frameIndices[u.frameIndicesOffset+h];if(this._frameIndex!==_){var f=this._frameIndex;if(this._frameIndex=_,null!==this._timelineArray)if(this._frameOffset=this._animationData.frameOffset+this._timelineArray[u.offset+5+this._frameIndex],s){if(f<0){var p=Math.floor(r*this._frameRate);f=this._frameIndices[u.frameIndicesOffset+p],this.currentPlayTimes===i&&f===_&&(f=-1)}for(;f>=0;){var d=this._animationData.frameOffset+this._timelineArray[u.offset+5+f],m=this._frameArray[d]/this._frameRate;if(this._position<=m&&m<=this._position+this._duration&&this._onCrossFrame(f),null!==c&&0===f&&(this._armature._dragonBones.bufferEvent(c),c=null),f>0?f--:f=this._frameCount-1,f===_)break}}else for(f<0&&(p=Math.floor(r*this._frameRate),f=this._frameIndices[u.frameIndicesOffset+p],d=this._animationData.frameOffset+this._timelineArray[u.offset+5+f],m=this._frameArray[d]/this._frameRate,this.currentPlayTimes===i&&(r<=m?f>0?f--:f=this._frameCount-1:f===_&&(f=-1)));f>=0&&(f<this._frameCount-1?f++:f=0,d=this._animationData.frameOffset+this._timelineArray[u.offset+5+f],m=this._frameArray[d]/this._frameRate,this._position<=m&&m<=this._position+this._duration&&this._onCrossFrame(f),null!==c&&0===f&&(this._armature._dragonBones.bufferEvent(c),c=null),f!==_););}}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData)&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5],m=this._frameArray[this._frameOffset]/this._frameRate,this.currentPlayTimes===i?r<=m&&this._onCrossFrame(this._frameIndex):this._position<=m&&(s||null===c||(this._armature._dragonBones.bufferEvent(c),c=null),this._onCrossFrame(this._frameIndex)));null!==c&&this._armature._dragonBones.bufferEvent(c),null!==l&&this._armature._dragonBones.bufferEvent(l)}},n.prototype.setCurrentTime=function(e){this._setCurrentTime(e),this._frameIndex=-1},n}(e.TimelineState);e.ActionTimelineState=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.ZOrderTimelineState]"},t.prototype._onArriveAtFrame=function(){this.playState>=0&&(this._frameArray[this._frameOffset+1]>0?this._armature._sortZOrder(this._frameArray,this._frameOffset+2):this._armature._sortZOrder(null,0))},t.prototype._onUpdateFrame=function(){},t}(e.TimelineState);e.ZOrderTimelineState=n;var i=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.toString=function(){return"[class dragonBones.BoneAllTimelineState]"},n.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+6*this._frameIndex,n=this._armature._armatureData.scale,i=this._frameFloatArray,r=this.bonePose.current,a=this.bonePose.delta;r.x=i[e++]*n,r.y=i[e++]*n,r.rotation=i[e++],r.skew=i[e++],r.scaleX=i[e++],r.scaleY=i[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),a.x=i[e++]*n-r.x,a.y=i[e++]*n-r.y,a.rotation=i[e++]-r.rotation,a.skew=i[e++]-r.skew,a.scaleX=i[e++]-r.scaleX,a.scaleY=i[e++]-r.scaleY):(a.x=0,a.y=0,a.rotation=0,a.skew=0,a.scaleX=0,a.scaleY=0)}else r=this.bonePose.current,a=this.bonePose.delta,r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=1,r.scaleY=1,a.x=0,a.y=0,a.rotation=0,a.skew=0,a.scaleX=0,a.scaleY=0},n.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.x=e.x+n.x*this._tweenProgress,i.y=e.y+n.y*this._tweenProgress,i.rotation=e.rotation+n.rotation*this._tweenProgress,i.skew=e.skew+n.skew*this._tweenProgress,i.scaleX=e.scaleX+n.scaleX*this._tweenProgress,i.scaleY=e.scaleY+n.scaleY*this._tweenProgress},n.prototype.fadeOut=function(){var t=this.bonePose.result;t.rotation=e.Transform.normalizeRadian(t.rotation),t.skew=e.Transform.normalizeRadian(t.skew)},n}(e.BoneTimelineState);e.BoneAllTimelineState=i;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.BoneTranslateTimelineState]"},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._armature._armatureData.scale,i=this._frameFloatArray,r=this.bonePose.current,a=this.bonePose.delta;r.x=i[t++]*n,r.y=i[t++]*n,2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),a.x=i[t++]*n-r.x,a.y=i[t++]*n-r.y):(a.x=0,a.y=0)}else r=this.bonePose.current,a=this.bonePose.delta,r.x=0,r.y=0,a.x=0,a.y=0},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.x=t.x+n.x*this._tweenProgress,i.y=t.y+n.y*this._tweenProgress},t}(e.BoneTimelineState);e.BoneTranslateTimelineState=r;var a=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.toString=function(){return"[class dragonBones.BoneRotateTimelineState]"},n.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var n=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameFloatArray,r=this.bonePose.current,a=this.bonePose.delta;r.rotation=i[n++],r.skew=i[n++],2===this._tweenState?(this._frameIndex===this._frameCount-1?(n=this._animationData.frameFloatOffset+this._frameValueOffset,a.rotation=e.Transform.normalizeRadian(i[n++]-r.rotation)):a.rotation=i[n++]-r.rotation,a.skew=i[n++]-r.skew):(a.rotation=0,a.skew=0)}else r=this.bonePose.current,a=this.bonePose.delta,r.rotation=0,r.skew=0,a.rotation=0,a.skew=0},n.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.rotation=e.rotation+n.rotation*this._tweenProgress,i.skew=e.skew+n.skew*this._tweenProgress},n.prototype.fadeOut=function(){var t=this.bonePose.result;t.rotation=e.Transform.normalizeRadian(t.rotation),t.skew=e.Transform.normalizeRadian(t.skew)},n}(e.BoneTimelineState);e.BoneRotateTimelineState=a;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.BoneScaleTimelineState]"},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameFloatArray,i=this.bonePose.current,r=this.bonePose.delta;i.scaleX=n[t++],i.scaleY=n[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),r.scaleX=n[t++]-i.scaleX,r.scaleY=n[t++]-i.scaleY):(r.scaleX=0,r.scaleY=0)}else i=this.bonePose.current,r=this.bonePose.delta,i.scaleX=1,i.scaleY=1,r.scaleX=0,r.scaleY=0},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.scaleX=t.scaleX+n.scaleX*this._tweenProgress,i.scaleY=t.scaleY+n.scaleY*this._tweenProgress},t}(e.BoneTimelineState);e.BoneScaleTimelineState=o;var s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._current=[],t._delta=[],t._result=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.SurfaceTimelineState]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.surface=null,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,n=this._armature._armatureData.scale,i=this._frameFloatArray;if(2===this._tweenState){var r=t+this._valueCount;this._frameIndex===this._frameCount-1&&(r=this._animationData.frameFloatOffset+this._frameValueOffset);for(var a=0;a<this._valueCount;++a)this._delta[a]=i[r+a]*n-(this._current[a]=i[t+a]*n)}else for(a=0;a<this._valueCount;++a)this._current[a]=i[t+a]*n}else for(a=0;a<this._valueCount;++a)this._current[a]=0},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this),this.surface._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var t=0;t<this._valueCount;++t)this._result[t]=this._current[t]+this._delta[t]*this._tweenProgress},t.prototype.init=function(t,n,i){if(e.prototype.init.call(this,t,n,i),null!==this._timelineData){var r=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this._deformCount=this._frameIntArray[r+1],this._valueCount=this._frameIntArray[r+2],this._valueOffset=this._frameIntArray[r+3],this._frameFloatOffset=this._frameIntArray[r+4]+this._animationData.frameFloatOffset}else this._deformCount=this.surface._deformVertices.length,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0;this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var a=0;a<this._valueCount;++a)this._delta[a]=0},t.prototype.blend=function(e){for(var t=this.surface._blendState.blendWeight,n=this.surface._deformVertices,i=0;i<this._deformCount;++i){var r;r=i<this._valueOffset?this._frameFloatArray[this._frameFloatOffset+i]:i<this._valueOffset+this._valueCount?this._result[i-this._valueOffset]:this._frameFloatArray[this._frameFloatOffset+i-this._valueCount],2===e?n[i]+=r*t:n[i]=1!==t?r*t:r}0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.surface._transformDirty=!0)},t}(e.TweenTimelineState);e.SurfaceTimelineState=s;var c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.SlotDislayTimelineState]"},t.prototype._onArriveAtFrame=function(){if(this.playState>=0){var e=null!==this._timelineData?this._frameArray[this._frameOffset+1]:this.slot._slotData.displayIndex;this.slot.displayIndex!==e&&this.slot._setDisplayIndex(e,!0)}},t}(e.SlotTimelineState);e.SlotDislayTimelineState=c;var l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._current=[0,0,0,0,0,0,0,0],t._delta=[0,0,0,0,0,0,0,0],t._result=[0,0,0,0,0,0,0,0],t}return qk(t,e),t.toString=function(){return"[class dragonBones.SlotColorTimelineState]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this._dirty=!1},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._dragonBonesData.intArray,n=this._frameIntArray,i=this._animationData.frameIntOffset+this._frameValueOffset+1*this._frameIndex,r=n[i];r<0&&(r+=65536),this._current[0]=t[r++],this._current[1]=t[r++],this._current[2]=t[r++],this._current[3]=t[r++],this._current[4]=t[r++],this._current[5]=t[r++],this._current[6]=t[r++],this._current[7]=t[r++],2===this._tweenState&&((r=this._frameIndex===this._frameCount-1?n[this._animationData.frameIntOffset+this._frameValueOffset]:n[i+1])<0&&(r+=65536),this._delta[0]=t[r++]-this._current[0],this._delta[1]=t[r++]-this._current[1],this._delta[2]=t[r++]-this._current[2],this._delta[3]=t[r++]-this._current[3],this._delta[4]=t[r++]-this._current[4],this._delta[5]=t[r++]-this._current[5],this._delta[6]=t[r++]-this._current[6],this._delta[7]=t[r++]-this._current[7])}else{var a=this.slot._slotData.color;this._current[0]=100*a.alphaMultiplier,this._current[1]=100*a.redMultiplier,this._current[2]=100*a.greenMultiplier,this._current[3]=100*a.blueMultiplier,this._current[4]=a.alphaOffset,this._current[5]=a.redOffset,this._current[6]=a.greenOffset,this._current[7]=a.blueOffset}},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0),this._result[0]=.01*(this._current[0]+this._delta[0]*this._tweenProgress),this._result[1]=.01*(this._current[1]+this._delta[1]*this._tweenProgress),this._result[2]=.01*(this._current[2]+this._delta[2]*this._tweenProgress),this._result[3]=.01*(this._current[3]+this._delta[3]*this._tweenProgress),this._result[4]=this._current[4]+this._delta[4]*this._tweenProgress,this._result[5]=this._current[5]+this._delta[5]*this._tweenProgress,this._result[6]=this._current[6]+this._delta[6]*this._tweenProgress,this._result[7]=this._current[7]+this._delta[7]*this._tweenProgress},t.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},t.prototype.update=function(t){if(e.prototype.update.call(this,t),0!==this._tweenState||this._dirty){var n=this.slot._colorTransform;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){if(n.alphaMultiplier!==this._result[0]||n.redMultiplier!==this._result[1]||n.greenMultiplier!==this._result[2]||n.blueMultiplier!==this._result[3]||n.alphaOffset!==this._result[4]||n.redOffset!==this._result[5]||n.greenOffset!==this._result[6]||n.blueOffset!==this._result[7]){var i=Math.pow(this._animationState._fadeProgress,4);n.alphaMultiplier+=(this._result[0]-n.alphaMultiplier)*i,n.redMultiplier+=(this._result[1]-n.redMultiplier)*i,n.greenMultiplier+=(this._result[2]-n.greenMultiplier)*i,n.blueMultiplier+=(this._result[3]-n.blueMultiplier)*i,n.alphaOffset+=(this._result[4]-n.alphaOffset)*i,n.redOffset+=(this._result[5]-n.redOffset)*i,n.greenOffset+=(this._result[6]-n.greenOffset)*i,n.blueOffset+=(this._result[7]-n.blueOffset)*i,this.slot._colorDirty=!0}}else this._dirty&&(this._dirty=!1,n.alphaMultiplier===this._result[0]&&n.redMultiplier===this._result[1]&&n.greenMultiplier===this._result[2]&&n.blueMultiplier===this._result[3]&&n.alphaOffset===this._result[4]&&n.redOffset===this._result[5]&&n.greenOffset===this._result[6]&&n.blueOffset===this._result[7]||(n.alphaMultiplier=this._result[0],n.redMultiplier=this._result[1],n.greenMultiplier=this._result[2],n.blueMultiplier=this._result[3],n.alphaOffset=this._result[4],n.redOffset=this._result[5],n.greenOffset=this._result[6],n.blueOffset=this._result[7],this.slot._colorDirty=!0))}},t}(e.SlotTimelineState);e.SlotColorTimelineState=l;var u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._current=[],t._delta=[],t._result=[],t}return qk(t,e),t.toString=function(){return"[class dragonBones.DeformTimelineState]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.vertexOffset=0,this._dirty=!1,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,n=this._armature._armatureData.scale,i=this._frameFloatArray;if(2===this._tweenState){var r=t+this._valueCount;this._frameIndex===this._frameCount-1&&(r=this._animationData.frameFloatOffset+this._frameValueOffset);for(var a=0;a<this._valueCount;++a)this._delta[a]=i[r+a]*n-(this._current[a]=i[t+a]*n)}else for(a=0;a<this._valueCount;++a)this._current[a]=i[t+a]*n}else for(a=0;a<this._valueCount;++a)this._current[a]=0},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var t=0;t<this._valueCount;++t)this._result[t]=this._current[t]+this._delta[t]*this._tweenProgress},t.prototype.init=function(t,n,i){if(e.prototype.init.call(this,t,n,i),null!==this._timelineData){var r=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this.vertexOffset=this._frameIntArray[r+0],this.vertexOffset<0&&(this.vertexOffset+=65536),this._deformCount=this._frameIntArray[r+1],this._valueCount=this._frameIntArray[r+2],this._valueOffset=this._frameIntArray[r+3],this._frameFloatOffset=this._frameIntArray[r+4]+this._animationData.frameFloatOffset}else{var a=this.slot._deformVertices;this._deformCount=null!==a?a.vertices.length:0,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0}this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var o=0;o<this._valueCount;++o)this._delta[o]=0},t.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},t.prototype.update=function(t){var n=this.slot._deformVertices;if(null!==n&&null!==n.verticesData&&n.verticesData.offset===this.vertexOffset&&(e.prototype.update.call(this,t),0!==this._tweenState||this._dirty)){var i=n.vertices;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){for(var r=Math.pow(this._animationState._fadeProgress,2),a=0;a<this._deformCount;++a)a<this._valueOffset?i[a]+=(this._frameFloatArray[this._frameFloatOffset+a]-i[a])*r:a<this._valueOffset+this._valueCount?i[a]+=(this._result[a-this._valueOffset]-i[a])*r:i[a]+=(this._frameFloatArray[this._frameFloatOffset+a-this._valueCount]-i[a])*r;n.verticesDirty=!0}else if(this._dirty){for(this._dirty=!1,a=0;a<this._deformCount;++a)a<this._valueOffset?i[a]=this._frameFloatArray[this._frameFloatOffset+a]:a<this._valueOffset+this._valueCount?i[a]=this._result[a-this._valueOffset]:i[a]=this._frameFloatArray[this._frameFloatOffset+a-this._valueCount];n.verticesDirty=!0}}},t}(e.SlotTimelineState);e.DeformTimelineState=u;var h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.toString=function(){return"[class dragonBones.IKConstraintTimelineState]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this._current=0,this._delta=0},t.prototype._onArriveAtFrame=function(){e.prototype._onArriveAtFrame.call(this);var t=this.constraint;if(null!==this._timelineData){var n=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameIntArray,r=0!==i[n++];this._current=.01*i[n++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(n=this._animationData.frameIntOffset+this._frameValueOffset),this._delta=.01*i[n+1]-this._current):this._delta=0,t._bendPositive=r}else{var a=t._constraintData;this._current=a.weight,this._delta=0,t._bendPositive=a.bendPositive}t.invalidUpdate()},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0);var t=this.constraint;t._weight=this._current+this._delta*this._tweenProgress,t.invalidUpdate()},t}(e.ConstraintTimelineState);e.IKConstraintTimelineState=h;var _=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._floats=[0,0,0,0,0,0],t}return qk(t,e),t.toString=function(){return"[class dragonBones.AnimationTimelineState]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.animationState=null},t.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,n=1/this.animationState._animationData.parent.frameRate,i=this._frameIntArray;this._floats[0]=i[t++]*n,this._floats[3]=.01*i[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameIntOffset+this._frameValueOffset),this._floats[1]=i[t++]*n-this._floats[0],this._floats[4]=.01*i[t++]-this._floats[3]):(this._floats[1]=0,this._floats[4]=0)}},t.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0),this._floats[0]>=0&&(this._floats[2]=this._floats[0]+this._floats[1]*this._tweenProgress),this._floats[5]=this._floats[3]+this._floats[4]*this._tweenProgress},t.prototype.blend=function(e){var t=this.animationState,n=t._blendState.blendWeight;2===e?(t.weight+=this._floats[5]*n,t.currentTime+=this._floats[2]*n):(t.weight=this._floats[5]*n,t.currentTime=this._floats[2]*n)},t}(e.TweenTimelineState);e.AnimationTimelineState=_}(Xk||(Xk={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return qk(t,e),t.actionDataToInstance=function(e,n,i){0===e.type?n.type=t.FRAME_EVENT:n.type=10===e.type?t.FRAME_EVENT:t.SOUND_EVENT,n.name=e.name,n.armature=i,n.actionData=e,n.data=e.data,null!==e.bone&&(n.bone=i.getBone(e.bone.name)),null!==e.slot&&(n.slot=i.getSlot(e.slot.name))},t.toString=function(){return"[class dragonBones.EventObject]"},t.prototype._onClear=function(){this.time=0,this.type="",this.name="",this.armature=null,this.bone=null,this.slot=null,this.animationState=null,this.actionData=null,this.data=null},t.START="start",t.LOOP_COMPLETE="loopComplete",t.COMPLETE="complete",t.FADE_IN="fadeIn",t.FADE_IN_COMPLETE="fadeInComplete",t.FADE_OUT="fadeOut",t.FADE_OUT_COMPLETE="fadeOutComplete",t.FRAME_EVENT="frameEvent",t.SOUND_EVENT="soundEvent",t}(e.BaseObject);e.EventObject=t}(Xk||(Xk={})),function(e){var t=function(){function t(){}return t._getArmatureType=function(e){switch(e.toLowerCase()){case"stage":return 2;case"armature":return 0;case"movieclip":return 1;default:return 0}},t._getBoneType=function(e){switch(e.toLowerCase()){case"bone":return 0;case"surface":return 1;default:return 0}},t._getDisplayType=function(e){switch(e.toLowerCase()){case"image":return 0;case"mesh":return 2;case"armature":return 1;case"boundingbox":return 3;case"path":return 4;default:return 0}},t._getBoundingBoxType=function(e){switch(e.toLowerCase()){case"rectangle":return 0;case"ellipse":return 1;case"polygon":return 2;default:return 0}},t._getActionType=function(e){switch(e.toLowerCase()){case"play":return 0;case"frame":return 10;case"sound":return 11;default:return 0}},t._getBlendMode=function(e){switch(e.toLowerCase()){case"normal":return 0;case"add":return 1;case"alpha":return 2;case"darken":return 3;case"difference":return 4;case"erase":return 5;case"hardlight":return 6;case"invert":return 7;case"layer":return 8;case"lighten":return 9;case"multiply":return 10;case"overlay":return 11;case"screen":return 12;case"subtract":return 13;default:return 0}},t._getPositionMode=function(e){switch(e.toLocaleLowerCase()){case"percent":return 1;case"fixed":return 0;default:return 1}},t._getSpacingMode=function(e){switch(e.toLocaleLowerCase()){case"length":return 0;case"percent":return 2;case"fixed":return 1;default:return 0}},t._getRotateMode=function(e){switch(e.toLocaleLowerCase()){case"tangent":return 0;case"chain":return 1;case"chainscale":return 2;default:return 0}},t.parseDragonBonesData=function(t){return console.warn("Deprecated."),t instanceof ArrayBuffer?e.BinaryDataParser.getInstance().parseDragonBonesData(t):e.ObjectDataParser.getInstance().parseDragonBonesData(t)},t.parseTextureAtlasData=function(n,i){void 0===i&&(i=1),console.warn("已废弃");for(var r={},a=n[t.SUB_TEXTURE],o=0,s=a.length;o<s;o++){var c=a[o],l=c[t.NAME],u=new e.Rectangle,h=null;u.x=c[t.X]/i,u.y=c[t.Y]/i,u.width=c[t.WIDTH]/i,u.height=c[t.HEIGHT]/i,t.FRAME_WIDTH in c&&((h=new e.Rectangle).x=c[t.FRAME_X]/i,h.y=c[t.FRAME_Y]/i,h.width=c[t.FRAME_WIDTH]/i,h.height=c[t.FRAME_HEIGHT]/i),r[l]={region:u,frame:h,rotated:!1}}return r},t.DATA_VERSION_2_3="2.3",t.DATA_VERSION_3_0="3.0",t.DATA_VERSION_4_0="4.0",t.DATA_VERSION_4_5="4.5",t.DATA_VERSION_5_0="5.0",t.DATA_VERSION_5_5="5.5",t.DATA_VERSION=t.DATA_VERSION_5_5,t.DATA_VERSIONS=[t.DATA_VERSION_4_0,t.DATA_VERSION_4_5,t.DATA_VERSION_5_0,t.DATA_VERSION_5_5],t.TEXTURE_ATLAS="textureAtlas",t.SUB_TEXTURE="SubTexture",t.FORMAT="format",t.IMAGE_PATH="imagePath",t.WIDTH="width",t.HEIGHT="height",t.ROTATED="rotated",t.FRAME_X="frameX",t.FRAME_Y="frameY",t.FRAME_WIDTH="frameWidth",t.FRAME_HEIGHT="frameHeight",t.DRADON_BONES="dragonBones",t.USER_DATA="userData",t.ARMATURE="armature",t.BONE="bone",t.SURFACE="surface",t.SLOT="slot",t.CONSTRAINT="constraint",t.IK="ik",t.PATH_CONSTRAINT="path",t.SKIN="skin",t.DISPLAY="display",t.ANIMATION="animation",t.Z_ORDER="zOrder",t.FFD="ffd",t.FRAME="frame",t.TRANSLATE_FRAME="translateFrame",t.ROTATE_FRAME="rotateFrame",t.SCALE_FRAME="scaleFrame",t.DISPLAY_FRAME="displayFrame",t.COLOR_FRAME="colorFrame",t.DEFAULT_ACTIONS="defaultActions",t.ACTIONS="actions",t.EVENTS="events",t.INTS="ints",t.FLOATS="floats",t.STRINGS="strings",t.CANVAS="canvas",t.TRANSFORM="transform",t.PIVOT="pivot",t.AABB="aabb",t.COLOR="color",t.VERSION="version",t.COMPATIBLE_VERSION="compatibleVersion",t.FRAME_RATE="frameRate",t.TYPE="type",t.SUB_TYPE="subType",t.NAME="name",t.PARENT="parent",t.TARGET="target",t.STAGE="stage",t.SHARE="share",t.PATH="path",t.LENGTH="length",t.DISPLAY_INDEX="displayIndex",t.BLEND_MODE="blendMode",t.INHERIT_TRANSLATION="inheritTranslation",t.INHERIT_ROTATION="inheritRotation",t.INHERIT_SCALE="inheritScale",t.INHERIT_REFLECTION="inheritReflection",t.INHERIT_ANIMATION="inheritAnimation",t.INHERIT_DEFORM="inheritDeform",t.SEGMENT_X="segmentX",t.SEGMENT_Y="segmentY",t.BEND_POSITIVE="bendPositive",t.CHAIN="chain",t.WEIGHT="weight",t.FADE_IN_TIME="fadeInTime",t.PLAY_TIMES="playTimes",t.SCALE="scale",t.OFFSET="offset",t.POSITION="position",t.DURATION="duration",t.TWEEN_EASING="tweenEasing",t.TWEEN_ROTATE="tweenRotate",t.TWEEN_SCALE="tweenScale",t.CLOCK_WISE="clockwise",t.CURVE="curve",t.SOUND="sound",t.EVENT="event",t.ACTION="action",t.X="x",t.Y="y",t.SKEW_X="skX",t.SKEW_Y="skY",t.SCALE_X="scX",t.SCALE_Y="scY",t.VALUE="value",t.ROTATE="rotate",t.SKEW="skew",t.ALPHA_OFFSET="aO",t.RED_OFFSET="rO",t.GREEN_OFFSET="gO",t.BLUE_OFFSET="bO",t.ALPHA_MULTIPLIER="aM",t.RED_MULTIPLIER="rM",t.GREEN_MULTIPLIER="gM",t.BLUE_MULTIPLIER="bM",t.UVS="uvs",t.VERTICES="vertices",t.TRIANGLES="triangles",t.WEIGHTS="weights",t.SLOT_POSE="slotPose",t.BONE_POSE="bonePose",t.GLUE_WEIGHTS="glueWeights",t.GLUE_MESHES="glueMeshes",t.BONES="bones",t.POSITION_MODE="positionMode",t.SPACING_MODE="spacingMode",t.ROTATE_MODE="rotateMode",t.SPACING="spacing",t.ROTATE_OFFSET="rotateOffset",t.ROTATE_MIX="rotateMix",t.TRANSLATE_MIX="translateMix",t.TARGET_DISPLAY="targetDisplay",t.CLOSED="closed",t.CONSTANT_SPEED="constantSpeed",t.VERTEX_COUNT="vertexCount",t.LENGTHS="lengths",t.GOTO_AND_PLAY="gotoAndPlay",t.DEFAULT_NAME="default",t}();e.DataParser=t}(Xk||(Xk={})),function(e){var t=function(t){function i(){var n=null!==t&&t.apply(this,arguments)||this;return n._rawTextureAtlasIndex=0,n._rawBones=[],n._data=null,n._armature=null,n._bone=null,n._surface=null,n._slot=null,n._skin=null,n._mesh=null,n._animation=null,n._timeline=null,n._rawTextureAtlases=null,n._defaultColorOffset=-1,n._prevClockwise=0,n._prevRotation=0,n._helpMatrixA=new e.Matrix,n._helpMatrixB=new e.Matrix,n._helpTransform=new e.Transform,n._helpColorTransform=new e.ColorTransform,n._helpPoint=new e.Point,n._helpArray=[],n._intArray=[],n._floatArray=[],n._frameIntArray=[],n._frameFloatArray=[],n._frameArray=[],n._timelineArray=[],n._cacheRawMeshes=[],n._cacheMeshes=[],n._actionFrames=[],n._weightSlotPose={},n._weightBonePoses={},n._cacheBones={},n._slotChildActions={},n}return qk(i,t),i._getBoolean=function(e,t,n){if(t in e){var i=e[t],r=typeof i;if("boolean"===r)return i;if("string"!==r)return!!i;switch(i){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return n},i._getNumber=function(e,t,n){if(t in e){var i=e[t];return null===i||"NaN"===i?n:+i||0}return n},i._getString=function(t,n,i){if(n in t){var r=t[n];if("string"==typeof r){if(e.DragonBones.webAssembly)for(var a=0,o=r.length;a<o;++a)if(r.charCodeAt(a)>255)return encodeURI(r);return r}return String(r)}return i},i.prototype._getCurvePoint=function(e,t,n,i,r,a,o,s,c,l){var u=1-c,h=u*u,_=c*c,f=u*h,p=3*c*h,d=3*u*_,m=c*_;l.x=f*e+p*n+d*r+m*o,l.y=f*t+p*i+d*a+m*s},i.prototype._samplingEasingCurve=function(e,t){for(var n=e.length,i=-2,r=0,a=t.length;r<a;++r){for(var o=(r+1)/(a+1);(i+6<n?e[i+6]:1)<o;)i+=6;for(var s=i>=0&&i+6<n,c=s?e[i]:0,l=s?e[i+1]:0,u=e[i+2],h=e[i+3],_=e[i+4],f=e[i+5],p=s?e[i+6]:1,d=s?e[i+7]:1,m=0,v=1;v-m>1e-4;){var g=.5*(v+m);this._getCurvePoint(c,l,u,h,_,f,p,d,g,this._helpPoint),o-this._helpPoint.x>0?m=g:v=g}t[r]=this._helpPoint.y}},i.prototype._parseActionDataInFrame=function(t,n,i,r){e.DataParser.EVENT in t&&this._mergeActionFrame(t[e.DataParser.EVENT],n,10,i,r),e.DataParser.SOUND in t&&this._mergeActionFrame(t[e.DataParser.SOUND],n,11,i,r),e.DataParser.ACTION in t&&this._mergeActionFrame(t[e.DataParser.ACTION],n,0,i,r),e.DataParser.EVENTS in t&&this._mergeActionFrame(t[e.DataParser.EVENTS],n,10,i,r),e.DataParser.ACTIONS in t&&this._mergeActionFrame(t[e.DataParser.ACTIONS],n,0,i,r)},i.prototype._mergeActionFrame=function(t,i,r,a,o){for(var s=e.DragonBones.webAssembly?this._armature.actions.size():this._armature.actions.length,c=this._parseActionData(t,r,a,o),l=0,u=null,h=0,_=c;h<_.length;h++){var f=_[h];this._armature.addAction(f,!1)}0===this._actionFrames.length&&((u=new n).frameStart=0,this._actionFrames.push(u),u=null);for(var p=0,d=this._actionFrames;p<d.length;p++){var m=d[p];if(m.frameStart===i){u=m;break}if(m.frameStart>i)break;l++}null===u&&((u=new n).frameStart=i,this._actionFrames.splice(l+1,0,u));for(var v=0;v<c.length;++v)u.actions.push(s+v)},i.prototype._parseArmature=function(t,n){var r=e.BaseObject.borrowObject(e.ArmatureData);if(r.name=i._getString(t,e.DataParser.NAME,""),r.frameRate=i._getNumber(t,e.DataParser.FRAME_RATE,this._data.frameRate),r.scale=n,e.DataParser.TYPE in t&&"string"==typeof t[e.DataParser.TYPE]?r.type=e.DataParser._getArmatureType(t[e.DataParser.TYPE]):r.type=i._getNumber(t,e.DataParser.TYPE,0),0===r.frameRate&&(r.frameRate=24),this._armature=r,e.DataParser.CANVAS in t){var a=t[e.DataParser.CANVAS],o=e.BaseObject.borrowObject(e.CanvasData);e.DataParser.COLOR in a?o.hasBackground=!0:o.hasBackground=!1,o.color=i._getNumber(a,e.DataParser.COLOR,0),o.x=i._getNumber(a,e.DataParser.X,0)*r.scale,o.y=i._getNumber(a,e.DataParser.Y,0)*r.scale,o.width=i._getNumber(a,e.DataParser.WIDTH,0)*r.scale,o.height=i._getNumber(a,e.DataParser.HEIGHT,0)*r.scale,r.canvas=o}if(e.DataParser.AABB in t){var s=t[e.DataParser.AABB];r.aabb.x=i._getNumber(s,e.DataParser.X,0)*r.scale,r.aabb.y=i._getNumber(s,e.DataParser.Y,0)*r.scale,r.aabb.width=i._getNumber(s,e.DataParser.WIDTH,0)*r.scale,r.aabb.height=i._getNumber(s,e.DataParser.HEIGHT,0)*r.scale}if(e.DataParser.BONE in t)for(var c=0,l=t[e.DataParser.BONE];c<l.length;c++){var u=l[c],h=i._getString(u,e.DataParser.PARENT,""),_=this._parseBone(u);if(h.length>0){var f=r.getBone(h);null!==f?_.parent=f:(h in this._cacheBones||(this._cacheBones[h]=[]),this._cacheBones[h].push(_))}if(_.name in this._cacheBones){for(var p=0,d=this._cacheBones[_.name];p<d.length;p++)d[p].parent=_;delete this._cacheBones[_.name]}r.addBone(_),this._rawBones.push(_)}if(e.DataParser.IK in t)for(var m=0,v=t[e.DataParser.IK];m<v.length;m++){var g=v[m];(R=this._parseIKConstraint(g))&&r.addConstraint(R)}if(r.sortBones(),e.DataParser.SLOT in t)for(var y=0,x=0,S=t[e.DataParser.SLOT];x<S.length;x++){var T=S[x];r.addSlot(this._parseSlot(T,y++))}if(e.DataParser.SKIN in t)for(var E=0,A=t[e.DataParser.SKIN];E<A.length;E++){var C=A[E];r.addSkin(this._parseSkin(C))}if(e.DataParser.PATH_CONSTRAINT in t)for(var b=0,P=t[e.DataParser.PATH_CONSTRAINT];b<P.length;b++){var R,I=P[b];(R=this._parsePathConstraint(I))&&r.addConstraint(R)}for(var w=0,D=this._cacheRawMeshes.length;w<D;++w){var O=this._cacheRawMeshes[w];e.DataParser.GLUE_WEIGHTS in O&&e.DataParser.GLUE_MESHES in O&&this._parseMeshGlue(O,this._cacheMeshes[w])}for(w=0,D=this._cacheRawMeshes.length;w<D;++w){var M=this._cacheRawMeshes[w],N=i._getString(M,e.DataParser.SHARE,"");if(0!==N.length){var B=i._getString(M,e.DataParser.SKIN,e.DataParser.DEFAULT_NAME);0===B.length&&(B=e.DataParser.DEFAULT_NAME);var F=r.getMesh(B,"",N);null!==F&&this._cacheMeshes[w].vertices.shareFrom(F.vertices)}}if(e.DataParser.ANIMATION in t)for(var L=0,z=t[e.DataParser.ANIMATION];L<z.length;L++){var U=z[L],G=this._parseAnimation(U);r.addAnimation(G)}if(e.DataParser.DEFAULT_ACTIONS in t)for(var k=0,H=this._parseActionData(t[e.DataParser.DEFAULT_ACTIONS],0,null,null);k<H.length;k++){var V=H[k];r.addAction(V,!0),0===V.type&&null!==(G=r.getAnimation(V.name))&&(r.defaultAnimation=G)}if(e.DataParser.ACTIONS in t)for(var j=0,W=this._parseActionData(t[e.DataParser.ACTIONS],0,null,null);j<W.length;j++)V=W[j],r.addAction(V,!1);for(var q in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[q];for(var q in this._weightBonePoses)delete this._weightBonePoses[q];for(var q in this._cacheBones)delete this._cacheBones[q];for(var q in this._slotChildActions)delete this._slotChildActions[q];return r},i.prototype._parseBone=function(t){var n=this._armature.scale;if(0===(e.DataParser.TYPE in t&&"string"==typeof t[e.DataParser.TYPE]?e.DataParser._getBoneType(t[e.DataParser.TYPE]):i._getNumber(t,e.DataParser.TYPE,0))){var r=e.BaseObject.borrowObject(e.BoneData);return r.inheritTranslation=i._getBoolean(t,e.DataParser.INHERIT_TRANSLATION,!0),r.inheritRotation=i._getBoolean(t,e.DataParser.INHERIT_ROTATION,!0),r.inheritScale=i._getBoolean(t,e.DataParser.INHERIT_SCALE,!0),r.inheritReflection=i._getBoolean(t,e.DataParser.INHERIT_REFLECTION,!0),r.length=i._getNumber(t,e.DataParser.LENGTH,0)*n,r.name=i._getString(t,e.DataParser.NAME,""),e.DataParser.TRANSFORM in t&&this._parseTransform(t[e.DataParser.TRANSFORM],r.transform,n),r}var a=e.BaseObject.borrowObject(e.SurfaceData);if(a.name=i._getString(t,e.DataParser.NAME,""),a.segmentX=i._getNumber(t,e.DataParser.SEGMENT_X,0),a.segmentY=i._getNumber(t,e.DataParser.SEGMENT_Y,0),a.vertices.length=(a.segmentX+1)*(a.segmentY+1)*2,e.DataParser.VERTICES in t)for(var o=t[e.DataParser.VERTICES],s=0,c=a.vertices.length;s<c;++s)s<o.length?a.vertices[s]=o[s]*n:a.vertices[s]=0;return a},i.prototype._parseIKConstraint=function(t){var n=this._armature.getBone(i._getString(t,e.DataParser.BONE,""));if(null===n)return null;var r=this._armature.getBone(i._getString(t,e.DataParser.TARGET,""));if(null===r)return null;var a=e.BaseObject.borrowObject(e.IKConstraintData);return a.scaleEnabled=i._getBoolean(t,e.DataParser.SCALE,!1),a.bendPositive=i._getBoolean(t,e.DataParser.BEND_POSITIVE,!0),a.weight=i._getNumber(t,e.DataParser.WEIGHT,1),a.name=i._getString(t,e.DataParser.NAME,""),a.type=0,a.target=r,i._getNumber(t,e.DataParser.CHAIN,0)>0&&null!==n.parent?(a.root=n.parent,a.bone=n):(a.root=n,a.bone=null),a},i.prototype._parsePathConstraint=function(t){var n=this._armature.getSlot(i._getString(t,e.DataParser.TARGET,""));if(null===n)return null;var r=this._armature.defaultSkin;if(null===r)return null;var a=r.getDisplay(n.name,i._getString(t,e.DataParser.TARGET_DISPLAY,n.name));if(null===a||!(a instanceof e.PathDisplayData))return null;var o=t[e.DataParser.BONES];if(null===o||0===o.length)return null;var s=e.BaseObject.borrowObject(e.PathConstraintData);s.name=i._getString(t,e.DataParser.NAME,""),s.type=1,s.pathSlot=n,s.pathDisplayData=a,s.target=n.parent,s.positionMode=e.DataParser._getPositionMode(i._getString(t,e.DataParser.POSITION_MODE,"")),s.spacingMode=e.DataParser._getSpacingMode(i._getString(t,e.DataParser.SPACING_MODE,"")),s.rotateMode=e.DataParser._getRotateMode(i._getString(t,e.DataParser.ROTATE_MODE,"")),s.position=i._getNumber(t,e.DataParser.POSITION,0),s.spacing=i._getNumber(t,e.DataParser.SPACING,0),s.rotateOffset=i._getNumber(t,e.DataParser.ROTATE_OFFSET,0),s.rotateMix=i._getNumber(t,e.DataParser.ROTATE_MIX,1),s.translateMix=i._getNumber(t,e.DataParser.TRANSLATE_MIX,1);for(var c=0,l=o;c<l.length;c++){var u=l[c],h=this._armature.getBone(u);null!==h&&(s.AddBone(h),null===s.root&&(s.root=h))}return s},i.prototype._parseSlot=function(t,n){var r=e.BaseObject.borrowObject(e.SlotData);return r.displayIndex=i._getNumber(t,e.DataParser.DISPLAY_INDEX,0),r.zOrder=n,r.name=i._getString(t,e.DataParser.NAME,""),r.parent=this._armature.getBone(i._getString(t,e.DataParser.PARENT,"")),e.DataParser.BLEND_MODE in t&&"string"==typeof t[e.DataParser.BLEND_MODE]?r.blendMode=e.DataParser._getBlendMode(t[e.DataParser.BLEND_MODE]):r.blendMode=i._getNumber(t,e.DataParser.BLEND_MODE,0),e.DataParser.COLOR in t?(r.color=e.SlotData.createColor(),this._parseColorTransform(t[e.DataParser.COLOR],r.color)):r.color=e.SlotData.DEFAULT_COLOR,e.DataParser.ACTIONS in t&&(this._slotChildActions[r.name]=this._parseActionData(t[e.DataParser.ACTIONS],0,null,null)),r},i.prototype._parseSkin=function(t){var n=e.BaseObject.borrowObject(e.SkinData);if(n.name=i._getString(t,e.DataParser.NAME,e.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=e.DataParser.DEFAULT_NAME),e.DataParser.SLOT in t){var r=t[e.DataParser.SLOT];this._skin=n;for(var a=0,o=r;a<o.length;a++){var s=o[a],c=i._getString(s,e.DataParser.NAME,""),l=this._armature.getSlot(c);if(null!==l){if(this._slot=l,e.DataParser.DISPLAY in s)for(var u=0,h=s[e.DataParser.DISPLAY];u<h.length;u++){var _=h[u];_?n.addDisplay(c,this._parseDisplay(_)):n.addDisplay(c,null)}this._slot=null}}this._skin=null}return n},i.prototype._parseDisplay=function(t){var n=i._getString(t,e.DataParser.NAME,""),r=i._getString(t,e.DataParser.PATH,""),a=0,o=null;switch(a=e.DataParser.TYPE in t&&"string"==typeof t[e.DataParser.TYPE]?e.DataParser._getDisplayType(t[e.DataParser.TYPE]):i._getNumber(t,e.DataParser.TYPE,a)){case 0:var s=o=e.BaseObject.borrowObject(e.ImageDisplayData);s.name=n,s.path=r.length>0?r:n,this._parsePivot(t,s);break;case 1:var c=o=e.BaseObject.borrowObject(e.ArmatureDisplayData);if(c.name=n,c.path=r.length>0?r:n,c.inheritAnimation=!0,e.DataParser.ACTIONS in t)for(var l=0,u=this._parseActionData(t[e.DataParser.ACTIONS],0,null,null);l<u.length;l++){var h=u[l];c.addAction(h)}else if(this._slot.name in this._slotChildActions){var _=this._skin.getDisplays(this._slot.name);if(null===_?0===this._slot.displayIndex:this._slot.displayIndex===_.length){for(var f=0,p=this._slotChildActions[this._slot.name];f<p.length;f++)h=p[f],c.addAction(h);delete this._slotChildActions[this._slot.name]}}break;case 2:var d=o=e.BaseObject.borrowObject(e.MeshDisplayData);d.vertices.inheritDeform=i._getBoolean(t,e.DataParser.INHERIT_DEFORM,!0),d.name=n,d.path=r.length>0?r:n,d.vertices.data=this._data,e.DataParser.SHARE in t?(this._cacheRawMeshes.push(t),this._cacheMeshes.push(d)):this._parseMesh(t,d),e.DataParser.GLUE_WEIGHTS in t&&e.DataParser.GLUE_MESHES in t&&(this._cacheRawMeshes.push(t),this._cacheMeshes.push(d));break;case 3:var m=this._parseBoundingBox(t);if(null!==m){var v=o=e.BaseObject.borrowObject(e.BoundingBoxDisplayData);v.name=n,v.path=r.length>0?r:n,v.boundingBox=m}break;case 4:var g=t[e.DataParser.LENGTHS],y=o=e.BaseObject.borrowObject(e.PathDisplayData);y.closed=i._getBoolean(t,e.DataParser.CLOSED,!1),y.constantSpeed=i._getBoolean(t,e.DataParser.CONSTANT_SPEED,!1),y.name=n,y.path=r.length>0?r:n,y.vertices.data=this._data,y.curveLengths.length=g.length;for(var x=0,S=g.length;x<S;++x)y.curveLengths[x]=g[x];this._parsePath(t,y)}return null!==o&&e.DataParser.TRANSFORM in t&&this._parseTransform(t[e.DataParser.TRANSFORM],o.transform,this._armature.scale),o},i.prototype._parsePath=function(t,n){var r=t[e.DataParser.VERTICES],a=i._getNumber(t,e.DataParser.VERTEX_COUNT,0),o=this._floatArray.length,s=this._intArray.length;if(n.vertices.offset=s,this._intArray.length+=2,this._intArray[s+0]=a,this._intArray[s+2]=o,e.DataParser.WEIGHTS in t){var c=t[e.DataParser.WEIGHTS],l=t[e.DataParser.BONES],u=l.length,h=Math.floor(c.length-a)/2,_=this._intArray.length,f=this._floatArray.length,p=this._armature.sortedBones,d=e.BaseObject.borrowObject(e.WeightData);for(d.count=h,d.offset=_,this._intArray.length+=2+u+a+h,this._intArray[_+0]=u,this._intArray[_+1]=f,R=0;R<u;R++){var m=l[R],v=this._rawBones[m];d.addBone(v),this._intArray[_+2+R]=p.indexOf(v)}this._floatArray.length+=3*h,R=0;for(var g=0,y=0,x=_+2+u,S=f;R<h;R++){var T=c[g++];this._intArray[x++]=T;for(var E=0;E<T;E++){var A=c[g++],C=c[g++],b=r[y++],P=r[y++];this._intArray[x++]=l.indexOf(A),this._floatArray[S++]=C,this._floatArray[S++]=b,this._floatArray[S++]=P}}n.vertices.weight=d}else{this._floatArray.length+=r.length;for(var R=0,I=r.length;R<I;++R)this._floatArray[o+R]=r[R]}},i.prototype._parsePivot=function(t,n){if(e.DataParser.PIVOT in t){var r=t[e.DataParser.PIVOT];n.pivot.x=i._getNumber(r,e.DataParser.X,0),n.pivot.y=i._getNumber(r,e.DataParser.Y,0)}else n.pivot.x=.5,n.pivot.y=.5},i.prototype._parseMesh=function(t,n){var i=t[e.DataParser.VERTICES],r=t[e.DataParser.UVS],a=t[e.DataParser.TRIANGLES],o=Math.floor(i.length/2),s=Math.floor(a.length/3),c=this._floatArray.length,l=c+2*o,u=this._intArray.length,h=this._skin.name+"_"+this._slot.name+"_"+n.name;n.vertices.offset=u,this._intArray.length+=4+3*s,this._intArray[u+0]=o,this._intArray[u+1]=s,this._intArray[u+2]=c;for(var _=0,f=3*s;_<f;++_)this._intArray[u+4+_]=a[_];for(this._floatArray.length+=2*o+2*o,_=0,f=2*o;_<f;++_)this._floatArray[c+_]=i[_],this._floatArray[l+_]=r[_];if(e.DataParser.WEIGHTS in t){var p=t[e.DataParser.WEIGHTS],d=t[e.DataParser.SLOT_POSE],m=t[e.DataParser.BONE_POSE],v=this._armature.sortedBones,g=new Array,y=Math.floor(m.length/7),x=this._floatArray.length,S=Math.floor(p.length-o)/2,T=this._intArray.length,E=e.BaseObject.borrowObject(e.WeightData);for(E.count=S,E.offset=T,g.length=y,this._intArray.length+=2+y+o+S,this._intArray[T+1]=x,_=0;_<y;++_){var A=m[7*_],C=this._rawBones[A];E.addBone(C),g[_]=A,this._intArray[T+2+_]=v.indexOf(C)}this._floatArray.length+=3*S,this._helpMatrixA.copyFromArray(d,0),_=0;for(var b=0,P=T+2+y,R=x;_<o;++_){var I=2*_,w=this._intArray[P++]=p[b++],D=this._floatArray[c+I],O=this._floatArray[c+I+1];this._helpMatrixA.transformPoint(D,O,this._helpPoint),D=this._helpPoint.x,O=this._helpPoint.y;for(var M=0;M<w;++M){A=p[b++];var N=g.indexOf(A);this._helpMatrixB.copyFromArray(m,7*N+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(D,O,this._helpPoint),this._intArray[P++]=N,this._floatArray[R++]=p[b++],this._floatArray[R++]=this._helpPoint.x,this._floatArray[R++]=this._helpPoint.y}}n.vertices.weight=E,this._weightSlotPose[h]=d,this._weightBonePoses[h]=m}},i.prototype._parseMeshGlue=function(){},i.prototype._parseBoundingBox=function(t){var n=null,r=0;switch(r=e.DataParser.SUB_TYPE in t&&"string"==typeof t[e.DataParser.SUB_TYPE]?e.DataParser._getBoundingBoxType(t[e.DataParser.SUB_TYPE]):i._getNumber(t,e.DataParser.SUB_TYPE,r)){case 0:n=e.BaseObject.borrowObject(e.RectangleBoundingBoxData);break;case 1:n=e.BaseObject.borrowObject(e.EllipseBoundingBoxData);break;case 2:n=this._parsePolygonBoundingBox(t)}return null!==n&&(n.color=i._getNumber(t,e.DataParser.COLOR,0),0!==n.type&&1!==n.type||(n.width=i._getNumber(t,e.DataParser.WIDTH,0),n.height=i._getNumber(t,e.DataParser.HEIGHT,0))),n},i.prototype._parsePolygonBoundingBox=function(t){var n=e.BaseObject.borrowObject(e.PolygonBoundingBoxData);if(e.DataParser.VERTICES in t){var i=this._armature.scale,r=t[e.DataParser.VERTICES],a=n.vertices;e.DragonBones.webAssembly?a.resize(r.length,0):a.length=r.length;for(var o=0,s=r.length;o<s;o+=2){var c=r[o]*i,l=r[o+1]*i;e.DragonBones.webAssembly?(a.set(o,c),a.set(o+1,l)):(a[o]=c,a[o+1]=l),0===o?(n.x=c,n.y=l,n.width=c,n.height=l):(c<n.x?n.x=c:c>n.width&&(n.width=c),l<n.y?n.y=l:l>n.height&&(n.height=l))}n.width-=n.x,n.height-=n.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return n},i.prototype._parseAnimation=function(t){var n=e.BaseObject.borrowObject(e.AnimationData);if(n.frameCount=Math.max(i._getNumber(t,e.DataParser.DURATION,1),1),n.playTimes=i._getNumber(t,e.DataParser.PLAY_TIMES,1),n.duration=n.frameCount/this._armature.frameRate,n.fadeInTime=i._getNumber(t,e.DataParser.FADE_IN_TIME,0),n.scale=i._getNumber(t,e.DataParser.SCALE,1),n.name=i._getString(t,e.DataParser.NAME,e.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=e.DataParser.DEFAULT_NAME),n.frameIntOffset=this._frameIntArray.length,n.frameFloatOffset=this._frameFloatArray.length,n.frameOffset=this._frameArray.length,this._animation=n,e.DataParser.FRAME in t){var r=t[e.DataParser.FRAME],a=r.length;if(a>0)for(var o=0,s=0;o<a;++o){var c=r[o];this._parseActionDataInFrame(c,s,null,null),s+=i._getNumber(c,e.DataParser.DURATION,1)}}if(e.DataParser.Z_ORDER in t&&(this._animation.zOrderTimeline=this._parseTimeline(t[e.DataParser.Z_ORDER],null,e.DataParser.FRAME,1,!1,!1,0,this._parseZOrderFrame)),e.DataParser.BONE in t)for(var l=0,u=t[e.DataParser.BONE];l<u.length;l++){var h=u[l];this._parseBoneTimeline(h)}if(e.DataParser.SURFACE in t)for(var _=0,f=t[e.DataParser.SURFACE];_<f.length;_++){h=f[_];var p=i._getString(h,e.DataParser.NAME,"");this._surface=this._armature.getBone(p),null!==this._surface&&(null!==(R=this._parseTimeline(h,null,e.DataParser.FRAME,50,!1,!0,0,this._parseSurfaceFrame))&&this._animation.addSurfaceTimeline(this._surface,R),this._surface=null)}if(e.DataParser.SLOT in t)for(var d=0,m=t[e.DataParser.SLOT];d<m.length;d++)h=m[d],this._parseSlotTimeline(h);if(e.DataParser.FFD in t)for(var v=0,g=t[e.DataParser.FFD];v<g.length;v++){h=g[v];var y=i._getString(h,e.DataParser.SKIN,e.DataParser.DEFAULT_NAME),x=i._getString(h,e.DataParser.SLOT,""),S=i._getString(h,e.DataParser.NAME,"");0===y.length&&(y=e.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(x),this._mesh=this._armature.getMesh(y,x,S),null!==this._slot&&null!==this._mesh&&(null!==(R=this._parseTimeline(h,null,e.DataParser.FRAME,22,!1,!0,0,this._parseSlotFFDFrame))&&this._animation.addSlotTimeline(this._slot,R),this._slot=null,this._mesh=null)}if(e.DataParser.IK in t)for(var T=0,E=t[e.DataParser.IK];T<E.length;T++){h=E[T];var A=i._getString(h,e.DataParser.NAME,""),C=this._armature.getConstraint(A);null!==C&&null!==(R=this._parseTimeline(h,null,e.DataParser.FRAME,30,!0,!1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(C,R)}if(e.DataParser.ANIMATION in t)for(var b=0,P=t[e.DataParser.ANIMATION];b<P.length;b++){h=P[b];var R,I=i._getString(h,e.DataParser.NAME,"");null!==(R=this._parseTimeline(h,null,e.DataParser.FRAME,40,!0,!1,2,this._parseAnimationFrame))&&this._animation.addAnimationTimeline(I,R)}return this._actionFrames.length>0&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,!1,!1,0,this._parseActionFrame),this._actionFrames.length=0),this._animation=null,n},i.prototype._parseTimeline=function(t,r,a,o,s,c,l,u){if(null!==t&&a.length>0&&a in t&&(r=t[a]),null===r)return null;var h=r.length;if(0===h)return null;var _=this._frameIntArray.length,f=this._frameFloatArray.length,p=e.BaseObject.borrowObject(e.TimelineData),d=this._timelineArray.length;if(this._timelineArray.length+=5+h,null!==t?(this._timelineArray[d+0]=Math.round(100*i._getNumber(t,e.DataParser.SCALE,1)),this._timelineArray[d+1]=Math.round(100*i._getNumber(t,e.DataParser.OFFSET,0))):(this._timelineArray[d+0]=100,this._timelineArray[d+1]=0),this._timelineArray[d+2]=h,this._timelineArray[d+3]=l,this._timelineArray[d+4]=s?_-this._animation.frameIntOffset:c?f-this._animation.frameFloatOffset:0,this._timeline=p,p.type=o,p.offset=d,1===h)p.frameIndicesOffset=-1,this._timelineArray[d+5+0]=u.call(this,r[0],0,0)-this._animation.frameOffset;else{var m=this._animation.frameCount+1,v=this._data.frameIndices,g=0;e.DragonBones.webAssembly?(g=v.size(),v.resize(g+m,0)):(g=v.length,v.length+=m),p.frameIndicesOffset=g;for(var y=0,x=0,S=0,T=0;y<m;++y){if(S+T<=y&&x<h){var E=r[x];S=y,T=x===h-1?this._animation.frameCount-S:E instanceof n?this._actionFrames[x+1].frameStart-S:i._getNumber(E,e.DataParser.DURATION,1),this._timelineArray[d+5+x]=u.call(this,E,S,T)-this._animation.frameOffset,x++}e.DragonBones.webAssembly?v.set(g+y,x-1):v[g+y]=x-1}}return this._timeline=null,p},i.prototype._parseBoneTimeline=function(t){var n,r=this._armature.getBone(i._getString(t,e.DataParser.NAME,""));null!==r&&(this._bone=r,this._slot=this._armature.getSlot(this._bone.name),e.DataParser.TRANSLATE_FRAME in t&&null!==(n=this._parseTimeline(t,null,e.DataParser.TRANSLATE_FRAME,11,!1,!0,2,this._parseBoneTranslateFrame))&&this._animation.addBoneTimeline(r,n),e.DataParser.ROTATE_FRAME in t&&null!==(n=this._parseTimeline(t,null,e.DataParser.ROTATE_FRAME,12,!1,!0,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(r,n),e.DataParser.SCALE_FRAME in t&&null!==(n=this._parseTimeline(t,null,e.DataParser.SCALE_FRAME,13,!1,!0,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(r,n),e.DataParser.FRAME in t&&null!==(n=this._parseTimeline(t,null,e.DataParser.FRAME,10,!1,!0,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(r,n),this._bone=null,this._slot=null)},i.prototype._parseSlotTimeline=function(t){var n=this._armature.getSlot(i._getString(t,e.DataParser.NAME,""));if(null!==n){this._slot=n;var r;null!==(r=e.DataParser.DISPLAY_FRAME in t?this._parseTimeline(t,null,e.DataParser.DISPLAY_FRAME,20,!1,!1,0,this._parseSlotDisplayFrame):this._parseTimeline(t,null,e.DataParser.FRAME,20,!1,!1,0,this._parseSlotDisplayFrame))&&this._animation.addSlotTimeline(n,r);var a;null!==(a=e.DataParser.COLOR_FRAME in t?this._parseTimeline(t,null,e.DataParser.COLOR_FRAME,21,!0,!1,1,this._parseSlotColorFrame):this._parseTimeline(t,null,e.DataParser.FRAME,21,!0,!1,1,this._parseSlotColorFrame))&&this._animation.addSlotTimeline(n,a),this._slot=null}},i.prototype._parseFrame=function(e,t){var n=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[n+0]=t,n},i.prototype._parseTweenFrame=function(t,n,r){var a=this._parseFrame(t,n,r);if(r>0)if(e.DataParser.CURVE in t){var o=r+1;this._helpArray.length=o,this._samplingEasingCurve(t[e.DataParser.CURVE],this._helpArray),this._frameArray.length+=2+this._helpArray.length,this._frameArray[a+1]=2,this._frameArray[a+2]=o;for(var s=0;s<o;++s)this._frameArray[a+3+s]=Math.round(1e4*this._helpArray[s])}else{var c=-2;e.DataParser.TWEEN_EASING in t&&(c=i._getNumber(t,e.DataParser.TWEEN_EASING,-2)),-2===c?(this._frameArray.length+=1,this._frameArray[a+1]=0):0===c?(this._frameArray.length+=1,this._frameArray[a+1]=1):c<0?(this._frameArray.length+=2,this._frameArray[a+1]=3,this._frameArray[a+2]=Math.round(100*-c)):c<=1?(this._frameArray.length+=2,this._frameArray[a+1]=4,this._frameArray[a+2]=Math.round(100*c)):(this._frameArray.length+=2,this._frameArray[a+1]=5,this._frameArray[a+2]=Math.round(100*c-100))}else this._frameArray.length+=1,this._frameArray[a+1]=0;return a},i.prototype._parseActionFrame=function(e,t){var n=this._frameArray.length,i=e.actions.length;this._frameArray.length+=2+i,this._frameArray[n+0]=t,this._frameArray[n+0+1]=i;for(var r=0;r<i;++r)this._frameArray[n+0+2+r]=e.actions[r];return n},i.prototype._parseZOrderFrame=function(t,n,i){var r=this._parseFrame(t,n,i);if(e.DataParser.Z_ORDER in t){var a=t[e.DataParser.Z_ORDER];if(a.length>0){for(var o=this._armature.sortedSlots.length,s=new Array(o-a.length/2),c=new Array(o),l=0;l<s.length;++l)s[l]=0;for(var u=0;u<o;++u)c[u]=-1;for(var h=0,_=0,f=0,p=a.length;f<p;f+=2){for(var d=a[f],m=a[f+1];h!==d;)s[_++]=h++;c[h+m]=h++}for(;h<o;)s[_++]=h++;this._frameArray.length+=1+o,this._frameArray[r+1]=o;for(var v=o;v--;)-1===c[v]?this._frameArray[r+2+v]=s[--_]||0:this._frameArray[r+2+v]=c[v]||0;return r}}return this._frameArray.length+=1,this._frameArray[r+1]=0,r},i.prototype._parseBoneAllFrame=function(t,n,r){this._helpTransform.identity(),e.DataParser.TRANSFORM in t&&this._parseTransform(t[e.DataParser.TRANSFORM],this._helpTransform,1);var a=this._helpTransform.rotation;0!==n&&(0===this._prevClockwise?a=this._prevRotation+e.Transform.normalizeRadian(a-this._prevRotation):((this._prevClockwise>0?a>=this._prevRotation:a<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),a=this._prevRotation+a-this._prevRotation+e.Transform.PI_D*this._prevClockwise)),this._prevClockwise=i._getNumber(t,e.DataParser.TWEEN_ROTATE,0),this._prevRotation=a;var o=this._parseTweenFrame(t,n,r),s=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[s++]=this._helpTransform.x,this._frameFloatArray[s++]=this._helpTransform.y,this._frameFloatArray[s++]=a,this._frameFloatArray[s++]=this._helpTransform.skew,this._frameFloatArray[s++]=this._helpTransform.scaleX,this._frameFloatArray[s++]=this._helpTransform.scaleY,this._parseActionDataInFrame(t,n,this._bone,this._slot),o},i.prototype._parseBoneTranslateFrame=function(t,n,r){var a=this._parseTweenFrame(t,n,r),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=i._getNumber(t,e.DataParser.X,0),this._frameFloatArray[o++]=i._getNumber(t,e.DataParser.Y,0),a},i.prototype._parseBoneRotateFrame=function(t,n,r){var a=i._getNumber(t,e.DataParser.ROTATE,0)*e.Transform.DEG_RAD;0!==n&&(0===this._prevClockwise?a=this._prevRotation+e.Transform.normalizeRadian(a-this._prevRotation):((this._prevClockwise>0?a>=this._prevRotation:a<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),a=this._prevRotation+a-this._prevRotation+e.Transform.PI_D*this._prevClockwise)),this._prevClockwise=i._getNumber(t,e.DataParser.CLOCK_WISE,0),this._prevRotation=a;var o=this._parseTweenFrame(t,n,r),s=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[s++]=a,this._frameFloatArray[s++]=i._getNumber(t,e.DataParser.SKEW,0)*e.Transform.DEG_RAD,o},i.prototype._parseBoneScaleFrame=function(t,n,r){var a=this._parseTweenFrame(t,n,r),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=i._getNumber(t,e.DataParser.X,1),this._frameFloatArray[o++]=i._getNumber(t,e.DataParser.Y,1),a},i.prototype._parseSurfaceFrame=function(t,n,r){var a=this._frameFloatArray.length,o=this._parseTweenFrame(t,n,r),s=t[e.DataParser.VERTICES],c=i._getNumber(t,e.DataParser.OFFSET,0),l=this._surface.vertices.length/2,u=0,h=0;this._frameFloatArray.length+=2*l;for(var _=0;_<2*l;_+=2)u=_<c||_-c>=s.length?0:s[_-c],h=_+1<c||_+1-c>=s.length?0:s[_+1-c],this._frameFloatArray[a+_]=u,this._frameFloatArray[a+_+1]=h;if(0===n){var f=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[f+0]=0,this._frameIntArray[f+1]=this._frameFloatArray.length-a,this._frameIntArray[f+2]=this._frameFloatArray.length-a,this._frameIntArray[f+3]=0,this._frameIntArray[f+4]=a-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=f-this._animation.frameIntOffset}return o},i.prototype._parseSlotDisplayFrame=function(t,n,r){var a=this._parseFrame(t,n,r);return this._frameArray.length+=1,e.DataParser.VALUE in t?this._frameArray[a+1]=i._getNumber(t,e.DataParser.VALUE,0):this._frameArray[a+1]=i._getNumber(t,e.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(t,n,this._slot.parent,this._slot),a},i.prototype._parseSlotColorFrame=function(t,n,i){var r=this._parseTweenFrame(t,n,i),a=-1;if(e.DataParser.VALUE in t||e.DataParser.COLOR in t){var o=e.DataParser.VALUE in t?t[e.DataParser.VALUE]:t[e.DataParser.COLOR];for(var s in o){this._parseColorTransform(o,this._helpColorTransform),a=this._intArray.length,this._intArray.length+=8,this._intArray[a++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._intArray[a++]=Math.round(100*this._helpColorTransform.redMultiplier),this._intArray[a++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._intArray[a++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._intArray[a++]=Math.round(this._helpColorTransform.alphaOffset),this._intArray[a++]=Math.round(this._helpColorTransform.redOffset),this._intArray[a++]=Math.round(this._helpColorTransform.greenOffset),this._intArray[a++]=Math.round(this._helpColorTransform.blueOffset),a-=8;break}}a<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=a=this._intArray.length,this._intArray.length+=8,this._intArray[a++]=100,this._intArray[a++]=100,this._intArray[a++]=100,this._intArray[a++]=100,this._intArray[a++]=0,this._intArray[a++]=0,this._intArray[a++]=0,this._intArray[a++]=0),a=this._defaultColorOffset);var c=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[c]=a,r},i.prototype._parseSlotFFDFrame=function(t,n,r){var a=this._frameFloatArray.length,o=this._parseTweenFrame(t,n,r),s=e.DataParser.VERTICES in t?t[e.DataParser.VERTICES]:null,c=i._getNumber(t,e.DataParser.OFFSET,0),l=this._intArray[this._mesh.vertices.offset+0],u=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,h=this._mesh.vertices.weight,_=0,f=0,p=0,d=0;if(null!==h){var m=this._weightSlotPose[u];this._helpMatrixA.copyFromArray(m,0),this._frameFloatArray.length+=2*h.count,p=h.offset+2+h.bones.length}else this._frameFloatArray.length+=2*l;for(var v=0;v<2*l;v+=2)if(null===s?(_=0,f=0):(_=v<c||v-c>=s.length?0:s[v-c],f=v+1<c||v+1-c>=s.length?0:s[v+1-c]),null!==h){var g=this._weightBonePoses[u],y=this._intArray[p++];this._helpMatrixA.transformPoint(_,f,this._helpPoint,!0),_=this._helpPoint.x,f=this._helpPoint.y;for(var x=0;x<y;++x){var S=this._intArray[p++];this._helpMatrixB.copyFromArray(g,7*S+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(_,f,this._helpPoint,!0),this._frameFloatArray[a+d++]=this._helpPoint.x,this._frameFloatArray[a+d++]=this._helpPoint.y}}else this._frameFloatArray[a+v]=_,this._frameFloatArray[a+v+1]=f;if(0===n){var T=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[T+0]=this._mesh.vertices.offset,this._frameIntArray[T+1]=this._frameFloatArray.length-a,this._frameIntArray[T+2]=this._frameFloatArray.length-a,this._frameIntArray[T+3]=0,this._frameIntArray[T+4]=a-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=T-this._animation.frameIntOffset}return o},i.prototype._parseIKConstraintFrame=function(t,n,r){var a=this._parseTweenFrame(t,n,r),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=i._getBoolean(t,e.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[o++]=Math.round(100*i._getNumber(t,e.DataParser.WEIGHT,1)),a},i.prototype._parseAnimationFrame=function(t,n,r){var a=this._parseTweenFrame(t,n,r),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=i._getNumber(t,e.DataParser.VALUE,0),this._frameIntArray[o++]=Math.round(100*i._getNumber(t,e.DataParser.WEIGHT,1)),a},i.prototype._parseActionData=function(t,n,r,a){var o=new Array;if("string"==typeof t)(u=e.BaseObject.borrowObject(e.ActionData)).type=n,u.name=t,u.bone=r,u.slot=a,o.push(u);else if(t instanceof Array)for(var s=0,c=t;s<c.length;s++){var l=c[s],u=e.BaseObject.borrowObject(e.ActionData);if(e.DataParser.GOTO_AND_PLAY in l?(u.type=0,u.name=i._getString(l,e.DataParser.GOTO_AND_PLAY,"")):(e.DataParser.TYPE in l&&"string"==typeof l[e.DataParser.TYPE]?u.type=e.DataParser._getActionType(l[e.DataParser.TYPE]):u.type=i._getNumber(l,e.DataParser.TYPE,n),u.name=i._getString(l,e.DataParser.NAME,"")),e.DataParser.BONE in l){var h=i._getString(l,e.DataParser.BONE,"");u.bone=this._armature.getBone(h)}else u.bone=r;if(e.DataParser.SLOT in l){var _=i._getString(l,e.DataParser.SLOT,"");u.slot=this._armature.getSlot(_)}else u.slot=a;var f=null;if(e.DataParser.INTS in l){null===f&&(f=e.BaseObject.borrowObject(e.UserData));for(var p=0,d=l[e.DataParser.INTS];p<d.length;p++){var m=d[p];f.addInt(m)}}if(e.DataParser.FLOATS in l){null===f&&(f=e.BaseObject.borrowObject(e.UserData));for(var v=0,g=l[e.DataParser.FLOATS];v<g.length;v++)m=g[v],f.addFloat(m)}if(e.DataParser.STRINGS in l){null===f&&(f=e.BaseObject.borrowObject(e.UserData));for(var y=0,x=l[e.DataParser.STRINGS];y<x.length;y++)m=x[y],f.addString(m)}u.data=f,o.push(u)}return o},i.prototype._parseTransform=function(t,n,r){n.x=i._getNumber(t,e.DataParser.X,0)*r,n.y=i._getNumber(t,e.DataParser.Y,0)*r,e.DataParser.ROTATE in t||e.DataParser.SKEW in t?(n.rotation=e.Transform.normalizeRadian(i._getNumber(t,e.DataParser.ROTATE,0)*e.Transform.DEG_RAD),n.skew=e.Transform.normalizeRadian(i._getNumber(t,e.DataParser.SKEW,0)*e.Transform.DEG_RAD)):(e.DataParser.SKEW_X in t||e.DataParser.SKEW_Y in t)&&(n.rotation=e.Transform.normalizeRadian(i._getNumber(t,e.DataParser.SKEW_Y,0)*e.Transform.DEG_RAD),n.skew=e.Transform.normalizeRadian(i._getNumber(t,e.DataParser.SKEW_X,0)*e.Transform.DEG_RAD)-n.rotation),n.scaleX=i._getNumber(t,e.DataParser.SCALE_X,1),n.scaleY=i._getNumber(t,e.DataParser.SCALE_Y,1)},i.prototype._parseColorTransform=function(t,n){n.alphaMultiplier=.01*i._getNumber(t,e.DataParser.ALPHA_MULTIPLIER,100),n.redMultiplier=.01*i._getNumber(t,e.DataParser.RED_MULTIPLIER,100),n.greenMultiplier=.01*i._getNumber(t,e.DataParser.GREEN_MULTIPLIER,100),n.blueMultiplier=.01*i._getNumber(t,e.DataParser.BLUE_MULTIPLIER,100),n.alphaOffset=i._getNumber(t,e.DataParser.ALPHA_OFFSET,0),n.redOffset=i._getNumber(t,e.DataParser.RED_OFFSET,0),n.greenOffset=i._getNumber(t,e.DataParser.GREEN_OFFSET,0),n.blueOffset=i._getNumber(t,e.DataParser.BLUE_OFFSET,0)},i.prototype._parseArray=function(){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0},i.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0);var t=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,n=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,i=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,r=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,a=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,o=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,s=t+n+i+r+a+o;if(e.DragonBones.webAssembly){for(var c=e.webAssemblyModule.HEAP16.buffer,l=e.webAssemblyModule._malloc(s),u=new Int16Array(c,l,this._intArray.length),h=new Float32Array(c,l+t,this._floatArray.length),_=new Int16Array(c,l+t+n,this._frameIntArray.length),f=new Float32Array(c,l+t+n+i,this._frameFloatArray.length),p=new Int16Array(c,l+t+n+i+r,this._frameArray.length),d=new Uint16Array(c,l+t+n+i+r+a,this._timelineArray.length),m=0,v=this._intArray.length;m<v;++m)u[m]=this._intArray[m];for(m=0,v=this._floatArray.length;m<v;++m)h[m]=this._floatArray[m];for(m=0,v=this._frameIntArray.length;m<v;++m)_[m]=this._frameIntArray[m];for(m=0,v=this._frameFloatArray.length;m<v;++m)f[m]=this._frameFloatArray[m];for(m=0,v=this._frameArray.length;m<v;++m)p[m]=this._frameArray[m];for(m=0,v=this._timelineArray.length;m<v;++m)d[m]=this._timelineArray[m];e.webAssemblyModule.setDataBinary(this._data,l,t,n,i,r,a,o)}else{var g=new ArrayBuffer(s);for(u=new Int16Array(g,0,this._intArray.length),h=new Float32Array(g,t,this._floatArray.length),_=new Int16Array(g,t+n,this._frameIntArray.length),f=new Float32Array(g,t+n+i,this._frameFloatArray.length),p=new Int16Array(g,t+n+i+r,this._frameArray.length),d=new Uint16Array(g,t+n+i+r+a,this._timelineArray.length),m=0,v=this._intArray.length;m<v;++m)u[m]=this._intArray[m];for(m=0,v=this._floatArray.length;m<v;++m)h[m]=this._floatArray[m];for(m=0,v=this._frameIntArray.length;m<v;++m)_[m]=this._frameIntArray[m];for(m=0,v=this._frameFloatArray.length;m<v;++m)f[m]=this._frameFloatArray[m];for(m=0,v=this._frameArray.length;m<v;++m)p[m]=this._frameArray[m];for(m=0,v=this._timelineArray.length;m<v;++m)d[m]=this._timelineArray[m];this._data.binary=g,this._data.intArray=u,this._data.floatArray=h,this._data.frameIntArray=_,this._data.frameFloatArray=f,this._data.frameArray=p,this._data.timelineArray=d}this._defaultColorOffset=-1},i.prototype.parseDragonBonesData=function(t,n){void 0===n&&(n=1),console.assert(null!=t,"Data error.");var r=i._getString(t,e.DataParser.VERSION,""),a=i._getString(t,e.DataParser.COMPATIBLE_VERSION,"");if(e.DataParser.DATA_VERSIONS.indexOf(r)>=0||e.DataParser.DATA_VERSIONS.indexOf(a)>=0){var o=e.BaseObject.borrowObject(e.DragonBonesData);if(o.version=r,o.name=i._getString(t,e.DataParser.NAME,""),o.frameRate=i._getNumber(t,e.DataParser.FRAME_RATE,24),0===o.frameRate&&(o.frameRate=24),e.DataParser.ARMATURE in t){this._data=o,this._parseArray(t);for(var s=0,c=t[e.DataParser.ARMATURE];s<c.length;s++){var l=c[s];o.addArmature(this._parseArmature(l,n))}this._data.binary||this._modifyArray(),e.DataParser.STAGE in t?o.stage=o.getArmature(i._getString(t,e.DataParser.STAGE,"")):o.armatureNames.length>0&&(o.stage=o.getArmature(o.armatureNames[0])),this._data=null}return e.DataParser.TEXTURE_ATLAS in t&&(this._rawTextureAtlases=t[e.DataParser.TEXTURE_ATLAS]),o}return console.assert(!1,"Nonsupport data version: "+r+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},i.prototype.parseTextureAtlasData=function(t,n,r){if(void 0===r&&(r=1),console.assert(void 0!==t),null===t){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var a=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(a,n,r),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(n.width=i._getNumber(t,e.DataParser.WIDTH,0),n.height=i._getNumber(t,e.DataParser.HEIGHT,0),n.scale=1===r?1/i._getNumber(t,e.DataParser.SCALE,1):r,n.name=i._getString(t,e.DataParser.NAME,""),n.imagePath=i._getString(t,e.DataParser.IMAGE_PATH,""),e.DataParser.SUB_TEXTURE in t)for(var o=t[e.DataParser.SUB_TEXTURE],s=0,c=o.length;s<c;++s){var l=o[s],u=n.createTexture();u.rotated=i._getBoolean(l,e.DataParser.ROTATED,!1),u.name=i._getString(l,e.DataParser.NAME,""),u.region.x=i._getNumber(l,e.DataParser.X,0),u.region.y=i._getNumber(l,e.DataParser.Y,0),u.region.width=i._getNumber(l,e.DataParser.WIDTH,0),u.region.height=i._getNumber(l,e.DataParser.HEIGHT,0);var h=i._getNumber(l,e.DataParser.FRAME_WIDTH,-1),_=i._getNumber(l,e.DataParser.FRAME_HEIGHT,-1);h>0&&_>0&&(u.frame=e.TextureData.createRectangle(),u.frame.x=i._getNumber(l,e.DataParser.FRAME_X,0),u.frame.y=i._getNumber(l,e.DataParser.FRAME_Y,0),u.frame.width=h,u.frame.height=_),n.addTexture(u)}return!0},i.getInstance=function(){return null===i._objectDataParserInstance&&(i._objectDataParserInstance=new i),i._objectDataParserInstance},i._objectDataParserInstance=null,i}(e.DataParser);e.ObjectDataParser=t;var n=function(){this.frameStart=0,this.actions=[]};e.ActionFrame=n}(Xk||(Xk={})),function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return qk(n,t),n.prototype._inRange=function(e,t,n){return t<=e&&e<=n},n.prototype._decodeUTF8=function(e){for(var t,n=0,i="",r=0,a=0,o=0,s=0;e.length>n;){var c=e[n++];if(-1===c)t=0!==a?65533:-1;else if(0===a)this._inRange(c,0,127)?t=c:(this._inRange(c,194,223)?(a=1,s=128,r=c-192):this._inRange(c,224,239)?(a=2,s=2048,r=c-224):this._inRange(c,240,244)&&(a=3,s=65536,r=c-240),r*=Math.pow(64,a),t=null);else if(this._inRange(c,128,191))if(o+=1,r+=(c-128)*Math.pow(64,a-o),o!==a)t=null;else{var l=r,u=s;r=0,a=0,o=0,s=0,t=this._inRange(l,u,1114111)&&!this._inRange(l,55296,57343)?l:c}else r=0,a=0,o=0,s=0,n--,t=c;null!==t&&-1!==t&&(t<=65535?t>0&&(i+=String.fromCharCode(t)):(t-=65536,i+=String.fromCharCode(55296+(t>>10&1023)),i+=String.fromCharCode(56320+(1023&t))))}return i},n.prototype._getUTF16Key=function(e){for(var t=0,n=e.length;t<n;++t)if(e.charCodeAt(t)>255)return encodeURI(e);return e},n.prototype._parseBinaryTimeline=function(t,n,i){void 0===i&&(i=null);var r=null!==i?i:e.BaseObject.borrowObject(e.TimelineData);r.type=t,r.offset=n,this._timeline=r;var a=this._timelineArrayBuffer[r.offset+2];if(1===a)r.frameIndicesOffset=-1;else{var o=0,s=this._animation.frameCount+1,c=this._data.frameIndices;e.DragonBones.webAssembly?(o=c.size(),c.resize(o+s,0)):(o=c.length,c.length+=s),r.frameIndicesOffset=o;for(var l=0,u=0,h=0,_=0;l<s;++l)h+_<=l&&u<a&&(h=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[r.offset+5+u]],_=u===a-1?this._animation.frameCount-h:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[r.offset+5+u+1]]-h,u++),e.DragonBones.webAssembly?c.set(o+l,u-1):c[o+l]=u-1}return this._timeline=null,r},n.prototype._parseVertices=function(t,n){n.offset=t[e.DataParser.OFFSET];var i=this._intArrayBuffer[n.offset+3];if(i>=0){var r=e.BaseObject.borrowObject(e.WeightData),a=this._intArrayBuffer[n.offset+0],o=this._intArrayBuffer[i+0];r.offset=i;for(var s=0;s<o;++s){var c=this._intArrayBuffer[i+2+s];r.addBone(this._rawBones[c])}for(var l=i+2+o,u=0,h=(s=0,a);s<h;++s){var _=this._intArrayBuffer[l++];u+=_,l+=_}r.count=u,n.weight=r}},n.prototype._parseMesh=function(e,t){this._parseVertices(e,t.vertices)},n.prototype._parsePath=function(e,t){this._parseVertices(e,t.vertices)},n.prototype._parseAnimation=function(t){var n=e.BaseObject.borrowObject(e.AnimationData);n.frameCount=Math.max(e.ObjectDataParser._getNumber(t,e.DataParser.DURATION,1),1),n.playTimes=e.ObjectDataParser._getNumber(t,e.DataParser.PLAY_TIMES,1),n.duration=n.frameCount/this._armature.frameRate,n.fadeInTime=e.ObjectDataParser._getNumber(t,e.DataParser.FADE_IN_TIME,0),n.scale=e.ObjectDataParser._getNumber(t,e.DataParser.SCALE,1),n.name=e.ObjectDataParser._getString(t,e.DataParser.NAME,e.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=e.DataParser.DEFAULT_NAME);var i=t[e.DataParser.OFFSET];if(n.frameIntOffset=i[0],n.frameFloatOffset=i[1],n.frameOffset=i[2],this._animation=n,e.DataParser.ACTION in t&&(n.actionTimeline=this._parseBinaryTimeline(0,t[e.DataParser.ACTION])),e.DataParser.Z_ORDER in t&&(n.zOrderTimeline=this._parseBinaryTimeline(1,t[e.DataParser.Z_ORDER])),e.DataParser.BONE in t){var r=t[e.DataParser.BONE];for(var a in r){var o=r[a];e.DragonBones.webAssembly&&(a=this._getUTF16Key(a));var s=this._armature.getBone(a);if(null!==s)for(var c=0,l=o.length;c<l;c+=2){var u=o[c],h=o[c+1],_=this._parseBinaryTimeline(u,h);this._animation.addBoneTimeline(s,_)}}}if(e.DataParser.SURFACE in t)for(var a in r=t[e.DataParser.SURFACE]){o=r[a],e.DragonBones.webAssembly&&(a=this._getUTF16Key(a));var f=this._armature.getBone(a);if(null!==f)for(c=0,l=o.length;c<l;c+=2)u=o[c],h=o[c+1],_=this._parseBinaryTimeline(u,h),this._animation.addSurfaceTimeline(f,_)}if(e.DataParser.SLOT in t)for(var a in r=t[e.DataParser.SLOT]){o=r[a],e.DragonBones.webAssembly&&(a=this._getUTF16Key(a));var p=this._armature.getSlot(a);if(null!==p)for(c=0,l=o.length;c<l;c+=2)u=o[c],h=o[c+1],_=this._parseBinaryTimeline(u,h),this._animation.addSlotTimeline(p,_)}if(e.DataParser.CONSTRAINT in t)for(var a in r=t[e.DataParser.CONSTRAINT]){o=r[a],e.DragonBones.webAssembly&&(a=this._getUTF16Key(a));var d=this._armature.getConstraint(a);if(null!==d)for(c=0,l=o.length;c<l;c+=2)u=o[c],h=o[c+1],_=this._parseBinaryTimeline(u,h),this._animation.addConstraintTimeline(d,_)}if(e.DataParser.ANIMATION in t)for(var a in r=t[e.DataParser.ANIMATION])for(o=r[a],e.DragonBones.webAssembly&&(a=this._getUTF16Key(a)),c=0,l=o.length;c<l;c+=2)u=o[c],h=o[c+1],_=this._parseBinaryTimeline(u,h),this._animation.addAnimationTimeline(a,_);return this._animation=null,n},n.prototype._parseArray=function(t){var n=t[e.DataParser.OFFSET],i=n[1],r=n[3],a=n[5],o=n[7],s=n[9],c=n[11],l=new Int16Array(this._binary,this._binaryOffset+n[0],i/Int16Array.BYTES_PER_ELEMENT),u=new Float32Array(this._binary,this._binaryOffset+n[2],r/Float32Array.BYTES_PER_ELEMENT),h=new Int16Array(this._binary,this._binaryOffset+n[4],a/Int16Array.BYTES_PER_ELEMENT),_=new Float32Array(this._binary,this._binaryOffset+n[6],o/Float32Array.BYTES_PER_ELEMENT),f=new Int16Array(this._binary,this._binaryOffset+n[8],s/Int16Array.BYTES_PER_ELEMENT),p=new Uint16Array(this._binary,this._binaryOffset+n[10],c/Uint16Array.BYTES_PER_ELEMENT);if(e.DragonBones.webAssembly){for(var d=i+r+a+o+s+c,m=e.webAssemblyModule._malloc(d),v=new Uint8Array(this._binary,this._binaryOffset,d/Uint8Array.BYTES_PER_ELEMENT),g=new Uint8Array(e.webAssemblyModule.HEAP16.buffer,m,v.length),y=0,x=v.length;y<x;++y)g[y]=v[y];e.webAssemblyModule.setDataBinary(this._data,m,i,r,a,o,s,c),this._intArrayBuffer=l,this._floatArrayBuffer=u,this._frameIntArrayBuffer=h,this._frameFloatArrayBuffer=_,this._frameArrayBuffer=f,this._timelineArrayBuffer=p}else this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=l,this._data.floatArray=this._floatArrayBuffer=u,this._data.frameIntArray=this._frameIntArrayBuffer=h,this._data.frameFloatArray=this._frameFloatArrayBuffer=_,this._data.frameArray=this._frameArrayBuffer=f,this._data.timelineArray=this._timelineArrayBuffer=p},n.prototype.parseDragonBonesData=function(e,n){void 0===n&&(n=1),console.assert(null!=e&&e instanceof ArrayBuffer,"Data error.");var i=new Uint8Array(e,0,8);if(i[0]!=="D".charCodeAt(0)||i[1]!=="B".charCodeAt(0)||i[2]!=="D".charCodeAt(0)||i[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var r=new Uint32Array(e,8,1)[0],a=new Uint8Array(e,12,r),o=this._decodeUTF8(a),s=JSON.parse(o);return this._binaryOffset=12+r,this._binary=e,t.prototype.parseDragonBonesData.call(this,s,n)},n.getInstance=function(){return null===n._binaryDataParserInstance&&(n._binaryDataParserInstance=new n),n._binaryDataParserInstance},n._binaryDataParserInstance=null,n}(e.ObjectDataParser);e.BinaryDataParser=t}(Xk||(Xk={})),function(e){var t=function(){function t(n){void 0===n&&(n=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,this._dataParser=null,null===t._objectParser&&(t._objectParser=new e.ObjectDataParser),null===t._binaryParser&&(t._binaryParser=new e.BinaryDataParser),this._dataParser=null!==n?n:t._objectParser}return t.prototype._isSupportMesh=function(){return!0},t.prototype._getTextureData=function(e,t){if(e in this._textureAtlasDataMap)for(var n=0,i=this._textureAtlasDataMap[e];n<i.length;n++)if(null!==(c=(s=i[n]).getTexture(t)))return c;if(this.autoSearch)for(var r in this._textureAtlasDataMap)for(var a=0,o=this._textureAtlasDataMap[r];a<o.length;a++){var s,c;if((s=o[a]).autoSearch&&null!==(c=s.getTexture(t)))return c}return null},t.prototype._fillBuildArmaturePackage=function(e,t,n,i,r){var a=null,o=null;if(t.length>0&&t in this._dragonBonesDataMap&&(o=(a=this._dragonBonesDataMap[t]).getArmature(n)),null===o&&(0===t.length||this.autoSearch))for(var s in this._dragonBonesDataMap)if(a=this._dragonBonesDataMap[s],(0===t.length||a.autoSearch)&&null!==(o=a.getArmature(n))){t=s;break}if(null!==o){if(e.dataName=t,e.textureAtlasName=r,e.data=a,e.armature=o,e.skin=null,i.length>0&&(e.skin=o.getSkin(i),null===e.skin&&this.autoSearch))for(var s in this._dragonBonesDataMap){var c=this._dragonBonesDataMap[s].getArmature(i);if(null!==c){e.skin=c.defaultSkin;break}}return null===e.skin&&(e.skin=o.defaultSkin),!0}return!1},t.prototype._buildBones=function(t,n){for(var i=0,r=t.armature.sortedBones;i<r.length;i++){var a=r[i];e.BaseObject.borrowObject(0===a.type?e.Bone:e.Surface).init(a,n)}},t.prototype._buildSlots=function(t,n){var i=t.skin,r=t.armature.defaultSkin;if(null!==i&&null!==r){var a={};for(var o in r.displays){var s=r.getDisplays(o);a[o]=s}if(i!==r)for(var o in i.displays)s=i.getDisplays(o),a[o]=s;for(var c=0,l=t.armature.sortedSlots;c<l.length;c++){var u=l[c],h=u.name in a?a[u.name]:null,_=this._buildSlot(t,u,n);if(_.rawDisplayDatas=h,null!==h){for(var f=new Array,p=0,d=e.DragonBones.webAssembly?h.size():h.length;p<d;++p){var m=e.DragonBones.webAssembly?h.get(p):h[p];null!==m?f.push(this._getSlotDisplay(t,m,null,_)):f.push(null)}_._setDisplayList(f)}_._setDisplayIndex(u.displayIndex,!0)}}},t.prototype._buildConstraints=function(t,n){var i=t.armature.constraints;for(var r in i){var a=i[r];switch(a.type){case 0:var o=e.BaseObject.borrowObject(e.IKConstraint);o.init(a,n),n._addConstraint(o);break;case 1:var s=e.BaseObject.borrowObject(e.PathConstraint);s.init(a,n),n._addConstraint(s);break;default:var c=e.BaseObject.borrowObject(e.IKConstraint);c.init(a,n),n._addConstraint(c)}}},t.prototype._buildChildArmature=function(e,t,n){return this.buildArmature(n.path,null!==e?e.dataName:"","",null!==e?e.textureAtlasName:"")},t.prototype._getSlotDisplay=function(t,n,i,r){var a=null!==t?t.dataName:n.parent.parent.parent.name,o=null;switch(n.type){case 0:var s=n;null!==t&&t.textureAtlasName.length>0&&(s.texture=this._getTextureData(t.textureAtlasName,n.path)),null===s.texture&&(s.texture=this._getTextureData(a,n.path)),o=null!==i&&2===i.type&&this._isSupportMesh()?r.meshDisplay:r.rawDisplay;break;case 2:var c=n;null!==t&&t.textureAtlasName.length>0&&(c.texture=this._getTextureData(t.textureAtlasName,c.path)),null===c.texture&&(c.texture=this._getTextureData(a,c.path)),o=this._isSupportMesh()?r.meshDisplay:r.rawDisplay;break;case 1:var l=n,u=this._buildChildArmature(t,r,n);if(null!==u){if(u.inheritAnimation=l.inheritAnimation,!u.inheritAnimation){var h=l.actions.length>0?l.actions:u.armatureData.defaultActions;if(h.length>0)for(var _=0,f=h;_<f.length;_++){var p=f[_],d=e.BaseObject.borrowObject(e.EventObject);e.EventObject.actionDataToInstance(p,d,r.armature),d.slot=r,r.armature._bufferAction(d,!1)}else u.animation.play()}l.armature=u.armatureData}o=u}return o},t.prototype.parseDragonBonesData=function(e,n,i){void 0===n&&(n=null),void 0===i&&(i=1);for(var r=e instanceof ArrayBuffer?t._binaryParser:this._dataParser,a=r.parseDragonBonesData(e,i);;){var o=this._buildTextureAtlasData(null,null);if(!r.parseTextureAtlasData(null,o,i)){o.returnToPool();break}this.addTextureAtlasData(o,n)}return null!==a&&this.addDragonBonesData(a,n),a},t.prototype.parseTextureAtlasData=function(e,t,n,i){void 0===n&&(n=null),void 0===i&&(i=1);var r=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(e,r,i),this._buildTextureAtlasData(r,t||null),this.addTextureAtlasData(r,n),r},t.prototype.updateTextureAtlasData=function(e,t){var n=this.getTextureAtlasData(e);if(null!==n)for(var i=0,r=n.length;i<r;++i)i<t.length&&this._buildTextureAtlasData(n[i],t[i])},t.prototype.getDragonBonesData=function(e){return e in this._dragonBonesDataMap?this._dragonBonesDataMap[e]:null},t.prototype.addDragonBonesData=function(e,t){if(void 0===t&&(t=null),(t=null!==t?t:e.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[t]===e)return;console.warn("Can not add same name data: "+t)}else this._dragonBonesDataMap[t]=e},t.prototype.removeDragonBonesData=function(e,t){void 0===t&&(t=!0),e in this._dragonBonesDataMap&&(t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[e]),delete this._dragonBonesDataMap[e])},t.prototype.getTextureAtlasData=function(e){return e in this._textureAtlasDataMap?this._textureAtlasDataMap[e]:null},t.prototype.addTextureAtlasData=function(e,t){void 0===t&&(t=null);var n=(t=null!==t?t:e.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:this._textureAtlasDataMap[t]=[];n.indexOf(e)<0&&n.push(e)},t.prototype.removeTextureAtlasData=function(e,t){if(void 0===t&&(t=!0),e in this._textureAtlasDataMap){var n=this._textureAtlasDataMap[e];if(t)for(var i=0,r=n;i<r.length;i++){var a=r[i];this._dragonBones.bufferObject(a)}delete this._textureAtlasDataMap[e]}},t.prototype.getArmatureData=function(e,t){void 0===t&&(t="");var i=new n;return this._fillBuildArmaturePackage(i,t,e,"","")?i.armature:null},t.prototype.clear=function(e){for(var t in void 0===e&&(e=!0),this._dragonBonesDataMap)e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t];for(var t in this._textureAtlasDataMap){if(e)for(var n=0,i=this._textureAtlasDataMap[t];n<i.length;n++){var r=i[n];this._dragonBones.bufferObject(r)}delete this._textureAtlasDataMap[t]}},t.prototype.buildArmature=function(e,t,i,r){void 0===t&&(t=""),void 0===i&&(i=""),void 0===r&&(r="");var a=new n;if(!this._fillBuildArmaturePackage(a,t||"",e,i||"",r||""))return console.warn("No armature data: "+e+", "+(null!==t?t:"")),null;var o=this._buildArmature(a);return this._buildBones(a,o),this._buildSlots(a,o),this._buildConstraints(a,o),o.invalidUpdate(null,!0),o.advanceTime(0),o},t.prototype.replaceDisplay=function(t,n,i){void 0===i&&(i=-1),i<0&&(i=t.displayIndex),i<0&&(i=0),t.replaceDisplayData(n,i);var r=t.displayList;if(r.length<=i){r.length=i+1;for(var a=0,o=r.length;a<o;++a)r[a]||(r[a]=null)}if(null!==n){var s=t.rawDisplayDatas,c=null;s&&(e.DragonBones.webAssembly?i<s.size()&&(c=s.get(i)):i<s.length&&(c=s[i])),r[i]=this._getSlotDisplay(null,n,c,t)}else r[i]=null;t.displayList=r},t.prototype.replaceSlotDisplay=function(e,t,n,i,r,a){void 0===a&&(a=-1);var o=this.getArmatureData(t,e||"");if(!o||!o.defaultSkin)return!1;var s=o.defaultSkin.getDisplay(n,i);return!!s&&(this.replaceDisplay(r,s,a),!0)},t.prototype.replaceSlotDisplayList=function(t,n,i,r){var a=this.getArmatureData(n,t||"");if(!a||!a.defaultSkin)return!1;var o=a.defaultSkin.getDisplays(i);if(!o)return!1;for(var s=0,c=0,l=e.DragonBones.webAssembly?o.size():o.length;c<l;++c){var u=e.DragonBones.webAssembly?o.get(c):o[c];this.replaceDisplay(r,u,s++)}return!0},t.prototype.replaceSkin=function(t,n,i,r){void 0===i&&(i=!1),void 0===r&&(r=null);for(var a=!1,o=n.parent.defaultSkin,s=0,c=t.getSlots();s<c.length;s++){var l=c[s];if(!(null!==r&&r.indexOf(l.name)>=0)){var u=n.getDisplays(l.name);if(u||(null!==o&&n!==o&&(u=o.getDisplays(l.name)),u)){var h=e.DragonBones.webAssembly?u.size():u.length,_=l.displayList;_.length=h;for(var f=0,p=h;f<p;++f){var d=e.DragonBones.webAssembly?u.get(f):u[f];_[f]=null!==d?this._getSlotDisplay(null,d,null,l):null}a=!0,l.rawDisplayDatas=u,l.displayList=_}else i&&(l.rawDisplayDatas=null,l.displayList=[])}}return a},t.prototype.replaceAnimation=function(t,n,i){void 0===i&&(i=!0);var r=n.defaultSkin;if(null===r)return!1;if(i)t.animation.animations=n.animations;else{var a=t.animation.animations,o={};for(var s in a)o[s]=a[s];for(var s in n.animations)o[s]=n.animations[s];t.animation.animations=o}for(var c=0,l=t.getSlots();c<l.length;c++)for(var u=l[c],h=0,_=0,f=u.displayList;_<f.length;_++){var p=f[_];if(p instanceof e.Armature){var d=r.getDisplays(u.name);if(null!==d&&h<(e.DragonBones.webAssembly?d.size():d.length)){var m=e.DragonBones.webAssembly?d.get(h):d[h];if(null!==m&&1===m.type){var v=this.getArmatureData(m.path,m.parent.parent.parent.name);v&&this.replaceAnimation(p,v,i)}}}h++}return!0},t.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},t.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(t.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),t.prototype.changeSkin=function(e,t,n){return void 0===n&&(n=null),this.replaceSkin(e,t,!1,n)},t.prototype.copyAnimationsToArmature=function(e,t,n,i,r){void 0===i&&(i=""),void 0===r&&(r=!0);var a=this.getArmatureData(t,i);return!!a&&this.replaceAnimation(e,a,r)},t._objectParser=null,t._binaryParser=null,t}();e.BaseFactory=t;var n=function(){this.dataName="",this.textureAtlasName="",this.skin=null};e.BuildArmaturePackage=n}(Xk||(Xk={})),function(e){e.BinaryOffset={WeigthBoneCount:0,WeigthFloatOffset:1,WeigthBoneIndices:2,MeshVertexCount:0,MeshTriangleCount:1,MeshFloatOffset:2,MeshWeightOffset:3,MeshVertexIndices:4,TimelineScale:0,TimelineOffset:1,TimelineKeyFrameCount:2,TimelineFrameValueCount:3,TimelineFrameValueOffset:4,TimelineFrameOffset:5,FramePosition:0,FrameTweenType:1,FrameTweenEasingOrCurveSampleCount:2,FrameCurveSamples:3,DeformMeshOffset:0,DeformCount:1,DeformValueCount:2,DeformValueOffset:3,DeformFloatOffset:4},e.ArmatureType={Armature:0,MovieClip:1,Stage:2},e.BoneType={Bone:0,Surface:1},e.DisplayType={Image:0,Armature:1,Mesh:2,BoundingBox:3},e.BoundingBoxType={Rectangle:0,Ellipse:1,Polygon:2},e.ActionType={Play:0,Stop:1,GotoAndPlay:2,GotoAndStop:3,FadeIn:4,FadeOut:5,Frame:10,Sound:11},e.BlendMode={Normal:0,Add:1,Alpha:2,Darken:3,Difference:4,Erase:5,HardLight:6,Invert:7,Layer:8,Lighten:9,Multiply:10,Overlay:11,Screen:12,Subtract:13},e.TweenType={None:0,Line:1,Curve:2,QuadIn:3,QuadOut:4,QuadInOut:5},e.TimelineType={Action:0,ZOrder:1,BoneAll:10,BoneTranslate:11,BoneRotate:12,BoneScale:13,Surface:50,SlotDisplay:20,SlotColor:21,SlotFFD:22,IKConstraint:30,AnimationTime:40,AnimationWeight:41}}(Xk||(Xk={}));var Yk=Xk.DragonBones,Kk=Xk.BaseObject,Qk=Xk.Matrix,Zk=Xk.Transform,Jk=Xk.ColorTransform,$k=Xk.Point,eH=Xk.Rectangle,tH=Xk.UserData,nH=Xk.ActionData,iH=Xk.DragonBonesData,rH=Xk.ArmatureData,aH=Xk.BoneData,oH=Xk.SurfaceData,sH=Xk.SlotData,cH=Xk.ConstraintData,lH=Xk.IKConstraintData,uH=Xk.PathConstraintData,hH=Xk.CanvasData,_H=Xk.SkinData,fH=Xk.VerticesData,pH=Xk.DisplayData,dH=Xk.ImageDisplayData,mH=Xk.ArmatureDisplayData,vH=Xk.MeshDisplayData,gH=Xk.BoundingBoxDisplayData,yH=Xk.PathDisplayData,xH=Xk.WeightData,SH=Xk.BoundingBoxData,TH=Xk.RectangleBoundingBoxData,EH=Xk.EllipseBoundingBoxData,AH=Xk.PolygonBoundingBoxData,CH=Xk.AnimationData,bH=Xk.TimelineData,PH=Xk.AnimationConfig,RH=Xk.TextureAtlasData,IH=Xk.TextureData,wH=Xk.DeformVertices,DH=Xk.Armature,OH=Xk.TransformObject,MH=Xk.Bone,NH=Xk.Surface,BH=Xk.Slot,FH=Xk.Constraint,LH=Xk.IKConstraint,zH=Xk.PathConstraint,UH=Xk.WorldClock,GH=Xk.Animation,kH=Xk.AnimationState,HH=Xk.BonePose,VH=Xk.BlendState,jH=Xk.TimelineState,WH=Xk.TweenTimelineState,qH=Xk.BoneTimelineState,XH=Xk.SlotTimelineState,YH=Xk.ConstraintTimelineState,KH=Xk.ActionTimelineState,QH=Xk.ZOrderTimelineState,ZH=Xk.BoneAllTimelineState,JH=Xk.BoneTranslateTimelineState,$H=Xk.BoneRotateTimelineState,eV=Xk.BoneScaleTimelineState,tV=Xk.SurfaceTimelineState,nV=Xk.SlotDislayTimelineState,iV=Xk.SlotColorTimelineState,rV=Xk.DeformTimelineState,aV=Xk.IKConstraintTimelineState,oV=Xk.AnimationTimelineState,sV=Xk.EventObject,cV=Xk.DataParser,lV=Xk.ObjectDataParser,uV=Xk.ActionFrame,hV=Xk.BinaryDataParser,_V=Xk.BaseFactory,fV=Xk.BuildArmaturePackage,pV=Xk.BinaryOffset,dV=Xk.ArmatureType,mV=Xk.BoneType,vV=Xk.DisplayType,gV=Xk.BoundingBoxType,yV=Xk.ActionType,xV=Xk.BlendMode,SV=Xk.TweenType,TV=Xk.TimelineType,EV=new di,AV=new wi;function CV(e,t,n,i){var r=n.chunk,a=n.data,o=r.vb,s=n.vertexCount;e.getWorldMatrix(AV);for(var c=0,l=0;l<s;l++){var u=a[l];di.set(EV,u.x,u.y,0),di.transformMat4(EV,EV,AV),o[c++]=EV.x,o[c++]=EV.y,o[c++]=EV.z,fi.toArray(o,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),p=r.vertexAccessor.getIndexBuffer(h),d=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var bV=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new PV;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,r=this._innerTextureInfos[n.getId()],a=t.x,o=t.y;if(r)a+=r.x,o+=r.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,a+=this._x,o+=this._y,this._x+=s+2}var l={x:a,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),l},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),PV=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=em.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new ma;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}},t}(tv),RV=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new bV(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==nm.LINEAR||t.magFilter!==nm.LINEAR||t.mipFilter!==nm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],ke.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();RV.instance=void 0;var IV,wV,DV,OV=RV.instance=new RV;i.internal.dynamicAtlasManager=OV;var MV,NV,BV,FV,LV=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],zV=nl("cc.SpriteFrame")((DV=wV=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new Vi,t._offset=new Ni,t._originalSize=new ki,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}L(t,e),t.createWithImage=function(e){var n=e instanceof wm?e:new wm(e),i=new tv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(b(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(b(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&OV&&OV.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,a=this._capInsets[0],o=this._capInsets[2],s=e.width-a-o,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){LV[0].u=e.x/i,LV[1].u=(e.x+l)/i,LV[2].u=(e.x+l+u)/i,LV[3].u=(e.x+e.height)/i,LV[3].v=e.y/r,LV[2].v=(e.y+a)/r,LV[1].v=(e.y+a+s)/r,LV[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=LV[_],p=0;p<4;++p){var d=LV[3-p];h.push({u:f.u,v:d.v})}}else{LV[0].u=e.x/i,LV[1].u=(e.x+a)/i,LV[2].u=(e.x+a+s)/i,LV[3].u=(e.x+e.width)/i,LV[3].v=e.y/r,LV[2].v=(e.y+c)/r,LV[1].v=(e.y+c+u)/r,LV[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=LV[m],g=0;g<4;++g){var y=LV[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,a=i.height;if(this._rotated){var o=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===a?0:e.y/a,l=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=o,t[5]=l,t[6]=o,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=o,t[5]=c,t[6]=o,t[7]=l):this._isFlipUVY?(t[0]=o,t[1]=l,t[2]=o,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=o,t[1]=c,t[2]=o,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===a?0:e.y/a,f=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var p=0===r?0:e.x/r,d=0===r?1:(e.x+e.width)/r,m=0===a?1:(e.y+e.height)/a,v=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):this._isFlipUVX?(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v):this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===a?1:(e.y+e.height)/a,S=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var T=this.vertices;if(T){T.nu.length=0,T.nv.length=0;for(var E=0;E<T.u.length;E++)T.nu[E]=T.u[E]/r,T.nv[E]=T.v[E]/a}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=OV;if(e){var t=this._texture;if(t instanceof tv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new Vi(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Ni(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new ki(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var a=t.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,a,o,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(a=l.uv).splice.apply(a,[0,l.uv.length].concat(this.uv)),(o=l.unbiasUV).splice.apply(o,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new Vi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ki(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new tv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},B(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Du),wV.EVENT_UV_UPDATED="uv_updated",IV=DV))||IV;i.SpriteFrame=zV;var UV,GV=nl("cc.SpriteAtlas")((FV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",BV,V(t)),t}L(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=_e();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],ze(zV))},t}(Du),BV=X((NV=FV).prototype,"spriteFrames",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _e()}}),MV=NV))||MV;i.SpriteAtlas=GV;var kV,HV,VV,jV,WV=nl("cc.Font")(UV=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(Du))||UV;i.Font=WV;var qV,XV,YV,KV,QV,ZV,JV,$V,ej,tj=nl("cc.TTFFont")((jV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",VV,V(t)),t}return L(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},B(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:gn(this._native),__isNative__:!0}}}]),t}(WV),VV=X((HV=jV).prototype,"_fontFamily",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(HV.prototype,"_nativeAsset",[Wl,Nl],Object.getOwnPropertyDescriptor(HV.prototype,"_nativeAsset"),HV.prototype),X(HV.prototype,"_nativeDep",[Wl],Object.getOwnPropertyDescriptor(HV.prototype,"_nativeDep"),HV.prototype),kV=HV))||kV;i.TTFFont=tj;var nj,ij=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},rj=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new ij;Ee(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),aj=(qV=nl("cc.BitmapFont"),XV=Bl(zV),qV((ej=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",QV,V(t)),q(t,"spriteFrame",ZV,V(t)),q(t,"fontSize",JV,V(t)),q(t,"fntConfig",$V,V(t)),t}return L(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new rj(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new ij,a=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=a.width,r.h=a.height,r.u=a.x,r.v=a.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else p("The fnt config is not exists!")},t}(WV),QV=X((KV=ej).prototype,"fntDataStr",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZV=X(KV.prototype,"spriteFrame",[XV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JV=X(KV.prototype,"fontSize",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$V=X(KV.prototype,"fntConfig",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YV=KV))||YV);i.BitmapFont=aj;var oj=nl("cc.LabelAtlas")(nj=function(e){function t(){return e.apply(this,arguments)||this}return L(t,e),t}(aj))||nj;i.LabelAtlas=oj;var sj=.26,cj=new Ue(2);cj.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var lj,uj=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=cj.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,cj.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),hj=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,_j=/^[!,.:;'}\]%\?>、‘“》？。，！]/,fj=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,pj=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,dj=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function mj(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function vj(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function gj(e,t,n){var i=(n||e.font)+"🎮"+t,r=uj.get(i);if(null!==r)return r;var a=e.measureText(t),o=a&&a.width||0;return uj.put(i,o),o}function yj(e,t,n){var i=t,r=n,a=e[t];if(a>="\udc00"&&a<="\udfff"&&i--,void 0!==n)if(n-1!==t){var o=e[n-1];o>="\ud800"&&o<="\udbff"&&r--}else a>="\ud800"&&a<="\udbff"&&r++;return e.substring(i,r)}function xj(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var a=e;t>n&&a.length>1;){for(var o=a.length*(n/t)|0,s=yj(a,o),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)o*=n/c,c=t-i(s=yj(a,o|=0));for(h=0;c<=n&&h++<10;){if(s){var _=hj.exec(s);u=_?_[0].length:1,l=s}c=t-i(s=yj(a,o+=u))}0==(o-=u)?(o=1,l=yj(a,1)):1===o&&a[0]>="\ud800"&&a[0]<="\udbff"&&(o=2,l=yj(a,2));var f=yj(a,0,o),p=void 0;_j.test(l||s)&&(0==(o-=(p=fj.exec(f))?p[0].length:0)&&(o=1),l=yj(a,o),f=yj(a,0,o)),dj.test(l)&&(p=pj.exec(f))&&f!==p[0]&&(l=yj(a,o-=p[0].length),f=yj(a,0,o)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(a=l||s)}return(0===r.length||(a=a.trim()).length>0)&&r.push(a),r}var Sj=function(){function e(){this.pool=[]}e.getInstance=function(){return lj||(lj=new e),lj};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=$e.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}(),Tj=fi.WHITE.clone(),Ej=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},Aj="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",Cj=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=Sj.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=gj(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=1.26*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*sj/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new wm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=Aj,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,a=n/2,o=i/2+.37*r+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||Tj;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,a,o)}e.fillText(this.char,a,o)}},e}(),bj=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=em.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new ma;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}},t}(tv),Pj=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new bj;n.initWithSize(e,t),this.fontDefDictionary=new rj(n),this._halfBleed=1,this._width=e,this._height=t,VM.on(HM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=VM.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return A(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new Ej;return a.u=this._x+this._halfBleed,a.v=this._y+this._halfBleed,a.texture=this.fontDefDictionary.texture,a.valid=!0,a.w=e.width-2,a.h=e.height-2,a.xAdvance=a.w,a.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,a),a},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new bj;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new Cj(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},B(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),Rj={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:fi.WHITE.clone(),isOutlined:!1,out:fi.WHITE.clone(),margin:0},Ij=[new Ua(oa.ATTR_POSITION,Sr.RGB32F)],wj=[new Ua(oa.ATTR_POSITION,Sr.RGB32F),new Ua(oa.ATTR_COLOR,Sr.RGBA32F)],Dj=[new Ua(oa.ATTR_POSITION,Sr.RGB32F),new Ua(oa.ATTR_TEX_COORD,Sr.RG32F),new Ua(oa.ATTR_COLOR,Sr.RGBA32F)],Oj=[new Ua(oa.ATTR_POSITION,Sr.RGB32F),new Ua(oa.ATTR_TEX_COORD,Sr.RG32F),new Ua(oa.ATTR_COLOR,Sr.RGBA32F),new Ua(oa.ATTR_COLOR2,Sr.RGBA32F)];function Mj(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=lo[i.format].count}return t}function Nj(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=lo[i.format].size}return t}i.internal.vfmtPosUvColor=Dj,i.internal.vfmtPosUvTwoColor=Oj;var Bj,Fj,Lj,zj,Uj,Gj,kj,Hj,Vj,jj,Wj,qj,Xj,Yj,Kj,Qj=Nj(Dj)>>2,Zj=new je((function(){return{x:0,y:0,z:0,u:0,v:0,color:fi.WHITE.clone()}}),128),Jj=null,$j=function(){function e(e){void 0===e&&(e=Dj),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=Dj,this._floatStride=e===Dj?Qj:Nj(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},B(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}(),eW=function(e){function t(t,n){var i;return void 0===t&&(t=Dj),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=VM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}L(t,e),t.add=function(e,n){void 0===e&&(e=Dj),Jj||(Jj=new We((function(){return new t}),32));var i=Jj.add();return i._floatStride=e===Dj?Qj:Nj(e)>>2,i._vertexFormat=e,n||(n=VM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=Jj.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,Jj.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Ro(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},B(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)Zj.free(t[i]);for(i=n;i<e;i++)t[i]=Zj.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}($j),tW=function(e){function t(t){var n;return void 0===t&&(t=Dj),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}L(t,e),t.add=function(e){void 0===e&&(e=Dj);var t=nW.add();return t._floatStride=e===Dj?Qj:Nj(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=nW.data.indexOf(e);-1!==t&&(nW.data[t].clear(),nW.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,o=this.vData.length,s=this.iData.length;if(n>r||i>a){for(;r<n||a<i;)r=4*(o*=2),a=s*=2;this._reallocBuffer(o,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,r,r))),this._iaInfo=new ka(this._vertexFormat,i,this._indexBuffer),this._iaPool=new We((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},B(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}($j),nW=new We((function(){return new tW}),32),iW=new Ni,rW=new Ni,aW=(new di,new wi),oW=new wi,sW=new wi,cW=new wi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),lW=new Vi,uW=(Bj=nl("cc.UITransform"),Fj=gl(),Lj=rl(110),zj=pl(),Uj=Rl(),Gj=El(),kj=Rl(),Hj=El(),Bj(Vj=Fj(Vj=Lj(Vj=zj(Vj=al(Vj=fl((Yj=Xj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,q(t,"_contentSize",Wj,V(t)),q(t,"_anchorPoint",qj,V(t)),t}L(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(jE.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(jE.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(jE.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(jE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=iW,a=rW,o=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(aW);var u=aW.m12,h=aW.m13,_=qM.center;if(aW.m12=_.x-(aW.m00*u+aW.m04*h),aW.m13=_.y-(aW.m01*u+aW.m05*h),wi.invert(aW,aW),Ni.transformMat4(r,e,aW),this.node.getWorldMatrix(sW),wi.invert(aW,sW),!wi.strictEquals(aW,cW)){Ni.transformMat4(a,r,aW),a.x+=this._anchorPoint.x*n,a.y+=this._anchorPoint.y*i;var f=!1;if(a.x>=0&&a.y>=0&&a.x<=n&&a.y<=i&&(f=!0,o&&o.maskList))for(var p=o.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){p.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(sW),wi.invert(aW,sW),t||(t=new di),di.transformMat4(t,e,aW)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(sW),t||(t=new di),di.transformMat4(t,e,sW)},n.getBoundingBox=function(){wi.fromRTS(oW,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new Vi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(oW),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(sW),this.getBoundingBoxTo(sW)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){wi.fromRTS(oW,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Vi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(wi.multiply(sW,e,oW),r.transformMat4(sW),!this.node.children)return r;for(var a,o=W(this.node.children);!(a=o()).done;){var s=a.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&Vi.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;lW.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),lW.transformMat4(this.node.worldMatrix);var i=lW.x+.5*lW.width,r=lW.y+.5*lW.height,a=this.node.worldPosition.z,o=lW.width/2,s=lW.height/2;return null!=e?(Mc.set(e,i,r,a,o,s,.001),e):new Mc(i,r,a,o,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},B(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(jE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(jE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(jE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(jE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(jE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(jE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?A(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=VM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=VM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(Ju),Xj.EventType=jE,Xj.priorityChangeNodeMap=new Map,X((jj=Yj).prototype,"contentSize",[Uj,Gj],Object.getOwnPropertyDescriptor(jj.prototype,"contentSize"),jj.prototype),X(jj.prototype,"anchorPoint",[kj,Hj],Object.getOwnPropertyDescriptor(jj.prototype,"anchorPoint"),jj.prototype),Wj=X(jj.prototype,"_contentSize",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(100,100)}}),qj=X(jj.prototype,"_anchorPoint",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(.5,.5)}}),Vj=jj))||Vj)||Vj)||Vj)||Vj)||Vj)||Vj);VM.on(HM.EVENT_AFTER_UPDATE,uW._sortSiblings),VM.on(HM.EVENT_BEFORE_SCENE_LAUNCH,uW._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(Kj||(Kj={}));var hW,_W,fW,pW,dW,mW,vW,gW,yW,xW,SW,TW,EW,AW,CW,bW,PW,RW,IW,wW,DW=function(){function e(){this.stage=Kj.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Br.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Fr.KEEP,zFailOp:Fr.KEEP,passOp:Fr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?Kj.CLEAR_INVERTED:Kj.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?Kj.ENTER_LEVEL_INVERTED:Kj.ENTER_LEVEL},t.enableMask=function(){this.stage=Kj.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=Kj.DISABLED:this.stage=Kj.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=Kj.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,a=Br.LESS,o=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,a=s.depthFunc,o=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(o&&o.has(n))return o.get(n);this.setStateFromStage(e);var u=new No(i,r,a,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===Kj.DISABLED?(t.stencilTest=!1,t.func=Br.ALWAYS,t.failOp=Fr.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===Kj.ENABLED?(t.func=Br.EQUAL,t.failOp=Fr.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===Kj.CLEAR?(t.func=Br.NEVER,t.failOp=Fr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===Kj.CLEAR_INVERTED||e===Kj.ENTER_LEVEL?(t.func=Br.NEVER,t.failOp=Fr.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===Kj.ENTER_LEVEL_INVERTED&&(t.func=Br.NEVER,t.failOp=Fr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},B(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}();DW.sharedManager=null,DW.sharedManager=new DW,Ze(Lr),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(wW||(wW={}));var OW,MW,NW,BW,FW,LW,zW,UW,GW,kW,HW,VW,jW,WW,qW,XW,YW,KW,QW,ZW,JW,$W,eq,tq,nq,iq,rq,aq,oq,sq,cq,lq,uq,hq,_q,fq,pq,dq,mq,vq,gq,yq,xq,Sq,Tq,Eq,Aq,Cq,bq,Pq,Rq,Iq,wq,Dq,Oq,Mq,Nq,Bq,Fq,Lq,zq,Uq,Gq,kq,Hq,Vq,jq,Wq,qq,Xq,Yq=(hW=nl("cc.Renderable2D"),_W=il(uW),fW=xl(),pW=Bl(Cg),dW=Bl(Cg),mW=Rl(),vW=El(),gW=Tl(),yW=Rl(),xW=El(),hW(SW=_W(SW=al(SW=fl((IW=RW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_materials",EW,V(t)),q(t,"_customMaterial",AW,V(t)),t.stencilStage=Kj.DISABLED,q(t,"_srcBlendFactor",CW,V(t)),q(t,"_dstBlendFactor",bW,V(t)),q(t,"_color",PW,V(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new Fo,t._blendHash=0,t._lastParent=null,t}L(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(jE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(jE.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(jE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(jE.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=eW.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(eW.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Bo,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Lr.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case wW.ADD_COLOR:e=Nv.get("ui-base-material");break;case wW.GRAYSCALE:e=Nv.get("ui-sprite-gray-material");break;case wW.USE_ALPHA_SEPARATED:e=Nv.get("ui-sprite-alpha-sep-material");break;case wW.USE_ALPHA_SEPARATED_AND_GRAY:e=Nv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Nv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},B(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&A(12001),this._srcBlendFactor},set:function(e){this._customMaterial?A(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&A(12001),this._dstBlendFactor},set:function(e){this._customMaterial?A(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),t}(fL),RW.BlendState=Lr,RW.Assembler=null,RW.PostAssembler=null,EW=X((TW=IW).prototype,"_materials",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(TW.prototype,"sharedMaterials",[Wl,fW],Object.getOwnPropertyDescriptor(TW.prototype,"sharedMaterials"),TW.prototype),AW=X(TW.prototype,"_customMaterial",[pW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(TW.prototype,"customMaterial",[dW,mW,vW,gW],Object.getOwnPropertyDescriptor(TW.prototype,"customMaterial"),TW.prototype),X(TW.prototype,"color",[yW,xW],Object.getOwnPropertyDescriptor(TW.prototype,"color"),TW.prototype),CW=X(TW.prototype,"_srcBlendFactor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lr.SRC_ALPHA}}),bW=X(TW.prototype,"_dstBlendFactor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lr.ONE_MINUS_SRC_ALPHA}}),PW=X(TW.prototype,"_color",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.WHITE.clone()}}),SW=TW))||SW)||SW)||SW)||SW);i.internal.Renderable2D=Yq,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(jq||(jq={})),Ze(jq),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(Wq||(Wq={})),Ze(Wq),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(qq||(qq={})),Ze(qq),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(Xq||(Xq={})),Ze(Xq);var Kq,Qq,Zq,Jq=(OW=nl("cc.Label"),MW=gl(),NW=rl(110),BW=pl(),FW=Rl(),LW=El(),zW=Bl(jq),UW=Rl(),GW=El(),kW=Bl(Wq),HW=Rl(),VW=El(),jW=Rl(),WW=El(),qW=Rl(),XW=xl(),YW=El(),KW=Rl(),QW=El(),ZW=xl(),JW=Rl(),$W=El(),eq=Bl(qq),tq=Rl(),nq=El(),iq=Rl(),rq=El(),aq=Bl(WV),oq=Rl(),sq=xl(),cq=El(),lq=Rl(),uq=El(),hq=Bl(Xq),_q=Rl(),fq=El(),pq=Rl(),dq=El(),mq=Rl(),vq=El(),gq=Rl(),yq=El(),xq=xl(),Sq=Rl(),Tq=El(),OW(Eq=MW(Eq=NW(Eq=BW((Vq=Hq=function(e){function t(){var t;return q(t=e.call(this)||this,"_string",Cq,V(t)),q(t,"_horizontalAlign",bq,V(t)),q(t,"_verticalAlign",Pq,V(t)),q(t,"_actualFontSize",Rq,V(t)),q(t,"_fontSize",Iq,V(t)),q(t,"_fontFamily",wq,V(t)),q(t,"_lineHeight",Dq,V(t)),q(t,"_overflow",Oq,V(t)),q(t,"_enableWrapText",Mq,V(t)),q(t,"_font",Nq,V(t)),q(t,"_isSystemFontUsed",Bq,V(t)),q(t,"_spacingX",Fq,V(t)),q(t,"_isItalic",Lq,V(t)),q(t,"_isBold",zq,V(t)),q(t,"_isUnderline",Uq,V(t)),q(t,"_underlineHeight",Gq,V(t)),q(t,"_cacheMode",kq,V(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}L(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof aj){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof aj){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===Xq.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new zV,this._assemblerData=this._assembler.getAssemblerData();var n=new wm(this._assemblerData.canvas),i=new tv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==Xq.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==Xq.CHAR){var t=this._texture.texture;if(t instanceof Om){var n=t.getPixelFormat();e=n===em.RGBA_ETC1||n===em.RGB_A_PVRTC_4BPPV1||n===em.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?wW.USE_ALPHA_SEPARATED:wW.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},B(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==Xq.BITMAP||this._font instanceof aj||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===Xq.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof aj?this._font.fontSize:-1}}]),t}(Yq),Hq.HorizontalAlign=jq,Hq.VerticalAlign=Wq,Hq.Overflow=qq,Hq.CacheMode=Xq,Hq._canvasPool=Sj.getInstance(),X((Aq=Vq).prototype,"string",[FW,LW,Il],Object.getOwnPropertyDescriptor(Aq.prototype,"string"),Aq.prototype),X(Aq.prototype,"horizontalAlign",[zW,UW,GW],Object.getOwnPropertyDescriptor(Aq.prototype,"horizontalAlign"),Aq.prototype),X(Aq.prototype,"verticalAlign",[kW,HW,VW],Object.getOwnPropertyDescriptor(Aq.prototype,"verticalAlign"),Aq.prototype),X(Aq.prototype,"fontSize",[jW,WW],Object.getOwnPropertyDescriptor(Aq.prototype,"fontSize"),Aq.prototype),X(Aq.prototype,"fontFamily",[qW,XW,YW],Object.getOwnPropertyDescriptor(Aq.prototype,"fontFamily"),Aq.prototype),X(Aq.prototype,"lineHeight",[KW,QW],Object.getOwnPropertyDescriptor(Aq.prototype,"lineHeight"),Aq.prototype),X(Aq.prototype,"spacingX",[ZW,JW,$W],Object.getOwnPropertyDescriptor(Aq.prototype,"spacingX"),Aq.prototype),X(Aq.prototype,"overflow",[eq,tq,nq],Object.getOwnPropertyDescriptor(Aq.prototype,"overflow"),Aq.prototype),X(Aq.prototype,"enableWrapText",[iq,rq],Object.getOwnPropertyDescriptor(Aq.prototype,"enableWrapText"),Aq.prototype),X(Aq.prototype,"font",[aq,oq,sq,cq],Object.getOwnPropertyDescriptor(Aq.prototype,"font"),Aq.prototype),X(Aq.prototype,"useSystemFont",[lq,uq],Object.getOwnPropertyDescriptor(Aq.prototype,"useSystemFont"),Aq.prototype),X(Aq.prototype,"cacheMode",[hq,_q,fq],Object.getOwnPropertyDescriptor(Aq.prototype,"cacheMode"),Aq.prototype),X(Aq.prototype,"isBold",[pq,dq],Object.getOwnPropertyDescriptor(Aq.prototype,"isBold"),Aq.prototype),X(Aq.prototype,"isItalic",[mq,vq],Object.getOwnPropertyDescriptor(Aq.prototype,"isItalic"),Aq.prototype),X(Aq.prototype,"isUnderline",[gq,yq],Object.getOwnPropertyDescriptor(Aq.prototype,"isUnderline"),Aq.prototype),X(Aq.prototype,"underlineHeight",[xq,yl,Sq,Tq],Object.getOwnPropertyDescriptor(Aq.prototype,"underlineHeight"),Aq.prototype),Cq=X(Aq.prototype,"_string",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),bq=X(Aq.prototype,"_horizontalAlign",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jq.CENTER}}),Pq=X(Aq.prototype,"_verticalAlign",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wq.CENTER}}),Rq=X(Aq.prototype,"_actualFontSize",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Iq=X(Aq.prototype,"_fontSize",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),wq=X(Aq.prototype,"_fontFamily",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Dq=X(Aq.prototype,"_lineHeight",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Oq=X(Aq.prototype,"_overflow",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qq.NONE}}),Mq=X(Aq.prototype,"_enableWrapText",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nq=X(Aq.prototype,"_font",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bq=X(Aq.prototype,"_isSystemFontUsed",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fq=X(Aq.prototype,"_spacingX",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lq=X(Aq.prototype,"_isItalic",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zq=X(Aq.prototype,"_isBold",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uq=X(Aq.prototype,"_isUnderline",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gq=X(Aq.prototype,"_underlineHeight",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),kq=X(Aq.prototype,"_cacheMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xq.NONE}}),Eq=Aq))||Eq)||Eq)||Eq)||Eq);i.Label=Jq,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(Kq||(Kq={})),Ze(Kq),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(Qq||(Qq={})),Ze(Qq),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(Zq||(Zq={})),Ze(Zq);var $q=Math.PI,eX=Math.min,tX=Math.max,nX=Math.cos,iX=Math.sin,rX=Math.abs,aX=Math.sign,oX=.5522847493;function sX(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*oX,t-i*oX,n+r,t,n+r),e.bezierCurveTo(t+i*oX,n+r,t+i,n+r*oX,t+i,n),e.bezierCurveTo(t+i,n-r*oX,t+i*oX,n-r,t,n-r),e.bezierCurveTo(t-i*oX,n-r,t-i,n-r*oX,t-i,n),e.close()}function cX(e,t,n,i,r,a,o,s,c,l,u){var h,_,f,p,d,m,v,g,y,x,S,T,E,A,C,b;l>10||(d=.5*(a+s),m=.5*(o+c),v=.5*((h=.5*(t+i))+(f=.5*(i+a))),g=.5*((_=.5*(n+r))+(p=.5*(r+o))),((C=rX((i-s)*(A=c-n)-(r-c)*(E=s-t)))+(b=rX((a-s)*A-(o-c)*E)))*(C+b)<e.tessTol*(E*E+A*A)?e.addPoint(s,c,0===u?u|Zq.PT_BEVEL:u):(cX(e,t,n,h,_,v,g,S=.5*(v+(y=.5*(f+d))),T=.5*(g+(x=.5*(p+m))),l+1,0),cX(e,S,T,y,x,d,m,s,c,l+1,u)))}var lX,uX,hX,_X,fX,pX,dX,mX,vX,gX,yX,xX,SX,TX,EX,AX,CX,bX,PX,RX,IX,wX,DX,OX,MX,NX,BX,FX,LX,zX,UX,GX,kX,HX,VX,jX,WX,qX,XX,YX,KX,QX,ZX,JX,$X,eY,tY,nY=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return L(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Ni),iY=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),rY=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=fi.WHITE.clone(),this.lineCap=Kq.BUTT,this.strokeColor=fi.BLACK.clone(),this.lineJoin=Qq.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,Zq.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,Zq.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,a){var o=this._curPath,s=o.points[o.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==a?(cX(this,s.x,s.y,e,t,n,i,r,a,0,Zq.PT_CORNER),this._commandX=r,this._commandY=a):this.lineTo(r,a))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,a=this._commandY;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,a){!function(e,t,n,i,r,a,o){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=a-r,o=o||!1)if(rX(u)>=2*$q)u=2*$q;else for(;u<0;)u+=2*$q;else if(rX(u)>=2*$q)u=2*-$q;else for(;u>0;)u-=2*$q;for(c=0|tX(1,eX(rX(u)/(.5*$q)+.5,5)),h=rX(4/3*(1-nX(s=u/c/2))/iX(s)),o||(h=-h),T=0;T<=c;T++)p=t+(_=nX(l=r+u*(T/c)))*i,d=n+(f=iX(l))*i,m=-f*i*h,v=_*i*h,0===T?e.moveTo(p,d):e.bezierCurveTo(g+x,y+S,p-m,d-v,p,d),g=p,y=d,x=m,S=v}(this,e,t,n,i,r,a)},t.ellipse=function(e,t,n,i){sX(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){sX(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,a){if(a<.1)e.rect(t,n,i,r);else{var o=eX(a,.5*rX(i))*aX(i),s=eX(a,.5*rX(r))*aX(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-oX),t+o*(1-oX),n+r,t+o,n+r),e.lineTo(t+i-o,n+r),e.bezierCurveTo(t+i-o*(1-oX),n+r,t+i,n+r-s*(1-oX),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-oX),t+i-o*(1-oX),n,t+i-o,n),e.lineTo(t+o,n),e.bezierCurveTo(t+o*(1-oX),n,t,n+s*(1-oX),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&tW.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=tW.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,a=i.points,o=r[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new nY(e,t),r.push(o)),o.flags=n,a.push(o)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new iY,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),aY=wj.concat([new Ua("a_dist",Sr.R32F)]),oY=Mj(aY),sY=Nj(aY),cY=(lX=nl("cc.Graphics"),uX=gl(),hX=rl(110),_X=pl(),fX=El(),pX=Bl(Qq),dX=El(),mX=Bl(Kq),vX=El(),gX=El(),yX=El(),xX=El(),SX=xl(),lX(TX=uX(TX=hX(TX=_X((DX=wX=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,q(t,"_lineWidth",AX,V(t)),q(t,"_strokeColor",CX,V(t)),q(t,"_lineJoin",bX,V(t)),q(t,"_lineCap",PX,V(t)),q(t,"_fillColor",RX,V(t)),q(t,"_miterLimit",IX,V(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=wW.ADD_COLOR,t.impl=new rY,t}L(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=VM.root.createModel(Zv),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(VM.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,a){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,a)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,a){this.impl&&this.impl.arc(e,t,n,i,r,a)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Nv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=i.director.root.device,n=t.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,65535*sY,sY)),r=t.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new kb([n],aY,qr.TRIANGLE_LIST,r);a.subMeshIdx=0,this.model.initSubModel(e,a,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(a)}}else A(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],a=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var o=new Float32Array(r.vData.buffer,0,r.vertexStart*oY);a.vertexBuffers[0].update(o),a.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);a.indexBuffer.update(s),a.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},B(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(Yq),wX.LineJoin=Qq,wX.LineCap=Kq,X((EX=DX).prototype,"lineWidth",[yl,fX],Object.getOwnPropertyDescriptor(EX.prototype,"lineWidth"),EX.prototype),X(EX.prototype,"lineJoin",[pX,dX],Object.getOwnPropertyDescriptor(EX.prototype,"lineJoin"),EX.prototype),X(EX.prototype,"lineCap",[mX,vX],Object.getOwnPropertyDescriptor(EX.prototype,"lineCap"),EX.prototype),X(EX.prototype,"strokeColor",[gX],Object.getOwnPropertyDescriptor(EX.prototype,"strokeColor"),EX.prototype),X(EX.prototype,"fillColor",[yX],Object.getOwnPropertyDescriptor(EX.prototype,"fillColor"),EX.prototype),X(EX.prototype,"miterLimit",[xX],Object.getOwnPropertyDescriptor(EX.prototype,"miterLimit"),EX.prototype),X(EX.prototype,"color",[Wl,SX],Object.getOwnPropertyDescriptor(EX.prototype,"color"),EX.prototype),AX=X(EX.prototype,"_lineWidth",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CX=X(EX.prototype,"_strokeColor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.BLACK.clone()}}),bX=X(EX.prototype,"_lineJoin",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qq.MITER}}),PX=X(EX.prototype,"_lineCap",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kq.BUTT}}),RX=X(EX.prototype,"_fillColor",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.WHITE.clone()}}),IX=X(EX.prototype,"_miterLimit",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),TX=EX))||TX)||TX)||TX)||TX);i.Graphics=cY;var lY,uY=new wi,hY=new Ni,_Y=new wi,fY=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(lY||(lY={})),Ze(lY);var pY=(OX=nl("cc.Mask"),MX=gl(),NX=rl(110),BX=pl(),FX=Bl(lY),LX=El(),zX=Rl(),UX=El(),GX=xl(),kX=Bl(zV),HX=xl(),VX=xl(),jX=Al(),WX=xl(),qX=xl(),OX(XX=MX(XX=NX(XX=BX((tY=eY=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,q(t,"_type",KX,V(t)),q(t,"_inverted",QX,V(t)),q(t,"_segments",ZX,V(t)),q(t,"_spriteFrame",JX,V(t)),q(t,"_alphaThreshold",$X,V(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=wW.ADD_COLOR,t}L(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(VM.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,a=hY;this.node.getWorldMatrix(uY),wi.invert(_Y,uY),Ni.transformMat4(a,e,_Y);var o=t.anchorPoint;a.x+=o.x*i,a.y+=o.y*r;var s=!1;if(this.type===lY.RECT||this.type===lY.GRAPHICS_STENCIL||this.type===lY.IMAGE_STENCIL)s=a.x>=0&&a.y>=0&&a.x<=i&&a.y<=r;else if(this.type===lY.ELLIPSE){var c=i/2,l=r/2,u=a.x-.5*i,h=a.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==lY.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new cY;e._objFlags|=Yt.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=fi.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===lY.RECT||this._type===lY.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,a=e.anchorPoint,o=-i*a.x,s=-r*a.y;if(this._type===lY.RECT)t.rect(o,s,i,r);else if(this._type===lY.ELLIPSE){for(var c=function(e,t,n){fY.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)fY.push(new di(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return fY}(new di(o+i/2,s+r/2,0),new di(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Nv.get("default-clear-stencil");this._clearStencilMtl=new kg({parent:e,owner:this,subModelIdx:0}),this._clearModel=VM.root.createModel(Zv),this._clearModel.node=this._clearModel.transform=this.node;var t=Nj(Ij),n=i.director.root.device,r=n.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.DEVICE,4*t,t)),a=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(a);var o=n.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);o.update(s),this._clearModelMesh=new kb([r],Ij,qr.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=Kj.DISABLED,this._type===lY.IMAGE_STENCIL?(e=Nv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Nv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==lY.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},B(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==lY.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=Kj.DISABLED,this._graphics&&(this._graphics.stencilStage=Kj.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Yn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===lY.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===lY.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(Yq),eY.Type=lY,X((YX=tY).prototype,"type",[FX,LX],Object.getOwnPropertyDescriptor(YX.prototype,"type"),YX.prototype),X(YX.prototype,"inverted",[zX,UX],Object.getOwnPropertyDescriptor(YX.prototype,"inverted"),YX.prototype),X(YX.prototype,"segments",[GX],Object.getOwnPropertyDescriptor(YX.prototype,"segments"),YX.prototype),X(YX.prototype,"spriteFrame",[kX,HX],Object.getOwnPropertyDescriptor(YX.prototype,"spriteFrame"),YX.prototype),X(YX.prototype,"alphaThreshold",[VX,jX,Pl],Object.getOwnPropertyDescriptor(YX.prototype,"alphaThreshold"),YX.prototype),X(YX.prototype,"color",[Wl,WX],Object.getOwnPropertyDescriptor(YX.prototype,"color"),YX.prototype),X(YX.prototype,"customMaterial",[Wl,qX],Object.getOwnPropertyDescriptor(YX.prototype,"customMaterial"),YX.prototype),KX=X(YX.prototype,"_type",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lY.RECT}}),QX=X(YX.prototype,"_inverted",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZX=X(YX.prototype,"_segments",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),JX=X(YX.prototype,"_spriteFrame",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$X=X(YX.prototype,"_alphaThreshold",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),XX=YX))||XX)||XX)||XX)||XX);Pw._maskComp=pY,i.Mask=pY;var dY,mY,vY,gY,yY,xY,SY,TY,EY,AY,CY,bY,PY,RY,IY,wY,DY,OY,MY,NY,BY,FY,LY,zY,UY,GY,kY,HY,VY,jY,WY,qY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,aK,oK,sK,cK,lK,uK,hK,_K,fK,pK,dK,mK,vK,gK,yK,xK,SK,TK,EK=/^(click)(\s)*=|(param)(\s)*=/,AK=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,CK=function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var a=e.substring(t,r),o=e.substring(r+1,i);""===o&&(a=e.substring(t,i+1)),this._processResult(a),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(o),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,a="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var o="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=AK.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(o=e.substring(i.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=AK.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(o=e.substring(i.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=EK.exec(e);r;){var a=r[0],o="";if(i=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(o=s?s[0]:"").length}i&&(t[a=a.substring(0,a.length-1).trim()]=o),e=e.substring(n).trim(),r=EK.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=W(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],a=i[1];e=e.replace(r,a)}return e},e}(),bK=(dY=nl("cc.LabelOutline"),mY=gl(),vY=rl(110),gY=pl(),yY=il(Jq),xY=El(),SY=El(),dY(TY=mY(TY=vY(TY=gY(TY=yY(TY=fl((bY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_color",AY,V(t)),q(t,"_width",CY,V(t)),t}L(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Jq);e&&e.updateRenderData(!0)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Ju),AY=X((EY=bY).prototype,"_color",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(0,0,0,255)}}),CY=X(EY.prototype,"_width",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(EY.prototype,"color",[xY],Object.getOwnPropertyDescriptor(EY.prototype,"color"),EY.prototype),X(EY.prototype,"width",[SY],Object.getOwnPropertyDescriptor(EY.prototype,"width"),EY.prototype),TY=EY))||TY)||TY)||TY)||TY)||TY)||TY);i.LabelOutline=bK,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(yK||(yK={})),Ze(yK),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(xK||(xK={})),Ze(xK),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(SK||(SK={})),Ze(SK),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(TK||(TK={}));var PK,RK=(PY=nl("cc.Sprite"),RY=gl(),IY=rl(110),wY=pl(),DY=Bl(GV),OY=Rl(),MY=El(),NY=Bl(zV),BY=Rl(),FY=El(),LY=Bl(yK),zY=Rl(),UY=El(),GY=Bl(xK),kY=Rl(),HY=El(),VY=Rl(),jY=El(),WY=Al(),qY=Rl(),XY=El(),YY=Al(),KY=Rl(),QY=El(),ZY=xl(),JY=Rl(),$Y=El(),eK=Rl(),tK=El(),nK=Bl(SK),iK=Rl(),rK=El(),PY(aK=RY(aK=IY(aK=wY((gK=vK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",sK,V(t)),q(t,"_type",cK,V(t)),q(t,"_fillType",lK,V(t)),q(t,"_sizeMode",uK,V(t)),q(t,"_fillCenter",hK,V(t)),q(t,"_fillStart",_K,V(t)),q(t,"_fillRange",fK,V(t)),q(t,"_isTrimmedMode",pK,V(t)),q(t,"_useGrayscale",dK,V(t)),q(t,"_atlas",mK,V(t)),t}L(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===yK.SLICED&&t.on(zV.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===yK.SLICED&&this._spriteFrame.off(zV.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Om){var i=e.getPixelFormat();n=i===em.RGBA_ETC1||i===em.RGB_A_PVRTC_4BPPV1||i===em.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=wW.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=wW.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=wW.GRAYSCALE:this._instanceMaterialType=wW.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof vT){var n=F({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Cg;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===yK.SLICED?this._spriteFrame.on(zV.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(zV.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(SK.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(SK.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===yK.SLICED&&e.off(zV.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===yK.SLICED&&t.on(zV.EVENT_UV_UPDATED,this._updateUVs,this))},B(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===xK.RADIAL||this._fillType===xK.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===yK.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Yn(e,0,1),this._type===yK.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Yn(e,-1,1),this._type===yK.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===yK.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==SK.CUSTOM&&this._applySpriteSize())}}]),t}(Yq),vK.FillType=xK,vK.Type=yK,vK.SizeMode=SK,vK.EventType=TK,X((oK=gK).prototype,"spriteAtlas",[DY,OY,MY],Object.getOwnPropertyDescriptor(oK.prototype,"spriteAtlas"),oK.prototype),X(oK.prototype,"spriteFrame",[NY,BY,FY],Object.getOwnPropertyDescriptor(oK.prototype,"spriteFrame"),oK.prototype),X(oK.prototype,"type",[LY,zY,UY],Object.getOwnPropertyDescriptor(oK.prototype,"type"),oK.prototype),X(oK.prototype,"fillType",[GY,kY,HY],Object.getOwnPropertyDescriptor(oK.prototype,"fillType"),oK.prototype),X(oK.prototype,"fillCenter",[VY,jY],Object.getOwnPropertyDescriptor(oK.prototype,"fillCenter"),oK.prototype),X(oK.prototype,"fillStart",[WY,qY,XY],Object.getOwnPropertyDescriptor(oK.prototype,"fillStart"),oK.prototype),X(oK.prototype,"fillRange",[YY,KY,QY],Object.getOwnPropertyDescriptor(oK.prototype,"fillRange"),oK.prototype),X(oK.prototype,"trim",[ZY,JY,$Y],Object.getOwnPropertyDescriptor(oK.prototype,"trim"),oK.prototype),X(oK.prototype,"grayscale",[yl,eK,tK],Object.getOwnPropertyDescriptor(oK.prototype,"grayscale"),oK.prototype),X(oK.prototype,"sizeMode",[nK,iK,rK],Object.getOwnPropertyDescriptor(oK.prototype,"sizeMode"),oK.prototype),sK=X(oK.prototype,"_spriteFrame",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cK=X(oK.prototype,"_type",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yK.SIMPLE}}),lK=X(oK.prototype,"_fillType",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xK.HORIZONTAL}}),uK=X(oK.prototype,"_sizeMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SK.TRIMMED}}),hK=X(oK.prototype,"_fillCenter",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,0)}}),_K=X(oK.prototype,"_fillStart",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fK=X(oK.prototype,"_fillRange",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pK=X(oK.prototype,"_isTrimmedMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dK=X(oK.prototype,"_useGrayscale",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mK=X(oK.prototype,"_atlas",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aK=oK))||aK)||aK)||aK)||aK);i.Sprite=RK;var IK,wK,DK,OK,MK,NK,BK,FK,LK,zK,UK,GK,kK,HK,VK,jK,WK,qK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ,aQ,oQ,sQ,cQ,lQ,uQ,hQ,_Q,fQ,pQ,dQ,mQ,vQ,gQ,yQ,xQ,SQ,TQ,EQ,AQ=nl("cc.RenderRoot2D")(PK=rl(100)(PK=pl()(PK=il(uW)(PK=al(PK=fl(PK=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.onEnable=function(){i.director.root.batcher2D.addScreen(this)},n.onDisable=function(){i.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){i.director.root.batcher2D.removeScreen(this)},t}(Ju))||PK)||PK)||PK)||PK)||PK)||PK,CQ=new di,bQ=Ye({OVERLAY:0,INTERSPERSE:1}),PQ=(IK=nl("cc.Canvas"),wK=gl(),DK=rl(100),OK=pl(),MK=Bl(iL),NK=El(),BK=El(),FK=Bl(iL),IK(LK=wK(LK=DK(LK=OK(LK=fl(LK=al((X((zK=function(e){function t(){var t;return q(t=e.call(this)||this,"_cameraComponent",UK,V(t)),q(t,"_alignCanvasWithScreen",GK,V(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new di,t._renderMode=bQ.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(V(t)),t}L(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(iL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(jE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(iL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(iL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(jE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=qM.height/2;else{var e=sh.windowSize;this._cameraComponent.orthoHeight=e.height/$M.getScaleY()/2}this.node.getWorldPosition(CQ),this._cameraComponent.node.setWorldPosition(CQ.x,CQ.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===bQ.OVERLAY?t|1<<30:t&~(1<<30)}return 0},B(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(AQ)).prototype,"cameraComponent",[MK,NK],Object.getOwnPropertyDescriptor(zK.prototype,"cameraComponent"),zK.prototype),X(zK.prototype,"alignCanvasWithScreen",[BK],Object.getOwnPropertyDescriptor(zK.prototype,"alignCanvasWithScreen"),zK.prototype),UK=X(zK.prototype,"_cameraComponent",[FK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GK=X(zK.prototype,"_alignCanvasWithScreen",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LK=zK))||LK)||LK)||LK)||LK)||LK)||LK);i.Canvas=PQ,Bn((nl("cc.UIComponent")(kK=il(uW)(kK=rl(110)(kK=al(kK=fl(kK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=Kj.DISABLED,t}L(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(Ju))||kK)||kK)||kK)||kK)||kK).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),Nn(PQ.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:fi.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),Fn(Yq.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),Fn(uW.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),i.UITransformComponent=uW,ke.setClassAlias(uW,"cc.UITransformComponent"),ke.setClassAlias(Yq,"cc.RenderComponent"),i.CanvasComponent=PQ,ke.setClassAlias(PQ,"cc.CanvasComponent");var RQ=new CK,IQ="RICHTEXT_CHILD",wQ="RICHTEXT_Image_CHILD",DQ=new Ue((function(e){if(!i.isValid(e.node))return!1;var t=e.node.getComponent(bK);return t&&(t.width=0),!0}),20),OQ=new Ue((function(e){return i.isValid(e.node)}),10);function MQ(e){return{node:new qC(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function NQ(e,t){var n;e===IQ?n=DQ._get():e===wQ&&(n=OQ._get());var i=(n=n||MQ(e)).node;return i||(i=new qC(e)),i.hideFlags|=Yt.Flags.DontSave|Yt.Flags.HideInHierarchy,e===wQ?(n.comp=i.getComponent(RK)||i.addComponent(RK),n.comp.spriteFrame=t,n.comp.type=RK.Type.SLICED,n.comp.sizeMode=RK.SizeMode.CUSTOM):(n.comp=i.getComponent(Jq)||i.addComponent(Jq),n.comp.string=t,n.comp.horizontalAlign=jq.LEFT,n.comp.verticalAlign=Wq.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var BQ,FQ=(HK=nl("cc.RichText"),VK=gl(),jK=rl(110),WK=pl(),qK=El(),XK=Bl(jq),YK=El(),KK=El(),QK=El(),ZK=Bl(WV),JK=El(),$K=El(),eQ=Rl(),tQ=Bl(Xq),nQ=El(),iQ=El(),rQ=El(),aQ=Bl(GV),oQ=El(),sQ=El(),HK(cQ=VK(cQ=jK(cQ=WK(cQ=fl((EQ=TQ=function(e){function t(){var t;return q(t=e.call(this)||this,"_lineHeight",uQ,V(t)),q(t,"_string",hQ,V(t)),q(t,"_horizontalAlign",_Q,V(t)),q(t,"_fontSize",fQ,V(t)),q(t,"_maxWidth",pQ,V(t)),q(t,"_fontFamily",dQ,V(t)),q(t,"_font",mQ,V(t)),q(t,"_isSystemFontUsed",vQ,V(t)),q(t,"_userDefinedFont",gQ,V(t)),q(t,"_cacheMode",yQ,V(t)),q(t,"_imageAtlas",xQ,V(t)),q(t,"_handleTouchEvent",SQ,V(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}L(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(jE.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(jE.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=W(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===IQ?DQ.put(n):n.type===wQ&&OQ.put(n)}this.node.off(jE.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(jE.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(jE.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(jE.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return NQ(IQ,e)},n._createImage=function(e){return NQ(wQ,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(Jq).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(Ju),r=function(){var r=t.value,a=r.clickHandler,o=r.clickParam;a&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[a];t.enabledInHierarchy&&n&&n.call(t,e,o)})),e.propagationStopped=!0)},a=W(this._segments);!(t=a()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(uW);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===IQ||n.name===wQ){n.parent===this.node?n.parent=null:e.splice(t,1);var i=MQ(n.name);i.node=n,n.name===IQ?(i.comp=n.getComponent(Jq),DQ.put(i)):(i.comp=n.getComponent(RK),OQ.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==IQ&&n.name!==wQ||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(Jq);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var a=this._getFirstWordLen(e,r,e.length),o=e.substr(r,a),s=this._measureText(n,o);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(i>this._maxWidth)for(var l=xj(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,a=i.style;if(r){if(a){if(!!a.outline!=!!r.outline)return!0;if(r.size!==a.size||r.italic!==a.italic||r.isImage!==a.isImage)return!0;if(r.src!==a.src||r.imageAlign!==a.imageAlign||r.imageHeight!==a.imageHeight||r.imageWidth!==a.imageWidth||r.imageOffset!==a.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(a&&(a.size||a.italic||a.isImage||a.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var a=i.rect.clone(),o=1,s=a.width,c=a.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=o=u/c,c*=o):(s*=o=this._lineHeight/c,c*=o),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else A(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=RQ.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var o=a.split("\n"),s=0;s<o.length;++s){var c=o[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),o.length>1&&s<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&s<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&s===o.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+sj)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(mj(i)||vj(i))return 1;for(var r=1,a=t+1;a<n&&!vj(i=e.charAt(a))&&!mj(i);++a)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,a=i.anchorY,o=0;o<this._segments.length;++o){var s=this._segments[o],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case jq.LEFT:break;case jq.CENTER:l-=this._linesWidth[c-1]/2;break;case jq.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*a,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(RK)){var h=s.node.position.clone(),_=this._lineHeight,f=1.26*this._lineHeight;switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(bK);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return fi[t]?fi[t]:(new fi).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(Jq);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(bK);r||(r=e.node.addComponent(bK)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var a=n.event;a&&(e.clickHandler=a.click||"",e.clickParam=a.param||"")}t.cacheMode=this._cacheMode,this._font instanceof WV&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var o=t._assembler;o&&o.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=W(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=fi.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},B(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(Ju),TQ.HorizontalAlign=jq,TQ.VerticalAlign=Wq,X((lQ=EQ).prototype,"string",[Il,qK],Object.getOwnPropertyDescriptor(lQ.prototype,"string"),lQ.prototype),X(lQ.prototype,"horizontalAlign",[XK,YK],Object.getOwnPropertyDescriptor(lQ.prototype,"horizontalAlign"),lQ.prototype),X(lQ.prototype,"fontSize",[KK],Object.getOwnPropertyDescriptor(lQ.prototype,"fontSize"),lQ.prototype),X(lQ.prototype,"fontFamily",[QK],Object.getOwnPropertyDescriptor(lQ.prototype,"fontFamily"),lQ.prototype),X(lQ.prototype,"font",[ZK,JK],Object.getOwnPropertyDescriptor(lQ.prototype,"font"),lQ.prototype),X(lQ.prototype,"useSystemFont",[$K,eQ],Object.getOwnPropertyDescriptor(lQ.prototype,"useSystemFont"),lQ.prototype),X(lQ.prototype,"cacheMode",[tQ,nQ],Object.getOwnPropertyDescriptor(lQ.prototype,"cacheMode"),lQ.prototype),X(lQ.prototype,"maxWidth",[iQ],Object.getOwnPropertyDescriptor(lQ.prototype,"maxWidth"),lQ.prototype),X(lQ.prototype,"lineHeight",[rQ],Object.getOwnPropertyDescriptor(lQ.prototype,"lineHeight"),lQ.prototype),X(lQ.prototype,"imageAtlas",[aQ,oQ],Object.getOwnPropertyDescriptor(lQ.prototype,"imageAtlas"),lQ.prototype),X(lQ.prototype,"handleTouchEvent",[sQ],Object.getOwnPropertyDescriptor(lQ.prototype,"handleTouchEvent"),lQ.prototype),uQ=X(lQ.prototype,"_lineHeight",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),hQ=X(lQ.prototype,"_string",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),_Q=X(lQ.prototype,"_horizontalAlign",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jq.LEFT}}),fQ=X(lQ.prototype,"_fontSize",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),pQ=X(lQ.prototype,"_maxWidth",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dQ=X(lQ.prototype,"_fontFamily",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),mQ=X(lQ.prototype,"_font",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vQ=X(lQ.prototype,"_isSystemFontUsed",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gQ=X(lQ.prototype,"_userDefinedFont",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yQ=X(lQ.prototype,"_cacheMode",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xq.NONE}}),xQ=X(lQ.prototype,"_imageAtlas",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SQ=X(lQ.prototype,"_handleTouchEvent",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cQ=lQ))||cQ)||cQ)||cQ)||cQ)||cQ);i.RichText=FQ;var LQ=nl("cc.UIMeshRenderer")(BQ=gl()(BQ=rl(110)(BQ=pl()(BQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t.stencilStage=Kj.DISABLED,t}L(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=W(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,a=0;a<r;a++)i[a]._priority=Bp.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},a)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},B(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(Ju))||BQ)||BQ)||BQ)||BQ;i.UIMeshRenderer=LQ;var zQ,UQ,GQ,kQ,HQ,VQ,jQ,WQ,qQ,XQ,YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,nZ,iZ,rZ,aZ,oZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ=Mp.Enum.NONE|Mp.Enum.UI_3D,pZ=function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=fZ,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=fZ,this.renderScene=null},t.fillPasses=function(e,t,n,r,a,o){if(e){var s=e.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new kv(i.director.root));var u=s[l],h=this._passes[l];u.update(),t||(t=u.depthStencilState,n=0),r||(r=u.blendState,a=0),-1===a&&(a=0),c=n<<16|a,h._initPassFromTarget(u,t,r,c),this._shaders[l]=h.getShaderVariant(o)}}},B(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}(),dZ=(zQ=nl("cc.UIStaticBatch"),UQ=gl(),GQ=pl(),kQ=rl(110),HQ=xl(),zQ(VQ=UQ(VQ=GQ(VQ=kQ((X((jQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}L(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new pZ;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return VM.root&&VM.root.batcher2D?VM.root.batcher2D:(A(9301),null)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(Yq)).prototype,"color",[Wl,HQ],Object.getOwnPropertyDescriptor(jQ.prototype,"color"),jQ.prototype),VQ=jQ))||VQ)||VQ)||VQ)||VQ),mZ=(WQ=nl("cc.LabelShadow"),qQ=gl(),XQ=rl(110),YQ=pl(),KQ=il(Jq),QQ=El(),ZQ=El(),JQ=El(),WQ($Q=qQ($Q=XQ($Q=YQ($Q=KQ($Q=fl((rZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_color",tZ,V(t)),q(t,"_offset",nZ,V(t)),q(t,"_blur",iZ,V(t)),t}L(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Jq);e&&e.updateRenderData(!0)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(Ju),tZ=X((eZ=rZ).prototype,"_color",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(0,0,0,255)}}),nZ=X(eZ.prototype,"_offset",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(2,2)}}),iZ=X(eZ.prototype,"_blur",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(eZ.prototype,"color",[QQ],Object.getOwnPropertyDescriptor(eZ.prototype,"color"),eZ.prototype),X(eZ.prototype,"offset",[ZQ],Object.getOwnPropertyDescriptor(eZ.prototype,"offset"),eZ.prototype),X(eZ.prototype,"blur",[JQ],Object.getOwnPropertyDescriptor(eZ.prototype,"blur"),eZ.prototype),$Q=eZ))||$Q)||$Q)||$Q)||$Q)||$Q)||$Q),vZ=(aZ=nl("cc.UIOpacity"),oZ=gl(),sZ=rl(110),cZ=pl(),lZ=El(),aZ(uZ=oZ(uZ=sZ(uZ=cZ(uZ=fl((X((hZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_opacity",_Z,V(t)),t}L(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},B(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=ht(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(Ju)).prototype,"opacity",[yl,lZ],Object.getOwnPropertyDescriptor(hZ.prototype,"opacity"),hZ.prototype),_Z=X(hZ.prototype,"_opacity",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),uZ=hZ))||uZ)||uZ)||uZ)||uZ)||uZ);i.MaskComponent=pY,ke.setClassAlias(pY,"cc.MaskComponent"),i.LabelComponent=Jq,ke.setClassAlias(Jq,"cc.LabelComponent"),i.LabelOutlineComponent=bK,ke.setClassAlias(bK,"cc.LabelOutlineComponent"),i.RichTextComponent=FQ,ke.setClassAlias(FQ,"cc.RichTextComponent"),i.SpriteComponent=RK,ke.setClassAlias(RK,"cc.SpriteComponent"),i.UIModelComponent=LQ,ke.setClassAlias(LQ,"cc.UIModelComponent"),i.GraphicsComponent=cY,ke.setClassAlias(cY,"cc.GraphicsComponent"),ke.setClassAlias(dZ,"cc.UIStaticBatchComponent"),ke.setClassAlias(vZ,"cc.UIOpacityComponent");var gZ=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function yZ(e,t,n,i,r){var a=0,o=null;if(r===function(e,t,n,i){for(var r=0,a=t,o=n-i;a<n;a+=i)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,n,i)>0)for(a=t;a<n;a+=i)o=LZ(a,e[a],e[a+1],o);else for(a=n-i;a>=t;a-=i)o=LZ(a,e[a],e[a+1],o);return o&&MZ(o,o.next)&&(zZ(o),o=o.next),o}function xZ(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!MZ(n,n.next)&&0!==OZ(n.prev,n,n.next))n=n.next;else{if(zZ(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function SZ(e,t,n,i,r,a,o){if(void 0===o&&(o=0),e){!o&&a&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=RZ(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,a=null,o=0,s=0,c=0,l=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;n=i}a.nextZ=null,l*=2}while(o>1)}(r)}(e,i,r,a);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,a?EZ(e,i,r,a):TZ(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),zZ(e),e=l.next,s=l.next;else if((e=l)===s){o?1===o?SZ(e=AZ(e,t,n),t,n,i,r,a,2):2===o&&CZ(e,t,n,i,r,a):SZ(xZ(e),t,n,i,r,a,1);break}}}function TZ(e){var t=e.prev,n=e,i=e.next;if(OZ(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(wZ(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&OZ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function EZ(e,t,n,i){var r=e.prev,a=e,o=e.next;if(OZ(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,c=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,l=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,u=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,h=RZ(s,c,t,n,i),_=RZ(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&wZ(r.x,r.y,a.x,a.y,o.x,o.y,f.x,f.y)&&OZ(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&wZ(r.x,r.y,a.x,a.y,o.x,o.y,f.x,f.y)&&OZ(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function AZ(e,t,n){var i=e;do{var r=i.prev,a=i.next.next;!MZ(r,a)&&NZ(r,i,i.next,a)&&BZ(r,a)&&BZ(a,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(a.i/n),zZ(i),zZ(i.next),i=e=a),i=i.next}while(i!==e);return i}function CZ(e,t,n,i,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&DZ(o,s)){var c=FZ(o,s);return o=xZ(o,o.next),c=xZ(c,c.next),SZ(o,t,n,i,r,a),void SZ(c,t,n,i,r,a)}s=s.next}o=o.next}while(o!==e)}function bZ(e,t){return e.x-t.x}function PZ(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,a=-1/0,o=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>a){if(a=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}o=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!o)return null;if(i===a)return o.prev;var c,l=o,u=o.x,h=o.y,_=1/0;for(n=o.next;n!==l;)i>=n.x&&n.x>=u&&wZ(r<h?i:a,r,u,h,r<h?a:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>o.x)&&BZ(n,e)&&(o=n,_=c),n=n.next;return o}(e,t)){var n=FZ(t,e);xZ(n,n.next)}}function RZ(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function IZ(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function wZ(e,t,n,i,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(i-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(r-o)*(i-s)>=0}function DZ(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&NZ(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&BZ(e,t)&&BZ(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&r<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function OZ(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function MZ(e,t){return e.x===t.x&&e.y===t.y}function NZ(e,t,n,i){return!!(MZ(e,t)&&MZ(n,i)||MZ(e,i)&&MZ(n,t))||OZ(e,t,n)>0!=OZ(e,t,i)>0&&OZ(n,i,e)>0!=OZ(n,i,t)>0}function BZ(e,t){return OZ(e.prev,e,e.next)<0?OZ(e,t,e.next)>=0&&OZ(e,e.prev,t)>=0:OZ(e,t,e.prev)<0||OZ(e,e.next,t)<0}function FZ(e,t){var n=new gZ(e.i,e.x,e.y),i=new gZ(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,a.next=i,i.prev=a,i}function LZ(e,t,n,i){var r=new gZ(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function zZ(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function UZ(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,a=yZ(e,0,r,n,!0),o=[];if(!a)return o;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(a=function(e,t,n,i){var r,a=[],o=0,s=null;for(o=0,r=t.length;o<r;o++)(s=yZ(e,t[o]*i,o<r-1?t[o+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),a.push(IZ(s)));if(a.sort(bZ),!n)return n;for(o=0;o<a.length;o++)PZ(a[o],n),n=xZ(n,n.next);return n}(e,t,a,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var p=n;p<r;p+=n)(h=e[p])<s&&(s=h),(_=e[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return SZ(a,o,n,s,c,f),o}for(var GZ=Math.PI,kZ=Math.min,HZ=Math.max,VZ=Math.ceil,jZ=Math.acos,WZ=Math.cos,qZ=Math.sin,XZ=Math.atan2,YZ=null,KZ=null,QZ=new fi,ZZ=[],JZ=0;JZ<4;JZ++)ZZ.push(new di);function $Z(e,t,n){return e<t?t:e>n?n:e}var eJ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!KZ)return null;var n=KZ.getRenderDataList(),i=n[KZ.dataOffset];if(!i)return null;var r=i,a=r?r.vertexStart+t:0;return(a>65535||3*a>131070)&&(++KZ.dataOffset,KZ.dataOffset<n.length?i=n[KZ.dataOffset]:(i=KZ.requestRenderData(),n[KZ.dataOffset]=i),r=i),r&&r.vertexCount<a&&r.request(t,3*t),i},stroke:function(e){fi.copy(QZ,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){fi.copy(QZ,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,n,i,r,a=.5*e.lineWidth,o=e.lineCap,s=e.lineJoin,c=e.miterLimit;if(KZ=e.impl){var l=(t=a,n=GZ,i=KZ.tessTol,r=2*jZ(t/(t+i)),HZ(2,VZ(n/r)));this._calculateJoins(KZ,a,s,c);for(var u=KZ.paths,h=0,_=KZ.pathOffset,f=KZ.pathLength;_<f;_++){var p=u[_],d=p.points.length;s===Qq.ROUND?h+=2*(d+p.bevel*(l+2)+1):h+=2*(d+5*p.bevel+1),p.closed||(o===Kq.ROUND?h+=2*(2*l+2):h+=12)}var m=YZ=this.getRenderData(e,h);if(m){for(var v=m.vData,g=m.iData,y=KZ.pathOffset,x=KZ.pathLength;y<x;y++){var S=u[y],T=S.points,E=T.length,A=m.vertexStart,C=void 0,b=void 0,P=0,R=0,I=S.closed;if(I?(C=T[E-1],b=T[0],P=0,R=E):(C=T[0],b=T[1],P=1,R=E-1),b=b||C,!I){var w=new nY(b.x,b.y);w.subtract(C),w.normalize();var D=w.x,O=w.y;o===Kq.BUTT?this._buttCapStart(C,D,O,a,0):o===Kq.SQUARE?this._buttCapStart(C,D,O,a,a):o===Kq.ROUND&&this._roundCapStart(C,D,O,a,l)}for(var M=P;M<R;++M)s===Qq.ROUND?this._roundJoin(C,b,a,a,l):0!=(b.flags&(Zq.PT_BEVEL|Zq.PT_INNERBEVEL))?this._bevelJoin(C,b,a,a):(this._vSet(b.x+b.dmx*a,b.y+b.dmy*a,1),this._vSet(b.x-b.dmx*a,b.y-b.dmy*a,-1)),C=b,b=T[M+1];if(I){var N=8*A;this._vSet(v[N],v[N+1],1),this._vSet(v[N+8],v[N+8+1],-1)}else{var B=new nY(b.x,b.y);B.subtract(C),B.normalize();var F=B.x,L=B.y;o===Kq.BUTT?this._buttCapEnd(b,F,L,a,0):o===Kq.SQUARE?this._buttCapEnd(b,F,L,a,a):o===Kq.ROUND&&this._roundCapEnd(b,F,L,a,l)}for(var z=m.indexStart,U=A+2,G=m.vertexStart;U<G;U++)g[z++]=U-2,g[z++]=U-1,g[z++]=U;m.indexStart=z}YZ=null,KZ=null}}},_expandFill:function(e){if(KZ=e.impl){for(var t=KZ.paths,n=0,i=KZ.pathOffset,r=KZ.pathLength;i<r;i++)n+=t[i].points.length;var a=YZ=this.getRenderData(e,n);if(a){for(var o=a,s=o.vData,c=o.iData,l=KZ.pathOffset,u=KZ.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var p=a.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=a.indexStart;if(h.complex){for(var v=[],g=p,y=a.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=UZ(v,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)c[m++]=S[T]+p}else for(var A=p,C=p+2,b=o.vertexStart;C<b;C++)c[m++]=A,c[m++]=C-1,c[m++]=C;o.indexStart=m}}YZ=null,KZ=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var a=e.paths,o=e.pathOffset,s=e.pathLength;o<s;o++){var c=a[o],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/p;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=Zq.PT_LEFT),p*(d=HZ(11,kZ(h.len,_.len)*r))*d<1&&(_.flags|=Zq.PT_INNERBEVEL),_.flags&Zq.PT_CORNER&&(p*i*i<1||n===Qq.BEVEL||n===Qq.ROUND)&&(_.flags|=Zq.PT_BEVEL),0!=(_.flags&(Zq.PT_BEVEL|Zq.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],a=r.points,o=a[a.length-1],s=a[0];a.length>2&&o.equals(s)&&(r.closed=!0,a.pop(),o=a[a.length-1]);for(var c=0,l=a.length;c<l;c++){var u=new nY(s.x,s.y);u.subtract(o),o.len=u.length(),(u.x||u.y)&&u.normalize(),o.dx=u.x,o.dy=u.y,o=s,s=a[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,a=n.y,o=0,s=0,c=0,l=0;return 0!==e?(o=r+t.dy*i,s=a-t.dx*i,c=r+n.dy*i,l=a-n.dx*i):(o=c=r+n.dmx*i,s=l=a+n.dmy*i),[o,s,c,l]},_buttCapStart:function(e,t,n,i,r){var a=e.x-t*r,o=e.y-n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var a=e.x+t*r,o=e.y+n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var a=e.x,o=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*GZ,h=WZ(u)*i,_=qZ(u)*i;this._vSet(a-s*h-t*_,o-c*h-n*_,1),this._vSet(a,o,0)}this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var a=e.x,o=e.y,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*GZ,h=WZ(u)*i,_=qZ(u)*i;this._vSet(a,o,0),this._vSet(a-s*h+t*_,o-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var a=e.dy,o=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&Zq.PT_LEFT)){var h=this._chooseBevel(t.flags&Zq.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],p=h[2],d=h[3],m=XZ(-o,-a),v=XZ(-c,-s);v>m&&(v-=2*GZ),this._vSet(_,f,1),this._vSet(l-a*i,t.y-o*i,-1);for(var g=$Z(VZ((m-v)/GZ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+WZ(x)*i,T=u+qZ(x)*i;this._vSet(l,u,0),this._vSet(S,T,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(t.flags&Zq.PT_INNERBEVEL,e,t,-i),A=E[0],C=E[1],b=E[2],P=E[3],R=XZ(o,a),I=XZ(c,s);I<R&&(I+=2*GZ),this._vSet(l+a*i,u+o*i,1),this._vSet(A,C,-1);for(var w=$Z(VZ((I-R)/GZ)*r,2,r),D=0;D<w;D++){var O=R+D/(w-1)*(I-R),M=l+WZ(O)*n,N=u+qZ(O)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(b,P,-1)}},_bevelJoin:function(e,t,n,i){var r=0,a=0,o=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,p=t.dy,d=-t.dx;if(t.flags&Zq.PT_LEFT){var m=this._chooseBevel(t.flags&Zq.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-p*i,t.y-d*i,-1)}else{var v=this._chooseBevel(t.flags&Zq.PT_INNERBEVEL,e,t,-i);r=v[0],a=v[1],o=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,a,-1),this._vSet(t.x+p*n,t.y+d*n,1),this._vSet(o,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),YZ){var i=YZ,r=8*i.vertexStart,a=i.vData;a[r++]=e,a[r++]=t,a[r++]=0,fi.toArray(a,QZ,r),r+=4,a[r++]=n,i.vertexStart++}}},tJ={getAssembler:function(){return eJ}};cY.Assembler=tJ;var nJ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},iJ=new Vi,rJ=null,aJ=null,oJ=[],sJ=[],cJ=[],lJ=[],uJ=new ki,hJ=new ki,_J=new Ni,fJ=null,pJ=0,dJ=0,mJ=0,vJ=0,gJ=0,yJ=1,xJ=null,SJ="",TJ=0,EJ=0,AJ=0,CJ=0,bJ=0,PJ=0,RJ=0,IJ=!1,wJ=0,DJ=0,OJ=0,MJ={updateRenderData:function(e){e.renderData&&rJ!==e&&(e.renderData.vertDirty&&(aJ=(rJ=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),rJ.actualFontSize=TJ,aJ.setContentSize(hJ),this.updateUVs(e),rJ.renderData.vertDirty=!1,rJ.markForUpdateRenderData(!1),rJ=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,a=3,o=0;o<i;o++){var s=r[o];n[a]=s.u,n[a+1]=s.v,a+=9}},_updateFontScale:function(){yJ=TJ/EJ},_updateFontFamily:function(e){var t=e.font;xJ=t.spriteFrame,fJ=t.fntConfig,Rj.fontAtlas=t.fontDefDictionary,OV.packToDynamicAtlas(e,xJ)},_updateLabelInfo:function(){Rj.hash="",Rj.margin=0},_updateProperties:function(e){SJ=e.string.toString(),TJ=e.fontSize,EJ=fJ?fJ.fontSize:e.fontSize,AJ=e.horizontalAlign,CJ=e.verticalAlign,bJ=e.spacingX,RJ=e.overflow,PJ=e._lineHeight;var t=aJ.contentSize;hJ.width=t.width,hJ.height=t.height,RJ===qq.NONE?(IJ=!1,hJ.width+=2*Rj.margin,hJ.height+=2*Rj.margin):RJ===qq.RESIZE_HEIGHT?(IJ=!0,hJ.height+=2*Rj.margin):IJ=e.enableWrapText,Rj.lineHeight=PJ,Rj.fontSize=TJ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){fJ=null,xJ=null,Rj.hash="",Rj.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=SJ,t=e.length,n=fJ.kerningDict,i=oJ,r=-1,a=0;a<t;++a){var o=e.charCodeAt(a),s=n[r<<16|65535&o]||0;i[a]=a<t-1?s:0,r=o}},_multilineTextWrap:function(e){for(var t=SJ.length,n=0,i=0,r=0,a=0,o=0,s=0,c=0,l=null,u=0;u<t;){var h=SJ.charAt(u);if("\n"!==h){for(var _=e(SJ,u,t),f=s,p=c,d=o,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=SJ.charAt(y)))if(l=Rj.fontAtlas.getLetterDefinitionForChar(h,Rj)){var x=m+l.offsetX*yJ-Rj.margin;if(IJ&&OJ>0&&i>0&&x+l.w*yJ>OJ&&!vj(h)){cJ.push(o),o=0,n++,i=0,r-=PJ*this._getFontScale()+0,v=!0;break}_J.x=x,_J.y=r-l.offsetY*yJ,this._recordLetterInfo(_J,h,y,n),y+1<oJ.length&&y<t-1&&(m+=oJ[y+1]),m+=l.xAdvance*yJ+bJ,d=_J.x+l.w*yJ,f<_J.y&&(f=_J.y),p>_J.y-l.h*yJ&&(p=_J.y-l.h*yJ)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+fJ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>p&&(c=p),a<(o=d)&&(a=o),u+=_)}else cJ.push(o),o=0,n++,i=0,r-=PJ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return cJ.push(o),dJ=(pJ=n+1)*PJ*this._getFontScale(),pJ>1&&(dJ+=0*(pJ-1)),hJ.width=wJ,hJ.height=DJ,wJ<=0&&(hJ.width=parseFloat(a.toFixed(2))+2*Rj.margin),DJ<=0&&(hJ.height=parseFloat(dJ.toFixed(2))+2*Rj.margin),vJ=hJ.height,gJ=0,s>0&&(vJ=hJ.height+s),c<-dJ&&(gJ=dJ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return RJ===qq.SHRINK?yJ:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(mj(i)||"\n"===i||vj(i))return 1;var r=1,a=Rj.fontAtlas.getLetterDefinitionForChar(i,Rj);if(!a)return r;for(var o=a.xAdvance*yJ+bJ,s=t+1;s<n&&(i=e.charAt(s),a=Rj.fontAtlas.getLetterDefinitionForChar(i,Rj));++s){if(o+a.offsetX*yJ+a.w*yJ>OJ&&!vj(i)&&OJ>0)return r;if(o+=a.xAdvance*yJ+bJ,"\n"===i||vj(i)||mj(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=sJ.length){var n=new nJ;sJ.push(n)}sJ[e].char=t,sJ[e].hash=""+t.charCodeAt(0)+Rj.hash,sJ[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=sJ.length){var r=new nJ;sJ.push(r)}var a=""+t.charCodeAt(0)+Rj.hash;sJ[n].line=i,sJ[n].char=t,sJ[n].hash=a,sJ[n].valid=Rj.fontAtlas.getLetter(a).valid,sJ[n].x=e.x,sJ[n].y=e.y},_alignText:function(){dJ=0,cJ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),RJ===qq.SHRINK&&TJ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||RJ===qq.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),TJ=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|TJ,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;yJ=r/EJ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return dJ>hJ.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=SJ.length;t<n;++t){var i=sJ[t];if(i.valid){var r=Rj.fontAtlas.getLetterDefinitionForChar(i.char,Rj);if(!r)continue;var a=i.x+r.w*yJ,o=i.line;if(wJ>0)if(IJ){if(cJ[o]>hJ.width&&(a>hJ.width||a<0)){e=!0;break}}else if(a>hJ.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=cJ[t],i=e>hJ.width||e<0;return IJ?n>hJ.width&&i:i},_updateQuads:function(){if(!rJ)return!1;var e=xJ?xJ.texture:Rj.fontAtlas.getTexture(),t=rJ.renderData;t.dataLength=0,t.resize(0,0);for(var n=aJ.anchorPoint,i=hJ,r=n.x*i.width,a=n.y*i.height,o=!0,s=0,c=SJ.length;s<c;++s){var l=sJ[s];if(l.valid){var u=Rj.fontAtlas.getLetter(l.hash);if(u){iJ.height=u.h,iJ.width=u.w,iJ.x=u.u,iJ.y=u.v;var h=l.y+mJ;if(DJ>0){if(h>vJ){var _=h-vJ;iJ.y+=_,iJ.height-=_,h-=_}h-u.h*yJ<gJ&&RJ===qq.CLAMP&&(iJ.height=h<gJ?0:(h-gJ)/yJ)}var f=l.line,p=l.x+u.w/2*yJ+lJ[f];if(wJ>0&&this._isHorizontalClamped(p,f))if(RJ===qq.CLAMP)iJ.width=0;else if(RJ===qq.SHRINK){if(hJ.width>u.w){o=!1;break}iJ.width=0}if(iJ.height>0&&iJ.width>0){var d=this._determineRect(),m=l.x+lJ[l.line];this.appendQuad(rJ,e,iJ,d,m-r,h-a,yJ)}}else console.warn("Can't find letter in this bitmap-font")}}return o},appendQuad:function(){},_determineRect:function(){var e=xJ.isRotated(),t=xJ.getOriginalSize(),n=xJ.getRect(),i=xJ.getOffset(),r=i.x+(t.width-n.width)/2,a=i.y-(t.height-n.height)/2;if(e){var o=iJ.x;iJ.x=n.x+n.height-iJ.y-iJ.height-a,iJ.y=o+n.y-r,iJ.y<0&&(iJ.height+=a)}else iJ.x+=n.x-r,iJ.y+=n.y+a;return e},_computeAlignmentOffset:function(){switch(lJ.length=0,AJ){case jq.LEFT:for(var e=0;e<pJ;++e)lJ.push(0);break;case jq.CENTER:for(var t=0,n=cJ.length;t<n;t++)lJ.push((hJ.width-cJ[t])/2);break;case jq.RIGHT:for(var i=0,r=cJ.length;i<r;i++)lJ.push(hJ.width-cJ[i])}if(mJ=hJ.height,CJ!==Wq.TOP){var a=hJ.height-dJ+PJ*this._getFontScale()-EJ*yJ;CJ===Wq.BOTTOM?mJ-=a:mJ-=a/2}},_setupBMFontOverflowMetrics:function(){var e=hJ.width,t=hJ.height;RJ===qq.RESIZE_HEIGHT&&(t=0),RJ===qq.NONE&&(e=0,t=0),wJ=e,DJ=t,uJ.width=e,uJ.height=t,OJ=e}},NJ=new fi(255,255,255,255),BJ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;NJ.set(e.color),NJ.a=255*t._uiProps.opacity,CV(t,0,e.renderData,NJ)},appendQuad:function(e,t,n,i,r,a,o){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=a-f*o,l[c+1].x=r+_*o,l[c+1].y=a-f*o,l[c+2].x=r,l[c+2].y=a,l[c+3].x=r+_*o,l[c+3].y=a}},updateColor:function(){}};Te(BJ,MJ);var FJ=null,LJ=Ee(MJ,{getAssemblerData:function(){return FJ||(FJ=new Pj(1024,1024)),FJ.getTexture()},_updateFontFamily:function(e){Rj.fontAtlas=FJ,Rj.fontFamily=this._getFontFamily(e);var t=e.getComponent(bK);t&&t.enabled?(Rj.isOutlined=!0,Rj.margin=t.width,Rj.out=t.color.clone(),Rj.out.a=t.color.a*e.color.a/255):(Rj.isOutlined=!1,Rj.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){Rj.fontDesc=this._getFontDesc(),Rj.color=e.color,Rj.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(Rj)},_getFontDesc:function(){return Rj.fontSize.toString()+"px "+Rj.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),zJ=new fi(255,255,255,255),UJ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;zJ.a=255*t._uiProps.opacity,CV(t,0,e.renderData,zJ)}},updateColor:function(){},appendQuad:BJ.appendQuad};Te(UJ,LJ);var GJ=Jq.Overflow,kJ=(1/255).toFixed(3),HJ=null,VJ=null,jJ=null,WJ="",qJ="",XJ=0,YJ=0,KJ=[],QJ=new ki,ZJ=0,JJ=0,$J=0,e$=new fi,t$="",n$=GJ.NONE,i$=!1,r$=null,a$=fi.BLACK.clone(),o$=null,s$=fi.BLACK.clone(),c$=new Vi,l$=ki.ZERO.clone(),u$=ki.ZERO.clone(),h$=Ni.ZERO.clone(),_$=Ni.ZERO.clone(),f$=0,p$=0,d$=!1,m$=!1,v$=!1,g$=["left","center","right"],y$={getAssemblerData:function(){return Jq._canvasPool.get()},resetAssemblerData:function(e){e&&Jq._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=XJ,t.setContentSize(QJ),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),HJ=null,VJ=null,jJ=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){t$=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(HJ=n.context,VJ=n.canvas,jJ=e.spriteFrame,qJ=e.string.toString(),XJ=e.fontSize,YJ=XJ,n$=e.overflow,u$.width=QJ.width=t.width,u$.height=QJ.height=t.height,p$=e.underlineHeight,ZJ=e.lineHeight,JJ=e.horizontalAlign,$J=e.verticalAlign,e$=e.color,e.node._uiProps.opacity,d$=e.isBold,m$=e.isItalic,v$=e.isUnderline,i$=n$!==GJ.NONE&&(n$===GJ.RESIZE_HEIGHT||e.enableWrapText),(r$=(r$=bK&&e.getComponent(bK))&&r$.enabled&&r$.width>0?r$:null)&&a$.set(r$.color),(o$=(o$=mZ&&e.getComponent(mZ))&&o$.enabled?o$:null)&&s$.set(o$.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(l$.width=l$.height=0,r$&&(e=t=n=i=r=r$.width,l$.width=l$.height=2*r),o$){var a=o$.blur+r,o=o$.offset.x,s=o$.offset.y;n=Math.max(n,-o+a),i=Math.max(i,o+a),e=Math.max(e,s+a),t=Math.max(t,-s+a)}if(m$){var c=YJ*Math.tan(.20943951);i+=c,l$.width+=c}c$.x=n,c$.y=e,c$.width=n+i,c$.height=e+t},_calculateFillTextStartPosition:function(){var e=0;JJ===jq.RIGHT?e=QJ.width-c$.width:JJ===jq.CENTER&&(e=(QJ.width-c$.width)/2);var t=this._getLineHeight()*(KJ.length-1),n=.87*XJ;if($J!==Wq.TOP){var i=t+c$.height+XJ-QJ.height;$J===Wq.BOTTOM?n-=i+=.13*XJ:n-=i/2}n+=0*XJ,h$.set(e+c$.x,n+c$.y)},_updateTexture:function(e){if(HJ&&VJ){HJ.clearRect(0,0,VJ.width,VJ.height),HJ.font=WJ,this._calculateFillTextStartPosition();var t=this._getLineHeight();HJ.lineJoin="round",r$?(HJ.fillStyle="rgba("+a$.r+", "+a$.g+", "+a$.b+", "+kJ+")",HJ.fillRect(0,0,VJ.width,VJ.height)):e._srcBlendFactor===Lr.SRC_ALPHA&&(HJ.fillStyle="rgba("+e$.r+", "+e$.g+", "+e$.b+", "+kJ+")",HJ.fillRect(0,0,VJ.width,VJ.height)),HJ.fillStyle="rgb("+e$.r+", "+e$.g+", "+e$.b+")";var n=h$.x,i=0;this._drawTextEffect(h$,t);for(var r=0;r<KJ.length;++r)i=h$.y+r*t,r$&&HJ.strokeText(KJ[r],n,i),HJ.fillText(KJ[r],n,i);o$&&(HJ.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===Jq.CacheMode.BITMAP){var t=e.ttfSpriteFrame;OV.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;jJ&&VJ&&(n=jJ instanceof zV?jJ.texture:jJ,0!==VJ.width&&0!==VJ.height&&(n.reset({width:VJ.width,height:VJ.height,mipmapLevel:1}),n.uploadData(VJ),jJ instanceof zV&&(jJ.rect=new Vi(0,0,VJ.width,VJ.height),jJ._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==Jq.CacheMode.BITMAP||!VJ||VJ.width<=0||VJ.height<=0)){var t=e.ttfSpriteFrame;OV.packToDynamicAtlas(e,t)}},_setupOutline:function(){HJ.strokeStyle="rgba("+a$.r+", "+a$.g+", "+a$.b+", "+a$.a/255+")",HJ.lineWidth=2*r$.width},_setupShadow:function(){HJ.shadowColor="rgba("+s$.r+", "+s$.g+", "+s$.b+", "+s$.a/255+")",HJ.shadowBlur=o$.blur,HJ.shadowOffsetX=o$.offset.x,HJ.shadowOffsetY=-o$.offset.y},_drawTextEffect:function(e,t){if(o$||r$||v$){var n=KJ.length>1&&o$,i=this._measureText(HJ,WJ),r=0,a=0;o$&&this._setupShadow(),r$&&this._setupOutline();for(var o=0;o<KJ.length;++o)r=e.x,a=e.y+o*t,n&&(r$&&HJ.strokeText(KJ[o],r,a),HJ.fillText(KJ[o],r,a)),v$&&(f$=i(KJ[o]),JJ===jq.RIGHT?_$.x=e.x-f$:JJ===jq.CENTER?_$.x=e.x-f$/2:_$.x=e.x,_$.y=a+YJ/8,HJ.fillRect(_$.x,_$.y,f$,p$));n&&(HJ.shadowColor="transparent")}},_updateLabelDimensions:function(){QJ.width=Math.min(QJ.width,2048),QJ.height=Math.min(QJ.height,2048);var e=!1;VJ.width!==QJ.width&&(VJ.width=QJ.width,e=!0),VJ.height!==QJ.height&&(VJ.height=QJ.height,e=!0),e&&(HJ.font=WJ),HJ.textAlign=g$[JJ],HJ.textBaseline="alphabetic"},_getFontDesc:function(){var e=XJ.toString()+"px ";return e+=t$,d$&&(e="bold "+e),m$&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===ZJ?XJ:ZJ*XJ/YJ)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=W(e);!(n=r()).done;){var a=gj(t,n.value,WJ);i.push(a)}return i},_measureText:function(e,t){return function(n){return gj(e,n,t)}},_calculateShrinkFont:function(e){if(HJ){var t=this._calculateParagraphLength(e,HJ),n=0,i=0,r=0;if(i$){var a=u$.width,o=u$.height;if(a<0||o<0)return;i=o+1;for(var s=0,c=0|XJ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){T(4003);break}XJ=l,WJ=this._getFontDesc(),HJ.font=WJ;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=gj(HJ,e[n],WJ);i+=xj(e[n],h,a,this._measureText(HJ,WJ)).length*u}i>o?c=l-1:s=l}0===s?T(4003):(XJ=s,WJ=this._getFontDesc(),HJ.font=WJ)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(QJ.width-c$.width)/r,f=QJ.height/i;XJ=YJ*Math.min(1,_,f)|0,WJ=this._getFontDesc(),HJ.font=WJ}}},_calculateWrapText:function(e){if(i$&&HJ){KJ=[];for(var t=u$.width,n=0;n<e.length;++n){var i=gj(HJ,e[n],WJ),r=xj(e[n],i,t,this._measureText(HJ,WJ));KJ=KJ.concat(r)}}},_calculateLabelFont:function(){if(HJ){var e=qJ.split("\n");switch(KJ=e,WJ=this._getFontDesc(),HJ.font=WJ,n$){case GJ.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=gj(HJ,e[i],WJ);t=t>r?t:r}n=(KJ.length+sj)*this._getLineHeight();var a=parseFloat(t.toFixed(2)),o=parseFloat(n.toFixed(2));QJ.width=a+c$.width,QJ.height=o+c$.height,u$.width=a+l$.width,u$.height=o+l$.height;break;case GJ.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case GJ.CLAMP:this._calculateWrapText(e);break;case GJ.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(KJ.length+sj)*this._getLineHeight();QJ.height=s+c$.height,u$.height=s+l$.height}}}},x$=fi.WHITE.clone(),S$={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)fi.toArray(n,x$,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,a=n[0],o=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=a.x*l.x,h=o.x*l.x,_=a.y*l.y,f=o.y*l.y,p=c.x,d=c.y,m=c.z,v=c.w,g=p*d,y=m*v,x=p*p-d*d,S=v*v-m*m,T=S+x,E=2*(g-y),A=S-x,C=2*(g+y),b=s.x,P=s.y;r[0]=T*u+E*_+b,r[1]=A*_+C*u+P,r[9]=T*h+E*_+b,r[10]=A*_+C*h+P,r[18]=T*u+E*f+b,r[19]=A*f+C*u+P,r[27]=T*h+E*f+b,r[28]=A*f+C*h+P;var R=t.bufferId,I=t.vertexOffset,w=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(R),O=w.indexOffset;D[O++]=I,D[O++]=I+1,D[O++]=I+2,D[O++]=I+2,D[O++]=I+1,D[O++]=I+3,w.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=t.data;s[0].x=-a,s[0].y=-o,s[1].x=i-a,s[1].y=r-o}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Te(S$,y$);var T$={getAssembler:function(e){var t=S$;return e.font instanceof aj?t=BJ:e.cacheMode===Jq.CacheMode.CHAR&&(t=UJ),t}};Jq.Assembler=T$;var E$=RK.FillType,A$=new wi,C$=new di,b$={updateRenderData:function(e){var t=e.spriteFrame;OV.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var a=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);a=a>1?1:a,this.updateUVs(e,i,a),this.updateVertexData(e,i,a)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,a=i.width,o=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0;switch(i.isRotated()?(c=s.x/a,l=(s.y+s.width)/o,u=_=c,p=m=(s.x+s.height)/a,f=v=l,h=d=s.y/o):(c=s.x/a,l=(s.y+s.height)/o,u=p=c,_=m=(s.x+s.width)/a,h=f=l,d=v=s.y/o),e.fillType){case E$.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=p+(m-p)*t,r[22]=d+(v-d)*t,r[30]=p+(m-p)*n,r[31]=d+(v-d)*n;break;case E$.VERTICAL:r[3]=u+(p-u)*t,r[4]=h+(d-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(p-u)*n,r[22]=h+(d-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:b(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,a=r.width,o=r.height,s=r.anchorX*a,c=r.anchorY*o,l=-s,u=-c,h=a-s,_=o-c,f=0;switch(e.fillType){case E$.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case E$.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:b(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=W(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(A$);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,a=0,o=0;o<4;o++){var s=i[o];di.transformMat4(C$,s,A$),r[a=o*n]=C$.x,r[a+1]=C$.y,r[a+2]=C$.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},P$=2*Math.PI,R$=1e-6,I$=new wi,w$=new di,D$=[new Ni,new Ni,new Ni,new Ni],O$=new Array(4),M$=new Array(8),N$=[new Ni,new Ni,new Ni,new Ni],B$=[new Ni,new Ni,new Ni,new Ni],F$=new Ni,L$=[new Ni,new Ni,new Ni,new Ni];function z$(e,t,n,i,r,a,o){var s=Math.sin(a);s=Math.abs(s)>R$?s:0;var c=Math.cos(a),l=0,u=0;if(0!==(c=Math.abs(c)>R$?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);o[0].x=e,o[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);o[2].x=t,o[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);o[3].x=f,o[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);o[1].x=p,o[1].y=n}}}function U$(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function G$(e,t,n,i,r){var a=O$,o=a[0],s=a[1],c=a[2],l=a[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,k$((n.x-o)/(c-o),(n.y-s)/(l-s),e,t),k$((i.x-o)/(c-o),(i.y-s)/(l-s),e,t+1),k$((r.x-o)/(c-o),(r.y-s)/(l-s),e,t+2)}function k$(e,t,n,i){var r=M$,a=r[0]+(r[2]-r[0])*e,o=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=a+(o-a)*t,l.v=s+(c-s)*t}for(var H$={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;OV.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var o=(r*=P$)+(a*=P$);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,a=t.anchorY*i,o=-r,s=-a,c=n-r,l=i-a,u=O$;u[0]=o,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=F$.x=Math.min(Math.max(0,h.x),1)*(c-o)+o,f=F$.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;D$[0].x=D$[3].x=o,D$[1].x=D$[2].x=c,D$[0].y=D$[1].y=s,D$[2].y=D$[3].y=l;for(var p,d=W(L$);!(p=d()).done;){var m=p.value;Ni.set(m,0,0)}_!==u[0]&&Ni.set(L$[0],3,0),_!==u[2]&&Ni.set(L$[2],1,2),f!==u[1]&&Ni.set(L$[1],0,1),f!==u[3]&&Ni.set(L$[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,a=0,o=0,s=0,c=M$;e.isRotated()?(r=i.x/t,a=(i.x+i.height)/t,o=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=a,c[3]=c[7]=s,c[1]=c[5]=o):(r=i.x/t,a=(i.x+i.width)/t,o=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=a,c[1]=c[3]=s,c[5]=c[7]=o)}(t),z$(O$[0],O$[2],O$[1],O$[3],F$,r,N$),z$(O$[0],O$[2],O$[1],O$[3],F$,r+a,B$);for(var s=0,c=0;c<4;++c){var l=L$[c];if(l)if(a>=P$)n.dataLength=s+3,G$(i,s,F$,D$[l.x],D$[l.y]),s+=3;else{var u=U$(F$,D$[l.x]),h=U$(F$,D$[l.y]);h<u&&(h+=P$),u-=P$,h-=P$;for(var _=0;_<3;++_)u>=o||(u>=r?(n.dataLength=s+3,G$(i,s,F$,D$[l.x],h>=o?B$[c]:D$[l.y]),s+=3):h>r&&(h<=o?(n.dataLength=s+3,G$(i,s,F$,N$[c],D$[l.y]),s+=3):(n.dataLength=s+3,G$(i,s,F$,N$[c],B$[c]),s+=3))),u+=P$,h+=P$}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=a+l;o.indexOffset+=n.indexCount,o.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(I$);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,a=t.vb,o=n.vertexCount,s=0,c=0;c<o;c++){var l=r[c];di.set(w$,l.x,l.y,0),di.transformMat4(w$,w$,I$),a[s+0]=w$.x,a[s+1]=w$.y,a[s+2]=w$.z,a[s+3]=l.u,a[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},V$=[],j$=0;j$<4;j$++)V$.push(new di);for(var W$={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;OV.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,a=e.node,o=r[0],s=r[1],c=a.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,p=c.m12,d=c.m13,m=o.x,v=s.x,g=o.y,y=s.y;if(f){var x=m+p,S=v+p,T=g+d,E=y+d;i[0]=x,i[1]=T,i[9]=S,i[10]=T,i[18]=x,i[19]=E,i[27]=S,i[28]=E}else{var A=l*m,C=l*v,b=u*m,P=u*v,R=h*g+p,I=h*y+p,w=_*g+d,D=_*y+d;i[0]=A+R,i[1]=b+w,i[9]=C+R,i[10]=P+w,i[18]=A+I,i[19]=b+D,i[27]=C+I,i[28]=P+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(i),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,a=n.height,o=n.anchorX*r,s=n.anchorY*a,c=0,l=0,u=0,h=0;if(e.trim)c=-o,l=-s,u=r-o,h=a-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),x=r/d,S=a/m,T=y.x+(d-v)/2,E=y.x-(d-v)/2;c=T*x-o,l=(y.y+(m-g)/2)*S-s,u=r+E*x-o,h=a+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,a=r.r/255,o=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=a,n[i+1]=o,n[i+2]=s,n[i+3]=c}},q$=new di,X$=new wi,Y$={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;OV.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,p=i/(c+l),d=r/(u+h);p=Number.isNaN(p)||p>1?1:p,d=Number.isNaN(d)||d>1?1:d,_=_<0?0:_,f=f<0?0:f,t[0].x=-a,t[0].y=-o,t[1].x=c*p-a,t[1].y=h*d-o,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-a,t[3].y=r-o},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;o[s++]=u,o[s++]=u+1,o[s++]=u+4,o[s++]=u+1,o[s++]=u+5,o[s++]=u+4}a.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(X$);for(var n=e.renderData,i=n.floatStride,r=n.data,a=t.vb,o=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];di.set(q$,u.x,c.y,0),di.transformMat4(q$,q$,X$),o=(4*s+l)*i,a[o++]=q$.x,a[o++]=q$.y,a[o++]=q$.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,a=3,o=0;o<16;o++)n[a]=r[o].u,n[a+1]=r[o].v,a+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},K$=[],Q$=0;Q$<4;Q$++)K$.push(new di);var Z$=new wi,J$={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),a=Math.abs(i.height),o=n.getRect(),s=n.insetLeft,c=n.insetRight,l=o.width-s-c,u=n.insetTop,h=n.insetBottom,_=o.height-u-h,f=r-s-c,p=a-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,p,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=a,s[c++]=a+1,s[c++]=a+2,s[c++]=a+1,s[c++]=a+3,s[c++]=a+2,a+=4,o.indexOffset+=6;o.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(Z$);var i=e.renderData,r=i.floatStride,a=i.data,o=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,p=u.rect,d=u.insetLeft,m=u.insetRight,v=p.width-d-m,g=u.insetTop,y=u.insetBottom,x=p.height-g-y,S=c-d-m,T=l-g-y;S=S>0?S:0,T=T>0?T:0;for(var E=0===v?S:S/v,A=0===x?T:T/x,C=Math.ceil(A+2),b=Math.ceil(E+2),P=0,R=0,I=0,w=0,D=0,O=0,M=C;O<M;++O){w=a[O].y,D=a[O+1].y;for(var N=0,B=b;N<B;++N){R=a[N].x,I=a[N+1].x,di.set(K$[0],R,w,0),di.set(K$[1],I,w,0),di.set(K$[2],R,D,0),di.set(K$[3],I,D,0);for(var F=0;F<4;F++){var L=K$[F];di.transformMat4(L,L,Z$);var z=F*r;o[P+z]=L.x,o[P+z+1]=L.y,o[P+z+2]=L.z}P+=4*r}}P=0;for(var U=r,G=2*r,k=3*r,H=4*r,V=0,j=0,W=[],q=[],X=0,Y=C;X<Y;++X){j=T>x?T>=X*x?1:A%1:A;for(var K=0,Q=b;K<Q;++K){V=S>v?S>=K*v?1:E%1:E;var Z=P+3,J=Z+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<C-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===C-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[0].v):K<b-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[1].v):K===b-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=_[0]):K<b-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=f[1].u):K===b-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<C-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===C-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),o[Z]=W[0],o[J]=q[0],o[Z+U]=W[1],o[J+U]=q[1],o[Z+G]=W[2],o[J+G]=q[2],o[Z+k]=W[3],o[J+k]=q[3],P+=H}}},updateVerts:function(e,t,n,i,r){var a,o,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),T=s.height/(g+y)>1?1:s.height/(g+y);a=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,o=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var E=0;E<=r;E++)0===E?c[E].x=-f:E>0&&E<r?c[E].x=1===E?d*S+Math.min(v,t)-f:v>0?E===r-1?d+a+v*(E-2)-f:d+Math.min(v,t)+v*(E-2)-f:d+t-f:E===r&&(c[E].x=Math.min(d+t+m,h)-f);for(var A=0;A<=i;A++)0===A?c[A].y=-p:A>0&&A<i?c[A].y=1===A?y*T+Math.min(x,n)-p:x>0?A===i-1?y+o+(A-2)*x-p:y+Math.min(x,n)+(A-2)*x-p:y+n-p:A===i&&(c[A].y=Math.min(y+n+g,_)-p)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},$$=RK.Type,e0=RK.FillType,t0={getAssembler:function(e){var t=W$,n=e;switch(n.type){case $$.SLICED:t=Y$;break;case $$.TILED:t=J$;break;case $$.FILLED:t=n.fillType===e0.RADIAL?H$:b$}return t}};RK.Assembler=t0;var n0=DW.sharedManager,i0={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===lY.IMAGE_STENCIL&&(W$.updateRenderData(e),W$.updateColor(e))},fillBuffers:function(e,t){(e.type!==lY.IMAGE_STENCIL||e.spriteFrame)&&(n0.pushMask(e),t.finishMergeBatches(),function(e,t){n0.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(n0.enterLevel(e),e.type===lY.IMAGE_STENCIL){W$.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),n0.enableMask())}},r0={fillBuffers:function(){n0.exitMask()}},a0={getAssembler:function(){return i0}},o0={getAssembler:function(){return r0}};pY.Assembler=a0,pY.PostAssembler=o0;var s0=function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=Mj(t),this._initVDataCount,this._floatsPerVertex,w(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return A(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=this.vertexOffset+e,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=ch.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],a=new Float32Array(this.vData.buffer,0,t>>2),o=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(a),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(o)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(ch.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,a=Uint16Array.BYTES_PER_ELEMENT,o=e.createBuffer(new Ta(Ar.VERTEX|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,r,r));i=e.createBuffer(new Ta(Ar.INDEX|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,a,a)),n=[o],this._iaInfo=new ka(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},B(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}(),c0=[lD.EventType.MOUSE_DOWN,lD.EventType.MOUSE_MOVE,lD.EventType.MOUSE_UP,lD.EventType.MOUSE_WHEEL],l0=[lD.EventType.TOUCH_START,lD.EventType.TOUCH_MOVE,lD.EventType.TOUCH_END,lD.EventType.TOUCH_CANCEL],u0=(new(function(){function e(){this.priority=$w.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],uD._registerEventDispatcher(this),Pw.callbacksInvoker.on(Hb.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),Pw.callbacksInvoker.on(Hb.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),Pw.callbacksInvoker.on(Hb.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return l0.includes(t)?this.dispatchEventTouch(e):!c0.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),ke.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(ke.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),ke.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var a=t[r];if(a.isEnabled&&a.shouldHandleEventMouse&&a._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,a=0;a<n;++a){var o=t[a];if(o.isEnabled&&o.shouldHandleEventTouch)if(e.type===Gb.TOUCH_START){if(o._handleEventTouch(e)){if(o.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(o.claimedTouchIdList.length>0){var s=o.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(o._handleEventTouch(e),e.type!==Gb.TOUCH_END&&e.type!==Gb.TOUCH_CANCEL||ke.array.removeAt(o.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,a=0;a<r;++a)this.removePointerEventProcessor(i[a]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var a=r._uiProps.uiTransformComp;i.cachedCameraPriority=a.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,a=i,o=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=a.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(o=!0)&&i:r&&r.parent,a=null===(null===(h=a)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(o=!0)&&n:a&&a.parent}if(r._id===a._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,p=a?a.getSiblingIndex():0;return o?f-p:p-f},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=Mj(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},B(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),h0=new je((function(){return{offset:0,length:0}}),32),_0=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},f0=function(e){function t(n,i,r,a){var o;return(o=e.call(this,n,i)||this)._freeLists=[],o._vCount=0,o._iCount=0,o._vCount=r||Math.floor(1024*$e.BATCHER2D_MEM_INCREMENT/o._vertexFormatBytes),o._iCount=a||o._vCount*t.IB_SCALE,o._allocateBuffer(),o}L(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)h0.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,a=0,o=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],a=c,o=l;break}if(s)break}if(s||(a=this._allocateBuffer(),(r=this._buffers[a])&&r.checkCapacity(e,t)&&(o=0,s=this._freeLists[a][o])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(a,o,s,i),new _0(this,a,u,h,t)}return A(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var a=!1,o=0,s=null,c=t[o];c&&c.offset<i;)s=c,c=t[++o];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(o,1),h0.free(c),c=null),a=!0),!a&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=h0.alloc();l.offset=i,l.length=r,t.splice(o,0,l)}a=!0}if(a)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=h0.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,a=n.offset+i,o=this._buffers[e];o.byteOffset<a&&(o.byteOffset=a),I(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),h0.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){I(this._buffers.length===this._freeLists.length,9003);var e=new s0,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=h0.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(u0);f0.IB_SCALE=4;var p0,d0=new Ja(null),m0=new wi,v0=function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Cg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new y0,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new qe(64),this._drawBatchPool=new je((function(){return new pZ}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),DW.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var a=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var o=this._batches.array[t];if(o.model)for(var s=o.model.subModels,c=0;c<s.length;c++)s[c].priority=a++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);r.addBatch(o)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),DW.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=Dj);var t=e===Dj?36:Nj(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new f0(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var a,o=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;o=t.dataHash,a=t.material,s=t.chunk.bufferId}e.stencilStage=DW.sharedManager.stage;var c=e.stencilStage;this._currHash===o&&0!==o&&this._currMaterial===a&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var a,o;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(a=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=DW.sharedManager.stage,o=null!==e.customMaterial?DW.sharedManager.getStencilStage(e.stencilStage,i):DW.sharedManager.getStencilStage(e.stencilStage),s=DW.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,o,s,a,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var r;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var a=0;n&&(e.stencilStage!==Kj.ENABLED&&e.stencilStage!==Kj.DISABLED||(e.stencilStage=DW.sharedManager.stage),r=DW.sharedManager.getStencilStage(e.stencilStage,n),a=DW.sharedManager.getStencilHash(e.stencilStage));var o=i.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var s=0;s<t.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=t.subModels[s];c.visFlags=e.node.layer,c.model=t,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,a,null,0,l.patches,this),c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=l.descriptorSet,this._batches.push(c)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var a=this._currBID,o=r.getMeshBuffer(a);if(!o)return;var s=o.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,o.indexOffset,o.setDirty(),(n=o.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=o.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?DW.sharedManager.getStencilStage(e.stencilStage,t):DW.sharedManager.getStencilStage(e.stencilStage),u=DW.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,a=this._pOpacity,o=a,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=o*=s*i.localOpacity,i._opacity=o,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,a=e.vertexFormat,o=e.chunk.vb,s=0,c=0;c<a.length;++c){if(n=a[c],(i=lo[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~Yn(Math.round(255*t),0,255),u=s;u<o.length;u+=r)o[u]=(4294967040&o[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<o.length;h+=r)o[h]=t;s+=i.size>>2}}(r.renderData,o);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=a,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},B(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}(),g0=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=i.director.root.device;this._localData=new Float32Array(ud.COUNT),this._localBuffer=e.createBuffer(new Ta(Ar.UNIFORM|Ar.TRANSFER_DST,Pr.HOST|Pr.DEVICE,ud.SIZE,ud.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=i.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,d0.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(d0),this._descriptorSet.bindBuffer(ud.BINDING,this._localBuffer);var n=Hp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;wi.toArray(this._localData,t,ud.MAT_WORLD_OFFSET),wi.inverseTranspose(m0,t);var n=wi.determinant(m0),i=1/Math.sqrt(n);wi.multiplyScalar(m0,m0,i),wi.toArray(this._localData,m0,ud.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},B(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),y0=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new je((function(){return new g0}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=i.director.root;if(e.useLocalData){for(var r=this._localDescriptorSetCache,a=0,o=r.length;a<o;a++){var s=r[a];if(s.equals(e.useLocalData,e.textureHash,e.samplerHash))return s.descriptorSet}var c=this._localCachePool.alloc();return c.initialize(e),this._localDescriptorSetCache.push(c),c.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);d0.layout=e.passes[0].localSetLayout;var l=n.device.createDescriptorSet(d0),u=Hp.SAMPLER_SPRITE;return l.bindTexture(u,e.texture),l.bindSampler(u,e.sampler),l.update(),this._descriptorSetCache.set(t,l),this._dsCacheHashByTexture.set(e.textureHash,t),l},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();i.internal.Batcher2D=v0,Fn(s0.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}}))),Nn(s0.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),Bn(s0.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),Nn(v0.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),Bn(tW.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),Nn(tW.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),L((function(e){var t;return t=p0.call(this,e)||this,A(9006),t}),p0=tW);var x0,S0,T0,E0=null,A0=-1,C0="BES bswy:->@123丁ぁᄁ",b0=Object.create(null),P0=[],R0=3e3;function I0(){for(var e=!0,t=Date.now(),n=P0.length-1;n>=0;n--){var i=P0[n],r=i.fontFamilyName;if(t-i.startTime>R0)A(4933,r),i.onComplete(null,r),P0.splice(n,1);else{var a=i.refWidth,o="40px "+r;E0.font=o,a!==gj(E0,C0,o)?(P0.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(A0),A0=-1)}function w0(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(b0[i])n(null,i);else{if(!E0){var r=document.createElement("canvas");r.width=100,r.height=100,E0=r.getContext("2d")}var a=gj(E0,C0,"40px "+i),o=document.createElement("style");o.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',o.textContent=s+"}",document.body.appendChild(o);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===x0)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);x0=e?parseInt(e[1],10)>42:!t}else x0=!1;return x0}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=R0?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,a=new Promise((function(e,t){r=setTimeout(t,R0)}));Promise.race([a,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){A(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:a,onComplete:n,startTime:Date.now()};P0.push(u),-1===A0&&(A0=setInterval(I0,100))}b0[i]=o}}function D0(e,t,n,i){var r=new tj;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}MN.register({".font":w0,".eot":w0,".ttf":w0,".woff":w0,".svg":w0,".ttc":w0}),GN.register({".font":D0,".eot":D0,".ttf":D0,".woff":D0,".svg":D0,".ttc":D0}),i.UI={MeshBuffer:s0,spriteAssembler:t0,graphicsAssembler:tJ,labelAssembler:T$,RenderData:eW,MeshRenderData:tW};var O0,M0,N0,B0,F0,L0,z0,U0,G0,k0,H0,V0=nl("dragonBones.CCTextureAtlasData")(S0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._renderTexture=null,t}L(t,e),t.toString=function(){return"[class dragonBones.CCTextureAtlasData]"};var n=t.prototype;return n.createTexture=function(){return Kk.borrowObject(j0)},n._onClear=function(){e.prototype._onClear.call(this),this.renderTexture=null},B(t,[{key:"renderTexture",get:function(){return this._renderTexture},set:function(e){if(this._renderTexture=e,e)for(var t in this.textures){var n=this.textures[t];if(!n.spriteFrame){var i=null;n.rotated?i=new Vi(n.region.x,n.region.y,n.region.height,n.region.width):(i=new Vi(n.region.x,n.region.y,n.region.width,n.region.height),n.spriteFrame=new zV,n.spriteFrame.texture=e,n.spriteFrame.rect=i)}}else for(var r in this.textures)this.textures[r].spriteFrame=null}}]),t}(RH))||S0,j0=nl("dragonBones.CCTextureData")(T0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).spriteFrame=null,t}return L(t,e),t.toString=function(){return"[class dragonBones.CCTextureData]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this.spriteFrame=null},t}(IH))||T0,W0=nl("dragonBones.CCSlot")(O0=function(e){function t(){var t;return(t=e.call(this)||this)._localVertices=void 0,t._indices=void 0,t._matrix=void 0,t._worldMatrix=void 0,t._worldMatrixDirty=void 0,t._color=void 0,t._localVertices=[],t._indices=[],t._matrix=new wi,t._worldMatrix=new wi,t._worldMatrixDirty=!0,t._visible=!1,t._color=new fi,t}L(t,e),t.toString=function(){return"[class dragonBones.CCSlot]"};var n=t.prototype;return n.getTexture=function(){return this._textureData?this._textureData.spriteFrame.texture:null},n.calculWorldMatrix=function(){var e=this._armature._parent;e?this._mulMat(this._worldMatrix,e._worldMatrix,this._matrix):wi.copy(this._worldMatrix,this._matrix),this._worldMatrixDirty=!1},n._onClear=function(){e.prototype._onClear.call(this),this._localVertices.length=0,this._indices.length=0,wi.identity(this._matrix),wi.identity(this._worldMatrix),this._worldMatrixDirty=!0,this._color=new fi,this._visible=!1},n._onUpdateDisplay=function(){},n._initDisplay=function(){},n._addDisplay=function(){this._visible=!0},n._replaceDisplay=function(){},n._removeDisplay=function(){this._visible=!1},n._disposeDisplay=function(){},n._updateVisible=function(){this._visible=this.parent.visible},n._updateGlueMesh=function(){},n._updateZOrder=function(){},n._updateBlendMode=function(){if(this._childArmature)for(var e=this._childArmature.getSlots(),t=0,n=e.length;t<n;t++){var i=e[t];i._blendMode=this._blendMode,i._updateBlendMode()}},n._updateColor=function(){var e=this._color;e.r=255*this._colorTransform.redMultiplier,e.g=255*this._colorTransform.greenMultiplier,e.b=255*this._colorTransform.blueMultiplier,e.a=255*this._colorTransform.alphaMultiplier},n._updateFrame=function(){this._indices.length=0;var e=this._indices,t=this._localVertices,n=0,i=0,r=this._textureData;if(this._display&&!(this._displayIndex<0)&&r&&r.spriteFrame){var a=r.spriteFrame.texture,o=a.width,s=a.height,c=r.region;if(0!==o&&0!==s){var l=null!==this._deformVertices&&this._display===this._meshDisplay?this._deformVertices.verticesData:null;if(l){var u=l.data,h=u.intArray,_=u.floatArray,f=h[l.offset+pV.MeshVertexCount],p=h[l.offset+pV.MeshTriangleCount],d=h[l.offset+pV.MeshFloatOffset];d<0&&(d+=65536);for(var m=d+2*f,v=this._armature._armatureData.scale,g=0,y=2*f;g<y;g+=2)t[i++]=_[d+g]*v,t[i++]=-_[d+g+1]*v,l.rotated?(t[i++]=(c.x+(1-_[m+g])*c.width)/o,t[i++]=(c.y+_[m+g+1]*c.height)/s):(t[i++]=(c.x+_[m+g]*c.width)/o,t[i++]=(c.y+_[m+g+1]*c.height)/s);for(var x=0;x<3*p;++x)e[n++]=h[l.offset+pV.MeshVertexIndices+x];t.length=i,e.length=n,l.weight&&this._identityTransform()}else{var S=c.x/o,T=(c.y+c.height)/s,E=(c.x+c.width)/o,A=c.y/s;t[i++]=0,t[i++]=0,t[i++]=S,t[i++]=T,t[i++]=c.width,t[i++]=0,t[i++]=E,t[i++]=T,t[i++]=0,t[i++]=c.height,t[i++]=S,t[i++]=A,t[i++]=c.width,t[i++]=c.height,t[i++]=E,t[i++]=A,e[0]=0,e[1]=1,e[2]=2,e[3]=1,e[4]=3,e[5]=2,t.length=i,e.length=6}this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0}else console.error("SpriteFrame "+r.spriteFrame.name+" incorrect size "+o+" x "+s)}},n._updateMesh=function(){var e=this._armature._armatureData.scale,t=this._deformVertices.vertices,n=this._deformVertices.bones,i=this._deformVertices.verticesData,r=i.weight,a=t.length>0&&i.inheritDeform,o=this._localVertices;if(r){var s=i.data,c=s.intArray,l=s.floatArray,u=c[i.offset+pV.MeshVertexCount],h=c[r.offset+pV.WeigthFloatOffset];h<0&&(h+=65536);for(var _=0,f=r.offset+pV.WeigthBoneIndices+n.length,p=h,d=0,m=0;_<u;_++,m+=4){for(var v=c[f++],g=0,y=0,x=0;x<v;++x){var S=n[c[f++]];if(null!==S){var T=S.globalTransformMatrix,E=l[p++],A=l[p++]*e,C=l[p++]*e;a&&(A+=t[d++],C+=t[d++]),g+=(T.a*A+T.c*C+T.tx)*E,y+=(T.b*A+T.d*C+T.ty)*E}}o[m]=g,o[m+1]=-y}}else if(a){var b=this._parent._boneData.type!==mV.Bone,P=i.data,R=P.intArray,I=P.floatArray,w=R[i.offset+pV.MeshVertexCount],D=R[i.offset+pV.MeshFloatOffset];D<0&&(D+=65536);for(var O=0,M=w,N=0;O<M;O++,N+=4){var B=I[D+2*O]*e+t[2*O],F=I[D+2*O+1]*e+t[2*O+1];if(b){var L=this._parent._getGlobalTransformMatrix(B,F);o[N]=L.a*B+L.c*F+L.tx,o[N+1]=-L.b*B+L.d*F+L.ty}else o[N]=B,o[N+1]=-F}}r&&this._identityTransform()},n._identityTransform=function(){var e=this._matrix;e.m00=1,e.m01=0,e.m04=-0,e.m05=-1,e.m12=0,e.m13=0,this._worldMatrixDirty=!0},n._updateTransform=function(){var e=this._matrix;e.m00=this.globalTransformMatrix.a,e.m01=this.globalTransformMatrix.b,e.m04=-this.globalTransformMatrix.c,e.m05=-this.globalTransformMatrix.d,this._childArmature?(e.m12=this.globalTransformMatrix.tx,e.m13=this.globalTransformMatrix.ty):(e.m12=this.globalTransformMatrix.tx-(this.globalTransformMatrix.a*this._pivotX-this.globalTransformMatrix.c*this._pivotY),e.m13=this.globalTransformMatrix.ty-(this.globalTransformMatrix.b*this._pivotX-this.globalTransformMatrix.d*this._pivotY)),this._worldMatrixDirty=!0},n.updateWorldMatrix=function(){if(this._armature){var e=this._armature._parent;if(e&&e.updateWorldMatrix(),this._worldMatrixDirty){this.calculWorldMatrix();var t=this.childArmature;if(!t)return;for(var n=t.getSlots(),i=0,r=n.length;i<r;i++){var a=n[i];a&&(a._worldMatrixDirty=!0)}}}},n._mulMat=function(e,t,n){var i=t.m00,r=t.m01,a=t.m04,o=t.m05,s=t.m12,c=t.m13,l=n.m00,u=n.m01,h=n.m04,_=n.m05,f=n.m12,p=n.m13;0!==r||0!==a?(e.m00=l*i+u*a,e.m01=l*r+u*o,e.m04=h*i+_*a,e.m05=h*r+_*o,e.m12=i*f+a*p+s,e.m13=r*f+o*p+c):(e.m00=l*i,e.m01=u*o,e.m04=h*i,e.m05=_*o,e.m12=i*f+s,e.m13=o*p+c)},t}(BH))||O0,q0=nl("dragonBones.CCArmatureDisplay")(M0=function(e){function t(){var t;return(t=e.call(this)||this).shouldAdvanced=!1,t._ccNode=null,t._ccComponent=null,t._eventTarget=void 0,t._armature=null,t._eventTarget=new _n,t}L(t,e);var n=t.prototype;return n.hasEvent=function(){return console.warn("Method not implemented."),!1},n.addEvent=function(){console.warn("Method not implemented.")},n.removeEvent=function(){console.warn("Method not implemented.")},n.setEventTarget=function(e){this._eventTarget=e},n.getRootDisplay=function(){var e,t=this._armature._parent;if(!t)return this;for(;t;)e=t,t=t._armature._parent;return e._armature.display},n.convertToRootSpace=function(e){var t=this._armature._parent;if(!t)return e;t.updateWorldMatrix();var n=t._worldMatrix,i=new di(0,0);return i.x=e.x*n.m00+e.y*n.m04+n.m12,i.y=e.x*n.m01+e.y*n.m05+n.m13,i},n.convertToWorldSpace=function(e){var t,n=this.convertToRootSpace(e),i=this.getRootNode();return null==i||null===(t=i._uiProps.uiTransformComp)||void 0===t?void 0:t.convertToWorldSpaceAR(n)},n.getRootNode=function(){var e=this.getRootDisplay();return e&&e._ccNode},n.dbInit=function(e){this._armature=e},n.dbClear=function(){this._armature=null},n.dbUpdate=function(){this._ccComponent&&this._ccComponent.markForUpdateRenderData()},n.advanceTimeBySelf=function(e){this.shouldAdvanced=!!e},n.hasDBEventListener=function(e){return this._eventTarget.hasEventListener(e)},n.addDBEventListener=function(e,t,n){this._eventTarget.on(e,t,n)},n.removeDBEventListener=function(e,t,n){this._eventTarget.off(e,t,n)},n.dispatchDBEvent=function(e,t){this._eventTarget.emit(e,t)},B(t,[{key:"node",get:function(){return this}}]),t}(pH))||M0,X0=nl("CCFactory")((F0=B0=function(e){function t(){var t;(t=e.call(this)||this).id=void 0,t.uuid=void 0,t._slots=void 0;var n=new q0;return t._dragonBones=new Yk(n),VM.getScheduler()&&(kM.on(GM.EVENT_RESTART,t.onRestart,V(t)),t.initUpdate()),t.id=t.uuid="CCFactory",t}L(t,e),t.getInstance=function(){return t._factory||(t._factory=new t),t._factory};var n=t.prototype;return n.onRestart=function(){t._factory=null},n.initUpdate=function(){FM.enableForTarget(this),VM.getScheduler().scheduleUpdate(this,IM.Priority.HIGH,!1)},n.update=function(e){this._dragonBones.advanceTime(e)},n.getDragonBonesDataByRawData=function(e){return(e instanceof ArrayBuffer?_V._binaryParser:this._dataParser).parseDragonBonesData(e,1)},n.buildArmatureDisplay=function(e,t,n,i){var r=this.buildArmature(e,t,n,i);return r?r._display:null},n.createArmatureNode=function(e,t,n){var i=(n=n||new qC).getComponent("dragonBones.ArmatureDisplay");return i||(i=n.addComponent("dragonBones.ArmatureDisplay")),n.name=t,i._armatureName=t,i._dragonAsset=e.dragonAsset,i._dragonAtlasAsset=e.dragonAtlasAsset,i._init(),i},n._buildTextureAtlasData=function(e,t){return e?e.renderTexture=t:e=Kk.borrowObject(V0),e},n._sortSlots=function(){for(var e=this._slots,t=[],n=0,i=e.length;n<i;n++){for(var r=e[n],a=r._zOrder,o=!1,s=t.length-1;s>=0;s--)if(a>=t[s]._zOrder){t.splice(s+1,0,r),o=!0;break}o||t.unshift(r)}this._slots=t},n._buildArmature=function(e){var t=Kk.borrowObject(DH);t._skinData=e.skin,t._animation=Kk.borrowObject(GH),t._animation._armature=t,t._animation.animations=e.armature.animations,t._isChildArmature=!1;var n=new q0;return t.init(e.armature,n,n,this._dragonBones),t},n._buildSlot=function(e,t,n){var i=Kk.borrowObject(W0),r=i;return i.init(t,n,r,r),i},n.getDragonBonesDataByUUID=function(e){for(var t in this._dragonBonesDataMap)if(-1!==t.indexOf(e))return this._dragonBonesDataMap[t];return null},n.removeDragonBonesDataByUUID=function(e,t){for(var n in void 0===t&&(t=!0),this._dragonBonesDataMap)-1!==n.indexOf(e)&&(t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[n]),delete this._dragonBonesDataMap[n])},t}(_V),B0._factory=null,N0=F0))||N0,Y0=1/60,K0=[],Q0=[],Z0=0,J0=0,$0=0,e1=null,t1=null,n1=0,i1=0,r1=0,a1=0,o1=0,s1=function(){function e(){this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this.isCompleted=!1,this._frameIdx=-1,this._armatureInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}var t=e.prototype;return t.init=function(e,t){this._inited=!0,this._armatureInfo=e,this._animationName=t},t.clear=function(){this._inited=!1;for(var e=0,t=this.frames.length;e<t;e++)this.frames[e].segments.length=0;this.invalidAllFrame()},t.begin=function(){if(this._invalid){var e=this._armatureInfo,t=e.curAnimationCache;t&&t!==this&&(this._privateMode?t.invalidAllFrame():t.updateToFrame()),e.armature.animation.play(this._animationName,1),e.curAnimationCache=this,this._invalid=!1,this._frameIdx=-1,this.totalTime=0,this.isCompleted=!1}},t.end=function(){this._needToUpdate()||(this._armatureInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0)},t._needToUpdate=function(e){return!this._armatureInfo.armature.animation.isCompleted&&this.totalTime<30&&(void 0===e||this._frameIdx<e)},t.updateToFrame=function(e){if(this._inited&&(this.begin(),this._needToUpdate(e))){var t=this._armatureInfo.armature;do{t.advanceTime(Y0),this._frameIdx++,this.updateFrame(t,this._frameIdx),this.totalTime+=Y0}while(this._needToUpdate(e));this.end()}},t.isInited=function(){return this._inited},t.isInvalid=function(){return this._invalid},t.invalidAllFrame=function(){this.isCompleted=!1,this._invalid=!0},t.updateAllFrame=function(){this.invalidAllFrame(),this.updateToFrame()},t.enableCacheAttachedInfo=function(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())},t.updateFrame=function(e,t){$0=0,Z0=0,J0=0,e1=null,t1=null,n1=0,i1=0,r1=0,a1=0,o1=0,this.frames[t]=this.frames[t]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};var n=this.frames[t],i=this._tempSegments=n.segments,r=this._tempColors=n.colors,a=this._tempBoneInfos=n.boneInfos;this._traverseArmature(e,1),a1>0&&(r[a1-1].vfOffset=$0),r.length=a1,a.length=Z0;var o=r1-1;if(o>=0)if(i1>0){var s=i[o];s.indexCount=i1,s.vfCount=9*n1,s.vertexCount=n1,i.length=r1}else i.length=r1-1;if(0!==i.length){var c,l=n.vertices,u=$0/5,h=9*u;(!l||l.length<$0)&&(l=n.vertices=new Float32Array(h));for(var _=0,f=0;_<h;)l[_]=K0[f++],l[_+1]=K0[f++],l[_+3]=K0[f++],l[_+4]=K0[f++],c=K0[f++],l[_+5]=(255&c)/255,l[_+6]=(c>>8&255)/255,l[_+7]=(c>>16&255)/255,l[_+8]=(c>>24&255)/255,_+=9;var p=n.indices;(!p||p.length<J0)&&(p=n.indices=new Uint16Array(J0));for(var d=0;d<J0;d++)p[d]=Q0[d];n.vertices=l,n.indices=p,this.maxVertexCount=u>this.maxVertexCount?u:this.maxVertexCount,this.maxIndexCount=p.length>this.maxIndexCount?p.length:this.maxIndexCount}},t._traverseArmature=function(e,t){var n,i,r,a,o,s,c,l,u,h=this._tempColors,_=this._tempSegments,f=this._tempBoneInfos,p=e._slots,d=e._bones;if(this._enableCacheAttachedInfo)for(var m=0,v=d.length;m<v;m++,Z0++){var g=d[m],y=f[Z0];y||(y=f[Z0]={globalTransformMatrix:new Qk});var x=g.globalTransformMatrix;y.globalTransformMatrix.copyFrom(x)}for(var S=0,T=p.length;S<T;S++)if((r=p[S])._visible&&r._displayData)if(r.updateWorldMatrix(),o=r._color,r.childArmature)this._traverseArmature(r.childArmature,t*o.a/255);else if(c=r.getTexture()){e1===c.nativeUrl&&t1===r._blendMode||(e1=c.nativeUrl,t1=r._blendMode,(l=r1-1)>=0&&(i1>0?((u=_[l]).indexCount=i1,u.vertexCount=n1,u.vfCount=9*n1):r1--),_[r1]={tex:c,blendMode:r._blendMode,indexCount:0,vertexCount:0,vfCount:0},r1++,i1=0,n1=0),s=(o.a*t<<24>>>0)+(o.b<<16)+(o.g<<8)+o.r,o1!==s&&(o1=s,a1>0&&(h[a1-1].vfOffset=$0),h[a1++]={r:o.r,g:o.g,b:o.b,a:o.a*t,vfOffset:0}),n=r._localVertices,i=r._indices,a=r._worldMatrix;for(var E=0,A=n.length;E<A;)L0=n[E++],z0=n[E++],K0[$0++]=L0*a.m00+z0*a.m04+a.m12,K0[$0++]=L0*a.m01+z0*a.m05+a.m13,K0[$0++]=n[E++],K0[$0++]=n[E++],K0[$0++]=s;for(var C=0,b=i.length;C<b;C++)Q0[J0++]=n1+i[C];i1+=i.length,n1+=n.length/4}},e}(),c1=function(){function e(){this._privateMode=!1,this._animationPool={},this._armatureCache={}}var t=e.prototype;return t.enablePrivateMode=function(){this._privateMode=!0},t.dispose=function(){for(var e in this._armatureCache){var t=this._armatureCache[e];if(t){var n=t.armature;n&&n.dispose()}}this._armatureCache={},this._animationPool={}},t._removeArmature=function(e){var t=this._armatureCache[e],n=t.animationsCache;for(var i in n){var r=n[i];r&&(this._animationPool[e+"#"+i]=r,r.clear())}var a=t.armature;a&&a.dispose(),delete this._armatureCache[e]},t.resetArmature=function(e){for(var t in this._armatureCache)-1!==t.indexOf(e)&&this._removeArmature(t)},t.getArmatureCache=function(t,n,i){var r,a=this._armatureCache[n];if(a)r=a.armature;else{var o=X0.getInstance().buildArmatureDisplay(t,n,"",i);if(!o||!o._armature)return null;if(r=o._armature,!e.canCache(r))return r.dispose(),null;this._armatureCache[n]={armature:r,animationsCache:{},curAnimationCache:null}}return r},t.getAnimationCache=function(e,t){var n=this._armatureCache[e];return n?n.animationsCache[t]:null},t.initAnimationCache=function(e,t){if(!t)return null;var n=this._armatureCache[e],i=n&&n.armature;if(!i)return null;if(!i.animation.hasAnimation(t))return null;var r=n.animationsCache,a=r[t];if(!a){var o=e+"#"+t;(a=this._animationPool[o])?delete this._animationPool[o]:(a=new s1)._privateMode=this._privateMode,a.init(n,t),r[t]=a}return a},t.invalidAnimationCache=function(e){var t=this._armatureCache[e];if(t&&t.armature){var n=t.animationsCache;for(var i in n)n[i].invalidAllFrame()}},t.updateAnimationCache=function(e,t){if(t){var n=this.initAnimationCache(e,t);if(!n)return;n.updateAllFrame()}else{var i=this._armatureCache[e];if(!i||!i.armature)return;var r=i.animationsCache;for(var a in r)r[a].updateAllFrame()}},e.canCache=function(e){for(var t=e._slots,n=0,i=t.length;n<i;n++)if(t[n].childArmature)return!1;return!0},e}();c1.FrameTime=Y0,c1.sharedCache=new c1;var l1,u1,h1,_1,f1,p1,d1,m1,v1,g1=nl("dragonBones.DragonBonesAsset")((H0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_dragonBonesJson",k0,V(t)),t._factory=null,t._dragonBonesJsonData=void 0,t._armaturesEnum=null,t}L(t,e);var n=t.prototype;return n.constructctor=function(){this.reset()},n.createNode=function(e){var t=new qC(this.name);return t.addComponent("dragonBones.ArmatureDisplay").dragonAsset=this,e(null,t)},n.reset=function(){this._clear()},n.init=function(e,t){this._factory=e,!this._dragonBonesJsonData&&this.dragonBonesJson&&(this._dragonBonesJsonData=JSON.parse(this.dragonBonesJson));var n;if(n=this._dragonBonesJsonData?this._dragonBonesJsonData:this._nativeAsset,!this._uuid){var i=this._factory.getDragonBonesDataByRawData(n);i?this._uuid=i.name:console.warn("dragonbones name is empty")}var r=this._uuid+"#"+t;return this._factory.getDragonBonesData(r)||this._factory.parseDragonBonesData(n instanceof ArrayBuffer?n:n.buffer instanceof ArrayBuffer?n.buffer:n,r),r},n.getArmatureEnum=function(){if(this._armaturesEnum)return this._armaturesEnum;this.init();var e=this._factory.getDragonBonesDataByUUID(this._uuid);if(e){for(var t=e.armatureNames,n={},i=0;i<t.length;i++)n[t[i]]=i;return this._armaturesEnum=Ye(n)}return null},n.getAnimsEnum=function(e){this.init();var t=this._factory.getDragonBonesDataByUUID(this._uuid);if(t){var n=t.getArmature(e);if(!n)return null;var i={"<None>":0},r=n.animations,a=0;for(var o in r)r.hasOwnProperty(o)&&(i[o]=a+1,a++);return Ye(i)}return null},n.destroy=function(){return this._clear(),e.prototype.destroy.call(this)},n._clear=function(){this._factory&&(c1.sharedCache.resetArmature(this._uuid),this._factory.removeDragonBonesDataByUUID(this._uuid,!0))},B(t,[{key:"dragonBonesJson",get:function(){return this._dragonBonesJson},set:function(e){this._dragonBonesJson=e,this._dragonBonesJsonData=JSON.parse(e),this.reset()}}]),t}(Du),k0=X((G0=H0).prototype,"_dragonBonesJson",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),U0=G0))||U0;i.internal.DragonBonesAsset=g1;var y1,x1=(l1=nl("dragonBones.DragonBonesAtlasAsset"),u1=Bl(tv),l1((v1=function(e){function t(){var t;return q(t=e.call(this)||this,"_atlasJson",f1,V(t)),q(t,"_texture",p1,V(t)),q(t,"_atlasJsonData",d1,V(t)),t._factory=null,q(t,"_textureAtlasData",m1,V(t)),t._clear(),t}L(t,e);var n=t.prototype;return n.createNode=function(e){var t=new qC(this.name);return t.addComponent("dragonBones.ArmatureDisplay").dragonAtlasAsset=this,e(null,t)},n.init=function(e){this._factory=e,this._atlasJsonData||(this._atlasJsonData=JSON.parse(this.atlasJson));var t=this._atlasJsonData;this._uuid=this._uuid||t.name,this._textureAtlasData?e.addTextureAtlasData(this._textureAtlasData,this._uuid):this._textureAtlasData=e.parseTextureAtlasData(t,this.texture,this._uuid)},n.destroy=function(){return this._clear(),e.prototype.destroy.call(this)},n._clear=function(){this._factory&&(c1.sharedCache.resetArmature(this._uuid),this._factory.removeTextureAtlasData(this._uuid,!0),this._factory.removeDragonBonesDataByUUID(this._uuid,!0)),this._textureAtlasData=null},B(t,[{key:"atlasJson",get:function(){return this._atlasJson},set:function(e){this._atlasJson=e,this._atlasJsonData=JSON.parse(this.atlasJson),this._clear()}},{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._clear()}}]),t}(Du),f1=X((_1=v1).prototype,"_atlasJson",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),p1=X(_1.prototype,"_texture",[cl,u1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),d1=X(_1.prototype,"_atlasJsonData",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),m1=X(_1.prototype,"_textureAtlasData",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h1=_1))||h1);i.internal.DragonBonesAtlasAsset=x1;var S1,T1,E1,A1,C1,b1,P1,R1,I1,w1,D1,O1,M1,N1,B1,F1,L1,z1,U1,G1,k1,H1,V1,j1,W1,q1,X1,Y1,K1,Q1,Z1,J1,$1,e2,t2,n2,i2,r2,a2,o2,s2,c2,l2,u2,h2,_2,f2,p2,d2,m2,v2,g2=new wi,y2=nl("dragonBones.AttachUtil")(y1=function(){function e(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}var t=e.prototype;return t.init=function(e){this._inited=!0,this._armature=e._armature,this._armatureNode=e.node,this._armatureDisplay=e},t.reset=function(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null},t._syncAttachedNode=function(){if(this._inited){this._armatureNode.worldMatrix;var e=null,t=this._armatureDisplay.isAnimationCached();if(!t||!this._armatureDisplay||(e=this._armatureDisplay._curFrame&&this._armatureDisplay._curFrame.boneInfos))for(var n,i,r,a=this._armatureDisplay.sockets,o=this._armatureDisplay.socketNodes,s=new di,c=this._armature.getBones(),l=a.length-1;l>=0;l--){var u=a[l],h=u.target;if(h)if(h.isValid){var _=t?e[u.boneIndex]:c[u.boneIndex];_&&(n=h,i=_.globalTransformMatrix,r=void 0,(r=g2).m00=i.a,r.m01=i.b,r.m04=-i.c,r.m05=-i.d,r.m12=i.tx,r.m13=i.ty,n._oldScale||(n._oldScale=n.scale.clone()),s.set(n._oldScale),n.matrix=g2,n.scale=s.multiply(this._armatureNode.scale))}else o.delete(u.path),a.splice(l,1)}}},e}())||y1,x2=function(e){function t(){var t;return(t=e.call(this)||this)._armatures=new Set,t}L(t,e),t.getInstance=function(){return t._instance||(t._instance=new t,VM.registerSystem(t.ID,t._instance,IM.Priority.HIGH)),t._instance};var n=t.prototype;return n.add=function(e){e&&(this._armatures.has(e)||this._armatures.add(e))},n.remove=function(e){e&&this._armatures.has(e)&&this._armatures.delete(e)},n.postUpdate=function(e){this._armatures&&this._armatures.forEach((function(t){t.updateAnimation(e)}))},t}(IM);function S2(e,t,n){kt.Attr.setClassAttr(e,t,"type","Enum"),kt.Attr.setClassAttr(e,t,"enumList",Ye.getList(n))}x2.ID="ARMATURE",x2._instance=void 0,i.internal.ArmatureSystem=x2,function(e){e[e.default=-1]="default"}(p2||(p2={})),Ze(p2),function(e){e[e["<None>"]=0]="<None>"}(d2||(d2={})),Ze(d2),function(e){e[e.REALTIME=0]="REALTIME"}(m2||(m2={})),Ze(d2),function(e){e[e.REALTIME=0]="REALTIME",e[e.SHARED_CACHE=1]="SHARED_CACHE",e[e.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(v2||(v2={})),Ze(v2);var T2=(S1=nl("dragonBones.ArmatureDisplay.DragonBoneSocket"),T1=Bl(qC),S1((C1=X((A1=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),q(this,"path",C1,this),q(this,"target",b1,this),this.boneIndex=null,this.path=e,this.target=t}).prototype,"path",[cl,yl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),b1=X(A1.prototype,"target",[T1,yl,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E1=A1))||E1);Ne(T2,"dragonBones.ArmatureDisplay.DragonBoneSocket");var E2=(P1=nl("dragonBones.ArmatureDisplay"),R1=gl(),I1=pl(),w1=Bl(g1),D1=El(),O1=Bl(x1),M1=El(),N1=xl(),B1=xl(),F1=Tl(),L1=Bl(p2),z1=El(),U1=Bl(d2),G1=Tl(),k1=El(),H1=Tl(),V1=El(),j1=El(),W1=El(),q1=El(),X1=El(),Y1=Bl([T2]),K1=El(),P1(Q1=R1(Q1=I1(Q1=fl((f2=_2=function(e){function t(){var t;return q(t=e.call(this)||this,"playTimes",J1,V(t)),q(t,"premultipliedAlpha",$1,V(t)),t._armature=null,t.attachUtil=void 0,q(t,"_defaultArmatureIndexValue",e2,V(t)),q(t,"_dragonAsset",t2,V(t)),q(t,"_dragonAtlasAsset",n2,V(t)),q(t,"_armatureName",i2,V(t)),q(t,"_animationName",r2,V(t)),q(t,"_animationIndexValue",a2,V(t)),t._preCacheMode=-1,t._cacheMode=v2.REALTIME,q(t,"_defaultCacheModeValue",o2,V(t)),q(t,"_timeScale",s2,V(t)),q(t,"_playTimes",c2,V(t)),q(t,"_debugBones",l2,V(t)),t._debugDraw=null,q(t,"_enableBatch",u2,V(t)),t._armatureKey="",t._accTime=0,t._playCount=0,t._frameCache=null,t._curFrame=null,t._playing=!1,t._armatureCache=null,t._eventTarget=void 0,t._factory=null,t._displayProxy=null,t._drawIdx=0,t._drawList=new We((function(){return{material:null,texture:null,indexOffset:0,indexCount:0}}),1),t.maxVertexCount=0,t.maxIndexCount=0,t._materialCache={},t._enumArmatures=Ye({}),t._enumAnimations=Ye({}),t._socketNodes=new Map,t._cachedSockets=new Map,q(t,"_sockets",h2,V(t)),t._inited=void 0,t._cacheModeEnum=void 0,t._eventTarget=new _n,t._inited=!1,t.attachUtil=new y2,t.initFactory(),S2(V(t),"_animationIndex",t._enumAnimations),S2(V(t),"_defaultArmatureIndex",t._enumArmatures),t}L(t,e);var n=t.prototype;return n.initFactory=function(){this._factory=X0.getInstance()},n.onLoad=function(){for(var e=this.node.children,t=0,n=e.length;t<n;t++){var i=e[t];0===(i.name&&i.name.search("CHILD_ARMATURE-"))&&i.destroy()}},n._requestDrawData=function(e,t,n,i){var r=this._drawList.add();return r.material=e,r.texture=t,r.indexOffset=n,r.indexCount=i,r},n.destroyRenderData=function(){this._drawList.reset(),e.prototype.destroyRenderData.call(this)},n.getMaterialForBlend=function(e,t){var n=e+"/"+t,i=this._materialCache[n];if(i)return i;var r=this.getMaterial(0);return(i=new kg({parent:r,subModelIdx:0,owner:this})).recompileShaders({USE_LOCAL:!0},0),this._materialCache[n]=i,i.overridePipelineStates({blendState:{targets:[{blendSrc:e,blendDst:t}]}}),i},n._render=function(e){if(this._renderData&&this._drawList){var t=this._renderData,n=t.chunk,i=n.vertexAccessor,r=t.getMeshBuffer(),a=r.indexOffset;i.appendIndices(n.bufferId,t.indices);for(var o=0;o<this._drawList.length;o++){this._drawIdx=o;var s=this._drawList.data[o];if(s.texture){var c=r.requireFreeIA(e.device);c.firstIndex=a+s.indexOffset,c.indexCount=s.indexCount,e.commitIA(this,c,s.texture,s.material,this.node)}}}},n._updateBatch=function(){this._materialCache={},this.markForUpdateRenderData()},n._updateMaterial=function(){this.markForUpdateRenderData()},n.__preload=function(){e.prototype.__preload.call(this),this._init()},n._init=function(){if(this._cacheMode=this._defaultCacheMode,!this._inited){this._inited=!0,this._parseDragonAtlasAsset(),this._refresh();for(var e=this.node.children,t=0,n=e.length;t<n;t++){var i=e[t];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateDebugDraw(),this._indexBoneSockets(),this._updateSocketBindings()}},n.getArmatureKey=function(){return this._armatureKey},n.setAnimationCacheMode=function(e){this._preCacheMode!==e&&(this._cacheMode=e,this._buildArmature(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._updateSocketBindings(),this.markForUpdateRenderData())},n.isAnimationCached=function(){return this._cacheMode!==v2.REALTIME},n.onEnable=function(){e.prototype.onEnable.call(this),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._flushAssembler(),x2.getInstance().add(this)},n.onDisable=function(){e.prototype.onDisable.call(this),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),x2.getInstance().remove(this)},n._emitCacheCompleteEvent=function(){this._eventTarget.emit(sV.LOOP_COMPLETE),this._eventTarget.emit(sV.COMPLETE)},n.updateAnimation=function(e){if(this.isAnimationCached()&&this._frameCache){this.markForUpdateRenderData();var t=this._frameCache;if(t.isInited()){var n=t.frames;if(this._playing){var i=c1.FrameTime;0===this._accTime&&0===this._playCount&&this._eventTarget.emit(sV.START),this._accTime+=e*this.timeScale*1;var r=Math.floor(this._accTime/i);if(t.isCompleted||(t.updateToFrame(r),this._renderData&&(this._renderData.vertexCount<t.maxVertexCount||this._renderData.indexCount<t.maxIndexCount)&&(this.maxVertexCount=t.maxVertexCount>this.maxVertexCount?t.maxVertexCount:this.maxVertexCount,this.maxIndexCount=t.maxIndexCount>this.maxIndexCount?t.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),t.isCompleted&&r>=n.length){if(this._playCount++,this.playTimes>0&&this._playCount>=this.playTimes)return this._curFrame=n[n.length-1],this._accTime=0,this._playing=!1,this._playCount=0,this._emitCacheCompleteEvent(),void this.attachUtil._syncAttachedNode();this._accTime=0,r=0,this._emitCacheCompleteEvent()}this._curFrame=n[r],this.attachUtil._syncAttachedNode()}else t.isInvalid()&&(t.updateToFrame(),this._curFrame=n[n.length-1],this._renderData&&(this._renderData.vertexCount<t.maxVertexCount||this._renderData.indexCount<t.maxIndexCount)&&(this.maxVertexCount=t.maxVertexCount>this.maxVertexCount?t.maxVertexCount:this.maxVertexCount,this.maxIndexCount=t.maxIndexCount>this.maxIndexCount?t.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount))))}}},n.onDestroy=function(){this._materialInstances=this._materialInstances.filter((function(e){return!!e})),this._inited=!1,this._cacheMode===v2.PRIVATE_CACHE?(this._armatureCache.dispose(),this._armatureCache=null,this._armature=null):this._cacheMode===v2.SHARED_CACHE?(this._armatureCache=null,this._armature=null):this._armature&&(this._armature.dispose(),this._armature=null),this._drawList.destroy(),e.prototype.onDestroy.call(this)},n._updateDebugDraw=function(){if(this.debugBones){if(!this._debugDraw){var e=new qC("DEBUG_DRAW_NODE");e.hideFlags|=Yt.Flags.DontSave|Yt.Flags.HideInHierarchy;var t=e.addComponent(cY);t.lineWidth=1,t.strokeColor=new fi(255,0,0,255),this._debugDraw=t}this._debugDraw.node.parent=this.node}else this._debugDraw&&(this._debugDraw.node.parent=null);this.markForUpdateRenderData()},n._buildArmature=function(){if(this.dragonAsset&&this.dragonAtlasAsset&&this.armatureName){this._armature&&(this._preCacheMode===v2.PRIVATE_CACHE?this._armatureCache.dispose():this._preCacheMode===v2.REALTIME&&this._armature.dispose(),this._armatureCache=null,this._armature=null,this._displayProxy=null,this._frameCache=null,this._curFrame=null,this._playing=!1,this._preCacheMode=-1),this._cacheMode===v2.SHARED_CACHE?this._armatureCache=c1.sharedCache:this._cacheMode===v2.PRIVATE_CACHE&&(this._armatureCache=new c1,this._armatureCache.enablePrivateMode());var e=this.dragonAtlasAsset._uuid;if(this._armatureKey=this.dragonAsset.init(this._factory,e),this.isAnimationCached()&&(this._armature=this._armatureCache.getArmatureCache(this.armatureName,this._armatureKey,e),this._armature||(this._cacheMode=v2.REALTIME)),this._preCacheMode=this._cacheMode,this._cacheMode===v2.REALTIME){if(this._displayProxy=this._factory.buildArmatureDisplay(this.armatureName,this._armatureKey,"",e),!this._displayProxy)return;this._displayProxy._ccNode=this.node,this._displayProxy._ccComponent=this,this._displayProxy.setEventTarget(this._eventTarget),this._armature=this._displayProxy._armature,this._armature.animation.timeScale=this.timeScale}if(this._cacheMode!==v2.REALTIME&&this.debugBones&&console.warn("Debug bones is invalid in cached mode"),this._armature){var t=this._armature.armatureData.aabb;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._updateBatch(),this.attachUtil.init(this),this.animationName&&this.playAnimation(this.animationName,this.playTimes),this._flushAssembler()}},n.querySockets=function(){return this._armature?(0===this._cachedSockets.size&&this._indexBoneSockets(),Array.from(this._cachedSockets.keys()).sort()):[]},n.setBlendHash=function(){-1!==this._blendHash&&(this._blendHash=-1)},n.querySocketPathByName=function(e){for(var t,n=[],i=W(this._cachedSockets.keys());!(t=i()).done;){var r=t.value;r.endsWith(e)&&n.push(r)}return n},n._parseDragonAtlasAsset=function(){this.dragonAtlasAsset&&this.dragonAtlasAsset.init(this._factory)},n._refresh=function(){this._buildArmature(),this._indexBoneSockets(),this.markForUpdateRenderData()},n._updateCacheModeEnum=function(){this._cacheModeEnum=Ye({}),this._armature?Object.assign(this._cacheModeEnum,v2):Object.assign(this._cacheModeEnum,m2),S2(this,"_defaultCacheMode",this._cacheModeEnum)},n._updateAnimEnum=function(){var e;e=this.dragonAsset?this.dragonAsset.getAnimsEnum(this.armatureName):d2,this._enumAnimations=Ye({}),Object.assign(this._enumAnimations,e||d2),Ye.update(this._enumAnimations),S2(this,"_animationIndex",this._enumAnimations)},n._updateArmatureEnum=function(){var e;e=this.dragonAsset?this.dragonAsset.getArmatureEnum():p2,this._enumArmatures=Ye({}),Object.assign(this._enumArmatures,e||p2),Ye.update(this._enumArmatures),S2(this,"_defaultArmatureIndex",this._enumArmatures)},n._indexBoneSockets=function(){if(this._armature){this._cachedSockets.clear();var e=this._cachedSockets,t=function e(t,n,i){if(i.has(t))return i.get(t);var r=n[t];if(!r.parent)return i.set(t,r.name),r.path=r.name,r.name;var a=e(r.parent._boneIndex,n,i)+"/"+r.name;return i.set(t,a),r.path=a,a};!function n(i,r){for(var a=r.getBones(),o=new Map,s=0;s<a.length;s++)a[s]._boneIndex=s;for(var c=0;c<a.length;c++)t(c,a,o);for(var l,u=W(o.keys());!(l=u()).done;){var h=l.value;e.set(""+i+o.get(h),h)}for(var _=r.getSlots(),f=0;f<_.length;f++)_[f].childArmature&&n(_[f].name,_[f].childArmature)}("",this._armature)}},n.playAnimation=function(e,t){if(this.playTimes=void 0===t?-1:t,this.animationName=e,this.isAnimationCached()){var n=this._armatureCache.getAnimationCache(this._armatureKey,e);n||(n=this._armatureCache.initAnimationCache(this._armatureKey,e)),n&&(this._accTime=0,this._playCount=0,this._frameCache=n,this._sockets.length>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._playing=!0,this._curFrame=this._frameCache.frames[0])}else if(this._armature)return this._armature.animation.play(e,this.playTimes);return this.markForUpdateRenderData(),null},n.updateAnimationCache=function(e){this.isAnimationCached()&&this._armatureCache.updateAnimationCache(this._armatureKey,e)},n.invalidAnimationCache=function(){this.isAnimationCached()&&this._armatureCache.invalidAnimationCache(this._armatureKey)},n.getArmatureNames=function(){var e=this._factory.getDragonBonesData(this._armatureKey);return e&&e.armatureNames||[]},n.getAnimationNames=function(e){var t=[],n=this._factory.getDragonBonesData(this._armatureKey);if(n){var i=n.getArmature(e);if(i)for(var r in i.animations)i.animations.hasOwnProperty(r)&&t.push(r)}return t},n.on=function(e,t,n){this.addEventListener(e,t,n)},n.off=function(e,t,n){this.removeEventListener(e,t,n)},n.once=function(e,t,n){this._eventTarget.once(e,t,n)},n.addEventListener=function(e,t,n){this._eventTarget.on(e,t,n)},n.removeEventListener=function(e,t,n){this._eventTarget.off(e,t,n)},n.buildArmature=function(e,t){return this._factory.createArmatureNode(this,e,t)},n.armature=function(){return this._armature},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._armature&&this._assembler&&(this._renderData=this._assembler.createData(this),this._renderData&&(this.maxVertexCount=this._renderData.vertexCount,this.maxIndexCount=this._renderData.indexCount),this.markForUpdateRenderData(),this._updateColor())},n._updateSocketBindings=function(){if(this._armature){this._socketNodes.clear();for(var e=0,t=this._sockets.length;e<t;e++){var n=this._sockets[e];if(n.path&&n.target){var i=this._cachedSockets.get(n.path);if(!i){console.error("Skeleton data does not contain path "+n.path);continue}n.boneIndex=i,this._socketNodes.set(n.path,n.target)}}}},n._verifySockets=function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t].target;!i||i.parent&&i.parent===this.node||console.error("Target node "+i.name+" is expected to be a direct child of "+this.node.name)}},B(t,[{key:"dragonAsset",get:function(){return this._dragonAsset},set:function(e){this._dragonAsset=e,this._refresh()}},{key:"dragonAtlasAsset",get:function(){return this._dragonAtlasAsset},set:function(e){this._dragonAtlasAsset=e,this._parseDragonAtlasAsset(),this._refresh()}},{key:"armatureName",get:function(){return this._armatureName},set:function(e){this._armatureName=e;var t=this.getAnimationNames(this._armatureName);(!this.animationName||t.indexOf(this.animationName)<0)&&(this.animationName=""),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),this._refresh(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature)}},{key:"animationName",get:function(){return this._animationName},set:function(e){this._animationName=e}},{key:"_defaultArmatureIndex",get:function(){return this._defaultArmatureIndexValue},set:function(e){this._defaultArmatureIndexValue=e;var t="";if(this.dragonAsset){var n;if(this.dragonAsset&&(n=this.dragonAsset.getArmatureEnum()),!n)return void b(7400,this.name);t=n[this._defaultArmatureIndex]}void 0!==t?this.armatureName=t:b(7401,this.name),this.markForUpdateRenderData()}},{key:"_animationIndex",get:function(){return this._animationIndexValue},set:function(e){var t;if(this._animationIndexValue=e,0!==this._animationIndex){if(this.dragonAsset&&(t=this.dragonAsset.getAnimsEnum(this.armatureName)),t){var n=t[this._animationIndex];void 0!==n?this.playAnimation(n,this.playTimes):b(7402,this.name)}}else this.animationName=""}},{key:"_defaultCacheMode",get:function(){return this._defaultCacheModeValue},set:function(e){if(this._defaultCacheModeValue=e,this._defaultCacheMode!==v2.REALTIME&&this._armature&&!c1.canCache(this._armature))return this._defaultCacheMode=v2.REALTIME,void console.warn("Animation cache mode doesn't support skeletal nesting");this.setAnimationCacheMode(this._defaultCacheMode)}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e,this._armature&&!this.isAnimationCached()&&(this._armature.animation.timeScale=this.timeScale)}},{key:"debugBones",get:function(){return this._debugBones},set:function(e){this._debugBones=e,this._updateDebugDraw()}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._verifySockets(e),this._sockets=e,this._updateSocketBindings(),e.length>0&&this._frameCache&&this._frameCache.enableCacheAttachedInfo()}},{key:"socketNodes",get:function(){return this._socketNodes}},{key:"drawList",get:function(){return this._drawList}}]),t}(Yq),_2.AnimationCacheMode=v2,X((Z1=f2).prototype,"dragonAsset",[yl,w1,D1],Object.getOwnPropertyDescriptor(Z1.prototype,"dragonAsset"),Z1.prototype),X(Z1.prototype,"dragonAtlasAsset",[yl,O1,M1],Object.getOwnPropertyDescriptor(Z1.prototype,"dragonAtlasAsset"),Z1.prototype),X(Z1.prototype,"armatureName",[N1],Object.getOwnPropertyDescriptor(Z1.prototype,"armatureName"),Z1.prototype),X(Z1.prototype,"animationName",[B1],Object.getOwnPropertyDescriptor(Z1.prototype,"animationName"),Z1.prototype),X(Z1.prototype,"_defaultArmatureIndex",[F1,yl,L1,z1],Object.getOwnPropertyDescriptor(Z1.prototype,"_defaultArmatureIndex"),Z1.prototype),X(Z1.prototype,"_animationIndex",[yl,U1,G1,k1],Object.getOwnPropertyDescriptor(Z1.prototype,"_animationIndex"),Z1.prototype),X(Z1.prototype,"_defaultCacheMode",[yl,H1,V1],Object.getOwnPropertyDescriptor(Z1.prototype,"_defaultCacheMode"),Z1.prototype),X(Z1.prototype,"timeScale",[yl,j1,cl],Object.getOwnPropertyDescriptor(Z1.prototype,"timeScale"),Z1.prototype),J1=X(Z1.prototype,"playTimes",[W1,yl,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$1=X(Z1.prototype,"premultipliedAlpha",[cl,yl,q1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Z1.prototype,"debugBones",[X1,yl],Object.getOwnPropertyDescriptor(Z1.prototype,"debugBones"),Z1.prototype),X(Z1.prototype,"sockets",[Y1,K1],Object.getOwnPropertyDescriptor(Z1.prototype,"sockets"),Z1.prototype),e2=X(Z1.prototype,"_defaultArmatureIndexValue",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p2.default}}),t2=X(Z1.prototype,"_dragonAsset",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n2=X(Z1.prototype,"_dragonAtlasAsset",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i2=X(Z1.prototype,"_armatureName",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),r2=X(Z1.prototype,"_animationName",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),a2=X(Z1.prototype,"_animationIndexValue",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o2=X(Z1.prototype,"_defaultCacheModeValue",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return v2.REALTIME}}),s2=X(Z1.prototype,"_timeScale",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c2=X(Z1.prototype,"_playTimes",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),l2=X(Z1.prototype,"_debugBones",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),u2=X(Z1.prototype,"_enableBatch",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h2=X(Z1.prototype,"_sockets",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Q1=Z1))||Q1)||Q1)||Q1)||Q1);i.internal.ArmatureDisplay=E2;var A2,C2,b2,P2,R2,I2,w2,D2,O2,M2,N2,B2,F2,L2,z2,U2,G2,k2,H2,V2,j2=new fi(255,0,0,255),W2=new fi(0,0,255,255),q2=new fi(0,255,0,255),X2=0,Y2=0,K2=0,Q2=0,Z2=0,J2=0,$2=0,e4=0,t4=0,n4=new Float32Array(4),i4=new wi,r4=null,a4=null;function o4(e,t){if(!e)return null;var n,i;switch(t){case 1:n=R2?Lr.ONE:Lr.SRC_ALPHA,i=Lr.ONE;break;case 10:n=Lr.DST_COLOR,i=Lr.ONE_MINUS_SRC_ALPHA;break;case 12:n=Lr.ONE,i=Lr.ONE_MINUS_SRC_COLOR;break;case 0:default:n=R2?Lr.ONE:Lr.SRC_ALPHA,i=Lr.ONE_MINUS_SRC_ALPHA}return N2.setBlendHash(),N2.getMaterialForBlend(n,i)}function s4(e,t){var n=e.a*t*P2,i=R2?n/255:1,r=e.r*A2*i/255,a=e.g*C2*i/255,o=e.b*b2*i/255;n4[0]=r,n4[1]=a,n4[2]=o,n4[3]=R2?1:n/255}var c4=null,l4={accessor:c4,vCount:32767,ensureAccessor:function(){if(!c4){var e=VM.root.device,t=VM.root.batcher2D,n=Dj;this.accessor=c4=new f0(e,n,this.vCount),t.registerBufferAccessor(Number.parseInt("DRAGONBONES",36),c4)}return this.accessor},createData:function(e){var t=e.renderData;if(!t){this.ensureAccessor();for(var n=e._armature._slots,i=0,r=0,a=0;a<n.length;++a){var o=n[a];i+=o._localVertices.length/4,r+=o._indices.length}(t=eW.add(Dj,this.accessor)).resize(i,r),t.indices&&r===t.indices.length||(t.indices=new Uint16Array(r))}return t},updateRenderData:function(e){N2=e,e._armature&&function(e){var t=e._armature;if(t){I2=!0,R2=e.premultipliedAlpha,e.drawList.reset(),N2=e,M2=e.node,w2=e.renderData,N2=e,L2=0,r4=null;var n,i=e.color;if(A2=i.r/255,C2=i.g/255,b2=i.b/255,P2=i.a/255,4294967295!==i._val&&(L2|=1),N2._enableBatch&&(n=M2.worldMatrix,I2=!1,L2|=16),X2=0,K2=0,Q2=0,Z2=0,J2=0,t4=0,$2=N2.maxVertexCount,e4=N2.maxIndexCount,e.isAnimationCached())!function(e,t){if(e){var n=e.segments;if(0!==n.length){var i=null,r=e.vertices,a=e.indices,o=0,s=0,c=0,l=0;t&&(z2=t.m00,k2=t.m01,U2=t.m04,H2=t.m05,G2=t.m12,V2=t.m13);var u=0,h=e.colors,_=h[u++],f=_.vfOffset;s4(_,1);for(var p=w2,d=p.chunk.vb,m=p.indices,v=0,g=n.length;v<g;v++){var y=n[v];if(i=o4(y.tex,y.blendMode)){if(r4||(r4=i),I2||i.hash!==r4.hash||y.tex&&y.tex!==a4){I2=!1;var x=J2-t4;x>0&&(N2._requestDrawData(r4,a4,t4,x),t4=J2),r4=i,a4=y.tex}Y2=y.vertexCount,Z2=y.indexCount,o=p.chunk.vertexOffset;for(var S=J2,T=J2+Z2;S<T;S++)m[S]=o+K2+a[c++];l=y.vfCount;var E=r.subarray(s,l);d.set(E,s);var A=0;if(t)for(var C=0,b=Y2;C<b;C++)B2=d[A],F2=d[A+1],d[A]=B2*z2+F2*U2+G2,d[A+1]=B2*k2+F2*H2+V2,A+=9;if(1&L2)for(var P=s/9*5,R=s,I=s+l;R<I;R+=9,P+=5)P>=f&&(s4(_=h[u++],1),f=_.vfOffset),d.set(n4,R+5);s+=l,K2+=Y2,J2+=Z2,Y2=0,Z2=0}}var w=J2-t4;a4&&w>0&&N2._requestDrawData(r4,a4,t4,w)}}}(e._curFrame,n);else{u4(t,1,n);var r=e._debugDraw;if(e.debugBones&&r){r.clear(),r.lineWidth=5,r.strokeColor=j2,r.fillColor=W2;for(var a=t.getBones(),o=0,s=a.length;o<s;o++){var c=a[o],l=Math.max(c.boneData.length,5),u=c.globalTransformMatrix.tx,h=c.globalTransformMatrix.ty,_=u+c.globalTransformMatrix.a*l,f=h+c.globalTransformMatrix.b*l;r.moveTo(u,h),r.lineTo(_,f),r.stroke(),r.circle(u,h,2*Math.PI),r.fill(),0===o&&(r.fillColor=q2)}}}c4.getMeshBuffer(w2.chunk.bufferId).setDirty(),e.attachUtil._syncAttachedNode(),M2=void 0,N2=void 0}}(e)},updateColor:function(e){e&&(N2=e).markForUpdateRenderData()}};function u4(e,t,n){var i=w2;O2=i.chunk.vb,D2=i.indices;for(var r,a,o,s,c,l,u=e._slots,h=0,_=u.length;h<_;h++)if(s=(c=u[h])._color,c._visible&&c._displayData)if(n?c._mulMat(c._worldMatrix,n,c._matrix):wi.copy(c._worldMatrix,c._matrix),c.childArmature)u4(c.childArmature,s.a/255,c._worldMatrix);else if(r=o4(c.getTexture(),c._blendMode)){r4||(r4=r);var f=c.getTexture();if(I2||r.hash!==r4.hash||f&&a4!==f){I2=!1;var p=J2-t4;p>0&&(N2._requestDrawData(r4,a4,t4,p),t4=J2),a4=f,r4=r}s4(s,t),i4.set(c._worldMatrix),a=c._localVertices,Y2=a.length/4,X2=9*Y2,o=c._indices,Z2=o.length;var d=!1;if(K2+Y2>$2&&($2=K2+Y2,d=!0),J2+Z2>e4&&(e4=J2+Z2,d=!0),d){var m=D2,v=i.chunk.vertexOffset;i.resizeAndCopy($2,e4>i.indexCount?e4:i.indexCount),O2=i.chunk.vb,e4>D2.length&&(D2=i.indices=new Uint16Array(e4));for(var g=i.chunk.vertexOffset-v,y=0;y<J2;++y)D2[y]=m[y]+g}z2=i4.m00,U2=i4.m04,G2=i4.m12,k2=i4.m01,H2=i4.m05,V2=i4.m13;for(var x=0,S=a.length,T=Q2;x<S;T+=9)B2=a[x++],F2=a[x++],O2[T]=B2*z2+F2*U2+G2,O2[T+1]=B2*k2+F2*H2+V2,O2[T+3]=a[x++],O2[T+4]=a[x++],O2.set(n4,T+5);for(var E=i.chunk.vertexOffset,A=0,C=o.length,b=J2;A<C;A++,b++)D2[b]=K2+o[A]+E;Q2+=X2,K2+=Y2,J2+=Z2,Y2=0,Z2=0}l=J2-t4,a4&&l>0&&(N2._requestDrawData(r4,a4,t4,l),t4=J2),N2.maxIndexCount<e4&&(N2.maxIndexCount=e4),N2.maxVertexCount<$2&&(N2.maxVertexCount=$2)}i.internal.DragonBonesAssembler=l4;var h4,_4,f4,p4={getAssembler:function(){return l4}};E2.Assembler=p4,function(e){e[e.FFD=0]="FFD",e[e.AdjustColor=10]="AdjustColor",e[e.BevelFilter=11]="BevelFilter",e[e.BlurFilter=12]="BlurFilter",e[e.DropShadowFilter=13]="DropShadowFilter",e[e.GlowFilter=14]="GlowFilter",e[e.GradientBevelFilter=15]="GradientBevelFilter",e[e.GradientGlowFilter=16]="GradientGlowFilter"}(h4||(h4={})),function(e){e[e.Frame=0]="Frame",e[e.Sound=1]="Sound"}(_4||(_4={})),function(e){e[e.None=0]="None",e[e.SameLayer=1]="SameLayer",e[e.SameGroup=2]="SameGroup",e[e.SameLayerAndGroup=3]="SameLayerAndGroup",e[e.All=4]="All"}(f4||(f4={})),e("dragonBones",Object.freeze({__proto__:null,get ExtensionType(){return h4},get EventType(){return _4},get AnimationFadeOutMode(){return f4},CCFactory:X0,CCSlot:W0,CCTextureAtlasData:V0,CCTextureData:j0,CCArmatureDisplay:q0,AnimationCache:s1,ArmatureCache:c1,DragonBonesAsset:g1,DragonBonesAtlasAsset:x1,timeScale:1,get AnimationCacheMode(){return v2},DragonBoneSocket:T2,ArmatureDisplay:E2,AttachUtil:y2,simpleDragonBoneAssembler:p4,DragonBones:Yk,BaseObject:Kk,Matrix:Qk,Transform:Zk,ColorTransform:Jk,Point:$k,Rectangle:eH,UserData:tH,ActionData:nH,DragonBonesData:iH,ArmatureData:rH,BoneData:aH,SurfaceData:oH,SlotData:sH,ConstraintData:cH,IKConstraintData:lH,PathConstraintData:uH,CanvasData:hH,SkinData:_H,VerticesData:fH,DisplayData:pH,ImageDisplayData:dH,ArmatureDisplayData:mH,MeshDisplayData:vH,BoundingBoxDisplayData:gH,PathDisplayData:yH,WeightData:xH,BoundingBoxData:SH,RectangleBoundingBoxData:TH,EllipseBoundingBoxData:EH,PolygonBoundingBoxData:AH,AnimationData:CH,TimelineData:bH,AnimationConfig:PH,TextureAtlasData:RH,TextureData:IH,DeformVertices:wH,Armature:DH,TransformObject:OH,Bone:MH,Surface:NH,Slot:BH,Constraint:FH,IKConstraint:LH,PathConstraint:zH,WorldClock:UH,Animation:GH,AnimationState:kH,BonePose:HH,BlendState:VH,TimelineState:jH,TweenTimelineState:WH,BoneTimelineState:qH,SlotTimelineState:XH,ConstraintTimelineState:YH,ActionTimelineState:KH,ZOrderTimelineState:QH,BoneAllTimelineState:ZH,BoneTranslateTimelineState:JH,BoneRotateTimelineState:$H,BoneScaleTimelineState:eV,SurfaceTimelineState:tV,SlotDislayTimelineState:nV,SlotColorTimelineState:iV,DeformTimelineState:rV,IKConstraintTimelineState:aV,AnimationTimelineState:oV,EventObject:sV,DataParser:cV,ObjectDataParser:lV,ActionFrame:uV,BinaryDataParser:hV,BaseFactory:_V,BuildArmaturePackage:fV,BinaryOffset:pV,ArmatureType:dV,BoneType:mV,DisplayType:vV,BoundingBoxType:gV,ActionType:yV,BlendMode:xV,TweenType:SV,TimelineType:TV}));var d4,m4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&uo){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ho&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},B(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(wo);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(d4||(d4={}));var v4=function(){function e(){}return e.setInstance=function(t){e._instance=t},B(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function g4(e,t){switch(e){case Sr.R8:return t.UNSIGNED_BYTE;case Sr.R8SN:return t.BYTE;case Sr.R8UI:return t.UNSIGNED_BYTE;case Sr.R8I:return t.BYTE;case Sr.R16F:return d4.HALF_FLOAT_OES;case Sr.R16UI:return t.UNSIGNED_SHORT;case Sr.R16I:return t.SHORT;case Sr.R32F:return t.FLOAT;case Sr.R32UI:return t.UNSIGNED_INT;case Sr.R32I:return t.INT;case Sr.RG8:return t.UNSIGNED_BYTE;case Sr.RG8SN:return t.BYTE;case Sr.RG8UI:return t.UNSIGNED_BYTE;case Sr.RG8I:return t.BYTE;case Sr.RG16F:return d4.HALF_FLOAT_OES;case Sr.RG16UI:return t.UNSIGNED_SHORT;case Sr.RG16I:return t.SHORT;case Sr.RG32F:return t.FLOAT;case Sr.RG32UI:return t.UNSIGNED_INT;case Sr.RG32I:return t.INT;case Sr.RGB8:case Sr.SRGB8:return t.UNSIGNED_BYTE;case Sr.RGB8SN:return t.BYTE;case Sr.RGB8UI:return t.UNSIGNED_BYTE;case Sr.RGB8I:return t.BYTE;case Sr.RGB16F:return d4.HALF_FLOAT_OES;case Sr.RGB16UI:return t.UNSIGNED_SHORT;case Sr.RGB16I:return t.SHORT;case Sr.RGB32F:return t.FLOAT;case Sr.RGB32UI:return t.UNSIGNED_INT;case Sr.RGB32I:return t.INT;case Sr.BGRA8:case Sr.RGBA8:case Sr.SRGB8_A8:return t.UNSIGNED_BYTE;case Sr.RGBA8SN:return t.BYTE;case Sr.RGBA8UI:return t.UNSIGNED_BYTE;case Sr.RGBA8I:return t.BYTE;case Sr.RGBA16F:return d4.HALF_FLOAT_OES;case Sr.RGBA16UI:return t.UNSIGNED_SHORT;case Sr.RGBA16I:return t.SHORT;case Sr.RGBA32F:return t.FLOAT;case Sr.RGBA32UI:return t.UNSIGNED_INT;case Sr.RGBA32I:return t.INT;case Sr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Sr.R11G11B10F:return t.FLOAT;case Sr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Sr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Sr.RGB10A2:return t.UNSIGNED_BYTE;case Sr.RGB10A2UI:return t.UNSIGNED_INT;case Sr.RGB9E5:return t.UNSIGNED_BYTE;case Sr.DEPTH:return t.UNSIGNED_INT;case Sr.DEPTH_STENCIL:return d4.UNSIGNED_INT_24_8_WEBGL;case Sr.BC1:case Sr.BC1_SRGB:case Sr.BC2:case Sr.BC2_SRGB:case Sr.BC3:case Sr.BC3_SRGB:case Sr.BC4:return t.UNSIGNED_BYTE;case Sr.BC4_SNORM:return t.BYTE;case Sr.BC5:return t.UNSIGNED_BYTE;case Sr.BC5_SNORM:return t.BYTE;case Sr.BC6H_SF16:case Sr.BC6H_UF16:return t.FLOAT;case Sr.BC7:case Sr.BC7_SRGB:case Sr.ETC_RGB8:case Sr.ETC2_RGB8:case Sr.ETC2_SRGB8:case Sr.ETC2_RGB8_A1:case Sr.ETC2_SRGB8_A1:case Sr.EAC_R11:return t.UNSIGNED_BYTE;case Sr.EAC_R11SN:return t.BYTE;case Sr.EAC_RG11:return t.UNSIGNED_BYTE;case Sr.EAC_RG11SN:return t.BYTE;case Sr.PVRTC_RGB2:case Sr.PVRTC_RGBA2:case Sr.PVRTC_RGB4:case Sr.PVRTC_RGBA4:case Sr.PVRTC2_2BPP:case Sr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Sr.ASTC_RGBA_4X4:case Sr.ASTC_RGBA_5X4:case Sr.ASTC_RGBA_5X5:case Sr.ASTC_RGBA_6X5:case Sr.ASTC_RGBA_6X6:case Sr.ASTC_RGBA_8X5:case Sr.ASTC_RGBA_8X6:case Sr.ASTC_RGBA_8X8:case Sr.ASTC_RGBA_10X5:case Sr.ASTC_RGBA_10X6:case Sr.ASTC_RGBA_10X8:case Sr.ASTC_RGBA_10X10:case Sr.ASTC_RGBA_12X10:case Sr.ASTC_RGBA_12X12:case Sr.ASTC_SRGBA_4X4:case Sr.ASTC_SRGBA_5X4:case Sr.ASTC_SRGBA_5X5:case Sr.ASTC_SRGBA_6X5:case Sr.ASTC_SRGBA_6X6:case Sr.ASTC_SRGBA_8X5:case Sr.ASTC_SRGBA_8X6:case Sr.ASTC_SRGBA_8X8:case Sr.ASTC_SRGBA_10X5:case Sr.ASTC_SRGBA_10X6:case Sr.ASTC_SRGBA_10X8:case Sr.ASTC_SRGBA_10X10:case Sr.ASTC_SRGBA_12X10:case Sr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function y4(e,t){switch(e){case Er.BOOL:return t.BOOL;case Er.BOOL2:return t.BOOL_VEC2;case Er.BOOL3:return t.BOOL_VEC3;case Er.BOOL4:return t.BOOL_VEC4;case Er.INT:return t.INT;case Er.INT2:return t.INT_VEC2;case Er.INT3:return t.INT_VEC3;case Er.INT4:return t.INT_VEC4;case Er.UINT:return t.UNSIGNED_INT;case Er.FLOAT:return t.FLOAT;case Er.FLOAT2:return t.FLOAT_VEC2;case Er.FLOAT3:return t.FLOAT_VEC3;case Er.FLOAT4:return t.FLOAT_VEC4;case Er.MAT2:return t.FLOAT_MAT2;case Er.MAT3:return t.FLOAT_MAT3;case Er.MAT4:return t.FLOAT_MAT4;case Er.SAMPLER2D:return t.SAMPLER_2D;case Er.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Er.UNKNOWN}}function x4(e){switch(e){case Er.BOOL:case Er.BOOL2:case Er.BOOL3:case Er.BOOL4:case Er.INT:case Er.INT2:case Er.INT3:case Er.INT4:case Er.UINT:return Int32Array;case Er.FLOAT:case Er.FLOAT2:case Er.FLOAT3:case Er.FLOAT4:case Er.MAT2:case Er.MAT3:case Er.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function S4(e,t){switch(e){case t.BOOL:return Er.BOOL;case t.BOOL_VEC2:return Er.BOOL2;case t.BOOL_VEC3:return Er.BOOL3;case t.BOOL_VEC4:return Er.BOOL4;case t.INT:return Er.INT;case t.INT_VEC2:return Er.INT2;case t.INT_VEC3:return Er.INT3;case t.INT_VEC4:return Er.INT4;case t.UNSIGNED_INT:return Er.UINT;case t.FLOAT:return Er.FLOAT;case t.FLOAT_VEC2:return Er.FLOAT2;case t.FLOAT_VEC3:return Er.FLOAT3;case t.FLOAT_VEC4:return Er.FLOAT4;case t.FLOAT_MAT2:return Er.MAT2;case t.FLOAT_MAT3:return Er.MAT3;case t.FLOAT_MAT4:return Er.MAT4;case t.SAMPLER_2D:return Er.SAMPLER2D;case t.SAMPLER_CUBE:return Er.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Er.UNKNOWN}}function T4(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function E4(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}v4._instance=null;var A4,C4=[512,513,514,515,516,517,518,519],b4=[0,7680,7681,7682,7683,5386,34055,34056],P4=[32774,32778,32779,32775,32776],R4=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(A4||(A4={}));var I4=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},w4=function(e){function t(){var t;return(t=e.call(this,A4.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new ua,t.clearFlag=na.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return L(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(I4),D4=function(e){function t(){var t;return(t=e.call(this,A4.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new so,t}return L(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(I4),O4=function(e){function t(){var t;return(t=e.call(this,A4.DRAW)||this).drawInfo=new Aa,t}return L(t,e),t.prototype.clear=function(){},t}(I4),M4=function(e){function t(){var t;return(t=e.call(this,A4.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return L(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(I4),N4=function(e){function t(){var t;return(t=e.call(this,A4.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return L(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(I4),B4=function(){function e(){this.cmds=new qe(1),this.beginRenderPassCmds=new qe(1),this.bindStatesCmds=new qe(1),this.drawCmds=new qe(1),this.updateBufferCmds=new qe(1),this.copyBufferToTextureCmds=new qe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function F4(e,t,n,i,r){if(t.usage&Ar.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Ar.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var L4={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function z4(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==Sr.UNKNOWN)switch(_.loadOp){case kr.LOAD:break;case kr.CLEAR:c.bs.targets[0].blendColorMask!==Ur.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case kr.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Sr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case kr.DISCARD:}if(lo[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case kr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Ur.ALL){var d=(p&Ur.R)!==Ur.NONE,m=(p&Ur.G)!==Ur.NONE,v=(p&Ur.B)!==Ur.NONE,g=(p&Ur.A)!==Ur.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function U4(e,t,n,i,r,a){var o,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&L4.gpuPipelineState!==t){if(L4.gpuPipelineState=t,L4.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=t.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case Kr.NONE:l.disable(l.CULL_FACE);break;case Kr.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Kr.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var m=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==m&&(l.frontFace(m?l.CCW:l.CW),u.rs.isFrontFaceCCW=m),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var v=t.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(C4[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,C4[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,b4[v.stencilFailOpFront],b4[v.stencilZFailOpFront],b4[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,C4[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,b4[v.stencilFailOpBack],b4[v.stencilZFailOpBack],b4[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=t.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],x=u.bs.targets[0];x.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),x.blend=y.blend),x.blendEq===y.blendEq&&x.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(P4[y.blendEq],P4[y.blendAlphaEq]),x.blendEq=y.blendEq,x.blendAlphaEq=y.blendAlphaEq),x.blendSrc===y.blendSrc&&x.blendDst===y.blendDst&&x.blendSrcAlpha===y.blendSrcAlpha&&x.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(R4[y.blendSrc],R4[y.blendDst],R4[y.blendSrcAlpha],R4[y.blendDstAlpha]),x.blendSrc=y.blendSrc,x.blendDst=y.blendDst,x.blendSrcAlpha=y.blendSrcAlpha,x.blendDstAlpha=y.blendDstAlpha),x.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&Ur.R)!==Ur.NONE,(y.blendColorMask&Ur.G)!==Ur.NONE,(y.blendColorMask&Ur.B)!==Ur.NONE,(y.blendColorMask&Ur.A)!==Ur.NONE),x.blendColorMask=y.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,T=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<S;E++){var A=h.glBlocks[E],C=i[A.set],b=C&&C.descriptorIndices[A.binding],P=b>=0&&C.gpuDescriptors[b],R=null,I=0;if(P&&P.gpuBuffer){var w=P.gpuBuffer,D=T[A.set],O=D&&D[A.binding];O>=0&&(I=r[O]),"vf32"in w?R=w.vf32:(I+=w.offset,R=w.gpuBuffer.vf32),I>>=2}if(R)for(var M=A.glActiveUniforms.length,N=0;N<M;N++){var B=A.glActiveUniforms[N];switch(B.glType){case l.BOOL:case l.INT:for(var F=0;F<B.array.length;++F){var L=B.offset+I+F;if(R[L]!==B.array[F]){for(var z=F,U=L;z<B.array.length;++z,++U)B.array[z]=R[U];l.uniform1iv(B.glLoc,B.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var G=0;G<B.array.length;++G){var k=B.offset+I+G;if(R[k]!==B.array[G]){for(var H=G,V=k;H<B.array.length;++H,++V)B.array[H]=R[V];l.uniform2iv(B.glLoc,B.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<B.array.length;++j){var W=B.offset+I+j;if(R[W]!==B.array[j]){for(var q=j,X=W;q<B.array.length;++q,++X)B.array[q]=R[X];l.uniform3iv(B.glLoc,B.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<B.array.length;++Y){var K=B.offset+I+Y;if(R[K]!==B.array[Y]){for(var Q=Y,Z=K;Q<B.array.length;++Q,++Z)B.array[Q]=R[Z];l.uniform4iv(B.glLoc,B.array);break}}break;case l.FLOAT:for(var J=0;J<B.array.length;++J){var $=B.offset+I+J;if(R[$]!==B.array[J]){for(var ee=J,te=$;ee<B.array.length;++ee,++te)B.array[ee]=R[te];l.uniform1fv(B.glLoc,B.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<B.array.length;++ne){var ie=B.offset+I+ne;if(R[ie]!==B.array[ne]){for(var re=ne,ae=ie;re<B.array.length;++re,++ae)B.array[re]=R[ae];l.uniform2fv(B.glLoc,B.array);break}}break;case l.FLOAT_VEC3:for(var oe=0;oe<B.array.length;++oe){var se=B.offset+I+oe;if(R[se]!==B.array[oe]){for(var ce=oe,le=se;ce<B.array.length;++ce,++le)B.array[ce]=R[le];l.uniform3fv(B.glLoc,B.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<B.array.length;++ue){var he=B.offset+I+ue;if(R[he]!==B.array[ue]){for(var _e=ue,fe=he;_e<B.array.length;++_e,++fe)B.array[_e]=R[fe];l.uniform4fv(B.glLoc,B.array);break}}break;case l.FLOAT_MAT2:for(var pe=0;pe<B.array.length;++pe){var de=B.offset+I+pe;if(R[de]!==B.array[pe]){for(var me=pe,ve=de;me<B.array.length;++me,++ve)B.array[me]=R[ve];l.uniformMatrix2fv(B.glLoc,!1,B.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<B.array.length;++ge){var ye=B.offset+I+ge;if(R[ye]!==B.array[ge]){for(var xe=ge,Se=ye;xe<B.array.length;++xe,++Se)B.array[xe]=R[Se];l.uniformMatrix3fv(B.glLoc,!1,B.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<B.array.length;++Te){var Ee=B.offset+I+Te;if(R[Ee]!==B.array[Te]){for(var Ae=Te,Ce=Ee;Ae<B.array.length;++Ae,++Ce)B.array[Ae]=R[Ce];l.uniformMatrix4fv(B.glLoc,!1,B.array);break}}}}else d("Buffer binding '"+A.name+"' at set "+A.set+" binding "+A.binding+" is not bounded")}for(var be=h.glSamplerTextures.length,Pe=0;Pe<be;Pe++)for(var Re=h.glSamplerTextures[Pe],Ie=i[Re.set],we=Ie&&Ie.descriptorIndices[Re.binding],De=we>=0&&Ie.gpuDescriptors[we],Oe=Re.units.length,Me=0;Me<Oe;Me++){var Ne=Re.units[Me];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Be=De.gpuTexture,Fe=u.glTexUnits[Ne];Fe.glTexture!==Be.glTexture&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),Be.glTexture?l.bindTexture(Be.glTarget,Be.glTexture):l.bindTexture(Be.glTarget,e.nullTex2D.gpuTexture.glTexture),Fe.glTexture=Be.glTexture);var Le=De.gpuSampler;Be.isPowerOf2?(o=Le.glWrapS,s=Le.glWrapT):(o=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Be.isPowerOf2?Be.mipLevel<=1&&(Le.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Le.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Le.glMinFilter:Le.glMinFilter===l.LINEAR||Le.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Le.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Be.glWrapS!==o&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Be.glTarget,l.TEXTURE_WRAP_S,o),Be.glWrapS=o),Be.glWrapT!==s&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Be.glTarget,l.TEXTURE_WRAP_T,s),Be.glWrapT=s),Be.glMinFilter!==c&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Be.glTarget,l.TEXTURE_MIN_FILTER,c),Be.glMinFilter=c),Be.glMagFilter!==Le.glMagFilter&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Be.glTarget,l.TEXTURE_MAG_FILTER,Le.glMagFilter),Be.glMagFilter=Le.glMagFilter)}De=Ie.gpuDescriptors[++we]}else d("Sampler binding '"+Re.name+"' at set "+Re.set+" binding "+Re.binding+" index "+Me+" is not bounded")}}if(n&&h&&(_||L4.gpuInputAssembler!==n)){L4.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,Ge=n.glVAOs.get(h.glProgram);if(!Ge){var ke;Ge=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Ge),Ue.bindVertexArrayOES(Ge),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var je=h.glInputs[Ve];ke=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){ke=Xe;break}}if(ke){u.glArrayBuffer!==ke.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ke.glBuffer),u.glArrayBuffer=ke.glBuffer);for(var Ye=0;Ye<ke.componentCount;++Ye){var Ke=je.glLoc+Ye,Qe=ke.offset+ke.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,ke.count,ke.glType,ke.isNormalized,ke.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,ke.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Ge&&(Ue.bindVertexArrayOES(Ge),u.glVAO=Ge)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var at=n.glAttribs[rt];if(at.name===tt.name){nt=at;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var ot=0;ot<nt.componentCount;++ot){var st=tt.glLoc+ot,ct=nt.offset+nt.size*ot;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Qr.LINE_WIDTH:u.rs.lineWidth!==a.lineWidth&&(l.lineWidth(a.lineWidth),u.rs.lineWidth=a.lineWidth);break;case Qr.DEPTH_BIAS:u.rs.depthBias===a.depthBiasConstant&&u.rs.depthBiasSlop===a.depthBiasSlope||(l.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),u.rs.depthBias=a.depthBiasConstant,u.rs.depthBiasSlop=a.depthBiasSlope);break;case Qr.BLEND_CONSTANTS:var ft=a.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case Qr.STENCIL_WRITE_MASK:var pt=a.stencilStatesFront,dt=a.stencilStatesBack;u.dss.stencilWriteMaskFront!==pt.writeMask&&(l.stencilMaskSeparate(l.FRONT,pt.writeMask),u.dss.stencilWriteMaskFront=pt.writeMask),u.dss.stencilWriteMaskBack!==dt.writeMask&&(l.stencilMaskSeparate(l.BACK,dt.writeMask),u.dss.stencilWriteMaskBack=dt.writeMask);break;case Qr.STENCIL_COMPARE_MASK:var mt=a.stencilStatesFront,vt=a.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,C4[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,C4[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function G4(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,a=i.WEBGL_multi_draw,o=L4.gpuInputAssembler,s=L4.glPrimitive;if(o){var c=o.gpuIndexBuffer;if(o.gpuIndirectBuffer){var l=o.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(a)l.instancedDraw?a.multiDrawElementsInstancedWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):a.multiDrawElementsWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],o.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],o.glIndexType,l.byteOffsets[h])}else if(a)l.instancedDraw?a.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):a.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,o.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var p=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,o.glIndexType,p)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var k4=new Array(A4.COUNT);function H4(e,t){k4.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=k4[i]++;switch(i){case A4.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];z4(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case A4.BIND_STATES:var o=t.bindStatesCmds.array[r];U4(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case A4.DRAW:G4(e,t.drawCmds.array[r].drawInfo);break;case A4.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];F4(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case A4.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];V4(e,c.buffers,c.gpuTexture,c.regions)}}}function V4(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=lo[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[o++];u?n.glInternalFmt===d4.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[o++];u?n.glInternalFmt===d4.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&wr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var j4=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Dn(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),W4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Ar.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new j4,glTarget:0,glBuffer:null},this._usage&Ar.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Ar.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Ar.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Ar.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(v4.instance,this._gpuBuffer),v4.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),L4.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),L4.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(v4.instance,this._gpuBuffer),v4.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Ar.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Ar.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),L4.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Ar.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(v4.instance,this._gpuBuffer),v4.instance.memoryStatus.bufferSize-=t,v4.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Ar.INDIRECT?0:e.byteLength,F4(v4.instance,this._gpuBuffer,e,0,n))},B(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(So),q4=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new qe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),X4=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new q4(w4,1),this.bindStatesCmdPool=new q4(D4,1),this.drawCmdPool=new q4(O4,1),this.updateBufferCmdPool=new q4(M4,1),this.copyBufferToTextureCmdPool=new q4(N4,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Y4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new B4,t._cmdAllocator=new X4,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new so,t._isStateInvalied=!1,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=v4.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(w4);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=n,o.clearColors.length=i.length;for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(A4.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Zr.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Zr.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Zr.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Zr.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===ta.PRIMARY&&this._isInRenderPass||this._type===ta.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(O4);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(A4.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===ta.PRIMARY&&!this._isInRenderPass||this._type===ta.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(M4),o=0;e.usage&Ar.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(A4.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===ta.PRIMARY&&!this._isInRenderPass||this._type===ta.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(N4);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(A4.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(D4);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(A4.BIND_STATES),this._isStateInvalied=!1)},t}(To),K4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(e){o=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var s=t.gpuColorTextures[o];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=lo[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(v4.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=v4.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},B(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Co),Q4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=g4(a.format,n),l=lo[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:lo[a.format].count,stride:s.stride,componentCount:E4(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(v4.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=v4.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),a===i.value&&(r.bindVertexArrayOES(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},B(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Io),Z4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&_o)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},B(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Do),J4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},B(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Oo),$4=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],e3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:$4[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},B(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(zo),t3=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,a){z4(v4.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;G4(v4.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=v4.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=v4.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Ar.INDIRECT?0:t.byteLength,F4(v4.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&V4(v4.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];H4(v4.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){U4(v4.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(Y4),n3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Uo),i3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},B(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Go),r3=[10497,33648,33071,33071],a3=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,a,o=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=o===Mr.LINEAR||o===Mr.ANISOTROPIC?c===Mr.LINEAR||c===Mr.ANISOTROPIC?9987:c===Mr.POINT?9985:9729:c===Mr.LINEAR||c===Mr.ANISOTROPIC?9986:c===Mr.POINT?9984:9728,a=s===Mr.LINEAR||s===Mr.ANISOTROPIC?9729:9728;var l=r3[i._info.addressU],u=r3[i._info.addressV],h=r3[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:a,glWrapS:l,glWrapT:u,glWrapR:h},i}return L(t,e),B(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(ko),o3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Gr.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Gr.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+o+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"==typeof a)return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(t.glProgram,p),g=S4(f.type,n),y=T4(f.type,n);t.glInputs[_]={binding:m,name:p,type:g,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var x=0;x<t.blocks.length;++x){var S=t.blocks[x],T={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};t.glBlocks[x]=T;for(var E=0;E<S.members.length;++E){var A=S.members[E],C=y4(A.type,n),b=T4(C,n),P=b*A.count;T.glUniforms[E]={binding:-1,name:A.name,type:A.type,stride:b,count:A.count,size:P,offset:0,glType:C,glLoc:null,array:null}}}}for(var R=0;R<t.subpassInputs.length;++R){var I=t.subpassInputs[R];t.samplerTextures.push(new Oa(I.set,I.binding,I.name,Er.SAMPLER2D,I.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var w=0;w<t.samplerTextures.length;++w){var D=t.samplerTextures[w];t.glSamplerTextures[w]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:y4(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),M=0;M<O;++M){var N=n.getActiveUniform(t.glProgram,M);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var B=n.getUniformLocation(t.glProgram,N.name);if(e.extensions.isLocationActive(B)){var F,L=N.name.indexOf("[");F=-1!==L?N.name.substr(0,L):N.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],G=0;G<U.glUniforms.length;G++){var k=U.glUniforms[G];if(k.name===F){k.glLoc=B,k.count=N.size,k.size=k.stride*k.count,k.array=new(x4(k.type))(k.size/4),U.glActiveUniforms.push(k);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],Y=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var ae=q[re],oe=K[ae.name];if(void 0!==oe){ae.glLoc=X[re];for(var se=0;se<ae.count;++se){for(;ie[oe];)oe=(oe+1)%e.capabilities.maxTextureUnits;ae.units.push(oe),ie[oe]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<q.length;_e++){var fe=q[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(v4.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(v4.instance,this._gpuShader),this._gpuShader=null)},B(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Ho),s3=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new va,this.scissorRect=new ua(0,0,0,0),this.rs=new Mo,this.dss=new No,this.bs=new Fo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),c3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=fo(this._width)&&fo(this._height),this._size=mo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case Sr.A8:return t.ALPHA;case Sr.L8:return t.LUMINANCE;case Sr.LA8:return t.LUMINANCE_ALPHA;case Sr.RGB8:case Sr.RGB16F:case Sr.RGB32F:return t.RGB;case Sr.BGRA8:case Sr.RGBA8:case Sr.SRGB8_A8:case Sr.RGBA16F:case Sr.RGBA32F:return t.RGBA;case Sr.R5G6B5:return t.RGB;case Sr.RGB5A1:case Sr.RGBA4:return t.RGBA;case Sr.DEPTH:return t.DEPTH_COMPONENT;case Sr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Sr.BC1:return d4.COMPRESSED_RGB_S3TC_DXT1_EXT;case Sr.BC1_ALPHA:return d4.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Sr.BC1_SRGB:return d4.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Sr.BC1_SRGB_ALPHA:return d4.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Sr.BC2:return d4.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Sr.BC2_SRGB:return d4.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Sr.BC3:return d4.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Sr.BC3_SRGB:return d4.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Sr.ETC_RGB8:return d4.COMPRESSED_RGB_ETC1_WEBGL;case Sr.ETC2_RGB8:return d4.COMPRESSED_RGB8_ETC2;case Sr.ETC2_SRGB8:return d4.COMPRESSED_SRGB8_ETC2;case Sr.ETC2_RGB8_A1:return d4.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_SRGB8_A1:return d4.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_RGBA8:return d4.COMPRESSED_RGBA8_ETC2_EAC;case Sr.ETC2_SRGB8_A8:return d4.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Sr.EAC_R11:return d4.COMPRESSED_R11_EAC;case Sr.EAC_R11SN:return d4.COMPRESSED_SIGNED_R11_EAC;case Sr.EAC_RG11:return d4.COMPRESSED_RG11_EAC;case Sr.EAC_RG11SN:return d4.COMPRESSED_SIGNED_RG11_EAC;case Sr.PVRTC_RGB2:return d4.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGBA2:return d4.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGB4:return d4.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Sr.PVRTC_RGBA4:return d4.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Sr.ASTC_RGBA_4X4:return d4.COMPRESSED_RGBA_ASTC_4x4_KHR;case Sr.ASTC_RGBA_5X4:return d4.COMPRESSED_RGBA_ASTC_5x4_KHR;case Sr.ASTC_RGBA_5X5:return d4.COMPRESSED_RGBA_ASTC_5x5_KHR;case Sr.ASTC_RGBA_6X5:return d4.COMPRESSED_RGBA_ASTC_6x5_KHR;case Sr.ASTC_RGBA_6X6:return d4.COMPRESSED_RGBA_ASTC_6x6_KHR;case Sr.ASTC_RGBA_8X5:return d4.COMPRESSED_RGBA_ASTC_8x5_KHR;case Sr.ASTC_RGBA_8X6:return d4.COMPRESSED_RGBA_ASTC_8x6_KHR;case Sr.ASTC_RGBA_8X8:return d4.COMPRESSED_RGBA_ASTC_8x8_KHR;case Sr.ASTC_RGBA_10X5:return d4.COMPRESSED_RGBA_ASTC_10x5_KHR;case Sr.ASTC_RGBA_10X6:return d4.COMPRESSED_RGBA_ASTC_10x6_KHR;case Sr.ASTC_RGBA_10X8:return d4.COMPRESSED_RGBA_ASTC_10x8_KHR;case Sr.ASTC_RGBA_10X10:return d4.COMPRESSED_RGBA_ASTC_10x10_KHR;case Sr.ASTC_RGBA_12X10:return d4.COMPRESSED_RGBA_ASTC_12x10_KHR;case Sr.ASTC_RGBA_12X12:return d4.COMPRESSED_RGBA_ASTC_12x12_KHR;case Sr.ASTC_SRGBA_4X4:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Sr.ASTC_SRGBA_5X4:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Sr.ASTC_SRGBA_5X5:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Sr.ASTC_SRGBA_6X5:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Sr.ASTC_SRGBA_6X6:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Sr.ASTC_SRGBA_8X5:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Sr.ASTC_SRGBA_8X6:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Sr.ASTC_SRGBA_8X8:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Sr.ASTC_SRGBA_10X5:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Sr.ASTC_SRGBA_10X6:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Sr.ASTC_SRGBA_10X8:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Sr.ASTC_SRGBA_10X10:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Sr.ASTC_SRGBA_12X10:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Sr.ASTC_SRGBA_12X12:return d4.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=g4(t.format,n);var i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&b(9100,a,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&lo[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case Sr.R5G6B5:return t.RGB565;case Sr.RGB5A1:return t.RGB5_A1;case Sr.RGBA4:return t.RGBA4;case Sr.RGBA16F:return d4.RGBA16F_EXT;case Sr.RGBA32F:return d4.RGBA32F_EXT;case Sr.SRGB8_A8:return d4.SRGB8_ALPHA8_EXT;case Sr.DEPTH:return t.DEPTH_COMPONENT16;case Sr.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),lo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=po(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&b(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),lo[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=po(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}(v4.instance,this._gpuTexture),v4.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;a++)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}(v4.instance,this._gpuTexture),v4.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=mo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&b(9100,a,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),lo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=po(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&b(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),lo[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=po(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}}(v4.instance,this._gpuTexture),v4.instance.memoryStatus.textureSize-=n,v4.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Pa;t.format=e.format,t.usage=lo[e.format].hasDepth?Ir.DEPTH_STENCIL_ATTACHMENT:Ir.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},B(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Vo),l3="webglcontextlost";function u3(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function h3(e){var t={EXT_texture_filter_anisotropic:u3(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:u3(e,"EXT_blend_minmax"),EXT_frag_depth:u3(e,"EXT_frag_depth"),EXT_shader_texture_lod:u3(e,"EXT_shader_texture_lod"),EXT_sRGB:u3(e,"EXT_sRGB"),OES_vertex_array_object:u3(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:u3(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:u3(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:u3(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:u3(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:u3(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:u3(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:u3(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:u3(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:u3(e,"WEBGL_draw_buffers"),WEBGL_lose_context:u3(e,"WEBGL_lose_context"),WEBGL_depth_texture:u3(e,"WEBGL_depth_texture"),OES_texture_half_float:u3(e,"OES_texture_half_float"),OES_texture_half_float_linear:u3(e,"OES_texture_half_float_linear"),OES_texture_float:u3(e,"OES_texture_float"),OES_texture_float_linear:u3(e,"OES_texture_float_linear"),OES_standard_derivatives:u3(e,"OES_standard_derivatives"),OES_element_index_uint:u3(e,"OES_element_index_uint"),ANGLE_instanced_arrays:u3(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:u3(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return fn.os===ln.IOS&&14===fn.osMainVersion&&fn.isBrowser||(t.WEBGL_compressed_texture_astc=u3(e,"WEBGL_compressed_texture_astc")),fn.os!==ln.ANDROID&&fn.os!==ln.IOS&&(t.WEBGL_multi_draw=u3(e,"WEBGL_multi_draw")),fn.browserType===on.UC&&(t.ANGLE_instanced_arrays=null),fn.os===ln.IOS&&fn.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var _3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new s3,t.cmdAllocator=new X4,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(l3,this._onWebGLContextLost);var t=v4.instance.gl;this.stateCache.initialize(v4.instance.capabilities.maxTextureUnits,v4.instance.capabilities.maxVertexAttributes),this._extensions=h3(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Sr.RGBA8,i=Sr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=Sr.DEPTH_STENCIL:r&&(i=Sr.DEPTH),this._colorTexture=new c3,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new c3,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=v4.instance.createTexture(new Pa(Rr.TEX2D,Ir.SAMPLED,Sr.RGBA8,2,2,wr.GEN_MIPMAP)),this.nullTexCube=v4.instance.createTexture(new Pa(Rr.CUBE,Ir.SAMPLED,Sr.RGBA8,2,2,wr.GEN_MIPMAP,6));var o=new ma;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),v4.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,v4.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(l3,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(v("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){A(11e3),p(e)},B(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ao),f3=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){v4.setInstance(this),this._gfxAPI=gr.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:$e.ENABLE_TRANSPARENT_CANVAS,antialias:$e.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(Eo.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new no($r.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new to(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=t.getSupportedExtensions(),i="";if(n)for(var r,a=W(n);!(r=a()).done;)i+=r.value+" ";var o=h3(t);o.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(o.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(o.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),o.EXT_sRGB&&(this._features[xr.FORMAT_SRGB]=!0),o.EXT_blend_minmax&&(this._features[xr.BLEND_MINMAX]=!0),o.WEBGL_color_buffer_float&&(this._features[xr.COLOR_FLOAT]=!0),o.EXT_color_buffer_half_float&&(this._features[xr.COLOR_HALF_FLOAT]=!0),o.OES_texture_float&&(this._features[xr.TEXTURE_FLOAT]=!0),o.OES_texture_half_float&&(this._features[xr.TEXTURE_HALF_FLOAT]=!0),o.OES_texture_float_linear&&(this._features[xr.TEXTURE_FLOAT_LINEAR]=!0),o.OES_texture_half_float_linear&&(this._features[xr.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[xr.FORMAT_RGB8]=!0,o.OES_element_index_uint&&(this._features[xr.ELEMENT_INDEX_UINT]=!0),o.ANGLE_instanced_arrays&&(this._features[xr.INSTANCED_ARRAYS]=!0),o.WEBGL_draw_buffers&&(this._features[xr.MULTIPLE_RENDER_TARGETS]=!0);var c="";return o.WEBGL_compressed_texture_etc1&&(this._features[xr.FORMAT_ETC1]=!0,c+="etc1 "),o.WEBGL_compressed_texture_etc&&(this._features[xr.FORMAT_ETC2]=!0,c+="etc2 "),o.WEBGL_compressed_texture_s3tc&&(this._features[xr.FORMAT_DXT]=!0,c+="dxt "),o.WEBGL_compressed_texture_pvrtc&&(this._features[xr.FORMAT_PVRTC]=!0,c+="pvrtc "),o.WEBGL_compressed_texture_astc&&(this._features[xr.FORMAT_ASTC]=!0,c+="astc "),v("WebGL device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===ta.PRIMARY?t3:Y4);return t.initialize(e),t},n.createSwapchain=function(e){var t=new _3;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new W4;return t.initialize(e),t},n.createTexture=function(e){var t=new c3;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new m4;return t.initialize(e),t},n.createShader=function(e){var t=new o3;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new Q4;return t.initialize(e),t},n.createRenderPass=function(e){var t=new i3;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new K4;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new Z4;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new J4;return t.initialize(e),t},n.createPipelineState=function(e){var t=new e3;return t.initialize(e),t},n.createQueue=function(e){var t=new n3;return t.initialize(e),t},n.getSampler=function(e){var t=ko.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new a3(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=jo.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new jo(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Wo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Wo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){V4(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&wr.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},B(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(Eo));i.WebGLDevice=f3;var p3,d3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&uo?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&ho&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},B(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(wo);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(p3||(p3={}));var m3=function(){function e(){}return e.setInstance=function(t){e._instance=t},B(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();m3._instance=null;var v3=[10497,33648,33071,33071],g3=new Float32Array(4);function y3(e,t){switch(e){case Sr.R8:return t.UNSIGNED_BYTE;case Sr.R8SN:return t.BYTE;case Sr.R8UI:return t.UNSIGNED_BYTE;case Sr.R8I:return t.BYTE;case Sr.R16F:return t.HALF_FLOAT;case Sr.R16UI:return t.UNSIGNED_SHORT;case Sr.R16I:return t.SHORT;case Sr.R32F:return t.FLOAT;case Sr.R32UI:return t.UNSIGNED_INT;case Sr.R32I:return t.INT;case Sr.RG8:return t.UNSIGNED_BYTE;case Sr.RG8SN:return t.BYTE;case Sr.RG8UI:return t.UNSIGNED_BYTE;case Sr.RG8I:return t.BYTE;case Sr.RG16F:return t.HALF_FLOAT;case Sr.RG16UI:return t.UNSIGNED_SHORT;case Sr.RG16I:return t.SHORT;case Sr.RG32F:return t.FLOAT;case Sr.RG32UI:return t.UNSIGNED_INT;case Sr.RG32I:return t.INT;case Sr.RGB8:case Sr.SRGB8:return t.UNSIGNED_BYTE;case Sr.RGB8SN:return t.BYTE;case Sr.RGB8UI:return t.UNSIGNED_BYTE;case Sr.RGB8I:return t.BYTE;case Sr.RGB16F:return t.HALF_FLOAT;case Sr.RGB16UI:return t.UNSIGNED_SHORT;case Sr.RGB16I:return t.SHORT;case Sr.RGB32F:return t.FLOAT;case Sr.RGB32UI:return t.UNSIGNED_INT;case Sr.RGB32I:return t.INT;case Sr.BGRA8:case Sr.RGBA8:case Sr.SRGB8_A8:return t.UNSIGNED_BYTE;case Sr.RGBA8SN:return t.BYTE;case Sr.RGBA8UI:return t.UNSIGNED_BYTE;case Sr.RGBA8I:return t.BYTE;case Sr.RGBA16F:return t.HALF_FLOAT;case Sr.RGBA16UI:return t.UNSIGNED_SHORT;case Sr.RGBA16I:return t.SHORT;case Sr.RGBA32F:return t.FLOAT;case Sr.RGBA32UI:return t.UNSIGNED_INT;case Sr.RGBA32I:return t.INT;case Sr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Sr.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Sr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Sr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Sr.RGB10A2:case Sr.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Sr.RGB9E5:case Sr.DEPTH:return t.FLOAT;case Sr.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case Sr.BC1:case Sr.BC1_SRGB:case Sr.BC2:case Sr.BC2_SRGB:case Sr.BC3:case Sr.BC3_SRGB:case Sr.BC4:return t.UNSIGNED_BYTE;case Sr.BC4_SNORM:return t.BYTE;case Sr.BC5:return t.UNSIGNED_BYTE;case Sr.BC5_SNORM:return t.BYTE;case Sr.BC6H_SF16:case Sr.BC6H_UF16:return t.FLOAT;case Sr.BC7:case Sr.BC7_SRGB:case Sr.ETC_RGB8:case Sr.ETC2_RGB8:case Sr.ETC2_SRGB8:case Sr.ETC2_RGB8_A1:case Sr.ETC2_SRGB8_A1:case Sr.EAC_R11:return t.UNSIGNED_BYTE;case Sr.EAC_R11SN:return t.BYTE;case Sr.EAC_RG11:return t.UNSIGNED_BYTE;case Sr.EAC_RG11SN:return t.BYTE;case Sr.PVRTC_RGB2:case Sr.PVRTC_RGBA2:case Sr.PVRTC_RGB4:case Sr.PVRTC_RGBA4:case Sr.PVRTC2_2BPP:case Sr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Sr.ASTC_RGBA_4X4:case Sr.ASTC_RGBA_5X4:case Sr.ASTC_RGBA_5X5:case Sr.ASTC_RGBA_6X5:case Sr.ASTC_RGBA_6X6:case Sr.ASTC_RGBA_8X5:case Sr.ASTC_RGBA_8X6:case Sr.ASTC_RGBA_8X8:case Sr.ASTC_RGBA_10X5:case Sr.ASTC_RGBA_10X6:case Sr.ASTC_RGBA_10X8:case Sr.ASTC_RGBA_10X10:case Sr.ASTC_RGBA_12X10:case Sr.ASTC_RGBA_12X12:case Sr.ASTC_SRGBA_4X4:case Sr.ASTC_SRGBA_5X4:case Sr.ASTC_SRGBA_5X5:case Sr.ASTC_SRGBA_6X5:case Sr.ASTC_SRGBA_6X6:case Sr.ASTC_SRGBA_8X5:case Sr.ASTC_SRGBA_8X6:case Sr.ASTC_SRGBA_8X8:case Sr.ASTC_SRGBA_10X5:case Sr.ASTC_SRGBA_10X6:case Sr.ASTC_SRGBA_10X8:case Sr.ASTC_SRGBA_10X10:case Sr.ASTC_SRGBA_12X10:case Sr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function x3(e,t){switch(e){case Er.BOOL:return t.BOOL;case Er.BOOL2:return t.BOOL_VEC2;case Er.BOOL3:return t.BOOL_VEC3;case Er.BOOL4:return t.BOOL_VEC4;case Er.INT:return t.INT;case Er.INT2:return t.INT_VEC2;case Er.INT3:return t.INT_VEC3;case Er.INT4:return t.INT_VEC4;case Er.UINT:return t.UNSIGNED_INT;case Er.FLOAT:return t.FLOAT;case Er.FLOAT2:return t.FLOAT_VEC2;case Er.FLOAT3:return t.FLOAT_VEC3;case Er.FLOAT4:return t.FLOAT_VEC4;case Er.MAT2:return t.FLOAT_MAT2;case Er.MAT2X3:return t.FLOAT_MAT2x3;case Er.MAT2X4:return t.FLOAT_MAT2x4;case Er.MAT3X2:return t.FLOAT_MAT3x2;case Er.MAT3:return t.FLOAT_MAT3;case Er.MAT3X4:return t.FLOAT_MAT3x4;case Er.MAT4X2:return t.FLOAT_MAT4x2;case Er.MAT4X3:return t.FLOAT_MAT4x3;case Er.MAT4:return t.FLOAT_MAT4;case Er.SAMPLER2D:return t.SAMPLER_2D;case Er.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Er.SAMPLER3D:return t.SAMPLER_3D;case Er.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Er.UNKNOWN}}function S3(e,t){switch(e){case t.BOOL:return Er.BOOL;case t.BOOL_VEC2:return Er.BOOL2;case t.BOOL_VEC3:return Er.BOOL3;case t.BOOL_VEC4:return Er.BOOL4;case t.INT:return Er.INT;case t.INT_VEC2:return Er.INT2;case t.INT_VEC3:return Er.INT3;case t.INT_VEC4:return Er.INT4;case t.UNSIGNED_INT:return Er.UINT;case t.UNSIGNED_INT_VEC2:return Er.UINT2;case t.UNSIGNED_INT_VEC3:return Er.UINT3;case t.UNSIGNED_INT_VEC4:return Er.UINT4;case t.FLOAT:return Er.FLOAT;case t.FLOAT_VEC2:return Er.FLOAT2;case t.FLOAT_VEC3:return Er.FLOAT3;case t.FLOAT_VEC4:return Er.FLOAT4;case t.FLOAT_MAT2:return Er.MAT2;case t.FLOAT_MAT2x3:return Er.MAT2X3;case t.FLOAT_MAT2x4:return Er.MAT2X4;case t.FLOAT_MAT3x2:return Er.MAT3X2;case t.FLOAT_MAT3:return Er.MAT3;case t.FLOAT_MAT3x4:return Er.MAT3X4;case t.FLOAT_MAT4x2:return Er.MAT4X2;case t.FLOAT_MAT4x3:return Er.MAT4X3;case t.FLOAT_MAT4:return Er.MAT4;case t.SAMPLER_2D:return Er.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Er.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Er.SAMPLER3D;case t.SAMPLER_CUBE:return Er.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Er.UNKNOWN}}function T3(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function E3(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var A3,C3=[512,513,514,515,516,517,518,519],b3=[0,7680,7681,7682,7683,5386,34055,34056],P3=[32774,32778,32779,32775,32776],R3=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(A3||(A3={}));var I3=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},w3=function(e){function t(){var t;return(t=e.call(this,A3.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new ua,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return L(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(I3),D3=function(e){function t(){var t;return(t=e.call(this,A3.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new so,t}return L(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(I3),O3=function(e){function t(){var t;return(t=e.call(this,A3.DRAW)||this).drawInfo=new Aa,t}return L(t,e),t.prototype.clear=function(){},t}(I3),M3=function(e){function t(){var t;return(t=e.call(this,A3.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return L(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(I3),N3=function(e){function t(){var t;return(t=e.call(this,A3.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return L(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(I3),B3=function(){function e(){this.cmds=new qe(1),this.beginRenderPassCmds=new qe(1),this.bindStatesCmds=new qe(1),this.drawCmds=new qe(1),this.updateBufferCmds=new qe(1),this.copyBufferToTextureCmds=new qe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function F3(e,t,n,i,r){if(t.usage&Ar.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),U3.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),U3.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function L3(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case Sr.A8:return t.ALPHA;case Sr.L8:return t.LUMINANCE;case Sr.LA8:return t.LUMINANCE_ALPHA;case Sr.R8:return t.R8;case Sr.R8SN:return t.R8_SNORM;case Sr.R8UI:return t.R8UI;case Sr.R8I:return t.R8I;case Sr.RG8:return t.RG8;case Sr.RG8SN:return t.RG8_SNORM;case Sr.RG8UI:return t.RG8UI;case Sr.RG8I:return t.RG8I;case Sr.RGB8:return t.RGB8;case Sr.RGB8SN:return t.RGB8_SNORM;case Sr.RGB8UI:return t.RGB8UI;case Sr.RGB8I:return t.RGB8I;case Sr.BGRA8:case Sr.RGBA8:return t.RGBA8;case Sr.RGBA8SN:return t.RGBA8_SNORM;case Sr.RGBA8UI:return t.RGBA8UI;case Sr.RGBA8I:return t.RGBA8I;case Sr.R16I:return t.R16I;case Sr.R16UI:return t.R16UI;case Sr.R16F:return t.R16F;case Sr.RG16I:return t.RG16I;case Sr.RG16UI:return t.RG16UI;case Sr.RG16F:return t.RG16F;case Sr.RGB16I:return t.RGB16I;case Sr.RGB16UI:return t.RGB16UI;case Sr.RGB16F:return t.RGB16F;case Sr.RGBA16I:return t.RGBA16I;case Sr.RGBA16UI:return t.RGBA16UI;case Sr.RGBA16F:return t.RGBA16F;case Sr.R32I:return t.R32I;case Sr.R32UI:return t.R32UI;case Sr.R32F:return t.R32F;case Sr.RG32I:return t.RG32I;case Sr.RG32UI:return t.RG32UI;case Sr.RG32F:return t.RG32F;case Sr.RGB32I:return t.RGB32I;case Sr.RGB32UI:return t.RGB32UI;case Sr.RGB32F:return t.RGB32F;case Sr.RGBA32I:return t.RGBA32I;case Sr.RGBA32UI:return t.RGBA32UI;case Sr.RGBA32F:return t.RGBA32F;case Sr.R5G6B5:return t.RGB565;case Sr.RGB5A1:return t.RGB5_A1;case Sr.RGBA4:return t.RGBA4;case Sr.SRGB8:return t.SRGB8;case Sr.SRGB8_A8:return t.SRGB8_ALPHA8;case Sr.RGB10A2:return t.RGB10_A2;case Sr.RGB10A2UI:return t.RGB10_A2UI;case Sr.R11G11B10F:return t.R11F_G11F_B10F;case Sr.DEPTH:return t.DEPTH_COMPONENT32F;case Sr.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case Sr.BC1:return p3.COMPRESSED_RGB_S3TC_DXT1_EXT;case Sr.BC1_ALPHA:return p3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Sr.BC1_SRGB:return p3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Sr.BC1_SRGB_ALPHA:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Sr.BC2:return p3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Sr.BC2_SRGB:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Sr.BC3:return p3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Sr.BC3_SRGB:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Sr.ETC_RGB8:return p3.COMPRESSED_RGB_ETC1_WEBGL;case Sr.ETC2_RGB8:return p3.COMPRESSED_RGB8_ETC2;case Sr.ETC2_SRGB8:return p3.COMPRESSED_SRGB8_ETC2;case Sr.ETC2_RGB8_A1:return p3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_SRGB8_A1:return p3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_RGBA8:return p3.COMPRESSED_RGBA8_ETC2_EAC;case Sr.ETC2_SRGB8_A8:return p3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Sr.EAC_R11:return p3.COMPRESSED_R11_EAC;case Sr.EAC_R11SN:return p3.COMPRESSED_SIGNED_R11_EAC;case Sr.EAC_RG11:return p3.COMPRESSED_RG11_EAC;case Sr.EAC_RG11SN:return p3.COMPRESSED_SIGNED_RG11_EAC;case Sr.PVRTC_RGB2:return p3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGBA2:return p3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGB4:return p3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Sr.PVRTC_RGBA4:return p3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Sr.ASTC_RGBA_4X4:return p3.COMPRESSED_RGBA_ASTC_4x4_KHR;case Sr.ASTC_RGBA_5X4:return p3.COMPRESSED_RGBA_ASTC_5x4_KHR;case Sr.ASTC_RGBA_5X5:return p3.COMPRESSED_RGBA_ASTC_5x5_KHR;case Sr.ASTC_RGBA_6X5:return p3.COMPRESSED_RGBA_ASTC_6x5_KHR;case Sr.ASTC_RGBA_6X6:return p3.COMPRESSED_RGBA_ASTC_6x6_KHR;case Sr.ASTC_RGBA_8X5:return p3.COMPRESSED_RGBA_ASTC_8x5_KHR;case Sr.ASTC_RGBA_8X6:return p3.COMPRESSED_RGBA_ASTC_8x6_KHR;case Sr.ASTC_RGBA_8X8:return p3.COMPRESSED_RGBA_ASTC_8x8_KHR;case Sr.ASTC_RGBA_10X5:return p3.COMPRESSED_RGBA_ASTC_10x5_KHR;case Sr.ASTC_RGBA_10X6:return p3.COMPRESSED_RGBA_ASTC_10x6_KHR;case Sr.ASTC_RGBA_10X8:return p3.COMPRESSED_RGBA_ASTC_10x8_KHR;case Sr.ASTC_RGBA_10X10:return p3.COMPRESSED_RGBA_ASTC_10x10_KHR;case Sr.ASTC_RGBA_12X10:return p3.COMPRESSED_RGBA_ASTC_12x10_KHR;case Sr.ASTC_RGBA_12X12:return p3.COMPRESSED_RGBA_ASTC_12x12_KHR;case Sr.ASTC_SRGBA_4X4:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Sr.ASTC_SRGBA_5X4:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Sr.ASTC_SRGBA_5X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Sr.ASTC_SRGBA_6X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Sr.ASTC_SRGBA_6X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Sr.ASTC_SRGBA_8X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Sr.ASTC_SRGBA_8X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Sr.ASTC_SRGBA_8X8:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Sr.ASTC_SRGBA_10X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Sr.ASTC_SRGBA_10X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Sr.ASTC_SRGBA_10X8:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Sr.ASTC_SRGBA_10X10:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Sr.ASTC_SRGBA_12X10:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Sr.ASTC_SRGBA_12X12:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case Sr.A8:return t.ALPHA;case Sr.L8:return t.LUMINANCE;case Sr.LA8:return t.LUMINANCE_ALPHA;case Sr.R8:case Sr.R8SN:return t.RED;case Sr.R8UI:case Sr.R8I:return t.RED;case Sr.RG8:case Sr.RG8SN:case Sr.RG8UI:case Sr.RG8I:return t.RG;case Sr.RGB8:case Sr.RGB8SN:case Sr.RGB8UI:case Sr.RGB8I:return t.RGB;case Sr.BGRA8:case Sr.RGBA8:case Sr.RGBA8SN:case Sr.RGBA8UI:case Sr.RGBA8I:return t.RGBA;case Sr.R16UI:case Sr.R16I:case Sr.R16F:return t.RED;case Sr.RG16UI:case Sr.RG16I:case Sr.RG16F:return t.RG;case Sr.RGB16UI:case Sr.RGB16I:case Sr.RGB16F:return t.RGB;case Sr.RGBA16UI:case Sr.RGBA16I:case Sr.RGBA16F:return t.RGBA;case Sr.R32UI:case Sr.R32I:case Sr.R32F:return t.RED;case Sr.RG32UI:case Sr.RG32I:case Sr.RG32F:return t.RG;case Sr.RGB32UI:case Sr.RGB32I:case Sr.RGB32F:return t.RGB;case Sr.RGBA32UI:case Sr.RGBA32I:case Sr.RGBA32F:case Sr.RGB10A2:return t.RGBA;case Sr.R11G11B10F:case Sr.R5G6B5:return t.RGB;case Sr.RGB5A1:case Sr.RGBA4:return t.RGBA;case Sr.SRGB8:return t.RGB;case Sr.SRGB8_A8:return t.RGBA;case Sr.DEPTH:return t.DEPTH_COMPONENT;case Sr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Sr.BC1:return p3.COMPRESSED_RGB_S3TC_DXT1_EXT;case Sr.BC1_ALPHA:return p3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Sr.BC1_SRGB:return p3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Sr.BC1_SRGB_ALPHA:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Sr.BC2:return p3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Sr.BC2_SRGB:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Sr.BC3:return p3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Sr.BC3_SRGB:return p3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Sr.ETC_RGB8:return p3.COMPRESSED_RGB_ETC1_WEBGL;case Sr.ETC2_RGB8:return p3.COMPRESSED_RGB8_ETC2;case Sr.ETC2_SRGB8:return p3.COMPRESSED_SRGB8_ETC2;case Sr.ETC2_RGB8_A1:return p3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_SRGB8_A1:return p3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Sr.ETC2_RGBA8:return p3.COMPRESSED_RGBA8_ETC2_EAC;case Sr.ETC2_SRGB8_A8:return p3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Sr.EAC_R11:return p3.COMPRESSED_R11_EAC;case Sr.EAC_R11SN:return p3.COMPRESSED_SIGNED_R11_EAC;case Sr.EAC_RG11:return p3.COMPRESSED_RG11_EAC;case Sr.EAC_RG11SN:return p3.COMPRESSED_SIGNED_RG11_EAC;case Sr.PVRTC_RGB2:return p3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGBA2:return p3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Sr.PVRTC_RGB4:return p3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Sr.PVRTC_RGBA4:return p3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Sr.ASTC_RGBA_4X4:return p3.COMPRESSED_RGBA_ASTC_4x4_KHR;case Sr.ASTC_RGBA_5X4:return p3.COMPRESSED_RGBA_ASTC_5x4_KHR;case Sr.ASTC_RGBA_5X5:return p3.COMPRESSED_RGBA_ASTC_5x5_KHR;case Sr.ASTC_RGBA_6X5:return p3.COMPRESSED_RGBA_ASTC_6x5_KHR;case Sr.ASTC_RGBA_6X6:return p3.COMPRESSED_RGBA_ASTC_6x6_KHR;case Sr.ASTC_RGBA_8X5:return p3.COMPRESSED_RGBA_ASTC_8x5_KHR;case Sr.ASTC_RGBA_8X6:return p3.COMPRESSED_RGBA_ASTC_8x6_KHR;case Sr.ASTC_RGBA_8X8:return p3.COMPRESSED_RGBA_ASTC_8x8_KHR;case Sr.ASTC_RGBA_10X5:return p3.COMPRESSED_RGBA_ASTC_10x5_KHR;case Sr.ASTC_RGBA_10X6:return p3.COMPRESSED_RGBA_ASTC_10x6_KHR;case Sr.ASTC_RGBA_10X8:return p3.COMPRESSED_RGBA_ASTC_10x8_KHR;case Sr.ASTC_RGBA_10X10:return p3.COMPRESSED_RGBA_ASTC_10x10_KHR;case Sr.ASTC_RGBA_12X10:return p3.COMPRESSED_RGBA_ASTC_12x10_KHR;case Sr.ASTC_RGBA_12X12:return p3.COMPRESSED_RGBA_ASTC_12x12_KHR;case Sr.ASTC_SRGBA_4X4:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Sr.ASTC_SRGBA_5X4:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Sr.ASTC_SRGBA_5X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Sr.ASTC_SRGBA_6X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Sr.ASTC_SRGBA_6X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Sr.ASTC_SRGBA_8X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Sr.ASTC_SRGBA_8X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Sr.ASTC_SRGBA_8X8:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Sr.ASTC_SRGBA_10X5:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Sr.ASTC_SRGBA_10X6:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Sr.ASTC_SRGBA_10X8:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Sr.ASTC_SRGBA_10X10:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Sr.ASTC_SRGBA_12X10:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Sr.ASTC_SRGBA_12X12:return p3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=y3(t.format,n);var i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&b(9100,a,e.capabilities.maxTextureSize),t.samples===Dr.ONE){if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),lo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=po(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&b(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),lo[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){for(var f=po(t.format,i,r,1),p=new Uint8Array(f),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,t.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}function z3(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;++a)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}var U3={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function G3(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),U3.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==Sr.UNKNOWN)switch(h.loadOp){case kr.LOAD:break;case kr.CLEAR:if(c.bs.targets[0].blendColorMask!==Ur.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)g3[0]=r[u].x,g3[1]=r[u].y,g3[2]=r[u].z,g3[3]=r[u].w,s.clearBufferfv(s.COLOR,u,g3);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case kr.DISCARD:U3.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Sr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case kr.DISCARD:U3.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(lo[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case kr.DISCARD:U3.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&U3.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,U3.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Ur.ALL){var p=(f&Ur.R)!==Ur.NONE,d=(f&Ur.G)!==Ur.NONE,m=(f&Ur.B)!==Ur.NONE,v=(f&Ur.A)!==Ur.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function k3(e,t,n,i,r,a){var o=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&U3.gpuPipelineState!==t){if(U3.gpuPipelineState=t,U3.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(o.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Kr.NONE:o.disable(o.CULL_FACE);break;case Kr.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case Kr.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(o.frontFace(_?o.CCW:o.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(o.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(o.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(o.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(o.depthFunc(C3[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,C3[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,b3[f.stencilFailOpFront],b3[f.stencilZFailOpFront],b3[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,C3[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,b3[f.stencilFailOpBack],b3[f.stencilZFailOpBack],b3[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var p=t.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(o.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var m=p.targets[0],v=s.bs.targets[0];v.blend!==m.blend&&(m.blend?o.enable(o.BLEND):o.disable(o.BLEND),v.blend=m.blend),v.blendEq===m.blendEq&&v.blendAlphaEq===m.blendAlphaEq||(o.blendEquationSeparate(P3[m.blendEq],P3[m.blendAlphaEq]),v.blendEq=m.blendEq,v.blendAlphaEq=m.blendAlphaEq),v.blendSrc===m.blendSrc&&v.blendDst===m.blendDst&&v.blendSrcAlpha===m.blendSrcAlpha&&v.blendDstAlpha===m.blendDstAlpha||(o.blendFuncSeparate(R3[m.blendSrc],R3[m.blendDst],R3[m.blendSrcAlpha],R3[m.blendDstAlpha]),v.blendSrc=m.blendSrc,v.blendDst=m.blendDst,v.blendSrcAlpha=m.blendSrcAlpha,v.blendDstAlpha=m.blendDstAlpha),v.blendColorMask!==m.blendColorMask&&(o.colorMask((m.blendColorMask&Ur.R)!==Ur.NONE,(m.blendColorMask&Ur.G)!==Ur.NONE,(m.blendColorMask&Ur.B)!==Ur.NONE,(m.blendColorMask&Ur.A)!==Ur.NONE),v.blendColorMask=m.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var g=c.glBlocks.length,y=t.gpuPipelineLayout.dynamicOffsetIndices,x=0;x<g;x++){var S=c.glBlocks[x],T=i[S.set],E=T&&T.descriptorIndices[S.binding],A=E>=0&&T.gpuDescriptors[E];if(A&&A.gpuBuffer){var C=y[S.set],b=C&&C[S.binding],P=A.gpuBuffer.glOffset;b>=0&&(P+=r[b]),s.glBindUBOs[S.glBinding]===A.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===P||(P?o.bindBufferRange(o.UNIFORM_BUFFER,S.glBinding,A.gpuBuffer.glBuffer,P,A.gpuBuffer.size):o.bindBufferBase(o.UNIFORM_BUFFER,S.glBinding,A.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=A.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=P)}else d("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var R=c.glSamplerTextures.length,I=0;I<R;I++)for(var w=c.glSamplerTextures[I],D=i[w.set],O=D&&D.descriptorIndices[w.binding],M=O>=0&&D.gpuDescriptors[O],N=0;N<w.units.length;N++){var B=w.units[N],F=s.glTexUnits[B];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var L=M.gpuTexture;F.glTexture!==L.glTexture&&(s.texUnit!==B&&(o.activeTexture(o.TEXTURE0+B),s.texUnit=B),L.glTexture?o.bindTexture(L.glTarget,L.glTexture):o.bindTexture(L.glTarget,e.nullTex2D.gpuTexture.glTexture),F.glTexture=L.glTexture);var z=M.gpuSampler;s.glSamplerUnits[B]!==z.glSampler&&(o.bindSampler(B,z.glSampler),s.glSamplerUnits[B]=z.glSampler)}M=D.gpuDescriptors[++O]}else d("Sampler binding '"+w.name+"' at set "+w.set+" binding "+w.binding+" index "+N+" is not bounded")}}if(n&&c&&(l||U3.gpuInputAssembler!==n))if(U3.gpuInputAssembler=n,e.extensions.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var G;U=o.createVertexArray(),n.glVAOs.set(c.glProgram,U),o.bindVertexArray(U),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var k=0;k<c.glInputs.length;k++){var H=c.glInputs[k];G=null;for(var V=0;V<n.glAttribs.length;V++){var j=n.glAttribs[V];if(j.name===H.name){G=j;break}}if(G){s.glArrayBuffer!==G.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,G.glBuffer),s.glArrayBuffer=G.glBuffer);for(var W=0;W<G.componentCount;++W){var q=H.glLoc+W,X=G.offset+G.size*W;o.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,o.vertexAttribPointer(q,G.count,G.glType,G.isNormalized,G.stride,X),o.vertexAttribDivisor(q,G.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,Y.glBuffer),o.bindVertexArray(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(o.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(o.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,o.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),o.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var ae=0;ae<e.capabilities.maxVertexAttributes;++ae)s.glEnabledAttribLocs[ae]!==s.glCurrentAttribLocs[ae]&&(o.disableVertexAttribArray(ae),s.glEnabledAttribLocs[ae]=!1)}if(t&&t.dynamicStates.length)for(var oe=t.dynamicStates.length,se=0;se<oe;se++)switch(t.dynamicStates[se]){case Qr.LINE_WIDTH:s.rs.lineWidth!==a.lineWidth&&(o.lineWidth(a.lineWidth),s.rs.lineWidth=a.lineWidth);break;case Qr.DEPTH_BIAS:s.rs.depthBias===a.depthBiasConstant&&s.rs.depthBiasSlop===a.depthBiasSlope||(o.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),s.rs.depthBias=a.depthBiasConstant,s.rs.depthBiasSlop=a.depthBiasSlope);break;case Qr.BLEND_CONSTANTS:var ce=a.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(o.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case Qr.STENCIL_WRITE_MASK:var le=a.stencilStatesFront,ue=a.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(o.stencilMaskSeparate(o.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(o.stencilMaskSeparate(o.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case Qr.STENCIL_COMPARE_MASK:var he=a.stencilStatesFront,_e=a.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(o.stencilFuncSeparate(o.FRONT,C3[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===_e.reference&&s.dss.stencilReadMaskBack===_e.compareMask||(o.stencilFuncSeparate(o.BACK,C3[s.dss.stencilFuncBack],_e.reference,_e.compareMask),s.dss.stencilRefBack=_e.reference,s.dss.stencilReadMaskBack=_e.compareMask)}}function H3(e,t){var n=e.gl,i=U3.gpuInputAssembler,r=U3.glPrimitive,a=e.extensions.WEBGL_multi_draw;if(i){var o=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*o.stride;if(a)s.instancedDraw?a.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):a.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(a)s.instancedDraw?a.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):a.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(o){if(t.indexCount>0){var h=t.firstIndex*o.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){var _=t.firstIndex*o.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var V3=new Array(A3.COUNT);function j3(e,t){V3.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=V3[i]++;switch(i){case A3.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];G3(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case A3.BIND_STATES:var o=t.bindStatesCmds.array[r];k3(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case A3.DRAW:H3(e,t.drawCmds.array[r].drawInfo);break;case A3.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];F3(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case A3.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];W3(e,c.buffers,c.gpuTexture,c.regions)}}}function W3(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=lo[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[o++];u?n.glInternalFmt!==p3.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[o++];u?n.glInternalFmt!==p3.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&wr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var q3=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Dn(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),X3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new q3,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Ar.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),U3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Ar.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),U3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Ar.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(m3.instance,this._gpuBuffer),m3.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),U3.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),U3.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(m3.instance,this._gpuBuffer),m3.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Ar.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),U3.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&Ar.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),U3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Ar.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(m3.instance,this._gpuBuffer),m3.instance.memoryStatus.bufferSize-=t,m3.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Ar.INDIRECT?0:e.byteLength,F3(m3.instance,this._gpuBuffer,e,0,n))},B(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(So),Y3=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new qe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),K3=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Y3(w3,1),this.bindStatesCmdPool=new Y3(D3,1),this.drawCmdPool=new Y3(O3,1),this.updateBufferCmdPool=new Y3(M3,1),this.copyBufferToTextureCmdPool=new Y3(N3,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Q3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new B3,t._cmdAllocator=new K3,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new so,t._isStateInvalied=!1,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=m3.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(w3);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=n;for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(A3.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Zr.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Zr.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Zr.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Zr.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===ta.PRIMARY&&this._isInRenderPass||this._type===ta.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(O3);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(A3.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===ta.PRIMARY&&!this._isInRenderPass||this._type===ta.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(M3),o=0;e.usage&Ar.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(A3.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===ta.PRIMARY&&!this._isInRenderPass||this._type===ta.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(N3);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(A3.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(D3);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(A3.BIND_STATES),this._isStateInvalied=!1},t}(To),Z3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(e){o=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var s=t.gpuColorTextures[o];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=lo[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(m3.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=m3.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},B(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Co),J3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=y3(a.format,n),l=lo[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:lo[a.format].count,stride:s.stride,componentCount:E3(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(m3.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=m3.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),a===i.value&&(r.bindVertexArray(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},B(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Io),$3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&_o)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},B(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Do),e5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},B(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Oo),t5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],n5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:t5[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},B(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(zo),i5=function(e){function t(){return e.apply(this,arguments)||this}L(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,a){G3(m3.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;H3(m3.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=m3.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=m3.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Ar.INDIRECT?0:t.byteLength,F3(m3.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&W3(m3.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];j3(m3.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){k3(m3.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(Q3),r5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Uo),a5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},B(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Go),o5=function(e){function t(t,n){var i,r,a,o,s;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=m3.instance,a=i._gpuSampler,(s=(o=r.gl).createSampler())&&(a.minFilter===Mr.LINEAR||a.minFilter===Mr.ANISOTROPIC?a.mipFilter===Mr.LINEAR||a.mipFilter===Mr.ANISOTROPIC?a.glMinFilter=o.LINEAR_MIPMAP_LINEAR:a.mipFilter===Mr.POINT?a.glMinFilter=o.LINEAR_MIPMAP_NEAREST:a.glMinFilter=o.LINEAR:a.mipFilter===Mr.LINEAR||a.mipFilter===Mr.ANISOTROPIC?a.glMinFilter=o.NEAREST_MIPMAP_LINEAR:a.mipFilter===Mr.POINT?a.glMinFilter=o.NEAREST_MIPMAP_NEAREST:a.glMinFilter=o.NEAREST,a.magFilter===Mr.LINEAR||a.magFilter===Mr.ANISOTROPIC?a.glMagFilter=o.LINEAR:a.glMagFilter=o.NEAREST,a.glWrapS=v3[a.addressU],a.glWrapT=v3[a.addressV],a.glWrapR=v3[a.addressW],a.glSampler=s,o.samplerParameteri(s,o.TEXTURE_MIN_FILTER,a.glMinFilter),o.samplerParameteri(s,o.TEXTURE_MAG_FILTER,a.glMagFilter),o.samplerParameteri(s,o.TEXTURE_WRAP_S,a.glWrapS),o.samplerParameteri(s,o.TEXTURE_WRAP_T,a.glWrapT),o.samplerParameteri(s,o.TEXTURE_WRAP_R,a.glWrapR),o.samplerParameterf(s,o.TEXTURE_MIN_LOD,0),o.samplerParameterf(s,o.TEXTURE_MAX_LOD,1e3)),i}return L(t,e),t.prototype.destroy=function(){this._gpuSampler&&(function(e,t){var n=e.gl;if(t.glSampler){n.deleteSampler(t.glSampler);for(var i=e.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===t.glSampler&&(n.bindSampler(r,null),i[r]=null);t.glSampler=null}}(m3.instance,this._gpuSampler),this._gpuSampler=null)},B(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(ko),s5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Gr.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Gr.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+o+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"==typeof a)return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,m=f.name.indexOf("[");p=-1!==m?f.name.substr(0,m):f.name;var g=n.getAttribLocation(t.glProgram,p),y=S3(f.type,n),x=T3(f.type,n);t.glInputs[_]={name:p,type:y,stride:x,count:f.size,size:x*f.size,glType:f.type,glLoc:g}}}var S,T,E,A,C=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var b=0;b<C;++b){var P=(S=n.getActiveUniformBlockName(t.glProgram,b)).indexOf("[");-1!==P&&(S=S.substr(0,P)),A=null;for(var R=0;R<t.blocks.length;R++)if(t.blocks[R].name===S){A=t.blocks[R];break}if(A){T=b,E=n.getActiveUniformBlockParameter(t.glProgram,T,n.UNIFORM_BLOCK_DATA_SIZE);var I=A.binding+(e.bindingMappingInfo.bufferOffsets[A.set]||0);n.uniformBlockBinding(t.glProgram,T,I),t.glBlocks[b]={set:A.set,binding:A.binding,idx:T,name:S,size:E,glBinding:I}}else d("Block '"+S+"' does not bound")}}for(var w=0;w<t.subpassInputs.length;++w){var D=t.subpassInputs[w];t.samplerTextures.push(new Oa(D.set,D.binding,D.name,Er.SAMPLER2D,D.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var O=0;O<t.samplerTextures.length;++O){var M=t.samplerTextures[O];t.glSamplerTextures[O]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:x3(M.type,n),glLoc:null}}}for(var N=[],B=[],F=e.stateCache.texUnitCacheMap,L=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappingInfo.flexibleSet&&L++;for(var U=0,G=0;G<t.samplerTextures.length;++G){var k=t.samplerTextures[G],H=n.getUniformLocation(t.glProgram,k.name);if(H&&-1!==H.id&&(N.push(t.glSamplerTextures[G]),B.push(H)),void 0===F[k.name]){var V=k.binding+e.bindingMappingInfo.samplerOffsets[k.set]+U;k.set===e.bindingMappingInfo.flexibleSet&&(V-=L),F[k.name]=V%e.capabilities.maxTextureUnits,U+=k.count-1}}if(N.length){for(var j=[],W=0;W<N.length;++W){var q=N[W],X=F[q.name];if(void 0!==X){q.glLoc=B[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,Q=0;Q<N.length;++Q){var Z=N[Q];if(!Z.glLoc){for(Z.glLoc=B[Q];j[K];)K++;for(var J=0;J<Z.count;++J){for(;j[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===F[Z.name]&&(F[Z.name]=K),Z.units.push(K),j[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<N.length;$++){var ee=N[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=N}}(m3.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=m3.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},B(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Ho),c5=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new va,this.scissorRect=new ua(0,0,0,0),this.rs=new Mo,this.dss=new No,this.bs=new Fo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),l5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=fo(this._width)&&fo(this._height),this._size=mo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},L3(m3.instance,this._gpuTexture),m3.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(z3(m3.instance,this._gpuTexture),m3.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=mo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&b(9100,a,e.capabilities.maxTextureSize),t.samples===Dr.ONE){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),lo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=po(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else z3(e,t),L3(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Rr.CUBE:t.type=Rr.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&b(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),lo[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var p=po(t.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else z3(e,t),L3(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}}(m3.instance,this._gpuTexture),m3.instance.memoryStatus.textureSize-=n,m3.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Pa;t.format=e.format,t.usage=lo[e.format].hasDepth?Ir.DEPTH_STENCIL_ATTACHMENT:Ir.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},B(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Vo),u5="webglcontextlost";function h5(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function _5(e){var t={EXT_texture_filter_anisotropic:h5(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:h5(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:h5(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:h5(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:h5(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:h5(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:h5(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:h5(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:h5(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:h5(e,"WEBGL_debug_shaders"),WEBGL_lose_context:h5(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:h5(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:h5(e,"OES_texture_half_float_linear"),OES_texture_float_linear:h5(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return fn.os!==ln.ANDROID&&fn.os!==ln.IOS&&(t.WEBGL_multi_draw=h5(e,"WEBGL_multi_draw")),t}var f5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new c5,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(u5,this._onWebGLContextLost);var t=m3.instance.gl;this.stateCache.initialize(m3.instance.capabilities.maxTextureUnits,m3.instance.capabilities.maxUniformBufferBindings,m3.instance.capabilities.maxVertexAttributes),this._extensions=_5(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Sr.RGBA8,i=Sr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=Sr.DEPTH_STENCIL:r&&(i=Sr.DEPTH),this._colorTexture=new l5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new l5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=m3.instance.createTexture(new Pa(Rr.TEX2D,Ir.SAMPLED,Sr.RGBA8,2,2,wr.NONE)),this.nullTexCube=m3.instance.createTexture(new Pa(Rr.CUBE,Ir.SAMPLED,Sr.RGBA8,2,2,wr.NONE,6));var o=new ma;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),m3.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,m3.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(u5,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(v("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){A(11e3),p(e)},B(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ao),p5=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}L(t,e);var n=t.prototype;return n.initialize=function(e){m3.setInstance(this),this._gfxAPI=gr.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:$e.ENABLE_TRANSPARENT_CANVAS,antialias:$e.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(Eo.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new no($r.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new to(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,a=W(n);!(r=a()).done;)i+=r.value+" ";var o=_5(t);o.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(o.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(o.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),this._features[xr.TEXTURE_FLOAT]=!0,this._features[xr.TEXTURE_HALF_FLOAT]=!0,this._features[xr.FORMAT_R11G11B10F]=!0,this._features[xr.FORMAT_SRGB]=!0,this._features[xr.FORMAT_RGB8]=!0,this._features[xr.ELEMENT_INDEX_UINT]=!0,this._features[xr.INSTANCED_ARRAYS]=!0,this._features[xr.MULTIPLE_RENDER_TARGETS]=!0,this._features[xr.BLEND_MINMAX]=!0,o.EXT_color_buffer_float&&(this._features[xr.COLOR_FLOAT]=!0,this._features[xr.COLOR_HALF_FLOAT]=!0),o.OES_texture_float_linear&&(this._features[xr.TEXTURE_FLOAT_LINEAR]=!0),o.OES_texture_half_float_linear&&(this._features[xr.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return o.WEBGL_compressed_texture_etc1&&(this._features[xr.FORMAT_ETC1]=!0,c+="etc1 "),o.WEBGL_compressed_texture_etc&&(this._features[xr.FORMAT_ETC2]=!0,c+="etc2 "),o.WEBGL_compressed_texture_s3tc&&(this._features[xr.FORMAT_DXT]=!0,c+="dxt "),o.WEBGL_compressed_texture_pvrtc&&(this._features[xr.FORMAT_PVRTC]=!0,c+="pvrtc "),o.WEBGL_compressed_texture_astc&&(this._features[xr.FORMAT_ASTC]=!0,c+="astc "),v("WebGL2 device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===ta.PRIMARY?i5:Q3);return t.initialize(e),t},n.createSwapchain=function(e){var t=new f5;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new X3;return t.initialize(e),t},n.createTexture=function(e){var t=new l5;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new d3;return t.initialize(e),t},n.createShader=function(e){var t=new s5;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new J3;return t.initialize(e),t},n.createRenderPass=function(e){var t=new a5;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new Z3;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new $3;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new e5;return t.initialize(e),t},n.createPipelineState=function(e){var t=new n5;return t.initialize(e),t},n.createQueue=function(e){var t=new r5;return t.initialize(e),t},n.getSampler=function(e){var t=ko.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new o5(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=jo.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new jo(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Wo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Wo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){W3(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&wr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},B(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(Eo));i.WebGL2Device=p5}}}));
